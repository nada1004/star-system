<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>â­ ìŠ¤íƒ€ëŒ€í•™ ë°ì´í„° ì„¼í„° V49.2</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root{
  --bg:#f0f2f5;--white:#fff;--surface:#f7f9fc;--border:#e4e8ee;--border2:#cdd3dc;
  --blue:#2563eb;--blue-d:#1d4ed8;--blue-l:#eff6ff;--blue-ll:#dbeafe;
  --gold:#d97706;--gold-bg:#fffbeb;--gold-b:#fde68a;
  --green:#16a34a;--red:#dc2626;--gray:#64748b;--gray-l:#9ca3af;
  --text:#1a202c;--text2:#374151;--text3:#6b7280;
  --god:#7c3aed;--king:#dc2626;--jack:#2563eb;--joker:#16a34a;--spade:#0f172a;
  --r:8px;--sh:0 1px 3px rgba(0,0,0,.06);--sh2:0 4px 20px rgba(0,0,0,.08);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Noto Sans KR',sans-serif;background:#fff;color:var(--text);font-size:13px;padding:16px;line-height:1.5;font-weight:400;}
button{font-family:'Noto Sans KR',sans-serif;cursor:pointer;}
input,select,textarea{font-family:'Noto Sans KR',sans-serif;font-weight:400;}
b,strong{font-weight:600;}
.app{max-width:1480px;margin:auto;background:var(--white);border-radius:14px;border:1px solid var(--border);box-shadow:var(--sh2);overflow:hidden;}
.hdr{background:linear-gradient(135deg,#1e3a8a 0%,#2563eb 55%,#1e40af 100%);padding:14px 24px;display:flex;align-items:center;gap:12px;position:relative;overflow:hidden;}
.hdr::after{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,rgba(255,255,255,.025) 0,rgba(255,255,255,.025) 1px,transparent 1px,transparent 14px);}
.hdr-ico{font-size:22px;z-index:1;}
.hdr-title{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:17px;color:#fff;letter-spacing:.5px;z-index:1;}
.hdr-ver{background:rgba(255,255,255,.15);color:rgba(255,255,255,.9);font-size:10px;padding:2px 9px;border-radius:20px;font-weight:500;letter-spacing:.5px;border:1px solid rgba(255,255,255,.22);z-index:1;}

/* â•â• V27 ì‹ ê·œ CSS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•â• V28 ì‹ ê·œ CSS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fadeIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.score-click{cursor:pointer;padding:2px 10px;border-radius:8px;transition:.12s;}
.score-click:hover{background:var(--blue-ll,#dbeafe);}

/* ê³µìœ ì¹´ë“œ ëª¨ë‹¬ */
.sharecard-modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,.7);z-index:3000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.sharecard-modal-box{background:var(--white);border-radius:16px;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:95vw;position:relative;}
.sharecard-modal-close{position:absolute;top:10px;right:12px;background:none;border:none;font-size:22px;cursor:pointer;color:var(--gray-l);line-height:1;}
.sharecard-modal-close:hover{color:var(--text);}
.sharecard-modal-actions{display:flex;gap:8px;margin-top:14px;justify-content:center;}
/* ì¡°ë³„ ìˆœìœ„í‘œ ì„¸ë ¨í™” */
.grp-rank-table{width:100%;border-collapse:separate;border-spacing:0;border-radius:10px;overflow:hidden;border:1.5px solid var(--border);}
.grp-rank-table th{background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff;padding:8px 8px;font-size:11px;font-weight:700;letter-spacing:.3px;white-space:nowrap;text-align:left;}
.grp-rank-table td{padding:7px 8px;border-bottom:1px solid var(--border);font-size:13px;transition:background .1s;text-align:left;}
.grp-rank-table tr:last-child td{border-bottom:none;}
.grp-rank-table tr:hover td{background:#f0f6ff;}
.grp-rank-top1{background:linear-gradient(90deg,#fffbeb,#fff)!important;}
.grp-rank-top2{background:linear-gradient(90deg,#f1f5f9,#fff)!important;}
.grp-match-card{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;box-shadow:0 1px 4px rgba(0,0,0,.04);transition:box-shadow .15s;}
.grp-match-card:hover{box-shadow:0 3px 12px rgba(37,99,235,.1);}
.grp-match-vs{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--gray-l);}
.grp-match-score{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:22px;letter-spacing:2px;}
.grp-section-hdr{display:flex;align-items:center;gap:8px;margin-bottom:12px;}
.grp-badge{display:inline-block;padding:4px 14px;border-radius:20px;color:#fff;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px;letter-spacing:.5px;}
/* í‹°ì–´ í•„í„° */
.tier-filter-bar{display:flex;gap:6px;flex-wrap:wrap;padding:10px 0;margin-bottom:8px;align-items:center;}
.tier-filter-btn{padding:4px 13px;border-radius:20px;border:1.5px solid var(--border2);background:var(--white);font-size:12px;font-weight:600;cursor:pointer;transition:.15s;color:var(--text3);}
.tier-filter-btn:hover{border-color:var(--blue);color:var(--blue);}
.tier-filter-btn.on{background:var(--blue);color:#fff;border-color:var(--blue);}
/* ê²½ê¸° ìˆ˜ì • ëª¨ë‹¬ */
.edit-match-modal .mbox{width:680px;}
/* ì´ë¯¸ì§€ ì €ì¥ ë²„íŠ¼ */
.btn-capture{background:linear-gradient(135deg,#7c3aed,#2563eb);color:#fff;border:none;padding:6px 14px;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;transition:.15s;}
.btn-capture:hover{opacity:.88;}
/* ì¡°í¸ì„± ê´€ë¦¬ ìš°ì¸¡ í‹°ì–´ í•„í„° */
.grp-edit-header{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
/* í”„ë¡œë¦¬ê·¸ ìˆ˜ì • ë²„íŠ¼ */
.pro-edit-btn{display:inline-flex;align-items:center;gap:3px;padding:3px 9px;border-radius:5px;background:#ea580c;color:#fff;border:none;font-size:11px;font-weight:600;cursor:pointer;transition:.15s;}
.pro-edit-btn:hover{background:#c2410c;}
/* ì¢…ì¡± í•„í„°ë§ëœ ì„ ìˆ˜ ì„ íƒ ê°œì„  */
.race-player-select{border-left:3px solid var(--blue);background:var(--blue-l)!important;}

.tabs{display:flex;gap:2px;padding:6px 16px;background:var(--surface);border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab{padding:6px 13px;border:none;background:transparent;color:var(--text3);border-radius:6px;font-size:12px;font-weight:500;white-space:nowrap;transition:.15s;}
.tab:hover{background:var(--blue-l);color:var(--blue);}
.tab.on{background:var(--blue);color:#fff;box-shadow:0 1px 8px rgba(37,99,235,.25);}
.tab.cfg{background:transparent;}
.tab.cfg.on{background:#334155;color:#fff;box-shadow:none;}
.fstrip{padding:10px 18px 0;background:var(--surface);border-bottom:1px solid var(--border);}
.form-row{display:flex;gap:8px;margin-bottom:10px;padding:10px 14px;background:var(--white);border-radius:var(--r);flex-wrap:wrap;align-items:center;border:1px solid var(--border);box-shadow:var(--sh);}
.flabel{font-weight:600;font-size:12px;color:var(--blue);white-space:nowrap;}
input,select{padding:6px 10px;border:1px solid var(--border2);border-radius:6px;background:var(--white);color:var(--text);font-size:12px;transition:.15s;}
input:focus,select:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1);}
input::placeholder{color:var(--gray-l);}
.btn{padding:6px 13px;border-radius:6px;border:none;font-size:12px;font-weight:600;transition:.15s;}
.btn-b{background:var(--blue);color:#fff;}.btn-b:hover{background:var(--blue-d);}
.btn-g{background:#16a34a;color:#fff;}.btn-g:hover{background:#15803d;}
.btn-o{background:#ea580c;color:#fff;}.btn-o:hover{background:#c2410c;}
.btn-r{background:#dc2626;color:#fff;}.btn-r:hover{background:#b91c1c;}
.btn-w{background:var(--white);color:var(--text2);border:1px solid var(--border2);}.btn-w:hover{background:var(--surface);}
.btn-p{background:#7c3aed;color:#fff;}.btn-p:hover{background:#6d28d9;}
.btn-xs{padding:2px 8px;font-size:11px;border-radius:5px;}
.btn-sm{padding:4px 10px;font-size:12px;border-radius:6px;}
.btn-detail{padding:3px 10px;border-radius:5px;border:1px solid var(--border2);background:var(--surface);color:var(--text3);font-size:11px;font-weight:500;cursor:pointer;transition:.15s;}
.btn-detail:hover{border-color:var(--blue);color:var(--blue);}
.btn-detail.open{background:var(--blue);color:#fff;border-color:var(--blue);}
.main{padding:18px;}#cap{background:var(--white);text-align:left;}
.rtitle{text-align:center;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px;margin-bottom:16px;color:var(--text);letter-spacing:.5px;}
table{width:100%;border-collapse:collapse;background:transparent;border:1px solid var(--border);border-radius:var(--r);overflow:hidden;height:1px;}
tbody{height:auto;}
table:empty{display:none;}
th{background:var(--surface);padding:8px 12px;border-bottom:1px solid var(--border);color:var(--text3);font-size:11px;letter-spacing:.3px;font-weight:600;}
td{padding:8px 12px;border-bottom:1px solid var(--border);text-align:left;font-weight:400;background:var(--white);}
.td-c{text-align:center!important;}
tr:last-child td{border-bottom:none;}
tr:not(.ugrp):not(.tgrp):hover td{background:#fafbff;}
/* ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„ ì»¬ëŸ¼ ê³µë°± ë°©ì§€ */
.td-name{text-align:left;padding-left:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:0;width:100%;}
.ugrp td{background:var(--c,#2563eb);font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;border-top:2px solid var(--c,#2563eb);padding:8px 12px;color:#fff;border-left:4px solid var(--c,#2563eb);text-align:left;text-shadow:0 1px 4px rgba(0,0,0,.2);}
.tgrp td{background:#f7f9fc;color:var(--text3);font-weight:500;font-size:11px;padding:4px 10px 4px 18px;border-bottom:1px solid var(--border);text-align:left;}
.rbadge{font-weight:600;padding:2px 6px;border-radius:4px;font-size:11px;letter-spacing:.3px;}
.rT{background:#dbeafe;color:#1d4ed8;border:1px solid #bfdbfe;}
.rZ{background:#ede9fe;color:#7c3aed;border:1px solid #ddd6fe;}
.rP{background:#fef3c7;color:#b45309;border:1px solid #fde68a;}
.ubadge{padding:2px 9px;border-radius:5px;font-size:11px;font-weight:600;color:#fff!important;display:inline-block;min-width:56px;text-align:center;box-shadow:0 1px 2px rgba(0,0,0,.15);}
.ubadge.loser{opacity:0.32;filter:grayscale(100%);box-shadow:none;}
.tbadge{display:inline-flex;align-items:center;justify-content:center;gap:3px;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:800;letter-spacing:.3px;white-space:nowrap;flex-shrink:0;vertical-align:middle;line-height:1.4;}
.tbadge-god{background:linear-gradient(135deg,#020b2a,#091540);color:#fff;box-shadow:0 2px 10px rgba(2,11,42,.8);border:1px solid rgba(255,255,255,.12);}
.tbadge-king{background:linear-gradient(135deg,#071535,#102058);color:#fff;box-shadow:0 2px 10px rgba(7,21,53,.75);border:1px solid rgba(255,255,255,.12);}
.tbadge-jack{background:linear-gradient(135deg,#0e2060,#182d80);color:#fff;box-shadow:0 2px 10px rgba(14,32,96,.7);border:1px solid rgba(255,255,255,.13);}
.tbadge-joker{background:linear-gradient(135deg,#162b80,#2040a8);color:#fff;box-shadow:0 2px 10px rgba(22,43,128,.65);border:1px solid rgba(255,255,255,.14);}
.tbadge-spade{background:linear-gradient(135deg,#1e389a,#2d52c8);color:#fff;box-shadow:0 2px 10px rgba(30,56,154,.6);border:1px solid rgba(255,255,255,.15);}
.tbadge-0{background:linear-gradient(135deg,#2845b4,#3860d8);color:#fff;box-shadow:0 2px 8px rgba(40,69,180,.55);}
.tbadge-t1{background:linear-gradient(135deg,#2e54c8,#4070e0);color:#fff;box-shadow:0 1px 5px rgba(46,84,200,.5);}
.tbadge-t2{background:linear-gradient(135deg,#3d6ee0,#5888f0);color:#fff;box-shadow:0 1px 5px rgba(61,110,224,.45);}
.tbadge-t3{background:linear-gradient(135deg,#5082f0,#6e9ef8);color:#fff;box-shadow:0 1px 5px rgba(80,130,240,.4);}
.tbadge-t4{background:linear-gradient(135deg,#6898f8,#84b4ff);color:#fff;box-shadow:0 1px 5px rgba(104,152,248,.4);}
.tbadge-t5{background:linear-gradient(135deg,#80b0ff,#9ecaff);color:#1a3a8a;box-shadow:0 1px 5px rgba(128,176,255,.45);}
.tbadge-t6{background:linear-gradient(135deg,#96c6ff,#b2dcff);color:#1d4ed8;box-shadow:0 1px 5px rgba(150,198,255,.5);}
.tbadge-t7{background:linear-gradient(135deg,#acdbff,#c6ecff);color:#1d4ed8;box-shadow:0 1px 5px rgba(172,219,255,.55);}
.tbadge-t8{background:linear-gradient(135deg,#c0e8ff,#d8f4ff);color:#1d4ed8;border:1px solid #96d0f8;box-shadow:0 1px 4px rgba(192,232,255,.6);}
.tbadge-youth{background:linear-gradient(135deg,#fde68a,#fbbf24);color:#78350f;box-shadow:0 1px 5px rgba(251,191,36,.4);}
.tbadge-default{background:linear-gradient(135deg,#94a3b8,#64748b);color:#fff;}
.wt{color:var(--green);font-weight:600;}
.lt{color:var(--red);font-weight:600;}
.pt-p{color:#16a34a;font-weight:700;}
.pt-n{color:#dc2626;font-weight:700;}
.pt-z{color:#94a3b8;font-weight:400;}
.fbar{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:12px;align-items:center;}
.fbar strong{color:var(--gray-l);font-size:11px;font-weight:500;}
.pill{padding:3px 11px;border-radius:20px;border:1px solid var(--border2);background:var(--white);color:var(--text3);font-size:11px;font-weight:500;cursor:pointer;transition:.15s;}
.pill:hover{border-color:var(--blue);color:var(--blue);}
.pill.on{background:var(--blue);color:#fff;border-color:var(--blue);}
.swrap{position:relative;display:inline-block;}
.sdrop{display:none;position:absolute;top:36px;left:0;background:var(--white);border:1px solid var(--border2);border-radius:8px;width:200px;z-index:500;max-height:190px;overflow-y:auto;box-shadow:var(--sh2);}
.sitem{padding:7px 12px;cursor:pointer;font-size:12px;transition:.1s;}
.sitem:hover{background:var(--blue-l);color:var(--blue);}
.scards{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;}
.scard{flex:1;min-width:120px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;}
.scard .sv{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:24px;}
.scard .sl{font-size:11px;color:var(--gray-l);margin-top:3px;font-weight:400;}
.ipanel{background:var(--white);border:2px solid var(--border);border-radius:14px;padding:18px 20px;margin-bottom:14px;box-shadow:0 2px 12px rgba(0,0,0,.05);}
.ocard{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:10px 14px;min-width:90px;text-align:center;transition:.15s;box-shadow:0 1px 4px rgba(0,0,0,.04);}
.ocard:hover{box-shadow:0 3px 12px rgba(37,99,235,.1);border-color:var(--blue-ll);}
.rscard{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:14px 18px;text-align:center;flex:1;min-width:90px;box-shadow:0 1px 4px rgba(0,0,0,.04);}
.rk1{color:#d97706;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;background:#fffbeb;border:1px solid #fcd34d;padding:2px 9px;border-radius:5px;display:inline-block;}
.rk2{color:#6b7280;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;background:#f1f5f9;border:1px solid #e2e8f0;padding:2px 9px;border-radius:5px;display:inline-block;}
.rk3{color:#92400e;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;background:#fef3c7;border:1px solid #fde68a;padding:2px 9px;border-radius:5px;display:inline-block;}
.stabs{display:flex;gap:3px;margin-bottom:14px;flex-wrap:wrap;}
.stab{padding:5px 13px;border-radius:6px;border:1px solid var(--border2);background:var(--white);color:var(--text3);font-size:12px;font-weight:500;cursor:pointer;transition:.15s;}
.stab:hover{background:var(--blue-l);color:var(--blue);}
.stab.on{background:var(--blue);color:#fff;border-color:var(--blue);}
.match-builder{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:18px;}
.match-builder h3{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:var(--blue);margin:-16px -16px 16px;padding:12px 16px;background:var(--blue-l);border-bottom:2px solid var(--blue-ll);border-radius:10px 10px 0 0;}
.set-block{background:var(--white);border:1px solid var(--border2);border-radius:8px;padding:14px;margin-bottom:10px;}
.set-block.ace{border-color:#c4b5fd;}
.set-title{display:flex;align-items:center;gap:8px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.set-badge{display:inline-block;padding:3px 10px;border-radius:5px;font-size:12px;font-weight:600;background:var(--blue);color:#fff;}
.set-badge.ace{background:#7c3aed;}
.game-row{display:flex;align-items:center;gap:6px;margin-bottom:6px;padding:8px 10px;background:var(--surface);border-radius:7px;flex-wrap:wrap;}
.game-row select{flex:1;min-width:110px;}
.win-btn{padding:5px 13px;border-radius:5px;border:1px solid var(--border2);background:var(--white);font-weight:500;font-size:12px;cursor:pointer;transition:.15s;white-space:nowrap;}
.win-btn:hover{border-color:var(--blue);}
.win-btn.win-sel{background:var(--green);color:#fff;border-color:var(--green);}
.win-btn.lose-sel{background:var(--red);color:#fff;border-color:var(--red);}
.score-board{display:flex;align-items:center;gap:12px;padding:10px 16px;background:var(--blue-l);border-radius:8px;margin-bottom:12px;flex-wrap:wrap;}
.score-num{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:26px;}
.rec-summary{background:var(--white);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;overflow:hidden;transition:box-shadow .15s;min-height:44px;}
.rec-summary:empty{display:none!important;}
.rec-summary:hover{box-shadow:var(--sh);}
.rec-sum-header{padding:8px 12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.rec-sum-vs{display:flex;align-items:center;gap:7px;flex:1;flex-wrap:wrap;}
.rec-sum-score{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px;display:flex;align-items:center;gap:5px;}
.rec-detail-area{border-top:1px solid var(--border);padding:10px 12px;background:var(--surface);display:none;}
.rec-detail-area.open{display:block;}
.rec-card{background:var(--white);border:1px solid var(--border);border-radius:8px;margin-bottom:10px;overflow:hidden;}
.rec-header{padding:10px 14px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;background:var(--surface);border-bottom:1px solid var(--border);}
.rec-sets{padding:10px 14px;}
.set-row{margin-bottom:5px;}
.set-row-title{font-size:11px;font-weight:600;color:var(--blue);margin-bottom:5px;padding:2px 7px;background:var(--blue-l);border-radius:4px;display:inline-block;}
.set-row-title.ace-t{color:#7c3aed;background:#f5f3ff;}
.game-detail{display:flex;align-items:center;gap:5px;padding:3px 8px;background:var(--surface);border-radius:5px;margin-bottom:3px;font-size:12px;flex-wrap:wrap;}
.set-result-row{display:flex;align-items:center;gap:7px;padding:6px 10px;background:var(--white);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;}
.set-team-col{flex:1;min-width:80px;}
.set-team-label{font-size:12px;font-weight:600;}
.set-score-center{display:flex;align-items:center;gap:5px;min-width:70px;justify-content:center;}
.set-score-num{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:17px;}
.ck-panel{background:var(--white);border:1px solid var(--border2);border-radius:8px;padding:12px;flex:1;min-width:200px;}
.ck-panel h4{font-size:12px;font-weight:600;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border);}
.mem-tag{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;margin:2px;color:#fff;}
.mem-tag button{background:none;border:none;color:#fff;cursor:pointer;font-size:12px;line-height:1;padding:0 2px;}
.ssec{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:16px 18px;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04);}
.ssec h4{font-family:'Noto Sans KR',sans-serif;font-size:14px;font-weight:800;color:var(--text2);margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid var(--border);}
.srow{display:flex;align-items:center;gap:7px;padding:7px 10px;background:var(--white);border:1px solid var(--border);border-radius:7px;margin-bottom:5px;}
.cdot{width:24px;height:24px;border-radius:5px;flex-shrink:0;}
.modal{display:none;position:fixed;z-index:2000;inset:0;background:rgba(15,23,42,.5);backdrop-filter:blur(4px);}
.mbox{background:var(--white);margin:5% auto;padding:24px;width:500px;max-width:95vw;border-radius:12px;border:1px solid var(--border);box-shadow:0 16px 48px rgba(0,0,0,.16);}
.mtitle{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px;color:var(--blue);margin-bottom:16px;}
.mbox label{display:block;font-size:11px;font-weight:500;color:var(--gray-l);margin-top:10px;margin-bottom:3px;}
.mbox input,.mbox select{width:100%;}
.mbtns{display:flex;gap:7px;margin-top:18px;}
.tour-wrap{background:linear-gradient(160deg,#f8faff,#eff6ff,#f8faff);border-radius:12px;border:1px solid #bfdbfe;padding:48px 20px 32px;overflow-x:auto;position:relative;min-height:500px;}
.tour-wrap::before{content:'â­  STAR UNIVERSITY TOURNAMENT  â­';position:absolute;top:12px;left:50%;transform:translateX(-50%);font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:11px;color:rgba(37,99,235,.18);letter-spacing:5px;white-space:nowrap;}
.tour-inner{display:flex;align-items:center;justify-content:center;gap:0;min-width:860px;}
.rcol{display:flex;flex-direction:column;justify-content:space-around;align-items:center;position:relative;min-width:172px;}
.rcol-lbl{position:absolute;top:-28px;left:50%;transform:translateX(-50%);font-size:9px;font-weight:500;letter-spacing:3px;color:#60a5fa;white-space:nowrap;}
.mcard{background:var(--white);border:1px solid #bfdbfe;border-radius:8px;width:150px;padding:9px;margin:8px 0;box-shadow:0 1px 4px rgba(37,99,235,.06);}
.mcard-lbl{font-size:9px;color:#93c5fd;text-align:center;margin-bottom:7px;letter-spacing:1.5px;font-weight:500;}
.mteam{display:flex;align-items:center;justify-content:center;padding:7px 9px;border-radius:5px;border:1px solid #dbeafe;background:#f8faff;min-height:34px;font-size:12px;font-weight:500;color:#94a3b8;}
.mteam.set{color:#1e293b;}
.mvs{text-align:center;font-size:9px;color:#93c5fd;margin:4px 0;font-weight:500;letter-spacing:1.5px;}
.msel-wrap{margin-top:7px;display:flex;flex-direction:column;gap:3px;}
.msel{width:100%;padding:3px 5px;font-size:10px;background:#f8faff;color:#64748b;border:1px solid #bfdbfe;border-radius:4px;}
.conn{width:32px;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.conn-line{width:100%;height:1px;background:linear-gradient(90deg,#93c5fd,rgba(147,197,253,.1));}
.champ-col{display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;min-width:168px;}
.champ-lbl2{position:absolute;top:-28px;left:50%;transform:translateX(-50%);font-size:9px;font-weight:500;letter-spacing:3px;color:#d97706;white-space:nowrap;}
.champ-box{background:linear-gradient(135deg,#fffbeb,#fef3c7);border:1px solid #fcd34d;border-radius:12px;width:158px;padding:16px 12px;text-align:center;box-shadow:0 3px 16px rgba(217,119,6,.14);}
.champ-star{color:#d97706;font-size:10px;letter-spacing:3px;margin-bottom:7px;display:block;}
.champ-lbl{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:10px;color:#d97706;letter-spacing:3px;margin-bottom:8px;}
.champ-team{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:#92400e;padding:8px 6px;background:rgba(217,119,6,.08);border:1px solid rgba(217,119,6,.3);border-radius:7px;min-height:40px;display:flex;align-items:center;justify-content:center;}
.foot{display:none!important;}
.male-icon{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;background:#2563eb;color:#fff;border-radius:50%;font-size:8px;font-weight:700;margin-left:3px;vertical-align:middle;flex-shrink:0;}
.female-icon{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;background:#db2777;color:#fff;border-radius:50%;font-size:8px;font-weight:700;margin-left:3px;vertical-align:middle;flex-shrink:0;}
.clickable-name{cursor:pointer;color:var(--blue);font-weight:500;border-bottom:1px solid rgba(37,99,235,.25);transition:.12s;}
.clickable-name:hover{border-bottom-color:var(--blue);}
.clickable-univ{cursor:pointer;}
.clickable-univ:hover{opacity:0.82;}
.umbox{background:var(--white);margin:3% auto;padding:24px;width:700px;max-width:96vw;border-radius:12px;border:1px solid var(--border);box-shadow:0 16px 48px rgba(0,0,0,.14);max-height:88vh;overflow-y:auto;}
.login-box input{width:100%;padding:10px 14px;border:1px solid var(--border2);border-radius:8px;font-size:13px;margin-bottom:10px;display:block;}
.login-box input:focus{border-color:var(--blue);outline:none;box-shadow:0 0 0 3px rgba(37,99,235,.1);}
.hdr-login-btn{background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.25);padding:4px 13px;border-radius:20px;font-size:11px;font-weight:500;cursor:pointer;z-index:1;transition:.15s;}
.hdr-login-btn:hover{background:rgba(255,255,255,.28);}
.locked{opacity:.38;pointer-events:none;cursor:not-allowed;}

/* 1:1 ìƒëŒ€ì „ì  */
.vs-box{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px;}
.vs-bar-wrap{height:7px;border-radius:20px;overflow:hidden;background:var(--border);display:flex;margin:8px 0;}
.vs-bar-a{background:var(--blue);transition:width .4s;}
.vs-bar-b{background:var(--red);transition:width .4s;}
/* VS ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ ë‹¤í¬ëª¨ë“œ */
body.dark [id^="vs-drop-"]{background:var(--surface)!important;border-color:var(--border2)!important;}
body.dark [id^="vs-wrap-"]{background:var(--surface)!important;border-color:var(--border2)!important;}
body.dark [id^="vs-drop-"] input{color:var(--text)!important;}

/* ë‚ ì§œ ì •ë ¬ */
.sort-bar{display:flex;gap:5px;align-items:center;margin-bottom:8px;flex-wrap:wrap;}
.sort-btn{padding:3px 9px;border-radius:5px;border:1px solid var(--border2);background:var(--white);color:var(--text3);font-size:11px;font-weight:500;cursor:pointer;transition:.12s;}
.sort-btn.on{background:var(--blue);color:#fff;border-color:var(--blue);}
.sort-btn:hover:not(.on){border-color:var(--blue);color:var(--blue);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“± ëª¨ë°”ì¼ UI ê°œì„ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
  body { padding: 0; font-size: 12px; background: #fff; }
  .app { border-radius: 0; border: none; }
  .hdr { padding: 8px 12px; gap: 6px; }
  .hdr-title { font-size: 13px; }
  .hdr-ver { display: none; }
  .hdr-ico { font-size: 18px; }
  #globalSearch { width: 100px !important; font-size: 12px !important; padding: 5px 8px !important; }

  /* íƒ­ ë©”ë‰´ */
  .tabs { padding: 5px 6px; gap: 2px; }
  .tab { padding: 5px 9px; font-size: 10px; border-radius: 5px; }

  /* í¼ ì˜ì—­ */
  .form-row { flex-direction: column; align-items: stretch; gap: 6px; padding: 10px 12px; }
  .form-row input, .form-row select { width: 100% !important; font-size: 13px; padding: 8px 10px; }
  .flabel { font-size: 11px; }
  #fstrip { padding: 8px 12px 0; }

  /* í…Œì´ë¸” */
  table { font-size: 11px; }
  th, td { padding: 6px 5px; }
  .ubadge { min-width: 32px; font-size: 10px; padding: 2px 4px; }

  /* ë©”ì¸ ì½˜í…ì¸  */
  .main { overflow-x: hidden; padding: 10px 10px 90px; }
  #actionBar { display: none !important; }
  #exportHint { display: none; }

  /* ì„¹ì…˜ ì¹´ë“œ */
  .ssec { padding: 12px 10px; margin-bottom: 10px; }
  .scards { gap: 6px; }
  .scard { min-width: 80px; padding: 10px 8px; }
  .scard .sv { font-size: 20px; }

  /* ëª¨ë‹¬ */
  .mbox { width: 95vw !important; padding: 16px !important; margin: 8% auto !important; }
  .umbox { width: 96vw !important; padding: 12px !important; margin: 3% auto !important; max-height: 92vh; overflow-y: auto; }

  /* ì ìˆ˜ë³´ë“œ */
  .score-board { gap: 6px; padding: 8px 10px; }
  .score-num { font-size: 20px; }

  /* ëŒ€ì „ ì¹´ë“œ */
  .rec-header { padding: 8px 10px; gap: 5px; }
  .rec-sum-score { font-size: 16px; }
  .rec-sum-vs { flex-wrap: wrap; gap: 4px; }
  .rec-summary { min-height: 40px; }

  /* íˆ¬ì–´ë„ˆë¨¼íŠ¸ */
  .tour-wrap { padding: 36px 8px 20px; }
  .mcard { width: 110px; padding: 7px; }

  /* ì¡°ë³„ë¦¬ê·¸ ê²½ê¸° ì¹´ë“œ ëª¨ë°”ì¼ */
  .grp-match-card { flex-direction: column; align-items: stretch; gap: 8px; padding: 10px 12px; }

  /* í…Œì´ë¸” ê°€ë¡œ ìŠ¤í¬ë¡¤ */
  .tab-cont table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }

  /* ì„¸íŠ¸/ê²Œì„ ë¹Œë” */
  .set-block { padding: 10px; }
  .game-row { flex-wrap: wrap; gap: 5px; padding: 7px 8px; }
  .game-row select { min-width: 100px; font-size: 12px; }
  .win-btn { padding: 6px 10px; font-size: 12px; }

  /* match-builder */
  .match-builder h3 { font-size: 13px; padding: 10px 12px; margin: -10px -10px 12px; }

  /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ê³µê°„ í™•ë³´ */
  #bottomNav { display: flex !important; }


}

@media (max-width: 480px) {
  .hdr-title { font-size: 12px; }
  #globalSearch { width: 80px !important; }
  .tab { padding: 4px 7px; font-size: 10px; }
  .scard { min-width: 70px; }
  .game-row select { min-width: 90px; }
  /* ìŠ¤íŠ¸ë¦¬ë¨¸ í…Œì´ë¸” ëª¨ë°”ì¼ ì†Œí˜• */
  .td-name { max-width: 80px; }
}

@media (min-width: 769px) {
  #bottomNav { display: none !important; }
}

/* â”€â”€ í•˜ë‹¨ ê³ ì • ë„¤ë¹„ê²Œì´ì…˜ ë°” â”€â”€ */
#bottomNav {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--white);
  border-top: 1.5px solid var(--border);
  z-index: 1000;
  padding: 4px 0 env(safe-area-inset-bottom, 4px);
  box-shadow: 0 -3px 16px rgba(0,0,0,.1);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.bnav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  padding: 5px 2px 4px;
  cursor: pointer;
  border: none;
  background: none;
  font-family: 'Noto Sans KR', sans-serif;
  color: var(--gray-l);
  font-size: 9px;
  font-weight: 600;
  transition: color .15s, transform .1s;
  -webkit-tap-highlight-color: transparent;
  position: relative;
}
.bnav-item:active { transform: scale(.92); }
.bnav-item.on { color: var(--blue); }
.bnav-item.on::before {
  content: '';
  position: absolute;
  top: 0; left: 20%; right: 20%;
  height: 2.5px;
  background: var(--blue);
  border-radius: 0 0 3px 3px;
}
.bnav-item span:first-child { font-size: 20px; line-height: 1; }

body.dark {
  --bg:#0f172a;--white:#1e293b;--surface:#162032;--border:#2d3f55;--border2:#3a4f6a;
  --blue:#60a5fa;--blue-d:#93c5fd;--blue-l:#1e3a5f;--blue-ll:#1e3a5f;
  --gold:#fbbf24;--gold-bg:#2d2000;--gold-b:#78500a;
  --green:#4ade80;--red:#f87171;--gray:#94a3b8;--gray-l:#64748b;
  --text:#e2e8f0;--text2:#cbd5e1;--text3:#94a3b8;
  background:#0f172a!important;color:#e2e8f0!important;
}
body.dark .app{background:#1e293b;border-color:#2d3f55;}
body.dark .hdr{background:linear-gradient(135deg,#0f172a 0%,#1e3a8a 55%,#0f172a 100%);}
body.dark table{background:#1e293b;border-color:#2d3f55;}
body.dark th{background:#162032;color:#94a3b8;}
body.dark td{background:#1e293b;border-color:#2d3f55;color:#e2e8f0;}
body.dark tr:not(.ugrp):not(.tgrp):hover td{background:#243248;}
body.dark .tabs{background:#162032;border-color:#2d3f55;}
body.dark .tab{color:#64748b;}
body.dark .tab:hover{background:#1e3a5f;color:#60a5fa;}
body.dark .tab.on{background:#2563eb;}
body.dark .fstrip{background:#162032;border-color:#2d3f55;}
body.dark .form-row{background:#1e293b;border-color:#2d3f55;}
body.dark input,body.dark select,body.dark textarea{background:#162032;border-color:#3a4f6a;color:#e2e8f0;}
body.dark .main{background:#1e293b;}
body.dark .ssec{background:#1e293b;border-color:#2d3f55;}
body.dark .modal .mbox{background:#1e293b;border-color:#2d3f55;}
body.dark .rec-summary{background:#1e293b;border-color:#2d3f55;}
body.dark .rec-detail-area{background:#162032;border-color:#2d3f55;}
body.dark .rec-sum-header{background:#1e293b;}
body.dark .ck-panel{background:#1e293b;border-color:#2d3f55;}
body.dark .grp-match-card{background:#1e293b;border-color:#2d3f55;}
body.dark .grp-match-score{background:#162032!important;border-color:#2d3f55!important;color:#e2e8f0!important;}
body.dark .set-result-row{background:#162032;border-color:#2d3f55;}
body.dark .ck-panel{background:#1e293b;border-color:#2d3f55;}
body.dark .ssec{background:#1e293b;border-color:#2d3f55;}

body.dark .grp-rank-top1{background:linear-gradient(90deg,#1e2d1a,#1e293b)!important;}
body.dark .grp-rank-top2{background:linear-gradient(90deg,#1e2330,#1e293b)!important;}
body.dark #globalSearchDrop{background:#1e293b!important;border-color:#2d3f55!important;color:#e2e8f0!important;}
body.dark #globalSearchDrop *{color:#e2e8f0;}
body.dark #ck-search-results{background:#1e293b!important;border-color:#2d3f55!important;}
body.dark #pro-a-drop,body.dark #pro-b-drop,body.dark #tt-a-drop,body.dark #tt-b-drop{background:#1e293b!important;border-color:#2d3f55!important;}
body.dark .mcard{background:#1e293b!important;border-color:#2d3f55!important;}
body.dark .stab{background:#1e293b;border-color:#3a4f6a;color:#94a3b8;}
body.dark .stab.on{background:#2563eb;color:#fff;border-color:#2563eb;}
body.dark .umbox{background:#1e293b;border-color:#2d3f55;}
body.dark .mbox{background:#1e293b;border-color:#2d3f55;}
body.dark .grp-rank-table th{background:linear-gradient(90deg,#0f172a,#1e3a8a);}
body.dark .grp-rank-table td{border-color:#2d3f55;background:#1e293b;color:#e2e8f0;}
body.dark .grp-rank-table tr:hover td{background:#243248;}
body.dark #bottomNav{background:#1e293b;border-color:#2d3f55;}
body.dark #actionBar{background:#1e293b;border-color:#2d3f55;}
body.dark .btn-w{background:#243248;color:#cbd5e1;border-color:#3a4f6a;}
body.dark .btn-w:hover{background:#2d3f55;}
body.dark #actionBar{background:#162032;border-color:#2d3f55;}
body.dark .stabs{background:#162032;}
body.dark .stab{color:#64748b;}
body.dark .stab.on{background:#2563eb;color:#fff;}
body.dark .match-builder{background:#1e293b;border-color:#2d3f55;}
body.dark .mem-tag{border-color:#3a4f6a;}
body.dark .sdrop{background:#1e293b;border-color:#2d3f55;}
body.dark .sitem:hover{background:#1e3a5f;}
body.dark .tier-filter-btn{background:#1e293b;border-color:#3a4f6a;color:#94a3b8;}
body.dark .tier-filter-btn:hover{border-color:#60a5fa;color:#60a5fa;}
body.dark .tier-filter-btn.on{background:#2563eb;color:#fff;border-color:#2563eb;}
body.dark .pill{background:#1e293b;border-color:#3a4f6a;color:#94a3b8;}
body.dark .pill.on{background:#2563eb;color:#fff;}
body.dark .sort-bar{background:#162032;border-color:#2d3f55;}
body.dark .sort-btn{background:#1e293b;border-color:#3a4f6a;color:#94a3b8;}
body.dark .sort-btn.on{background:#2563eb;color:#fff;}
/* ë‹¤í¬ëª¨ë“œ ê³µìœ ì¹´ë“œ ëª¨ë‹¬ */
body.dark .sharecard-modal-box{background:#1e293b;border:1px solid #2d3f55;color:#e2e8f0;}
body.dark .sharecard-modal-box .mtitle,
body.dark .sharecard-modal-box [style*="color:var(--blue)"]{color:#60a5fa!important;}
body.dark .sharecard-modal-close{color:#64748b;}
body.dark .sharecard-modal-close:hover{color:#e2e8f0;}
/* ê³µìœ ì¹´ë“œ ëª¨ë‹¬ì€ ë‹¤í¬ëª¨ë“œì¼ ë•Œë§Œ ì–´ë‘¡ê²Œ, ì•„ë‹ ë•ŒëŠ” ê¸°ë³¸ í°ìƒ‰ */
body:not(.dark) .sharecard-modal-box{background:#ffffff;}
/* ë‹¤í¬ëª¨ë“œ ì¶”ê°€ ìš”ì†Œ */
body.dark .tour-wrap{background:linear-gradient(160deg,#162032,#1e3a5f,#162032);}
body.dark .mcard{background:#1e293b;border-color:#2d3f55;}
body.dark .mteam{background:#162032;border-color:#3a4f6a;color:#cbd5e1;}
body.dark .mteam.set{color:#e2e8f0;}
body.dark .msel{background:#162032;border-color:#3a4f6a;color:#e2e8f0;}
body.dark .vs-box{background:#1e293b;border-color:#2d3f55;}
body.dark .srow{background:#1e293b;border-color:#2d3f55;}
body.dark .set-block{background:#1e293b;border-color:#2d3f55;}
body.dark .set-block.ace{border-color:#7c3aed;}
body.dark .game-row{background:#162032;}
body.dark .ocard{background:#1e293b;border-color:#2d3f55;}
body.dark .rscard{background:#1e293b;border-color:#2d3f55;}
body.dark .ipanel{background:#1e293b;border-color:#2d3f55;}
body.dark .rec-card{background:#1e293b;border-color:#2d3f55;}
body.dark .rec-header{background:#162032;border-color:#2d3f55;}
/* ë‹¤í¬ëª¨ë“œ ì¶”ê°€: ë“œë¡­ë‹¤ìš´, ê²€ìƒ‰ê²°ê³¼, ë²„íŠ¼ ë“± */
body.dark #ck-search-results,
body.dark #pro-a-drop,
body.dark #pro-b-drop,
body.dark #tt-a-drop,
body.dark #tt-b-drop,
body.dark #globalSearchDrop{background:#1e293b!important;border-color:#2d3f55!important;color:#e2e8f0;}
body.dark #ck-search-results div:hover,
body.dark #pro-a-drop div:hover,
body.dark #pro-b-drop div:hover,
body.dark #tt-a-drop div:hover,
body.dark #tt-b-drop div:hover{background:#243248!important;}
body.dark .grp-match-score.score-click{background:var(--white)!important;}
body.dark input[type="text"],
body.dark input[type="date"],
body.dark input[type="password"],
body.dark select,
body.dark textarea{background:#1e293b!important;color:#e2e8f0!important;border-color:#3a4f6a!important;}
/* ë²„íŠ¼ íŒ€ ë°°ì • ë‹¤í¬ */
body.dark button[onclick*="proAddPlayer"],
body.dark button[onclick*="ttAddPlayer"]{background:#1e293b!important;color:#93c5fd!important;border:1px solid #2d3f55!important;}
/* ëŒ€íšŒ ì¸ë¼ì¸ ë°°ê²½ ë‹¤í¬ */
body.dark [style*="background:#fff;"]:not(.sharecard-modal-box):not([onclick*="canvas"]){background:var(--white)!important;}
body.dark [style*="background:#ffffff"]:not(.sharecard-modal-box){background:var(--white)!important;}
body.dark [style*="background: #fff"]:not(.sharecard-modal-box){background:var(--white)!important;}
body.dark [style*="background:#fffff8"]{background:var(--surface)!important;}
body.dark [style*="background:#f5f3ff"]{background:#2d1854!important;}
body.dark [style*="background:#ffffeb"]{background:var(--surface)!important;}
body.dark [style*="background:#fffbeb"]{background:var(--surface)!important;border-color:var(--border)!important;}
body.dark [style*="background:#fff1f1"]{background:#2d1a1a!important;}
body.dark [style*="background:#f1f5f9"]{background:var(--surface)!important;}
body.dark .champ-box{background:linear-gradient(135deg,#2d200a,#3d2900)!important;border-color:#78500a!important;}
</style>
</head>
<body>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ (í—¤ë” ë²„íŠ¼ í´ë¦­ ì‹œ) -->
<div id="loginModal" class="modal no-export" style="display:none">
  <div class="mbox" style="width:340px;text-align:center;padding:32px 28px">
    <div style="font-size:32px;margin-bottom:8px">ğŸ”</div>
    <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:17px;color:#1e3a8a;margin-bottom:20px">ê´€ë¦¬ì ë¡œê·¸ì¸</div>
    <input type="text" id="li-id" placeholder="ì•„ì´ë””" autocomplete="username"
      style="width:100%;padding:10px 14px;border:1.5px solid var(--border2);border-radius:8px;font-size:13px;margin-bottom:10px;display:block"
      onkeydown="if(event.key==='Enter')document.getElementById('li-pw').focus()">
    <input type="password" id="li-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password"
      style="width:100%;padding:10px 14px;border:1.5px solid var(--border2);border-radius:8px;font-size:13px;margin-bottom:10px;display:block"
      onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()" style="width:100%;padding:11px;background:linear-gradient(135deg,#1e3a8a,#2563eb);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer">ğŸ” ë¡œê·¸ì¸</button>
    <div class="login-err" id="li-err" style="color:#dc2626;font-size:12px;margin-top:8px;min-height:18px"></div>
    <button onclick="cm('loginModal')" style="margin-top:10px;background:none;border:none;color:var(--gray-l);font-size:12px;cursor:pointer">ì·¨ì†Œ</button>
  </div>
</div>

<div class="app">
<div class="hdr">
  <span class="hdr-ico">ğŸ†</span>
  <div class="hdr-title">ìŠ¤íƒ€ëŒ€í•™ ë°ì´í„° ì„¼í„°</div>
  <div class="hdr-ver">V49.2</div>
  <div style="margin-left:auto;display:flex;gap:6px;z-index:1;align-items:center">
    <!-- ì „ì²´ ì„ ìˆ˜ ê²€ìƒ‰ -->
    <div style="position:relative">
      <input id="globalSearch" type="text" placeholder="ğŸ” ì„ ìˆ˜ ê²€ìƒ‰..." oninput="onGlobalSearch(this.value)"
        style="width:160px;padding:5px 12px;border-radius:20px;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.15);color:#fff;font-size:12px;outline:none;"
        onfocus="this.style.background='rgba(255,255,255,.25)'" onblur="this.style.background='rgba(255,255,255,.15)'">
      <div id="globalSearchDrop" style="display:none;position:fixed;top:50px;right:16px;background:var(--white);border:1px solid var(--border2);border-radius:10px;width:300px;max-height:360px;overflow-y:auto;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,.22)"></div>
    </div>
    <span id="hdrLoginStatus" style="color:rgba(255,255,255,.7);font-size:11px;display:none">âœ… ê´€ë¦¬ì</span>
    <button id="darkToggleBtn" onclick="toggleDark()" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);color:#fff;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;z-index:1">ğŸŒ™ ë‹¤í¬</button>
    <button id="hdrLoginBtn" class="hdr-login-btn" onclick="om('loginModal')">ğŸ” ë¡œê·¸ì¸í•˜ê¸°</button>
    <button id="hdrLogoutBtn" class="hdr-login-btn" style="display:none;background:rgba(220,38,38,.4);border-color:rgba(220,38,38,.5)" onclick="doLogout()">ğŸ”“ ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</div>

<div class="tabs no-export">
  <button class="tab on"  onclick="sw('total',this)">ğŸ“‹ ìŠ¤íŠ¸ë¦¬ë¨¸</button>
  <button class="tab"     onclick="sw('board',this)">ğŸ“Š í˜„í™©íŒ</button>
  <button class="tab"     onclick="sw('tier',this)">ğŸ“Š í‹°ì–´ ìˆœìœ„í‘œ</button>
  <button class="tab"     onclick="sw('hist',this)">ğŸ“… ëŒ€ì „ ê¸°ë¡</button>
  <button class="tab"     onclick="sw('mini',this)">âš¡ ë¯¸ë‹ˆëŒ€ì „</button>
  <button class="tab"     onclick="sw('univck',this)">ğŸ¤ ëŒ€í•™CK</button>
  <button class="tab"     onclick="sw('univm',this)">ğŸŸï¸ ëŒ€í•™ëŒ€ì „</button>
  <button class="tab"     onclick="sw('comp',this)">ğŸ–ï¸ ëŒ€íšŒ</button>
  <button class="tab"     onclick="sw('pro',this)">ğŸ… í”„ë¡œë¦¬ê·¸</button>
  <button class="tab" onclick="sw('stats',this)">ğŸ“Š í†µê³„</button>
  <button class="tab" onclick="sw('cal',this)">ğŸ“… ìº˜ë¦°ë”</button>
  <button id="tabMember" class="tab" onclick="sw('member',this)">ğŸ‘¥ íšŒì›ê´€ë¦¬</button>
  <button id="tabCfg" class="tab cfg" onclick="sw('cfg',this)">âš™ï¸ ì„¤ì •</button>
</div>

<div id="fstrip" class="fstrip no-export lock-admin">
  <div class="form-row">
    <span class="flabel">ğŸ¬ ìŠ¤íŠ¸ë¦¬ë¨¸ ë“±ë¡</span>
    <select id="p-univ"></select>
    <select id="p-tier"></select>
    <select id="p-race"><option value="T">í…Œë€</option><option value="Z">ì €ê·¸</option><option value="P">í”„ë¡œí† ìŠ¤</option></select>
    <select id="p-gender"><option value="F">ğŸ‘© ì—¬ì</option><option value="M">ğŸ‘¨ ë‚¨ì</option></select>
    <input type="text" id="p-name" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„" style="width:120px;">
    <input type="text" id="p-role" placeholder="ì§ì±…(ì„ íƒ)" style="width:90px;">
    <button class="btn btn-b" onclick="addPlayer()">+ ë“±ë¡</button>
  </div>
  <div class="form-row" style="border-color:#93c5fd;background:#f0f6ff;">
    <span class="flabel">âš”ï¸ ê²½ê¸° ê¸°ë¡</span>
    <input type="date" id="m-date">
    <button class="btn btn-w btn-xs" onclick="document.getElementById('m-date').valueAsDate=new Date()" title="ì˜¤ëŠ˜ ë‚ ì§œë¡œ" style="padding:3px 8px;font-size:11px;flex-shrink:0">ì˜¤ëŠ˜</button>
    <div class="swrap">
      <input type="text" id="ws" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ê²€ìƒ‰..." onkeyup="fsearch('w');if(event.key==='Enter')recMatch()" style="width:130px;">
      <div id="wl" class="sdrop"></div>
    </div>
    <span style="font-weight:800;color:var(--gray-l);">VS</span>
    <div class="swrap">
      <input type="text" id="ls" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ê²€ìƒ‰..." onkeyup="fsearch('l');if(event.key==='Enter')recMatch()" style="width:130px;">
      <div id="ll" class="sdrop"></div>
    </div>
    <select id="m-map"></select>
    <button class="btn btn-g" onclick="recMatch()">ğŸ’¾ ì €ì¥</button>
  </div>
</div>

<div class="main"><div id="cap">
  <div class="rtitle" id="rtitle"></div>
  <div id="farea" class="no-export"></div>
  <div id="rcont"></div>
</div></div>

<!-- í•˜ë‹¨ ì•¡ì…˜ ë²„íŠ¼ ë°” -->
<input type="file" id="fi" style="display:none" onchange="doFile(this)">
<div id="actionBar" style="display:flex;align-items:center;gap:8px;padding:10px 18px;background:var(--surface);border-top:1px solid var(--border);flex-wrap:wrap;">
  <button class="btn btn-b" onclick="doJpg()" style="display:flex;align-items:center;gap:5px;"><span>ğŸ“·</span> ì´ë¯¸ì§€ ì €ì¥</button>
  <button id="btnCloudLoad" class="btn btn-g" onclick="cloudLoad()" style="display:flex;align-items:center;gap:5px;"><span>â˜ï¸</span> ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <button id="btnExportVis" class="btn btn-w" onclick="doExport()" style="display:none;align-items:center;gap:5px;border:1px solid var(--border2);"><span>ğŸ“¤</span> ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
  <button id="btnImportVis" class="btn btn-w" onclick="doImport()" style="display:none;align-items:center;gap:5px;border:1px solid var(--border2);"><span>ğŸ“</span> ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
  <span id="cloudStatus" style="font-size:12px;color:var(--gray-l);margin-left:4px"></span>
  <span id="exportHint" style="font-size:12px;color:var(--gray-l)">ğŸ’¡ ë‹¤ë¥¸ ê¸°ê¸°ì™€ ê³µìœ  ì‹œ ë°ì´í„° ë‚´ë³´ë‚´ê¸° â†’ ê°€ì ¸ì˜¤ê¸°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”</span>
</div>
</div>

<!-- ì„ ìˆ˜ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="emModal" class="modal no-export">
  <div class="mbox">
    <div class="mtitle">âœï¸ ì„ ìˆ˜ ì •ë³´ ìˆ˜ì •</div>
    <div id="emBody"></div>
    <div class="mbtns">
      <button class="btn btn-b" style="flex:1" onclick="savePlayer()">ì €ì¥</button>
      <button class="btn btn-r" style="flex:1" onclick="delPlayer()">ì‚­ì œ</button>
      <button class="btn btn-w" style="flex:1" onclick="cm('emModal')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- ê¸°ë¡ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="reModal" class="modal no-export">
  <div class="mbox">
    <div class="mtitle" id="reTitle">ìˆ˜ì •</div>
    <div id="reBody"></div>
    <div class="mbtns">
      <button class="btn btn-b" style="flex:1" onclick="saveRow()">ì €ì¥</button>
      <button class="btn btn-w" style="flex:1" onclick="cm('reModal')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- ëŒ€íšŒëª… ê´€ë¦¬ ëª¨ë‹¬ -->
<div id="cnModal" class="modal no-export">
  <div class="mbox" style="width:420px;">
    <div class="mtitle">ğŸ–ï¸ ëŒ€íšŒëª… ê´€ë¦¬</div>
    <div id="cnBody"></div>
    <div class="mbtns"><button class="btn btn-w" style="flex:1" onclick="cm('cnModal')">ë‹«ê¸°</button></div>
  </div>
</div>

<!-- ì„ ìˆ˜ ìƒì„¸ ëª¨ë‹¬ -->
<div id="playerModal" class="modal no-export">
  <div class="umbox">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:8px;flex-wrap:wrap">
      <div class="mtitle" id="playerModalTitle" style="margin-bottom:0">ì„ ìˆ˜ ìƒì„¸</div>
      <div style="display:flex;gap:6px;align-items:center">
        <button id="playerModalEditBtn" class="btn btn-o btn-sm" style="display:none" onclick="openEPFromModal()">âœï¸ ìˆ˜ì •</button>
        <button class="btn btn-p btn-sm" onclick="openShareCardFromPlayer()">ğŸ´ ê³µìœ  ì¹´ë“œ</button>
        <button class="btn-capture" onclick="capturePlayerModal()">ğŸ“¸ ì´ë¯¸ì§€ ì €ì¥</button>
        <button class="btn btn-w btn-sm" onclick="cm('playerModal')">âœ• ë‹«ê¸°</button>
      </div>
    </div>
    <div id="playerModalBody"></div>
  </div>
</div>

<!-- ëŒ€í•™ ìƒì„¸ ëª¨ë‹¬ -->
<div id="univModal" class="modal no-export">
  <div class="umbox">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:8px;flex-wrap:wrap">
      <div class="mtitle" id="univModalTitle" style="margin-bottom:0">ëŒ€í•™ ìƒì„¸</div>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="btn btn-p btn-sm" onclick="openShareCardFromUniv()">ğŸ´ ê³µìœ  ì¹´ë“œ</button>
        <button class="btn-capture" onclick="captureUnivModal()">ğŸ“¸ ì´ë¯¸ì§€ ì €ì¥</button>
        <button class="btn btn-w btn-sm" onclick="cm('univModal')">âœ• ë‹«ê¸°</button>
      </div>
    </div>
    <div id="univModalBody"></div>
  </div>
</div>

<!-- ì¡°í¸ì„± ê²½ê¸° ì…ë ¥ ëª¨ë‹¬ -->
<div id="grpMatchModal" class="modal no-export">
  <div class="umbox" style="width:780px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="mtitle" id="grpMatchTitle" style="margin-bottom:0">ê²½ê¸° ì…ë ¥</div>
      <button class="btn btn-w btn-sm" onclick="cm('grpMatchModal')">âœ• ë‹«ê¸°</button>
    </div>
    <div id="grpMatchBody"></div>
  </div>
</div>

<!-- ëŒ€íšŒ ê²½ê¸° ë¶™ì—¬ë„£ê¸° ëª¨ë‹¬ -->
<div id="grpPasteModal" class="modal no-export">
  <div class="umbox" style="width:720px;max-width:96vw">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div class="mtitle" style="margin-bottom:0">ğŸ“‹ ëŒ€íšŒ ê²½ê¸° ê²°ê³¼ ë¶™ì—¬ë„£ê¸° ì¼ê´„ ì…ë ¥</div>
      <button class="btn btn-w btn-sm" onclick="cm('grpPasteModal')">âœ• ë‹«ê¸°</button>
    </div>
    <div id="grpPasteBody"></div>
    <div class="mbtns" style="margin-top:14px;gap:8px">
      <button id="grp-paste-apply-btn" class="btn btn-g" style="flex:1;display:none" onclick="grpPasteApply()">âœ… ì„¸íŠ¸ì— ì ìš©</button>
      <button class="btn btn-w" style="flex:0 0 auto" onclick="cm('grpPasteModal')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- íšŒì› ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
<div id="memberModal" class="modal no-export">
  <div class="umbox" style="width:680px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="mtitle" id="memberModalTitle" style="margin-bottom:0">íšŒì› ì¶”ê°€</div>
      <button class="btn btn-w btn-sm" onclick="cm('memberModal')">âœ• ë‹«ê¸°</button>
    </div>
    <div id="memberModalBody"></div>
    <div class="mbtns" style="margin-top:16px">
      <button class="btn btn-b" style="flex:1" onclick="memberSave()">ğŸ’¾ ì €ì¥</button>
      <button class="btn btn-w" style="flex:1" onclick="cm('memberModal')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- íšŒì› ìƒì„¸ ëª¨ë‹¬ -->
<div id="memberDetailModal" class="modal no-export">
  <div class="umbox" style="width:680px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="mtitle" id="memberDetailTitle" style="margin-bottom:0">íšŒì› ìƒì„¸</div>
      <button class="btn btn-w btn-sm" onclick="cm('memberDetailModal')">âœ• ë‹«ê¸°</button>
    </div>
    <div id="memberDetailBody"></div>
  </div>
</div>

<div id="pasteModal" class="modal no-export">
  <div class="umbox" style="width:740px;max-width:96vw">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div class="mtitle" style="margin-bottom:0">ğŸ“‹ ê²½ê¸° ê²°ê³¼ ë¶™ì—¬ë„£ê¸° ì…ë ¥</div>
      <div style="display:flex;gap:6px;align-items:center">
        <span id="paste-summary-badge" style="display:none;font-size:12px;font-weight:700;padding:3px 10px;border-radius:20px;background:#dcfce7;color:#16a34a;border:1px solid #bbf7d0"></span>
        <button class="btn btn-w btn-sm" onclick="closePasteModal()">âœ• ë‹«ê¸°</button>
      </div>
    </div>

    <!-- ì‚¬ìš©ë²• (ì ‘ê¸°/í¼ì¹˜ê¸°) -->
    <details style="margin-bottom:12px">
      <summary style="font-size:12px;font-weight:700;color:var(--blue);cursor:pointer;padding:6px 10px;background:var(--blue-l);border-radius:8px;border:1px solid var(--blue-ll);list-style:none;display:flex;align-items:center;gap:5px">
        ğŸ“Œ ì‚¬ìš©ë²• ë³´ê¸°
      </summary>
      <div style="background:#eff6ff;border:1px solid #93c5fd;border-radius:0 0 8px 8px;padding:10px 14px;font-size:12px;color:#1e40af;line-height:1.9;margin-top:-1px">
        í˜•ì‹ A: <span style="font-family:monospace;background:#dbeafe;padding:1px 6px;border-radius:4px">[ë§µ] ì„ ìˆ˜ëª…ì¢…ì¡± (ìŠ¹) vs (íŒ¨) ì„ ìˆ˜ëª…ì¢…ì¡±</span><br>
        í˜•ì‹ B: <span style="font-family:monospace;background:#dbeafe;padding:1px 6px;border-radius:4px">ì„ ìˆ˜ëª…[í‹°ì–´ì¢…ì¡±] âŒğŸ†šâ­• ì„ ìˆ˜ëª…[í‹°ì–´ì¢…ì¡±] ğŸŒë§µ</span><br>
        í˜•ì‹ C: <span style="font-family:monospace;background:#dbeafe;padding:1px 6px;border-radius:4px">1ì„¸íŠ¸ ì‹¤í”¼ ì´ì¬í˜¸ 0:1 ë³€í˜„ì œ</span> (ëˆ„ì  ìŠ¤ì½”ì–´ ìë™ íŒë³„)<br>
        ì„¸íŠ¸ êµ¬ë¶„: <span style="font-family:monospace;background:#dbeafe;padding:1px 6px;border-radius:4px">â•â•1ì„¸íŠ¸â•â• / --2ì„¸íŠ¸-- / 1ì…‹ã…¡ã…¡</span> í˜•íƒœ ëª¨ë‘ ì¸ì‹<br>
        ë§µ ì•½ì: <span style="font-family:monospace;background:#dbeafe;padding:1px 6px;border-radius:4px">ë…¹ì•„ Â· ë…¹ â†’ ë…¹ì•„ì›ƒ / ë¼ë° â†’ ë¼ë°ë¦¬ì•ˆ / ë„ë¯¸ â†’ ë„ë¯¸ë„¤ì´í„°</span> ë“± ìë™ ë³€í™˜<br>
        <span style="color:#6b7280;font-size:11px">ğŸ’¡ ì„ ìˆ˜ ì•½ì ìë™ ì¸ì‹ (ì˜ˆ: ì£¼ì–‘ â†’ ì†Œì£¼ì–‘) Â· ì¤‘ë³µ ì‹œ ë²„íŠ¼ìœ¼ë¡œ ì§ì ‘ ì„ íƒ Â· 3ì„¸íŠ¸ ì´ìƒì€ ì—ì´ìŠ¤ì „ìœ¼ë¡œ í‘œì‹œ</span>
      </div>
    </details>

    <!-- ë‚ ì§œ + ì €ì¥ í˜•ì‹ -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap;padding:10px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px">
      <label style="font-size:12px;font-weight:700;color:var(--text2)">ğŸ“… ë‚ ì§œ</label>
      <input type="date" id="paste-date" style="border:1px solid var(--border2);border-radius:7px;padding:5px 10px;font-size:13px">
      <label style="font-size:12px;font-weight:700;color:var(--text2);margin-left:4px" id="paste-mode-label">ğŸ“ ì €ì¥ í˜•ì‹</label>
      <select id="paste-mode" onchange="onPasteModeChange(this.value)" style="border:1px solid var(--border2);border-radius:7px;padding:5px 10px;font-size:13px">
        <option value="individual">ê°œì¸ ì „ì ë§Œ (íˆìŠ¤í† ë¦¬)</option>
        <option value="mini">âš¡ ë¯¸ë‹ˆëŒ€ì „ìœ¼ë¡œ ì €ì¥</option>
        <option value="univm">ğŸŸï¸ ëŒ€í•™ëŒ€ì „ìœ¼ë¡œ ì €ì¥</option>
        <option value="pro">ğŸ… í”„ë¡œë¦¬ê·¸ë¡œ ì €ì¥</option>
        <option value="comp">ğŸ–ï¸ ëŒ€íšŒ ê¸°ë¡ìœ¼ë¡œ ì €ì¥</option>
      </select>
      <div id="paste-comp-wrap" style="display:none;align-items:center;gap:6px;flex-wrap:wrap">
        <input type="text" id="paste-comp-name" placeholder="ëŒ€íšŒëª… ì…ë ¥" style="border:1px solid var(--border2);border-radius:7px;padding:5px 10px;font-size:13px;width:180px">
      </div>
      <div id="paste-mode-hint" style="font-size:11px;color:var(--gray-l);width:100%;margin-top:2px"></div>
    </div>

    <div style="position:relative">
      <textarea id="paste-input" placeholder="ì—¬ê¸°ì— ê²½ê¸° ê²°ê³¼ë¥¼ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”...&#10;&#10;ì˜ˆì‹œ (í˜•ì‹A): 1. [ë„ë¯¸] ë„ì¬ìš±P (ìŠ¹) vs (íŒ¨) ìœ ì˜ì§„T&#10;ì˜ˆì‹œ (í˜•ì‹B): ë¦¬ë‚˜[4P]âŒğŸ†šâ­•í–‡ì‚´[4T]ğŸŒë…¹ì•„"
        style="width:100%;min-height:140px;font-size:13px;border:1.5px solid var(--border2);border-radius:10px;padding:12px 36px 12px 12px;resize:vertical;font-family:'Noto Sans KR',monospace;line-height:1.8;box-sizing:border-box"
        oninput="pastePreview()" onpaste="setTimeout(pastePreview,0)"></textarea>
      <button onclick="document.getElementById('paste-input').value='';pastePreview();"
        title="ì…ë ¥ ì§€ìš°ê¸°"
        style="position:absolute;top:8px;right:8px;background:var(--border2);border:none;border-radius:5px;width:22px;height:22px;font-size:13px;line-height:1;cursor:pointer;color:var(--text3);display:flex;align-items:center;justify-content:center;transition:.15s;"
        onmouseover="this.style.background='#dc2626';this.style.color='#fff'"
        onmouseout="this.style.background='var(--border2)';this.style.color='var(--text3)'">âœ•</button>
    </div>

    <div id="paste-preview" style="margin-top:12px"></div>

    <div style="display:flex;gap:8px;margin-top:14px;justify-content:flex-end;align-items:center">
      <span id="paste-pending-warn" style="display:none;font-size:11px;color:#b45309;font-weight:600">âš ï¸ ì¤‘ë³µ ì„ íƒ í•„ìš”í•œ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤</span>
      <button class="btn btn-w" onclick="closePasteModal()">ì·¨ì†Œ</button>
      <button class="btn btn-g" onclick="pasteApply()" id="paste-apply-btn" style="display:none">âœ… ì €ì¥í•˜ê¸°</button>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS - í‹°ì–´ ìˆœì„œ: god > king > jack > joker > spade > 0í‹°ì–´ > 1í‹°ì–´ ...
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let TIERS = J('su_tiers') || ['G','K','JA','J','S','0í‹°ì–´','1í‹°ì–´','2í‹°ì–´','3í‹°ì–´','4í‹°ì–´','5í‹°ì–´','6í‹°ì–´','7í‹°ì–´','8í‹°ì–´','ìœ ìŠ¤'];
const RACES=['T','Z','P'];
const RNAME={T:'í…Œë€',Z:'ì €ê·¸',P:'í”„ë¡œí† ìŠ¤'};
const RANK_PTS={'ğŸ¥‡ 1ìœ„':3,'ğŸ¥ˆ 2ìœ„':0,'ğŸ¥‰ 3ìœ„':-3,'4ê°•':0,'8ê°•':0,'ì¶œì „':0};

function getTierBadge(tier){
  if(!tier) return '';
  const map={
    'G':'tbadge tbadge-god',
    'K':'tbadge tbadge-king',
    'JA':'tbadge tbadge-jack',
    'J':'tbadge tbadge-joker',
    'S':'tbadge tbadge-spade',
    '0í‹°ì–´':'tbadge tbadge-0',
    '1í‹°ì–´':'tbadge tbadge-t1',
    '2í‹°ì–´':'tbadge tbadge-t2',
    '3í‹°ì–´':'tbadge tbadge-t3',
    '4í‹°ì–´':'tbadge tbadge-t4',
    '5í‹°ì–´':'tbadge tbadge-t5',
    '6í‹°ì–´':'tbadge tbadge-t6',
    '7í‹°ì–´':'tbadge tbadge-t7',
    '8í‹°ì–´':'tbadge tbadge-t8',
    'ìœ ìŠ¤':'tbadge tbadge-youth',
  };
  // íŠ¹ìˆ˜ í‹°ì–´ë§Œ ì•„ì´ì½˜ ìœ ì§€ (0~8í‹°ì–´/ìœ ìŠ¤ ì•„ì´ì½˜ ì œê±°)
  const icons={'G':'ğŸ‘‘','K':'ğŸ”´','JA':'âš”ï¸','J':'ğŸƒ','S':'â™ '};
  const ic=icons[tier]||'';
  return `<span class="${map[tier]||'tbadge tbadge-default'}">${ic?ic+' ':''}${tier}</span>`;
}

function getTierLabel(tier){
  const icons={G:'ğŸ‘‘',K:'ğŸ”´',JA:'âš”ï¸',J:'ğŸƒ',S:'â™ '};
  const labels={G:'G (God)',K:'K (King)',JA:'JA (Jack)',J:'J (Joker)',S:'S (Spade)'};
  const ic=icons[tier]||'';
  return ic?`${ic} ${labels[tier]||tier}`:tier;
}

function getTierPillLabel(tier){
  const icons={G:'ğŸ‘‘',K:'ğŸ”´',JA:'âš”ï¸',J:'ğŸƒ',S:'â™ ï¸'};
  const labels={G:'G (God)',K:'K (King)',JA:'JA (Jack)',J:'J (Joker)',S:'S (Spade)'};
  return icons[tier]?`${icons[tier]} ${labels[tier]||tier}`:tier;
}

// í‹°ì–´ í•„í„° ë²„íŠ¼ ìƒ‰ìƒ (tbadgeì™€ ë™ì¼ ê³„ì—´)
function getTierBtnColor(tier){
  const c={
    'G':'#091540','K':'#102058','JA':'#182d80',
    'J':'#2040a8','S':'#2d52c8',
    '0í‹°ì–´':'#3860d8',
    '1í‹°ì–´':'#4070e0','2í‹°ì–´':'#5888f0','3í‹°ì–´':'#6e9ef8','4í‹°ì–´':'#84b4ff',
    '5í‹°ì–´':'#9ecaff','6í‹°ì–´':'#b2dcff','7í‹°ì–´':'#c6ecff','8í‹°ì–´':'#d8f4ff','ìœ ìŠ¤':'#d97706'
  };
  return c[tier]||'#64748b';
}
function getTierBtnTextColor(tier){
  return ['5í‹°ì–´','6í‹°ì–´','7í‹°ì–´','8í‹°ì–´'].includes(tier)?'#1d4ed8':'#fff';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì§ì±… ì‹œìŠ¤í…œ
   - MAIN_ROLES: ì •ë ¬ ìˆœì„œì— ì˜í–¥, í‘œì‹œ+ì •ë ¬
   - SUB_ROLES: í‘œì‹œë§Œ (í•™ìƒíšŒì¥, ì˜¤ë½ë¶€ì¥ ë“±)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MAIN_ROLES = ['ì´ì‚¬ì¥','ì´ì¥','ë¶€ì´ì¥','ì´ê´„','êµìˆ˜','ì½”ì¹˜'];
const ROLE_ICONS = {'ì´ì‚¬ì¥':'ğŸ‘”','ì´ì¥':'ğŸ“','ë¶€ì´ì¥':'ğŸ“š','ì´ê´„':'ğŸ›ï¸','êµìˆ˜':'ğŸ«','ì½”ì¹˜':'ğŸ¯'};
const ROLE_COLORS = {'ì´ì‚¬ì¥':'#7c3aed','ì´ì¥':'#dc2626','ë¶€ì´ì¥':'#d97706','ì´ê´„':'#0891b2','êµìˆ˜':'#2563eb','ì½”ì¹˜':'#16a34a'};

function getRoleOrder(role){
  // MAIN_ROLESë§Œ ì •ë ¬ ì ìš©, SUB_ROLES ë° ê¸°íƒ€ëŠ” 99(ì •ë ¬ ë¬´ê´€)
  if(!role) return 99;
  const idx = MAIN_ROLES.indexOf(role);
  return idx>=0 ? idx : 99;
}
function getRoleBadgeHTML(role, size='11px'){
  if(!role) return '';
  const icon = ROLE_ICONS[role]||'ğŸ·ï¸';
  const col = ROLE_COLORS[role]||'#6b7280';
  // MAIN_ROLESëŠ” ì§„í•œ ë°°ê²½ìƒ‰, ê·¸ ì™¸ëŠ” ì—°í•œ ë°°ê²½
  const isMain = MAIN_ROLES.includes(role);
  if(isMain){
    return `<span style="font-size:${size};padding:2px 7px;border-radius:5px;background:${col};color:#fff;font-weight:800;white-space:nowrap;flex-shrink:0;letter-spacing:.3px;text-shadow:0 1px 2px rgba(0,0,0,.2)">${icon} ${role}</span>`;
  }
  return `<span style="font-size:${size};padding:1px 6px;border-radius:4px;background:${col}20;color:${col};border:1px solid ${col}44;font-weight:700;white-space:nowrap;flex-shrink:0">${icon} ${role}</span>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA LOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function J(k){try{const v=localStorage.getItem(k);return v?JSON.parse(v):null;}catch{return null;}}

let players    = J('su_p')  || [];
let boardOrder = J('su_boardOrder') || []; // í˜„í™©íŒ ëŒ€í•™ ìˆœì„œ
let univCfg    = J('su_u')  || [{name:'í‘ì¹´ë°ë¯¸',color:'#1e3a8a'},{name:'JSA',color:'#c2410c'},{name:'ëŠªì§€ëŒ€',color:'#15803d'},{name:'ë¬´ì†Œì†',color:'#6b7280'}];
let maps       = J('su_m')  || ['íˆ¬í˜¼','ì„œí‚·','ë¸”ë¦¬ì¸ ','ì‹  ê°œë§ˆê³ ì›'];
let userMapAlias = J('su_mAlias') || {};   // ì‚¬ìš©ì ì •ì˜ ë§µ ì•½ì { 'ì•½ì': 'ì „ì²´ì´ë¦„' }
let tourD      = J('su_t')  || Array(15).fill('');
let miniM      = J('su_mm') || [];
let univM      = J('su_um') || [];
let comps      = J('su_cm') || [];
let ckM        = J('su_ck') || [];
let compNames  = J('su_cn') || [];
let curComp    = J('su_cc') || '';
// í”„ë¡œë¦¬ê·¸ ë°ì´í„°
let proM       = J('su_pro') || [];
// íšŒì› ê´€ë¦¬ ë°ì´í„°: [{id,nick,uid,status,banType,banEnd,banDone,category,memo,posts:[{url,savedAt,note}],comments:[{url,savedAt,note}],createdAt,updatedAt}]
let members    = J('su_mb') || [];
// ëŒ€íšŒ ì¡°í¸ì„±: [{id,name,groups:[{name,univs:[],matches:[{a,b,sa,sb,sets:[]}]}]}]
let tourneys   = J('su_tn') || [];
let ttM        = J('su_ttm') || [];

let BLD = {};
let openDetails = {};

// â”€â”€ ì„ ìˆ˜ë³„ ìƒíƒœ ì•„ì´ì½˜ ì‹œìŠ¤í…œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let playerStatusIcons = J('su_psi') || {};
const STATUS_ICON_DEFS = {
  none:    { label: 'ì—†ìŒ',    emoji: '' },
  up:      { label: 'ìŠ¹ê¸‰',    emoji: 'â¬†ï¸' },
  rise:    { label: 'ìƒìŠ¹',    emoji: 'ğŸ”¥' },
  stay:    { label: 'ìœ ì§€',    emoji: 'âœ…' },
  freeze:  { label: 'ì–¼ìŒ',    emoji: 'ğŸ§Š' },
  down:    { label: 'ê°•ë“±',    emoji: 'â¬‡ï¸' },
  custom1: { label: 'ì»¤ìŠ¤í…€1', emoji: J('su_si_c1') || 'â­' },
  custom2: { label: 'ì»¤ìŠ¤í…€2', emoji: J('su_si_c2') || 'ğŸ’ª' },
  custom3: { label: 'ì»¤ìŠ¤í…€3', emoji: J('su_si_c3') || 'ğŸ’€' },
};
function getStatusIcon(name){ return playerStatusIcons[name]||''; }
function setStatusIcon(name, iconId){
  if(!iconId||iconId==='none') delete playerStatusIcons[name];
  else playerStatusIcons[name]=STATUS_ICON_DEFS[iconId]?.emoji||iconId;
  localStorage.setItem('su_psi', JSON.stringify(playerStatusIcons));
}
function saveCustomStatusIcon(slot, emoji){
  localStorage.setItem('su_si_c'+slot, emoji);
  const k='custom'+slot;
  if(STATUS_ICON_DEFS[k]) STATUS_ICON_DEFS[k].emoji=emoji;
}
function getPlayerPhotoHTML(playerName, size, extraStyle){
  size=size||'28px'; extraStyle=extraStyle||'';
  const p=players.find(x=>x.name===playerName);
  const base='display:inline-block;width:'+size+';height:'+size+';border-radius:50%;flex-shrink:0;vertical-align:middle;'+extraStyle;
  if(!p||!p.photo) return '<span style="'+base+';background:var(--border2);border:1.5px solid var(--border)"></span>';
  return '<img src="'+p.photo+'" style="'+base+';object-fit:cover;border:1.5px solid var(--border)" onerror="this.style.display=\'none\'">';
}
function getStatusIconHTML(name){
  const ic=getStatusIcon(name);
  return ic?`<span style="font-size:13px;margin-left:3px;flex-shrink:0">${ic}</span>`:'';
}

function fixPoints(){
  // êµ¬ í‹°ì–´ëª… â†’ ìƒˆ ì•½ì–´ ë§ˆì´ê·¸ë ˆì´ì…˜
  const tierMap={god:'G',king:'K',jack:'JA',joker:'J',spade:'S'};
  players.forEach(p=>{
    if(!p.history)p.history=[];
    if(p.points===undefined)p.points=0;
    if(!p.win)p.win=0; if(!p.loss)p.loss=0;
    if(!p.gender || !['M','F'].includes(p.gender))p.gender='F';
    if(tierMap[p.tier])p.tier=tierMap[p.tier]; // ê¸°ì¡´ ë°ì´í„° ìë™ ë³€í™˜
  });
}

function save(){
  localStorage.setItem('su_tiers',JSON.stringify(TIERS));
  localStorage.setItem('su_p', JSON.stringify(players));
  localStorage.setItem('su_u', JSON.stringify(univCfg));
  localStorage.setItem('su_m', JSON.stringify(maps));
  localStorage.setItem('su_mAlias', JSON.stringify(userMapAlias));
  localStorage.setItem('su_t', JSON.stringify(tourD));
  localStorage.setItem('su_mm',JSON.stringify(miniM));
  localStorage.setItem('su_um',JSON.stringify(univM));
  localStorage.setItem('su_cm',JSON.stringify(comps));
  localStorage.setItem('su_ck',JSON.stringify(ckM));
  localStorage.setItem('su_cn',JSON.stringify(compNames));
  localStorage.setItem('su_cc',JSON.stringify(curComp));
  localStorage.setItem('su_pro',JSON.stringify(proM));
  localStorage.setItem('su_mb',JSON.stringify(members));
  localStorage.setItem('su_tn',JSON.stringify(tourneys));
  localStorage.setItem('su_ttm',JSON.stringify(ttM));
  localStorage.setItem('su_boardOrder',JSON.stringify(boardOrder));
  localStorage.setItem('su_bpo',JSON.stringify(boardPlayerOrder));
  localStorage.setItem('su_psi',JSON.stringify(playerStatusIcons));
}

let curTab='total', editName='', reMode='', reIdx=-1;
let histPage={mini:0, ck:0, univm:0, comp:0, pro:0, tiertour:0, tt:0}; // ëŒ€ì „ê¸°ë¡ íƒ­ í˜ì´ì§€ ìƒíƒœ
let playerHistPage=0; // ì„ ìˆ˜ ìƒì„¸ í˜ì´ì§€ ìƒíƒœ
const HIST_PAGE_SIZE=20;
const HIST_PAGE_SIZE_MOBILE=10;
function getHistPageSize(){return window.innerWidth<=768?HIST_PAGE_SIZE_MOBILE:HIST_PAGE_SIZE;}
const PLAYER_HIST_PAGE_SIZE=10; // REQ4: ì„ ìˆ˜ ìƒì„¸ 10ê°œ ì´ìƒì¼ ë•Œ í˜ì´ì§€ë„¤ì´ì…˜
let calYear=new Date().getFullYear(), calMonth=new Date().getMonth(), calView='month';
let voteData=JSON.parse(localStorage.getItem('su_votes')||'{}');
let fUniv='ì „ì²´', fTier='ì „ì²´';
let miniSub='input', univmSub='input', ckSub='input', compSub='league', histSub='mini';
let histUniv='';
let searchTarget='';
let recSortDir='desc'; // ë‚ ì§œ ì •ë ¬: 'desc'=ìµœì‹ ìˆœ, 'asc'=ì˜¤ë˜ëœìˆœ
let vsNameA='', vsNameB=''; // 1:1 ìƒëŒ€ì „ì  ì¡°íšŒ

// ê³µí†µ ì—°ë„/ì›” í•„í„° ìƒíƒœ
let yearOptions=['2026'];
let filterYear='ì „ì²´';
let filterMonth='ì „ì²´'; // 'ì „ì²´' ë˜ëŠ” '01'~'12'

function gc(n){const u=univCfg.find(x=>x.name===n);return u?u.color:'#6b7280';}
// ìŠ¤íƒ€ëŒ€í•™ ì•„ì´ì½˜ URL ë§¤í•‘
const UNIV_ICONS={
  'ì— ë¹„ëŒ€':'https://i.ibb.co/6cfNW2Nt/image.png',
  'ì™€í”ŒëŒ€':'https://i.ibb.co/Zp8f2w8c/image.png',
  'ì •ì„ ëŒ€':'https://i.ibb.co/QFc22RMp/image.png',
  'ì¸ ìº„ëª¬ìŠ¤íƒ€ì¦ˆ':'https://i.ibb.co/ZpRrMWMt/image.png',
  'ìˆ˜ìˆ ëŒ€':'https://i.ibb.co/Q7CGzwck/image.png',
  'JSA':'https://i.ibb.co/tpdY6Z6T/jsa.png',
  'ëŠªì§€ëŒ€':'https://i.ibb.co/1YhTgzdS/image.png',
  'ë‰´ìº£ìŠ¬':'https://i.ibb.co/qM7NQVMr/image.png',
  'ì”¨ë‚˜ì¸':'https://i.ibb.co/8nyMJyWh/image.png',
  'HM':'https://i.ibb.co/ksZY7Ksq/hm-1.png',
  'BGM':'https://i.ibb.co/PGL06DJb/bgm-1.png',
  'í‘ì¹´ë°ë¯¸':'https://i.ibb.co/VW7Rw0G7/image.png',
  'ì¼€ì´ëŒ€':'https://i.ibb.co/8n196Hq8/image.png',
  'ì´ë…¸ëŒ€':'https://i.ibb.co/pjK8Hb1Z/image.png'
};
// ê¸°ë³¸ ëŒ€í•™ ì•„ì´ì½˜ SVG (ì•„ì´ì½˜ì´ ì—†ëŠ” ëŒ€í•™ì— ì‚¬ìš©)
const DEFAULT_UNIV_ICON_SVG=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" data-univ-icon="1" style="flex-shrink:0;opacity:0.75;vertical-align:middle"><path d="M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z"/></svg>`;
// ëŒ€í•™ëª… ì˜†ì— ì•„ì´ì½˜ img íƒœê·¸ ë°˜í™˜ (ì•„ì´ì½˜ ì—†ìœ¼ë©´ ê¸°ë³¸ SVG ë°˜í™˜)
function gUI(n,size='1em'){
  const url=UNIV_ICONS[n]||(univCfg.find(x=>x.name===n)||{}).icon||'';
  if(url)return `<img src="${url}" alt="" data-univ-icon="1" style="width:${size};height:${size};object-fit:contain;vertical-align:middle;margin-right:3px;border-radius:2px;flex-shrink:0" onerror="this.style.display='none'">`;
  // ê¸°ë³¸ ì•„ì´ì½˜ SVG
  return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" data-univ-icon="1" style="width:${size};height:${size};flex-shrink:0;opacity:0.75;vertical-align:middle;margin-right:3px"><path d="M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z"/></svg>`;
}
// ëŒ€í•™ëª… + ì•„ì´ì½˜ HTML ë°˜í™˜ (ì•„ì´ì½˜ì´ ì¢Œì¸¡ì— ìœ„ì¹˜)
function univNameWithIcon(n,fontSize){const icon=gUI(n,fontSize||'1em');return icon+n;}
// DOM ìš”ì†Œ ë‚´ ubadgeì— ëŒ€í•™ ì•„ì´ì½˜ ì£¼ì… (í•­ìƒ ì¢Œì¸¡ì—, ê¸°ë³¸ ì•„ì´ì½˜ í¬í•¨)
function injectUnivIcons(container){
  if(!container)return;
  container.querySelectorAll('.ubadge').forEach(el=>{
    if(el.querySelector('[data-univ-icon]')||el.getAttribute('data-icon-done'))return;
    let name='';
    el.childNodes.forEach(node=>{if(node.nodeType===3)name+=node.textContent;});
    name=name.trim().replace(/\s+/g,' ');
    if(!name)return;
    el.setAttribute('data-icon-done','1');
    // inline-flex ë ˆì´ì•„ì›ƒìœ¼ë¡œ ì •ë ¬
    if(!el.style.display||el.style.display==='inline-block')el.style.display='inline-flex';
    el.style.alignItems='center';
    el.style.gap='3px';
    const url=UNIV_ICONS[name]||(univCfg.find(x=>x.name===name)||{}).icon||'';
    if(url){
      const img=document.createElement('img');
      img.src=url; img.setAttribute('data-univ-icon','1');
      img.style.cssText='width:1em;height:1em;object-fit:contain;vertical-align:middle;border-radius:2px;flex-shrink:0';
      img.onerror=function(){this.style.display='none';};
      el.insertBefore(img,el.firstChild);
    } else {
      // ê¸°ë³¸ ì•„ì´ì½˜ SVG ì‚½ì…
      const svgWrap=document.createElement('span');
      svgWrap.setAttribute('data-univ-icon','1');
      svgWrap.style.cssText='display:inline-flex;align-items:center;flex-shrink:0';
      svgWrap.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:1em;height:1em;opacity:0.75"><path d="M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z"/></svg>`;
      el.insertBefore(svgWrap,el.firstChild);
    }
  });
}
function pC(n){return n>0?'pt-p':n<0?'pt-n':'pt-z';}
function pS(n){return (n>0?'+':'')+n;}
function getAllUnivs(){
  const r=[...univCfg];const s=new Set(univCfg.map(u=>u.name));
  players.forEach(p=>{if(!s.has(p.univ)){r.push({name:p.univ,color:'#6b7280'});s.add(p.univ);}});
  return r;
}

// í˜„í™©íŒ boardOrder â†’ univCfg ìˆœì„œ ë™ê¸°í™” (í˜„í™©íŒì—ì„œ ì´ë™í•˜ë©´ ìŠ¤íŠ¸ë¦¬ë¨¸ ëª©ë¡ë„ ê°™ì´ ì´ë™)
function syncBoardOrderToUnivCfg(){
  if(!boardOrder||!boardOrder.length) return;
  const newCfg=[];
  boardOrder.forEach(name=>{const u=univCfg.find(x=>x.name===name);if(u)newCfg.push(u);});
  univCfg.forEach(u=>{if(!boardOrder.includes(u.name))newCfg.push(u);});
  if(newCfg.length===univCfg.length){univCfg=newCfg;save();}
}
function getMembers(univ){return players.filter(p=>p.univ===univ);}

function genderIcon(gender){
  if(gender==='M')return `<span class="male-icon">â™‚</span>`;
  return '';
}

/* ELO ìƒìˆ˜ */
const ELO_DEFAULT=1200;
const ELO_K=32;

function calcElo(winnerElo, loserElo){
  const exp=1/(1+Math.pow(10,(loserElo-winnerElo)/400));
  return Math.round(ELO_K*(1-exp));
}

function applyGameResult(winName, loseName, date, map, matchId){
  const w=players.find(p=>p.name===winName);
  const l=players.find(p=>p.name===loseName);
  if(!w||!l||w===l)return;
  w.win++;l.loss++;w.points+=3;l.points-=3;
  // ELO ê³„ì‚°
  const wElo=w.elo||ELO_DEFAULT;
  const lElo=l.elo||ELO_DEFAULT;
  const delta=calcElo(wElo,lElo);
  w.elo=wElo+delta;
  l.elo=lElo-delta;
  const t=Date.now();
  const d=date||new Date().toISOString().slice(0,10);
  const m=map||'-';
  w.history.unshift({date:d,time:t,result:'ìŠ¹',opp:l.name,oppRace:l.race,map:m,matchId:matchId||'',eloDelta:delta,eloAfter:w.elo});
  l.history.unshift({date:d,time:t,result:'íŒ¨',opp:w.name,oppRace:w.race,map:m,matchId:matchId||'',eloDelta:-delta,eloAfter:l.elo});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëŒ€ì „ ê¸°ë¡ ì‚­ì œ ì‹œ ì„ ìˆ˜ ìŠ¤íƒ¯ ì™„ì „ ë¡¤ë°±
   - matchId ìˆìœ¼ë©´ matchIdë¡œ ì •í™•íˆ ì œê±°
   - matchId ì—†ìœ¼ë©´(êµ¬ ë°ì´í„°) ë‚ ì§œ+ìƒëŒ€ ì¡°í•©ìœ¼ë¡œ ì œê±°
   - ì–´ë–¤ ê²½ìš°ì—ë„ win/loss/points ì°¨ê°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function revertMatchRecord(matchObj){
  if(!matchObj||!matchObj.sets)return;
  const mid=matchObj._id||null;
  const mdate=matchObj.d||'';

  matchObj.sets.forEach(set=>{
    if(!set.games)return;
    set.games.forEach(g=>{
      if(!g.playerA||!g.playerB||!g.winner)return;
      const wName=g.winner==='A'?g.playerA:g.playerB;
      const lName=g.winner==='A'?g.playerB:g.playerA;
      const w=players.find(p=>p.name===wName);
      const l=players.find(p=>p.name===lName);

      if(w){
        w.win=Math.max(0,(w.win||0)-1);
        w.points=(w.points||0)-3;
        // matchId ìš°ì„ , ì—†ìœ¼ë©´ ë‚ ì§œ+ê²°ê³¼+ìƒëŒ€ ë°©ì‹ (ì°¾ëŠ” ì¦‰ì‹œ 1ê±´ë§Œ ì œê±°)
        let idx=-1;
        if(mid) idx=w.history.findIndex(h=>h.matchId===mid&&h.result==='ìŠ¹'&&h.opp===lName);
        if(idx<0) idx=w.history.findIndex(h=>h.result==='ìŠ¹'&&h.opp===lName&&h.date===mdate);
        if(idx<0) idx=w.history.findIndex(h=>h.result==='ìŠ¹'&&h.opp===lName);
        if(idx>=0){const hr=w.history[idx];if(hr.eloDelta!=null){w.elo=(w.elo||ELO_DEFAULT)-hr.eloDelta;}w.history.splice(idx,1);}
      }
      if(l){
        l.loss=Math.max(0,(l.loss||0)-1);
        l.points=(l.points||0)+3;
        let idx=-1;
        if(mid) idx=l.history.findIndex(h=>h.matchId===mid&&h.result==='íŒ¨'&&h.opp===wName);
        if(idx<0) idx=l.history.findIndex(h=>h.result==='íŒ¨'&&h.opp===wName&&h.date===mdate);
        if(idx<0) idx=l.history.findIndex(h=>h.result==='íŒ¨'&&h.opp===wName);
        if(idx>=0){const hr=l.history[idx];if(hr.eloDelta!=null){l.elo=(l.elo||ELO_DEFAULT)-hr.eloDelta;}l.history.splice(idx,1);}
      }
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB & RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sw(t,el){
  // íƒ­ ë³€ê²½ ì‹œ ì„œë¸Œíƒ­ ì´ˆê¸°í™”
  if(t==='comp') { compSub='league'; leagueFilterDate=''; leagueFilterGrp=''; grpRankFilter=''; }
  if(t==='mini') miniSub='records';
  if(t==='univck') ckSub='records';
  if(t==='univm') univmSub='records';
  if(t==='pro') proSub='records';
  if(t==='hist') histSub='mini'; // ëŒ€ì „ ê¸°ë¡ íƒ­ìœ¼ë¡œ ëŒì•„ì˜¬ ë•Œ ì´ˆê¸°í™”
  // íƒ­ ì „í™˜ ì‹œ í•´ë‹¹ íƒ­ ê²€ìƒ‰ì–´ ì´ˆê¸°í™”
  if(window._recQ){const tabModeMap={mini:'mini',univck:'ck',univm:'univm',comp:'comp',pro:'pro'};const m=tabModeMap[t];if(m)window._recQ[m]='';}
  if(t==='total')totalSearch='';
  curTab=t;openDetails={};
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  const _fs=document.getElementById('fstrip');if(_fs)_fs.style.display=(t==='total'&&isLoggedIn)?'block':'none';
  // ì´ì „ ë‚´ìš© ì œê±° í›„ ë Œë”ë§
  const C=document.getElementById('rcont');
  if(C) C.innerHTML='';
  render();
}
function render(){
  const C=document.getElementById('rcont');
  const T=document.getElementById('rtitle');
  if(!C||!T)return;
  const farea=document.getElementById('farea');if(farea)farea.innerHTML='';
  // íƒ­ ë²„íŠ¼ UI ë™ê¸°í™”
  document.querySelectorAll('.tab').forEach(b=>{
    const oc=b.getAttribute('onclick')||'';
    const active=oc.includes("'"+curTab+"'");
    b.classList.toggle('on',active);
  });
  // ì´ì „ ë‚´ìš© ì œê±°
  C.innerHTML='';
  // ë‚ ì§œ í•„í„° ë³€ê²½ ì‹œ ìºì‹œ ì´ˆê¸°í™”
  window._compListCache={};
  window._histTourneyCache={};
  // íƒ­ë³„ ë Œë” í•¨ìˆ˜ ì§ì ‘ í˜¸ì¶œ (object literal ì¼ê´„ í‰ê°€ ì—ëŸ¬ ë°©ì§€)
  switch(curTab){
    case 'total':   if(typeof rTotal==='function')   rTotal(C,T);   break;
    case 'tier':    if(typeof rTier==='function')    rTier(C,T);    break;
    case 'hist':    if(typeof rHist==='function')    rHist(C,T);    break;
    case 'mini':    if(typeof rMini==='function')    rMini(C,T);    break;
    case 'univck':  if(typeof rCK==='function')      rCK(C,T);      break;
    case 'univm':   if(typeof rUnivM==='function')   rUnivM(C,T);   break;
    case 'comp':    if(typeof rComp==='function')    rComp(C,T);    break;
    case 'pro':     if(typeof rPro==='function')     rPro(C,T);     break;
    case 'member':  if(typeof rMember==='function')  rMember(C,T);  break;
    case 'cfg':     if(typeof rCfg==='function')     rCfg(C,T);     break;
    case 'stats':   if(typeof rStats==='function')   rStats(C,T);   break;
    case 'cal':     if(typeof rCal==='function')     rCal(C,T);     break;
    case 'vote':    if(typeof rVote==='function')    rVote(C,T);    break;
    case 'board':   if(typeof rBoard==='function')   rBoard(C,T);   break;
    default: break;
  }
  // ë Œë”ë§ í›„ ë¹ˆ rec-summary ì œê±° (ë‚´ìš© ì—†ëŠ” ë¹ˆ ì¤„ ë°©ì§€)
  // ì¦‰ì‹œ 1ì°¨ inject (PC í¬í•¨ ì¦‰ì‹œ ì ìš©)
  injectUnivIcons(C);
  requestAnimationFrame(()=>{
    C.querySelectorAll('.rec-summary').forEach(el=>{
      const header=el.querySelector('.rec-sum-header');
      if(!header||header.innerText.trim()==='')el.remove();
    });
    injectUnivIcons(C);
    // ê²½ê¸° ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ ë³µì›
    const _restoreFocus=()=>{
      // ê²€ìƒ‰ ì¤‘ì¸ íŠ¹ì • inputìœ¼ë¡œ í¬ì»¤ìŠ¤
      if(window._searchFocusId){
        const el=document.getElementById(window._searchFocusId);
        if(el){el.focus();el.setSelectionRange(el.value.length,el.value.length);return;}
      }
      if(window._recQ){
        Object.keys(window._recQ).forEach(mode=>{
          if(!window._recQ[mode]) return;
          const el=document.getElementById('rq-'+mode);
          if(el&&document.activeElement!==el){el.focus();el.setSelectionRange(el.value.length,el.value.length);}
        });
      }
      // ìŠ¤íŠ¸ë¦¬ë¨¸ íƒ­ ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ ë³µì›
      const tsi=document.getElementById('total-search');
      if(tsi&&typeof totalSearch!=='undefined'&&totalSearch&&document.activeElement!==tsi){tsi.focus();tsi.setSelectionRange(tsi.value.length,tsi.value.length);}
    };
    _restoreFocus();
    // ëª¨ë°”ì¼: ì²« rAF í›„ í•œ í”„ë ˆì„ ë”
    requestAnimationFrame(()=>{injectUnivIcons(C);_restoreFocus();});
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„ ìˆ˜ ì´ë¦„ í´ë¦­ â†’ ëª¨ë‹¬
   ëŒ€í•™ í´ë¦­ â†’ ëª¨ë‹¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openPlayerModal(name){
  const p=players.find(x=>x.name===name);
  if(!p)return;
  // REQ4: ë‹¤ë¥¸ ì„ ìˆ˜ë¡œ ë³€ê²½ ì‹œ í˜ì´ì§€ ì´ˆê¸°í™”
  if(window._playerModalCurrentName!==name) playerHistPage=0;
  document.getElementById('playerModalTitle').innerText=`ğŸ‘¤ ${name} ì„ ìˆ˜ ìƒì„¸`;
  document.getElementById('playerModalBody').innerHTML=buildPlayerDetailHTML(p);
  injectUnivIcons(document.getElementById('playerModalBody'));
  // ì–´ë“œë¯¼ ì „ìš© ìˆ˜ì • ë²„íŠ¼
  const editBtn=document.getElementById('playerModalEditBtn');
  if(editBtn) editBtn.style.display=isLoggedIn?'inline-flex':'none';
  // í˜„ì¬ ëª¨ë‹¬ì— í‘œì‹œ ì¤‘ì¸ ì„ ìˆ˜ëª… ì €ì¥
  window._playerModalCurrentName=name;
  om('playerModal');
}

function openEPFromModal(){
  const name=window._playerModalCurrentName;
  if(!name)return;
  cm('playerModal');
  setTimeout(()=>openEP(name),100);
}

/* â”€â”€ ì„ ìˆ˜ ìµœê·¼ ê²½ê¸° ìˆ˜ì • (ê´€ë¦¬ì ì „ìš©) â”€â”€ */
function openPlayerHistEdit(playerName, histIdx){
  if(!isLoggedIn)return;
  const p=players.find(x=>x.name===playerName);
  if(!p||!p.history||!p.history[histIdx])return;
  const hh=p.history[histIdx];
  const races=['T','Z','P'];
  const mapOpts=maps.map(m=>`<option value="${m}"${hh.map===m?' selected':''}>${m}</option>`).join('');
  document.getElementById('reTitle').textContent=`âœï¸ ê²½ê¸° ìˆ˜ì • â€” ${playerName} vs ${hh.opp}`;
  document.getElementById('reBody').innerHTML=`
    <div style="display:flex;flex-direction:column;gap:8px">
      <div><label>ë‚ ì§œ</label><input id="phe-date" type="date" value="${hh.date||''}" style="width:100%"></div>
      <div><label>ê²°ê³¼</label>
        <select id="phe-result" style="width:100%">
          <option value="ìŠ¹"${hh.result==='ìŠ¹'?' selected':''}>ìŠ¹</option>
          <option value="íŒ¨"${hh.result==='íŒ¨'?' selected':''}>íŒ¨</option>
        </select>
      </div>
      <div><label>ìƒëŒ€ ì´ë¦„</label><input id="phe-opp" type="text" value="${hh.opp||''}" style="width:100%"></div>
      <div><label>ìƒëŒ€ ì¢…ì¡±</label>
        <select id="phe-race" style="width:100%">
          ${races.map(r=>`<option value="${r}"${hh.oppRace===r?' selected':''}>${r}</option>`).join('')}
        </select>
      </div>
      <div><label>ë§µ</label>
        <select id="phe-map" style="width:100%">
          <option value="">-</option>${mapOpts}
        </select>
      </div>
    </div>`;
  // ì €ì¥ ë²„íŠ¼ ì„ì‹œ êµì²´
  const saveBtnOrig=document.querySelector('#reModal .btn-b');
  if(saveBtnOrig){
    saveBtnOrig.onclick=function(){
      hh.date=document.getElementById('phe-date').value;
      hh.result=document.getElementById('phe-result').value;
      hh.opp=document.getElementById('phe-opp').value;
      hh.oppRace=document.getElementById('phe-race').value;
      hh.map=document.getElementById('phe-map').value;
      // í¬ì¸íŠ¸ ì¬ê³„ì‚°ì€ ë³µì¡í•˜ë¯€ë¡œ ìŠ¤í‚µ, ë‚ ì§œ/ë§µ/ìƒëŒ€ ì •ë„ë§Œ ìˆ˜ì •
      save();
      cm('reModal');
      // ëª¨ë‹¬ ì—…ë°ì´íŠ¸
      const pb=document.getElementById('playerModalBody');
      if(pb&&window._playerModalCurrentName===playerName){
        pb.innerHTML=buildPlayerDetailHTML(p);
        injectUnivIcons(pb);
      }
    };
  }
  om('reModal');
}

// í˜„í™©íŒ ëŒ€í•™ ê³µìœ ì¹´ë“œ ë°”ë¡œ ì—´ê¸°
function openBoardUnivShareCard(univName){
  if(!univName||univName==='ì „ì²´')return;
  _shareMode='univ';
  _shareUnivSearch=univName;
  openShareCardModal();
  setTimeout(()=>renderShareCardByUniv(univName),80);
}

function openShareCardFromPlayer(){
  const name=window._playerModalCurrentName;
  if(!name)return;
  cm('playerModal');
  _shareMode='player';
  _sharePlayerSearch=name;
  openShareCardModal();
  setTimeout(()=>renderShareCardByPlayer(name),80);
}

function openShareCardFromUniv(){
  const name=window._univModalCurrentName;
  if(!name)return;
  cm('univModal');
  _shareMode='univ';
  _shareUnivSearch=name;
  openShareCardModal();
  setTimeout(()=>renderShareCardByUniv(name),80);
}
function openShareCardFromMatch(mode,idx){
  const arr=mode==='mini'?miniM:mode==='univm'?univM:mode==='ck'?ckM:mode==='comp'?comps:mode==='pro'?proM:mode==='tt'?ttM:miniM;
  window._shareMatchObj=arr[idx]||null;
  _shareMode='match';
  openShareCardModal();
  setTimeout(()=>{
    if(window._shareMatchObj)renderShareCardByMatchObj(window._shareMatchObj);
  },80);
}

async function capturePlayerModal(){
  const body=document.getElementById('playerModalBody');
  if(!body){alert('ìº¡ì²˜í•  ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
  try{
    const canvas=await html2canvas(body,{backgroundColor:'#ffffff',scale:2,useCORS:true});
    const a=document.createElement('a');
    a.download=`${window._playerModalCurrentName||'player'}_stat.jpg`;
    a.href=canvas.toDataURL('image/jpeg',0.92);
    document.body.appendChild(a);a.click();
    setTimeout(()=>document.body.removeChild(a),100);
  }catch(e){alert('ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜: '+e.message);}
}

async function captureUnivModal(){
  const body=document.getElementById('univModalBody');
  const title=document.getElementById('univModalTitle');
  if(!body){alert('ìº¡ì²˜í•  ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
  try{
    const canvas=await html2canvas(body,{backgroundColor:'#ffffff',scale:2,useCORS:true});
    const a=document.createElement('a');
    a.download=`${title?title.innerText.replace('ğŸ›ï¸ ',''):'univ'}_ëŒ€í•™ì •ë³´.jpg`;
    a.href=canvas.toDataURL('image/jpeg',0.92);
    document.body.appendChild(a);a.click();
    setTimeout(()=>document.body.removeChild(a),100);
  }catch(e){alert('ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜: '+e.message);}
}

async function captureDetail(id, filename){
  const el=document.getElementById(id);
  if(!el){alert('ìº¡ì²˜í•  ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
  try{
    const canvas=await html2canvas(el,{backgroundColor:'#ffffff',scale:2,useCORS:true});
    const a=document.createElement('a');
    a.download=`ê²½ê¸°ìƒì„¸_${filename}.jpg`;
    a.href=canvas.toDataURL('image/jpeg',0.92);
    document.body.appendChild(a);a.click();
    setTimeout(()=>document.body.removeChild(a),100);
  }catch(e){alert('ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜: '+e.message);}
}

function openUnivModal(univName){
  if(!univName)return;
  document.getElementById('univModalTitle').innerText=`${univName} ëŒ€í•™ ìƒì„¸`;
  document.getElementById('univModalBody').innerHTML=buildUnivDetailHTML(univName);
  injectUnivIcons(document.getElementById('univModalBody'));
  window._univModalCurrentName=univName;
  om('univModal');
}

function buildPlayerDetailHTML(p){
  const col=gc(p.univ);
  const opps={},rv={T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}};
  p.history.forEach(h=>{
    if(!opps[h.opp])opps[h.opp]={w:0,l:0,race:h.oppRace};
    if(h.result==='ìŠ¹'){opps[h.opp].w++;if(rv[h.oppRace])rv[h.oppRace].w++;}
    else{opps[h.opp].l++;if(rv[h.oppRace])rv[h.oppRace].l++;}
  });
  const tot=p.win+p.loss;const wr=tot?Math.round(p.win/tot*100):0;
  const eloVal=p.elo||ELO_DEFAULT;
  const eloColor=eloVal>=1400?'#7c3aed':eloVal>=1300?'#d97706':eloVal>=1200?'#16a34a':'#dc2626';

  // â”€â”€ ìƒë‹¨ í”„ë¡œí•„ íŒ¨ë„ â”€â”€
  let h=`<div style="background:linear-gradient(135deg,${col} 0%,${col}dd 60%,${col}bb 100%);border-radius:18px;padding:22px 24px;margin-bottom:16px;position:relative;overflow:hidden;box-shadow:0 8px 28px ${col}44">
    <div style="position:absolute;top:-30px;right:-30px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.1);pointer-events:none"></div>
    <div style="position:absolute;bottom:-50px;left:10px;width:90px;height:90px;border-radius:50%;background:rgba(255,255,255,.06);pointer-events:none"></div>
    <div style="position:absolute;top:0;right:0;width:200px;height:100%;background:linear-gradient(to left,rgba(255,255,255,.06),transparent);pointer-events:none"></div>
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;flex-wrap:wrap;position:relative">
      <div style="width:64px;height:64px;border-radius:18px;background:rgba(255,255,255,.22);display:flex;align-items:center;justify-content:center;flex-shrink:0;border:2.5px solid rgba(255,255,255,.45);overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.2)">${(()=>{if(p.photo)return`<img src="${p.photo}" style="width:64px;height:64px;object-fit:cover" onerror="this.style.display='none'">`;const url=UNIV_ICONS[p.univ]||(univCfg.find(x=>x.name===p.univ)||{}).icon||'';return url?`<img src="${url}" style="width:44px;height:44px;object-fit:contain" onerror="this.outerHTML='<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 24 24\\' fill=\\'white\\' width=\\'34\\' height=\\'34\\'><path d=\\'M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z\\'/></svg>'">`:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='34' height='34'><path d='M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z'/></svg>`;})()}</div>
      <div style="flex:1;min-width:0;position:relative">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:5px">
          <span style="font-size:22px;font-weight:900;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.15)">${p.name}${genderIcon(p.gender)}</span>${p.role?`<span style="display:block;margin-top:3px">${getRoleBadgeHTML(p.role,'11px')}</span>`:''}
          <span style="background:rgba(255,255,255,.22);border:1.5px solid rgba(255,255,255,.4);border-radius:6px;padding:3px 10px;font-size:11px;font-weight:700;color:#fff;letter-spacing:.3px">${getTierLabel(p.tier)||p.tier}</span>
        </div>
        <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap">
          <span class="ubadge clickable-univ" data-icon-done="1" style="background:rgba(255,255,255,.22);color:#fff;border:1.5px solid rgba(255,255,255,.4);font-size:11px;padding:3px 11px;display:inline-flex;align-items:center;gap:4px;border-radius:6px" onclick="cm('playerModal');setTimeout(()=>openUnivModal('${p.univ}'),100)">${gUI(p.univ,'12px')}${p.univ}</span>
          <span style="background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);border-radius:6px;padding:3px 10px;font-size:11px;font-weight:700;color:#fff">${p.race} ${RNAME[p.race]||''}</span>
        </div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;position:relative">
      <div style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.22);border-radius:12px;padding:10px 8px;text-align:center;backdrop-filter:blur(4px)">
        <div style="font-size:10px;color:rgba(255,255,255,.7);font-weight:600;margin-bottom:4px;letter-spacing:.3px">ì „ì </div>
        <div style="font-weight:900;font-size:13px;color:#fff"><span style="color:#86efac">${p.win}W</span> <span style="color:#fca5a5">${p.loss}L</span></div>
      </div>
      <div style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.22);border-radius:12px;padding:10px 8px;text-align:center;backdrop-filter:blur(4px)">
        <div style="font-size:10px;color:rgba(255,255,255,.7);font-weight:600;margin-bottom:4px;letter-spacing:.3px">ìŠ¹ë¥ </div>
        <div style="font-weight:900;font-size:16px;color:${wr>=50?'#86efac':'#fca5a5'}">${tot?wr+'%':'-'}</div>
      </div>
      <div style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.22);border-radius:12px;padding:10px 8px;text-align:center;backdrop-filter:blur(4px)">
        <div style="font-size:10px;color:rgba(255,255,255,.7);font-weight:600;margin-bottom:4px;letter-spacing:.3px">í¬ì¸íŠ¸</div>
        <div style="font-weight:900;font-size:16px;color:${p.points>=0?'#86efac':'#fca5a5'}">${pS(p.points)}</div>
      </div>
      <div style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.22);border-radius:12px;padding:10px 8px;text-align:center;backdrop-filter:blur(4px)">
        <div style="font-size:10px;color:rgba(255,255,255,.75);font-weight:600;margin-bottom:4px;letter-spacing:.3px">ELO</div>
        <div style="font-weight:900;font-size:16px;color:#fff">${eloVal}</div>
        ${(()=>{
          // ELO ìŠ¤íŒŒí¬ë¼ì¸: historyì—ì„œ eloDeltaë¡œ ì¶”ì´ ê³„ì‚°
          const deltas=(p.history||[]).filter(h=>h.eloDelta!=null).slice(-12);
          if(deltas.length<2) return '';
          let cur=eloVal;
          const points=[];
          [...deltas].reverse().forEach(h=>{cur-=h.eloDelta;});
          let val=cur;
          const elos=[val];
          deltas.forEach(h=>{val+=h.eloDelta;elos.push(val);});
          const min=Math.min(...elos),max=Math.max(...elos);
          const range=max-min||1;
          const W=68,H=22;
          const coords=elos.map((e,i)=>`${Math.round(i/(elos.length-1)*W)},${Math.round(H-((e-min)/range)*H)}`);
          const last=elos[elos.length-1],prev=elos[elos.length-2];
          const lineColor=last>=prev?'#86efac':'#fca5a5';
          return `<svg viewBox="0 0 ${W} ${H}" width="${W}" height="${H}" style="display:block;margin:4px auto 0;overflow:visible"><polyline points="${coords.join(' ')}" fill="none" stroke="${lineColor}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        })()}
      </div>
    </div>
  </div>`;

  // â”€â”€ ì¢…ì¡±ë³„ ìŠ¹ë¥  â”€â”€
  h+=`<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">`;
  RACES.forEach(r=>{
    const s=rv[r];const t=s.w+s.l;const w=t?Math.round(s.w/t*100):0;
    const raceColors={T:'#3b82f6',Z:'#7c3aed',P:'#d97706'};
    const rc=raceColors[r]||'#6b7280';
    h+=`<div class="rscard" style="border-color:${rc}55;background:${rc}12;flex:1;min-width:80px">
      <div style="margin-bottom:6px"><span class="rbadge r${r}" style="font-size:11px">${r} ${RNAME[r]||''}</span></div>
      <div style="font-weight:900;font-size:22px;color:${t?(w>=50?rc:'#94a3b8'):'#d1d5db'}">${t?w+'%':'-'}</div>
      <div style="font-size:10px;margin-top:4px"><span style="color:#16a34a;font-weight:700">${s.w}W</span> <span style="color:#dc2626;font-weight:700">${s.l}L</span></div>
    </div>`;
  });
  h+=`</div>`;

  // â”€â”€ ìƒëŒ€ ì „ì  â”€â”€
  const oppList=Object.entries(opps).sort((a,b)=>(b[1].w+b[1].l)-(a[1].w+a[1].l));
  if(oppList.length){
    h+=`<div style="font-weight:700;font-size:12px;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:6px"><span style="display:inline-block;width:3px;height:14px;background:var(--blue);border-radius:2px"></span>ìƒëŒ€ ì „ì  (${oppList.length}ëª…)</div>
    <div style="display:flex;gap:7px;flex-wrap:wrap;margin-bottom:16px">`;
    oppList.forEach(([opp,s])=>{
      const ot=s.w+s.l;const ow=ot?Math.round(s.w/ot*100):0;
      const oc=gc((players.find(x=>x.name===opp)||{}).univ||'');
      const oppUniv=(players.find(x=>x.name===opp)||{}).univ||'';
      h+=`<div class="ocard" onclick="cm('playerModal');setTimeout(()=>openPlayerModal('${opp}'),100)" style="border-color:${oc}44;background:${oc}08">
        <div style="width:28px;height:28px;border-radius:8px;background:${oc};margin:0 auto 5px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:900;color:#fff;box-shadow:0 2px 6px ${oc}55">${opp[0]}</div>
        <div style="font-weight:800;font-size:11px;color:var(--text);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60px">${opp}</div>
        <div style="font-size:9px;color:var(--gray-l);margin-bottom:3px">${oppUniv}</div>
        <div style="font-size:10px;margin-bottom:2px"><span class="rbadge r${s.race}" style="font-size:9px;padding:1px 5px">${s.race}</span></div>
        <div style="font-size:10px"><span style="color:#16a34a;font-weight:700">${s.w}W</span> <span style="color:#dc2626;font-weight:700">${s.l}L</span></div>
        <div style="font-weight:800;font-size:12px;margin-top:2px;color:${ow>=50?'#16a34a':'#dc2626'}">${ow}%</div>
      </div>`;
    });
    h+=`</div>`;
  }

  // â”€â”€ ìµœê·¼ ê¸°ë¡ â”€â”€
  if(p.history.length){
    const totalGames=p.history.length;
    const pageSize=20;
    const showAll=totalGames<=pageSize;
    const displayHist=p.history.slice(0,pageSize);
    h+=`<div style="font-weight:700;font-size:12px;color:var(--text2);margin-bottom:8px;display:flex;align-items:center;gap:6px"><span style="display:inline-block;width:3px;height:14px;background:var(--blue);border-radius:2px"></span>ìµœê·¼ ê²½ê¸° ê¸°ë¡ <span style="font-size:11px;color:var(--gray-l);font-weight:400">(ì´ ${totalGames}ê²Œì„ Â· ìµœê·¼ ${Math.min(pageSize,totalGames)}ê°œ í‘œì‹œ)</span></div>`;
    h+=`<div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:16px">`;
    h+=`<table style="margin:0;border:none;border-radius:0"><thead><tr><th>ë‚ ì§œ</th><th>ê²°ê³¼</th><th>ìƒëŒ€</th><th>ì¢…ì¡±</th><th>ë§µ</th><th>ELO</th>${isLoggedIn?'<th class="no-export" style="width:48px">ê´€ë¦¬</th>':''}</tr></thead><tbody>`;
    displayHist.forEach((hh,hi)=>{
      const isWin=hh.result==='ìŠ¹';
      const eloStr=hh.eloDelta!=null?`<span style="font-weight:700;font-size:11px;color:${hh.eloDelta>0?'#16a34a':'#dc2626'}">${hh.eloDelta>0?'+':''}${hh.eloDelta}</span>`:'-';
      const oppP=players.find(x=>x.name===hh.opp);const oppCol=oppP?gc(oppP.univ):'#6b7280';
      const editBtnHTML=isLoggedIn?`<td class="no-export" style="text-align:center">
        <button class="btn btn-w btn-xs" onclick="openPlayerHistEdit('${p.name}',${hi})" title="ê²½ê¸° ìˆ˜ì •" style="padding:2px 7px;font-size:10px;border-color:var(--border2)">âœï¸</button>
      </td>`:'';
      h+=`<tr style="background:${isWin?'#f0fdf4':'#fef2f2'}10">
        <td style="color:var(--gray-l);font-size:11px">${hh.date}</td>
        <td>${isWin?`<span style="background:#dcfce7;color:#16a34a;border:1px solid #bbf7d0;font-size:10px;font-weight:800;padding:2px 8px;border-radius:20px">WIN</span>`:`<span style="background:#fee2e2;color:#dc2626;border:1px solid #fecaca;font-size:10px;font-weight:800;padding:2px 8px;border-radius:20px">LOSE</span>`}</td>
        <td style="cursor:pointer;font-weight:700" onclick="cm('playerModal');setTimeout(()=>openPlayerModal('${hh.opp}'),100)"><span style="display:inline-flex;align-items:center;gap:4px"><span style="width:16px;height:16px;border-radius:4px;background:${oppCol};display:inline-block;flex-shrink:0"></span><span style="color:var(--blue)">${hh.opp}</span></span></td>
        <td><span class="rbadge r${hh.oppRace}" style="font-size:10px">${hh.oppRace}</span></td>
        <td style="color:var(--gray-l);font-size:11px">${hh.map||'-'}</td>
        <td>${eloStr}</td>
        ${editBtnHTML}
      </tr>`;
    });
    h+=`</tbody></table>`;
    if(!showAll){
      h+=`<div style="text-align:center;padding:8px;background:var(--surface);border-top:1px solid var(--border)">
        <button class="btn btn-w btn-sm" onclick="goToPlayer('${p.name}')">ğŸ“‹ ì „ì²´ ${totalGames}ê°œ ê¸°ë¡ ë³´ê¸° â†’</button>
      </div>`;
    }
    h+=`</div>`;
  }

  // â”€â”€ ì„ ìˆ˜ ë©”ëª¨ â”€â”€
  h+=`<div style="background:#fffbeb;border:1px solid #fde68a;border-radius:12px;padding:14px 16px">
    <div style="font-weight:700;font-size:12px;color:#d97706;margin-bottom:8px">ğŸ“ ì„ ìˆ˜ ë©”ëª¨</div>
    ${p.memo?`<div style="font-size:12px;color:var(--text2);margin-bottom:10px;line-height:1.7;white-space:pre-wrap">${p.memo}</div>`:'<div style="font-size:12px;color:var(--gray-l);margin-bottom:10px">ë©”ëª¨ ì—†ìŒ</div>'}
    ${isLoggedIn?`<textarea id="player-memo-input" style="width:100%;min-height:60px;font-size:12px;border:1px solid #fde68a;border-radius:8px;padding:8px 10px;resize:vertical;font-family:'Noto Sans KR',sans-serif;background:var(--surface)" placeholder="ì„ ìˆ˜ ë©”ëª¨...">${p.memo||''}</textarea>
    <div style="display:flex;gap:6px;margin-top:8px">
      <button class="btn btn-b btn-sm" onclick="savePlayerMemo('${p.name}')">ğŸ’¾ ì €ì¥</button>
      ${p.memo?`<button class="btn btn-r btn-sm" onclick="savePlayerMemo('${p.name}',true)">ì‚­ì œ</button>`:''}
    </div>`:''}
  </div>`;
  return h;
}

function buildUnivDetailHTML(univName){
  const col=gc(univName);
  const members=getMembers(univName);
  const oppStats={};
  function addOpp(myU,oppU,myWin){
    if(myU!==univName)return;
    if(oppU===univName)return;
    if(!oppStats[oppU])oppStats[oppU]={w:0,l:0};
    if(myWin)oppStats[oppU].w++;else oppStats[oppU].l++;
  }
  miniM.forEach(m=>{addOpp(m.a,m.b,m.sa>m.sb);addOpp(m.b,m.a,m.sb>m.sa);});
  univM.forEach(m=>{addOpp(m.a,m.b,m.sa>m.sb);addOpp(m.b,m.a,m.sb>m.sa);});
  comps.forEach(m=>{const a=m.a||m.u||'';addOpp(a,m.b,m.sa>m.sb);addOpp(m.b,a,m.sb>m.sa);});

  const tot=members.reduce((s,p)=>s+p.win+p.loss,0);
  const wins=members.reduce((s,p)=>s+p.win,0);
  const pts=members.reduce((s,p)=>s+p.points,0);
  const wr=tot?Math.round(wins/tot*100):0;

  // â”€â”€ ìƒë‹¨ ëŒ€í•™ í—¤ë” ì¹´ë“œ â”€â”€
  let h=`<div style="background:linear-gradient(135deg,${col},${col}cc);border-radius:16px;padding:20px 24px;margin-bottom:18px;color:#fff;position:relative;overflow:hidden">
    <div style="position:absolute;top:-20px;right:-20px;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,.08);pointer-events:none"></div>
    <div style="position:absolute;bottom:-30px;right:40px;width:70px;height:70px;border-radius:50%;background:rgba(255,255,255,.05);pointer-events:none"></div>
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:18px">
      <div style="width:56px;height:56px;border-radius:16px;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:28px;border:2px solid rgba(255,255,255,.35);flex-shrink:0">
        ${gUI(univName,'32px')}
      </div>
      <div>
        <div style="font-size:20px;font-weight:900;color:#fff;text-shadow:0 1px 6px rgba(0,0,0,.2)">${univName}</div>
        <div style="font-size:12px;color:rgba(255,255,255,.75);margin-top:2px">ì†Œì† ì„ ìˆ˜ ${members.length}ëª…</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
      <div style="background:rgba(255,255,255,.15);border-radius:10px;padding:10px 8px;text-align:center;backdrop-filter:blur(4px)">
        <div style="font-size:10px;color:rgba(255,255,255,.75);margin-bottom:3px">ê°œì¸ ì „ì </div>
        <div style="font-weight:900;font-size:13px;color:#fff">${wins}ìŠ¹ ${tot-wins}íŒ¨</div>
      </div>
      <div style="background:rgba(255,255,255,.15);border-radius:10px;padding:10px 8px;text-align:center;backdrop-filter:blur(4px)">
        <div style="font-size:10px;color:rgba(255,255,255,.75);margin-bottom:3px">ê°œì¸ ìŠ¹ë¥ </div>
        <div style="font-weight:900;font-size:14px;color:${wr>=50?'#bbf7d0':'#fca5a5'}">${tot?wr+'%':'-'}</div>
      </div>
      <div style="background:rgba(255,255,255,.15);border-radius:10px;padding:10px 8px;text-align:center;backdrop-filter:blur(4px)">
        <div style="font-size:10px;color:rgba(255,255,255,.75);margin-bottom:3px">ì´ í¬ì¸íŠ¸</div>
        <div style="font-weight:900;font-size:13px;color:${pts>0?'#fef08a':pts<0?'#fca5a5':'#fff'}">${pts>0?'+':''}${pts}</div>
      </div>
      <div style="background:rgba(255,255,255,.15);border-radius:10px;padding:10px 8px;text-align:center;backdrop-filter:blur(4px)">
        <div style="font-size:10px;color:rgba(255,255,255,.75);margin-bottom:3px">ì„ ìˆ˜ ìˆ˜</div>
        <div style="font-weight:900;font-size:14px;color:#fff">${members.length}ëª…</div>
      </div>
    </div>
  </div>`;

  // â”€â”€ ì†Œì† ì„ ìˆ˜ â”€â”€
  if(members.length){
    const sorted=[...members].sort((a,b)=>getRoleOrder(a.role)-getRoleOrder(b.role)||TIERS.indexOf(a.tier)-TIERS.indexOf(b.tier)||b.points-a.points);
    const displayList=sorted; // ì „ì²´ ì„ ìˆ˜ í‘œì‹œ (ë‚¨ì í¬í•¨, ê²½ê¸° ì´ë ¥ ì—†ì–´ë„)
    h+=`<div style="font-weight:700;font-size:12px;color:${col};margin-bottom:10px;display:flex;align-items:center;gap:6px">
      <span style="display:inline-block;width:3px;height:14px;background:${col};border-radius:2px"></span>ì†Œì† ì„ ìˆ˜ (${displayList.length}ëª…)
    </div>`;
    h+=`<div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:18px"><table style="margin:0;border:none;border-radius:0;table-layout:auto"><thead><tr><th style="text-align:center;width:1px;white-space:nowrap;padding:7px 6px">ì§ì±…</th><th style="text-align:center">í‹°ì–´</th><th style="text-align:center;width:50px">ì¢…ì¡±</th><th style="text-align:left;padding-left:10px">ì´ë¦„</th><th style="text-align:center;width:40px">ì„±ë³„</th><th style="text-align:center;width:40px">ìŠ¹</th><th style="text-align:center;width:40px">íŒ¨</th><th style="text-align:center;width:52px">ìŠ¹ë¥ </th><th style="text-align:center;width:60px">í¬ì¸íŠ¸</th></tr></thead><tbody>`;
    displayList.forEach(p=>{
      const tw=p.win+p.loss;const twr=tw?Math.round(p.win/tw*100):0;
      h+=`<tr style="cursor:pointer" onclick="cm('univModal');setTimeout(()=>openPlayerModal('${p.name}'),100)" onmouseover="this.style.background='#f0f6ff'" onmouseout="this.style.background=''">\r\n        <td style="text-align:center;padding:5px 4px;white-space:nowrap">${p.role?getRoleBadgeHTML(p.role,'10px'):''}</td>
        <td style="text-align:center">${getTierBadge(p.tier)}</td>
        <td style="text-align:center"><span class="rbadge r${p.race}">${p.race}</span></td>
        <td style="text-align:left;padding-left:10px;font-weight:600"><span style="display:inline-flex;align-items:center;gap:6px">${getPlayerPhotoHTML(p.name,'24px')}<span class="clickable-name">${p.name}</span>${getStatusIconHTML(p.name)}</span></td>
        <td style="text-align:center">${genderIcon(p.gender)}</td>
        <td style="text-align:center" class="wt">${p.win}</td>
        <td style="text-align:center" class="lt">${p.loss}</td>
        <td style="text-align:center;font-weight:700;color:${twr>=50?'#16a34a':'#dc2626'}">${tw?twr+'%':'-'}</td>
        <td style="text-align:center" class="${pC(p.points)}">${pS(p.points)}</td>
      </tr>`;
    });
    h+=`</tbody></table></div>`;
  }

  // â”€â”€ ìƒëŒ€ ëŒ€í•™ ì „ì  â”€â”€
  const oppList=Object.entries(oppStats).filter(([,s])=>s.w+s.l>0).sort((a,b)=>(b[1].w+b[1].l)-(a[1].w+a[1].l));
  if(oppList.length){
    h+=`<div style="font-weight:700;font-size:12px;color:#7c3aed;margin-bottom:10px;display:flex;align-items:center;gap:6px">
      <span style="display:inline-block;width:3px;height:14px;background:#7c3aed;border-radius:2px"></span>ìƒëŒ€ ëŒ€í•™ ì „ì 
    </div>`;
    h+=`<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:18px">`;
    oppList.forEach(([opp,s])=>{
      const ot=s.w+s.l;const ow=ot?Math.round(s.w/ot*100):0;
      const oc=gc(opp);
      h+=`<div style="background:var(--white);border:1px solid var(--border);border-radius:10px;padding:10px 14px;text-align:center;cursor:pointer;min-width:90px;box-shadow:0 1px 4px rgba(0,0,0,.04)"
        onclick="cm('univModal');setTimeout(()=>openUnivModal('${opp}'),100)">
        <span class="ubadge" data-icon-done="1" style="background:${oc};font-size:11px;margin-bottom:6px;display:inline-flex;align-items:center;gap:3px">${gUI(opp,'11px')}${opp}</span>
        <div style="font-size:11px;margin-top:4px"><span class="wt">${s.w}</span>ìŠ¹ <span class="lt">${s.l}</span>íŒ¨</div>
        <div style="font-weight:700;font-size:11px;color:${ow>=50?'#16a34a':'#dc2626'}">${ow}%</div>
      </div>`;
    });
    h+=`</div>`;
  }

  // â”€â”€ ìµœê·¼ ëŒ€ì „ ê¸°ë¡ â”€â”€
  const myMatches=[
    ...miniM.filter(m=>m.a===univName||m.b===univName).map(m=>({...m,mode:'ë¯¸ë‹ˆëŒ€ì „'})),
    ...univM.filter(m=>m.a===univName||m.b===univName).map(m=>({...m,mode:'ëŒ€í•™ëŒ€ì „'})),
  ].sort((a,b)=>(b.d||'').localeCompare(a.d||''));
  if(myMatches.length){
    h+=`<div style="font-weight:700;font-size:12px;color:#d97706;margin-bottom:10px;display:flex;align-items:center;gap:6px">
      <span style="display:inline-block;width:3px;height:14px;background:#d97706;border-radius:2px"></span>ìµœê·¼ ëŒ€ì „ ê¸°ë¡
    </div>`;
    h+=`<div style="border:1px solid var(--border);border-radius:10px;overflow:hidden">`;
    h+=`<table style="margin:0;border:none;border-radius:0"><thead><tr><th>ë‚ ì§œ</th><th>ì¢…ë¥˜</th><th>ìƒëŒ€</th><th>ê²°ê³¼</th></tr></thead><tbody>`;
    myMatches.slice(0,10).forEach(m=>{
      const isA=m.a===univName;
      const opp=isA?m.b:m.a;
      const myS=isA?m.sa:m.sb;const oppS=isA?m.sb:m.sa;
      const win=myS>oppS;const oc=gc(opp);
      const modeBg=m.mode==='ë¯¸ë‹ˆëŒ€ì „'?'#2563eb':'#7c3aed';
      h+=`<tr>
        <td style="color:var(--gray-l);font-size:11px">${m.d||''}</td>
        <td><span style="background:${modeBg};color:#fff;padding:1px 8px;border-radius:4px;font-size:10px;font-weight:700">${m.mode}</span></td>
        <td><span class="ubadge clickable-univ" style="background:${oc};font-size:10px;padding:1px 7px" onclick="cm('univModal');setTimeout(()=>openUnivModal('${opp}'),100)">${opp}</span></td>
        <td>${win?`<span class="wt" style="font-weight:800">${myS}:${oppS} ìŠ¹</span>`:`<span class="lt" style="font-weight:800">${myS}:${oppS} íŒ¨</span>`}</td>
      </tr>`;
    });
    h+=`</tbody></table></div>`;
  }
  return h;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„±ì  ê´€ë¦¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let totalRaceFilter='ì „ì²´'; // ìŠ¤íŠ¸ë¦¬ë¨¸ íƒ­ ì¢…ì¡± í•„í„°
let totalSearch=''; // ìŠ¤íŠ¸ë¦¬ë¨¸ íƒ­ ì´ë¦„ ê²€ìƒ‰
let totalHideNoRecord=false; // ì „ì  ì—†ëŠ” ì„ ìˆ˜ ìˆ¨ê¸°ê¸°

function rTotal(C,T){
  T.innerText='ğŸ¬ ì „ì²´ ìŠ¤íƒ€í¬ë˜í”„íŠ¸ ìŠ¤íŠ¸ë¦¬ë¨¸ ë¦¬ìŠ¤íŠ¸';
  const raceOpts=['ì „ì²´','T','Z','P'];
  let filterBar=`<div class="fbar" style="margin-bottom:16px;flex-wrap:wrap;gap:6px">
    <strong style="font-size:11px;color:var(--gray-l)">ì¢…ì¡±:</strong>
    ${raceOpts.map(r=>`<button class="pill ${totalRaceFilter===r?'on':''}" onclick="totalRaceFilter='${r}';render()">${r==='ì „ì²´'?'ì „ì²´':RNAME[r]||r}</button>`).join('')}
    <button class="pill ${totalHideNoRecord?'on':''}" onclick="totalHideNoRecord=!totalHideNoRecord;render()" style="${totalHideNoRecord?'background:#f59e0b;border-color:#f59e0b;color:#fff':''}">ì „ì ì—†ëŠ” ì„ ìˆ˜ ìˆ¨ê¸°ê¸°</button>
    <div style="margin-left:auto;position:relative;display:inline-block">
      <input type="text" id="total-search" value="${totalSearch}" placeholder="ğŸ” ì´ë¦„ ê²€ìƒ‰..."
        oninput="(function(inp){totalSearch=inp.value;window._searchFocusId='total-search';clearTimeout(window._totalSearchTm);window._totalSearchTm=setTimeout(function(){render();window._searchFocusId=null;},200);})(this)"
        style="padding:4px 10px;border:1px solid var(--border2);border-radius:6px;font-size:12px;width:130px">
    </div>
  </div>`;

    let tableHTML=`<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;width:100%"><table style="table-layout:auto;width:100%"><colgroup>
    <col style="white-space:nowrap"><col style="white-space:nowrap"><col style="white-space:nowrap"><col>
    <col style="white-space:nowrap"><col style="white-space:nowrap">
    <col style="white-space:nowrap"><col style="white-space:nowrap">
    ${isLoggedIn?'<col style="white-space:nowrap">':''}
  </colgroup><thead><tr>
    <th style="text-align:center;white-space:nowrap;padding:8px 10px">í‹°ì–´</th>
    <th style="text-align:center;white-space:nowrap;padding:8px 8px">ì¢…ì¡±</th>
    <th style="text-align:left;padding:8px 12px">ìŠ¤íŠ¸ë¦¬ë¨¸</th>
    <th style="text-align:center;white-space:nowrap;padding:8px 10px">ìŠ¹</th>
    <th style="text-align:center;white-space:nowrap;padding:8px 10px">íŒ¨</th>
    <th style="text-align:center;white-space:nowrap;padding:8px 10px">ìŠ¹ë¥ </th>
    <th style="text-align:center;white-space:nowrap;padding:8px 10px">í¬ì¸íŠ¸</th>
    ${isLoggedIn?'<th class="no-export" style="text-align:center;white-space:nowrap;padding:8px 10px">ê´€ë¦¬</th>':''}
  </tr></thead><tbody>`;

  let totalShown=0;
  getAllUnivs().forEach(u=>{
    let up=players.filter(p=>p.univ===u.name);
    if(totalRaceFilter!=='ì „ì²´') up=up.filter(p=>p.race===totalRaceFilter);
    if(totalSearch.trim()) up=up.filter(p=>p.name.toLowerCase().includes(totalSearch.trim().toLowerCase()));
    if(totalHideNoRecord) up=up.filter(p=>(p.win+p.loss)>0);
    if(!up.length)return;
    totalShown+=up.length;
    tableHTML+=`<tr class="ugrp" style="--c:${u.color}"><td colspan="${isLoggedIn?7:6}">
      <span class="clickable-univ" onclick="openUnivModal('${u.name}')" style="color:#fff;font-size:14px;display:inline-flex;align-items:center;gap:4px">${gUI(u.name,'18px')}${u.name}</span>
      <span style="font-size:11px;color:rgba(255,255,255,.75);margin-left:6px">(${up.length}ëª…)</span>
    </td></tr>`;
    const sorted=(typeof _getBoardPlayers==='function')
      ? _getBoardPlayers(u.name).filter(p=>{
          if(totalRaceFilter!=='ì „ì²´'&&p.race!==totalRaceFilter)return false;
          if(totalSearch.trim()&&!p.name.toLowerCase().includes(totalSearch.trim().toLowerCase()))return false;
          if(totalHideNoRecord&&!(p.win+p.loss))return false;
          return true;
        })
      : [...up].sort((a,b)=>getRoleOrder(a.role)-getRoleOrder(b.role)||TIERS.indexOf(a.tier)-TIERS.indexOf(b.tier)||b.points-a.points);
    let lt='';
    sorted.forEach(p=>{
      if(p.tier!==lt){lt=p.tier;tableHTML+=`<tr class="tgrp"><td colspan="${isLoggedIn?7:6}">â–· ${getTierLabel(p.tier)}</td></tr>`;}
      const wr=(p.win+p.loss)?Math.round(p.win/(p.win+p.loss)*100):0;
      tableHTML+=`<tr>
        <td style="text-align:center;white-space:nowrap;padding:7px 10px">${getTierBadge(p.tier)}</td>
        <td style="text-align:center;white-space:nowrap;padding:7px 8px"><span class="rbadge r${p.race}">${p.race}</span></td>
        <td style="text-align:left;padding:6px 12px;white-space:nowrap">
          <span style="display:inline-flex;align-items:center;gap:8px">
            ${p.photo?`<img src="${p.photo}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid var(--border);flex-shrink:0" onerror="this.style.display='none'">`:'<span style="display:inline-block;width:32px;height:32px;border-radius:50%;background:var(--border2);border:2px solid var(--border);flex-shrink:0"></span>'}
            <span style="font-weight:600">${p.role?`${getRoleBadgeHTML(p.role,'10px')} `:''}<span class="clickable-name" onclick="openPlayerModal('${p.name}')">${p.name}</span>${genderIcon(p.gender)}${getStatusIconHTML(p.name)}</span>
          </span>
        </td>
        <td style="text-align:center;white-space:nowrap;padding:7px 10px" class="wt">${p.win}</td>
        <td style="text-align:center;white-space:nowrap;padding:7px 10px" class="lt">${p.loss}</td>
        <td style="text-align:center;white-space:nowrap;padding:7px 10px;font-weight:700;color:${(p.win+p.loss)===0?'var(--gray-l)':wr>=50?'var(--green)':'var(--red)'}">${(p.win+p.loss)?wr+'%':'-'}</td>
        <td style="text-align:center;white-space:nowrap;padding:7px 10px;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px" class="${pC(p.points)}">${pS(p.points)}</td>
        ${isLoggedIn?`<td class="no-export" style="text-align:center;white-space:nowrap;padding:7px 8px">${adminBtn(`<button class="btn btn-w btn-xs" onclick="openEP('${p.name}')">ìˆ˜ì •</button>`)}</td>`:''}
      </tr>`;
    });
  });
  if(totalShown===0){
    tableHTML+=`<tr><td colspan="${isLoggedIn?7:6}" style="padding:30px;text-align:center;color:var(--gray-l)">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
  }
  tableHTML+=`</tbody></table></div>`;

  C.innerHTML = filterBar + tableHTML;
  injectUnivIcons(C);
  requestAnimationFrame(()=>injectUnivIcons(C));
  const si=C.querySelector('#total-search');
  if(si&&totalSearch){si.focus();si.setSelectionRange(si.value.length,si.value.length);}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í‹°ì–´ ìˆœìœ„í‘œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let tierRankMode='tier'; // tier | winstreak | wins | revstreak | winrate | recent

function rTier(C,T){
  T.innerText='ğŸ“Š í‹°ì–´ ìˆœìœ„í‘œ';
  const allU=getAllUnivs();
  const F=document.getElementById('farea');
  // ëª¨ë“œ ë²„íŠ¼
  const modes=[
    {id:'tier',lbl:'ğŸ“Š í‹°ì–´ìˆœ'},
    {id:'wins',lbl:'ğŸ† ë‹¤ìŠ¹ìˆœ'},
    {id:'winstreak',lbl:'ğŸ”¥ ìŠ¹ì°¨ìˆœ'},
    {id:'winrate',lbl:'ğŸ“ˆ ìŠ¹ë¥ ìˆœ'},
    {id:'revstreak',lbl:'â„ï¸ ì—­ìŠ¹ì°¨ìˆœ'},
    {id:'recent',lbl:'ğŸ• ìµœê·¼ ê²½ê¸°'},
  ];
  let fh=`<div class="fbar"><strong>ë³´ê¸°:</strong>`;
  modes.forEach(m=>{fh+=`<button class="pill ${tierRankMode===m.id?'on':''}" onclick="tierRankMode='${m.id}';render()">${m.lbl}</button>`;});
  fh+=`</div>`;
  if(tierRankMode!=='recent'){
    fh+=`<div class="fbar"><strong>ëŒ€í•™:</strong><button class="pill ${fUniv==='ì „ì²´'?'on':''}" onclick="sf('ì „ì²´','${fTier}')">ì „ì²´</button>`;
    allU.forEach(u=>{fh+=`<button class="pill ${fUniv===u.name?'on':''}" style="${fUniv===u.name?`background:${u.color};border-color:${u.color};color:#fff`:''}" onclick="sf('${u.name}','${fTier}')">${u.name}</button>`;});
    fh+=`</div><div class="fbar"><strong>í‹°ì–´:</strong><button class="pill ${fTier==='ì „ì²´'?'on':''}" onclick="sf('${fUniv}','ì „ì²´')">ì „ì²´</button>`;
    TIERS.forEach(t=>{
    const _bc=getTierBtnColor(t),_bt=getTierBtnTextColor(t),_sel=fTier===t;
    fh+=`<button class="pill" style="border-color:${_bc};border-width:${_sel?'2':'1'}px;${_sel?`background:${_bc};color:${_bt};font-weight:700;`:'color:'+_bc+';'}" onmouseover="if(!${_sel})this.style.background='${_bc}22'" onmouseout="if(!${_sel})this.style.background=''" onclick="sf('${fUniv}','${t}')">${getTierPillLabel(t)}</button>`;
  });
    fh+=`</div>`;
    // ì¢…ì¡± í•„í„° + ì „ì ì—†ëŠ” ì„ ìˆ˜ ìˆ¨ê¸°ê¸°
    if(!window._tierRaceFilter) window._tierRaceFilter='ì „ì²´';
    if(window._tierHideNoRecord===undefined) window._tierHideNoRecord=false;
    fh+=`<div class="fbar"><strong>ì¢…ì¡±:</strong>`;
    ['ì „ì²´','T','Z','P'].forEach(r=>{
      fh+=`<button class="pill ${window._tierRaceFilter===r?'on':''}" onclick="window._tierRaceFilter='${r}';render()">${r==='ì „ì²´'?'ì „ì²´':r}</button>`;
    });
    fh+=`<button class="pill ${window._tierHideNoRecord?'on':''}" onclick="window._tierHideNoRecord=!window._tierHideNoRecord;render()" style="${window._tierHideNoRecord?'background:#f59e0b;border-color:#f59e0b;color:#fff':''}">ì „ì ì—†ëŠ” ì„ ìˆ˜ ìˆ¨ê¸°ê¸°</button>`;
    fh+=`</div>`;
  }
  F.innerHTML=fh;

  if(tierRankMode==='recent'){
    // ìµœê·¼ ê²½ê¸° ë‚´ì—­: ëª¨ë“  ëŒ€ì „ì—ì„œ ìµœê·¼ ê²Œì„ ì¶”ì¶œ (ëŒ€íšŒ/í‹°ì–´ëŒ€íšŒ í¬í•¨)
    const recentGames=[];
    function extractGames(matchList,label){
      matchList.forEach(m=>{
        (m.sets||[]).forEach(set=>{
          (set.games||[]).forEach(g=>{
            if(!g.playerA||!g.playerB||!g.winner)return;
            const wn=g.winner==='A'?g.playerA:g.playerB;
            const ln=g.winner==='A'?g.playerB:g.playerA;
            recentGames.push({date:m.d||'',winner:wn,loser:ln,map:g.map||'-',label:label||''});
          });
        });
      });
    }
    extractGames(miniM,'ë¯¸ë‹ˆëŒ€ì „');
    extractGames(univM,'ëŒ€í•™ëŒ€ì „');
    extractGames(comps,'ëŒ€íšŒ');
    extractGames(ckM,'ëŒ€í•™CK');
    extractGames(proM,'í”„ë¡œë¦¬ê·¸');
    // ì¡°ë³„ë¦¬ê·¸ ëŒ€íšŒ ê²½ê¸° í¬í•¨
    const tourItems=typeof getTourneyMatches==='function'?getTourneyMatches():[];
    extractGames(tourItems,'ì¡°ë³„ëŒ€íšŒ');
    // í‹°ì–´ëŒ€íšŒ í¬í•¨
    if(ttM&&ttM.length) extractGames(ttM,'í‹°ì–´ëŒ€íšŒ');
    recentGames.sort((a,b)=>b.date.localeCompare(a.date));

    // ì¢…ì¡± í•„í„° ìƒíƒœ
    if(!window._recentRaceFilter) window._recentRaceFilter='ì „ì²´';
    // í‹°ì–´ í•„í„° ìƒíƒœ
    if(!window._recentTierFilter) window._recentTierFilter='ì „ì²´';

    let filtered=recentGames;
    if(window._recentRaceFilter!=='ì „ì²´'){
      filtered=filtered.filter(g=>{
        const wp=players.find(p=>p.name===g.winner);
        const lp=players.find(p=>p.name===g.loser);
        return (wp&&wp.race===window._recentRaceFilter)||(lp&&lp.race===window._recentRaceFilter);
      });
    }
    if(window._recentTierFilter!=='ì „ì²´'){
      filtered=filtered.filter(g=>{
        const wp=players.find(p=>p.name===g.winner);
        const lp=players.find(p=>p.name===g.loser);
        return (wp&&wp.tier===window._recentTierFilter)||(lp&&lp.tier===window._recentTierFilter);
      });
    }

    let fh=`<div class="fbar"><strong>ì¢…ì¡±:</strong>`;
    ['ì „ì²´','T','Z','P'].forEach(r=>{
      fh+=`<button class="pill ${window._recentRaceFilter===r?'on':''}" onclick="window._recentRaceFilter='${r}';render()">${r==='ì „ì²´'?'ì „ì²´':r}</button>`;
    });
    fh+=`<strong style="margin-left:8px">í‹°ì–´:</strong><button class="pill ${window._recentTierFilter==='ì „ì²´'?'on':''}" onclick="window._recentTierFilter='ì „ì²´';render()">ì „ì²´</button>`;
    TIERS.forEach(t=>{
    const _bc=getTierBtnColor(t),_bt=getTierBtnTextColor(t),_sel=window._recentTierFilter===t;
    fh+=`<button class="pill" style="border-color:${_bc};border-width:${_sel?'2':'1'}px;${_sel?`background:${_bc};color:${_bt};font-weight:700;`:'color:'+_bc+';'}" onmouseover="if(!${_sel})this.style.background='${_bc}22'" onmouseout="if(!${_sel})this.style.background=''" onclick="window._recentTierFilter='${t}';render()">${getTierPillLabel(t)}</button>`;
  });
    fh+=`</div>`;
    F.innerHTML+=fh;

    let h=`<div style="font-size:11px;color:var(--gray-l);margin-bottom:8px">ì´ ${filtered.length}ê±´</div>`;
    h+=`<table><thead><tr><th>ë‚ ì§œ</th><th>ì¢…ë¥˜</th><th>ìŠ¹ì</th><th>íŒ¨ì</th><th>ë§µ</th></tr></thead><tbody>`;
    if(!filtered.length)h+=`<tr><td colspan="5" style="padding:30px;color:var(--gray-l);text-align:center">ê²½ê¸° ê¸°ë¡ ì—†ìŒ</td></tr>`;
    filtered.slice(0,100).forEach(g=>{
      const wp=players.find(p=>p.name===g.winner);const lp=players.find(p=>p.name===g.loser);
      const wc=wp?gc(wp.univ):'#888';const lc=lp?gc(lp.univ):'#888';
      const lblColors={'ë¯¸ë‹ˆëŒ€ì „':'#2563eb','ëŒ€í•™ëŒ€ì „':'#7c3aed','ëŒ€íšŒ':'#d97706','ëŒ€í•™CK':'#dc2626','í”„ë¡œë¦¬ê·¸':'#0891b2','ì¡°ë³„ëŒ€íšŒ':'#16a34a','í‹°ì–´ëŒ€íšŒ':'#7c3aed'};
      const lblColor=lblColors[g.label]||'#6b7280';
      h+=`<tr>
        <td style="color:var(--gray-l);font-size:11px">${g.date}</td>
        <td><span style="background:${lblColor};color:#fff;padding:1px 7px;border-radius:4px;font-size:10px;font-weight:700">${g.label||'-'}</span></td>
        <td><span style="display:inline-flex;align-items:center;gap:5px;font-weight:800" class="wt">
          ${wp?getPlayerPhotoHTML(g.winner,'22px'):''}
          <span style="cursor:pointer" onclick="openPlayerModal('${g.winner.replace(/'/g,"\\'")}')">
            ${wp?`<span class="rbadge r${wp.race}" style="font-size:10px;margin-right:2px">${wp.race}</span>`:''}${g.winner}${getStatusIconHTML(g.winner)}</span></span>
          ${wp?`<span class="ubadge" style="background:${wc};font-size:10px;padding:1px 6px;margin-left:4px">${wp.univ}</span>`:''}</td>
        <td><span style="display:inline-flex;align-items:center;gap:5px;opacity:.75">
          ${lp?getPlayerPhotoHTML(g.loser,'22px'):''}
          <span style="cursor:pointer" onclick="openPlayerModal('${g.loser.replace(/'/g,"\\'")}')">
            ${lp?`<span class="rbadge r${lp.race}" style="font-size:10px;margin-right:2px">${lp.race}</span>`:''}${g.loser}</span></span>
          ${lp?`<span class="ubadge" style="background:${lc};font-size:10px;padding:1px 6px;margin-left:4px;opacity:.7">${lp.univ}</span>`:''}</td>
        <td style="color:var(--gray-l);font-size:11px">${g.map}</td>
      </tr>`;
    });
    C.innerHTML=h+`</tbody></table>`;
    return;
  }

  let list=[...players]; // ëª¨ë“  ì„ ìˆ˜ í‘œì‹œ (ìŠ¹íŒ¨ ê¸°ë¡ ì—†ì–´ë„)
  if(fUniv!=='ì „ì²´')list=list.filter(p=>p.univ===fUniv);
  if(fTier!=='ì „ì²´')list=list.filter(p=>p.tier===fTier);
  // ì¢…ì¡± í•„í„° ì ìš©
  if(window._tierRaceFilter&&window._tierRaceFilter!=='ì „ì²´') list=list.filter(p=>p.race===window._tierRaceFilter);
  // ì „ì ì—†ëŠ” ì„ ìˆ˜ ìˆ¨ê¸°ê¸°
  if(window._tierHideNoRecord) list=list.filter(p=>(p.win+p.loss)>0);

  if(tierRankMode==='tier') list.sort((a,b)=>TIERS.indexOf(a.tier)-TIERS.indexOf(b.tier)||b.points-a.points);
  else if(tierRankMode==='wins') list.sort((a,b)=>b.win-a.win||a.loss-b.loss);
  else if(tierRankMode==='winrate'){
    list=list.filter(p=>(p.win+p.loss)>=1);
    list.sort((a,b)=>{const ra=(a.win+a.loss)?a.win/(a.win+a.loss):0;const rb=(b.win+b.loss)?b.win/(b.win+b.loss):0;return rb-ra||b.win-a.win;});
  }
  else if(tierRankMode==='winstreak'){
    // ìŠ¹ì°¨: ìŠ¹ìˆ˜ - íŒ¨ìˆ˜ (ë§ì„ìˆ˜ë¡ ìƒìœ„)
    list.sort((a,b)=>(b.win-b.loss)-(a.win-a.loss)||b.win-a.win);
  }
  else if(tierRankMode==='revstreak'){
    // ì—­ìŠ¹ì°¨: íŒ¨ìˆ˜ - ìŠ¹ìˆ˜ (ë§ì„ìˆ˜ë¡ ìƒìœ„, ì¦‰ ìŠ¹ì°¨ ë‚®ì€ ìˆœ)
    list.sort((a,b)=>(b.loss-b.win)-(a.loss-a.win)||b.loss-a.loss);
  }
  else if(tierRankMode==='elo'){
    list.sort((a,b)=>(b.elo||ELO_DEFAULT)-(a.elo||ELO_DEFAULT));
  }

  const modeHeaders={
    tier:'í¬ì¸íŠ¸',wins:'ìŠ¹',winrate:'ìŠ¹ë¥ ',winstreak:'ìŠ¹ì°¨',revstreak:'ì—­ìŠ¹ì°¨'
  };
  if(tierRankMode==='elo') tierRankMode='tier'; // ELO ì œê±° í›„ fallback
  const extraHeader=modeHeaders[tierRankMode]||'í¬ì¸íŠ¸';

  let h=`<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;width:100%"><table style="table-layout:auto;width:100%"><thead><tr>
    <th style="text-align:center;white-space:nowrap;padding:8px 10px">ìˆœìœ„</th>
    <th style="text-align:center;white-space:nowrap;padding:8px 10px">í‹°ì–´</th>
    <th style="text-align:center;white-space:nowrap;padding:8px 10px">ëŒ€í•™</th>
    <th style="text-align:center;white-space:nowrap;padding:8px 8px">ì¢…ì¡±</th>
    <th style="text-align:left;padding:8px 12px">ìŠ¤íŠ¸ë¦¬ë¨¸</th>
    <th style="text-align:center;white-space:nowrap;padding:8px 10px">ìŠ¹</th>
    <th style="text-align:center;white-space:nowrap;padding:8px 10px">íŒ¨</th>
    <th style="text-align:center;white-space:nowrap;padding:8px 10px">ìŠ¹ë¥ </th>
    <th style="text-align:center;white-space:nowrap;padding:8px 10px">${extraHeader}</th>
  </tr></thead><tbody>`;
  list.forEach((p,i)=>{
    const col=gc(p.univ);const tot=p.win+p.loss;const wr=tot?Math.round(p.win/tot*100):0;
    let rnkHTML;
    if(i===0) rnkHTML=`<span class="rk1">1ë“±</span>`;
    else if(i===1) rnkHTML=`<span class="rk2">2ë“±</span>`;
    else if(i===2) rnkHTML=`<span class="rk3">3ë“±</span>`;
    else rnkHTML=`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px">${i+1}ìœ„</span>`;
    let extraVal='';
    if(tierRankMode==='tier') extraVal=`<span class="${pC(p.points)}" style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px">${pS(p.points)}</span>`;
    else if(tierRankMode==='wins') extraVal=`<span class="wt" style="font-size:15px;font-weight:800">${p.win}</span>`;
    else if(tierRankMode==='winrate') extraVal=`<span style="font-weight:700;color:${wr>=50?'var(--green)':'var(--red)'}">${tot?wr+'%':'-'}</span>`;
    else if(tierRankMode==='winstreak'){const diff=p.win-p.loss;extraVal=`<span style="font-weight:800;color:${diff>0?'var(--green)':diff<0?'var(--red)':'var(--gray-l)'}">${diff>0?'+':''}${diff}</span>`;}
    else if(tierRankMode==='revstreak'){const diff=p.loss-p.win;extraVal=`<span style="font-weight:800;color:${diff>0?'var(--red)':diff<0?'var(--green)':'var(--gray-l)'}">${diff>0?'+':''}${diff}</span>`;}
    else if(tierRankMode==='elo'){const e=p.elo||ELO_DEFAULT;extraVal=`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:${e>=1400?'#7c3aed':e>=1300?'var(--gold)':e>=1200?'var(--green)':'var(--red)'}">${e}</span>`;}
    const univIconHTML=(()=>{const url=UNIV_ICONS[p.univ]||(univCfg.find(x=>x.name===p.univ)||{}).icon||'';return url?`<img src="${url}" style="width:16px;height:16px;object-fit:contain;border-radius:3px;flex-shrink:0" onerror="this.style.display='none'">`:``})();
    h+=`<tr>
      <td style="text-align:center;white-space:nowrap;padding:7px 10px">${rnkHTML}</td>
      <td style="text-align:center;white-space:nowrap;padding:7px 10px">${getTierBadge(p.tier)}</td>
      <td style="text-align:center;white-space:nowrap;padding:7px 8px"><span class="ubadge clickable-univ" data-icon-done="1" style="background:${col};display:inline-flex;align-items:center;gap:4px" onclick="openUnivModal('${p.univ}')">${univIconHTML}${p.univ}</span></td>
      <td style="text-align:center;white-space:nowrap;padding:7px 8px"><span class="rbadge r${p.race}">${p.race}</span></td>
      <td style="text-align:left;padding:7px 12px;font-weight:700;white-space:nowrap"><span style="display:inline-flex;align-items:center;gap:6px">${getPlayerPhotoHTML(p.name,'26px')}<span class="clickable-name" onclick="openPlayerModal('${p.name}')">${p.name}</span>${genderIcon(p.gender)}${getStatusIconHTML(p.name)}</span></td>
      <td style="text-align:center;white-space:nowrap;padding:7px 10px" class="wt">${p.win}</td>
      <td style="text-align:center;white-space:nowrap;padding:7px 10px" class="lt">${p.loss}</td>
      <td style="text-align:center;white-space:nowrap;padding:7px 10px;font-weight:700;color:${tot===0?'var(--gray-l)':wr>=50?'var(--green)':'var(--red)'}">${tot?wr+'%':'-'}</td>
      <td style="text-align:center;white-space:nowrap;padding:7px 10px">${extraVal}</td>
    </tr>`;
  });
  C.innerHTML=h+`</tbody></table></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëŒ€ì „ ê¸°ë¡ íƒ­
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   1:1 ìƒëŒ€ì „ì  â€” ì´ë¦„ ê²€ìƒ‰ ë°©ì‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// ê²€ìƒ‰ ì…ë ¥ ìƒíƒœ (ë Œë” ì‚¬ì´ ìœ ì§€)
let _vsInputA='', _vsInputB='';

function vsSearchHTML(){
  const colA=vsNameA?(gc((players.find(p=>p.name===vsNameA)||{}).univ||'')):'#2563eb';
  const colB=vsNameB?(gc((players.find(p=>p.name===vsNameB)||{}).univ||'')):'#dc2626';

  // ì„ íƒ ì™„ë£Œëœ ì„ ìˆ˜ ë±ƒì§€ or ê²€ìƒ‰ë°•ìŠ¤
  function playerSlot(slot){
    const name   = slot==='A'?vsNameA:vsNameB;
    const col    = slot==='A'?colA:colB;
    const inputId= `vs-input-${slot}`;
    const dropId = `vs-drop-${slot}`;
    const label  = slot==='A'?'ì„ ìˆ˜ A':'ì„ ìˆ˜ B';
    const inputVal= slot==='A'?_vsInputA:_vsInputB;
    if(name){
      const p=players.find(x=>x.name===name);
      const raceLabel=p?(p.race==='T'?'í…Œë€':p.race==='Z'?'ì €ê·¸':'í”„ë¡œí† ìŠ¤'):'';
      return `<div style="display:flex;align-items:center;gap:7px;flex:1;min-width:160px;background:${col}18;border:2px solid ${col}55;border-radius:10px;padding:8px 12px">
        ${p&&p.photo?`<img src="${p.photo}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid ${col};flex-shrink:0" onerror="this.style.display='none'">` : `<div style="width:34px;height:34px;border-radius:8px;background:${col};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:#fff;flex-shrink:0">${name[0]}</div>`}
        <div style="flex:1;min-width:0">
          <div style="font-weight:800;font-size:13px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${name}</div>
          <div style="font-size:10px;color:var(--gray-l)">${p?p.univ+' Â· '+p.tier+' Â· '+raceLabel:''}</div>
        </div>
        <button onclick="vsClearSlot('${slot}')" style="background:none;border:none;font-size:16px;color:var(--gray-l);cursor:pointer;padding:0 2px;line-height:1" title="ë³€ê²½">âœ•</button>
      </div>`;
    }
    return `<div style="flex:1;min-width:160px;position:relative">
      <div style="display:flex;align-items:center;gap:6px;border:2px solid var(--border2);border-radius:10px;padding:7px 12px;background:var(--white);transition:.15s" id="vs-wrap-${slot}">
        <span style="font-size:14px">${slot==='A'?'ğŸ”µ':'ğŸ”´'}</span>
        <input id="${inputId}" type="text" placeholder="${label} ì´ë¦„ ê²€ìƒ‰..."
          value="${inputVal}"
          oninput="_vsInput('${slot}',this.value)"
          onfocus="this.parentElement.style.borderColor='var(--blue)';this.parentElement.style.boxShadow='0 0 0 3px rgba(37,99,235,.1)'"
          onblur="setTimeout(()=>{this.parentElement.style.borderColor='';this.parentElement.style.boxShadow='';_vsHideDrop('${slot}')},180)"
          style="border:none;outline:none;background:transparent;font-size:13px;flex:1;color:var(--text);font-family:'Noto Sans KR',sans-serif">
        ${inputVal?`<button onclick="vsClearInput('${slot}')" style="background:none;border:none;font-size:13px;color:var(--gray-l);cursor:pointer;padding:0;line-height:1">âœ•</button>`:''}
      </div>
      <div id="${dropId}" style="display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--white);border:1px solid var(--border2);border-radius:10px;z-index:600;max-height:220px;overflow-y:auto;box-shadow:0 8px 24px rgba(0,0,0,.13)"></div>
    </div>`;
  }

  return `
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:14px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:6px">
      <div style="font-size:13px;font-weight:700;color:var(--text2)">âš”ï¸ 1:1 ìƒëŒ€ ì „ì  ì¡°íšŒ</div>
      ${(vsNameA||vsNameB)?`<button onclick="vsClearAll()" class="btn btn-w btn-sm" style="font-size:11px">ğŸ—‘ ì´ˆê¸°í™”</button>`:''}
    </div>
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      ${playerSlot('A')}
      <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px;color:var(--gray-l);flex-shrink:0">VS</div>
      ${playerSlot('B')}
    </div>
    ${(!vsNameA&&!vsNameB)?`<div style="margin-top:12px;font-size:11px;color:var(--gray-l);text-align:center">ğŸ’¡ ì„ ìˆ˜ ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ëª©ë¡ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</div>`:''}
  </div>
  <div id="vsResult"></div>`;
}

// ê²€ìƒ‰ ì…ë ¥ í•¸ë“¤ëŸ¬
function _vsInput(slot, val){
  if(slot==='A') _vsInputA=val; else _vsInputB=val;
  const dropId='vs-drop-'+slot;
  const drop=document.getElementById(dropId);
  if(!drop)return;
  const q=val.trim().toLowerCase();
  if(!q){drop.style.display='none';drop.innerHTML='';return;}
  const results=players.filter(p=>
    p.name.toLowerCase().includes(q)||(p.univ||'').toLowerCase().includes(q)
  ).slice(0,20);
  if(!results.length){
    drop.innerHTML='<div style="padding:12px 14px;color:var(--gray-l);font-size:12px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
    drop.style.display='block';return;
  }
  drop.innerHTML=results.map(p=>{
    const col=gc(p.univ);
    const raceLabel=p.race==='T'?'í…Œë€':p.race==='Z'?'ì €ê·¸':'í”„ë¡œí† ìŠ¤';
    const otherName=slot==='A'?vsNameB:vsNameA;
    const isSame=(p.name===otherName);
    return `<div onclick="${isSame?'':'vsSelectPlayer(\''+slot+'\',\''+p.name+'\')'}"
      style="padding:9px 14px;display:flex;align-items:center;gap:10px;cursor:${isSame?'not-allowed':'pointer'};opacity:${isSame?'.4':'1'};border-bottom:1px solid var(--border);transition:.1s"
      onmouseover="if(!${isSame})this.style.background='var(--blue-l)'"
      onmouseout="this.style.background=''">
      <div style="width:30px;height:30px;border-radius:7px;background:${col};display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:900;color:#fff;flex-shrink:0">${p.name[0]}</div>
      <div style="flex:1;min-width:0">
        <div style="font-weight:700;font-size:12px;color:var(--text)">${p.name}${isSame?'<span style="font-size:10px;color:var(--red);margin-left:4px">(ì´ë¯¸ ì„ íƒë¨)</span>':''}</div>
        <div style="font-size:10px;color:var(--gray-l)">${p.univ} Â· ${p.tier||'-'} Â· ${raceLabel}</div>
      </div>
      <span class="rbadge r${p.race}" style="font-size:10px;flex-shrink:0">${p.race}</span>
    </div>`;
  }).join('');
  drop.style.display='block';
}

function _vsHideDrop(slot){
  const drop=document.getElementById('vs-drop-'+slot);
  if(drop)drop.style.display='none';
}

function vsSelectPlayer(slot, name){
  if(slot==='A'){vsNameA=name;_vsInputA='';}
  else{vsNameB=name;_vsInputB='';}
  _vsHideDrop(slot);
  const C=document.getElementById('rcont');
  const T=document.getElementById('rtitle');
  if(C&&T) rHist(C,T);
}

function vsClearSlot(slot){
  if(slot==='A'){vsNameA='';_vsInputA='';}
  else{vsNameB='';_vsInputB='';}
  const C=document.getElementById('rcont');const T=document.getElementById('rtitle');
  if(C&&T)rHist(C,T);
}

function vsClearInput(slot){
  if(slot==='A')_vsInputA=''; else _vsInputB='';
  const C=document.getElementById('rcont');const T=document.getElementById('rtitle');
  if(C&&T){rHist(C,T);setTimeout(()=>{const inp=document.getElementById('vs-input-'+slot);if(inp)inp.focus();},0);}
  _vsHideDrop(slot);
}

function vsClearAll(){
  vsNameA='';vsNameB='';_vsInputA='';_vsInputB='';
  const C=document.getElementById('rcont');const T=document.getElementById('rtitle');
  if(C&&T)rHist(C,T);
}

// ì‹¤ì œ ê²°ê³¼ ê³„ì‚° + ë Œë”
function _vsRenderResult(){
  const r=document.getElementById('vsResult');
  if(!r)return;
  if(!vsNameA||!vsNameB||vsNameA===vsNameB){r.innerHTML='';return;}

  const pA=players.find(p=>p.name===vsNameA);
  const pB=players.find(p=>p.name===vsNameB);
  const colA=pA?gc(pA.univ):'#2563eb';
  const colB=pB?gc(pB.univ):'#dc2626';

  let aWins=0,bWins=0;
  const gameLogs=[];

  function scanVs(arr,modeLabel){
    arr.forEach(m=>{
      (m.sets||[]).forEach(set=>{
        (set.games||[]).forEach(g=>{
          const aIsA=(g.playerA===vsNameA&&g.playerB===vsNameB);
          const aIsB=(g.playerA===vsNameB&&g.playerB===vsNameA);
          if(!aIsA&&!aIsB)return;
          const aWon=(aIsA&&g.winner==='A')||(aIsB&&g.winner==='B');
          const bWon=(aIsA&&g.winner==='B')||(aIsB&&g.winner==='A');
          if(aWon)aWins++;else if(bWon)bWins++;
          gameLogs.push({date:m.d||'',mode:modeLabel,map:g.map||'-',aWon,bWon});
        });
      });
    });
  }
  scanVs(miniM,'âš¡ ë¯¸ë‹ˆëŒ€ì „');
  scanVs(univM,'ğŸŸï¸ ëŒ€í•™ëŒ€ì „');
  scanVs(comps,'ğŸ–ï¸ ëŒ€íšŒ');
  scanVs(ckM,'ğŸ¤ ëŒ€í•™CK');
  scanVs(proM,'ğŸ… í”„ë¡œë¦¬ê·¸');
  gameLogs.sort((a,b)=>b.date.localeCompare(a.date));

  const total=aWins+bWins;
  const aRate=total?Math.round(aWins/total*100):0;
  const bRate=total?100-aRate:0;
  const aLeading=aWins>bWins, bLeading=bWins>aWins;

  // ìŠ¤íŠ¸ë¦­ ê³„ì‚°
  let streak=0, streakName='';
  for(const lg of gameLogs){
    if(streak===0){streak=lg.aWon?1:lg.bWon?-1:0;streakName=lg.aWon?vsNameA:vsNameB;}
    else if(streak>0&&lg.aWon)streak++;
    else if(streak<0&&lg.bWon)streak--;
    else break;
  }
  const streakAbs=Math.abs(streak);

  r.innerHTML=`<div class="vs-box" id="vs-result-card">
    <!-- ìƒë‹¨ í—¤ë”: ë‘ ì„ ìˆ˜ ì •ë³´ -->
    <div style="display:flex;align-items:stretch;gap:10px;margin-bottom:16px;flex-wrap:wrap">
      <!-- A ì„ ìˆ˜ ì¹´ë“œ -->
      <div style="flex:1;min-width:130px;background:${colA}18;border:2px solid ${colA}44;border-radius:10px;padding:12px;text-align:center">
        <div style="width:44px;height:44px;border-radius:10px;background:${colA};margin:0 auto 8px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;color:#fff">${vsNameA[0]}</div>
        <div style="font-weight:800;font-size:13px;color:var(--text)">${vsNameA}</div>
        ${pA?`<div style="font-size:10px;color:var(--gray-l);margin-top:2px">${pA.univ}</div>`:''}
        ${pA?getTierBadge(pA.tier):''}
        ${aLeading?'<div style="margin-top:6px;font-size:10px;font-weight:800;color:'+colA+'">ğŸ† ìš°ì„¸</div>':''}
      </div>
      <!-- ì¤‘ì•™ ìŠ¤ì½”ì–´ -->
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px;min-width:80px">
        <div style="font-size:11px;color:var(--gray-l);margin-bottom:4px;letter-spacing:.5px">ì „ì²´ ì „ì </div>
        <div style="display:flex;align-items:center;gap:6px">
          <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:34px;color:${aLeading?colA:'var(--text3)'}">${aWins}</span>
          <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:22px;color:var(--gray-l)">:</span>
          <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:34px;color:${bLeading?colB:'var(--text3)'}">${bWins}</span>
        </div>
        <div style="font-size:10px;color:var(--text3);margin-top:3px">ì´ ${total}ê²Œì„</div>
        ${streakAbs>=2?`<div style="margin-top:6px;font-size:10px;font-weight:700;color:${aWins>bWins?colA:colB};background:${aWins>bWins?colA+'18':colB+'18'};border-radius:20px;padding:2px 8px">${streakName} ${streakAbs}ì—°ìŠ¹</div>`:''}
      </div>
      <!-- B ì„ ìˆ˜ ì¹´ë“œ -->
      <div style="flex:1;min-width:130px;background:${colB}18;border:2px solid ${colB}44;border-radius:10px;padding:12px;text-align:center">
        <div style="width:44px;height:44px;border-radius:10px;background:${colB};margin:0 auto 8px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;color:#fff">${vsNameB[0]}</div>
        <div style="font-weight:800;font-size:13px;color:var(--text)">${vsNameB}</div>
        ${pB?`<div style="font-size:10px;color:var(--gray-l);margin-top:2px">${pB.univ}</div>`:''}
        ${pB?getTierBadge(pB.tier):''}
        ${bLeading?'<div style="margin-top:6px;font-size:10px;font-weight:800;color:'+colB+'">ğŸ† ìš°ì„¸</div>':''}
      </div>
    </div>

    ${total===0?`<div style="padding:24px;text-align:center;color:var(--gray-l);background:var(--surface);border-radius:8px;font-size:13px">ë‘ ì„ ìˆ˜ ê°„ ì§ì ‘ ëŒ€ê²° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`:`
    <!-- ìŠ¹ë¥  ë°” -->
    <div style="margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;font-size:11px;font-weight:700;margin-bottom:5px">
        <span style="color:${colA}">${vsNameA} ${aRate}%</span>
        <span style="color:${colB}">${bRate}% ${vsNameB}</span>
      </div>
      <div class="vs-bar-wrap">
        <div class="vs-bar-a" style="width:${aRate}%"></div>
        <div class="vs-bar-b" style="width:${bRate}%"></div>
      </div>
    </div>

    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
    <div style="display:flex;gap:7px;margin-bottom:14px;flex-wrap:wrap" class="no-export">
      <button class="btn btn-p btn-sm" onclick="openVsShareCard()">ğŸ´ ê³µìœ  ì¹´ë“œ</button>
      <button class="btn-capture btn-sm" onclick="captureVsCard()">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
      <button class="btn btn-w btn-sm" onclick="vsClearAll()">ğŸ—‘ ê²°ê³¼ ì§€ìš°ê¸°</button>
    </div>

    <!-- ëŒ€ì „ ë‚´ì—­ í…Œì´ë¸” -->
    <div style="font-size:12px;font-weight:700;color:var(--text2);margin-bottom:8px">ğŸ“‹ ê²Œì„ ë‚´ì—­ (${gameLogs.length}ê±´)</div>
    <div style="overflow-x:auto">
      <table style="min-width:340px"><thead><tr><th>ë‚ ì§œ</th><th>ëŒ€ì „ ì¢…ë¥˜</th><th>ë§µ</th><th>ê²°ê³¼</th></tr></thead><tbody>
      ${gameLogs.length===0?`<tr><td colspan="4" style="padding:20px;color:var(--gray-l)">ì—†ìŒ</td></tr>`:''}
      ${gameLogs.map(lg=>`<tr>
        <td style="color:var(--gray-l);font-size:11px">${lg.date}</td>
        <td style="font-size:11px">${lg.mode}</td>
        <td style="color:var(--gray-l);font-size:11px">${lg.map!=='-'?'ğŸ“'+lg.map:'-'}</td>
        <td>${lg.aWon?`<span style="font-weight:700;color:${colA}">â–¶ ${vsNameA} ìŠ¹</span>`:lg.bWon?`<span style="font-weight:700;color:${colB}">â–¶ ${vsNameB} ìŠ¹</span>`:'<span style="color:var(--gray-l)">ë¯¸ì •</span>'}</td>
      </tr>`).join('')}
      </tbody></table>
    </div>`}
  </div>`;
}

// renderVsëŠ” í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€
function renderVs(){
  if(vsNameA&&vsNameB&&vsNameA!==vsNameB) _vsRenderResult();
}

/* â”€â”€ 1:1 ì „ì  ê³µìœ  ì¹´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openVsShareCard(){
  if(!vsNameA||!vsNameB||vsNameA===vsNameB)return;
  const pA=players.find(p=>p.name===vsNameA);
  const pB=players.find(p=>p.name===vsNameB);
  const colA=pA?gc(pA.univ):'#2563eb';
  const colB=pB?gc(pB.univ):'#dc2626';

  let aWins=0,bWins=0;
  const gameLogs=[];
  function scanVs(arr,label){
    arr.forEach(m=>{(m.sets||[]).forEach(s=>{(s.games||[]).forEach(g=>{
      const aIsA=(g.playerA===vsNameA&&g.playerB===vsNameB);
      const aIsB=(g.playerA===vsNameB&&g.playerB===vsNameA);
      if(!aIsA&&!aIsB)return;
      const aWon=(aIsA&&g.winner==='A')||(aIsB&&g.winner==='B');
      const bWon=(aIsA&&g.winner==='B')||(aIsB&&g.winner==='A');
      if(aWon)aWins++;else if(bWon)bWins++;
      gameLogs.push({date:m.d||'',mode:label,map:g.map||'-',aWon,bWon});
    });});});
  }
  scanVs(miniM,'âš¡ ë¯¸ë‹ˆëŒ€ì „');
  scanVs(univM,'ğŸŸï¸ ëŒ€í•™ëŒ€ì „');
  scanVs(comps,'ğŸ–ï¸ ëŒ€íšŒ');
  scanVs(ckM,'ğŸ¤ ëŒ€í•™CK');
  scanVs(proM,'ğŸ… í”„ë¡œë¦¬ê·¸');
  gameLogs.sort((a,b)=>b.date.localeCompare(a.date));

  const total=aWins+bWins;
  const aRate=total?Math.round(aWins/total*100):0;
  const bRate=total?100-aRate:0;
  const aLead=aWins>bWins,bLead=bWins>aWins;

  // ë°°ê²½: ìš°ì„¸í•œ ìª½ ìƒ‰ìƒ HSL ê¸°ë°˜ â€” ì±„ë„Â·ìƒ‰ì¡° ì‚´ë¦¬ê³  ëª…ë„ë§Œ ë‚®ì¶¤
  function hexToHslVs(hex){
    let h=(hex||'').replace('#','');
    if(h.length===3)h=h[0]+h[0]+h[1]+h[1]+h[2]+h[2];
    if(h.length!==6)return null;
    let r=parseInt(h.slice(0,2),16)/255,g=parseInt(h.slice(2,4),16)/255,b=parseInt(h.slice(4,6),16)/255;
    const mx=Math.max(r,g,b),mn=Math.min(r,g,b);
    let hue=0,sat=0,lit=(mx+mn)/2;
    if(mx!==mn){const d=mx-mn;sat=lit>.5?d/(2-mx-mn):d/(mx+mn);
      if(mx===r)hue=((g-b)/d+(g<b?6:0))/6;
      else if(mx===g)hue=((b-r)/d+2)/6;
      else hue=((r-g)/d+4)/6;}
    return{h:Math.round(hue*360),s:Math.round(sat*100),l:Math.round(lit*100)};
  }
  function makeVsBg(hex){
    const hsl=hexToHslVs(hex);
    if(!hsl)return{bg:'linear-gradient(135deg,#1e3a5c,#1e4a7c)',accent:'#60a5fa'};
    const {h,s,l}=hsl;
    const bgS=Math.max(Math.min(s,60),25);
    const bgL1=Math.min(l+28,90);
    const bgL2=Math.min(l+38,96);
    const accent=`hsl(${h},${Math.min(s+5,90)}%,${Math.max(l-5,25)}%)`;
    return{bg:`linear-gradient(135deg,hsl(${h},${bgS}%,${bgL1}%),hsl(${h},${Math.max(bgS-10,15)}%,${bgL2}%))`,accent};
  }
  const vsWinBg=aLead?makeVsBg(colA):bLead?makeVsBg(colB):{bg:'linear-gradient(135deg,#1e3a5c,#1e4a7c)',accent:'#60a5fa'};
  const winCol=vsWinBg.accent;
  const cardBg=vsWinBg.bg;
  // ë°°ê²½ì´ ë°ì•„ì¡Œìœ¼ë¯€ë¡œ í…ìŠ¤íŠ¸ ì–´ë‘¡ê²Œ
  const vsHslWin=aLead?hexToHslVs(colA):bLead?hexToHslVs(colB):null;
  const vsTextColor=vsHslWin?`hsl(${vsHslWin.h},${Math.min(vsHslWin.s,50)}%,${Math.max(vsHslWin.l-40,8)}%)`:'#fff';
  const vsDimColor=vsHslWin?`hsla(${vsHslWin.h},${Math.min(vsHslWin.s,40)}%,${Math.max(vsHslWin.l-25,20)}%,.7)`:'rgba(255,255,255,.5)';

  // ìµœê·¼ 5ê²½ê¸° í¼
  const recentForm=gameLogs.slice(0,5).map(lg=>
    lg.aWon?`<span style="display:inline-block;width:22px;height:22px;background:${colA};color:#fff;font-size:10px;font-weight:800;border-radius:5px;text-align:center;line-height:22px">W</span>`
    :lg.bWon?`<span style="display:inline-block;width:22px;height:22px;background:${colB};color:#fff;font-size:10px;font-weight:800;border-radius:5px;text-align:center;line-height:22px">W</span>`
    :`<span style="display:inline-block;width:22px;height:22px;background:#475569;color:#fff;font-size:10px;border-radius:5px;text-align:center;line-height:22px">-</span>`
  ).join('');

  // ì¹´ë“œ HTML
  const cardHTML=`<div id="vs-share-card-inner" style="background:${cardBg};padding:22px;color:${vsTextColor};width:380px;font-family:'Noto Sans KR',sans-serif;position:relative;overflow:hidden">
    <div style="position:absolute;top:-30px;right:-30px;width:130px;height:130px;border-radius:50%;background:${winCol};opacity:.08;pointer-events:none"></div>
    <!-- ì œëª© -->
    <div style="text-align:center;margin-bottom:16px">
      <div style="font-size:10px;color:${vsDimColor};letter-spacing:1px;margin-bottom:4px">âš”ï¸ 1:1 ìƒëŒ€ ì „ì </div>
      <div style="font-size:11px;color:${vsDimColor}">${new Date().toLocaleDateString('ko-KR')} ê¸°ì¤€</div>
    </div>
    <!-- ë‘ ì„ ìˆ˜ ëŒ€ê²° -->
    <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:16px">
      <div style="text-align:center;flex:1">
        <div style="width:48px;height:48px;border-radius:12px;background:${colA};margin:0 auto 6px;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;border:${aLead?'3px solid rgba(255,255,255,.7)':'2px solid rgba(255,255,255,.25)'};${aLead?'box-shadow:0 0 16px '+colA+'99':''}">${vsNameA[0]}</div>
        <div style="font-size:13px;font-weight:800;${aLead?'':'opacity:.65'}">${vsNameA}</div>
        ${pA?`<div style="font-size:9px;opacity:.6;margin-top:1px">${pA.univ} Â· ${pA.tier}</div>`:''}
        ${aLead?`<div style="margin-top:5px;font-size:10px;font-weight:800;color:${colA};background:rgba(255,255,255,.15);border-radius:20px;padding:2px 9px;display:inline-block">ğŸ† ìš°ì„¸</div>`:''}
      </div>
      <div style="text-align:center;flex-shrink:0">
        <div style="font-size:42px;font-weight:900;letter-spacing:3px;line-height:1">
          <span style="color:${aLead?'#4ade80':'rgba(255,255,255,.5)'}">${aWins}</span>
          <span style="color:rgba(255,255,255,.2);font-size:26px;margin:0 4px">:</span>
          <span style="color:${bLead?'#4ade80':'rgba(255,255,255,.5)'}">${bWins}</span>
        </div>
        <div style="font-size:9px;color:${vsDimColor};margin-top:3px">ì´ ${total}ê²Œì„</div>
      </div>
      <div style="text-align:center;flex:1">
        <div style="width:48px;height:48px;border-radius:12px;background:${colB};margin:0 auto 6px;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;border:${bLead?'3px solid rgba(255,255,255,.7)':'2px solid rgba(255,255,255,.25)'};${bLead?'box-shadow:0 0 16px '+colB+'99':''}">${vsNameB[0]}</div>
        <div style="font-size:13px;font-weight:800;${bLead?'':'opacity:.65'}">${vsNameB}</div>
        ${pB?`<div style="font-size:9px;opacity:.6;margin-top:1px">${pB.univ} Â· ${pB.tier}</div>`:''}
        ${bLead?`<div style="margin-top:5px;font-size:10px;font-weight:800;color:${colB};background:rgba(255,255,255,.15);border-radius:20px;padding:2px 9px;display:inline-block">ğŸ† ìš°ì„¸</div>`:''}
      </div>
    </div>
    <!-- ìŠ¹ë¥  ë°” -->
    ${total>0?`<div style="margin-bottom:12px">
      <div style="height:6px;border-radius:3px;background:rgba(255,255,255,.15);overflow:hidden;display:flex">
        <div style="width:${aRate}%;background:${colA};border-radius:3px 0 0 3px"></div>
        <div style="width:${bRate}%;background:${colB};border-radius:0 3px 3px 0"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:10px">
        <span style="color:${colA};font-weight:700">${aRate}%</span>
        <span style="color:${colB};font-weight:700">${bRate}%</span>
      </div>
    </div>`:''}
    <!-- ìµœê·¼ 5ê²½ê¸° -->
    ${gameLogs.length?`<div style="margin-bottom:12px">
      <div style="font-size:9px;color:${vsDimColor};letter-spacing:.5px;margin-bottom:5px">ìµœê·¼ ê²½ê¸° (${vsNameA}ê¸°ì¤€: W=ìŠ¹, ${vsNameB} W=íŒ¨)</div>
      <div style="display:flex;gap:4px">${recentForm}</div>
    </div>`:''}
    <!-- í‘¸í„° -->
    <div style="text-align:right;font-size:9px;color:${vsDimColor};letter-spacing:.3px">â­ ìŠ¤íƒ€ëŒ€í•™ ë°ì´í„° ì„¼í„°</div>
  </div>`;

  // ëª¨ë‹¬ ì—´ê¸°
  const existing=document.getElementById('sharecard-overlay');
  if(existing)existing.remove();
  const overlay=document.createElement('div');
  overlay.id='sharecard-overlay';
  overlay.className='sharecard-modal-overlay';
  overlay.innerHTML=`<div class="sharecard-modal-box" onclick="event.stopPropagation()" style="max-width:460px;width:96vw">
    <button class="sharecard-modal-close" onclick="document.getElementById('sharecard-overlay').remove()">âœ•</button>
    <div style="font-weight:700;font-size:14px;color:var(--blue);margin-bottom:14px;padding-right:30px">ğŸ´ 1:1 ìƒëŒ€ ì „ì  ê³µìœ  ì¹´ë“œ</div>
    <div id="modal-share-card" style="display:flex;justify-content:center;overflow:auto;max-height:70vh">
      <div id="share-card">${cardHTML}</div>
    </div>
    <div class="sharecard-modal-actions" style="margin-top:16px">
      <button class="btn btn-p" onclick="downloadVsShareCard('jpg')">ğŸ“· JPG ì €ì¥</button>
      <button class="btn btn-w" onclick="downloadVsShareCard('png')">ğŸ–¼ PNG ì €ì¥</button>
      <button class="btn btn-w" onclick="document.getElementById('sharecard-overlay').remove()">ë‹«ê¸°</button>
    </div>
  </div>`;
  overlay.addEventListener('click',e=>{if(e.target===overlay)overlay.remove();});
  document.body.appendChild(overlay);
}

async function downloadVsShareCard(fmt){
  const el=document.getElementById('vs-share-card-inner')||document.getElementById('share-card');
  if(!el){alert('ì¹´ë“œë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”.');return;}
  try{
    const canvas=await html2canvas(el,{backgroundColor:null,scale:3,useCORS:true,logging:false});
    const a=document.createElement('a');
    a.download=`vs_${vsNameA}_vs_${vsNameB}_${new Date().toISOString().slice(0,10)}.${fmt}`;
    a.href=fmt==='jpg'?canvas.toDataURL('image/jpeg',0.96):canvas.toDataURL('image/png');
    a.click();
  }catch(e){alert('ì €ì¥ ì˜¤ë¥˜: '+e.message);}
}

async function captureVsCard(){
  const el=document.getElementById('vs-result-card');
  if(!el){alert('ê²°ê³¼ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');return;}
  try{
    const canvas=await html2canvas(el,{backgroundColor:null,scale:2,useCORS:true,logging:false,ignoreElements:e=>e.classList.contains('no-export')});
    const a=document.createElement('a');
    a.download=`vs_${vsNameA}_vs_${vsNameB}_${new Date().toISOString().slice(0,10)}.jpg`;
    a.href=canvas.toDataURL('image/jpeg',0.95);
    a.click();
  }catch(e){alert('ì €ì¥ ì˜¤ë¥˜: '+e.message);}
}

function rHist(C,T){
  T.innerText='ğŸ“… ëŒ€ì „ ê¸°ë¡';

  // â”€â”€ ì´ë²ˆë‹¬ ìš”ì•½ ë°°ë„ˆ â”€â”€
  let _bannerHTML='';
  (()=>{
    const now=new Date();
    const ym=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const allM=[...miniM,...univM,...ckM,...comps];
    const thisMonth=allM.filter(m=>(m.d||'').startsWith(ym)&&m.sa!=null&&m.sb!=null);
    if(!thisMonth.length) return;
    const total=thisMonth.length;
    const pCount={};
    thisMonth.forEach(m=>{
      (m.sets||[]).forEach(s=>(s.games||[]).forEach(g=>{
        if(g.playerA)pCount[g.playerA]=(pCount[g.playerA]||0)+1;
        if(g.playerB)pCount[g.playerB]=(pCount[g.playerB]||0)+1;
      }));
    });
    const mvp=Object.entries(pCount).sort((a,b)=>b[1]-a[1])[0];
    _bannerHTML=`<div style="background:linear-gradient(90deg,#1e40af,#3b82f6);color:#fff;border-radius:12px;padding:10px 18px;margin-bottom:14px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;box-shadow:0 4px 14px #3b82f644">
      <span style="font-size:20px">ğŸ“…</span>
      <span style="font-size:13px;font-weight:700">${now.getMonth()+1}ì›” í˜„ì¬ <b style="font-size:18px">${total}</b>ê²½ê¸° ì§„í–‰</span>
      ${mvp?`<span style="font-size:12px;background:rgba(255,255,255,.18);border-radius:8px;padding:3px 12px">ğŸ”¥ ìµœë‹¤ì¶œì „ <b>${mvp[0]}</b> (${mvp[1]}ê²Œì„)</span>`:''}
      <span style="font-size:11px;color:rgba(255,255,255,.75);margin-left:auto">${ym}</span>
    </div>`;
  })();
  const tabs=[
    {id:'race',lbl:'ğŸ§¬ ì¢…ì¡±ìŠ¹ë¥ '},
    {id:'mini',lbl:'âš¡ ë¯¸ë‹ˆëŒ€ì „'},
    {id:'ck',lbl:'ğŸ¤ ëŒ€í•™CK'},
    {id:'univm',lbl:'ğŸŸï¸ ëŒ€í•™ëŒ€ì „'},
    {id:'tourney',lbl:'ğŸ–ï¸ ëŒ€íšŒ'},
    {id:'tiertour',lbl:'ğŸ¯ í‹°ì–´ëŒ€íšŒ'},
    {id:'univstat',lbl:'ğŸ›ï¸ ëŒ€í•™ë³„'},
    {id:'univrank',lbl:'ğŸ›ï¸ ëŒ€í•™ë³„ í¬ì¸íŠ¸ ìˆœìœ„'},
    {id:'pro',lbl:'ğŸ… í”„ë¡œë¦¬ê·¸'},
    {id:'player',lbl:'ğŸ‘¤ ì„ ìˆ˜ë³„'},
    {id:'vs',lbl:'âš”ï¸ 1:1 ìƒëŒ€ì „ì '}
  ];
  let h=_bannerHTML+`<div class="stabs no-export">`;
  tabs.forEach(t=>{h+=`<button class="stab ${histSub===t.id?'on':''}" onclick="histSub='${t.id}';openDetails={};if(histPage['${t.id}']!==undefined)histPage['${t.id}']=0;render()">${t.lbl}</button>`;});
  h+=`</div>`;
  const needDateFilter=['mini','ck','univm','comp','tourney','pro','player'].includes(histSub);
  if(needDateFilter && typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('hist');
  }
  if(histSub==='vs'){
    h+=vsSearchHTML();
    C.innerHTML=h;
    // ë‘ ì„ ìˆ˜ ì´ë¯¸ ì„ íƒëœ ê²½ìš° ê²°ê³¼ ì¦‰ì‹œ ë Œë”
    if(vsNameA&&vsNameB&&vsNameA!==vsNameB) _vsRenderResult();
    return;
  }
  if(histSub==='player'){
    h+=`<input type="text" id="hs" placeholder="ğŸ” ìŠ¤íŠ¸ë¦¬ë¨¸ ê²€ìƒ‰..." onkeyup="doSearch(this.value)"
      style="width:100%;max-width:320px;padding:10px 16px;border:2px solid var(--blue);border-radius:8px;font-size:13px;margin-bottom:16px;">
      <div id="hres"></div>`;
    C.innerHTML=h;
    if(searchTarget){
      document.getElementById('hs').value=searchTarget;
      doSearch(searchTarget);
    }
    return;
  }
  if(histSub==='race'){
    if(typeof raceSummaryHTML==='function'){
      h+=raceSummaryHTML();
      C.innerHTML=h;
      return;
    }
    rRace(C,T);
    return;
  }
  if(histSub==='univstat'){h+=rHistUnivStat();C.innerHTML=h;return;}
  if(histSub==='univrank'){
    if(typeof rUnivBodyHTML==='function'){
      h+=rUnivBodyHTML();
      C.innerHTML=h;
      return;
    }
    rUniv(C,T);
    return;
  }
  if(histSub==='mini') h+=recSummaryListHTML(miniM,'mini','hist');
  else if(histSub==='ck') h+=recSummaryListHTML(ckM,'ck','hist');
  else if(histSub==='univm') h+=recSummaryListHTML(univM,'univm','hist');
  else if(histSub==='comp') h+=compSummaryListHTML('hist');
  else if(histSub==='tourney') h+=histTourneyHTML('hist');
  else if(histSub==='tiertour') h+=ttM&&ttM.length?recSummaryListHTMLFiltered(ttM,'tt','hist'):'<div style="padding:40px;text-align:center;color:var(--gray-l)">í‹°ì–´ëŒ€íšŒ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
  else if(histSub==='pro') h+=recSummaryListHTML(proM,'pro','hist');
  C.innerHTML=h;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëŒ€ì „ ê¸°ë¡ > ëŒ€íšŒ íƒ­: ë¯¸ë‹ˆëŒ€ì „ì²˜ëŸ¼ ë³´ì´ëŠ” ëŒ€íšŒ ê²½ê¸° ê¸°ë¡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function histTourneyHTML(context){
  // tourneys(ì¡°í¸ì„± ëŒ€íšŒ) + comps(ê¸°ì¡´ ëŒ€íšŒ) í•©ì‚°
  const tourItems=getTourneyMatches();
  const compItems=[...comps].map((m,origIdx)=>({...m,_src:'comps',_origIdx:origIdx}));
  const allItems=[...tourItems,...compItems].filter(m=>{
    if(!m.a||!m.b) return false;
    if(m.sa==null||m.sa===''||m.sb==null||m.sb==='') return false;
    if(isNaN(Number(m.sa))||isNaN(Number(m.sb))) return false;
    return typeof passDateFilter!=='function'||passDateFilter(m.d||'');
  });
  allItems.sort((a,b)=>recSortDir==='asc'?(a.d||'').localeCompare(b.d||''):(b.d||'').localeCompare(a.d||''));
  const sortBar=`<div class="sort-bar no-export">
    <span style="font-size:11px;color:var(--text3)">ë‚ ì§œ ì •ë ¬</span>
    <button class="sort-btn ${recSortDir==='desc'?'on':''}" onclick="recSortDir='desc';render()">ìµœì‹ ìˆœ â†“</button>
    <button class="sort-btn ${recSortDir==='asc'?'on':''}" onclick="recSortDir='asc';render()">ì˜¤ë˜ëœìˆœ â†‘</button>
    <span style="font-size:11px;color:var(--gray-l);margin-left:4px">${allItems.length}ê±´</span>
  </div>`;
  if(!allItems.length) return sortBar+`<div style="padding:40px;text-align:center;color:var(--gray-l);">ëŒ€íšŒ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;

  // ëŒ€íšŒëª…ë³„ë¡œ ê·¸ë£¹í™”
  const groups={};
  allItems.forEach((m,idx)=>{
    const compName=m.n||m.compName||'ê¸°íƒ€ ëŒ€íšŒ';
    if(!groups[compName]) groups[compName]=[];
    groups[compName].push({m,idx});
  });

  let h=sortBar;
  Object.entries(groups).forEach(([compName,items])=>{
    const firstDate=items[items.length-1]?.m?.d||'';
    const lastDate=items[0]?.m?.d||'';
    const dateRange=firstDate===lastDate?firstDate:(firstDate&&lastDate?`${lastDate} ~ ${firstDate}`:'');
    h+=`<div style="background:linear-gradient(90deg,var(--blue-l),var(--white));border:1.5px solid var(--blue-ll);border-radius:12px;padding:10px 16px;margin-bottom:6px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:var(--blue)">ğŸ–ï¸ ${compName}</span>
      ${dateRange?`<span style="font-size:11px;color:var(--gray-l)">${dateRange}</span>`:''}
      <span style="font-size:11px;color:var(--text3);background:var(--blue-ll);border-radius:20px;padding:1px 10px">${items.length}ê²½ê¸°</span>
    </div>`;
    items.forEach(({m,idx})=>{
      const a=m.a||'',b=m.b||'';
      const ca=gc(a),cb=gc(b);
      const aWin=m.sa>m.sb,bWin=m.sb>m.sa;
      const key=`${context}-tourney-${idx}`;
      const rIdx=(m._src==='comps')?m._origIdx:-1;
      const grpBadge=m._src==='tour'
        ?`<span style="background:${m.grpColor||'#2563eb'};color:#fff;font-size:10px;font-weight:700;padding:1px 8px;border-radius:4px">GROUP ${m.grpLetter||''}</span>`:'';
      h+=`<div class="rec-summary" style="margin-left:12px;border-left:3px solid var(--blue-ll)">
        <div class="rec-sum-header">
          <span style="color:var(--gray-l);font-size:11px;min-width:72px">${m.d||''}</span>
          ${grpBadge}
          <div class="rec-sum-vs">
            ${a?`<span class="ubadge${aWin?'':' loser'} clickable-univ" style="background:${ca}" onclick="openUnivModal('${a}')">${a}</span>`:''}
            ${(a&&b)?`<div class="rec-sum-score score-click" onclick="toggleDetail('${key}')" title="í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°">
              <span class="${aWin?'wt':bWin?'lt':'pt-z'}">${m.sa||0}</span>
              <span style="color:var(--gray-l);font-size:14px">:</span>
              <span class="${bWin?'wt':aWin?'lt':'pt-z'}">${m.sb||0}</span>
            </div>`:''}
            ${b?`<span class="ubadge${bWin?'':' loser'} clickable-univ" style="background:${cb}" onclick="openUnivModal('${b}')">${b}</span>`:''}
            ${(a&&b)?`<span style="font-size:12px;font-weight:700;color:${aWin?ca:bWin?cb:'#888'}">
              ${aWin?'â–¶ '+a+' ìŠ¹':bWin?'â–¶ '+b+' ìŠ¹':'ë¬´ìŠ¹ë¶€'}
            </span>`:''}
          </div>
          <div style="margin-left:auto;display:flex;gap:5px;align-items:center" class="no-export">
            <button id="detbtn-${key}" class="btn-detail" onclick="toggleDetail('${key}')">â–¼ ìƒì„¸</button>
            ${rIdx>=0?adminBtn(`<button class="btn btn-o btn-xs" onclick="openRE('comp',${rIdx})">ìˆ˜ì •</button>`):''}
            ${rIdx>=0?adminBtn(`<button class="btn btn-r btn-xs" onclick="delRec('comp',${rIdx})">ì‚­ì œ</button>`):''}
            ${m._src==='tour'?adminBtn(`<button class="btn btn-o btn-xs" onclick="leagueEditMatch('${m._tnId}',${m._gi},${m._mi})">ìˆ˜ì •</button>`):''}
          </div>
        </div>
        <div id="det-${key}" class="rec-detail-area">
          ${buildDetailHTML(m,'comp',a,b,ca,cb,aWin,bWin)}
          <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)" class="no-export">
            ${m.memo?`<div style="font-size:12px;color:var(--text2);background:#fffbeb;border:1px solid var(--gold-b);border-radius:6px;padding:6px 10px;margin-bottom:6px">ğŸ“ ${m.memo}</div>`:''}
            <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
              <button class="btn-capture btn-xs" onclick="captureDetail('det-${key}','ëŒ€íšŒ_${(m.d||'match').replace(/\//g,'-')}')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
              <button class="btn btn-p btn-xs" onclick="_shareMode='match';window._shareMatchObj=_getHistTourneyMatchObj(${idx},'${context}');openShareCardModal();setTimeout(()=>renderShareCardByMatchObj(window._shareMatchObj),80)">ğŸ´ ê³µìœ  ì¹´ë“œ</button>
              ${rIdx>=0&&isLoggedIn?`<input type="text" id="memo-${key}" placeholder="ê²½ê¸° ë©”ëª¨..." value="${m.memo||''}" style="flex:1;font-size:12px">
              <button class="btn btn-w btn-xs" onclick="saveMemo('comp',${rIdx},'memo-${key}')">ğŸ’¾ ë©”ëª¨</button>
              ${m.memo?`<button class="btn btn-r btn-xs" onclick="saveMemo('comp',${rIdx},null)">ì‚­ì œ</button>`:''}`:''}
            </div>
          </div>
        </div>
      </div>`;
    });
  });
  return h;
}

// ëŒ€íšŒ íƒ­ ê³µìœ ì¹´ë“œìš© í—¬í¼
window._histTourneyCache={};
function _getHistTourneyMatchObj(idx, context){
  const key=context+'_tourney';
  if(!window._histTourneyCache[key]){
    const tourItems=getTourneyMatches();
    const compItems=[...comps].map((m,origIdx)=>({...m,_src:'comps',_origIdx:origIdx}));
    const all=[...tourItems,...compItems].filter(m=>{
      if(!m.a||!m.b) return false;
      if(m.sa==null||m.sb==null) return false;
      return typeof passDateFilter!=='function'||passDateFilter(m.d||'');
    });
    all.sort((a,b)=>recSortDir==='asc'?(a.d||'').localeCompare(b.d||''):(b.d||'').localeCompare(a.d||''));
    window._histTourneyCache[key]=all;
  }
  return window._histTourneyCache[key][idx]||null;
}


function rHistUnivStat(){
  const allU=getAllUnivs();
  if(!histUniv&&allU.length) histUniv=allU[0].name;
  let h='';
  if(typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('hist-univ');
  }
  h+=`<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px;" class="no-export">`;
  allU.forEach(u=>{
    const sel=histUniv===u.name;
    h+=`<button class="pill ${sel?'on':''}" style="${sel?`background:${u.color};border-color:${u.color};color:#fff`:''}" onclick="histUniv='${u.name}';openDetails={};render()">${u.name}</button>`;
  });
  h+=`</div>`;
  if(!histUniv) return h+`<div style="padding:40px;text-align:center;color:var(--gray-l)">ëŒ€í•™ì„ ì„ íƒí•˜ì„¸ìš”.</div>`;
  const col=gc(histUniv);
  const myMini=miniM.filter(m=>(m.a===histUniv||m.b===histUniv)&&(!passDateFilter||passDateFilter(m.d||'')));
  const myUnivM=univM.filter(m=>(m.a===histUniv||m.b===histUniv)&&(!passDateFilter||passDateFilter(m.d||'')));
  const myCK=ckM.filter(m=>((m.teamAMembers||[]).some(x=>x.univ===histUniv)||(m.teamBMembers||[]).some(x=>x.univ===histUniv))&&(!passDateFilter||passDateFilter(m.d||'')));
  const myComp=comps.filter(m=>(((m.a||m.u)===histUniv)||m.b===histUniv)&&(!passDateFilter||passDateFilter(m.d||'')));
  // ì¡°ë³„ëŒ€íšŒ(tourneys) ê²½ê¸° ì¶”ê°€
  const myTourney=(typeof getTourneyMatches==='function'?getTourneyMatches():[])
    .filter(m=>(m.a===histUniv||m.b===histUniv)&&(!passDateFilter||passDateFilter(m.d||'')));
  function calcStats(arr,getA,getB){let w=0,l=0,d=0;arr.forEach(m=>{const a=getA(m),b=getB(m);const iA=(a===histUniv),iB=(b===histUniv);if(iA){if(m.sa>m.sb)w++;else if(m.sb>m.sa)l++;else d++;}else if(iB){if(m.sb>m.sa)w++;else if(m.sa>m.sb)l++;else d++;}});return{w,l,d,total:w+l+d};}
  const sm=calcStats(myMini,m=>m.a,m=>m.b);
  const su=calcStats(myUnivM,m=>m.a,m=>m.b);
  const sc=calcStats(myComp,m=>m.a||m.u,m=>m.b);
  const st=calcStats(myTourney,m=>m.a,m=>m.b);
  let ckW=0,ckL=0;
  myCK.forEach(m=>{if(m.univWins&&m.univWins[histUniv])ckW+=m.univWins[histUniv];if(m.univLosses&&m.univLosses[histUniv])ckL+=m.univLosses[histUniv];});

  // ìƒëŒ€ ëŒ€í•™ ìŠ¹/íŒ¨ ì§‘ê³„
  const oppStats={};
  function addOpp(myU,oppU,myWin){
    if(myU!==histUniv||oppU===histUniv)return;
    if(!oppStats[oppU])oppStats[oppU]={w:0,l:0};
    if(myWin)oppStats[oppU].w++;else oppStats[oppU].l++;
  }
  myMini.forEach(m=>{addOpp(m.a,m.b,m.sa>m.sb);addOpp(m.b,m.a,m.sb>m.sa);});
  myUnivM.forEach(m=>{addOpp(m.a,m.b,m.sa>m.sb);addOpp(m.b,m.a,m.sb>m.sa);});
  myComp.forEach(m=>{const a=m.a||m.u||'';addOpp(a,m.b,m.sa>m.sb);addOpp(m.b,a,m.sb>m.sa);});
  myTourney.forEach(m=>{addOpp(m.a,m.b,m.sa>m.sb);addOpp(m.b,m.a,m.sb>m.sa);});

  h+=`<div style="background:${col}0d;border:2px solid ${col}44;border-radius:12px;padding:16px 20px;margin-bottom:20px;">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
      <span class="ubadge clickable-univ" style="background:${col};font-size:14px;padding:5px 16px" onclick="openUnivModal('${histUniv}')">${histUniv}</span>
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px;color:${col}">ëŒ€ì „ í†µí•© ì„±ì </span>
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      ${statCard('âš¡ ë¯¸ë‹ˆëŒ€ì „',sm.w,sm.l,sm.d,col)}
      ${statCard('ğŸŸï¸ ëŒ€í•™ëŒ€ì „',su.w,su.l,su.d,col)}
      ${statCard('ğŸ–ï¸ ëŒ€íšŒ',sc.w,sc.l,sc.d,col)}
      ${st.total>0?statCard('ğŸ† ì¡°ë³„ëŒ€íšŒ',st.w,st.l,st.d,col):''}
      ${statCard('ğŸ¤ ëŒ€í•™CK (ê²Œì„)',ckW,ckL,0,col)}
    </div>
  </div>`;

  // ìƒëŒ€ ëŒ€í•™ë³„ ì „ì í‘œ
  const oppList=Object.entries(oppStats).filter(([,s])=>s.w+s.l>0).sort((a,b)=>(b[1].w+b[1].l)-(a[1].w+a[1].l));
  if(oppList.length){
    h+=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:#7c3aed;margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid #ede9fe">ğŸ†š ìƒëŒ€ ëŒ€í•™ ëŒ€ì „ ì „ì </div>`;
    h+=`<table style="margin-bottom:20px"><thead><tr><th>ìƒëŒ€ ëŒ€í•™</th><th>ìŠ¹</th><th>íŒ¨</th><th>ìŠ¹ë¥ </th></tr></thead><tbody>`;
    oppList.forEach(([opp,s])=>{
      const ot=s.w+s.l;const ow=ot?Math.round(s.w/ot*100):0;const oc=gc(opp);
      h+=`<tr><td><span class="ubadge clickable-univ" style="background:${oc}" onclick="openUnivModal('${opp}')">${opp}</span></td>
        <td class="wt" style="font-weight:800;font-size:14px">${s.w}</td>
        <td class="lt" style="font-weight:800;font-size:14px">${s.l}</td>
        <td style="font-weight:700;color:${ow>=50?'var(--green)':'var(--red)'}">${ot?ow+'%':'-'}</td></tr>`;
    });
    h+=`</tbody></table>`;
  }

  if(myMini.length){h+=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:var(--blue);margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--blue-ll)">âš¡ ë¯¸ë‹ˆëŒ€ì „ ê¸°ë¡</div>`;h+=recSummaryListHTMLFiltered(myMini,'mini','ustat-mini',histUniv);}
  if(myUnivM.length){h+=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:#7c3aed;margin:16px 0 10px;padding-bottom:6px;border-bottom:2px solid #ede9fe">ğŸŸï¸ ëŒ€í•™ëŒ€ì „ ê¸°ë¡</div>`;h+=recSummaryListHTMLFiltered(myUnivM,'univm','ustat-univm',histUniv);}
  if(myCK.length){h+=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:#dc2626;margin:16px 0 10px;padding-bottom:6px;border-bottom:2px solid #fee2e2">ğŸ¤ ëŒ€í•™CK ê¸°ë¡</div>`;h+=recSummaryListHTMLFiltered(myCK,'ck','ustat-ck',histUniv);}
  if(myComp.length){
    h+=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:var(--gold);margin:16px 0 10px;padding-bottom:6px;border-bottom:2px solid var(--gold-b)">ğŸ–ï¸ ëŒ€íšŒ ê¸°ë¡</div>`;
    myComp.forEach(m=>{
      const rIdx=comps.indexOf(m);const a=m.a||m.hostUniv||m.u||'';const b=m.b||'';
      const ca=gc(a);const cb=gc(b);const aWin=m.sa>m.sb;const bWin=m.sb>m.sa;
      const isA=(a===histUniv),isB=(b===histUniv);const myWin=(isA&&aWin)||(isB&&bWin);
      const key=`ustat-comp-${rIdx}`;
      h+=`<div class="rec-summary">
        <div class="rec-sum-header">
          <span style="color:var(--gray-l);font-size:11px;min-width:72px">${m.d||''}</span>
          <span style="font-weight:700;font-size:13px">ğŸ–ï¸ ${m.n||'ëŒ€íšŒ'}</span>
          <div class="rec-sum-vs">
            ${a?`<span class="ubadge${aWin?'':' loser'} clickable-univ" style="background:${ca}" onclick="openUnivModal('${a}')">${a}</span>`:''}
            ${(a&&b)?`<div class="rec-sum-score score-click" onclick="toggleDetail('${key}')"><span class="${aWin?'wt':bWin?'lt':'pt-z'}">${m.sa||0}</span><span style="color:var(--gray-l);font-size:14px">:</span><span class="${bWin?'wt':aWin?'lt':'pt-z'}">${m.sb||0}</span></div>`:''}
            ${b?`<span class="ubadge${bWin?'':' loser'} clickable-univ" style="background:${cb}" onclick="openUnivModal('${b}')">${b}</span>`:''}
            <span style="font-size:12px;font-weight:700;color:${myWin?col:'#888'}">${myWin?'â–¶ '+histUniv+' ìŠ¹':aWin?'â–¶ '+a+' ìŠ¹':bWin?'â–¶ '+b+' ìŠ¹':'ë¬´ìŠ¹ë¶€'}</span>
          </div>
          <div style="margin-left:auto" class="no-export"><button id="detbtn-${key}" class="btn-detail" onclick="toggleDetail('${key}')">â–¼ ìƒì„¸ ì—´ê¸°</button></div>
        </div>
        <div id="det-${key}" class="rec-detail-area">
          ${buildDetailHTML(m,'comp',a,b,ca,cb,aWin,bWin)}
          <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
            <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
              <button class="btn-capture btn-xs no-export" onclick="captureDetail('det-${key}','ëŒ€íšŒ_${m.d||'match'}')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
              <button class="btn btn-p btn-xs no-export" onclick="_shareMode='match';window._shareMatchObj={a:'${a.replace(/'/g,"\\'")}',b:'${b.replace(/'/g,"\\'")}',sa:${m.sa||0},sb:${m.sb||0},d:'${(m.d||'').replace(/'/g,"\\'")}',n:'${(m.n||'ëŒ€íšŒ').replace(/'/g,"\\'")}',sets:[]};openShareCardModal();setTimeout(()=>renderShareCardByMatchObj(window._shareMatchObj),80)">ğŸ´ ê³µìœ  ì¹´ë“œ</button>
            </div>
          </div>
        </div>
      </div>`;
    });
  }
  if(!myMini.length&&!myUnivM.length&&!myCK.length&&!myComp.length&&!myTourney.length)h+=`<div style="padding:40px;text-align:center;color:var(--gray-l)">ì´ ëŒ€í•™ì˜ ëŒ€ì „ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  // ì¡°ë³„ëŒ€íšŒ ê¸°ë¡
  if(myTourney.length){
    h+=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:#0891b2;margin:16px 0 10px;padding-bottom:6px;border-bottom:2px solid #cffafe">ğŸ† ì¡°ë³„ëŒ€íšŒ ê¸°ë¡</div>`;
    myTourney.forEach(m=>{
      const a=m.a||'';const b=m.b||'';
      const ca=gc(a);const cb=gc(b);const aWin=m.sa>m.sb;const bWin=m.sb>m.sa;
      const isA=(a===histUniv),isB=(b===histUniv);const myWin=(isA&&aWin)||(isB&&bWin);
      const key=`ustat-tour-${m._tnId||''}-${m._gi||0}-${m._mi||0}`;
      h+=`<div class="rec-summary">
        <div class="rec-sum-header">
          <span style="color:var(--gray-l);font-size:11px;min-width:72px">${m.d||''}</span>
          <span style="font-weight:700;font-size:13px">ğŸ† ${m.n||'ì¡°ë³„ëŒ€íšŒ'} ${m.grpName?'GROUP '+m.grpLetter:''}</span>
          <div class="rec-sum-vs">
            ${a?`<span class="ubadge${aWin?'':' loser'} clickable-univ" style="background:${ca}" onclick="openUnivModal('${a}')">${a}</span>`:''}
            <div class="rec-sum-score"><span class="${aWin?'wt':bWin?'lt':'pt-z'}">${m.sa||0}</span><span style="color:var(--gray-l);font-size:14px">:</span><span class="${bWin?'wt':aWin?'lt':'pt-z'}">${m.sb||0}</span></div>
            ${b?`<span class="ubadge${bWin?'':' loser'} clickable-univ" style="background:${cb}" onclick="openUnivModal('${b}')">${b}</span>`:''}
            <span style="font-size:12px;font-weight:700;color:${myWin?col:'#888'}">${myWin?'â–¶ '+histUniv+' ìŠ¹':aWin?'â–¶ '+a+' ìŠ¹':bWin?'â–¶ '+b+' ìŠ¹':'ë¬´ìŠ¹ë¶€'}</span>
          </div>
        </div>
      </div>`;
    });
  }
  return h;
}

function statCard(label,w,l,d,col){
  const tot=w+l+d;const wr=tot?Math.round(w/tot*100):0;
  return `<div style="background:var(--white);border:1px solid ${col}33;border-radius:10px;padding:12px 16px;min-width:120px;text-align:center;flex:1">
    <div style="font-size:11px;font-weight:700;color:var(--text3);margin-bottom:8px">${label}</div>
    <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px"><span class="wt">${w}ìŠ¹</span> <span class="lt">${l}íŒ¨</span>${d?` <span style="color:var(--gray-l)">${d}ë¬´</span>`:''}</div>
    <div style="font-size:12px;font-weight:700;color:${wr>=50?'var(--green)':'var(--red)'};margin-top:4px">${tot?wr+'%':'-'}</div>
  </div>`;
}

function recSummaryListHTMLFiltered(arr,mode,ctxPrefix,filterUniv){
  if(!arr.length)return`<div style="padding:20px;text-align:center;color:var(--gray-l);">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  const isCKmode=(mode==='ck'||mode==='pro'||mode==='tt');
  let h='';
  arr.forEach(m=>{
    if(isCKmode){if(!m.teamAMembers||!m.teamBMembers) return;}
    else{if(!m.a||!m.b) return;}
    if(m.sa==null||m.sa===''||m.sb==null||m.sb==='') return;
    if(isNaN(Number(m.sa))||isNaN(Number(m.sb))) return;
    if(typeof passDateFilter==='function' && !passDateFilter(m.d||''))return;
    const srcArr=mode==='mini'?miniM:mode==='univm'?univM:mode==='pro'?proM:mode==='tt'?ttM:ckM;
    const i=srcArr.indexOf(m);
    const isCK=isCKmode;
    const ca=isCK?'#2563eb':gc(m.a);const cb=isCK?'#dc2626':gc(m.b);
    const rawLA2=(m.teamALabel||'').replace(/^\$\{.*\}$/,'');
    const rawLB2=(m.teamBLabel||'').replace(/^\$\{.*\}$/,'');
    const labelA=isCK?(rawLA2||'AíŒ€'):m.a;const labelB=isCK?(rawLB2||'BíŒ€'):m.b;
    const aWin=(m.sa>m.sb),bWin=(m.sb>m.sa);
    const col=gc(filterUniv);
    const isA=(!isCK&&m.a===filterUniv)||(isCK&&(m.teamAMembers||[]).some(x=>x.univ===filterUniv));
    const isB=(!isCK&&m.b===filterUniv)||(isCK&&(m.teamBMembers||[]).some(x=>x.univ===filterUniv));
    const myWin=(isA&&aWin)||(isB&&bWin);
    const key=`${ctxPrefix}-${mode}-${i}`;
    h+=`<div class="rec-summary">
      <div class="rec-sum-header">
        <span style="color:var(--gray-l);font-size:11px;min-width:72px">${m.d||''}</span>
        ${m.t?`<span style="font-weight:700;font-size:12px;color:var(--text3)">${m.t}</span>`:''}
        ${(m.n&&mode!=='comp')?`<span style="font-weight:700;font-size:12px;color:var(--text3)">${m.n}</span>`:''}
        <div class="rec-sum-vs">
          <span class="ubadge${aWin?'':' loser'} clickable-univ" data-icon-done="1" style="background:${ca};display:inline-flex;align-items:center;gap:4px" onclick="openUnivModal('${isCK?'':m.a}')">${(()=>{const n=isCK?'':m.a;const url=UNIV_ICONS[n]||(univCfg.find(x=>x.name===n)||{}).icon||'';return url?`<img src="${url}" style="width:18px;height:18px;object-fit:contain;border-radius:3px;flex-shrink:0" onerror="this.style.display='none'">`:''})()}${labelA}</span>
          <div class="rec-sum-score score-click" onclick="toggleDetail('${key}')"><span class="${aWin?'wt':bWin?'lt':'pt-z'}">${m.sa}</span><span style="color:var(--gray-l);font-size:14px">:</span><span class="${bWin?'wt':aWin?'lt':'pt-z'}">${m.sb}</span></div>
          <span class="ubadge${bWin?'':' loser'} clickable-univ" data-icon-done="1" style="background:${cb};display:inline-flex;align-items:center;gap:4px" onclick="openUnivModal('${isCK?'':m.b}')">${(()=>{const n=isCK?'':m.b;const url=UNIV_ICONS[n]||(univCfg.find(x=>x.name===n)||{}).icon||'';return url?`<img src="${url}" style="width:18px;height:18px;object-fit:contain;border-radius:3px;flex-shrink:0" onerror="this.style.display='none'">`:''})()}${labelB}</span>
          <span style="font-size:12px;font-weight:700;color:${myWin?col:'#888'}">${myWin?'â–¶ '+filterUniv+' ìŠ¹':aWin?'â–¶ '+labelA+' ìŠ¹':bWin?'â–¶ '+labelB+' ìŠ¹':'ë¬´ìŠ¹ë¶€'}</span>
        </div>
        <div style="margin-left:auto;display:flex;gap:5px;align-items:center" class="no-export">
          <button id="detbtn-${key}" class="btn-detail" onclick="toggleDetail('${key}')">â–¼ ìƒì„¸</button>
          ${(mode==='tt'||mode==='mini'||mode==='univm'||mode==='comp')?adminBtn(`<button class="btn btn-o btn-xs" onclick="openRE('${mode}',${i})">ìˆ˜ì •</button>`):''}
          ${adminBtn(`<button class="btn btn-r btn-xs" onclick="delRec('${mode}',${i})">ì‚­ì œ</button>`)}
        </div>
      </div>
      <div id="det-${key}" class="rec-detail-area">
        ${buildDetailHTML({...m,_editRef:`${mode}:${i}`},mode,labelA,labelB,ca,cb,aWin,bWin)}
        <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
          <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
            <button class="btn-capture btn-xs no-export" onclick="captureDetail('det-${key}','${m.d||'match'}')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
            <button class="btn btn-p btn-xs no-export" onclick="openShareCardFromMatch('${mode}',${i})">ğŸ´ ê³µìœ  ì¹´ë“œ</button>
          </div>
        </div>
      </div>
    </div>`;
  });
  return h;
}

function recSummaryListHTML(arr, mode, context){
  const isCKmode=(mode==='ck'||mode==='pro'||mode==='tt');
  if(!window._recQ)window._recQ={};
  if(!arr.length){
    const hasQ=!!(window._recQ&&window._recQ[mode]);
    const initQ=(window._recQ&&window._recQ[mode])||'';
    const emptyBar=`<div class="sort-bar no-export" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
    <span style="font-size:11px;color:var(--text3)">ë‚ ì§œ</span>
    <button class="sort-btn ${recSortDir==='desc'?'on':''}" onclick="recSortDir='desc';render()">ìµœì‹ ìˆœ â†“</button>
    <button class="sort-btn ${recSortDir==='asc'?'on':''}" onclick="recSortDir='asc';render()">ì˜¤ë˜ëœìˆœ â†‘</button>
    <div style="margin-left:auto;display:flex;align-items:center;gap:4px">
      <input type="text" id="rq-${mode}" placeholder="ğŸ” ì„ ìˆ˜/ëŒ€í•™ ê²€ìƒ‰..." value="${initQ}"
        oninput="recFilterInPlace('${mode}',this.value)"
        style="padding:4px 10px;border:1px solid var(--border2);border-radius:6px;font-size:12px;width:140px">
      <button id="rq-clear-${mode}" onclick="recClearSearch('${mode}')" style="display:${initQ?'inline-block':'none'};background:none;border:none;cursor:pointer;color:var(--gray-l);font-size:16px;line-height:1;padding:0 2px" title="ê²€ìƒ‰ ì´ˆê¸°í™”">âœ•</button>
    </div>
  </div>`;
    return emptyBar+`<div style="padding:40px;text-align:center;color:var(--gray-l);">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }
  // ë‚ ì§œ í•„í„°ë§Œ ì ìš© (ê²€ìƒ‰ì–´ í•„í„°ëŠ” DOMì—ì„œ ì‹¤ì‹œê°„ ì²˜ë¦¬)
  let filtered=arr.map((m,i)=>({m,i})).filter(({m})=>{
    if(isCKmode){
      if(!m.teamAMembers||!m.teamBMembers) return false;
    } else {
      if(!m.a||!m.b) return false;
    }
    if(m.sa==null||m.sa===''||m.sb==null||m.sb==='') return false;
    if(isNaN(Number(m.sa))||isNaN(Number(m.sb))) return false;
    if(typeof passDateFilter==='function'&&!passDateFilter(m.d||'')) return false;
    return true;
  });
  filtered.sort((a,b)=>recSortDir==='asc'?(a.m.d||'').localeCompare(b.m.d||''):(b.m.d||'').localeCompare(a.m.d||''));

  // â”€â”€ ê²€ìƒ‰ë°” + ì „ì²´ ë Œë”ë§ (DOM ì‹¤ì‹œê°„ í•„í„°ë§) â”€â”€
  const totalItems=filtered.length;
  const initQ2=(window._recQ&&window._recQ[mode])||'';
  const sortBar=`<div class="sort-bar no-export" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
    <span style="font-size:11px;color:var(--text3)">ë‚ ì§œ</span>
    <button class="sort-btn ${recSortDir==='desc'?'on':''}" onclick="recSortDir='desc';render()">ìµœì‹ ìˆœ â†“</button>
    <button class="sort-btn ${recSortDir==='asc'?'on':''}" onclick="recSortDir='asc';render()">ì˜¤ë˜ëœìˆœ â†‘</button>
    <span id="rq-count-${mode}" style="font-size:11px;color:var(--gray-l);margin-left:4px">${totalItems}ê±´</span>
    <div style="margin-left:auto;display:flex;align-items:center;gap:4px">
      <input type="text" id="rq-${mode}" placeholder="ğŸ” ì„ ìˆ˜/ëŒ€í•™ ê²€ìƒ‰..." value="${initQ2}"
        oninput="recFilterInPlace('${mode}',this.value)"
        style="padding:4px 10px;border:1px solid var(--border2);border-radius:6px;font-size:12px;width:140px">
      <button id="rq-clear-${mode}" onclick="recClearSearch('${mode}')" style="display:${initQ2?'inline-block':'none'};background:none;border:none;cursor:pointer;color:var(--gray-l);font-size:16px;line-height:1;padding:0 2px" title="ê²€ìƒ‰ ì´ˆê¸°í™”">âœ•</button>
    </div>
  </div>
  <div id="rq-empty-${mode}" style="display:none;padding:24px;text-align:center;color:var(--gray-l)">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. <button onclick="recClearSearch('${mode}')" style="margin-left:6px;padding:2px 10px;border-radius:6px;border:1px solid var(--border2);background:var(--white);color:var(--text3);font-size:12px;cursor:pointer">ì´ˆê¸°í™”</button></div>`;

  if(!totalItems){
    return sortBar+`<div style="padding:40px;text-align:center;color:var(--gray-l);">í•´ë‹¹ ê¸°ê°„ì— ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }

  // filtered ì „ì²´(í˜ì´ì§€ ê´€ê³„ì—†ì´) data-hayë¡œ ë Œë”ë§ í›„ DOM í•„í„°ë§
  // â†’ í˜ì´ì§€ë„¤ì´ì…˜ ëŒ€ì‹  ì „ì²´ ë Œë”ë§ + CSS display:none ë°©ì‹
  let h=sortBar+`<div id="rec-list-${mode}">`;
  filtered.forEach(({m,i})=>{
    const isCK=(mode==='ck'||mode==='pro'||mode==='tt');
    const ca=isCK?'#2563eb':gc(m.a);
    const cb=isCK?'#dc2626':gc(m.b);
    // teamALabel/B í•„ë“œ ì •ë¦¬: ì˜ëª»ëœ ê°’({...} í¬í•¨) í•„í„°ë§
    const rawLA=(m.teamALabel||'').replace(/^\$\{.*\}$/,'');
    const rawLB=(m.teamBLabel||'').replace(/^\$\{.*\}$/,'');
    const labelA=isCK?(rawLA||'AíŒ€'):m.a;
    const labelB=isCK?(rawLB||'BíŒ€'):m.b;
    const aWin=(m.sa>m.sb);const bWin=(m.sb>m.sa);
    const key=`${context}-${mode}-${i}`;
    // ê²€ìƒ‰ìš© hay ë°ì´í„°
    const hayData=[m.a||'',m.b||'',m.n||'',m.d||'',labelA,labelB,
      (m.sets||[]).flatMap(s=>(s.games||[]).flatMap(g=>[g.playerA||'',g.playerB||''])).join(' '),
      (m.teamAMembers||[]).map(x=>x.name||'').join(' '),
      (m.teamBMembers||[]).map(x=>x.name||'').join(' ')
    ].join(' ').toLowerCase().replace(/"/g,'&quot;');
    // ëŒ€í•™ ì•„ì´ì½˜ (ëŒ€í•™ë¼ë¦¬ ê²½ê¸°: mini/univm/comp/tour ëŠ” ìƒëŒ€ ëŒ€í•™ ì•„ì´ì½˜, CK/pro/ttëŠ” ì†Œì† ëŒ€í•™ ì•„ì´ì½˜)
    const iconA=(()=>{const n=isCK?'':m.a;const u=univCfg.find(x=>x.name===n)||{};const url=UNIV_ICONS[n]||u.icon||'';return url?`<img src="${url}" style="width:18px;height:18px;object-fit:contain;border-radius:3px;flex-shrink:0;vertical-align:middle" onerror="this.style.display='none'">`:''})();
    const iconB=(()=>{const n=isCK?'':m.b;const u=univCfg.find(x=>x.name===n)||{};const url=UNIV_ICONS[n]||u.icon||'';return url?`<img src="${url}" style="width:18px;height:18px;object-fit:contain;border-radius:3px;flex-shrink:0;vertical-align:middle" onerror="this.style.display='none'">`:''})();
    h+=`<div class="rec-summary" data-hay="${hayData}">
      <div class="rec-sum-header">
        <span style="color:var(--gray-l);font-size:11px;min-width:72px">${m.d||''}</span>
        <div class="rec-sum-vs">
          <span class="ubadge${aWin?'':' loser'} clickable-univ" data-icon-done="1" style="background:${ca};display:inline-flex;align-items:center;gap:4px" onclick="${!isCK?`openUnivModal('${m.a||''}')`:''}">${iconA}${labelA}</span>
          <div class="rec-sum-score score-click" onclick="toggleDetail('${key}')" title="í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°/ë‹«ê¸°">
            <span class="${aWin?'wt':bWin?'lt':'pt-z'}">${m.sa}</span>
            <span style="color:var(--gray-l);font-size:14px">:</span>
            <span class="${bWin?'wt':aWin?'lt':'pt-z'}">${m.sb}</span>
          </div>
          <span class="ubadge${bWin?'':' loser'} clickable-univ" data-icon-done="1" style="background:${cb};display:inline-flex;align-items:center;gap:4px" onclick="${!isCK?`openUnivModal('${m.b||''}')`:''}">${iconB}${labelB}</span>
          <span style="font-size:12px;color:${aWin?ca:bWin?cb:'#888'};font-weight:600">
            ${aWin?'â–¶ '+labelA+' ìŠ¹':bWin?'â–¶ '+labelB+' ìŠ¹':'ë¬´ìŠ¹ë¶€'}
          </span>
        </div>
        <div style="margin-left:auto;display:flex;align-items:center;gap:4px;flex-shrink:0">
          <button class="btn btn-w btn-xs" onclick="copyMatchResult('${(m.a||'').replace(/'/g,"\\'")}',${m.sa||0},'${(m.b||'').replace(/'/g,"\\'")}',${m.sb||0},'${m.d||''}','${mode}',${i})" title="ê²°ê³¼ ë³µì‚¬" style="padding:3px 8px;font-size:14px">ğŸ“‹</button>
          <div style="display:flex;gap:4px;align-items:center" class="no-export">
            <button id="detbtn-${key}" class="btn-detail" onclick="toggleDetail('${key}')">â–¼ ìƒì„¸</button>
            ${(mode!=='ck'&&mode!=='pro')||mode==='tt'?adminBtn(`<button class="btn btn-o btn-xs" onclick="openRE('${mode}',${i})">ìˆ˜ì •</button>`):''}
            ${adminBtn(`<button class="btn btn-r btn-xs" onclick="delRec('${mode}',${i})">ì‚­ì œ</button>`)}
          </div>
        </div>
      </div>
      <div id="det-${key}" class="rec-detail-area">
        ${buildDetailHTML({...m,_editRef:`${mode}:${i}`}, mode, labelA, labelB, ca, cb, aWin, bWin)}
        <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
          ${m.memo?`<div style="font-size:12px;color:var(--text2);background:#fffbeb;border:1px solid var(--gold-b);border-radius:6px;padding:6px 10px;margin-bottom:6px">ğŸ“ ${m.memo}</div>`:''}
          <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
            <button class="btn-capture btn-xs no-export" onclick="captureDetail('det-${key}','${m.d||'match'}')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
            <button class="btn btn-p btn-xs no-export" onclick="openShareCardFromMatch('${mode}',${i})">ğŸ´ ê³µìœ  ì¹´ë“œ</button>
            ${isLoggedIn?`<input type="text" id="memo-${key}" placeholder="ê²½ê¸° ë©”ëª¨ ì…ë ¥..." value="${m.memo||''}" style="flex:1;font-size:12px">
            <button class="btn btn-w btn-xs" onclick="saveMemo('${mode}',${i},'memo-${key}')">ğŸ’¾ ë©”ëª¨</button>
            ${m.memo?`<button class="btn btn-r btn-xs" onclick="saveMemo('${mode}',${i},null)">ì‚­ì œ</button>`:''}`:''}
          </div>
        </div>
      </div>
    </div>`;
  });

  // â”€â”€ í˜ì´ì§€ ì»¨íŠ¸ë¡¤ â”€â”€
  if(totalItems>getHistPageSize()){
    const pages=totalPages;
    let pager=`<div class="no-export" style="display:flex;align-items:center;justify-content:center;gap:6px;padding:16px 0;flex-wrap:wrap">`;
    pager+=`<button class="btn btn-w btn-xs" style="min-width:32px" onclick="histPage['${pageKey}']=0;render()" ${curPage===0?'disabled':''}>Â«</button>`;
    pager+=`<button class="btn btn-w btn-xs" style="min-width:32px" onclick="histPage['${pageKey}']=Math.max(0,${curPage}-1);render()" ${curPage===0?'disabled':''}>â€¹</button>`;
    // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ (ìµœëŒ€ 7ê°œ)
    let startP=Math.max(0,curPage-3);let endP=Math.min(pages-1,startP+6);
    if(endP-startP<6)startP=Math.max(0,endP-6);
    for(let p=startP;p<=endP;p++){
      pager+=`<button class="btn ${p===curPage?'btn-b':'btn-w'} btn-xs" style="min-width:32px" onclick="histPage['${pageKey}']=${p};render()">${p+1}</button>`;
    }
    pager+=`<button class="btn btn-w btn-xs" style="min-width:32px" onclick="histPage['${pageKey}']=Math.min(${pages-1},${curPage}+1);render()" ${curPage===pages-1?'disabled':''}>â€º</button>`;
    pager+=`<button class="btn btn-w btn-xs" style="min-width:32px" onclick="histPage['${pageKey}']=${pages-1};render()" ${curPage===pages-1?'disabled':''}>Â»</button>`;
    pager+=`<span style="font-size:11px;color:var(--text3);margin-left:6px">${curPage+1} / ${pages}</span>`;
    pager+=`</div>`;
    h+=pager;
  }

  return h||`<div style="padding:40px;text-align:center;color:var(--gray-l);">í•´ë‹¹ ê¸°ê°„ì— ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
}

function buildDetailHTML(m, mode, labelA, labelB, ca, cb, aWin, bWin){
  if(!m.sets||!m.sets.length) return `<div style="font-size:12px;color:var(--gray-l);padding:8px 0">ì„¸íŠ¸ ìƒì„¸ ê¸°ë¡ ì—†ìŒ</div>`;
  let h='';
  m.sets.forEach((set,si)=>{
    const isAce=(si===2);
    const sLabel=isAce?'ğŸ¯ ì—ì´ìŠ¤ì „':`${si+1}ì„¸íŠ¸`;
    const swA=set.scoreA||0, swB=set.scoreB||0;
    const setAWin=swA>swB, setBWin=swB>swA;
    h+=`<div class="set-row">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:7px 12px;background:${isAce?'#f5f3ff':'var(--blue-l)'};border-radius:7px;border:1px solid ${isAce?'#ddd6fe':'var(--blue-ll)'}">
        <span class="set-row-title ${isAce?'ace-t':''}" style="margin-bottom:0">${sLabel}</span>
        <span class="ubadge${setAWin?'':' loser'}" style="background:${ca};font-size:10px">${labelA}</span>
        <span style="font-weight:800;font-size:15px">
          <span class="${setAWin?'wt':setBWin?'lt':'pt-z'}">${swA}</span>
          <span style="color:var(--border2)"> : </span>
          <span class="${setBWin?'wt':setAWin?'lt':'pt-z'}">${swB}</span>
        </span>
        <span class="ubadge${setBWin?'':' loser'}" style="background:${cb};font-size:10px">${labelB}</span>
        ${setAWin?`<span style="font-size:11px;font-weight:800;color:${ca};margin-left:4px">â–¶ ${labelA} ì„¸íŠ¸ ìŠ¹</span>`:setBWin?`<span style="font-size:11px;font-weight:800;color:${cb};margin-left:4px">â–¶ ${labelB} ì„¸íŠ¸ ìŠ¹</span>`:'<span style="font-size:11px;color:var(--gray-l)">ë¬´ìŠ¹ë¶€</span>'}
      </div>`;
    if(set.games&&set.games.length){
      set.games.forEach((g,gi)=>{
        if(!g.playerA&&!g.playerB)return;
        const pA=players.find(p=>p.name===g.playerA);
        const pB=players.find(p=>p.name===g.playerB);
        const aIsWinner=(g.winner==='A');
        const bIsWinner=(g.winner==='B');
        const hasWinner=!!(g.winner);
        const mapStr=g.map?`<span style="background:var(--surface);border:1px solid var(--border);padding:2px 8px;border-radius:4px;font-size:10px;color:var(--text3)">ğŸ“ ${g.map}</span>`:'';
        const winBgA=ca+'22';const winBgB=cb+'22';
        const winBorderA=ca+'66';const winBorderB=cb+'66';
        const styleA=hasWinner?(aIsWinner?`display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;background:${winBgA};border:2px solid ${winBorderA};`:`display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;background:#f1f5f9;border:1px solid #cbd5e1;opacity:0.45;filter:grayscale(1);`):`display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;background:var(--surface);border:1px solid var(--border);`;
        const styleB=hasWinner?(bIsWinner?`display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;background:${winBgB};border:2px solid ${winBorderB};`:`display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;background:#f1f5f9;border:1px solid #cbd5e1;opacity:0.45;filter:grayscale(1);`):`display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;background:var(--surface);border:1px solid var(--border);`;
        const winTagA=aIsWinner&&hasWinner?`<span style="background:${ca};color:#fff;font-size:10px;font-weight:800;padding:2px 7px;border-radius:4px;letter-spacing:.5px">WIN</span>`:'';
        const winTagB=bIsWinner&&hasWinner?`<span style="background:${cb};color:#fff;font-size:10px;font-weight:800;padding:2px 7px;border-radius:4px;letter-spacing:.5px">WIN</span>`:'';
        const clickA=g.playerA?`onclick="openPlayerModal('${g.playerA}')" style="cursor:pointer;text-decoration:underline dotted;"`:'';
        const clickB=g.playerB?`onclick="openPlayerModal('${g.playerB}')" style="cursor:pointer;text-decoration:underline dotted;"`:'';
        h+=`<div style="display:flex;align-items:center;gap:6px;padding:4px 4px;flex-wrap:wrap;">
          <span style="color:var(--gray-l);font-size:10px;min-width:42px;font-weight:600">ê²½ê¸°${gi+1}</span>
          <div style="${styleA}">
            ${pA?getPlayerPhotoHTML(pA.name,'22px','margin-right:2px'):''}
            ${pA?`<span class="rbadge r${pA.race}" style="font-size:10px">${pA.race}</span>`:''}
            <strong style="font-size:12px;color:var(--text)" ${clickA}>${g.playerA||'?'}</strong>
            ${pA?genderIcon(pA.gender):''}
            <span style="font-size:10px;color:${ca};font-weight:700">(${labelA})</span>
            ${winTagA}
          </div>
          <span style="color:var(--gray-l);font-size:11px;font-weight:600">vs</span>
          <div style="${styleB}">
            ${pB?getPlayerPhotoHTML(pB.name,'22px','margin-right:2px'):''}
            ${pB?`<span class="rbadge r${pB.race}" style="font-size:10px">${pB.race}</span>`:''}
            <strong style="font-size:12px;color:var(--text)" ${clickB}>${g.playerB||'?'}</strong>
            ${pB?genderIcon(pB.gender):''}
            <span style="font-size:10px;color:${cb};font-weight:700">(${labelB})</span>
            ${winTagB}
          </div>
          ${mapStr}
          ${isLoggedIn&&m._editRef?`<button class="btn btn-o btn-xs no-export" style="margin-left:4px" onclick="openGameEditModal('${m._editRef}',${si},${gi})">âœï¸ ìˆ˜ì •</button>`:''}
        </div>`;
      });
    } else {
      h+=`<div style="font-size:11px;color:var(--gray-l);padding:4px 0">ìƒì„¸ ê²½ê¸° ê¸°ë¡ ì—†ìŒ</div>`;
    }
    h+=`</div>`;
  });
  h+=`</div>`; // rec-list-${mode} ë‹«ê¸°
  // ë Œë” ì§í›„ ê²€ìƒ‰ì–´ ìˆìœ¼ë©´ ë°”ë¡œ í•„í„° ì ìš© (íƒ€ì´ë° ë¬¸ì œ ë°©ì§€)
  if(typeof requestAnimationFrame!=='undefined'){
    const _mode=mode, _q=(window._recQ&&window._recQ[_mode])||'';
    if(_q) requestAnimationFrame(()=>recFilterInPlace(_mode,_q));
  }
  return h;
}

// tourneysì—ì„œ ì™„ë£Œëœ ëª¨ë“  ê²½ê¸°ë¥¼ flatí•˜ê²Œ ì¶”ì¶œ
function getTourneyMatches(){
  const result=[];
  if(!Array.isArray(tourneys))return result;
  (tourneys||[]).forEach(tn=>{
    (tn.groups||[]).forEach((grp,gi)=>{
      const gl='ABCDEFGHIJ'[gi]||String(gi);
      const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
      (grp.matches||[]).forEach((m,mi)=>{
        if(!m.a||!m.b)return;
        if(m.sa==null||m.sb==null)return;
        result.push({
          _src:'tour',_tnId:tn.id,_gi:gi,_mi:mi,
          d:m.d||'',n:tn.name,a:m.a,b:m.b,
          sa:m.sa,sb:m.sb,sets:m.sets||[],
          grpName:grp.name,grpLetter:gl,grpColor:col
        });
      });
    });
  });
  return result;
}
function compSummaryListHTML(context){
  // tourneys ê²½ê¸° + comps ë°°ì—´ ëª¨ë‘ í•©ì‚°
  const tourItems=getTourneyMatches();
  const compItems=[...comps].map((m,origIdx)=>({...m,_src:'comps',_origIdx:origIdx}));
  const allItems=[...tourItems,...compItems];
  if(!allItems.length)return`<div style="padding:40px;text-align:center;color:var(--gray-l);">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  // ë‚ ì§œ í•„í„° ì ìš© í›„ ì •ë ¬
  const filtered=allItems.filter(m=>
    typeof passDateFilter!=='function'||passDateFilter(m.d||'')
  );
  filtered.sort((a,b)=>recSortDir==='asc'
    ?(a.d||'').localeCompare(b.d||'')
    :(b.d||'').localeCompare(a.d||''));
  const sortBar=`<div class="sort-bar no-export">
    <span style="font-size:11px;color:var(--text3)">ë‚ ì§œ ì •ë ¬</span>
    <button class="sort-btn ${recSortDir==='desc'?'on':''}" onclick="recSortDir='desc';render()">ìµœì‹ ìˆœ â†“</button>
    <button class="sort-btn ${recSortDir==='asc'?'on':''}" onclick="recSortDir='asc';render()">ì˜¤ë˜ëœìˆœ â†‘</button>
    <span style="font-size:11px;color:var(--gray-l);margin-left:4px">${filtered.length}ê±´</span>
  </div>`;
  if(!filtered.length)return sortBar+`<div style="padding:40px;text-align:center;color:var(--gray-l);">í•´ë‹¹ ê¸°ê°„ì— ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  let h=sortBar;
  filtered.forEach((m,listIdx)=>{
    const a=m.a||m.hostUniv||m.u||'';const b=m.b||'';
    const ca=gc(a);const cb=gc(b);
    const aWin=m.sa>m.sb;const bWin=m.sb>m.sa;
    const key=`${context}-comp-${listIdx}`;
    const rIdx=(m._src==='comps')?m._origIdx:-1;
    // GROUP ë°°ì§€ (tourneys ê²½ê¸°)
    const grpBadge=m._src==='tour'
      ?`<span style="background:${m.grpColor};color:#fff;font-size:10px;font-weight:700;padding:1px 8px;border-radius:4px;margin-left:6px">GROUP ${m.grpLetter}</span>`:'';
    h+=`<div class="rec-summary">
      <div class="rec-sum-header">
        <span style="color:var(--gray-l);font-size:11px;min-width:72px">${m.d||''}</span>
        <span style="font-weight:700;font-size:13px">ğŸ–ï¸ ${m.n||'ëŒ€íšŒ'}${grpBadge}</span>
        <div class="rec-sum-vs">
          ${a?`<span class="ubadge${aWin?'':' loser'} clickable-univ" style="background:${ca}" onclick="openUnivModal('${a}')">${a}</span>`:''}
          ${(a&&b)?`<div class="rec-sum-score score-click" onclick="toggleDetail('${key}')" title="í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°">
            <span class="${aWin?'wt':bWin?'lt':'pt-z'}">${m.sa||0}</span>
            <span style="color:var(--gray-l);font-size:14px">:</span>
            <span class="${bWin?'wt':aWin?'lt':'pt-z'}">${m.sb||0}</span>
          </div>`:''}
          ${b?`<span class="ubadge${bWin?'':' loser'} clickable-univ" style="background:${cb}" onclick="openUnivModal('${b}')">${b}</span>`:''}
          ${(a&&b)?`<span style="font-size:12px;font-weight:700;color:${aWin?ca:bWin?cb:'#888'}">
            ${aWin?'â–¶ '+a+' ìŠ¹':bWin?'â–¶ '+b+' ìŠ¹':'ë¬´ìŠ¹ë¶€'}
          </span>`:''}
        </div>
        <div style="margin-left:auto;display:flex;align-items:center;gap:4px;flex-shrink:0">
          <button class="btn btn-w btn-xs" onclick="copyMatchResult('${a.replace(/'/g,"\\'")}',${m.sa||0},'${b.replace(/'/g,"\\'")}',${m.sb||0},'${m.d||''}','comp',${rIdx>=0?rIdx:'null'})" title="ê²°ê³¼ ë³µì‚¬" style="padding:3px 8px;font-size:14px">ğŸ“‹</button>
          <div style="display:flex;gap:4px;align-items:center" class="no-export">
            <button id="detbtn-${key}" class="btn-detail" onclick="toggleDetail('${key}')">â–¼ ìƒì„¸ ì—´ê¸°</button>
            ${rIdx>=0?adminBtn(`<button class="btn btn-o btn-xs" onclick="openRE('comp',${rIdx})">ìˆ˜ì •</button>`):''}
            ${rIdx>=0?adminBtn(`<button class="btn btn-r btn-xs" onclick="delRec('comp',${rIdx})">ì‚­ì œ</button>`):''}
            ${m._src==='tour'?adminBtn(`<button class="btn btn-o btn-xs" onclick="leagueEditMatch('${m._tnId}',${m._gi},${m._mi})">ìˆ˜ì •</button>`):''}
          </div>
        </div>
      </div>
      <div id="det-${key}" class="rec-detail-area">
        ${buildDetailHTML(m,'comp',a,b,ca,cb,aWin,bWin)}
        <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)" class="no-export">
          ${m.memo?`<div style="font-size:12px;color:var(--text2);background:#fffbeb;border:1px solid var(--gold-b);border-radius:6px;padding:6px 10px;margin-bottom:6px">ğŸ“ ${m.memo}</div>`:''}
          <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
            <button class="btn-capture btn-xs" onclick="captureDetail('det-${key}','ëŒ€íšŒ_${(m.d||'match').replace(/\\//g,'-')}')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
            <button class="btn btn-p btn-xs" onclick="_shareMode='match';window._shareMatchObj=_getCompMatchObj(${listIdx},'${context}');openShareCardModal();setTimeout(()=>renderShareCardByMatchObj(window._shareMatchObj),80)">ğŸ´ ê³µìœ  ì¹´ë“œ</button>
            ${rIdx>=0&&isLoggedIn?`<input type="text" id="memo-${key}" placeholder="ê²½ê¸° ë©”ëª¨..." value="${m.memo||''}" style="flex:1;font-size:12px">
            <button class="btn btn-w btn-xs" onclick="saveMemo('comp',${rIdx},'memo-${key}')">ğŸ’¾ ë©”ëª¨</button>
            ${m.memo?`<button class="btn btn-r btn-xs" onclick="saveMemo('comp',${rIdx},null)">ì‚­ì œ</button>`:''}`:''}
          </div>
        </div>
      </div>
    </div>`;
  });
  return h||`<div style="padding:40px;text-align:center;color:var(--gray-l);">í•´ë‹¹ ê¸°ê°„ì— ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
}
// ê³µìœ ì¹´ë“œìš© - contextë³„ ìºì‹œëœ filtered ë°°ì—´ì—ì„œ m ê°ì²´ ë°˜í™˜ í—¬í¼
window._compListCache={};
function _getCompMatchObj(listIdx,context){
  // ìºì‹œ ì—†ê±°ë‚˜ ë°ì´í„° ë³€ê²½ ì‹œ ì¬ìƒì„±
  if(!window._compListCache||!window._compListCache[context]){
    if(!window._compListCache)window._compListCache={};
    const tourItems=getTourneyMatches();
    const compItems=[...comps].map((m,origIdx)=>({...m,_src:'comps',_origIdx:origIdx}));
    const all=[...tourItems,...compItems].filter(m=>typeof passDateFilter!=='function'||passDateFilter(m.d||''));
    all.sort((a,b)=>recSortDir==='asc'?(a.d||'').localeCompare(b.d||''):(b.d||'').localeCompare(a.d||''));
    window._compListCache[context]=all;
  }
  return window._compListCache[context][listIdx]||null;
}

function delRec(mode,i){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ í•´ë‹¹ ëŒ€ì „ì˜ ëª¨ë“  ê²½ê¸° ê²°ê³¼ê°€ ì„ ìˆ˜ ì„±ì ì—ì„œ ì°¨ê°ë©ë‹ˆë‹¤.'))return;
  let matchObj=null;
  if(mode==='mini')     { matchObj=miniM[i];  miniM.splice(i,1); }
  else if(mode==='univm'){ matchObj=univM[i];  univM.splice(i,1); }
  else if(mode==='comp') { matchObj=comps[i];  comps.splice(i,1); }
  else if(mode==='ck')   { matchObj=ckM[i];    ckM.splice(i,1);   }
  else if(mode==='pro')  { matchObj=proM[i];   proM.splice(i,1);  }
  else if(mode==='tt')   { matchObj=ttM[i];    ttM.splice(i,1);   }
  if(matchObj) revertMatchRecord(matchObj);
  if(typeof fixPoints==='function')fixPoints();
  save();render();
}

function goToPlayer(name){
  searchTarget=name;histSub='player';openDetails={};curTab='hist';
  document.getElementById('fstrip').style.display='none';
  render();
}

function doSearch(val){
  const v=(val||'').toLowerCase().trim();
  const R=document.getElementById('hres');
  if(!R)return;
  if(!v){R.innerHTML='';return;}
  // ì—¬ëŸ¬ ì„ ìˆ˜ ë§¤ì¹­ ì§€ì›
  const matched=players.filter(x=>x.name.toLowerCase().includes(v)||(x.univ||'').toLowerCase().includes(v));
  if(!matched.length){R.innerHTML=`<div style="color:var(--gray-l);padding:20px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;return;}
  // ì™„ì „ ì¼ì¹˜ ìš°ì„ , ì•„ë‹ˆë©´ ì²« ë²ˆì§¸
  const p=matched.find(x=>x.name.toLowerCase()===v)||matched[0];
  // ì—¬ëŸ¬ ê²°ê³¼ì¼ ë•Œ ì„ íƒ ë²„íŠ¼ í‘œì‹œ
  if(matched.length>1&&matched[0].name.toLowerCase()!==v){
    let pick=`<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">`;
    matched.slice(0,10).forEach(m=>{
      const col=gc(m.univ);
      pick+=`<button onclick="searchTarget='${m.name.replace(/'/g,"\\'")}';doSearch('${m.name.replace(/'/g,"\\'")}');document.getElementById('hs').value='${m.name.replace(/'/g,"\\'")}'"
        style="padding:4px 12px;border-radius:20px;background:${col};color:#fff;border:none;font-size:12px;font-weight:700;cursor:pointer">${m.name}</button>`;
    });
    pick+=`</div>`;
    if(p===matched[0]&&matched.length>1){
      R.innerHTML=pick;
      // ì™„ì „ ì¼ì¹˜ê°€ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ë©ˆì¶¤
      if(matched[0].name.toLowerCase()!==v) return;
    }
  }
  searchTarget=p.name;
  const opps={},rv={T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}};
  p.history.forEach(h=>{
    if(!opps[h.opp])opps[h.opp]={w:0,l:0,race:h.oppRace};
    if(h.result==='ìŠ¹'){opps[h.opp].w++;if(rv[h.oppRace])rv[h.oppRace].w++;}
    else{opps[h.opp].l++;if(rv[h.oppRace])rv[h.oppRace].l++;}
  });
  const matchLog=[];
  function scanMatches(arr, modeLabel, getLabel){
    arr.forEach(m=>{
      if(!m.sets)return;
      m.sets.forEach((set,si)=>{
        if(!set.games)return;
        set.games.forEach(g=>{
          const isA=(g.playerA===p.name), isB=(g.playerB===p.name);
          if(!isA&&!isB)return;
          const isWin=(isA&&g.winner==='A')||(isB&&g.winner==='B');
          const opp=isA?g.playerB:g.playerA;
          const oppP=players.find(x=>x.name===opp);
          const d=m.d||'';
          if(typeof passDateFilter==='function' && !passDateFilter(d)) return;
          matchLog.push({
            date:d,
            mode:modeLabel,
            label:getLabel(m),
            result:isWin?'ìŠ¹':'íŒ¨',
            opp:opp||'?',
            oppRace:oppP?.race||'?',
            map:g.map||'-',
            setLabel:si===2?'ì—ì´ìŠ¤ì „':`${si+1}ì„¸íŠ¸`,
            mObj:m,
            si:si,
            gi:set.games.indexOf(g)
          });
        });
      });
    });
  }
  scanMatches(miniM,'ë¯¸ë‹ˆëŒ€ì „',m=>m.t||'ë¯¸ë‹ˆëŒ€ì „');
  scanMatches(univM,'ëŒ€í•™ëŒ€ì „',m=>m.n||`${m.a} vs ${m.b}`);
  scanMatches(comps,'ëŒ€íšŒ',m=>m.n||'ëŒ€íšŒ');
  scanMatches(ckM,'ëŒ€í•™CK',m=>'ëŒ€í•™CK');
  matchLog.sort((a,b)=>b.date.localeCompare(a.date));

  // í•„í„°ì— ë”°ë¥¸ ê¸°ê°„ë³„ ì „ì  ì§‘ê³„
  let fWin=p.win, fLoss=p.loss;
  if(!(filterYear==='ì „ì²´' && filterMonth==='ì „ì²´')){
    fWin=0;fLoss=0;
    matchLog.forEach(lg=>{
      if(lg.result==='ìŠ¹')fWin++; else if(lg.result==='íŒ¨')fLoss++;
    });
  }
  const fTot=fWin+fLoss;
  const fWr=fTot?Math.round(fWin/fTot*100):0;

  const col=gc(p.univ);

  const modeBg={'ë¯¸ë‹ˆëŒ€ì „':'#2563eb','ëŒ€í•™ëŒ€ì „':'#7c3aed','ëŒ€íšŒ':'#d97706','ëŒ€í•™CK':'#dc2626'};
  let h=`<div class="ipanel" style="border-color:${col}66;background:${col}0d;">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px">
      <span class="ubadge clickable-univ" style="background:${col};font-size:13px;padding:5px 14px" onclick="openUnivModal('${p.univ}')">${p.univ}</span>
      <span class="rbadge r${p.race}">${p.race}</span>
      <span style="font-size:20px">${p.name}${genderIcon(p.gender)}</span>
      ${getTierBadge(p.tier)}
    </div>
    <div style="display:flex;gap:24px;flex-wrap:wrap">
      <div><div style="font-size:11px;color:var(--gray-l)">ì´ ì „ì </div>
        <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px"><span class="wt">${fWin}ìŠ¹</span> <span class="lt">${fLoss}íŒ¨</span></div></div>
      <div><div style="font-size:11px;color:var(--gray-l)">ìŠ¹ë¥ </div>
        <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px;color:${fWr>=50?'var(--green)':'var(--red)'}">${fTot?fWr+'%':'-'}</div></div>
      <div><div style="font-size:11px;color:var(--gray-l)">í¬ì¸íŠ¸</div>
        <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px" class="${pC(p.points)}">${pS(p.points)}</div></div>
    </div>
  </div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px">`;
  RACES.forEach(r=>{
    const s=rv[r];const t=s.w+s.l;const w=t?Math.round(s.w/t*100):0;
    h+=`<div class="rscard"><div style="margin-bottom:6px"><span class="rbadge r${r}">${r} ${RNAME[r]}</span></div>
      <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px;color:${w>=50?'var(--green)':'var(--red)'}">${t?w+'%':'-'}</div>
      <div style="font-size:11px;margin-top:4px"><span class="wt">${s.w}ìŠ¹</span> <span class="lt">${s.l}íŒ¨</span></div></div>`;
  });
  h+=`</div><div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">`;
  Object.entries(opps).sort((a,b)=>(b[1].w+b[1].l)-(a[1].w+a[1].l)).forEach(([opp,s])=>{
    const ot=s.w+s.l;const ow=ot?Math.round(s.w/ot*100):0;
    h+=`<div class="ocard" style="cursor:pointer" onclick="openPlayerModal('${opp}')">
      <div style="font-weight:700;font-size:13px;color:var(--blue);text-decoration:underline dotted">${opp}</div>
      <div style="font-size:11px;margin:3px 0"><span class="rbadge r${s.race}">${s.race}</span></div>
      <div><span class="wt">${s.w}ìŠ¹</span> <span class="lt">${s.l}íŒ¨</span></div>
      <div style="font-weight:700;font-size:12px;color:${ow>=50?'var(--green)':'var(--red)'}">${ow}%</div>
    </div>`;
  });
  h+=`</div>`;

  if(matchLog.length){
    const totalItems=matchLog.length;
    const totalPages=Math.ceil(totalItems/PLAYER_HIST_PAGE_SIZE);
    if(playerHistPage>=totalPages)playerHistPage=Math.max(0,totalPages-1);
    const pageStart=playerHistPage*PLAYER_HIST_PAGE_SIZE;
    const pageLogs=totalItems>PLAYER_HIST_PAGE_SIZE?matchLog.slice(pageStart,pageStart+PLAYER_HIST_PAGE_SIZE):matchLog;

    h+=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px;color:var(--blue);margin-bottom:8px;padding-bottom:6px;border-bottom:2px solid var(--blue-ll);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px">
      <span>ğŸ“‹ ëŒ€ì „ë³„ ìƒì„¸ ê¸°ë¡ <span style="font-size:10px;font-weight:400;color:var(--gray-l)">(í–‰ í´ë¦­ ì‹œ ê²½ê¸° ìƒì„¸ / ì´ë¦„ í´ë¦­ ì‹œ í•´ë‹¹ ì„ ìˆ˜ ì´ë™)</span></span>
      <span style="font-size:11px;font-weight:400;color:var(--gray-l)">${totalItems}ê±´${totalItems>PLAYER_HIST_PAGE_SIZE?` (${pageStart+1}~${Math.min(pageStart+PLAYER_HIST_PAGE_SIZE,totalItems)})`:''}</span>
    </div>`;
    h+=`<table><thead><tr><th>ë‚ ì§œ</th><th>ëŒ€ì „ ì¢…ë¥˜</th><th>ì„¸íŠ¸</th><th>ê²°ê³¼</th><th>ìƒëŒ€</th><th>ìƒëŒ€ì¢…ì¡±</th><th>ë§µ</th><th style="width:20px"></th>${isLoggedIn?'<th class="no-export" style="width:60px">ê´€ë¦¬</th>':''}</tr></thead><tbody>`;
    pageLogs.forEach((lg,li)=>{
      const globalLi=pageStart+li;
      const mb=modeBg[lg.mode]||'#6b7280';
      const modeCell=lg.mode==='ëŒ€íšŒ'
        ?`<span style="background:${mb};color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700">${lg.mode}</span><span style="font-size:11px;font-weight:700;color:var(--gold);margin-left:4px">${lg.label}</span>`
        :`<span style="background:${mb};color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700">${lg.mode}</span>`;
      const resultCell=lg.result==='ìŠ¹'
        ?`<span style="background:var(--blue);color:#fff;font-size:12px;font-weight:800;padding:3px 11px;border-radius:5px;letter-spacing:.5px">WIN</span>`
        :`<span style="background:#94a3b8;color:#fff;font-size:12px;font-weight:700;padding:3px 11px;border-radius:5px;letter-spacing:.5px;opacity:0.7">LOSE</span>`;
      const oppP=players.find(x=>x.name===lg.opp);
      const oppClick=lg.opp!=='?'?`onclick="event.stopPropagation();openPlayerModal('${lg.opp}')" style="color:var(--blue);text-decoration:underline dotted;cursor:pointer;font-weight:700"`:'';
      const detKey=`psearch-${globalLi}`;
      const mObj=lg.mObj;
      const isCK=(lg.mode==='ëŒ€í•™CK');
      const ca=isCK?'#2563eb':(mObj.a?gc(mObj.a):'#888');
      const cb=isCK?'#dc2626':(mObj.b?gc(mObj.b):'#888');
      const labelA=isCK?'AíŒ€':(mObj.a||'A');
      const labelB=isCK?'BíŒ€':(mObj.b||'B');
      const singleSetHTML=buildSingleSetHTML(mObj,lg.si,labelA,labelB,ca,cb);
      // REQ4: ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ - mObj ì›ë³¸ ë°°ì—´ ì¸ë±ìŠ¤ ê³„ì‚°
      let editMode='',editIdx=-1;
      if(lg.mode==='ë¯¸ë‹ˆëŒ€ì „'){editMode='mini';editIdx=miniM.indexOf(mObj);}
      else if(lg.mode==='ëŒ€í•™ëŒ€ì „'){editMode='univm';editIdx=univM.indexOf(mObj);}
      else if(lg.mode==='ëŒ€íšŒ'){editMode='comp';editIdx=comps.indexOf(mObj);}
      else if(lg.mode==='ëŒ€í•™CK'){editMode='ck';editIdx=ckM.indexOf(mObj);}
      h+=`<tr style="cursor:pointer" onclick="toggleDetail('${detKey}')">
        <td style="color:var(--gray-l);font-size:11px">${lg.date}</td>
        <td>${modeCell}</td>
        <td style="color:var(--gray-l);font-size:11px">${lg.setLabel}</td>
        <td>${resultCell}</td>
        <td><span ${oppClick}>${lg.opp}</span></td>
        <td>${lg.oppRace!=='?'?`<span class="rbadge r${lg.oppRace}">${lg.oppRace}</span>`:'-'}</td>
        <td style="color:var(--gray-l);font-size:11px">${lg.map}</td>
        <td style="color:var(--gray-l);font-size:10px" id="detbtn-${detKey}">â–¼</td>
        ${isLoggedIn&&editIdx>=0&&(editMode==='mini'||editMode==='univm'||editMode==='comp')?`<td class="no-export" style="text-align:center" onclick="event.stopPropagation()">
          ${adminBtn(`<button class="btn btn-o btn-xs" onclick="openRE('${editMode}',${editIdx})">ìˆ˜ì •</button>`)}
          ${adminBtn(`<button class="btn btn-r btn-xs" onclick="delRec('${editMode}',${editIdx})">ì‚­ì œ</button>`)}
        </td>`:isLoggedIn?'<td class="no-export"></td>':''}
      </tr>
      <tr id="det-${detKey}" style="display:none">
        <td colspan="${isLoggedIn?9:8}" style="padding:0;background:var(--surface)">
          <div style="padding:10px 16px">${singleSetHTML}</div>
        </td>
      </tr>`;
    });
    h+=`</tbody></table>`;

    // REQ4: í˜ì´ì§€ ì»¨íŠ¸ë¡¤
    if(totalItems>PLAYER_HIST_PAGE_SIZE){
      const pages=totalPages;
      let pager=`<div class="no-export" style="display:flex;align-items:center;justify-content:center;gap:6px;padding:14px 0;flex-wrap:wrap">`;
      pager+=`<button class="btn btn-w btn-xs" style="min-width:32px" onclick="playerHistPage=0;openPlayerModal('${name}')" ${playerHistPage===0?'disabled':''}>Â«</button>`;
      pager+=`<button class="btn btn-w btn-xs" style="min-width:32px" onclick="playerHistPage=Math.max(0,${playerHistPage}-1);openPlayerModal('${name}')" ${playerHistPage===0?'disabled':''}>â€¹</button>`;
      let startP=Math.max(0,playerHistPage-3);let endP=Math.min(pages-1,startP+6);
      if(endP-startP<6)startP=Math.max(0,endP-6);
      for(let pg=startP;pg<=endP;pg++){
        pager+=`<button class="btn ${pg===playerHistPage?'btn-b':'btn-w'} btn-xs" style="min-width:32px" onclick="playerHistPage=${pg};openPlayerModal('${name}')">${pg+1}</button>`;
      }
      pager+=`<button class="btn btn-w btn-xs" style="min-width:32px" onclick="playerHistPage=Math.min(${pages-1},${playerHistPage}+1);openPlayerModal('${name}')" ${playerHistPage===pages-1?'disabled':''}>â€º</button>`;
      pager+=`<button class="btn btn-w btn-xs" style="min-width:32px" onclick="playerHistPage=${pages-1};openPlayerModal('${name}')" ${playerHistPage===pages-1?'disabled':''}>Â»</button>`;
      pager+=`</div>`;
      h+=pager;
    }
  } else {
    h+=`<div style="padding:20px;text-align:center;color:var(--gray-l);background:var(--surface);border-radius:8px;border:1px solid var(--border)">ëŒ€ì „ ê¸°ë¡ì—ì„œ ì´ ì„ ìˆ˜ì˜ ê²½ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }
  R.innerHTML=h;
}

function toggleDetail(key){
  const area=document.getElementById('det-'+key);
  const btn=document.getElementById('detbtn-'+key);
  if(!area)return;
  const isTR=area.tagName==='TR';
  if(isTR){
    const open=area.style.display==='none'||area.style.display==='';
    area.style.display=open?'table-row':'none';
    if(btn)btn.textContent=open?'â–²':'â–¼';
  } else {
    openDetails[key]=!openDetails[key];
    area.classList.toggle('open',!!openDetails[key]);
    if(btn){btn.classList.toggle('open',!!openDetails[key]);btn.textContent=openDetails[key]?'â–² ìƒì„¸ ë‹«ê¸°':'â–¼ ìƒì„¸ ë³´ê¸°';}
  }
}

function savePlayerMemo(name, del=false){
  const p=players.find(x=>x.name===name);
  if(!p)return;
  if(del){
    delete p.memo;
  } else {
    const el=document.getElementById('player-memo-input');
    if(el) p.memo=el.value.trim();
  }
  save();
  document.getElementById('playerModalBody').innerHTML=buildPlayerDetailHTML(p);
}

function saveMemo(mode,idx,inputId){
  let arr;
  if(mode==='mini') arr=miniM;
  else if(mode==='univm') arr=univM;
  else if(mode==='comp') arr=comps;
  else if(mode==='ck') arr=ckM;
  else if(mode==='pro') arr=proM;
  else return;
  if(!arr[idx])return;
  if(inputId===null){
    delete arr[idx].memo;
  } else {
    const el=document.getElementById(inputId);
    if(el) arr[idx].memo=el.value.trim();
  }
  save();render();
}

function buildSingleSetHTML(m, si, labelA, labelB, ca, cb){
  if(!m.sets||!m.sets[si])return`<div style="font-size:11px;color:var(--gray-l)">ì„¸íŠ¸ ê¸°ë¡ ì—†ìŒ</div>`;
  const set=m.sets[si];
  const isAce=(si===2);
  const sLabel=isAce?'ğŸ¯ ì—ì´ìŠ¤ì „':`${si+1}ì„¸íŠ¸`;
  const swA=set.scoreA||0,swB=set.scoreB||0;
  const setAWin=swA>swB,setBWin=swB>swA;
  let h=`<div style="font-size:11px;font-weight:700;color:${isAce?'#7c3aed':'var(--blue)'};margin-bottom:8px">${sLabel} â€” ${labelA} <span class="${setAWin?'wt':'lt'}">${swA}</span>:<span class="${setBWin?'wt':'lt'}">${swB}</span> ${labelB}</div>`;
  if(set.games&&set.games.length){
    set.games.forEach((g,gi)=>{
      if(!g.playerA&&!g.playerB)return;
      const pA=players.find(p=>p.name===g.playerA);
      const pB=players.find(p=>p.name===g.playerB);
      const aIsWinner=g.winner==='A';const bIsWinner=g.winner==='B';const hasWinner=!!g.winner;
      const winBgA=ca+'22',winBgB=cb+'22',winBorderA=ca+'66',winBorderB=cb+'66';
      const styleA=hasWinner?(aIsWinner?`display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:${winBgA};border:2px solid ${winBorderA};`:`display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:#f1f5f9;border:1px solid #cbd5e1;opacity:0.45;filter:grayscale(1);`):`display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:var(--surface);border:1px solid var(--border);`;
      const styleB=hasWinner?(bIsWinner?`display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:${winBgB};border:2px solid ${winBorderB};`:`display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:#f1f5f9;border:1px solid #cbd5e1;opacity:0.45;filter:grayscale(1);`):`display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:var(--surface);border:1px solid var(--border);`;
      const cA=g.playerA?`onclick="openPlayerModal('${g.playerA}')" style="cursor:pointer;text-decoration:underline dotted"`:'';
      const cB=g.playerB?`onclick="openPlayerModal('${g.playerB}')" style="cursor:pointer;text-decoration:underline dotted"`:'';
      const mapStr=g.map?`<span style="background:var(--surface);border:1px solid var(--border);padding:2px 6px;border-radius:4px;font-size:10px">ğŸ“${g.map}</span>`:'';
      h+=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;flex-wrap:wrap">
        <span style="color:var(--gray-l);font-size:10px;min-width:40px">ê²½ê¸°${gi+1}</span>
        <div style="${styleA}">${pA?getPlayerPhotoHTML(pA.name,'20px','margin-right:2px'):''} ${pA?`<span class="rbadge r${pA.race}" style="font-size:10px">${pA.race}</span>`:''}<strong style="font-size:12px" ${cA}>${g.playerA||'?'}</strong>${pA?genderIcon(pA.gender):''}<span style="font-size:10px;color:${ca};font-weight:700">(${labelA})</span>${aIsWinner&&hasWinner?`<span style="background:${ca};color:#fff;font-size:9px;font-weight:800;padding:1px 6px;border-radius:3px">WIN</span>`:''}</div>
        <span style="color:var(--gray-l);font-size:10px">vs</span>
        <div style="${styleB}">${pB?getPlayerPhotoHTML(pB.name,'20px','margin-right:2px'):''} ${pB?`<span class="rbadge r${pB.race}" style="font-size:10px">${pB.race}</span>`:''}<strong style="font-size:12px" ${cB}>${g.playerB||'?'}</strong>${pB?genderIcon(pB.gender):''}<span style="font-size:10px;color:${cb};font-weight:700">(${labelB})</span>${bIsWinner&&hasWinner?`<span style="background:${cb};color:#fff;font-size:9px;font-weight:800;padding:1px 6px;border-radius:3px">WIN</span>`:''}</div>
        ${mapStr}
      </div>`;
    });
  }
  return h;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì¢…ì¡± ìŠ¹ë¥ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rRace(C,T){
  T.innerText='ğŸ§¬ ì¢…ì¡±ë³„ ì „ì²´ ìŠ¹ë¥ ';
  let h='';
  if(typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('race');
  }
  if(typeof raceSummaryHTML==='function'){
    h+=raceSummaryHTML();
    C.innerHTML=h;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëŒ€í•™ë³„ í¬ì¸íŠ¸ ìˆœìœ„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rUniv(C,T){
  T.innerText='ğŸ›ï¸ ëŒ€í•™ë³„ í¬ì¸íŠ¸ ìˆœìœ„';
  C.innerHTML=rUnivBodyHTML();
}

function rUnivBodyHTML(){
  const uS={};
  // í”„ë¡œë¦¬ê·¸ matchId ì§‘í•© (ì œì™¸ìš©)
  const proMatchIds=new Set(proM.map(m=>m._id).filter(Boolean));
  // ëŒ€í•™ë³„ ê¸°ë³¸ êµ¬ì¡° ìƒì„±
  getAllUnivs().forEach(u=>{uS[u.name]={w:0,l:0,pts:0,cnt:0};});
  // ì„ ìˆ˜ ìˆ˜ ì¹´ìš´íŠ¸
  players.forEach(p=>{
    if(!uS[p.univ])uS[p.univ]={w:0,l:0,pts:0,cnt:0};
    uS[p.univ].cnt++;
  });
  // ì—°/ì›” í•„í„°ë¥¼ ì ìš©í•œ ê²½ê¸° ê²°ê³¼ë¡œ ìŠ¹/íŒ¨/í¬ì¸íŠ¸ ì§‘ê³„ (í”„ë¡œë¦¬ê·¸ ì œì™¸)
  players.forEach(p=>{
    const univ=p.univ;
    const bucket=uS[univ];
    if(!bucket)return;
    (p.history||[]).forEach(h=>{
      if(proMatchIds.has(h.matchId)) return; // í”„ë¡œë¦¬ê·¸ ì œì™¸
      const d=h.date||'';
      if(typeof passDateFilter==='function' && !passDateFilter(d)) return;
      if(h.result==='ìŠ¹') bucket.w++;
      else if(h.result==='íŒ¨') bucket.l++;
    });
  });
  Object.values(uS).forEach(s=>{
    s.pts = (s.w*3)-(s.l*3);
  });
  const sorted=Object.entries(uS).filter(([,s])=>s.cnt>0).sort((a,b)=>b[1].pts-a[1].pts);
  let h='';
  if(typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('univ-rank');
  }
  h+=`<table><thead><tr><th style="text-align:left">ìˆœìœ„</th><th style="text-align:left">ëŒ€í•™</th><th>ì„ ìˆ˜ ìˆ˜</th><th>ì´ ìŠ¹</th><th>ì´ íŒ¨</th><th>ì´ í¬ì¸íŠ¸</th><th>ìŠ¹ë¥ </th></tr></thead><tbody>`;
  if(!sorted.length)h+=`<tr><td colspan="7" style="padding:40px;color:var(--gray-l)">ë“±ë¡ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
  sorted.forEach(([name,s],i)=>{
    const col=gc(name);const tot=s.w+s.l;const wr=tot?Math.round(s.w/tot*100):0;
    let rnkHTML;
    if(i===0) rnkHTML=`<span class="rk1">1ë“±</span>`;
    else if(i===1) rnkHTML=`<span class="rk2">2ë“±</span>`;
    else if(i===2) rnkHTML=`<span class="rk3">3ë“±</span>`;
    else rnkHTML=`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px">${i+1}ìœ„</span>`;
    h+=`<tr style="background:${col}08">
      <td style="text-align:left">${rnkHTML}</td>
      <td style="text-align:left"><span class="ubadge clickable-univ" style="background:${col}" onclick="openUnivModal('${name}')">${name}</span></td>
      <td style="color:var(--gray-l)">${s.cnt}ëª…</td>
      <td class="wt" style="font-size:15px;font-weight:800">${s.w}</td>
      <td class="lt" style="font-size:15px;font-weight:800">${s.l}</td>
      <td class="${pC(s.pts)}" style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px">${pS(s.pts)}</td>
      <td style="font-weight:700;color:${wr>=50?'var(--green)':'var(--red)'}">${tot?wr+'%':'-'}</td>
    </tr>`;
  });
  return h+`</tbody></table>`;
}

// ì¢…ì¡± ìŠ¹ë¥  ê³µí†µ HTML (ì—°ë„/ì›” í•„í„° ì ìš©)
function raceSummaryHTML(){
  const proMatchIds=new Set(proM.map(m=>m._id).filter(Boolean));
  const rs={T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}};
  const vs={T:{T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}},Z:{T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}},P:{T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}}};
  players.forEach(p=>{
    const myRace=p.race;
    if(!rs[myRace])return;
    (p.history||[]).forEach(h=>{
      if(proMatchIds.has(h.matchId)) return; // í”„ë¡œë¦¬ê·¸ ì œì™¸
      const d=h.date||'';
      if(typeof passDateFilter==='function' && !passDateFilter(d)) return;
      if(h.result==='ìŠ¹') rs[myRace].w++; else rs[myRace].l++;
      if(vs[myRace]?.[h.oppRace]){
        if(h.result==='ìŠ¹') vs[myRace][h.oppRace].w++; else vs[myRace][h.oppRace].l++;
      }
    });
  });
  const RC={T:'#1d4ed8',Z:'#7c3aed',P:'#b45309'};
  let h=`<div class="scards">`;
  RACES.forEach(r=>{
    const s=rs[r];const tot=s.w+s.l;const wr=tot?Math.round(s.w/tot*100):0;
    h+=`<div class="scard" style="border-top:4px solid ${RC[r]}">
      <div class="sv" style="color:${RC[r]}">${tot?wr+'%':'-'}</div>
      <div style="margin:6px 0"><span class="rbadge r${r}">${r} ${RNAME[r]}</span></div>
      <div class="sl"><span class="wt">${s.w}ìŠ¹</span> Â· <span class="lt">${s.l}íŒ¨</span></div>
    </div>`;
  });
  h+=`</div><table><thead><tr><th style="text-align:left">ë‚´ ì¢…ì¡±</th><th>vs í…Œë€(T)</th><th>vs ì €ê·¸(Z)</th><th>vs í”„ë¡œí† ìŠ¤(P)</th></tr></thead><tbody>`;
  RACES.forEach(my=>{
    h+=`<tr><td style="text-align:left"><span class="rbadge r${my}">${my} ${RNAME[my]}</span></td>`;
    RACES.forEach(op=>{
      const s=vs[my][op];const t=s.w+s.l;const w=t?Math.round(s.w/t*100):0;
      h+=`<td><span class="wt">${s.w}ìŠ¹</span> <span class="lt">${s.l}íŒ¨</span>${t?` <span style="color:${w>=50?'var(--green)':'var(--red)'};font-weight:700">(${w}%)</span>`:''}`;
    });
    h+=`</tr>`;
  });
  return h+`</tbody></table>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ê³µí†µ ì„¸íŠ¸ ë¹Œë”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function stabs(current, opts){
  return `<div class="stabs no-export">${opts.map(o=>{
    if(o.id==='input'&&!isLoggedIn) return '';
    return `<button class="stab ${current===o.id?'on':''}" onclick="${o.fn}">${o.lbl}</button>`;
  }).join('')}</div>`;
}

// ê³µí†µ ì—°ë„/ì›” í•„í„° UI
function buildYearMonthFilter(section){
  let h=`<div class="fbar no-export" style="margin-bottom:12px;flex-wrap:wrap">
    <strong>ê¸°ê°„</strong>`;
  const years=['ì „ì²´',...yearOptions];
  years.forEach(y=>{
    const sel=(filterYear===y);
    const label=(y==='ì „ì²´')?'ì „ì²´':`${y}ë…„`;
    h+=`<button class="pill ${sel?'on':''}" onclick="setFilterYear('${y}','${section}')">${label}</button>`;
  });
  if(isLoggedIn){
    h+=`<button class="pill" onclick="addYear('${section}')">+ ì—°ë„ ì¶”ê°€</button>`;
  }
  h+=`<span style="font-size:11px;color:var(--gray-l);margin-left:10px">ì›”</span>`;
  const months=['ì „ì²´','01','02','03','04','05','06','07','08','09','10','11','12'];
  months.forEach(m=>{
    const sel=(filterMonth===m);
    const label=(m==='ì „ì²´')?'ì „ì²´':`${parseInt(m,10)}ì›”`;
    h+=`<button class="pill ${sel?'on':''}" onclick="setFilterMonth('${m}','${section}')">${label}</button>`;
  });
  h+='</div>';
  return h;
}

function setFilterYear(y, section){
  filterYear=y;
  openDetails={};
  render();
}

function addYear(section){
  if(!isLoggedIn)return;
  const y=prompt('ì¶”ê°€í•  ì—°ë„ (ì˜ˆ: 2027)ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
  if(!y)return;
  const v=y.trim();
  if(!/^\d{4}$/.test(v))return;
  if(!yearOptions.includes(v))yearOptions.push(v);
  render();
}

function setFilterMonth(m, section){
  filterMonth=m;
  openDetails={};
  render();
}

function passDateFilter(dateStr){
  if(!dateStr)return true;
  const y=dateStr.slice(0,4);
  const m=dateStr.slice(5,7);
  if(filterYear!=='ì „ì²´' && y!==filterYear)return false;
  if(filterMonth!=='ì „ì²´' && m!==filterMonth)return false;
  return true;
}

function setBuilderHTML(bld, mode){
  const isCK=(mode==='ck'||mode==='pro'||mode==='tt');const isComp=(mode==='comp');
  const allU=getAllUnivs();
  const uOptsA=allU.map(u=>`<option value="${u.name}"${bld.teamA===u.name?' selected':''}>${u.name}</option>`).join('');
  const uOptsB=allU.map(u=>`<option value="${u.name}"${bld.teamB===u.name?' selected':''}>${u.name}</option>`).join('');
  let scoreA=0,scoreB=0;
  bld.sets.forEach(s=>{if(s.winner==='A')scoreA++;else if(s.winner==='B')scoreB++;});
  let h='';
  // CK ëª¨ë“œì—ì„œëŠ” ë‚ ì§œë¥¼ buildCKInputHTMLì—ì„œë§Œ í‘œì‹œ (ì¤‘ë³µ ë°©ì§€)
  if(!isCK){
  h+=`<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;align-items:center">
    <label style="font-size:12px;font-weight:700;color:var(--blue)">ë‚ ì§œ</label>
    <input type="date" value="${bld.date||''}" onchange="BLD['${mode}'].date=this.value" style="width:140px">`;
  if(isComp)h+=`<label style="font-size:12px;font-weight:700;color:var(--blue)">ëŒ€íšŒëª…</label>
    <input type="text" id="comp-name-input" value="${bld.compName||curComp||''}" placeholder="ëŒ€íšŒëª…" style="width:150px" onchange="BLD['comp'].compName=this.value">`;
  h+=`</div>`;
  }
  if(!isCK){
    // ì¢…ì¡± í•„í„° ìƒíƒœ (BLDì— ì €ì¥)
    const rfA=bld.raceFilterA||'';const rfB=bld.raceFilterB||'';
    h+=`<div style="display:flex;gap:14px;margin-bottom:16px;flex-wrap:wrap">
      <div style="flex:1;min-width:160px">
        <label style="font-size:12px;font-weight:700;color:var(--blue);display:block;margin-bottom:6px">ğŸ”µ ${isComp?'ì£¼ìµœ ëŒ€í•™ A':'íŒ€ A ëŒ€í•™'}</label>
        <select onchange="BLD['${mode}'].teamA=this.value;BLD['${mode}'].raceFilterA='';BLD['${mode}'].sets=[];render()" style="width:100%">
          <option value="">ëŒ€í•™ ì„ íƒ</option>${uOptsA}
        </select>
        ${bld.teamA?`<div style="margin-top:6px;display:flex;gap:4px;align-items:center;flex-wrap:wrap">
          <span class="ubadge" style="background:${gc(bld.teamA)}">${bld.teamA}</span>
          ${!isComp?`<span style="font-size:11px;color:var(--gray-l)">ì¢…ì¡± í•„í„°:</span>
          <button class="pill ${rfA===''?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterA='';render()">ì „ì²´</button>
          <button class="pill ${rfA==='T'?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterA='T';render()">í…Œë€</button>
          <button class="pill ${rfA==='Z'?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterA='Z';render()">ì €ê·¸</button>
          <button class="pill ${rfA==='P'?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterA='P';render()">í”„í† </button>`:''}
        </div>`:''}
      </div>
      <div style="flex:1;min-width:160px">
        <label style="font-size:12px;font-weight:700;color:var(--red);display:block;margin-bottom:6px">ğŸ”´ ${isComp?'ëŒ€ê²° ëŒ€í•™ B':'íŒ€ B ëŒ€í•™'}</label>
        <select onchange="BLD['${mode}'].teamB=this.value;BLD['${mode}'].raceFilterB='';BLD['${mode}'].sets=[];render()" style="width:100%">
          <option value="">ëŒ€í•™ ì„ íƒ</option>${uOptsB}
        </select>
        ${bld.teamB?`<div style="margin-top:6px;display:flex;gap:4px;align-items:center;flex-wrap:wrap">
          <span class="ubadge" style="background:${gc(bld.teamB)}">${bld.teamB}</span>
          ${!isComp?`<span style="font-size:11px;color:var(--gray-l)">ì¢…ì¡± í•„í„°:</span>
          <button class="pill ${rfB===''?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterB='';render()">ì „ì²´</button>
          <button class="pill ${rfB==='T'?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterB='T';render()">í…Œë€</button>
          <button class="pill ${rfB==='Z'?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterB='Z';render()">ì €ê·¸</button>
          <button class="pill ${rfB==='P'?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterB='P';render()">í”„í† </button>`:''}
        </div>`:''}
      </div>
    </div>`;
  }
  const teamA=bld.teamA||'';const teamB=bld.teamB||'';
  const rfA=bld.raceFilterA||'';const rfB=bld.raceFilterB||'';
  const rawMA=isCK?(bld.membersA||[]):getMembers(teamA);
  const rawMB=isCK?(bld.membersB||[]):getMembers(teamB);
  const mA=rfA?rawMA.filter(p=>p.race===rfA):rawMA;
  const mB=rfB?rawMB.filter(p=>p.race===rfB):rawMB;
  const canBuild=(isCK)?(rawMA.length&&rawMB.length):(teamA&&teamB);
  if(canBuild){
    h+=`<div class="score-board">
      <span style="font-weight:700">${isCK?'íŒ€A ('+mA.map(m=>m.name).join(',')+')':teamA}</span>
      <span class="score-num wt">${scoreA}</span>
      <span style="color:var(--gray-l);font-size:20px;font-weight:700">:</span>
      <span class="score-num lt">${scoreB}</span>
      <span style="font-weight:700">${isCK?'íŒ€B ('+mB.map(m=>m.name).join(',')+')':teamB}</span>
      <span style="font-size:11px;color:var(--gray-l);margin-left:auto">${bld.sets.length}ì„¸íŠ¸</span>
    </div>`;
    bld.sets.forEach((set,si)=>{
      const isAce=(si===2);const sLabel=isAce?'ğŸ¯ ì—ì´ìŠ¤ì „':`${si+1}ì„¸íŠ¸`;
      const sA=set.scoreA||0,sB=set.scoreB||0;
      h+=`<div class="set-block ${isAce?'ace':''}">
        <div class="set-title">
          <span class="set-badge ${isAce?'ace':''}">${sLabel}</span>
          <span style="font-size:12px;color:var(--gray-l)">ê²½ê¸° ${set.games.length}ê°œ &nbsp;|&nbsp; <span class="${sA>sB?'wt':''}">${sA}</span>:<span class="${sB>sA?'wt':''}">${sB}</span></span>
          <button class="btn btn-r btn-xs" onclick="BLD['${mode}'].sets.splice(${si},1);render()">ì„¸íŠ¸ ì‚­ì œ</button>
        </div>`;
      set.games.forEach((g,gi)=>{
        const optsA=mA.map(p=>`<option value="${p.name}"${g.playerA===p.name?' selected':''}>${p.name}${p.gender==='F'?'â™€':''} [${p.tier}/${p.race}]${isCK?' ('+p.univ+')':''}</option>`).join('');
        const optsB=mB.map(p=>`<option value="${p.name}"${g.playerB===p.name?' selected':''}>${p.name}${p.gender==='F'?'â™€':''} [${p.tier}/${p.race}]${isCK?' ('+p.univ+')':''}</option>`).join('');
        const mapOpts=maps.map(m=>`<option value="${m}"${g.map===m?' selected':''}>${m}</option>`).join('');
        h+=`<div class="game-row">
          <span style="font-size:11px;font-weight:700;color:var(--gray-l);min-width:40px">ê²½ê¸°${gi+1}</span>
          <select onchange="BLD['${mode}'].sets[${si}].games[${gi}].playerA=this.value"><option value="">A ì„ íƒ</option>${optsA}</select>
          <span style="font-size:11px;color:var(--gray-l)">vs</span>
          <select onchange="BLD['${mode}'].sets[${si}].games[${gi}].playerB=this.value"><option value="">B ì„ íƒ</option>${optsB}</select>
          <select onchange="BLD['${mode}'].sets[${si}].games[${gi}].map=this.value" style="max-width:100px"><option value="">ë§µ ì„ íƒ</option>${mapOpts}</select>
          <button class="win-btn ${g.winner==='A'?'win-sel':''}" onclick="BLD['${mode}'].sets[${si}].games[${gi}].winner='A';recalcSet('${mode}',${si});render()">A ìŠ¹</button>
          <button class="win-btn ${g.winner==='B'?'lose-sel':''}" onclick="BLD['${mode}'].sets[${si}].games[${gi}].winner='B';recalcSet('${mode}',${si});render()">B ìŠ¹</button>
          <button class="btn btn-r btn-xs" onclick="BLD['${mode}'].sets[${si}].games.splice(${gi},1);recalcSet('${mode}',${si});render()">ì‚­ì œ</button>
        </div>`;
      });
      h+=`<button class="btn btn-w btn-sm" onclick="BLD['${mode}'].sets[${si}].games.push({playerA:'',playerB:'',winner:'',map:''});render()">+ ê²½ê¸° ì¶”ê°€</button></div>`;
    });
    if(bld.sets.length<3){
      const nLabel=bld.sets.length===2?'ğŸ¯ ì—ì´ìŠ¤ì „ ì¶”ê°€':`${bld.sets.length+1}ì„¸íŠ¸ ì¶”ê°€`;
      h+=`<button class="btn btn-b" style="margin-right:8px;margin-top:4px" onclick="BLD['${mode}'].sets.push({games:[],scoreA:0,scoreB:0,winner:''});render()">+ ${nLabel}</button>`;
    }
    h+=`<div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-g" onclick="saveMatch('${mode}')">âœ… ì €ì¥</button>
      <button class="btn btn-w" onclick="BLD['${mode}']=null;render()">ì´ˆê¸°í™”</button>
    </div>`;
  }
  return h;
}

function recalcSet(mode,si){
  const set=BLD[mode].sets[si];let a=0,b=0;
  set.games.forEach(g=>{if(g.winner==='A')a++;else if(g.winner==='B')b++;});
  set.scoreA=a;set.scoreB=b;set.winner=a>b?'A':b>a?'B':'';
}

function genId(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6);}

function saveMatch(mode){
  const bld=BLD[mode];if(!bld)return;
  if(!bld.sets.length)return alert('ì„¸íŠ¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
  const isCK=(mode==='ck'||mode==='tt');const isComp=(mode==='comp');
  let totalA=0,totalB=0;
  bld.sets.forEach((s,si)=>{recalcSet(mode,si);if(s.winner==='A')totalA++;else if(s.winner==='B')totalB++;});
  const date=bld.date||new Date().toISOString().slice(0,10);
  const matchId=genId();
  const setsSnap=bld.sets.map(s=>({scoreA:s.scoreA,scoreB:s.scoreB,winner:s.winner,games:s.games.map(g=>({...g}))}));
  // pro ëª¨ë“œë„ ì„ ìˆ˜ ê°œì¸ historyì— ë°˜ì˜ (ì—¬ì ì„ ìˆ˜ í¬í•¨ í˜¼ì„± ì§€ì›)
  bld.sets.forEach(set=>{
    set.games.forEach(g=>{
      if(!g.playerA||!g.playerB||!g.winner)return;
      const wName=g.winner==='A'?g.playerA:g.playerB;
      const lName=g.winner==='A'?g.playerB:g.playerA;
      applyGameResult(wName,lName,date,g.map||'-',matchId);
    });
  });
  if(mode==='mini'){
    if(!bld.teamA||!bld.teamB)return alert('íŒ€ì„ ì„ íƒí•˜ì„¸ìš”.');
    miniM.unshift({_id:matchId,d:date,a:bld.teamA,b:bld.teamB,sa:totalA,sb:totalB,sets:setsSnap});
  } else if(mode==='univm'){
    if(!bld.teamA||!bld.teamB)return alert('íŒ€ì„ ì„ íƒí•˜ì„¸ìš”.');
    univM.unshift({_id:matchId,d:date,a:bld.teamA,b:bld.teamB,sa:totalA,sb:totalB,sets:setsSnap});
  } else if(mode==='ck'){
    const mA=bld.membersA||[];const mB=bld.membersB||[];
    if(!mA.length||!mB.length)return alert('íŒ€ ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
    const univW={},univL={};
    bld.sets.forEach(set=>{
      set.games.forEach(g=>{
        if(!g.playerA||!g.playerB||!g.winner)return;
        const wName=g.winner==='A'?g.playerA:g.playerB;
        const lName=g.winner==='A'?g.playerB:g.playerA;
        const wM=(g.winner==='A'?mA:mB).find(m=>m.name===wName);
        const lM=(g.winner==='A'?mB:mA).find(m=>m.name===lName);
        if(wM){univW[wM.univ]=(univW[wM.univ]||0)+1;}
        if(lM){univL[lM.univ]=(univL[lM.univ]||0)+1;}
      });
    });
    ckM.unshift({_id:matchId,d:date,sa:totalA,sb:totalB,
      teamALabel:'AíŒ€',
      teamBLabel:'BíŒ€',
      teamAMembers:mA,teamBMembers:mB,sets:setsSnap,
      univWins:univW,univLosses:univL
    });
  } else if(mode==='pro'){
    const mA=bld.membersA||[];const mB=bld.membersB||[];
    if(!mA.length||!mB.length)return alert('íŒ€ ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
    const univW={},univL={};
    bld.sets.forEach(set=>{
      set.games.forEach(g=>{
        if(!g.playerA||!g.playerB||!g.winner)return;
        const wName=g.winner==='A'?g.playerA:g.playerB;
        const lName=g.winner==='A'?g.playerB:g.playerA;
        const wM=(g.winner==='A'?mA:mB).find(m=>m.name===wName);
        const lM=(g.winner==='A'?mB:mA).find(m=>m.name===lName);
        if(wM){univW[wM.univ]=(univW[wM.univ]||0)+1;}
        if(lM){univL[lM.univ]=(univL[lM.univ]||0)+1;}
      });
    });
    proM.unshift({_id:matchId,d:date,sa:totalA,sb:totalB,
      teamALabel:'AíŒ€',
      teamBLabel:'BíŒ€',
      teamAMembers:mA,teamBMembers:mB,sets:setsSnap,
      univWins:univW,univLosses:univL
    });
  } else if(mode==='comp'){
    const cn=bld.compName||document.getElementById('comp-name-input')?.value||curComp||'';
    if(!cn)return alert('ëŒ€íšŒëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
    if(!bld.teamA||!bld.teamB)return alert('ëŒ€í•™ì„ ì„ íƒí•˜ì„¸ìš”.');
    if(cn&&!compNames.includes(cn))compNames.push(cn);
    curComp=cn;
    comps.unshift({_id:matchId,d:date,n:cn,hostUniv:bld.teamA,u:bld.teamA,a:bld.teamA,b:bld.teamB,sa:totalA,sb:totalB,sets:setsSnap});
  } else if(mode==='tt'){
    const mA=bld.membersA||[];const mB=bld.membersB||[];
    if(!mA.length||!mB.length)return alert('íŒ€ ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
    const tLabel=bld.tiers&&bld.tiers.length?bld.tiers.join('+')+'í‹°ì–´':'ì „ì²´';
    ttM.unshift({_id:matchId,d:date,sa:totalA,sb:totalB,
      teamALabel:'AíŒ€',teamBLabel:'BíŒ€',tierLabel:tLabel,
      teamAMembers:mA,teamBMembers:mB,sets:setsSnap
    });
  }
  BLD[mode]=null;if(typeof fixPoints==='function')fixPoints();save();
  if(mode==='mini')miniSub='records';
  else if(mode==='univm')univmSub='records';
  else if(mode==='ck')ckSub='records';
  else if(mode==='pro')proSub='records';
  else if(mode==='comp')compSub='records';
  else if(mode==='tt'){_ttSub='records';compSub='tiertour';}
  render();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë¯¸ë‹ˆëŒ€ì „
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rMini(C,T){
  T.innerText='âš¡ ë¯¸ë‹ˆëŒ€ì „';
  if(!isLoggedIn && miniSub==='input') miniSub='records';
  const subOpts=[{id:'input',lbl:'ğŸ“ ê²½ê¸° ì…ë ¥',fn:`miniSub='input';render()`},{id:'rank',lbl:'ğŸ† ìˆœìœ„',fn:`miniSub='rank';render()`},{id:'records',lbl:'ğŸ“‹ ê¸°ë¡',fn:`miniSub='records';openDetails={};render()`}];
  let h=stabs(miniSub,subOpts);
  if(miniSub!=='input' && typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('mini');
  }
  if(miniSub==='input'&&isLoggedIn){if(!BLD['mini'])BLD['mini']={date:'',title:'',teamA:'',teamB:'',sets:[]};h+=`<div class="match-builder"><h3>âš¡ ë¯¸ë‹ˆëŒ€ì „ ì…ë ¥</h3><div style="margin-bottom:12px"><button class="btn btn-p btn-sm" onclick="openPasteModal()" style="display:inline-flex;align-items:center;gap:5px">ğŸ“‹ ê²°ê³¼ ë¶™ì—¬ë„£ê¸° ì¼ê´„ ì…ë ¥</button><span style="font-size:11px;color:var(--gray-l);margin-left:8px">í…ìŠ¤íŠ¸/ì´ë¯¸ì§€ OCR ì§€ì›</span></div>${setBuilderHTML(BLD['mini'],'mini')}</div>`;}
  else if(miniSub==='rank'){h+=miniRankHTML();}
  else{h+=recSummaryListHTML(miniM,'mini','tab');}
  C.innerHTML=h;
}

function miniRankHTML(){
  const sc={};
  getAllUnivs().forEach(u=>{sc[u.name]={w:0,l:0,pts:0,total:0};});
  miniM.forEach(m=>{
    if(!sc[m.a])sc[m.a]={w:0,l:0,pts:0,total:0};if(!sc[m.b])sc[m.b]={w:0,l:0,pts:0,total:0};
    sc[m.a].total++;sc[m.b].total++;
    if(m.sa>m.sb){sc[m.a].w++;sc[m.a].pts+=3;sc[m.b].l++;sc[m.b].pts-=3;}
    else if(m.sb>m.sa){sc[m.b].w++;sc[m.b].pts+=3;sc[m.a].l++;sc[m.a].pts-=3;}
  });
  const sorted=Object.entries(sc).filter(([,s])=>s.total>0).sort((a,b)=>b[1].pts-a[1].pts);
  let h=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--blue);margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--blue-ll)">ğŸ† ë¯¸ë‹ˆëŒ€ì „ ëŒ€í•™ë³„ ìˆœìœ„</div>
  <table><thead><tr><th style="text-align:left">ìˆœìœ„</th><th style="text-align:left">ëŒ€í•™</th><th>ìŠ¹</th><th>íŒ¨</th><th>í¬ì¸íŠ¸</th></tr></thead><tbody>`;
  if(!sorted.length)h+=`<tr><td colspan="5" style="padding:30px;color:var(--gray-l)">ê¸°ë¡ ì—†ìŒ</td></tr>`;
  sorted.forEach(([name,s],i)=>{
    const col=gc(name);let rnkHTML;
    if(i===0) rnkHTML=`<span class="rk1">1ë“±</span>`;else if(i===1) rnkHTML=`<span class="rk2">2ë“±</span>`;else if(i===2) rnkHTML=`<span class="rk3">3ë“±</span>`;else rnkHTML=`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px">${i+1}ìœ„</span>`;
    h+=`<tr><td style="text-align:left">${rnkHTML}</td><td style="text-align:left"><span class="ubadge clickable-univ" style="background:${col}" onclick="openUnivModal('${name}')">${name}</span></td><td class="wt" style="font-size:15px;font-weight:800">${s.w}</td><td class="lt" style="font-size:15px;font-weight:800">${s.l}</td><td class="${pC(s.pts)}" style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px">${pS(s.pts)}</td></tr>`;
  });
  return h+`</tbody></table>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëŒ€í•™CK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rCK(C,T){
  T.innerText='ğŸ¤ ëŒ€í•™CK';
  if(!isLoggedIn && ckSub==='input') ckSub='records';
  const subOpts=[{id:'input',lbl:'ğŸ“ ê²½ê¸° ì…ë ¥',fn:`ckSub='input';render()`},{id:'rank',lbl:'ğŸ† ëŒ€í•™ ìˆœìœ„',fn:`ckSub='rank';render()`},{id:'records',lbl:'ğŸ“‹ ê¸°ë¡',fn:`ckSub='records';openDetails={};render()`}];
  let h=stabs(ckSub,subOpts);
  if(ckSub!=='input' && typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('ck');
  }
  if(ckSub==='input'&&isLoggedIn){if(!BLD['ck'])BLD['ck']={date:'',membersA:[],membersB:[],sets:[]};h+=buildCKInputHTML();}
  else if(ckSub==='rank'){h+=ckRankHTML();}
  else{h+=recSummaryListHTML(ckM,'ck','tab');}
  C.innerHTML=h;
}

function buildCKInputHTML(){
  const bld=BLD['ck'];const allU=getAllUnivs();
  const uO=`<option value="">ëŒ€í•™ ì„ íƒ</option>`+allU.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
  const mA=bld.membersA||[];const mB=bld.membersB||[];
  let h=`<div class="match-builder"><h3>ğŸ¤ ëŒ€í•™CK ì…ë ¥</h3>
    <div style="margin-bottom:14px;display:flex;align-items:center;gap:10px">
      <label style="font-size:12px;font-weight:700;color:var(--blue)">ë‚ ì§œ</label>
      <input type="date" value="${bld.date||''}" onchange="BLD['ck'].date=this.value">
    </div>

    <!-- ì„ ìˆ˜ ê²€ìƒ‰ìœ¼ë¡œ ë¹ ë¥¸ íŒ€ ì§œê¸° -->
    <div style="background:var(--blue-l);border:1px solid var(--blue-ll);border-radius:10px;padding:12px 14px;margin-bottom:16px">
      <div style="font-size:12px;font-weight:700;color:var(--blue);margin-bottom:8px">ğŸ” ì„ ìˆ˜ ê²€ìƒ‰ìœ¼ë¡œ ë¹ ë¥¸ íŒ€ ì§œê¸° <span style="font-weight:400;color:var(--gray-l)">(ì´ë¦„Â·ëŒ€í•™ ê²€ìƒ‰ í›„ AíŒ€/BíŒ€ ë°°ì •)</span></div>
      <div style="position:relative;display:flex;gap:6px;align-items:center">
        <input type="text" id="ck-search-input" placeholder="ì„ ìˆ˜ ì´ë¦„ ë˜ëŠ” ëŒ€í•™ ê²€ìƒ‰..." 
          style="flex:1;padding:8px 12px;border:1.5px solid var(--blue);border-radius:8px;font-size:13px"
          oninput="ckSearchPlayer()">
      </div>
      <div id="ck-search-results" style="display:none;margin-top:6px;background:var(--white);border:1px solid var(--border2);border-radius:8px;max-height:180px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,.1)"></div>
    </div>

    <div style="display:flex;gap:14px;flex-wrap:wrap;margin-bottom:16px">
      <div class="ck-panel">
        <h4>ğŸ”µ íŒ€ A êµ¬ì„± (${mA.length}ëª…)</h4>
        <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
          <select id="ck-a-univ" style="flex:1" onchange="ckFilterPlayers('A')">${uO}</select>
          <select id="ck-a-player" style="flex:1"><option value="">ëŒ€í•™ ë¨¼ì € ì„ íƒ</option></select>
          <button class="btn btn-b btn-xs" onclick="ckAddMember('A')">+ ì¶”ê°€</button>
        </div>
        <div>${mA.map((m,i)=>`<span class="mem-tag" style="background:${gc(m.univ)}">${m.name}<span style="font-size:10px;opacity:.8">(${m.univ}${m.tier?'/'+m.tier:''}${m.race?'/'+m.race:''})</span><button onclick="BLD['ck'].membersA.splice(${i},1);BLD['ck'].sets=[];render()">Ã—</button></span>`).join('')||'<span style="color:var(--gray-l);font-size:12px">ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”</span>'}</div>
      </div>
      <div class="ck-panel">
        <h4>ğŸ”´ íŒ€ B êµ¬ì„± (${mB.length}ëª…)</h4>
        <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
          <select id="ck-b-univ" style="flex:1" onchange="ckFilterPlayers('B')">${uO}</select>
          <select id="ck-b-player" style="flex:1"><option value="">ëŒ€í•™ ë¨¼ì € ì„ íƒ</option></select>
          <button class="btn btn-b btn-xs" onclick="ckAddMember('B')">+ ì¶”ê°€</button>
        </div>
        <div>${mB.map((m,i)=>`<span class="mem-tag" style="background:${gc(m.univ)}">${m.name}<span style="font-size:10px;opacity:.8">(${m.univ}${m.tier?'/'+m.tier:''}${m.race?'/'+m.race:''})</span><button onclick="BLD['ck'].membersB.splice(${i},1);BLD['ck'].sets=[];render()">Ã—</button></span>`).join('')||'<span style="color:var(--gray-l);font-size:12px">ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”</span>'}</div>
      </div>
    </div>`;
  h+=setBuilderHTML(bld,'ck');h+=`</div>`;return h;
}

function ckSearchPlayer(){
  const inp=document.getElementById('ck-search-input');
  const res=document.getElementById('ck-search-results');
  if(!inp||!res)return;
  const q=inp.value.trim().toLowerCase();
  if(!q){res.style.display='none';res.innerHTML='';return;}
  const bld=BLD['ck']||{};
  const already=[...(bld.membersA||[]),...(bld.membersB||[])].map(m=>m.name);
  const results=players.filter(p=>
    (p.name.toLowerCase().includes(q)||(p.univ||'').toLowerCase().includes(q)||(p.tier||'').toLowerCase().includes(q)||(p.race||'').toLowerCase().includes(q))
  ).slice(0,20);
  if(!results.length){res.innerHTML='<div style="padding:10px 12px;color:var(--gray-l);font-size:12px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';res.style.display='block';return;}
  res.innerHTML=results.map(p=>{
    const col=gc(p.univ);
    const inA=(bld.membersA||[]).some(m=>m.name===p.name);
    const inB=(bld.membersB||[]).some(m=>m.name===p.name);
    const inTeam=inA||inB;
    return `<div style="padding:8px 12px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);${inTeam?'opacity:.5;':''}">
      <span style="width:28px;height:28px;border-radius:6px;background:${col};color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0">${p.race||'?'}</span>
      <div style="flex:1;font-size:12px">
        <span style="font-weight:700">${p.name}</span>
        <span style="color:var(--gray-l);font-size:11px;margin-left:4px">${p.univ} Â· ${p.tier||'-'} Â· ${p.race||'-'}</span>
        ${inA?'<span style="background:#dbeafe;color:#1d4ed8;border-radius:3px;padding:1px 5px;font-size:10px;font-weight:700;margin-left:4px">AíŒ€</span>':''}
        ${inB?'<span style="background:#fee2e2;color:#dc2626;border-radius:3px;padding:1px 5px;font-size:10px;font-weight:700;margin-left:4px">BíŒ€</span>':''}
      </div>
      ${!inTeam?`
      <button onclick="ckAddBySearch('A','${p.name}')" style="background:#2563eb;color:#fff;border:none;border-radius:5px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer">AíŒ€</button>
      <button onclick="ckAddBySearch('B','${p.name}')" style="background:#dc2626;color:#fff;border:none;border-radius:5px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer">BíŒ€</button>
      `:'<span style="font-size:11px;color:var(--gray-l)">ë°°ì •ë¨</span>'}
    </div>`;
  }).join('');
  res.style.display='block';
}

function ckAddBySearch(team, name){
  if(!BLD['ck'])return;
  const arr=team==='A'?BLD['ck'].membersA:BLD['ck'].membersB;
  const other=team==='A'?BLD['ck'].membersB:BLD['ck'].membersA;
  if(arr.find(m=>m.name===name)||other.find(m=>m.name===name))return;
  const pObj=players.find(p=>p.name===name)||{};
  arr.push({name,univ:pObj.univ||'',race:pObj.race||'',tier:pObj.tier||''});
  BLD['ck'].sets=[];
  // ê²€ìƒ‰ ê²°ê³¼ ìƒˆë¡œê³ ì¹¨
  ckSearchPlayer();
  render();
}


function ckFilterPlayers(team){
  const univSel=document.getElementById(`ck-${team.toLowerCase()}-univ`);
  const playerSel=document.getElementById(`ck-${team.toLowerCase()}-player`);
  if(!univSel||!playerSel)return;
  const univ=univSel.value;
  const univMembers=univ?players.filter(p=>p.univ===univ):[];
  playerSel.innerHTML=univMembers.length?`<option value="">ë©¤ë²„ ì„ íƒ</option>`+univMembers.map(p=>`<option value="${p.name}">${p.name} [${p.tier||'-'}/${p.race||'-'}]</option>`).join(''):`<option value="">ë©¤ë²„ ì—†ìŒ</option>`;
}

function ckAddMember(team){
  const univSel=document.getElementById(`ck-${team.toLowerCase()}-univ`);
  const playerSel=document.getElementById(`ck-${team.toLowerCase()}-player`);
  if(!univSel||!playerSel)return;
  const univ=univSel.value;const name=playerSel.value;
  if(!name)return alert('ë©¤ë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  const arr=team==='A'?BLD['ck'].membersA:BLD['ck'].membersB;
  if(arr.find(m=>m.name===name))return alert('ì´ë¯¸ ì¶”ê°€ë¨');
  const pObj=players.find(p=>p.name===name)||{};
  arr.push({name,univ,race:pObj.race||'',tier:pObj.tier||''});BLD['ck'].sets=[];render();
}

function ckRankHTML(){
  const uS={};
  getAllUnivs().forEach(u=>{uS[u.name]={w:0,l:0,pts:0,total:0};});
  ckM.forEach(m=>{
    if(m.univWins)Object.entries(m.univWins).forEach(([u,c])=>{if(!uS[u])uS[u]={w:0,l:0,pts:0,total:0};uS[u].w+=c;uS[u].pts+=c*3;uS[u].total+=c;});
    if(m.univLosses)Object.entries(m.univLosses).forEach(([u,c])=>{if(!uS[u])uS[u]={w:0,l:0,pts:0,total:0};uS[u].l+=c;uS[u].pts-=c*3;uS[u].total+=c;});
  });
  const sorted=Object.entries(uS).filter(([,s])=>s.total>0).sort((a,b)=>b[1].pts-a[1].pts);
  let h=`<div style="font-size:11px;color:var(--gray-l);margin-bottom:10px">â€» ëŒ€í•™ ìˆœìœ„ë§Œ í‘œì‹œ (ì†Œì† ë©¤ë²„ ê°œë³„ í‘œì‹œ ì—†ìŒ)</div>
  <table><thead><tr><th style="text-align:left">ìˆœìœ„</th><th style="text-align:left">ëŒ€í•™</th><th>ê²Œì„ ìŠ¹</th><th>ê²Œì„ íŒ¨</th><th>í¬ì¸íŠ¸</th></tr></thead><tbody>`;
  if(!sorted.length)h+=`<tr><td colspan="5" style="padding:30px;color:var(--gray-l)">ê¸°ë¡ ì—†ìŒ</td></tr>`;
  sorted.forEach(([name,s],i)=>{
    const col=gc(name);let rnkHTML;
    if(i===0) rnkHTML=`<span class="rk1">1ë“±</span>`;else if(i===1) rnkHTML=`<span class="rk2">2ë“±</span>`;else if(i===2) rnkHTML=`<span class="rk3">3ë“±</span>`;else rnkHTML=`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px">${i+1}ìœ„</span>`;
    h+=`<tr><td style="text-align:left">${rnkHTML}</td><td style="text-align:left"><span class="ubadge clickable-univ" style="background:${col}" onclick="openUnivModal('${name}')">${name}</span></td><td class="wt" style="font-size:15px;font-weight:800">${s.w}</td><td class="lt" style="font-size:15px;font-weight:800">${s.l}</td><td class="${pC(s.pts)}" style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px">${pS(s.pts)}</td></tr>`;
  });
  return h+`</tbody></table>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëŒ€í•™ëŒ€ì „
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rUnivM(C,T){
  T.innerText='ğŸŸï¸ ëŒ€í•™ëŒ€ì „';
  if(!isLoggedIn && univmSub==='input') univmSub='records';
  const subOpts=[{id:'input',lbl:'ğŸ“ ê²½ê¸° ì…ë ¥',fn:`univmSub='input';render()`},{id:'rank',lbl:'ğŸ† ìˆœìœ„',fn:`univmSub='rank';render()`},{id:'records',lbl:'ğŸ“‹ ê¸°ë¡',fn:`univmSub='records';openDetails={};render()`}];
  let h=stabs(univmSub,subOpts);
  if(univmSub!=='input' && typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('univm');
  }
  if(univmSub==='input'&&isLoggedIn){if(!BLD['univm'])BLD['univm']={date:'',note:'',teamA:'',teamB:'',sets:[]};h+=`<div class="match-builder"><h3>ğŸŸï¸ ëŒ€í•™ëŒ€ì „ ì…ë ¥</h3><div style="margin-bottom:12px"><button class="btn btn-p btn-sm" onclick="openPasteModal()" style="display:inline-flex;align-items:center;gap:5px">ğŸ“‹ ê²°ê³¼ ë¶™ì—¬ë„£ê¸° ì¼ê´„ ì…ë ¥</button></div>${setBuilderHTML(BLD['univm'],'univm')}</div>`;}
  else if(univmSub==='rank'){h+=univMRankHTML();}
  else{h+=recSummaryListHTML(univM,'univm','tab');}
  C.innerHTML=h;
}

function univMRankHTML(){
  const sc={};
  getAllUnivs().forEach(u=>{sc[u.name]={w:0,l:0,pts:0,total:0};});
  univM.forEach(m=>{
    if(!sc[m.a])sc[m.a]={w:0,l:0,pts:0,total:0};if(!sc[m.b])sc[m.b]={w:0,l:0,pts:0,total:0};
    sc[m.a].total++;sc[m.b].total++;
    if(m.sa>m.sb){sc[m.a].w++;sc[m.a].pts+=3;sc[m.b].l++;sc[m.b].pts-=3;}
    else if(m.sb>m.sa){sc[m.b].w++;sc[m.b].pts+=3;sc[m.a].l++;sc[m.a].pts-=3;}
  });
  const sorted=Object.entries(sc).filter(([,s])=>s.total>0).sort((a,b)=>b[1].pts-a[1].pts);
  let h=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--blue);margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--blue-ll)">ğŸ† ëŒ€í•™ëŒ€ì „ ëŒ€í•™ë³„ ìˆœìœ„</div>
  <table><thead><tr><th style="text-align:left">ìˆœìœ„</th><th style="text-align:left">ëŒ€í•™</th><th>ìŠ¹</th><th>íŒ¨</th><th>í¬ì¸íŠ¸</th></tr></thead><tbody>`;
  if(!sorted.length)h+=`<tr><td colspan="5" style="padding:30px;color:var(--gray-l)">ê¸°ë¡ ì—†ìŒ</td></tr>`;
  sorted.forEach(([name,s],i)=>{
    const col=gc(name);let rnkHTML;
    if(i===0) rnkHTML=`<span class="rk1">1ë“±</span>`;else if(i===1) rnkHTML=`<span class="rk2">2ë“±</span>`;else if(i===2) rnkHTML=`<span class="rk3">3ë“±</span>`;else rnkHTML=`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px">${i+1}ìœ„</span>`;
    h+=`<tr><td style="text-align:left">${rnkHTML}</td><td style="text-align:left"><span class="ubadge clickable-univ" style="background:${col}" onclick="openUnivModal('${name}')">${name}</span></td><td class="wt" style="font-size:15px;font-weight:800">${s.w}</td><td class="lt" style="font-size:15px;font-weight:800">${s.l}</td><td class="${pC(s.pts)}" style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px">${pS(s.pts)}</td></tr>`;
  });
  return h+`</tbody></table>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í”„ë¡œë¦¬ê·¸ (ëŒ€í•™CK ë°©ì‹)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let proSub='records';

function rPro(C,T){
  T.innerText='ğŸ… í”„ë¡œë¦¬ê·¸';
  if(!isLoggedIn && proSub==='input') proSub='records';
  const subOpts=[
    {id:'input',lbl:'ğŸ“ ê²½ê¸° ì…ë ¥',fn:`proSub='input';render()`},
    {id:'rank',lbl:'ğŸ† ìˆœìœ„',fn:`proSub='rank';render()`},
    {id:'records',lbl:'ğŸ“‹ ê¸°ë¡',fn:`proSub='records';openDetails={};render()`}
  ];
  let h=stabs(proSub,subOpts);
  if(proSub!=='input' && typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('pro');
  }
  if(proSub==='input'&&isLoggedIn){
    if(!BLD['pro'])BLD['pro']={date:'',membersA:[],membersB:[],sets:[]};
    h+=buildProInputHTML();
  } else if(proSub==='rank'){
    h+=proRankHTML();
  } else {
    h+=recSummaryListHTML(proM,'pro','tab');
  }
  C.innerHTML=h;
}

function buildProInputHTML(){
  const bld=BLD['pro'];
  const mA=bld.membersA||[];const mB=bld.membersB||[];
  // í”„ë¡œë¦¬ê·¸ëŠ” god~1í‹°ì–´ê¹Œì§€ë§Œ í—ˆìš©
  const PRO_TIERS=['G','K','JA','J','S','0í‹°ì–´','1í‹°ì–´'];
  if(!bld.tierFilters)bld.tierFilters=[];
  const tf=bld.tierFilters;
  // god~1í‹°ì–´ ì„ ìˆ˜ (í´ë¦­ ëª©ë¡: ê¸°ë³¸ ë‚¨ì, ì´ë¯¸ íŒ€ì— ì¶”ê°€ëœ ì—¬ì„±ì€ í¬í•¨)
  const allAddedNames=new Set([...(bld.membersA||[]),...(bld.membersB||[])].map(m=>m.name));
  const eligible=players.filter(p=>
    PRO_TIERS.includes(p.tier) &&
    (tf.length===0||tf.includes(p.tier)) &&
    (p.gender==='M' || allAddedNames.has(p.name)) // ì—¬ìëŠ” ì´ë¯¸ ì¶”ê°€ëœ ê²½ìš°ë§Œ ëª©ë¡ì— í‘œì‹œ
  ).sort((a,b)=>{
    const ti=t=>PRO_TIERS.indexOf(t);
    return ti(a.tier)-ti(b.tier)||(a.name||'').localeCompare(b.name||'');
  });

  let h=`<div class="match-builder"><h3>ğŸ… í”„ë¡œë¦¬ê·¸ ì…ë ¥</h3>
    <div style="margin-bottom:12px"><button class="btn btn-p btn-sm" onclick="openPasteModal()" style="display:inline-flex;align-items:center;gap:5px">ğŸ“‹ ê²°ê³¼ ë¶™ì—¬ë„£ê¸° ì¼ê´„ ì…ë ¥</button><span style="font-size:11px;color:var(--gray-l);margin-left:8px">í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° ì§€ì›</span></div>
    <div style="margin-bottom:14px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <label style="font-size:12px;font-weight:700;color:var(--blue)">ë‚ ì§œ</label>
      <input type="date" value="${bld.date||''}" onchange="BLD['pro'].date=this.value">
    </div>

    <!-- â‘  ì°¸ê°€ í‹°ì–´ ì„ íƒ -->
    <div style="background:var(--blue-l);border:1px solid var(--blue-ll);border-radius:10px;padding:10px 14px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:var(--blue);margin-bottom:8px">â‘  ì°¸ê°€ í‹°ì–´ <span style="font-weight:400;color:var(--gray-l)">(ë³µìˆ˜ ì„ íƒ Â· god~1í‹°ì–´ Â· ê²€ìƒ‰ìœ¼ë¡œ ì—¬ì„± ì„ ìˆ˜ë„ ì¶”ê°€ ê°€ëŠ¥)</span></div>
      <div style="display:flex;gap:5px;flex-wrap:wrap">
        <button class="tier-filter-btn ${tf.length===0?'on':''}" onclick="BLD['pro'].tierFilters=[];BLD['pro'].membersA=[];BLD['pro'].membersB=[];BLD['pro'].sets=[];render()">ì „ì²´</button>
        ${PRO_TIERS.map(t=>`<button class="tier-filter-btn ${tf.includes(t)?'on':''}" onclick="proToggleTier('${t}')">${getTierLabel(t)}</button>`).join('')}
      </div>
      <div style="font-size:11px;color:var(--blue);margin-top:6px">ëŒ€ìƒ ì„ ìˆ˜: <strong>${eligible.length}ëª…</strong></div>
    </div>

    <!-- â‘¡ ì„ ìˆ˜ í´ë¦­ â†’ íŒ€ ë°°ì • -->
    <div style="margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:var(--text2);margin-bottom:8px">â‘¡ ì„ ìˆ˜ í´ë¦­ â†’ íŒ€ ë°°ì • <span style="font-weight:400;color:var(--gray-l);font-size:11px">(AíŒ€ / BíŒ€ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€)</span></div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;padding:10px;background:var(--surface);border:1px solid var(--border);border-radius:8px;max-height:220px;overflow-y:auto">
        ${eligible.length===0
          ?'<span style="color:var(--gray-l);font-size:12px">í‹°ì–´ë¥¼ ì„ íƒí•˜ë©´ ì„ ìˆ˜ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤</span>'
          :eligible.map(p=>{
              const inA=mA.some(m=>m.name===p.name);
              const inB=mB.some(m=>m.name===p.name);
              const bg=inA?'#2563eb':inB?'#dc2626':gc(p.univ);
              if(inA||inB){
                return `<span style="display:inline-flex;align-items:center;gap:3px;background:${bg};color:#fff;padding:4px 8px;border-radius:6px;font-size:11px;opacity:0.55">${p.name}${p.gender==='F'?'<span style="font-size:9px;color:#fda4af">â™€</span>':''}<span style="opacity:.8;font-size:10px;margin-left:2px">${p.univ}/${p.tier}</span><span style="background:rgba(255,255,255,.3);border-radius:2px;padding:0 4px;font-size:9px;font-weight:800;margin-left:3px">${inA?'AíŒ€':'BíŒ€'}</span></span>`;
              }
              return `<span style="display:inline-flex;align-items:center;gap:4px;background:${bg};color:#fff;padding:3px 6px;border-radius:6px;font-size:11px">
                <span style="font-weight:700">${p.name}${p.gender==='F'?'<span style="font-size:9px;color:#fda4af;margin-left:2px">â™€</span>':''}</span><span style="opacity:.8;font-size:10px">${p.univ}/${p.tier}</span>
                <button onclick="proAddPlayer('A','${p.name}')" style="background:var(--white);color:#2563eb;border:none;border-radius:3px;padding:1px 6px;font-size:10px;font-weight:800;cursor:pointer;margin-left:2px">AíŒ€</button>
                <button onclick="proAddPlayer('B','${p.name}')" style="background:var(--white);color:#dc2626;border:none;border-radius:3px;padding:1px 6px;font-size:10px;font-weight:800;cursor:pointer">BíŒ€</button>
              </span>`;
            }).join('')
        }
      </div>
    </div>

    <!-- â‘¢ íŒ€ êµ¬ì„± í™•ì¸ + ê²€ìƒ‰ ì¶”ê°€ -->
    <div style="display:flex;gap:14px;flex-wrap:wrap;margin-bottom:16px">
      <div class="ck-panel">
        <h4>ğŸ”µ íŒ€ A (${mA.length}ëª…)</h4>
        <div style="display:flex;gap:6px;margin-bottom:6px">
          <input type="text" id="pro-a-search" placeholder="ğŸ” ì´ë¦„Â·ë©”ëª¨ ê²€ìƒ‰..." style="flex:1;padding:5px 8px;border:1px solid var(--border2);border-radius:6px;font-size:12px" oninput="proSearchPlayer('A')">
        </div>
        <div id="pro-a-drop" style="display:none;max-height:140px;overflow-y:auto;border:1px solid var(--border2);border-radius:6px;background:var(--white);margin-bottom:6px"></div>
        <div>${mA.map((m,i)=>`<span class="mem-tag" style="background:${gc(m.univ)}">${m.name}<span style="font-size:10px;opacity:.8">(${m.univ}${m.tier?'/'+m.tier:''}${m.race?'/'+m.race:''})</span><button onclick="BLD['pro'].membersA.splice(${i},1);BLD['pro'].sets=[];render()">Ã—</button></span>`).join('')||'<span style="color:var(--gray-l);font-size:12px">ì„ ìˆ˜ ì—†ìŒ</span>'}</div>
      </div>
      <div class="ck-panel">
        <h4>ğŸ”´ íŒ€ B (${mB.length}ëª…)</h4>
        <div style="display:flex;gap:6px;margin-bottom:6px">
          <input type="text" id="pro-b-search" placeholder="ğŸ” ì´ë¦„Â·ë©”ëª¨ ê²€ìƒ‰..." style="flex:1;padding:5px 8px;border:1px solid var(--border2);border-radius:6px;font-size:12px" oninput="proSearchPlayer('B')">
        </div>
        <div id="pro-b-drop" style="display:none;max-height:140px;overflow-y:auto;border:1px solid var(--border2);border-radius:6px;background:var(--white);margin-bottom:6px"></div>
        <div>${mB.map((m,i)=>`<span class="mem-tag" style="background:${gc(m.univ)}">${m.name}<span style="font-size:10px;opacity:.8">(${m.univ}${m.tier?'/'+m.tier:''}${m.race?'/'+m.race:''})</span><button onclick="BLD['pro'].membersB.splice(${i},1);BLD['pro'].sets=[];render()">Ã—</button></span>`).join('')||'<span style="color:var(--gray-l);font-size:12px">ì„ ìˆ˜ ì—†ìŒ</span>'}</div>
      </div>
    </div>`;
  h+=setBuilderHTML(bld,'pro');h+=`</div>`;return h;
}

function proSearchPlayer(team){
  const searchEl=document.getElementById(`pro-${team.toLowerCase()}-search`);
  const dropEl=document.getElementById(`pro-${team.toLowerCase()}-drop`);
  if(!searchEl||!dropEl)return;
  const q=searchEl.value.trim().toLowerCase();
  if(!q){dropEl.style.display='none';dropEl.innerHTML='';return;}
  const PRO_TIERS=['G','K','JA','J','S','0í‹°ì–´','1í‹°ì–´'];
  const bld=BLD['pro']||{};
  const tf=bld.tierFilters||[];
  const already=[...(bld.membersA||[]),...(bld.membersB||[])].map(m=>m.name);
  // ê²€ìƒ‰ ì‹œì—ëŠ” gender ì œí•œ ì—†ìŒ (í˜¼ì„± ê²½ê¸° ì§€ì›) - ì—¬ì ì„ ìˆ˜ëŠ” í‹°ì–´ ë¬´ê´€í•˜ê²Œ ê²€ìƒ‰ ê°€ëŠ¥
  const results=players.filter(p=>
    (PRO_TIERS.includes(p.tier) || p.gender==='F') &&
    (tf.length===0||tf.includes(p.tier)||p.gender==='F') &&
    !already.includes(p.name) &&
    (p.name.toLowerCase().includes(q)||(p.memo||'').toLowerCase().includes(q)||(p.univ||'').toLowerCase().includes(q)||(p.tier||'').toLowerCase().includes(q))
  ).slice(0,20);
  if(!results.length){
    dropEl.innerHTML='<div style="padding:10px;color:var(--gray-l);font-size:12px;text-align:center">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
    dropEl.style.display='block';return;
  }
  dropEl.innerHTML=results.map(p=>`<div onclick="proAddPlayer('${team}','${p.name}');document.getElementById('pro-${team.toLowerCase()}-search').value='';document.getElementById('pro-${team.toLowerCase()}-drop').style.display='none'"
    style="padding:8px 12px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;font-size:12px"
    onmouseover="this.style.background='var(--blue-l)'" onmouseout="this.style.background=''">
    <span style="display:inline-block;width:28px;height:28px;border-radius:6px;background:${gc(p.univ)};color:#fff;text-align:center;line-height:28px;font-size:11px;font-weight:700;flex-shrink:0">${(p.race||'?').charAt(0)}</span>
    <div>
      <div style="font-weight:700">${p.name}${p.gender==='F'?'<span style="color:#ec4899;font-size:10px;margin-left:3px">â™€</span>':''} <span style="font-size:10px;background:${gc(p.univ)};color:#fff;padding:1px 5px;border-radius:3px">${p.univ}</span></div>
      <div style="font-size:10px;color:var(--gray-l)">${p.tier||'-'} Â· ${p.race||'-'}${p.memo?` Â· ${p.memo.slice(0,20)}`:''}</div>
    </div>
  </div>`).join('');
  dropEl.style.display='block';
}

function proAddPlayerDirect(team, name){
  const bld=BLD['pro'];if(!bld)return;
  const arr=team==='A'?bld.membersA:bld.membersB;
  if(arr.find(m=>m.name===name))return;
  const pObj=players.find(p=>p.name===name)||{};
  arr.push({name,univ:pObj.univ||'',race:pObj.race||'',tier:pObj.tier||''});
  bld.sets=[];
  const searchEl=document.getElementById(`pro-${team.toLowerCase()}-search`);
  const dropEl=document.getElementById(`pro-${team.toLowerCase()}-drop`);
  if(searchEl)searchEl.value='';
  if(dropEl){dropEl.style.display='none';dropEl.innerHTML='';}
  render();
}

function proAddPlayer(team, name){
  const bld=BLD['pro'];if(!bld)return;
  const all=[...(bld.membersA||[]),...(bld.membersB||[])];
  if(all.find(m=>m.name===name))return;
  const pObj=players.find(p=>p.name===name)||{};
  const mem={name,univ:pObj.univ||'',race:pObj.race||'',tier:pObj.tier||''};
  if(team==='A')bld.membersA.push(mem);else bld.membersB.push(mem);
  bld.sets=[];render();
}

function proToggleTier(t){
  const bld=BLD['pro'];if(!bld)return;
  if(!bld.tierFilters)bld.tierFilters=[];
  const idx=bld.tierFilters.indexOf(t);
  if(idx>=0)bld.tierFilters.splice(idx,1);else bld.tierFilters.push(t);
  bld.membersA=[];bld.membersB=[];bld.sets=[];render();
}

function proFilterPlayers(team){
  const univSel=document.getElementById(`pro-${team.toLowerCase()}-univ`);
  const playerSel=document.getElementById(`pro-${team.toLowerCase()}-player`);
  if(!univSel||!playerSel)return;
  const univ=univSel.value;
  const bld=BLD['pro']||{};const tf=(bld.tierFilters||[]);
  // í‹°ì–´ í•„í„° ì ìš© (ë‹¤ì¤‘ì„ íƒ: ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´)
  const mems=univ?players.filter(p=>p.univ===univ&&p.gender==='M'&&(tf.length===0||tf.includes(p.tier))):[];
  playerSel.innerHTML=mems.length?`<option value="">ë©¤ë²„ ì„ íƒ</option>`+mems.map(p=>`<option value="${p.name}">${p.name} [${p.tier||'-'}/${p.race||'-'}]</option>`).join(''):`<option value="">ë©¤ë²„ ì—†ìŒ</option>`;
}

function proAddMember(team){
  const univSel=document.getElementById(`pro-${team.toLowerCase()}-univ`);
  const playerSel=document.getElementById(`pro-${team.toLowerCase()}-player`);
  if(!univSel||!playerSel)return;
  const univ=univSel.value;const name=playerSel.value;
  if(!name)return alert('ë©¤ë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  const arr=team==='A'?BLD['pro'].membersA:BLD['pro'].membersB;
  if(arr.find(m=>m.name===name))return alert('ì´ë¯¸ ì¶”ê°€ë¨');
  const pObj=players.find(p=>p.name===name)||{};
  arr.push({name,univ,race:pObj.race||'',tier:pObj.tier||''});BLD['pro'].sets=[];render();
}

function proRankHTML(){
  // ì„ ìˆ˜ë³„ í”„ë¡œë¦¬ê·¸ ìŠ¹/íŒ¨ ì§‘ê³„
  const pStats={};
  proM.forEach(m=>{
    (m.sets||[]).forEach(set=>{
      (set.games||[]).forEach(g=>{
        if(!g.playerA||!g.playerB||!g.winner)return;
        const wName=g.winner==='A'?g.playerA:g.playerB;
        const lName=g.winner==='A'?g.playerB:g.playerA;
        if(!pStats[wName])pStats[wName]={w:0,l:0};
        if(!pStats[lName])pStats[lName]={w:0,l:0};
        pStats[wName].w++;
        pStats[lName].l++;
      });
    });
  });
  const sorted=Object.entries(pStats)
    .map(([name,s])=>({name,w:s.w,l:s.l,total:s.w+s.l,rate:s.w+s.l===0?0:Math.round(s.w/(s.w+s.l)*100)}))
    .filter(p=>p.total>0)
    .sort((a,b)=>b.rate-a.rate||b.w-a.w||a.l-b.l);
  let h=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--blue);margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--blue-ll)">ğŸ… í”„ë¡œ ìˆœìœ„</div>
  <table><thead><tr><th style="text-align:left">ìˆœìœ„</th><th style="text-align:left">ì„ ìˆ˜</th><th style="text-align:left">ëŒ€í•™</th><th>í‹°ì–´</th><th>ìŠ¹</th><th>íŒ¨</th><th>ìŠ¹ë¥ </th></tr></thead><tbody>`;
  if(!sorted.length)h+=`<tr><td colspan="7" style="padding:30px;color:var(--gray-l)">ê¸°ë¡ ì—†ìŒ</td></tr>`;
  sorted.forEach((p,i)=>{
    const pObj=players.find(x=>x.name===p.name)||{};
    const col=gc(pObj.univ);
    let rnkHTML;
    if(i===0)rnkHTML=`<span class="rk1">1ë“±</span>`;
    else if(i===1)rnkHTML=`<span class="rk2">2ë“±</span>`;
    else if(i===2)rnkHTML=`<span class="rk3">3ë“±</span>`;
    else rnkHTML=`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px">${i+1}ìœ„</span>`;
    h+=`<tr>
      <td style="text-align:left">${rnkHTML}</td>
      <td style="font-weight:700;cursor:pointer;color:var(--blue);text-align:left" onclick="openPlayerModal('${p.name}')"><span style="display:inline-flex;align-items:center;gap:6px">${getPlayerPhotoHTML(p.name,'24px')}${p.name}${getStatusIconHTML(p.name)}</span></td>
      <td style="text-align:left"><span class="ubadge clickable-univ" style="background:${col}" onclick="openUnivModal('${pObj.univ||''}')">${pObj.univ||'-'}</span></td>
      <td style="text-align:center">${pObj.tier?getTierBadge(pObj.tier):'-'}</td>
      <td class="wt" style="font-size:15px;font-weight:800">${p.w}</td>
      <td class="lt" style="font-size:15px;font-weight:800">${p.l}</td>
      <td class="${p.rate>=50?'wt':'lt'}" style="font-weight:800">${p.rate}%</td>
    </tr>`;
  });
  return h+`</tbody></table>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëŒ€íšŒ (ì¡°ë³„ë¦¬ê·¸ + ì¡°í¸ì„± ê´€ë¦¬ + ëŒ€ì§„í‘œ + ê°œì¸ìˆœìœ„)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let leagueFilterDate='';
let leagueFilterGrp='';
let grpRankFilter='';
let grpSub='list';
let grpEditId=null;
let grpMatchState={tnId:null,gi:null,mi:null};

function getCurrentTourney(){
  return tourneys.find(t=>t.name===curComp)||tourneys[0]||null;
}

function rComp(C,T){
  T.innerText='ğŸ–ï¸ ëŒ€íšŒ';
  if(!isLoggedIn && compSub==='grpedit') compSub='league';

  const tn=getCurrentTourney();
  const tnType=tn?tn.type||'league':'league'; // 'league' or 'tier'

  let h=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap;padding:12px 16px;background:var(--gold-bg);border:1px solid var(--gold-b);border-radius:10px">
    <span style="font-weight:700;color:var(--gold);white-space:nowrap">ğŸ–ï¸ ëŒ€íšŒ ì„ íƒ:</span>
    <select style="flex:1;max-width:220px;font-weight:700" onchange="curComp=this.value;leagueFilterDate='';leagueFilterGrp='';grpRankFilter='';save();render()">
      <option value="">â€” ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš” â€”</option>
      ${tourneys.map(t=>`<option value="${t.name}"${curComp===t.name?' selected':''}>${t.name}${t.type==='tier'?' ğŸ¯':''}</option>`).join('')}
    </select>
    ${isLoggedIn?`<button class="btn btn-b btn-xs" onclick="grpNewLeagueTourney()">+ ì¼ë°˜ ëŒ€íšŒ</button><button class="btn btn-p btn-xs" onclick="grpNewTierTourney()">+ í‹°ì–´ ëŒ€íšŒ</button>`:''}
    ${tn&&isLoggedIn?`<button class="btn btn-w btn-xs" onclick="grpRenameTourney()" title="ëŒ€íšŒëª… ìˆ˜ì •">âœï¸ ì´ë¦„ìˆ˜ì •</button><button class="btn btn-r btn-xs" onclick="grpDelCurTourney()" title="í˜„ì¬ ëŒ€íšŒ ì‚­ì œ">ğŸ—‘ï¸ ì‚­ì œ</button>`:''}
    ${tn?`<span style="font-size:11px;color:var(--gray-l)">${tnType==='tier'?'ğŸ¯ í‹°ì–´ëŒ€íšŒ':('ğŸ† '+tn.groups.length+'ê°œ ì¡° Â· '+tn.groups.reduce((s,g)=>s+(g.matches||[]).length,0)+'ê²½ê¸°')}</span>`:''}
  </div>`;

  // ëŒ€íšŒ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ ì„œë¸Œë©”ë‰´
  let subOpts;
  if(tnType==='tier'){
    // í‹°ì–´ë³„ ëŒ€íšŒ ì „ìš© ë©”ë‰´
    subOpts=[{id:'tiertour',lbl:'ğŸ¯ í‹°ì–´ëŒ€íšŒ'}];
    if(compSub!=='tiertour') compSub='tiertour';
  } else {
    // ì¼ë°˜ ëŒ€íšŒ ë©”ë‰´ (tiertour ì œì™¸)
    subOpts=[
      {id:'league',lbl:'ğŸ“… ì¡°ë³„ë¦¬ê·¸ ì¼ì •'},
      {id:'grprank',lbl:'ğŸ“Š ì¡°ë³„ ìˆœìœ„'},
      {id:'tour',lbl:'âš”ï¸ ëŒ€ì§„í‘œ'},
      {id:'comprank',lbl:'ğŸ… ê°œì¸ ìˆœìœ„'},
      ...(isLoggedIn?[{id:'grpedit',lbl:'ğŸ—ï¸ ì¡°í¸ì„± ê´€ë¦¬'}]:[]),
    ];
    if(compSub==='tiertour') compSub='league';
  }
  h+=`<div class="stabs no-export">${subOpts.map(o=>`<button class="stab ${compSub===o.id?'on':''}" onclick="compSub='${o.id}';render()">${o.lbl}</button>`).join('')}</div>`;

  if(!tn && compSub!=='grpedit'){
    h+=`<div style="padding:60px 20px;text-align:center;background:var(--surface);border-radius:12px;border:2px dashed var(--border2)">
      <div style="font-size:44px;margin-bottom:14px">ğŸ†</div>
      <div style="font-size:16px;font-weight:700;margin-bottom:8px">ë“±ë¡ëœ ëŒ€íšŒê°€ ì—†ìŠµë‹ˆë‹¤</div>
      <div style="color:var(--gray-l);margin-bottom:20px">ìƒˆ ëŒ€íšŒë¥¼ ë§Œë“¤ì–´ ì¡°í¸ì„±ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
      ${isLoggedIn?`<button class="btn btn-b" onclick="grpNewLeagueTourney()">+ ì¼ë°˜ ëŒ€íšŒ ë§Œë“¤ê¸°</button> <button class="btn btn-p" onclick="grpNewTierTourney()">+ í‹°ì–´ ëŒ€íšŒ ë§Œë“¤ê¸°</button>`:''}
    </div>`;
    C.innerHTML=h; return;
  }

  if(compSub==='league') h+=rCompLeague(tn);
  else if(compSub==='grprank') h+=rCompGrpRankFull(tn);
  else if(compSub==='tour') h+=rCompTour();
  else if(compSub==='comprank') h+=rCompPlayerRank(tn);
  else if(compSub==='grpedit') h+=rCompGrpEdit();
  else if(compSub==='tiertour') h+=rTierTour();
  C.innerHTML=h;
}

function rCompLeague(tn){
  if(!tn) return `<div style="padding:30px;text-align:center;color:var(--gray-l)">ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>`;
  const allMatches=[];
  tn.groups.forEach((grp,gi)=>{
    const gl='ABCDEFGHIJ'[gi]||gi;
    const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
    (grp.matches||[]).forEach((m,mi)=>{
      allMatches.push({...m,grpName:grp.name,grpIdx:gi,grpLetter:gl,matchNum:mi+1,grpColor:col});
    });
  });
  allMatches.sort((a,b)=>(a.d||'9999').localeCompare(b.d||'9999'));
  const dates=[...new Set(allMatches.map(m=>m.d).filter(Boolean))].sort();
  let h=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--blue);margin-bottom:12px">ğŸ† ${tn.name}</div>`;
  h+=`<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px;padding-bottom:10px;border-bottom:2px solid var(--border)">
    <button class="pill ${!leagueFilterDate?'on':''}" onclick="leagueFilterDate='';render()">ì „ì²´</button>`;
  dates.forEach(d=>{
    const dt=new Date(d+'T00:00:00');const days=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    h+=`<button class="pill ${leagueFilterDate===d?'on':''}" onclick="leagueFilterDate='${d}';render()">${dt.getMonth()+1}/${dt.getDate()}(${days[dt.getDay()]})</button>`;
  });
  h+=`</div>`;
  if(tn.groups.length>1){
    h+=`<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px;align-items:center"><span style="font-size:11px;font-weight:700;color:var(--gray-l)">ì¡°:</span>
      <button class="pill ${!leagueFilterGrp?'on':''}" onclick="leagueFilterGrp='';render()">ì „ì²´</button>`;
    tn.groups.forEach((grp,gi)=>{
      const gl='ABCDEFGHIJ'[gi];const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
      h+=`<button class="pill ${leagueFilterGrp===grp.name?'on':''}" style="${leagueFilterGrp===grp.name?`background:${col};border-color:${col};color:#fff`:''}" onclick="leagueFilterGrp='${grp.name}';render()">GROUP ${gl}</button>`;
    });
    h+=`</div>`;
  }
  let filtered=allMatches;
  if(leagueFilterDate) filtered=filtered.filter(m=>m.d===leagueFilterDate);
  if(leagueFilterGrp) filtered=filtered.filter(m=>m.grpName===leagueFilterGrp);
  if(!filtered.length){
    h+=`<div style="padding:40px;text-align:center;color:var(--gray-l);background:var(--surface);border-radius:10px">
      ${allMatches.length?'í•´ë‹¹ ì¡°ê±´ì˜ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.':'ì•„ì§ ë“±ë¡ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.'}
      ${isLoggedIn?`<br><br><button class="btn btn-b btn-sm" onclick="compSub='grpedit';render()">+ ì¡°í¸ì„± ê´€ë¦¬ì—ì„œ ê²½ê¸° ì¶”ê°€</button>`:''}
    </div>`;
    return h;
  }
  const byDate={};
  filtered.forEach(m=>{const k=m.d||'ë‚ ì§œ ë¯¸ì •';if(!byDate[k])byDate[k]=[];byDate[k].push(m);});
  Object.keys(byDate).sort().forEach(date=>{
    let dateLabel=date;
    if(date!=='ë‚ ì§œ ë¯¸ì •'){
      const dt=new Date(date+'T00:00:00');
      const days=['ì¼ìš”ì¼','ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼','í† ìš”ì¼'];
      dateLabel=`${dt.getFullYear()}ë…„ ${dt.getMonth()+1}ì›” ${dt.getDate()}ì¼ ${days[dt.getDay()]}`;
    }
    h+=`<div style="margin-bottom:22px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <div style="flex:1;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px;color:#1e3a8a;padding:8px 16px;background:linear-gradient(90deg,#1e3a8a10,transparent);border-left:4px solid #2563eb;border-radius:0 8px 8px 0">ğŸ“… ${dateLabel}</div>
        ${isLoggedIn?`<button class="btn btn-b btn-xs no-export" onclick="grpAddMatchByDate('${tn.id}','${date}')">+ ê²½ê¸° ì¶”ê°€</button>`:''}
      </div>`;
    byDate[date].forEach(m=>{
      const ca=gc(m.a||'');const cb=gc(m.b||'');
      const isDone=m.sa!=null&&m.sb!=null;
      const aWin=isDone&&m.sa>m.sb;const bWin=isDone&&m.sb>m.sa;
      const detId=`ld-${m.grpIdx}-${m.matchNum-1}`;
      const hasDetail=isDone&&m.sets&&m.sets.some(s=>(s.games||[]).some(g=>g.playerA||g.playerB));
      h+=`<div class="grp-match-card" style="background:linear-gradient(135deg,var(--white) 0%,var(--blue-l) 100%);border:1.5px solid ${m.grpColor}22;border-left:4px solid ${m.grpColor};box-shadow:0 2px 12px rgba(0,0,0,.06);">
        <div style="display:flex;flex-direction:column;align-items:center;gap:3px;min-width:72px">
          <span class="grp-badge" style="background:linear-gradient(135deg,${m.grpColor},${m.grpColor}cc);font-size:10px;letter-spacing:.5px;box-shadow:0 2px 6px ${m.grpColor}55">GROUP ${m.grpLetter}</span>
          <span style="font-size:10px;color:var(--gray-l);font-weight:600">${m.matchNum}ê²½ê¸°</span>
          ${isDone?`<span style="background:linear-gradient(135deg,#dcfce7,#bbf7d0);color:#16a34a;font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;border:1px solid #86efac">âœ“ ì™„ë£Œ</span>`:`<span style="background:#f1f5f9;color:var(--gray-l);font-size:10px;padding:2px 8px;border-radius:10px;border:1px solid var(--border)">ì˜ˆì •</span>`}
        </div>
        <div style="flex:1;display:flex;align-items:center;gap:10px;justify-content:center;flex-wrap:wrap">
          <div style="text-align:center;min-width:100px">
            <div style="display:flex;align-items:center;justify-content:center;gap:7px;background:${ca||'#888'};padding:10px 16px;border-radius:12px;cursor:pointer;transition:.15s;${aWin?'box-shadow:0 0 0 3px #fff,0 0 0 5px '+ca+',0 6px 18px '+ca+'66':isDone?'opacity:.5;filter:saturate(0.6)':''}" onclick="openUnivModal('${m.a||''}')">
              ${(()=>{const url=UNIV_ICONS[m.a]||(univCfg.find(x=>x.name===m.a)||{}).icon||'';return url?`<img src="${url}" style="width:28px;height:28px;object-fit:contain;border-radius:5px;flex-shrink:0" onerror="this.style.display='none'">`:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='24' height='24'><path d='M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z'/></svg>`;})()}
              <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:#fff">${m.a||'â€”'}</span>
            </div>
          </div>
          <div style="text-align:center;min-width:80px">
            ${isDone?`<div class="grp-match-score score-click" style="cursor:pointer;padding:6px 14px;background:var(--white);border-radius:12px;border:1.5px solid var(--border);box-shadow:0 2px 8px rgba(0,0,0,.08)" onclick="leagueToggleDet('${detId}',document.getElementById('detbtn-${detId}'))"><span style="color:${aWin?'#16a34a':bWin?'#dc2626':'var(--text)'}">${m.sa}</span><span style="color:var(--gray-l);font-size:14px;margin:0 3px">:</span><span style="color:${bWin?'#16a34a':aWin?'#dc2626':'var(--text)'}">${m.sb}</span></div>
            <div style="display:flex;align-items:center;justify-content:center;gap:4px;margin-top:5px">${(()=>{const winTeam=aWin?m.a:bWin?m.b:'';if(!winTeam)return '<span style="font-size:10px;color:var(--gray-l)">ë¬´ìŠ¹ë¶€</span>';const url=UNIV_ICONS[winTeam]||(univCfg.find(x=>x.name===winTeam)||{}).icon||'';return url?`<img src="${url}" style="width:18px;height:18px;object-fit:contain;border-radius:3px" onerror="this.style.display='none'"><span style="font-size:10px;font-weight:700;color:${aWin?ca:cb}">${winTeam} ìŠ¹</span>`:`<span style="font-size:10px;font-weight:700;color:${aWin?ca:cb}">${winTeam} ìŠ¹</span>`;})()}</div>
            ${isDone?`<button id="detbtn-${detId}" class="btn-detail" style="margin-top:4px;font-size:10px" onclick="leagueToggleDet('${detId}',this)">ìƒì„¸ â–¼</button>`:''}
            `:`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:22px;color:${m.grpColor};text-shadow:0 1px 8px ${m.grpColor}44">VS</div>`}
          </div>
          <div style="text-align:center;min-width:100px">
            <div style="display:flex;align-items:center;justify-content:center;gap:7px;background:${cb||'#888'};padding:10px 16px;border-radius:12px;cursor:pointer;transition:.15s;${bWin?'box-shadow:0 0 0 3px #fff,0 0 0 5px '+cb+',0 6px 18px '+cb+'66':isDone?'opacity:.5;filter:saturate(0.6)':''}" onclick="openUnivModal('${m.b||''}')">
              ${(()=>{const url=UNIV_ICONS[m.b]||(univCfg.find(x=>x.name===m.b)||{}).icon||'';return url?`<img src="${url}" style="width:28px;height:28px;object-fit:contain;border-radius:5px;flex-shrink:0" onerror="this.style.display='none'">`:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='24' height='24'><path d='M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z'/></svg>`;})()}
              <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:#fff">${m.b||'â€”'}</span>
            </div>
          </div>
        </div>
        ${isLoggedIn?`<div class="no-export" style="display:flex;flex-direction:column;gap:4px">
          <button class="btn btn-b btn-xs" style="white-space:nowrap" onclick="leagueEditMatch('${tn.id}',${m.grpIdx},${m.matchNum-1})">âœï¸ ê²°ê³¼</button>
          <button class="btn btn-r btn-xs" onclick="grpDelMatch('${tn.id}',${m.grpIdx},${m.matchNum-1})">ì‚­ì œ</button>
        </div>`:''}
      </div>
      <div id="${detId}" style="display:none;margin-top:-4px;margin-bottom:8px;padding:14px 16px;background:var(--surface);border-radius:0 0 10px 10px;border:1px solid var(--border);border-top:none">
        ${isDone?buildDetailHTML(m,'comp',m.a||'AíŒ€',m.b||'BíŒ€',ca,cb,aWin,bWin):'<div style="font-size:12px;color:var(--gray-l)">ì•„ì§ ê²½ê¸°ê°€ ì§„í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>'}
        ${isDone?`<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border);display:flex;gap:6px;align-items:center;flex-wrap:wrap" class="no-export">
          <button class="btn-capture btn-xs" onclick="captureDetail('${detId}','ëŒ€íšŒ_${(m.d||'match').replace(/\//g,'-')}')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
          <button class="btn btn-p btn-xs" onclick="openCompMatchShareCard('${tn.id}',${m.grpIdx},${m.matchNum-1})">ğŸ´ ê³µìœ  ì¹´ë“œ</button>
        </div>`:''}
      </div>`;
    });
    h+=`</div>`;
  });
  return h;
}

function leagueToggleDet(id,btn){
  const el=document.getElementById(id);if(!el)return;
  const open=el.style.display==='none'||!el.style.display;
  el.style.display=open?'block':'none';
  const detBtn=btn||document.getElementById('detbtn-'+id);
  if(detBtn){detBtn.textContent=open?'ë‹«ê¸° â–²':'ìƒì„¸ ë³´ê¸° â–¼';detBtn.classList.toggle('open',open);}
}

function leagueEditMatch(tnId,gi,mi){
  grpMatchState={tnId,gi,mi};
  const tn=tourneys.find(t=>t.id===tnId);
  if(tn)grpOpenMatchModal(tn,gi,mi);
}

function grpMatchDetail(m){
  if(!m.sets||!m.sets.length) return `<div style="font-size:12px;color:var(--gray-l)">ìƒì„¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  let h=`<div style="font-size:12px;font-weight:700;color:var(--text2);margin-bottom:8px">ğŸ” ì„¸ë¶€ ê²½ê¸° ê¸°ë¡</div>`;
  m.sets.forEach((set,si)=>{
    const lbl=si===2?'ğŸ¯ ì—ì´ìŠ¤ì „':`${si+1}ì„¸íŠ¸`;
    const sA=set.scoreA||0;const sB=set.scoreB||0;
    h+=`<div style="margin-bottom:10px">
      <div style="display:flex;align-items:center;gap:8px;padding:5px 10px;background:${si===2?'#f5f3ff':'var(--blue-l)'};border-radius:6px;margin-bottom:6px">
        <strong style="font-size:11px;color:${si===2?'#7c3aed':'var(--blue)'}">${lbl}</strong>
        <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px"><span class="${sA>sB?'wt':''}">${sA}</span><span style="color:var(--gray-l)">:</span><span class="${sB>sA?'wt':''}">${sB}</span></span>
        <span style="font-size:11px;font-weight:700;color:${sA>sB?'var(--green)':sB>sA?'var(--red)':'var(--gray-l)'}">${sA>sB?(m.a||'AíŒ€')+' ìŠ¹':sB>sA?(m.b||'BíŒ€')+' ìŠ¹':'ë¬´ìŠ¹ë¶€'}</span>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:5px">`;
    (set.games||[]).forEach((g,gi)=>{
      if(!g.playerA&&!g.playerB)return;
      const pa=players.find(p=>p.name===g.playerA);const pb=players.find(p=>p.name===g.playerB);
      const wA=g.winner==='A';const wB=g.winner==='B';
      h+=`<div style="font-size:11px;background:var(--white);padding:5px 10px;border-radius:6px;border:1px solid var(--border);display:flex;align-items:center;gap:4px">
        <span style="font-size:10px;color:var(--gray-l);min-width:14px">${gi+1}</span>
        <span style="font-weight:${wA?'800':'400'};color:${wA?'var(--green)':'var(--text)'}">${g.playerA||'?'}</span>
        ${pa?`<span class="rbadge r${pa.race}" style="font-size:9px;padding:0 3px">${pa.race||''}</span>`:''}
        <span style="color:var(--gray-l);font-size:10px">vs</span>
        <span style="font-weight:${wB?'800':'400'};color:${wB?'var(--green)':'var(--text)'}">${g.playerB||'?'}</span>
        ${pb?`<span class="rbadge r${pb.race}" style="font-size:9px;padding:0 3px">${pb.race||''}</span>`:''}
        ${g.map?`<span style="color:var(--gray-l);font-size:10px;margin-left:2px">[${g.map}]</span>`:''}
      </div>`;
    });
    h+=`</div></div>`;
  });
  return h;
}

function rCompGrpRankFull(tn){
  if(!tn) return `<div style="padding:30px;text-align:center;color:var(--gray-l)">ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>`;
  const GL='ABCDEFGHIJ';
  let h=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--blue);margin-bottom:4px">ğŸ“Š ${tn.name} â€” ì¡°ë³„ ìˆœìœ„</div>
  <div style="font-size:11px;color:var(--gray-l);margin-bottom:14px">ìŠ¹ì  â†’ ì„¸íŠ¸ ë“ì‹¤ â†’ ë“ì  ìˆœ Â· ìƒìœ„ 2íŒ€ í† ë„ˆë¨¼íŠ¸ ì§„ì¶œ</div>`;
  if(tn.groups.length>1){
    h+=`<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:14px">
      <button class="pill ${!grpRankFilter?'on':''}" onclick="grpRankFilter='';render()">ì „ì²´</button>`;
    tn.groups.forEach((grp,gi)=>{
      const gl=GL[gi];const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
      h+=`<button class="pill ${grpRankFilter===grp.name?'on':''}" style="${grpRankFilter===grp.name?`background:${col};border-color:${col};color:#fff`:''}" onclick="grpRankFilter='${grp.name}';render()">GROUP ${gl}</button>`;
    });
    h+=`</div>`;
  }
  const targetGroups=grpRankFilter?tn.groups.filter(g=>g.name===grpRankFilter):tn.groups;
  targetGroups.forEach(grp=>{
    const gi=tn.groups.indexOf(grp);const gl=GL[gi]||gi;
    const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
    const sc={};
    grp.univs.forEach(u=>{sc[u]={w:0,l:0,gw:0,gl2:0,pts:0,played:0};});
    (grp.matches||[]).forEach(m=>{
      if(m.sa==null||m.sb==null)return;
      if(!sc[m.a])sc[m.a]={w:0,l:0,gw:0,gl2:0,pts:0,played:0};
      if(!sc[m.b])sc[m.b]={w:0,l:0,gw:0,gl2:0,pts:0,played:0};
      sc[m.a].played++;sc[m.b].played++;
      sc[m.a].gw+=m.sa;sc[m.a].gl2+=m.sb;sc[m.b].gw+=m.sb;sc[m.b].gl2+=m.sa;
      if(m.sa>m.sb){sc[m.a].w++;sc[m.a].pts+=3;sc[m.b].l++;}
      else if(m.sb>m.sa){sc[m.b].w++;sc[m.b].pts+=3;sc[m.a].l++;}
      else{sc[m.a].pts++;sc[m.b].pts++;}
    });
    const sorted=Object.entries(sc).sort((a,b)=>b[1].pts-a[1].pts||(b[1].gw-b[1].gl2)-(a[1].gw-a[1].gl2)||b[1].gw-a[1].gw);
    const played=grp.matches.filter(m=>m.sa!=null).length;
    h+=`<div style="background:var(--white);border:1.5px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap">
        <span style="background:${col};color:#fff;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px;padding:3px 14px;border-radius:20px">GROUP ${gl}</span>
        <span style="font-size:11px;color:var(--gray-l)">${played}/${grp.matches.length}ê²½ê¸° ì™„ë£Œ</span>
        <div style="margin-left:auto;display:flex;gap:5px;flex-wrap:wrap">${grp.univs.map(u=>`<span class="ubadge" style="background:${gc(u)};font-size:11px">${gUI(u,'10px')}${u}</span>`).join('')}</div>
      </div>
      <table class="grp-rank-table"><thead><tr><th>ìˆœìœ„</th><th>ëŒ€í•™</th><th>ê²½ê¸°</th><th>ìŠ¹</th><th>íŒ¨</th><th>ë“</th><th>ì‹¤</th><th>ë“ì‹¤</th><th>ìŠ¹ì </th></tr></thead><tbody>`;
    sorted.forEach(([name,s],i)=>{
      const uc=gc(name);const diff=s.gw-s.gl2;const isTop=i<2;
      const rowClass=i===0?'grp-rank-top1':i===1?'grp-rank-top2':'';
      h+=`<tr class="${rowClass}">
        <td>${i===0?`<span class="rk1">1ìœ„</span>`:i===1?`<span class="rk2">2ìœ„</span>`:i===2?`<span class="rk3">3ìœ„</span>`:`${i+1}ìœ„`}</td>
        <td><span class="ubadge clickable-univ" style="background:${uc};font-size:11px" onclick="openUnivModal('${name}')">${name}</span></td>
        <td style="color:var(--gray-l)">${s.played}</td><td class="wt">${s.w}</td><td class="lt">${s.l}</td>
        <td class="wt">${s.gw}</td><td class="lt">${s.gl2}</td>
        <td style="font-weight:700;color:${diff>0?'var(--green)':diff<0?'var(--red)':'var(--gray-l)'}">${diff>=0?'+':''}${diff}</td>
        <td style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:${col}">${s.pts}</td>
      </tr>`;
    });
    h+=`</tbody></table>`;
    if(played===0) h+=`<div style="font-size:12px;color:var(--gray-l);padding:10px 0;text-align:center">â³ ì•„ì§ ì§„í–‰ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
    h+=`</div>`;
  });
  return h;
}

function rCompTour(){
  const tn=getCurrentTourney();
  // tourneyê°€ ìˆìœ¼ë©´ í•­ìƒ ë™ì  ë¸Œë¼ì¼“ ì‚¬ìš© (ê·¸ë£¹ ì—†ì–´ë„ ìˆ˜ë™ íŒ€ ì„ íƒ ê°€ëŠ¥)
  if(tn){
    return rCompTourDynamic(tn);
  }
  // fallback: tourney ì—†ì„ ë•Œ ê¸°ì¡´ ìˆ˜ë™ 8ê°• (ë ˆê±°ì‹œ)
  const allU=getAllUnivs();
  function teamBox(idx,label){
    const v=tourD[idx]||'';const col=v?gc(v):'';
    return `<div class="mteam ${v?'set':''}" style="${v?`background:${col}18;border-color:${col};color:${col};font-weight:800`:'color:#94a3b8'}">` + (v||label) + `</div>`;
  }
  function mCard(label,i1,i2,no){
    const v1=tourD[i1]||'',v2=tourD[i2]||'';
    const c1=v1?gc(v1):'',c2=v2?gc(v2):'';
    const selHtml=isLoggedIn?`<div class="msel-wrap no-export" style="margin-top:6px;display:flex;flex-direction:column;gap:4px">
      <select class="msel" onchange="upTour(${i1},this.value)" style="border-left:3px solid ${c1||'var(--border2)'};font-weight:${v1?'700':'400'}">
        <option value="">íŒ€A ì„ íƒ...</option>
        ${allU.map(u=>`<option value="${u.name}"${v1===u.name?' selected':''}>${u.name}</option>`).join('')}
      </select>
      <select class="msel" onchange="upTour(${i2},this.value)" style="border-left:3px solid ${c2||'var(--border2)'};font-weight:${v2?'700':'400'}">
        <option value="">íŒ€B ì„ íƒ...</option>
        ${allU.map(u=>`<option value="${u.name}"${v2===u.name?' selected':''}>${u.name}</option>`).join('')}
      </select>
    </div>`:'';
    return `<div class="mcard" style="${(v1||v2)?'border-color:var(--blue-ll)':''}">
      <div class="mcard-lbl">${label} Â· ${no}</div>
      ${teamBox(i1,'ë¯¸í™•ì •')}<div class="mvs">VS</div>${teamBox(i2,'ë¯¸í™•ì •')}
      ${selHtml}
    </div>`;
  }
  const champ=tourD[14]||''; const cc=champ?gc(champ):'';
  const champSel=isLoggedIn?`<select class="msel no-export" style="margin-top:10px" onchange="upTour(14,this.value)"><option value="">ì±”í”¼ì–¸...</option>${allU.map(u=>`<option value="${u.name}"${champ===u.name?' selected':''}>${u.name}</option>`).join('')}</select>`:'';
  return `<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:var(--blue);margin-bottom:12px">âš”ï¸ í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ â€” ê° ì¡° ìƒìœ„ 2íŒ€</div>
  <div class="tour-wrap"><div class="tour-inner">
    <div class="rcol" style="height:480px"><div class="rcol-lbl">8ê°• QUARTER</div>${mCard('8ê°•',0,1,1)}${mCard('8ê°•',2,3,2)}${mCard('8ê°•',4,5,3)}${mCard('8ê°•',6,7,4)}</div>
    <div class="conn"><div class="conn-line"></div></div>
    <div class="rcol" style="height:340px"><div class="rcol-lbl">4ê°• SEMI</div>${mCard('4ê°•',8,9,1)}${mCard('4ê°•',10,11,2)}</div>
    <div class="conn"><div class="conn-line"></div></div>
    <div class="rcol" style="height:200px"><div class="rcol-lbl">ğŸ† ê²°ìŠ¹ FINAL</div>${mCard('ê²°ìŠ¹',12,13,1)}</div>
    <div class="conn"><div class="conn-line"></div></div>
    <div class="champ-col" style="height:200px"><div class="champ-lbl2">ğŸ† CHAMPION</div>
      <div class="champ-box"><span class="champ-star">âœ¦ âœ¦ âœ¦</span><div class="champ-lbl">CHAMPION</div>
        <div class="champ-team" style="${cc?`background:${cc}18;border-color:${cc};color:${cc}`:''}">` + (champ||'?') + `</div>${champSel}
      </div>
    </div>
  </div></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë¸Œë¼ì¼“ ìƒíƒœ ì €ì¥ ìœ í‹¸
   tn.bracket = {
     slots: { "r-mi-side": "ëŒ€í•™ëª…" },   // ê° ë¼ìš´ë“œ ê° ê²½ê¸° ìŠ¬ë¡¯ ìˆ˜ë™ override
     winners: { "r-mi": "ëŒ€í•™ëª…" },       // ê° ë¼ìš´ë“œ ê° ê²½ê¸° ìŠ¹ì
     champ: "ëŒ€í•™ëª…"
   }
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getBracket(tn){
  if(!tn.bracket)tn.bracket={slots:{},winners:{},champ:''};
  if(!tn.bracket.slots)tn.bracket.slots={};
  if(!tn.bracket.winners)tn.bracket.winners={};
  if(tn.bracket.champ===undefined)tn.bracket.champ='';
  return tn.bracket;
}
function setBracketWinner(tnId,rnd,mi,winner){
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  const br=getBracket(tn);
  const key=`${rnd}-${mi}`;
  if(br.winners[key]===winner){br.winners[key]='';} // í† ê¸€ off
  else{br.winners[key]=winner;}
  save();render();
}
function setBracketSlot(tnId,rnd,mi,side,val){
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  const br=getBracket(tn);
  br.slots[`${rnd}-${mi}-${side}`]=val;
  // ìŠ¬ë¡¯ ë°”ê¾¸ë©´ í•´ë‹¹ ë§¤ì¹˜ ìŠ¹ì ì´ˆê¸°í™”
  delete br.winners[`${rnd}-${mi}`];
  save();render();
}
function setBracketChamp(tnId,val){
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  getBracket(tn).champ=val;save();render();
}
function resetBracket(tnId){
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  if(!confirm('ë¸Œë¼ì¼“ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•œ íŒ€ ë°°ì¹˜ì™€ ê²°ê³¼ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.'))return;
  tn.bracket={slots:{},winners:{},champ:''};save();render();
}

/* â”€â”€ ë™ì  ë¸Œë¼ì¼“ ì‹œê°í™” (ìˆ˜ì • ê°€ëŠ¥ ë²„ì „) â”€â”€ */
function rCompTourDynamic(tn){
  function getGrpRank(grp){
    const stat={};
    (grp.univs||[]).forEach(u=>{stat[u]={w:0,l:0,sw:0,sl:0};});
    (grp.matches||[]).forEach(m=>{
      if(!m.a||!m.b||m.sa==null||m.sb==null)return;
      if(!stat[m.a])stat[m.a]={w:0,l:0,sw:0,sl:0};
      if(!stat[m.b])stat[m.b]={w:0,l:0,sw:0,sl:0};
      if(m.sa>m.sb){stat[m.a].w++;stat[m.b].l++;}
      else if(m.sb>m.sa){stat[m.b].w++;stat[m.a].l++;}
      stat[m.a].sw+=m.sa; stat[m.a].sl+=m.sb;
      stat[m.b].sw+=m.sb; stat[m.b].sl+=m.sa;
    });
    return Object.entries(stat).map(([u,s])=>({u,w:s.w,l:s.l,sw:s.sw,sl:s.sl}))
      .sort((a,b)=>b.w-a.w||(b.sw-b.sl)-(a.sw-a.sl)||b.sw-a.sw);
  }

  const grpRanks=(tn.groups&&tn.groups.length>=2)?tn.groups.map((grp,gi)=>{
    const gl='ABCDEFGHIJ'[gi]||String(gi+1);
    const color=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
    const ranked=getGrpRank(grp);
    return{grpName:grp.name||('ì¡°'+gl),color,ranked};
  }):[];

  const numGroups=grpRanks.length;
  const pairCount=Math.floor(numGroups/2)*2;
  const r1teams=[]; // 1ë¼ìš´ë“œ íŒ€ ëª©ë¡ ìˆœì„œëŒ€ë¡œ (ì¡°í¸ì„± ìë™ ë°°ì¹˜)
  for(let i=0;i<pairCount;i+=2){
    const gA=grpRanks[i],gB=grpRanks[i+1]||grpRanks[0];
    r1teams.push(
      {univ:gA.ranked[0]?.u||'',grpName:gA.grpName,color:gA.color,rank:1},
      {univ:gB.ranked[1]?.u||'',grpName:gB.grpName,color:gB.color,rank:2},
      {univ:gB.ranked[0]?.u||'',grpName:gB.grpName,color:gB.color,rank:1},
      {univ:gA.ranked[1]?.u||'',grpName:gA.grpName,color:gA.color,rank:2}
    );
  }
  if(numGroups%2===1){
    const last=grpRanks[numGroups-1];
    r1teams.push(
      {univ:last.ranked[0]?.u||'',grpName:last.grpName,color:last.color,rank:1},
      {univ:'',grpName:'ì™€ì¼ë“œì¹´ë“œ',color:'#6b7280',rank:'-'}
    );
  }
  // ê·¸ë£¹ ì—†ìœ¼ë©´ ê¸°ë³¸ 4ê²½ê¸°(8ê°•) ìˆ˜ë™ ë¸Œë¼ì¼“
  const numR1=r1teams.length>0?Math.ceil(r1teams.length/2):4;
  let bracketN=numR1; let totalRounds=0;
  let n=bracketN; while(n>1){n=Math.ceil(n/2);totalRounds++;}
  if(totalRounds===0)totalRounds=1;
  const roundLabels={1:'ê²°ìŠ¹',2:'ì¤€ê²°ìŠ¹',3:'8ê°•',4:'16ê°•',5:'32ê°•'};

  const br=getBracket(tn);
  const allU=getAllUnivs();
  const tnId=tn.id;

  // ë¸Œë¼ì¼“ ì „ì²´ íŒ€ ìƒíƒœ ê³„ì‚° (ìˆ˜ë™ override + ìë™ ìŠ¹ì ì „íŒŒ)
  // rounds[r][mi] = {a,b} (ê°ê° {univ,color,...} or null)
  const rounds=[]; // rounds[0] = 1ë¼ìš´ë“œ
  for(let r=0;r<totalRounds;r++){
    const matchCount=Math.ceil(numR1/Math.pow(2,r));
    const pairs=[];
    for(let mi=0;mi<matchCount;mi++){
      let teamA=null,teamB=null;
      if(r===0){
        // 1ë¼ìš´ë“œ: ì¡° ìˆœìœ„ì—ì„œ ê¸°ë³¸ê°’, ìˆ˜ë™ override ìš°ì„ 
        const baseA=r1teams[mi*2]||null;
        const baseB=r1teams[mi*2+1]||null;
        const slotA=br.slots[`0-${mi}-a`];
        const slotB=br.slots[`0-${mi}-b`];
        teamA=slotA!==undefined?(slotA?{univ:slotA,color:gc(slotA)}:null):(baseA?.univ?baseA:null);
        teamB=slotB!==undefined?(slotB?{univ:slotB,color:gc(slotB)}:null):(baseB?.univ?baseB:null);
      }else{
        // ì´í›„ ë¼ìš´ë“œ: ì´ì „ ë¼ìš´ë“œ ìŠ¹ì ë˜ëŠ” ìˆ˜ë™ override
        const prevMiA=mi*2, prevMiB=mi*2+1;
        const autoA=br.winners[`${r-1}-${prevMiA}`]||null;
        const autoB=br.winners[`${r-1}-${prevMiB}`]||null;
        const slotA=br.slots[`${r}-${mi}-a`];
        const slotB=br.slots[`${r}-${mi}-b`];
        teamA=slotA!==undefined?(slotA?{univ:slotA,color:gc(slotA)}:null):(autoA?{univ:autoA,color:gc(autoA)}:null);
        teamB=slotB!==undefined?(slotB?{univ:slotB,color:gc(slotB)}:null):(autoB?{univ:autoB,color:gc(autoB)}:null);
      }
      pairs.push({a:teamA,b:teamB,winner:br.winners[`${r}-${mi}`]||null});
    }
    rounds.push(pairs);
  }

  function teamSlot(team,isWinner,tnId,rnd,mi,side){
    const col=team?gc(team.univ):'#94a3b8';
    const univName=team?.univ||'';
    const isTbd=!univName;
    const winMark=isWinner?'<span style="font-size:13px;margin-left:2px">âœ…</span>':'';

    // í¸ì§‘ëª¨ë“œë©´ ì…€ë ‰íŠ¸
    if(isLoggedIn){
      const grpBadge=team?.grpName?`<span style="background:${team.color||col};color:#fff;font-size:9px;font-weight:800;padding:1px 4px;border-radius:3px;flex-shrink:0">${team.rank}</span>`:'';
      const winMarkInner=isWinner?`<span style="font-size:11px;flex-shrink:0">âœ…</span>`:'';
      return `<div style="display:flex;align-items:center;gap:3px;height:38px">
        ${grpBadge}
        <select style="flex:1;height:32px;font-size:12px;font-weight:${isWinner?'800':'600'};padding:0 6px;border-radius:6px;border:${isWinner?'2px':'1px'} solid ${isWinner?col:isTbd?'#cbd5e1':col+'55'};background:${isWinner?col+'15':isTbd?'#f8fafc':'var(--white)'};color:${isWinner?col:isTbd?'#94a3b8':'var(--text)'};cursor:pointer;min-width:0"
          onchange="setBracketSlot('${tnId}',${rnd},${mi},'${side}',this.value)">
          <option value="">â€” ë¯¸ì • â€”</option>
          ${allU.map(u=>`<option value="${u.name}"${univName===u.name?' selected':''}>${u.name}</option>`).join('')}
        </select>
        ${winMarkInner}
      </div>`;
    }
    return `<div style="height:38px;padding:0 8px;border-radius:6px;border:${isWinner?'2px':'1px'} solid ${isWinner?col:isTbd?'#cbd5e1':col+'55'};background:${isWinner?col+'22':isTbd?'#f8fafc':'var(--white)'};display:flex;align-items:center;gap:4px;font-size:12px;font-weight:${isWinner?'800':'600'};color:${isWinner?col:isTbd?'#94a3b8':'var(--text)'};overflow:hidden;white-space:nowrap">
      ${team?.grpName?`<span style="background:${team.color||col};color:#fff;font-size:9px;font-weight:800;padding:1px 4px;border-radius:3px;flex-shrink:0">${team.rank}</span>`:''}
      <span style="overflow:hidden;text-overflow:ellipsis;flex:1">${isTbd?'ë¯¸ì •':univName}</span>
      ${winMark}
    </div>`;
  }

  function matchCard(pair, rLabel, rnd, mi){
    const {a,b,winner}=pair;
    const aIsWin=winner&&winner===a?.univ;
    const bIsWin=winner&&winner===b?.univ;
    const canSetWinner=isLoggedIn&&a?.univ&&b?.univ;
    const isDone=!!winner;

    // ìŠ¹ì ë²„íŠ¼
    let winBtns='';
    if(canSetWinner){
      winBtns=`<div style="display:flex;gap:4px;margin-top:5px">
        <button onclick="setBracketWinner('${tnId}',${rnd},${mi},'${a.univ}')"
          style="flex:1;padding:3px 0;border-radius:5px;border:1.5px solid ${aIsWin?gc(a.univ):'var(--border2)'};background:${aIsWin?gc(a.univ)+'22':'var(--white)'};font-size:10px;font-weight:700;color:${aIsWin?gc(a.univ):'var(--text3)'};cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
          ${aIsWin?'âœ… ':''}${a.univ.length>6?a.univ.slice(0,5)+'â€¦':a.univ} ìŠ¹
        </button>
        <button onclick="setBracketWinner('${tnId}',${rnd},${mi},'${b.univ}')"
          style="flex:1;padding:3px 0;border-radius:5px;border:1.5px solid ${bIsWin?gc(b.univ):'var(--border2)'};background:${bIsWin?gc(b.univ)+'22':'var(--white)'};font-size:10px;font-weight:700;color:${bIsWin?gc(b.univ):'var(--text3)'};cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
          ${bIsWin?'âœ… ':''}${b.univ.length>6?b.univ.slice(0,5)+'â€¦':b.univ} ìŠ¹
        </button>
      </div>`;
    }else if(!a?.univ||!b?.univ){
      winBtns=`<div style="font-size:9px;color:#94a3b8;text-align:center;margin-top:4px">íŒ€ ë°°ì • í›„ ê²°ê³¼ ì…ë ¥</div>`;
    }

    return `<div style="background:var(--white);border:${isDone?'2px':'1px'} solid ${isDone?'var(--blue)':'var(--border)'};border-radius:10px;padding:8px 10px;min-width:190px;max-width:210px;box-shadow:${isDone?'0 2px 10px rgba(37,99,235,.12)':'0 1px 4px rgba(0,0,0,.06)'}">
      <div style="font-size:9px;color:${isDone?'var(--blue)':'var(--gray-l)'};font-weight:700;margin-bottom:5px;text-align:center;letter-spacing:.5px">${rLabel} ${mi+1}ê²½ê¸°${isDone?' âœ“':''}</div>
      ${teamSlot(a,aIsWin,tnId,rnd,mi,'a')}
      <div style="text-align:center;font-size:9px;color:var(--gray-l);font-weight:700;margin:3px 0">VS</div>
      ${teamSlot(b,bIsWin,tnId,rnd,mi,'b')}
      ${winBtns}
    </div>`;
  }

  let allRoundsHTML='';
  for(let r=0;r<totalRounds;r++){
    const rNum=totalRounds-r;
    const rLabel=roundLabels[rNum]||(rNum+'ê°•');
    const pairs=rounds[r];
    const colH=pairs.length>1?`${pairs.length*110+pairs.length*14}px`:'auto';
    allRoundsHTML+=`<div style="display:flex;flex-direction:column;justify-content:space-around;gap:14px;min-width:200px;padding-top:28px;align-items:center">
      <div style="font-size:11px;font-weight:800;color:var(--blue);text-align:center;letter-spacing:.5px;white-space:nowrap;width:100%">${rLabel}</div>
      ${pairs.map((p,mi)=>matchCard(p,rLabel,r,mi)).join('')}
    </div>`;
    if(r<totalRounds-1){
      const connH=Math.max(1,pairs.length);
      allRoundsHTML+=`<div style="display:flex;flex-direction:column;justify-content:space-around;min-width:28px;padding-top:52px;gap:${connH>1?Math.floor(100/connH):0}px">
        ${pairs.map(()=>'<div style="height:2px;background:linear-gradient(90deg,#cbd5e1,#93c5fd);min-width:28px"></div>').join('')}
      </div>`;
    }
  }

  // ì±”í”¼ì–¸ ë°•ìŠ¤
  const finalPairs=rounds[totalRounds-1]||[];
  const finalWinner=finalPairs[0]?.winner||br.champ||'';
  const cc=finalWinner?gc(finalWinner):'#d97706';
  allRoundsHTML+=`<div style="display:flex;align-items:center;min-width:24px;padding-top:52px">
    <div style="height:2px;width:24px;background:linear-gradient(90deg,#93c5fd,${cc})"></div>
  </div>
  <div style="display:flex;flex-direction:column;justify-content:center;align-items:center;padding-top:28px;min-width:140px">
    <div style="font-size:10px;font-weight:800;color:#d97706;text-align:center;margin-bottom:8px;letter-spacing:2px">ğŸ† CHAMPION</div>
    <div style="background:${cc}15;border:2px solid ${cc};border-radius:12px;padding:14px 18px;text-align:center;min-width:130px">
      <div style="font-size:22px;margin-bottom:4px">ğŸ†</div>
      <div style="font-weight:900;font-size:14px;color:${cc};white-space:nowrap">${finalWinner||'?'}</div>
    </div>
    ${isLoggedIn?`<select style="margin-top:7px;font-size:11px;padding:4px 7px;border:1px solid var(--border2);border-radius:6px;max-width:130px" onchange="setBracketChamp('${tnId}',this.value)">
      <option value="">ì±”í”¼ì–¸ ì§ì ‘ ì§€ì •...</option>
      ${allU.map(u=>`<option value="${u.name}"${finalWinner===u.name?' selected':''}>${u.name}</option>`).join('')}
    </select>`:''}
  </div>`;

  return `<div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap">
      <span style="font-weight:900;font-size:15px;color:var(--blue)">âš”ï¸ ${tn.name} â€” í† ë„ˆë¨¼íŠ¸ ë¸Œë¼ì¼“</span>
      ${isLoggedIn?`<button class="btn btn-w btn-xs" onclick="resetBracket('${tnId}')" title="ë¸Œë¼ì¼“ ì´ˆê¸°í™”">ğŸ”„ ì´ˆê¸°í™”</button>`:''}
      ${isLoggedIn?`<span style="font-size:11px;color:var(--gray-l);margin-left:4px">ğŸ’¡ íŒ€ ìŠ¬ë¡¯ í´ë¦­ìœ¼ë¡œ ë³€ê²½ Â· ìŠ¹ ë²„íŠ¼ìœ¼ë¡œ ê²°ê³¼ ì…ë ¥</span>`:''}
    </div>
    <!-- ì¡°ë³„ ìˆœìœ„ ìš”ì•½ (ê·¸ë£¹ ìˆëŠ” ê²½ìš°ë§Œ) -->
    ${grpRanks.length>0?`<div style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px">
      ${grpRanks.map(g=>`<div style="background:${g.color}10;border:1px solid ${g.color}44;border-radius:8px;padding:7px 11px;min-width:120px">
        <div style="font-size:11px;font-weight:800;color:${g.color};margin-bottom:5px">${g.grpName}</div>
        ${g.ranked.slice(0,2).map((s,ri)=>`<div style="display:flex;align-items:center;gap:4px;margin-bottom:2px">
          <span style="font-size:10px">${ri===0?'ğŸ¥‡':'ğŸ¥ˆ'}</span>
          <span style="background:${gc(s.u)};color:#fff;font-size:10px;font-weight:700;padding:1px 5px;border-radius:3px">${s.u}</span>
          <span style="font-size:9px;color:var(--gray-l)">${s.w}ìŠ¹${s.l}íŒ¨</span>
        </div>`).join('')}
      </div>`).join('')}
    </div>`:`<div style="font-size:11px;color:var(--gray-l);margin-bottom:10px;padding:6px 10px;background:var(--surface);border-radius:6px">ğŸ’¡ ì¡°í¸ì„±ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ ë“œë¡­ë‹¤ìš´ì—ì„œ ì§ì ‘ íŒ€ì„ ë°°ì¹˜í•˜ì„¸ìš”.</div>`}
    <!-- ë¸Œë¼ì¼“ -->
    <div style="overflow-x:auto;padding-bottom:8px">
      <div style="display:flex;align-items:center;gap:0;min-width:fit-content;padding:8px 0">
        ${allRoundsHTML}
      </div>
    </div>
  </div>`;
}

function rCompPlayerRank(tn){
  if(!tn) return `<div style="padding:30px;text-align:center;color:var(--gray-l)">ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>`;
  const pStats={};
  tn.groups.forEach(grp=>{
    (grp.matches||[]).forEach(m=>{
      if(m.sa==null)return;
      (m.sets||[]).forEach(set=>{
        (set.games||[]).forEach(g=>{
          if(!g.playerA||!g.playerB||!g.winner)return;
          const wn=g.winner==='A'?g.playerA:g.playerB;const ln=g.winner==='A'?g.playerB:g.playerA;
          if(!pStats[wn])pStats[wn]={w:0,l:0};if(!pStats[ln])pStats[ln]={w:0,l:0};
          pStats[wn].w++;pStats[ln].l++;
        });
      });
    });
  });
  const sorted=Object.entries(pStats).sort((a,b)=>{const da=a[1].w-a[1].l,db=b[1].w-b[1].l;return db!==da?db-da:b[1].w-a[1].w;});
  if(!sorted.length) return `<div style="padding:40px;text-align:center;color:var(--gray-l);background:var(--surface);border-radius:10px">â³ ì•„ì§ ê¸°ë¡ëœ ê²½ê¸° ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
  let h=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--blue);margin-bottom:14px">ğŸ… ${tn.name} ê°œì¸ ìˆœìœ„</div>
  <table><thead><tr><th style="text-align:left">ìˆœìœ„</th><th style="text-align:left">ì´ë¦„</th><th style="text-align:left">ì†Œì†</th><th>ìŠ¹</th><th>íŒ¨</th><th>ìŠ¹ì°¨</th><th>ìŠ¹ë¥ </th></tr></thead><tbody>`;
  sorted.forEach(([name,s],i)=>{
    const p=players.find(x=>x.name===name);const col=p?gc(p.univ):'#888';
    const tot=s.w+s.l;const wr=tot?Math.round(s.w/tot*100):0;const diff=s.w-s.l;
    h+=`<tr>
      <td style="text-align:left">${i===0?`<span class="rk1">1ë“±</span>`:i===1?`<span class="rk2">2ë“±</span>`:i===2?`<span class="rk3">3ë“±</span>`:`${i+1}ìœ„`}</td>
      <td style="text-align:left"><span class="clickable-name" onclick="openPlayerModal('${name}')">${name}</span></td>
      <td style="text-align:left">${p?`<span class="ubadge" style="background:${col};font-size:11px">${p.univ}</span>`:'-'}</td>
      <td class="wt" style="font-weight:800">${s.w}</td><td class="lt" style="font-weight:800">${s.l}</td>
      <td style="font-weight:800;color:${diff>0?'var(--green)':diff<0?'var(--red)':'var(--gray-l)'}">${diff>=0?'+':''}${diff}</td>
      <td style="font-weight:700;color:${wr>=50?'var(--green)':'var(--red)'}">${tot?wr+'%':'-'}</td>
    </tr>`;
  });
  return h+`</tbody></table>`;
}

function grpToggleTierFilter(t){
  if(!window._grpTierFilters)window._grpTierFilters=[];
  const i=window._grpTierFilters.indexOf(t);
  if(i>=0)window._grpTierFilters.splice(i,1);else window._grpTierFilters.push(t);
  render();
}

function rCompGrpEdit(){
  if(!isLoggedIn) return `<div style="padding:30px;text-align:center;color:var(--gray-l)">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>`;
  if(grpSub==='edit'&&grpEditId) return rGrpEditInner();
  if(!window._grpTierFilters)window._grpTierFilters=[];
  const tfs=window._grpTierFilters;
  let h=`<div class="grp-edit-header">
    <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--blue)">ğŸ—ï¸ ëŒ€íšŒ ì¡°í¸ì„± ê´€ë¦¬</span>
    <button class="btn btn-b btn-sm" onclick="grpNewTourney()">+ ìƒˆ ëŒ€íšŒ ë§Œë“¤ê¸°</button>
    <div style="margin-left:auto;display:flex;gap:5px;align-items:center;flex-wrap:wrap">
      <span style="font-size:11px;font-weight:700;color:var(--gray-l)">ì¶œì „ í‹°ì–´ <span style="font-weight:400;font-size:10px">(ë³µìˆ˜ì„ íƒ)</span>:</span>
      <button class="tier-filter-btn ${tfs.length===0?'on':''}" onclick="window._grpTierFilters=[];render()">ì „ì²´</button>
      ${TIERS.map(t=>`<button class="tier-filter-btn ${tfs.includes(t)?'on':''}" onclick="grpToggleTierFilter('${t}')">${getTierLabel(t)}</button>`).join('')}
    </div>
  </div>`;
  if(!tourneys.length){h+=`<div style="padding:40px;text-align:center;color:var(--gray-l);background:var(--surface);border-radius:10px;border:2px dashed var(--border2)">ë“±ë¡ëœ ëŒ€íšŒê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;return h;}
  tourneys.forEach((tn,ti)=>{
    const isActive=tn.name===curComp;
    h+=`<div style="background:${isActive?'var(--blue-l)':'var(--surface)'};border:${isActive?'2px solid var(--blue)':'1px solid var(--border)'};border-radius:12px;padding:16px 20px;margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px">
        <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px">${isActive?'âœ… ':''} ${tn.name}</span>
        <span style="font-size:11px;color:var(--gray-l)">${tn.groups.length}ê°œì¡° / ${tn.groups.reduce((s,g)=>s+(g.matches||[]).length,0)}ê²½ê¸°</span>
        <div style="margin-left:auto;display:flex;gap:6px;flex-wrap:wrap">
          ${!isActive?`<button class="btn btn-b btn-xs" onclick="curComp='${tn.name}';save();render()">í˜„ì¬ ëŒ€íšŒë¡œ ì„¤ì •</button>`:'<span style="font-size:11px;color:var(--blue);font-weight:700">ğŸ“Œ í˜„ì¬ ëŒ€íšŒ</span>'}
          <button class="btn btn-w btn-xs" onclick="grpEditId='${tn.id}';grpSub='edit';render()">ğŸ“ ì¡°í¸ì„± ì…ë ¥</button>
          <button class="btn btn-r btn-xs" onclick="grpDelTourney(${ti})">ì‚­ì œ</button>
        </div>
      </div>
      ${tn.groups.length?`<div style="display:flex;gap:6px;flex-wrap:wrap">${tn.groups.map((g,gi)=>{const gl='ABCDEFGHIJ'[gi];const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];return `<span style="background:${col};color:#fff;padding:2px 12px;border-radius:20px;font-size:11px;font-weight:700">GROUP ${gl}ì¡° (${g.univs.length}íŒ€, ${(g.matches||[]).length}ê²½ê¸°)</span>`;}).join('')}</div>`:'<span style="font-size:11px;color:var(--gray-l)">ì¡° ì—†ìŒ</span>'}
    </div>`;
  });
  return h;
}

function rGrpEditInner(){
  const tn=tourneys.find(t=>t.id===grpEditId);
  if(!tn){grpSub='list';render();return '';}
  const GL='ABCDEFGHIJ';
  let h=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap">
    <button class="btn btn-w btn-sm" onclick="grpSub='list';render()">â† ëª©ë¡</button>
    <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px">ğŸ† ${tn.name} â€” ì¡°í¸ì„±</span>
    <button class="btn btn-b btn-sm" style="margin-left:auto" onclick="grpAddGroup('${tn.id}')">+ ${GL[tn.groups.length]||'?'}ì¡° ì¶”ê°€</button>
  </div>`;
  if(!tn.groups.length){
    h+=`<div style="text-align:center;padding:50px;background:var(--surface);border-radius:12px;border:2px dashed var(--border2)">
      <div style="font-size:32px;margin-bottom:12px">ğŸ†</div>
      <div style="font-weight:700;margin-bottom:10px">Aì¡°ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ì¡°ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”</div>
      <button class="btn btn-b" onclick="grpAddGroup('${tn.id}')">+ GROUP Aì¡° ë§Œë“¤ê¸°</button>
    </div>`;
    return h;
  }
  tn.groups.forEach((grp,gi)=>{
    const gl=GL[gi]||gi;const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
    const availU=getAllUnivs().map(u=>u.name).filter(n=>!grp.univs.includes(n));
    h+=`<div style="background:${col}08;border:2px solid ${col}44;border-radius:12px;padding:16px;margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap">
        <span style="background:${col};color:#fff;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;padding:3px 16px;border-radius:20px">GROUP ${gl}ì¡°</span>
        <span style="font-size:11px;color:var(--gray-l)">${grp.univs.length}ê°œ ëŒ€í•™ Â· ${(grp.matches||[]).length}ê²½ê¸°</span>
        <button class="btn btn-r btn-xs" style="margin-left:auto" onclick="grpDelGroup('${tn.id}',${gi})">ì¡° ì‚­ì œ</button>
      </div>
      <div style="margin-bottom:14px">
        <div style="font-size:12px;font-weight:700;color:${col};margin-bottom:8px">â‘  ëŒ€í•™ ì„ íƒ</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
          ${grp.univs.map((u,ui)=>`<span class="ubadge" style="background:${gc(u)};font-size:12px">${u}<button onclick="grpRemoveUniv('${tn.id}',${gi},${ui})" style="background:rgba(255,255,255,.3);border:none;border-radius:50%;color:#fff;width:16px;height:16px;font-size:9px;cursor:pointer;margin-left:3px;line-height:16px;text-align:center">Ã—</button></span>`).join('')}
          ${!grp.univs.length?'<span style="color:var(--gray-l);font-size:12px">ì•„ì§ ì—†ìŒ</span>':''}
        </div>
        ${availU.length?`<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <div style="position:relative;flex:1;min-width:150px">
            <input type="text" id="grp-univ-search-${gi}" placeholder="ğŸ” ëŒ€í•™ ê²€ìƒ‰..." style="width:100%;padding:6px 10px;font-size:12px;border:1px solid var(--border2);border-radius:6px" oninput="grpFilterUnivSel(${gi})">
          </div>
          <select id="grp-univ-sel-${gi}" style="max-width:200px"><option value="">â€” ëŒ€í•™ ì„ íƒ â€”</option>${availU.map(u=>`<option value="${u}">${u}</option>`).join('')}</select>
          <button class="btn btn-b btn-sm" onclick="grpAddUniv('${tn.id}',${gi})">+ ì¶”ê°€</button>
        </div>`:`<div style="font-size:11px;color:var(--gray-l)">ëª¨ë“  ëŒ€í•™ì´ ì¶”ê°€ë¨</div>`}
      </div>
      <div>
        <div style="font-size:12px;font-weight:700;color:${col};margin-bottom:8px">â‘¡ ê²½ê¸° ì¼ì • (${(grp.matches||[]).length}ê²½ê¸° ë“±ë¡)</div>
        ${(grp.matches||[]).length?`<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">${grp.matches.map((m,mi)=>{
          const isDone=m.sa!=null&&m.sb!=null;const ca=gc(m.a||'');const cb=gc(m.b||'');
          return `<div style="background:var(--white);border:1px solid var(--border);border-radius:8px;padding:7px 12px;font-size:12px;display:flex;align-items:center;gap:6px;flex-wrap:wrap">
            <span style="font-size:10px;font-weight:700;color:${col}">${gl}ì¡° ${mi+1}ê²½ê¸°</span>
            ${m.d?`<span style="font-size:10px;color:var(--gray-l)">${m.d.slice(5)}</span>`:''}
            <span style="background:${ca||'#888'};color:#fff;padding:1px 7px;border-radius:4px;font-size:11px">${m.a||'?'}</span>
            <span style="color:var(--gray-l)">vs</span>
            <span style="background:${cb||'#888'};color:#fff;padding:1px 7px;border-radius:4px;font-size:11px">${m.b||'?'}</span>
            ${isDone?`<span style="font-weight:800;font-size:12px"><span class="wt">${m.sa}</span>:<span class="lt">${m.sb}</span></span>`:'<span style="font-size:10px;color:var(--gray-l)">ì˜ˆì •</span>'}
            <button class="btn btn-b btn-xs" onclick="grpEditMatch('${tn.id}',${gi},${mi})">âœï¸ ê²°ê³¼ì…ë ¥</button>
            <button class="btn btn-r btn-xs" onclick="grpDelMatch('${tn.id}',${gi},${mi})">Ã—</button>
          </div>`;
        }).join('')}</div>`:''}
        ${grp.univs.length>=2?`<button class="btn btn-b btn-sm" onclick="grpAddMatch('${tn.id}',${gi})">+ ${gl}ì¡° ê²½ê¸° ì¶”ê°€</button>`:`<span style="font-size:11px;color:var(--gray-l)">â€» ëŒ€í•™ 2ê°œ ì´ìƒ ì¶”ê°€ í›„ ê²½ê¸° ë“±ë¡ ê°€ëŠ¥</span>`}
      </div>
    </div>`;
  });
  return h;
}

function grpAddMatchByDate(tnId, date){
  // í•´ë‹¹ ë‚ ì§œì˜ ì¡° ì¤‘ íŒ€ì´ 2ê°œ ì´ìƒì¸ ì²« ë²ˆì§¸ ì¡°ì— ê²½ê¸° ì¶”ê°€
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  // ì¡° ì„ íƒ (íŒ€ 2ê°œ ì´ìƒ ìˆëŠ” ì¡°ê°€ ìˆìœ¼ë©´ ì²« ë²ˆì§¸, ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì¡°)
  const validGrp=tn.groups.find(g=>g.univs.length>=2)||tn.groups[0];
  if(!validGrp){alert('ì¡°ë¥¼ ë¨¼ì € ë§Œë“¤ì–´ ì£¼ì„¸ìš”.');return;}
  const gi=tn.groups.indexOf(validGrp);
  validGrp.matches.push({a:'',b:'',d:date,sa:null,sb:null,sets:[]});
  const mi=validGrp.matches.length-1;
  save();grpMatchState={tnId,gi,mi};grpOpenMatchModal(tn,gi,mi);
}

function grpAddMatch(tnId,gi){
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  const grp=tn.groups[gi];
  if(grp.univs.length<2){alert('ë¨¼ì € ëŒ€í•™ì„ 2ê°œ ì´ìƒ ì¶”ê°€í•˜ì„¸ìš”.');return;}
  tn.groups[gi].matches.push({a:'',b:'',d:'',sa:null,sb:null,sets:[]});
  const mi=tn.groups[gi].matches.length-1;
  save();grpMatchState={tnId,gi,mi};grpOpenMatchModal(tn,gi,mi);
}
function grpEditMatch(tnId,gi,mi){
  grpMatchState={tnId,gi,mi};const tn=tourneys.find(t=>t.id===tnId);if(tn)grpOpenMatchModal(tn,gi,mi);
}
function grpDelMatch(tnId,gi,mi){
  if(!confirm('ê²½ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nâš ï¸ ì„ ìˆ˜ ê°œì¸ ì „ì ë„ ë¡¤ë°±ë©ë‹ˆë‹¤.'))return;
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  revertMatchRecord(tn.groups[gi].matches[mi]);
  tn.groups[gi].matches.splice(mi,1);save();render();
}

function grpOpenMatchModal(tn,gi,mi){
  const grp=tn.groups[gi];const m=grp.matches[mi];
  const GL=['A','B','C','D','E','F','G','H','I','J'];const gl=GL[gi]||String.fromCharCode(65+gi);
  const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
  const uOpts=`<option value="">â€” ëŒ€í•™ ì„ íƒ â€”</option>`+grp.univs.map(u=>`<option value="${u}"${m.a===u?' selected':''}>${u}</option>`).join('');
  const uOptsB=`<option value="">â€” ëŒ€í•™ ì„ íƒ â€”</option>`+grp.univs.map(u=>`<option value="${u}"${m.b===u?' selected':''}>${u}</option>`).join('');
  document.getElementById('grpMatchTitle').textContent=`GROUP ${gl}ì¡° ${mi+1}ê²½ê¸° ê²°ê³¼ ì…ë ¥`;
  document.getElementById('grpMatchBody').innerHTML=`
    <div style="background:${col}10;border:1px solid ${col}44;border-radius:10px;padding:14px;margin-bottom:16px">
      <div style="font-size:11px;font-weight:700;color:${col};margin-bottom:10px">
        ğŸ“‹ GROUP ${gl}ì¡° ì†Œì† ëŒ€í•™: ${grp.univs.map(u=>`<span style="background:${gc(u)};color:#fff;padding:1px 8px;border-radius:4px;font-size:11px;margin-left:4px">${u}</span>`).join('')}
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start">
        <div style="flex:1;min-width:130px">
          <div style="font-size:11px;font-weight:700;color:var(--blue);margin-bottom:4px">ğŸ”µ íŒ€ A ëŒ€í•™</div>
          <select id="gm-a" onchange="grpRefreshSets();" style="width:100%">${uOpts}</select>
        </div>
        <div style="font-size:16px;font-weight:800;color:var(--gray-l);padding-top:22px">VS</div>
        <div style="flex:1;min-width:130px">
          <div style="font-size:11px;font-weight:700;color:var(--red);margin-bottom:4px">ğŸ”´ íŒ€ B ëŒ€í•™</div>
          <select id="gm-b" onchange="grpRefreshSets();" style="width:100%">${uOptsB}</select>
        </div>
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--gray-l);margin-bottom:4px">ğŸ“… ë‚ ì§œ</div>
          <input type="date" id="gm-date" value="${m.d||new Date().toISOString().slice(0,10)}" style="width:145px">
        </div>
      </div>
    </div>
    <div id="gm-sets"></div>
    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
      <button class="btn btn-b btn-sm" onclick="grpAddSet()">+ 1ì„¸íŠ¸</button>
      <button class="btn btn-w btn-sm" onclick="grpAddSet2()">+ 2ì„¸íŠ¸</button>
      <button class="btn btn-w btn-sm" onclick="grpAddSet3()">ğŸ¯ ì—ì´ìŠ¤ì „</button>
      <button class="btn btn-p btn-sm" onclick="openGrpPasteModal()">ğŸ“‹ ë¶™ì—¬ë„£ê¸° ì¼ê´„ ì…ë ¥</button>
      <button class="btn btn-g btn-sm" style="margin-left:auto" onclick="grpSaveMatch()">âœ… ì €ì¥ (ê°œì¸ì „ì  ìë™ë°˜ì˜)</button>
      <button class="btn btn-w btn-sm" onclick="cm('grpMatchModal')">ì·¨ì†Œ</button>
    </div>`;
  om('grpMatchModal');
  grpRefreshSets();
}

function grpUpdateMemberList(){
  function mHTML(univ){
    if(!univ)return '';
    const mems=players.filter(p=>p.univ===univ);
    if(!mems.length)return `<span style="color:var(--gray-l)">ì„ ìˆ˜ ì—†ìŒ</span>`;
    return `<div style="display:flex;flex-wrap:wrap;gap:3px">${mems.map(p=>`<span style="font-size:11px;background:${gc(univ)}12;border:1px solid ${gc(univ)}44;padding:2px 7px;border-radius:4px">${p.name}<span style="color:var(--gray-l)">[${p.tier||'-'}/${p.race||'-'}]</span></span>`).join('')}</div>`;
  }
  const aEl=document.getElementById('gm-a'),bEl=document.getElementById('gm-b');
  const aDiv=document.getElementById('gm-a-mems'),bDiv=document.getElementById('gm-b-mems');
  if(aEl&&aDiv)aDiv.innerHTML=mHTML(aEl.value);
  if(bEl&&bDiv)bDiv.innerHTML=mHTML(bEl.value);
}

function grpRefreshSets(){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];
  const aEl=document.getElementById('gm-a');const bEl=document.getElementById('gm-b');
  if(!aEl)return;
  const teamA=aEl.value,teamB=bEl?bEl.value:'';
  const tfs=window._grpTierFilters||[];
  const mA=players.filter(p=>p.univ===teamA&&(tfs.length===0||tfs.includes(p.tier)));
  const mB=players.filter(p=>p.univ===teamB&&(tfs.length===0||tfs.includes(p.tier)));
  const tfLabel=tfs.length?` [${tfs.join('+')}]`:'';
  const optsA=`<option value="">AíŒ€ ì„ ìˆ˜${tfLabel}</option>`+mA.map(p=>`<option value="${p.name}">${p.name} [${p.tier||'-'}/${p.race||'-'}]</option>`).join('');
  const optsB=`<option value="">BíŒ€ ì„ ìˆ˜${tfLabel}</option>`+mB.map(p=>`<option value="${p.name}">${p.name} [${p.tier||'-'}/${p.race||'-'}]</option>`).join('');
  const setsEl=document.getElementById('gm-sets');if(!setsEl)return;
  if(!m.sets||!m.sets.length){setsEl.innerHTML='<div style="color:var(--gray-l);font-size:12px;margin:12px 0;padding:14px;background:var(--surface);border-radius:8px;text-align:center">ì„¸íŠ¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš” â†“</div>';return;}
  let h='';
  m.sets.forEach((set,si)=>{
    const lbl=si===2?'ğŸ¯ ì—ì´ìŠ¤ì „':`${si+1}ì„¸íŠ¸`;
    const sA=set.scoreA||0,sB=set.scoreB||0;
    h+=`<div class="set-block${si===2?' ace':''}">
      <div class="set-title">
        <span class="set-badge${si===2?' ace':''}">${lbl}</span>
        <span style="font-size:12px;color:var(--gray-l)">ê²½ê¸° ${(set.games||[]).length}ê°œ Â· <span class="${sA>sB?'wt':''}">${sA}</span>:<span class="${sB>sA?'wt':''}">${sB}</span></span>
        <button class="btn btn-r btn-xs" onclick="grpDelSet(${si})">ì„¸íŠ¸ ì‚­ì œ</button>
      </div>`;
    (set.games||[]).forEach((g,gi2)=>{
      const mapOpts=maps.map(mp=>`<option value="${mp}"${g.map===mp?' selected':''}>${mp}</option>`).join('');
      const selA=optsA.replace(`value="${g.playerA}"`,`value="${g.playerA}" selected`);
      const selB=optsB.replace(`value="${g.playerB}"`,`value="${g.playerB}" selected`);
      h+=`<div class="game-row">
        <span style="font-size:11px;font-weight:700;color:var(--gray-l);min-width:40px">ê²½ê¸°${gi2+1}</span>
        <select onchange="grpSetGame(${si},${gi2},'playerA',this.value)">${selA}</select>
        <span style="font-size:11px;color:var(--gray-l)">vs</span>
        <select onchange="grpSetGame(${si},${gi2},'playerB',this.value)">${selB}</select>
        <select onchange="grpSetGame(${si},${gi2},'map',this.value)" style="max-width:100px"><option value="">ë§µ</option>${mapOpts}</select>
        <button class="win-btn ${g.winner==='A'?'win-sel':''}" onclick="grpSetGame(${si},${gi2},'winner','A');grpRefreshSets()">A ìŠ¹</button>
        <button class="win-btn ${g.winner==='B'?'lose-sel':''}" onclick="grpSetGame(${si},${gi2},'winner','B');grpRefreshSets()">B ìŠ¹</button>
        <button class="btn btn-r btn-xs" onclick="grpDelGame(${si},${gi2})">ì‚­ì œ</button>
      </div>`;
    });
    h+=`<button class="btn btn-w btn-sm" onclick="grpAddGame(${si})">+ ê²½ê¸° ì¶”ê°€</button></div>`;
  });
  setsEl.innerHTML=h;
}

function grpSetGame(si,gi,field,val){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];
  if(m.sets[si]&&m.sets[si].games[gi])m.sets[si].games[gi][field]=val;
}
function grpAddSet(){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];if(!m.sets)m.sets=[];
  if(m.sets.length>=3){alert('ìµœëŒ€ 3ì„¸íŠ¸(ì—ì´ìŠ¤ì „ í¬í•¨)ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');return;}
  m.sets.push({games:[{playerA:'',playerB:'',winner:'',map:''}],scoreA:0,scoreB:0,winner:''});grpRefreshSets();
}
function grpAddSet2(){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];if(!m.sets)m.sets=[];
  if(m.sets.length>=3){alert('ì´ë¯¸ ìµœëŒ€ ì„¸íŠ¸ì…ë‹ˆë‹¤.');return;}
  if(m.sets.length<1)m.sets.push({games:[{playerA:'',playerB:'',winner:'',map:''}],scoreA:0,scoreB:0,winner:''});
  if(m.sets.length<2)m.sets.push({games:[{playerA:'',playerB:'',winner:'',map:''}],scoreA:0,scoreB:0,winner:''});
  grpRefreshSets();
}
function grpAddSet3(){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];if(!m.sets)m.sets=[];
  if(m.sets.length>=3){alert('ì—ì´ìŠ¤ì „ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤.');return;}
  while(m.sets.length<3)m.sets.push({games:[{playerA:'',playerB:'',winner:'',map:''}],scoreA:0,scoreB:0,winner:''});
  grpRefreshSets();
}
function grpDelSet(si){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];m.sets.splice(si,1);grpRefreshSets();
}
function grpAddGame(si){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];if(!m.sets[si].games)m.sets[si].games=[];
  m.sets[si].games.push({playerA:'',playerB:'',winner:'',map:''});grpRefreshSets();
}
function grpDelGame(si,gi2){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];m.sets[si].games.splice(gi2,1);grpRefreshSets();
}

function grpSaveMatch(){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const {gi,mi}=grpMatchState;const m=tn.groups[gi].matches[mi];
  m.d=document.getElementById('gm-date')?.value||'';
  m.a=document.getElementById('gm-a')?.value||'';
  m.b=document.getElementById('gm-b')?.value||'';
  if(!m.a||!m.b){alert('ë‘ íŒ€ì„ ì„ íƒí•˜ì„¸ìš”.');return;}
  // ì´ì „ ê¸°ë¡ ë¡¤ë°±
  if(m._id)revertMatchRecord({...m,_id:m._id});
  const matchId=genId();m._id=matchId;
  let sa=0,sb=0;
  (m.sets||[]).forEach(set=>{
    let sA=0,sB=0;
    (set.games||[]).forEach(g=>{if(g.winner==='A')sA++;else if(g.winner==='B')sB++;});
    set.scoreA=sA;set.scoreB=sB;set.winner=sA>sB?'A':sB>sA?'B':'';
    if(set.winner==='A')sa++;else if(set.winner==='B')sb++;
  });
  m.sa=sa;m.sb=sb;
  // ì„ ìˆ˜ ê°œì¸ ì „ì  ìë™ ë°˜ì˜
  (m.sets||[]).forEach(set=>{
    (set.games||[]).forEach(g=>{
      if(!g.playerA||!g.playerB||!g.winner)return;
      const wn=g.winner==='A'?g.playerA:g.playerB;const ln=g.winner==='A'?g.playerB:g.playerA;
      applyGameResult(wn,ln,m.d,g.map||'',matchId);
    });
  });
  save();cm('grpMatchModal');render();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“‹ ëŒ€íšŒ ê²½ê¸° ë¶™ì—¬ë„£ê¸° ì¼ê´„ ì…ë ¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _grpPasteState = null; // {tnId, gi, mi}

/* â”€â”€ ëŒ€íšŒ ê²½ê¸° ë¶™ì—¬ë„£ê¸°: ì¼ë°˜ pasteModalì„ ì¬í™œìš© â”€â”€ */
function openGrpPasteModal(){
  _grpPasteState = {...grpMatchState};
  const tn = tourneys.find(t=>t.id===grpMatchState.tnId); if(!tn) return;
  const grp = tn.groups[grpMatchState.gi];
  const m = grp.matches[grpMatchState.mi];
  const teamA = document.getElementById('gm-a')?.value||m.a||'';
  const teamB = document.getElementById('gm-b')?.value||m.b||'';

  // ì¼ë°˜ pasteModalì„ ì—´ë˜ ëŒ€íšŒ ì„¸íŠ¸ ì ìš© ëª¨ë“œë¡œ í‘œì‹œ
  window._grpPasteMode = true; // pasteApplyì—ì„œ ëŒ€íšŒ ì„¸íŠ¸ ì ìš©ìœ¼ë¡œ ë¶„ê¸°

  // pasteModal ì´ˆê¸°í™” (openPasteModal ë¡œì§ ì¸ë¼ì¸)
  const textarea  = document.getElementById('paste-input');
  const previewEl = document.getElementById('paste-preview');
  const applyBtn  = document.getElementById('paste-apply-btn');
  const badge     = document.getElementById('paste-summary-badge');
  const pendWarn  = document.getElementById('paste-pending-warn');
  if (textarea)  textarea.value  = '';
  if (previewEl) previewEl.innerHTML = '';
  if (applyBtn)  { applyBtn.style.display = 'none'; applyBtn.textContent = 'âœ… ì„¸íŠ¸ì— ì ìš©'; }
  if (badge)     badge.style.display = 'none';
  if (pendWarn)  pendWarn.style.display = 'none';
  window._pasteResults = null;
  window._pasteErrors  = null;

  const dateInput = document.getElementById('paste-date');
  if (dateInput) dateInput.value = m.d || new Date().toISOString().slice(0,10);

  // ì €ì¥í˜•ì‹ ì˜ì—­ì— ëŒ€íšŒ íŒ€ ì •ë³´ ì•ˆë‚´ë¡œ ëŒ€ì²´ (ìˆ¨ê¹€ ì²˜ë¦¬)
  const modeWrap = document.querySelector('#pasteModal [id="paste-mode"]')?.closest('div');
  // ëª¨ë“œ ì„ íƒ ìˆ¨ê¸°ê³  ëŒ€íšŒ ì•ˆë‚´ ë°°ë„ˆ ì¶”ê°€
  const modeSel = document.getElementById('paste-mode');
  if(modeSel){ modeSel.value='comp'; modeSel.style.display='none'; }
  const modeLabel = document.getElementById('paste-mode-label');
  if(modeLabel) modeLabel.style.display='none';
  const hintEl = document.getElementById('paste-mode-hint');
  if(hintEl) hintEl.innerHTML = `<span style="color:#1d4ed8;font-weight:700">ğŸ† ëŒ€íšŒ ê²½ê¸° ì…ë ¥ ëª¨ë“œ</span> â€” <b>íŒ€A: ${teamA}</b> vs <b>íŒ€B: ${teamB}</b> Â· ë¶™ì—¬ë„£ê¸° í›„ [ì„¸íŠ¸ì— ì ìš©]ì„ ëˆ„ë¥´ë©´ ì„¸íŠ¸ì— ìë™ ì¶”ê°€ë©ë‹ˆë‹¤.`;

  // ì„¸íŠ¸ ì„ íƒ ë“œë¡­ë‹¤ìš´ì„ paste-comp-wrap ì˜ì—­ì— ì‚½ì…
  const compWrap = document.getElementById('paste-comp-wrap');
  if(compWrap){
    const setOpts = (m.sets||[]).map((s,i)=>{
      const lbl = i===2?'ğŸ¯ ì—ì´ìŠ¤ì „':`${i+1}ì„¸íŠ¸`;
      return `<option value="${i}">${lbl}</option>`;
    }).join('');
    compWrap.style.display='flex';
    compWrap.innerHTML = `
      <label style="font-size:12px;font-weight:700;white-space:nowrap">ì¶”ê°€í•  ì„¸íŠ¸:</label>
      <select id="grp-paste-set-sel" style="padding:5px 10px;border-radius:6px;border:1px solid var(--border2);font-size:12px">
        ${setOpts||'<option value="new">ìƒˆ ì„¸íŠ¸ ìë™ ì¶”ê°€</option>'}
        <option value="new">+ ìƒˆ ì„¸íŠ¸ ì¶”ê°€</option>
      </select>`;
  }

  om('pasteModal');
}

// grpPasteApply: pasteApplyì—ì„œ _grpPasteMode===trueì¼ ë•Œ í˜¸ì¶œë¨ (ì•„ë˜ pasteApply ë‚´ë¶€ì—ì„œ ë¶„ê¸°)
function _grpPasteApplyLogic(savable){
  const tn = tourneys.find(t=>t.id===_grpPasteState.tnId); if(!tn) return false;
  const m = tn.groups[_grpPasteState.gi].matches[_grpPasteState.mi];
  const teamA = document.getElementById('gm-a')?.value||m.a||'';
  const teamB = document.getElementById('gm-b')?.value||m.b||'';

  let setIdxEl = document.getElementById('grp-paste-set-sel');
  let setIdx = setIdxEl ? setIdxEl.value : 'new';
  if(!m.sets) m.sets=[];
  if(setIdx==='new'||setIdx===undefined){
    if(m.sets.length>=3){ alert('ìµœëŒ€ 3ì„¸íŠ¸ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return false; }
    m.sets.push({games:[],scoreA:0,scoreB:0,winner:''});
    setIdx = m.sets.length-1;
  } else {
    setIdx = parseInt(setIdx);
  }
  const set = m.sets[setIdx];
  if(!set.games) set.games=[];

  const teamANamesSet = new Set(players.filter(p=>p.univ===teamA).map(p=>p.name));
  savable.forEach(r=>{
    const wn = r.wPlayer.name; const ln = r.lPlayer.name;
    let pA='', pB='', winner='';
    if(teamANamesSet.has(wn)){ pA=wn; pB=ln; winner='A'; }
    else { pA=ln; pB=wn; winner='B'; }
    set.games.push({playerA:pA, playerB:pB, winner:winner, map:r.map||''});
  });
  let sA=0,sB=0;
  set.games.forEach(g=>{ if(g.winner==='A')sA++; else if(g.winner==='B')sB++; });
  set.scoreA=sA; set.scoreB=sB; set.winner=sA>sB?'A':sB>sA?'B':'';
  if(!m.a) m.a=teamA;
  if(!m.b) m.b=teamB;
  const dateEl = document.getElementById('paste-date');
  if(dateEl&&dateEl.value) m.d=dateEl.value;

  // ê°œì¸ ì „ì  ë°˜ì˜
  const matchId = genId();
  savable.forEach(r=>{ applyGameResult(r.wPlayer.name, r.lPlayer.name, dateEl?.value||'', r.map||'-', matchId); });

  save();
  grpRefreshSets();

  const toast=document.createElement('div');
  toast.textContent=`âœ… ${savable.length}ê±´ ${setIdx===2?'ì—ì´ìŠ¤ì „':(setIdx+1)+'ì„¸íŠ¸'}ì— ì¶”ê°€ë¨!`;
  toast.style.cssText='position:fixed;bottom:32px;left:50%;transform:translateX(-50%);background:#16a34a;color:#fff;padding:12px 24px;border-radius:10px;font-weight:700;font-size:14px;z-index:99999;box-shadow:0 4px 20px rgba(0,0,0,.2)';
  document.body.appendChild(toast);
  setTimeout(()=>toast.remove(),2500);
  return true;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ¯ í‹°ì–´ëŒ€íšŒ - CK ë°©ì‹ ê²½ê¸° ì…ë ¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _ttSub = 'input'; // input | records

function rTierTour(){
  if(!isLoggedIn && _ttSub==='input') _ttSub='records';
  const subOpts=[
    {id:'input',lbl:'ğŸ“ ê²½ê¸° ì…ë ¥',fn:`_ttSub='input';render()`},
    {id:'records',lbl:'ğŸ“‹ ê¸°ë¡',fn:`_ttSub='records';openDetails={};render()`}
  ];
  let h=stabs(_ttSub,subOpts);
  if(_ttSub==='input' && isLoggedIn){
    if(!BLD['tt'])BLD['tt']={date:'',tiers:[],membersA:[],membersB:[],sets:[]};
    h+=buildTierTourInputHTML();
  } else {
    // ê¸°ë¡ì€ ckM ì¤‘ tt íƒ€ì…ë§Œ or ë³„ë„ ttM ë°°ì—´ ì‚¬ìš©
    // ê°„ë‹¨í•˜ê²Œ ttM ë°°ì—´ì— ì €ì¥
    h+=ttM&&ttM.length?recSummaryListHTML(ttM,'tt','tiertour'):'<div style="padding:40px;text-align:center;color:var(--gray-l)">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
  }
  return h;
}

function buildTierTourInputHTML(){
  const bld=BLD['tt'];
  if(!bld.tiers)bld.tiers=[];
  const tfs=bld.tiers;
  const eligible=players.filter(p=>tfs.length===0||tfs.includes(p.tier));
  const mA=bld.membersA||[];const mB=bld.membersB||[];
  const addedNames=[...mA,...mB].map(m=>m.name);

  let h=`<div class="match-builder"><h3>ğŸ¯ í‹°ì–´ëŒ€íšŒ ì…ë ¥</h3>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
      <label style="font-size:12px;font-weight:700;color:var(--blue)">ë‚ ì§œ</label>
      <input type="date" value="${bld.date||''}" onchange="BLD['tt'].date=this.value">
    </div>

    <!-- ì°¸ê°€ í‹°ì–´ ì„ íƒ -->
    <div style="background:var(--blue-l);border:1px solid var(--blue-ll);border-radius:10px;padding:10px 14px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:var(--blue);margin-bottom:8px">â‘  ì°¸ê°€ í‹°ì–´ <span style="font-weight:400;color:var(--gray-l)">(ë³µìˆ˜ ì„ íƒ)</span></div>
      <div style="display:flex;gap:5px;flex-wrap:wrap">
        <button class="tier-filter-btn ${tfs.length===0?'on':''}" onclick="BLD['tt'].tiers=[];BLD['tt'].membersA=[];BLD['tt'].membersB=[];BLD['tt'].sets=[];render()">ì „ì²´</button>
        ${TIERS.map(t=>`<button class="tier-filter-btn ${tfs.includes(t)?'on':''}" onclick="ttToggleTier('${t}')">${getTierLabel(t)}</button>`).join('')}
      </div>
      <div style="font-size:11px;color:var(--blue);margin-top:6px">ëŒ€ìƒ ì„ ìˆ˜: <strong>${eligible.length}ëª…</strong></div>
    </div>

    <!-- ì„ ìˆ˜ ëª©ë¡ í´ë¦­ìœ¼ë¡œ íŒ€ ë°°ì • -->
    <div style="margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:var(--text2);margin-bottom:8px">â‘¡ ì„ ìˆ˜ í´ë¦­ â†’ íŒ€ ë°°ì • <span style="font-weight:400;color:var(--gray-l);font-size:11px">(AíŒ€ ë²„íŠ¼ / BíŒ€ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€)</span></div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;padding:10px;background:var(--surface);border:1px solid var(--border);border-radius:8px;max-height:200px;overflow-y:auto">
        ${eligible.length===0
          ?'<span style="color:var(--gray-l);font-size:12px">í‹°ì–´ë¥¼ ì„ íƒí•˜ë©´ ì„ ìˆ˜ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤</span>'
          :eligible.map(p=>{
              const inA=mA.some(m=>m.name===p.name);
              const inB=mB.some(m=>m.name===p.name);
              const bg=inA?'#2563eb':inB?'#dc2626':gc(p.univ);
              if(inA||inB){
                return `<span style="display:inline-flex;align-items:center;gap:3px;background:${bg};color:#fff;padding:4px 8px;border-radius:6px;font-size:11px;opacity:0.55">${p.name}<span style="opacity:.8;font-size:10px;margin-left:2px">${p.univ}/${p.tier}</span><span style="background:rgba(255,255,255,.3);border-radius:2px;padding:0 4px;font-size:9px;font-weight:800;margin-left:3px">${inA?'AíŒ€':'BíŒ€'}</span></span>`;
              }
              return `<span style="display:inline-flex;align-items:center;gap:4px;background:${bg};color:#fff;padding:3px 6px;border-radius:6px;font-size:11px">
                <span style="font-weight:700">${p.name}</span><span style="opacity:.8;font-size:10px">${p.univ}/${p.tier}</span>
                <button onclick="ttAddPlayer('A','${p.name}')" style="background:var(--white);color:#2563eb;border:none;border-radius:3px;padding:1px 6px;font-size:10px;font-weight:800;cursor:pointer;margin-left:2px">AíŒ€</button>
                <button onclick="ttAddPlayer('B','${p.name}')" style="background:var(--white);color:#dc2626;border:none;border-radius:3px;padding:1px 6px;font-size:10px;font-weight:800;cursor:pointer">BíŒ€</button>
              </span>`;
            }).join('')
        }
      </div>
    </div>

    <!-- íŒ€ êµ¬ì„± í™•ì¸ + ê²€ìƒ‰ ì¶”ê°€ -->
    <div style="display:flex;gap:14px;flex-wrap:wrap;margin-bottom:16px">
      <div class="ck-panel">
        <h4>ğŸ”µ íŒ€ A (${mA.length}ëª…)</h4>
        <div style="display:flex;gap:6px;margin-bottom:6px">
          <input type="text" id="tt-a-search" placeholder="ğŸ” ì´ë¦„Â·ë©”ëª¨ ê²€ìƒ‰..." style="flex:1;padding:5px 8px;border:1px solid var(--border2);border-radius:6px;font-size:12px" oninput="ttSearchPlayer('A')">
        </div>
        <div id="tt-a-drop" style="display:none;max-height:140px;overflow-y:auto;border:1px solid var(--border2);border-radius:6px;background:var(--white);margin-bottom:6px"></div>
        <div>${mA.map((m,i)=>`<span class="mem-tag" style="background:${gc(m.univ)}">${m.name}<span style="font-size:10px;opacity:.8">(${m.univ}${m.tier?'/'+m.tier:''})</span><button onclick="BLD['tt'].membersA.splice(${i},1);BLD['tt'].sets=[];render()">Ã—</button></span>`).join('')||'<span style="color:var(--gray-l);font-size:12px">ì„ ìˆ˜ ì—†ìŒ</span>'}</div>
      </div>
      <div class="ck-panel">
        <h4>ğŸ”´ íŒ€ B (${mB.length}ëª…)</h4>
        <div style="display:flex;gap:6px;margin-bottom:6px">
          <input type="text" id="tt-b-search" placeholder="ğŸ” ì´ë¦„Â·ë©”ëª¨ ê²€ìƒ‰..." style="flex:1;padding:5px 8px;border:1px solid var(--border2);border-radius:6px;font-size:12px" oninput="ttSearchPlayer('B')">
        </div>
        <div id="tt-b-drop" style="display:none;max-height:140px;overflow-y:auto;border:1px solid var(--border2);border-radius:6px;background:var(--white);margin-bottom:6px"></div>
        <div>${mB.map((m,i)=>`<span class="mem-tag" style="background:${gc(m.univ)}">${m.name}<span style="font-size:10px;opacity:.8">(${m.univ}${m.tier?'/'+m.tier:''})</span><button onclick="BLD['tt'].membersB.splice(${i},1);BLD['tt'].sets=[];render()">Ã—</button></span>`).join('')||'<span style="color:var(--gray-l);font-size:12px">ì„ ìˆ˜ ì—†ìŒ</span>'}</div>
      </div>
    </div>`;
  h+=setBuilderHTML(bld,'tt');h+=`</div>`;return h;
}

function ttToggleTier(t){
  const bld=BLD['tt'];if(!bld)return;
  if(!bld.tiers)bld.tiers=[];
  const i=bld.tiers.indexOf(t);
  if(i>=0)bld.tiers.splice(i,1);else bld.tiers.push(t);
  bld.membersA=[];bld.membersB=[];bld.sets=[];render();
}

function ttAddPlayer(team, name){
  const bld=BLD['tt'];if(!bld)return;
  const all=[...(bld.membersA||[]),...(bld.membersB||[])];
  if(all.find(m=>m.name===name))return;
  const pObj=players.find(p=>p.name===name)||{};
  const mem={name,univ:pObj.univ||'',race:pObj.race||'',tier:pObj.tier||''};
  if(team==='A')bld.membersA.push(mem);else bld.membersB.push(mem);
  bld.sets=[];render();
}

function ttSearchPlayer(team){
  const searchEl=document.getElementById(`tt-${team.toLowerCase()}-search`);
  const dropEl=document.getElementById(`tt-${team.toLowerCase()}-drop`);
  if(!searchEl||!dropEl)return;
  const q=searchEl.value.trim().toLowerCase();
  if(!q){dropEl.style.display='none';dropEl.innerHTML='';return;}
  const bld=BLD['tt']||{};
  const tfs=bld.tiers||[];
  const already=[...(bld.membersA||[]),...(bld.membersB||[])].map(m=>m.name);
  const results=players.filter(p=>
    (tfs.length===0||tfs.includes(p.tier)) &&
    !already.includes(p.name) &&
    (p.name.toLowerCase().includes(q)||(p.memo||'').toLowerCase().includes(q)||(p.univ||'').toLowerCase().includes(q))
  ).slice(0,15);
  if(!results.length){dropEl.innerHTML='<div style="padding:8px 12px;color:var(--gray-l);font-size:12px">ê²°ê³¼ ì—†ìŒ</div>';dropEl.style.display='block';return;}
  dropEl.innerHTML=results.map(p=>`<div onclick="ttAddPlayer('${team}','${p.name}')"
    style="padding:7px 12px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;font-size:12px"
    onmouseover="this.style.background='#f0f6ff'" onmouseout="this.style.background=''">
    <span style="width:26px;height:26px;border-radius:5px;background:${gc(p.univ)};color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0">${p.race||'?'}</span>
    <div><div style="font-weight:700">${p.name} <span style="font-size:10px;color:var(--gray-l)">${p.univ} Â· ${p.tier||'-'}</span></div></div>
  </div>`).join('');
  dropEl.style.display='block';
}

function tierTourAutoGroup(){
  const st=_tierTourState;
  if(!st.groups.length){
    const n=parseInt(prompt('ëª‡ ì¡°ë¡œ ë‚˜ëˆŒê¹Œìš”?','4')||'0');
    if(!n||n<2)return;
    st.groups=[];
    for(let i=0;i<n;i++) st.groups.push({name:'GROUP '+String.fromCharCode(65+i),players:[],matches:[]});
  }
  // ì„ íƒëœ í‹°ì–´ ì„ ìˆ˜ë“¤ ì„ì–´ì„œ ë°°ì •
  const eligible=players.filter(p=>st.tiers.length===0||st.tiers.includes(p.tier));
  const shuffled=[...eligible].sort(()=>Math.random()-0.5);
  st.groups.forEach(g=>g.players=[]);
  shuffled.forEach((p,i)=>{
    st.groups[i%st.groups.length].players.push(p.name);
  });
  render();
}

function grpRenameTourney(){
  const tn=tourneys.find(t=>t.name===curComp);
  if(!tn){alert('ëŒ€íšŒë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');return;}
  const newName=prompt('ìƒˆ ëŒ€íšŒëª…ì„ ì…ë ¥í•˜ì„¸ìš”:',tn.name);
  if(!newName||!newName.trim()||newName.trim()===tn.name)return;
  const trimmed=newName.trim();
  if(tourneys.find(t=>t.name===trimmed&&t.id!==tn.id)){alert('ì´ë¯¸ ê°™ì€ ì´ë¦„ì˜ ëŒ€íšŒê°€ ìˆìŠµë‹ˆë‹¤.');return;}
  // compsì—ì„œë„ ëŒ€íšŒëª… ì—…ë°ì´íŠ¸
  comps.forEach(m=>{if(m.n===tn.name)m.n=trimmed;if(m.a===tn.name)m.a=trimmed;});
  curComp=trimmed;
  tn.name=trimmed;
  save();render();
}

function grpDelCurTourney(){
  const tn=tourneys.find(t=>t.name===curComp);
  if(!tn){alert('ëŒ€íšŒë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');return;}
  const matchCount=tn.groups.reduce((s,g)=>s+(g.matches||[]).length,0);
  if(!confirm(`"${tn.name}" ëŒ€íšŒë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(${tn.groups.length}ê°œ ì¡° Â· ${matchCount}ê²½ê¸° ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)`))return;
  const ti=tourneys.indexOf(tn);
  tourneys.splice(ti,1);
  curComp=tourneys.length?tourneys[0].name:'';
  save();render();
}

function grpNewLeagueTourney(){
  const name=prompt('ì¼ë°˜ ëŒ€íšŒëª…ì„ ì…ë ¥í•˜ì„¸ìš”:');if(!name||!name.trim())return;
  const id=genId();tourneys.unshift({id,name:name.trim(),type:'league',groups:[],createdAt:new Date().toISOString()});
  curComp=name.trim();save();grpEditId=tourneys[0].id;grpSub='edit';compSub='grpedit';render();
}
function grpNewTierTourney(){
  const name=prompt('í‹°ì–´ ëŒ€íšŒëª…ì„ ì…ë ¥í•˜ì„¸ìš”:');if(!name||!name.trim())return;
  const id=genId();tourneys.unshift({id,name:name.trim(),type:'tier',groups:[],createdAt:new Date().toISOString()});
  curComp=name.trim();save();compSub='tiertour';render();
}
function grpNewTourney(){grpNewLeagueTourney();}
function grpDelTourney(ti){
  if(!confirm(`"${tourneys[ti].name}" ëŒ€íšŒë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  if(curComp===tourneys[ti].name)curComp='';tourneys.splice(ti,1);save();render();
}
function grpFilterUnivSel(gi){
  const searchEl=document.getElementById(`grp-univ-search-${gi}`);
  const selEl=document.getElementById(`grp-univ-sel-${gi}`);
  if(!searchEl||!selEl)return;
  const q=searchEl.value.trim().toLowerCase();
  Array.from(selEl.options).forEach(opt=>{
    if(!opt.value)return;
    opt.style.display=(!q||opt.text.toLowerCase().includes(q))?'':'none';
  });
  // ì²« ë²ˆì§¸ ë§¤ì¹­ ì˜µì…˜ ìë™ ì„ íƒ
  const firstMatch=Array.from(selEl.options).find(o=>o.value&&o.style.display!=='none');
  if(firstMatch)selEl.value=firstMatch.value;
}

function grpAddGroup(tnId){
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  const name=`${'ABCDEFGHIJ'[tn.groups.length]||tn.groups.length+1}ì¡°`;
  tn.groups.push({name,univs:[],matches:[]});save();render();
}
function grpDelGroup(tnId,gi){
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  if(!confirm(`"${tn.groups[gi].name}"ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  tn.groups.splice(gi,1);save();render();
}
function grpAddUniv(tnId,gi){
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  const sel=document.getElementById(`grp-univ-sel-${gi}`);const val=sel?sel.value:'';
  if(!val){alert('ëŒ€í•™ì„ ì„ íƒí•˜ì„¸ìš”.');return;}
  if(tn.groups[gi].univs.includes(val)){alert('ì´ë¯¸ ì¶”ê°€ëœ ëŒ€í•™ì…ë‹ˆë‹¤.');return;}
  tn.groups[gi].univs.push(val);save();render();
}
function grpRemoveUniv(tnId,gi,ui){
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  tn.groups[gi].univs.splice(ui,1);save();render();
}
function bindLeagueDateBtns(){}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   íšŒì› ê´€ë¦¬ (rMember)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let memberSearch='';
let memberEditId=null;

const BAN_TYPES=[
  {val:'30h',lbl:'30ì‹œê°„'},{val:'60h',lbl:'60ì‹œê°„'},{val:'100h',lbl:'100ì‹œê°„'},
  {val:'10d',lbl:'10ì¼'},{val:'30d',lbl:'30ì¼'},{val:'60d',lbl:'60ì¼'},{val:'perm',lbl:'ì˜êµ¬ì°¨ë‹¨'}
];
const MEMBER_CATS=[{val:'warn',lbl:'âš ï¸ ì£¼ì˜'},{val:'bad',lbl:'ğŸ˜¡ ì•…ì„±'},{val:'sus',lbl:'ğŸ” ì˜ì‹¬'}];

function banEndLabel(m){
  if(!m.banType)return '';
  if(m.banType==='perm')return 'ì˜êµ¬ì°¨ë‹¨';
  if(!m.banEnd)return m.banType;
  const end=new Date(m.banEnd);const now=new Date();
  if(now>=end)return 'âœ… ì°¨ë‹¨ ì™„ë£Œ';
  const diff=Math.ceil((end-now)/3600000);
  return `ì°¨ë‹¨ ì¤‘ (${diff}ì‹œê°„ ë‚¨ìŒ)`;
}

function isBanDone(m){
  if(!m.banType||m.banType==='perm')return false;
  if(!m.banEnd)return false;
  return new Date()>=new Date(m.banEnd);
}

function rMember(C,T){
  T.innerText='ğŸ‘¥ íšŒì› ê´€ë¦¬';
  const adminOk=isLoggedIn;
  // ì°¨ë‹¨ ì™„ë£Œì ë¶„ë¦¬
  const done=members.filter(m=>isBanDone(m));
  const active=members.filter(m=>!isBanDone(m));
  const filtered=memberSearch
    ? active.filter(m=>m.nick.toLowerCase().includes(memberSearch.toLowerCase())||m.uid.toLowerCase().includes(memberSearch.toLowerCase()))
    : active;

  let h=`<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px">
    <input type="text" id="memberSearchInput" placeholder="ë‹‰ë„¤ì„ ë˜ëŠ” íšŒì›ë²ˆí˜¸ ì…ë ¥..." value="${memberSearch}"
      style="flex:1;max-width:280px" onkeydown="if(event.key==='Enter')memberDoSearch()">
    <button class="btn btn-b btn-sm" onclick="memberDoSearch()">ğŸ” íšŒì›ê²€ìƒ‰</button>
    ${memberSearch?`<button class="btn btn-w btn-sm" onclick="memberSearch='';render()">âœ• ì´ˆê¸°í™”</button>`:''}
    ${adminOk?`<button class="btn btn-g btn-sm" onclick="memberOpenAdd()">+ íšŒì› ì¶”ê°€</button>`:''}
  </div>`;

  // ì°¨ë‹¨ ì™„ë£Œì ì•Œë¦¼
  if(done.length){
    h+=`<div style="background:#f0fdf4;border:2px solid #86efac;border-radius:10px;padding:12px 16px;margin-bottom:16px">
      <div style="font-weight:700;font-size:13px;color:#16a34a;margin-bottom:8px">âœ… ì°¨ë‹¨ ì™„ë£Œì (${done.length}ëª…)</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">`;
    done.forEach(m=>{
      h+=`<span style="background:#dcfce7;color:#16a34a;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:700">
        ${m.nick} <span style="opacity:.6">(${m.uid})</span>
        ${adminOk?`<button onclick="memberConfirmDone('${m.id}')" style="background:none;border:none;color:#16a34a;cursor:pointer;font-weight:700;margin-left:4px">âœ“ í™•ì¸</button>`:''}
      </span>`;
    });
    h+=`</div></div>`;
  }

  if(!filtered.length){h+=`<div style="padding:40px;text-align:center;color:var(--gray-l);background:var(--surface);border-radius:10px">${memberSearch?'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ':'ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>`;C.innerHTML=h;return;}

  h+=`<table><thead><tr><th>ë‹‰ë„¤ì„</th><th>íšŒì›ë²ˆí˜¸</th><th>ë¶„ë¥˜</th><th>ì°¨ë‹¨</th><th>ì°¨ë‹¨ì´ë ¥</th><th>ìƒíƒœ</th><th>ë“±ë¡ì¼</th><th>ê´€ë¦¬</th></tr></thead><tbody>`;
  filtered.forEach(m=>{
    const catObj=MEMBER_CATS.find(c=>c.val===m.category)||{lbl:''};
    const banLabel=banEndLabel(m);
    const isActive=m.banType&&!isBanDone(m);
    const banHistCount=(m.banHistory||[]).length;
    h+=`<tr style="${isActive?'background:#fff1f1':''}">
      <td style="font-weight:700">${m.nick}</td>
      <td style="color:var(--gray-l)">${m.uid}</td>
      <td>${catObj.lbl?`<span style="font-size:11px">${catObj.lbl}</span>`:'-'}</td>
      <td><span style="font-size:11px;font-weight:700;color:${isActive?'var(--red)':banLabel.startsWith('âœ…')?'var(--green)':'var(--gray-l)'}">${banLabel||'-'}</span></td>
      <td><span style="font-size:11px;font-weight:700;color:${banHistCount>0?'var(--red)':'var(--gray-l)'}">${banHistCount}ê±´</span></td>
      <td><button class="btn-detail" style="font-size:11px" onclick="memberOpenDetail('${m.id}')">ìƒì„¸ë³´ê¸°</button></td>
      <td style="color:var(--gray-l);font-size:11px">${(m.createdAt||'').slice(0,10)}</td>
      <td class="no-export">${adminOk?`<button class="btn btn-o btn-xs" onclick="memberOpenEdit('${m.id}')">ìˆ˜ì •</button> <button class="btn btn-r btn-xs" onclick="memberDel('${m.id}')">ì‚­ì œ</button>`:'-'}</td>
    </tr>`;
  });
  h+=`</tbody></table>`;
  C.innerHTML=h;
}

function memberDoSearch(){
  const inp=document.getElementById('memberSearchInput');
  if(inp) memberSearch=inp.value.trim();
  render();
}

function memberOpenAdd(){
  memberEditId=null;_tmpPosts=[];_tmpComments=[];
  document.getElementById('memberModalTitle').textContent='íšŒì› ì¶”ê°€';
  memberFillForm({nick:'',uid:'',category:'warn',banType:'',memo:'',report:'',posts:[]});
  om('memberModal');
}

function memberOpenEdit(id){
  const m=members.find(x=>x.id===id);if(!m)return;
  memberEditId=id;_tmpPosts=[...(m.posts||[])];_tmpComments=[...(m.comments||[])];
  document.getElementById('memberModalTitle').textContent='íšŒì› ìˆ˜ì •';
  memberFillForm(m);
  om('memberModal');
}

function memberFillForm(m){
  const banOpts=BAN_TYPES.map(b=>`<option value="${b.val}"${m.banType===b.val?' selected':''}>${b.lbl}</option>`).join('');
  const catOpts=MEMBER_CATS.map(c=>`<option value="${c.val}"${m.category===c.val?' selected':''}>${c.lbl}</option>`).join('');
  // ì°¨ë‹¨ ì´ë ¥ í‘œì‹œ (ì €ì¥ëœ ê¸°ë¡)
  const banHist=(m.banHistory||[]);
  const banHistHTML=banHist.length?`<div style="margin-top:8px;max-height:120px;overflow-y:auto;">`+banHist.map(h=>`<div style="font-size:11px;padding:3px 8px;background:var(--surface);border-radius:4px;margin-bottom:3px;color:var(--gray-l)">${h.date} Â· ${h.type} Â· ${h.memo||''}</div>`).join('')+`</div>`:'<div style="font-size:11px;color:var(--gray-l)">ì—†ìŒ</div>';
  document.getElementById('memberModalBody').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div>
        <label style="font-size:11px;font-weight:700;color:var(--gray-l);display:block;margin-bottom:4px">ë‹‰ë„¤ì„ *</label>
        <input type="text" id="mb-nick" value="${m.nick||''}" placeholder="ë‹‰ë„¤ì„" style="width:100%">
      </div>
      <div>
        <label style="font-size:11px;font-weight:700;color:var(--gray-l);display:block;margin-bottom:4px">íšŒì›ë²ˆí˜¸ *</label>
        <input type="text" id="mb-uid" value="${m.uid||''}" placeholder="íšŒì›ë²ˆí˜¸" style="width:100%">
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div>
        <label style="font-size:11px;font-weight:700;color:var(--gray-l);display:block;margin-bottom:4px">ë¶„ë¥˜</label>
        <select id="mb-cat" style="width:100%"><option value="">ë¶„ë¥˜ ì—†ìŒ</option>${catOpts}</select>
      </div>
      <div>
        <label style="font-size:11px;font-weight:700;color:var(--gray-l);display:block;margin-bottom:4px">ì°¨ë‹¨ ê¸°ê°„ (ìƒˆë¡œ ì¶”ê°€)</label>
        <select id="mb-ban" style="width:100%"><option value="">ì°¨ë‹¨ ì—†ìŒ</option>${banOpts}</select>
      </div>
    </div>
    <div style="margin-bottom:10px">
      <label style="font-size:11px;font-weight:700;color:var(--gray-l);display:block;margin-bottom:4px">ë©”ëª¨</label>
      <textarea id="mb-memo" rows="2" style="width:100%;padding:8px;border:1px solid var(--border2);border-radius:6px;font-size:12px;resize:vertical">${m.memo||''}</textarea>
    </div>
    <div style="margin-bottom:10px">
      <label style="font-size:11px;font-weight:700;color:var(--red);display:block;margin-bottom:4px">ğŸš¨ ì‹ ê³  ë‚´ìš©</label>
      <textarea id="mb-report" rows="2" style="width:100%;padding:8px;border:1.5px solid var(--red);border-radius:6px;font-size:12px;resize:vertical;color:var(--text)">${m.report||''}</textarea>
    </div>
    <div style="background:var(--surface);border-radius:8px;padding:10px 12px;margin-bottom:10px">
      <div style="font-weight:700;font-size:12px;color:var(--red);margin-bottom:6px">ğŸš« ì°¨ë‹¨ ì´ë ¥ (${banHist.length}ê±´)</div>
      ${banHistHTML}
    </div>
    <div>
      <div style="font-weight:700;font-size:12px;color:var(--blue);margin-bottom:6px">ğŸ”— ê²Œì‹œê¸€ ì´ë ¥</div>
      <div id="mb-posts">${memberPostsHTML(_tmpPosts)}</div>
      <div style="display:flex;gap:6px;margin-top:6px">
        <input type="text" id="mb-post-url" placeholder="ê²Œì‹œê¸€ URL" style="flex:1">
        <input type="text" id="mb-post-note" placeholder="ë©”ëª¨" style="width:100px">
        <button class="btn btn-b btn-xs" onclick="memberAddPost()">ì¶”ê°€</button>
      </div>
    </div>
    <div style="margin-top:10px">
      <div style="font-weight:700;font-size:12px;color:var(--red);margin-bottom:6px">ğŸ’¬ ëŒ“ê¸€ ì´ë ¥</div>
      <div id="mb-comments">${memberCommentsHTML(_tmpComments)}</div>
    </div>`;
}

function memberPostsHTML(posts){
  if(!posts.length)return '<div style="color:var(--gray-l);font-size:11px">ì—†ìŒ</div>';
  return posts.map((p,i)=>`<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;background:var(--surface);padding:4px 8px;border-radius:6px">
    <a href="${p.url}" target="_blank" style="color:var(--blue);font-size:11px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.url}</a>
    ${p.note?`<span style="font-size:10px;color:var(--gray-l)">${p.note}</span>`:''}
    <span style="font-size:10px;color:var(--gray-l)">${(p.savedAt||'').slice(0,10)}</span>
    <button onclick="memberRemovePost(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:12px">Ã—</button>
  </div>`).join('');
}

function memberCommentsHTML(comments){
  if(!comments.length)return '<div style="color:var(--gray-l);font-size:11px">ì—†ìŒ</div>';
  return comments.map((c,i)=>`<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;background:var(--surface);padding:4px 8px;border-radius:6px">
    <a href="${c.url}" target="_blank" style="color:var(--red);font-size:11px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.url}</a>
    ${c.note?`<span style="font-size:10px;color:var(--gray-l)">${c.note}</span>`:''}
    <span style="font-size:10px;color:var(--gray-l)">${(c.savedAt||'').slice(0,10)}</span>
    <button onclick="memberRemoveComment(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:12px">Ã—</button>
  </div>`).join('');
}

// ì„ì‹œ í¸ì§‘ìš© ë°°ì—´
let _tmpPosts=[];
function memberAddPost(){
  const url=document.getElementById('mb-post-url').value.trim();
  const note=document.getElementById('mb-post-note').value.trim();
  if(!url)return;
  _tmpPosts.push({url,note,savedAt:new Date().toISOString()});
  document.getElementById('mb-post-url').value='';
  document.getElementById('mb-post-note').value='';
  document.getElementById('mb-posts').innerHTML=memberPostsHTML(_tmpPosts);
}
function memberRemovePost(i){_tmpPosts.splice(i,1);document.getElementById('mb-posts').innerHTML=memberPostsHTML(_tmpPosts);}

let _tmpComments=[];
function memberRemoveComment(i){_tmpComments.splice(i,1);const el=document.getElementById('mb-comments');if(el)el.innerHTML=memberCommentsHTML(_tmpComments);}

function memberSave(){
  const nick=document.getElementById('mb-nick').value.trim();
  const uid=document.getElementById('mb-uid').value.trim();
  if(!nick||!uid){alert('ë‹‰ë„¤ì„ê³¼ íšŒì›ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return;}
  const banType=document.getElementById('mb-ban').value;
  const cat=document.getElementById('mb-cat').value;
  const memo=document.getElementById('mb-memo').value;
  const report=document.getElementById('mb-report').value;
  let banEnd=null;
  if(banType&&banType!=='perm'){
    const now2=new Date();
    if(banType.endsWith('h'))banEnd=new Date(now2.getTime()+parseInt(banType)*3600000).toISOString();
    else if(banType.endsWith('d'))banEnd=new Date(now2.getTime()+parseInt(banType)*86400000).toISOString();
  }
  const now=new Date().toISOString();
  if(memberEditId){
    const idx=members.findIndex(m=>m.id===memberEditId);
    if(idx>=0){
      const existing=members[idx];
      const banHistory=[...(existing.banHistory||[])];
      // ìƒˆë¡œìš´ ì°¨ë‹¨ì´ ì¶”ê°€ëœ ê²½ìš°ì—ë§Œ ì´ë ¥ì— ê¸°ë¡
      if(banType&&banType!==existing.banType){
        const bt=BAN_TYPES.find(b=>b.val===banType);
        banHistory.push({date:now.slice(0,10),type:bt?bt.lbl:banType,memo,banEnd});
      }
      members[idx]={...existing,nick,uid,category:cat,banType,banEnd,banHistory,memo,report,posts:_tmpPosts,updatedAt:now};
    }
  } else {
    const banHistory=[];
    if(banType){const bt=BAN_TYPES.find(b=>b.val===banType);banHistory.push({date:now.slice(0,10),type:bt?bt.lbl:banType,memo,banEnd});}
    members.unshift({id:genId(),nick,uid,category:cat,banType,banEnd,banHistory,memo,report,posts:_tmpPosts,createdAt:now,updatedAt:now});
  }
  save();cm('memberModal');render();
}

function memberDel(id){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  members=members.filter(m=>m.id!==id);save();render();
}

function memberConfirmDone(id){
  const m=members.find(x=>x.id===id);if(!m)return;
  m.banType='';m.banEnd=null;save();render();
}

function memberOpenDetail(id){
  const m=members.find(x=>x.id===id);if(!m)return;
  const catObj=MEMBER_CATS.find(c=>c.val===m.category)||{lbl:''};
  const banLabel=banEndLabel(m);
  const banHist=(m.banHistory||[]);
  document.getElementById('memberDetailTitle').textContent=`ğŸ‘¤ ${m.nick} ìƒì„¸`;
  document.getElementById('memberDetailBody').innerHTML=`
    <div style="background:var(--surface);border-radius:8px;padding:14px;margin-bottom:14px">
      <div style="display:flex;gap:14px;flex-wrap:wrap">
        <div><div style="font-size:10px;color:var(--gray-l)">ë‹‰ë„¤ì„</div><div style="font-weight:700;font-size:15px">${m.nick}</div></div>
        <div><div style="font-size:10px;color:var(--gray-l)">íšŒì›ë²ˆí˜¸</div><div style="font-weight:700">${m.uid}</div></div>
        <div><div style="font-size:10px;color:var(--gray-l)">ë¶„ë¥˜</div><div>${catObj.lbl||'-'}</div></div>
        <div><div style="font-size:10px;color:var(--gray-l)">ì°¨ë‹¨ ìƒíƒœ</div><div style="font-weight:700;color:${banLabel.startsWith('âœ…')?'var(--green)':'var(--red)'}">${banLabel||'ì—†ìŒ'}</div></div>
        <div><div style="font-size:10px;color:var(--gray-l)">ë“±ë¡ì¼</div><div style="font-size:11px">${(m.createdAt||'').slice(0,10)}</div></div>
      </div>
      ${m.memo?`<div style="margin-top:10px;font-size:12px;background:var(--white);padding:8px 12px;border-radius:6px;border:1px solid var(--border)">ğŸ“ ${m.memo}</div>`:''}
      ${m.report?`<div style="margin-top:8px;font-size:12px;background:#fff1f1;padding:8px 12px;border-radius:6px;border:1px solid #fca5a5;color:var(--red)">ğŸš¨ ì‹ ê³ ë‚´ìš©: ${m.report}</div>`:''}
    </div>
    <div style="font-weight:700;font-size:12px;color:var(--red);margin-bottom:8px">ğŸš« ì°¨ë‹¨ ì´ë ¥ (${banHist.length}ê±´)</div>
    ${banHist.length?`<div style="max-height:150px;overflow-y:auto;margin-bottom:14px">`+banHist.map(h=>`<div style="font-size:11px;padding:4px 8px;background:var(--surface);border-radius:4px;margin-bottom:3px;color:var(--gray-l)">${h.date} Â· ${h.type} Â· ${h.memo||''}</div>`).join('')+'</div>':`<div style="color:var(--gray-l);font-size:11px;margin-bottom:14px">ì—†ìŒ</div>`}
    <div style="font-weight:700;font-size:12px;color:var(--blue);margin-bottom:8px">ğŸ”— ê²Œì‹œê¸€ ì´ë ¥ (${(m.posts||[]).length}ê±´)</div>
    ${(m.posts||[]).length?m.posts.map(p=>`<div style="margin-bottom:6px;padding:6px 10px;background:var(--surface);border-radius:6px;display:flex;align-items:center;gap:8px">
      <a href="${p.url}" target="_blank" onclick="event.stopPropagation()" style="color:var(--blue);font-size:12px;flex:1">ğŸ”— ê¸€ ì´ë ¥ í™•ì¸í•˜ê¸°</a>
      ${p.note?`<span style="font-size:10px;color:var(--gray-l)">${p.note}</span>`:''}
      <span style="font-size:10px;color:var(--gray-l)">${(p.savedAt||'').slice(0,10)}</span>
    </div>`).join(''):'<div style="color:var(--gray-l);font-size:11px">ì—†ìŒ</div>'}`;
  om('memberDetailModal');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„¤ì •
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rCfg(C,T){
  T.innerText='âš™ï¸ ì„¤ì •';
  let h=`<div class="ssec"><h4>ğŸ›ï¸ ëŒ€í•™ ê´€ë¦¬</h4>`;
  univCfg.forEach((u,i)=>{
    h+=`<div class="srow">
      <div class="cdot" style="background:${u.color}"></div>
      <input type="text" value="${u.name}" style="flex:1;max-width:160px" onblur="univCfg[${i}].name=this.value;save()">
      <input type="color" value="${u.color}" style="width:40px;height:32px;padding:2px;border-radius:5px;cursor:pointer;border:1px solid var(--border2)" onchange="univCfg[${i}].color=this.value;this.previousElementSibling.previousElementSibling.style.background=this.value;save()">
      <button class="btn btn-r btn-xs" onclick="delUniv(${i})">ì‚­ì œ</button>
    </div>`;
  });
  h+=`<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <input type="text" id="nu-n" placeholder="ìƒˆ ëŒ€í•™ëª…" style="width:150px">
    <input type="color" id="nu-c" value="#2563eb" style="width:40px;height:34px;padding:2px;border-radius:5px;cursor:pointer;border:1px solid var(--border2)">
    <button class="btn btn-b" onclick="addUniv()">+ ëŒ€í•™ ì¶”ê°€</button>
  </div></div>
  <div class="ssec"><h4>ğŸ—ºï¸ ë§µ ê´€ë¦¬</h4>`;
  maps.forEach((m,i)=>{
    h+=`<div class="srow">
      <span style="font-size:14px">ğŸ“</span>
      <input type="text" value="${m}" style="flex:1" onblur="maps[${i}]=this.value;save();refreshSel()">
      <button class="btn btn-r btn-xs" onclick="delMap(${i})">ì‚­ì œ</button>
    </div>`;
  });
  h+=`<div style="margin-top:12px;display:flex;gap:8px">
    <input type="text" id="nm" placeholder="ìƒˆ ë§µ ì´ë¦„" style="width:200px">
    <button class="btn btn-b" onclick="addMap()">+ ë§µ ì¶”ê°€</button>
  </div></div>
  <div class="ssec"><h4>âš¡ ë§µ ì•½ì ê´€ë¦¬ <span style="font-size:11px;font-weight:400;color:var(--gray-l)">ë¶™ì—¬ë„£ê¸° ì…ë ¥ ì‹œ ìë™ ë³€í™˜</span></h4>
    <div style="font-size:12px;color:var(--gray-l);margin-bottom:10px">
      ì•½ìë¥¼ ì…ë ¥í•˜ë©´ ê²½ê¸° ê²°ê³¼ ë¶™ì—¬ë„£ê¸° ì‹œ ìë™ìœ¼ë¡œ ì „ì²´ ë§µ ì´ë¦„ìœ¼ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.<br>
      <span style="color:var(--blue);font-weight:600">ì˜ˆ:</span> <code style="background:var(--surface);padding:1px 6px;border-radius:4px">ë…¹ â†’ ë…¹ì•„ì›ƒ</code>, <code style="background:var(--surface);padding:1px 6px;border-radius:4px">í´ â†’ í´ë¦¬í¬ì´ë“œ</code>
    </div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:12px">
      <div style="font-size:11px;font-weight:700;color:var(--text2);margin-bottom:8px">ğŸ“¦ ê¸°ë³¸ ë‚´ì¥ ì•½ì</div>
      <div style="display:flex;flex-wrap:wrap;gap:5px">
        ${Object.entries(PASTE_MAP_ALIAS_DEFAULT).slice(0,30).map(([k,v])=>k!==v?`<span style="background:var(--white);border:1px solid var(--border);border-radius:6px;padding:2px 9px;font-size:11px;font-family:monospace"><b>${k}</b> â†’ ${v}</span>`:'').filter(Boolean).join('')}
      </div>
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--text2);margin-bottom:8px">ğŸ”§ ì‚¬ìš©ì ì •ì˜ ì•½ì</div>
    <div id="alias-list" style="margin-bottom:10px"></div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input type="text" id="alias-key" placeholder="ì•½ì (ì˜ˆ: ë…¹)" style="width:100px" maxlength="10">
      <span style="color:var(--gray-l)">â†’</span>
      <select id="alias-val" style="width:180px;border:1px solid var(--border2);border-radius:7px;padding:5px 8px;font-size:13px">
        <option value="">ë§µ ì„ íƒ...</option>
        ${maps.map(m=>`<option value="${m}">${m}</option>`).join('')}
      </select>
      <button class="btn btn-b" onclick="addMapAlias()">+ ì•½ì ì¶”ê°€</button>
    </div>
    <div id="alias-msg" style="font-size:12px;margin-top:6px;min-height:16px"></div>
  </div>
  <div class="ssec"><h4>ğŸ·ï¸ ì„ ìˆ˜ ìƒíƒœ ì•„ì´ì½˜ ê´€ë¦¬</h4>
    <div style="font-size:12px;color:var(--gray-l);margin-bottom:12px">ì´ë¦„ ìš°ì¸¡ì— í‘œì‹œë  ìƒíƒœ ì•„ì´ì½˜ì„ ì„ ìˆ˜ë³„ë¡œ ì§€ì •í•©ë‹ˆë‹¤. í˜„í™©íŒÂ·ìˆœìœ„í‘œÂ·ì´ë¯¸ì§€ ì €ì¥ ëª¨ë‘ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
    <div style="padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:var(--blue);margin-bottom:10px">ğŸ¨ ì»¤ìŠ¤í…€ ì•„ì´ì½˜ ì´ëª¨ì§€ ì§€ì •</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        ${[1,2,3].map(n=>{const def=STATUS_ICON_DEFS['custom'+n];return `<div style="display:flex;align-items:center;gap:6px;background:var(--white);border:1px solid var(--border);border-radius:8px;padding:8px 12px">
          <span style="font-size:12px;font-weight:700">ì»¤ìŠ¤í…€${n}:</span>
          <span style="font-size:18px">${def?.emoji||''}</span>
          <input type="text" id="ci${n}" value="${def?.emoji||''}" placeholder="ì´ëª¨ì§€" style="width:44px;font-size:18px;text-align:center;border:1px solid var(--border2);border-radius:6px;padding:2px 4px">
          <button class="btn btn-b btn-xs" onclick="const v=document.getElementById('ci${n}').value.trim();if(v){saveCustomStatusIcon(${n},v);render();}">ì €ì¥</button>
        </div>`;}).join('')}
      </div>
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--text2);margin-bottom:8px">ì„ ìˆ˜ë³„ ìƒíƒœ ì•„ì´ì½˜ ì§€ì •</div>
    <div style="max-height:320px;overflow-y:auto;border:1px solid var(--border);border-radius:8px">
      ${players.length===0?'<div style="padding:20px;text-align:center;color:var(--gray-l)">ë“±ë¡ëœ ì„ ìˆ˜ ì—†ìŒ</div>':
        [...players].sort((a,b)=>a.name.localeCompare(b.name,'ko')).map(p=>{
          const cur=playerStatusIcons[p.name]||'';
          const pN=p.name.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
          return `<div style="display:flex;align-items:center;gap:8px;padding:7px 12px;border-bottom:1px solid var(--border)">
            ${getPlayerPhotoHTML(p.name,'26px')}
            <span style="font-weight:600;flex:1;min-width:0;font-size:13px">${p.name}<span style="font-size:10px;color:var(--gray-l);margin-left:4px">${p.univ||''}Â·${p.tier||''}</span></span>
            <span style="font-size:18px;min-width:24px;text-align:center">${cur}</span>
            <select onchange="setStatusIcon('${pN}',this.value);render()" style="font-size:12px;padding:3px 6px;border:1px solid var(--border2);border-radius:5px;max-width:110px">
              ${Object.entries(STATUS_ICON_DEFS).map(([id,d])=>`<option value="${id}"${(!cur&&id==='none')||(cur&&cur===d.emoji&&id!=='none')?' selected':''}>${d.emoji?d.emoji+' ':''}${d.label}</option>`).join('')}
            </select>
          </div>`;
        }).join('')
      }
    </div>
    <button class="btn btn-r btn-sm" style="margin-top:10px" onclick="if(confirm('ëª¨ë“  ìƒíƒœ ì•„ì´ì½˜ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')){playerStatusIcons={};localStorage.setItem('su_psi','{}');render();}">ì „ì²´ ì´ˆê¸°í™”</button>
  </div>
  <div class="ssec"><h4>ğŸ­ í‹°ì–´ ê´€ë¦¬</h4>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
      ${TIERS.map((t,i)=>`<div style="text-align:center;padding:8px 12px;background:var(--white);border:1px solid var(--border);border-radius:8px;display:flex;flex-direction:column;align-items:center;gap:4px">
        ${getTierBadge(t)}
        <div style="font-size:10px;color:var(--gray-l)">${i+1}ìˆœìœ„</div>
        ${!['G','K','JA','J','S','0í‹°ì–´'].includes(t)?`<button class="btn btn-r btn-xs" onclick="delTier('${t}')">ì‚­ì œ</button>`:''}
      </div>`).join('')}
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input type="text" id="nt-name" placeholder="í‹°ì–´ ì´ë¦„ (ì˜ˆ: 9í‹°ì–´)" style="width:160px">
      <button class="btn btn-b" onclick="addTier()">+ í‹°ì–´ ì¶”ê°€</button>
    </div>
    <div style="font-size:11px;color:var(--gray-l);margin-top:6px">â€» ê¸°ë³¸ í‹°ì–´(G/K/JA/J/S/0í‹°ì–´)ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
  </div>
  <div class="ssec"><h4>ğŸ‘¤ ê´€ë¦¬ì ê³„ì • ê´€ë¦¬</h4>
    <p style="font-size:12px;color:var(--gray-l);margin-bottom:12px">ê´€ë¦¬ìë¥¼ ì—¬ëŸ¬ ëª… ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ê³„ì •ì€ ìœ ì§€ë˜ê³  ìƒˆ ê³„ì •ì´ ì¶”ê°€ë©ë‹ˆë‹¤.</p>
    <div style="margin-bottom:14px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:8px">
      <div style="font-size:12px;font-weight:700;color:var(--blue);margin-bottom:8px">í˜„ì¬ ë“±ë¡ëœ ê´€ë¦¬ì ê³„ì • ìˆ˜: <span id="adm-count">-</span>ëª…</div>
      <div id="adm-list" style="font-size:11px;color:var(--gray-l)"></div>
      <button class="btn btn-r btn-xs" style="margin-top:8px" onclick="clearAllAdmins()">âš ï¸ ì „ì²´ ê³„ì • ì´ˆê¸°í™” (ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹)</button>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
      <input type="text" id="adm-id" placeholder="ìƒˆ ê´€ë¦¬ì ì•„ì´ë””" style="width:180px" autocomplete="off">
      <input type="password" id="adm-pw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ)" style="width:180px" autocomplete="new-password">
      <button class="btn btn-p" onclick="addAdminAccount()">ğŸ‘¤ ê´€ë¦¬ì ì¶”ê°€</button>
    </div>
    <div id="adm-msg" style="font-size:12px;min-height:18px"></div>
  </div>`;
  // ê´€ë¦¬ì ìˆ˜ í‘œì‹œ + ë§µ ì•½ì ëª©ë¡ ë Œë”ë§
  setTimeout(()=>{
    const el=document.getElementById('adm-count');
    const listEl=document.getElementById('adm-list');
    if(el){const h=getAdminHashes();el.textContent=h.length;}
    if(listEl){listEl.textContent='â€» ë³´ì•ˆìƒ ê³„ì • ëª©ë¡ì€ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';}
  },50);
  C.innerHTML=h;
  // alias-listëŠ” C.innerHTML ì„¸íŒ… í›„ ë Œë”ë§
  setTimeout(_refreshAliasList, 10);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„ ìˆ˜ CRUD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addPlayer(){
  const n=document.getElementById('p-name').value.trim();
  if(!n)return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
  if(players.find(p=>p.name===n))return alert('ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
  const _pRole=(document.getElementById('p-role')?.value||'').trim();
  players.push({name:n,univ:document.getElementById('p-univ').value,tier:document.getElementById('p-tier').value,race:document.getElementById('p-race').value,gender:document.getElementById('p-gender').value,role:_pRole||undefined,win:0,loss:0,points:0,history:[]});
  document.getElementById('p-name').value='';save();render();
}
function recMatch(){
  const wN=document.getElementById('ws').value.trim();const lN=document.getElementById('ls').value.trim();
  const w=players.find(p=>p.name===wN);const l=players.find(p=>p.name===lN);
  if(!w||!l||w===l)return alert('ì„ ìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì„ íƒí•˜ì„¸ìš”.');
  const m=document.getElementById('m-map').value;const d=document.getElementById('m-date').value;
  applyGameResult(wN,lN,d,m,genId());
  document.getElementById('ws').value='';document.getElementById('ls').value='';save();render();
}
function openEP(name){
  editName=name;const p=players.find(x=>x.name===name);
  document.getElementById('emBody').innerHTML=`
    <label>ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„</label><input type="text" id="ed-n" value="${p.name}">
    <label>í‹°ì–´</label><select id="ed-t">${TIERS.map(t=>`<option value="${t}"${p.tier===t?' selected':''}>${getTierLabel(t)}</option>`).join('')}</select>
    <label>ëŒ€í•™</label><select id="ed-u">${getAllUnivs().map(u=>`<option value="${u.name}"${p.univ===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
    <label>ì¢…ì¡±</label><select id="ed-r"><option value="T"${p.race==='T'?' selected':''}>í…Œë€</option><option value="Z"${p.race==='Z'?' selected':''}>ì €ê·¸</option><option value="P"${p.race==='P'?' selected':''}>í”„ë¡œí† ìŠ¤</option></select>
    <label>ì„±ë³„</label><select id="ed-g"><option value="F"${(p.gender||'F')==='F'?' selected':''}>ğŸ‘© ì—¬ì</option><option value="M"${p.gender==='M'?' selected':''}>ğŸ‘¨ ë‚¨ì</option></select>
    <label>ì§ì±… <span style="font-size:10px;font-weight:400;color:var(--gray-l)">(ì´ì‚¬ì¥/ì´ì¥/ë¶€ì´ì¥/ì´ê´„/êµìˆ˜/ì½”ì¹˜ëŠ” ì •ë ¬ ìš°ì„ ìˆœìœ„ ì ìš©)</span></label>
    <input type="text" id="ed-role" value="${p.role||''}" placeholder="ì˜ˆ: ì´ì‚¬ì¥, ì´ì¥, ë¶€ì´ì¥, ì´ê´„, êµìˆ˜, ì½”ì¹˜, í•™ìƒíšŒì¥, ì˜¤ë½ë¶€ì¥ ë“±" style="width:100%">
    <label>ğŸ–¼ í”„ë¡œí•„ ì‚¬ì§„ URL <span style="font-size:10px;font-weight:400;color:var(--gray-l)">(í˜„í™©íŒ ì¹´ë“œì— í‘œì‹œ Â· ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ì•„ì´ì½˜)</span></label>
    <div style="display:flex;gap:8px;align-items:center">
      <input type="text" id="ed-photo" value="${p.photo||''}" placeholder="https://... ì´ë¯¸ì§€ URL ì…ë ¥" style="flex:1" oninput="const v=this.value.trim();const img=document.getElementById('ed-photo-preview');if(v){img.src=v;img.style.display='block';}else{img.style.display='none';}">
      <img id="ed-photo-preview" src="${p.photo||''}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--border);flex-shrink:0;${p.photo?'':' display:none'}" onerror="this.style.display='none'">
    </div>
    <div style="font-size:10px;color:var(--gray-l);margin-top:-6px">ì´ë¯¸ì§€ URLì„ ë¶™ì—¬ë„£ìœ¼ë©´ í˜„í™©íŒ ì„ ìˆ˜ ì¹´ë“œì— í”„ë¡œí•„ ì‚¬ì§„ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
    <div style="margin-top:16px;padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;">
      <div style="font-weight:700;font-size:12px;color:var(--blue);margin-bottom:12px">ğŸ“Š ìŠ¹íŒ¨ ì§ì ‘ ì¡°ì •</div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px">
        <div style="flex:1;min-width:100px">
          <div style="font-size:11px;font-weight:700;color:var(--gray-l);margin-bottom:4px">ìŠ¹ (í˜„ì¬: ${p.win})</div>
          <input type="number" id="ed-win" value="${p.win}" min="0" style="width:100%">
        </div>
        <div style="flex:1;min-width:100px">
          <div style="font-size:11px;font-weight:700;color:var(--gray-l);margin-bottom:4px">íŒ¨ (í˜„ì¬: ${p.loss})</div>
          <input type="number" id="ed-loss" value="${p.loss}" min="0" style="width:100%">
        </div>
        <div style="flex:1;min-width:100px">
          <div style="font-size:11px;font-weight:700;color:var(--gray-l);margin-bottom:4px">í¬ì¸íŠ¸ (í˜„ì¬: ${p.points})</div>
          <input type="number" id="ed-pts" value="${p.points}" style="width:100%">
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-o btn-sm" onclick="
          if(confirm('ìŠ¹íŒ¨ì™€ íˆìŠ¤í† ë¦¬ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
            const p=players.find(x=>x.name===editName);
            p.win=0;p.loss=0;p.points=0;p.history=[];
            document.getElementById('ed-win').value=0;
            document.getElementById('ed-loss').value=0;
            document.getElementById('ed-pts').value=0;
            save();render();
          }
        ">ğŸ”„ ìŠ¹íŒ¨ ì „ì²´ ì´ˆê¸°í™”</button>
        <button class="btn btn-w btn-sm" onclick="
          const p=players.find(x=>x.name===editName);
          p.win=parseInt(document.getElementById('ed-win').value)||0;
          p.loss=parseInt(document.getElementById('ed-loss').value)||0;
          p.points=parseInt(document.getElementById('ed-pts').value)||0;
          save();render();
          document.getElementById('emBody').querySelector('.apply-ok').style.display='inline-block';
          setTimeout(()=>document.getElementById('emBody').querySelector('.apply-ok').style.display='none',1500);
        " style="border-color:var(--green);color:var(--green)">âœ… ìŠ¹íŒ¨ ì ìš©</button>
        <span class="apply-ok" style="display:none;color:var(--green);font-weight:700;font-size:12px;align-self:center">ì ìš©ë¨!</span>
      </div>
      <div style="font-size:10px;color:var(--gray-l);margin-top:8px">â€» ìŠ¹íŒ¨ ì´ˆê¸°í™” ì‹œ ê°œì¸ ê²½ê¸° ê¸°ë¡(íˆìŠ¤í† ë¦¬)ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤. ëŒ€ì „ ê¸°ë¡(ë¯¸ë‹ˆ/ëŒ€í•™ëŒ€ì „ ë“±)ì€ ìœ ì§€ë©ë‹ˆë‹¤.</div>
    </div>
    <div style="margin-top:14px;padding:14px;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;">
      <div style="font-weight:700;font-size:12px;color:#b45309;margin-bottom:8px">ğŸ“ ì„ ìˆ˜ ë©”ëª¨</div>
      <textarea id="ed-memo" style="width:100%;min-height:70px;font-size:12px;border:1px solid #fde68a;border-radius:6px;padding:8px;background:#fff;resize:vertical;font-family:'Noto Sans KR',sans-serif;line-height:1.6;box-sizing:border-box;" placeholder="ì„ ìˆ˜ì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">${p.memo||''}</textarea>
    </div>`;
  om('emModal');
}
function savePlayer(){
  const p=players.find(x=>x.name===editName);
  const newName=document.getElementById('ed-n').value.trim();
  const oldName=editName;

  // ì´ë¦„ ë³€ê²½ ì‹œ ëª¨ë“  ê¸°ë¡ ìë™ ê°±ì‹ 
  if(newName && newName !== oldName){
    // íˆìŠ¤í† ë¦¬ ë‚´ ìƒëŒ€ë°© ì´ë¦„ ê°±ì‹ 
    players.forEach(other=>{
      (other.history||[]).forEach(h=>{
        if(h.opp===oldName) h.opp=newName;
      });
    });
    // íˆìŠ¤í† ë¦¬ ë‚´ ë³¸ì¸ ì´ë¦„ì€ p.name ë³€ê²½ìœ¼ë¡œ ìë™ ì²˜ë¦¬
    // ë¯¸ë‹ˆëŒ€ì „/ëŒ€í•™ëŒ€ì „/ëŒ€íšŒ/CK/í”„ë¡œ ê²½ê¸° ë‚´ ì„ ìˆ˜ëª… ê°±ì‹ 
    const renameInMatches=(arr)=>{
      arr.forEach(m=>{
        (m.sets||[]).forEach(set=>{
          (set.games||[]).forEach(g=>{
            if(g.playerA===oldName) g.playerA=newName;
            if(g.playerB===oldName) g.playerB=newName;
            // g.winnerëŠ” 'A'/'B' ê°’ì´ë¯€ë¡œ ì´ë¦„ ë¹„êµ ë¶ˆí•„ìš”
          });
        });
        (m.teamAMembers||[]).forEach(mb=>{if(mb.name===oldName)mb.name=newName;});
        (m.teamBMembers||[]).forEach(mb=>{if(mb.name===oldName)mb.name=newName;});
      });
    };
    renameInMatches(miniM);
    renameInMatches(univM);
    renameInMatches(comps);
    renameInMatches(ckM);
    renameInMatches(proM);
    // ì¡°í¸ì„± ëŒ€íšŒ
    tourneys.forEach(tn=>{
      tn.groups.forEach(grp=>{
        (grp.matches||[]).forEach(m=>{
          (m.sets||[]).forEach(set=>{
            (set.games||[]).forEach(g=>{
              if(g.playerA===oldName) g.playerA=newName;
              if(g.playerB===oldName) g.playerB=newName;
            });
          });
        });
      });
    });
  }

  p.name=newName||oldName;
  p.tier=document.getElementById('ed-t').value;
  p.univ=document.getElementById('ed-u').value;
  p.race=document.getElementById('ed-r').value;
  p.gender=document.getElementById('ed-g').value;
  const _rv=(document.getElementById('ed-role')?.value||'').trim();
  p.role=_rv||undefined;
  const _photo=(document.getElementById('ed-photo')?.value||'').trim();
  p.photo=_photo||undefined;
  p.win=parseInt(document.getElementById('ed-win').value)||0;
  p.loss=parseInt(document.getElementById('ed-loss').value)||0;
  p.points=parseInt(document.getElementById('ed-pts').value)||0;
  const _memo=(document.getElementById('ed-memo')?.value||'').trim();
  p.memo=_memo||undefined;
  save();render();cm('emModal');
  // playerModal ì—´ë ¤ìˆìœ¼ë©´ ë©”ëª¨ ì¦‰ì‹œ ê°±ì‹ 
  const _pm=document.getElementById('playerModal');
  if(_pm&&_pm.style.display!=='none'&&window._playerModalCurrentName===editName){
    const _pmb=document.getElementById('playerModalBody');
    if(_pmb) setTimeout(()=>{const _p2=players.find(x=>x.name===editName);if(_p2&&typeof buildPlayerModalHTML==='function')_pmb.innerHTML=buildPlayerModalHTML(_p2);},50);
  }
}
function setAllFemale(){
  if(!confirm(`ëª¨ë“  ìŠ¤íŠ¸ë¦¬ë¨¸ ${players.length}ëª…ì„ ì—¬ìë¡œ ì¼ê´„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´í›„ ë‚¨ì ì„ ìˆ˜ëŠ” ê°œë³„ ìˆ˜ì •ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.`))return;
  players.forEach(p=>p.gender='F');
  save();render();
  alert(`ì™„ë£Œ! ì´ ${players.length}ëª…ì´ ì—¬ìë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

function delPlayer(){
  if(confirm(`"${editName}" ì„ ìˆ˜ë¥¼ ì‚­ì œí• ê¹Œìš”?`)){const idx=players.findIndex(p=>p.name===editName);if(idx>=0)players.splice(idx,1);save();render();cm('emModal');}
}

function openRE(mode,idx){
  reMode=mode;reIdx=idx;const allU=getAllUnivs();
  let body='',tit='';
  if(mode==='mini'){
    const m=miniM[idx];tit='âš¡ ë¯¸ë‹ˆëŒ€ì „ ìˆ˜ì •';
    body=`<label>ë‚ ì§œ</label><input type="date" id="re-d" value="${m.d}">
      <label>íŒ€ A ëŒ€í•™</label><select id="re-a">${allU.map(u=>`<option value="${u.name}"${m.a===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
      <label>íŒ€ A ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sa" value="${m.sa}">
      <label>íŒ€ B ëŒ€í•™</label><select id="re-b">${allU.map(u=>`<option value="${u.name}"${m.b===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
      <label>íŒ€ B ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sb" value="${m.sb}">`;
  } else if(mode==='univm'){
    const m=univM[idx];tit='ğŸŸï¸ ëŒ€í•™ëŒ€ì „ ìˆ˜ì •';
    body=`<label>ë‚ ì§œ</label><input type="date" id="re-d" value="${m.d}">
      <label>íŒ€ A</label><select id="re-a">${allU.map(u=>`<option value="${u.name}"${m.a===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
      <label>A ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sa" value="${m.sa}">
      <label>íŒ€ B</label><select id="re-b">${allU.map(u=>`<option value="${u.name}"${m.b===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
      <label>B ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sb" value="${m.sb}">`;
  } else if(mode==='comp'){
    const c=comps[idx];tit='ğŸ–ï¸ ëŒ€íšŒ ìˆ˜ì •';
    body=`<label>ë‚ ì§œ</label><input type="date" id="re-d" value="${c.d}">
      <label>ëŒ€íšŒëª…</label><input type="text" id="re-cn" value="${c.n}">
      <label>ëŒ€í•™ A</label><select id="re-a">${allU.map(u=>`<option value="${u.name}"${(c.a||c.u)===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
      <label>A ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sa" value="${c.sa||0}">
      <label>ëŒ€í•™ B</label><select id="re-b">${allU.map(u=>`<option value="${u.name}"${c.b===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
      <label>B ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sb" value="${c.sb||0}">`;
  } else if(mode==='pro'){
    const m=proM[idx];tit='ğŸ… í”„ë¡œë¦¬ê·¸ ìˆ˜ì •';
    const mA=m.teamAMembers||[];const mB=m.teamBMembers||[];
    body=`<label>ë‚ ì§œ</label><input type="date" id="re-d" value="${m.d||''}">
      <label>AíŒ€ ë ˆì´ë¸”</label><input type="text" id="re-tla" value="${m.teamALabel||''}">
      <label>AíŒ€ ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sa" value="${m.sa||0}">
      <label>BíŒ€ ë ˆì´ë¸”</label><input type="text" id="re-tlb" value="${m.teamBLabel||''}">
      <label>BíŒ€ ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sb" value="${m.sb||0}">
      <div style="margin-top:10px;font-size:11px;color:var(--gray-l)">â€» ì„¸íŠ¸ë³„ ê°œì¸ ê²½ê¸°ëŠ” ê¸°ë¡ ìƒì„¸ë³´ê¸°ì—ì„œ ìˆ˜ì •í•˜ì„¸ìš”.</div>`;
  } else if(mode==='tt'){
    const m=ttM[idx];tit='ğŸ¯ í‹°ì–´ëŒ€íšŒ ìˆ˜ì •';
    body=`<label>ë‚ ì§œ</label><input type="date" id="re-d" value="${m.d||''}">
      <label>ëŒ€íšŒëª…/ë©”ëª¨</label><input type="text" id="re-ttn" value="${m.n||m.t||''}">
      <label>AíŒ€ ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sa" value="${m.sa||0}">
      <label>BíŒ€ ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sb" value="${m.sb||0}">
      <div style="margin-top:10px;font-size:11px;color:var(--gray-l)">â€» ì„¸íŠ¸ë³„ ê°œì¸ ê²½ê¸°ëŠ” ê¸°ë¡ ìƒì„¸ë³´ê¸°ì—ì„œ ìˆ˜ì •í•˜ì„¸ìš”.</div>`;
  }
  document.getElementById('reTitle').innerText=tit;
  document.getElementById('reBody').innerHTML=body;om('reModal');
}
function saveRow(){
  const d=document.getElementById('re-d')?.value||'';
  if(reMode==='mini'){
    miniM[reIdx].d=d;
    miniM[reIdx].a=document.getElementById('re-a')?.value||miniM[reIdx].a;
    miniM[reIdx].b=document.getElementById('re-b')?.value||miniM[reIdx].b;
    miniM[reIdx].sa=parseInt(document.getElementById('re-sa').value)||0;
    miniM[reIdx].sb=parseInt(document.getElementById('re-sb').value)||0;
  } else if(reMode==='univm'){
    const m=univM[reIdx];m.d=d;m.a=document.getElementById('re-a').value;
    m.sa=parseInt(document.getElementById('re-sa').value)||0;
    m.b=document.getElementById('re-b').value;m.sb=parseInt(document.getElementById('re-sb').value)||0;
  } else if(reMode==='comp'){
    const c=comps[reIdx];c.d=d;c.n=document.getElementById('re-cn').value;
    c.a=document.getElementById('re-a').value;c.u=c.a;c.hostUniv=c.a;
    c.sa=parseInt(document.getElementById('re-sa').value)||0;
    c.b=document.getElementById('re-b').value;c.sb=parseInt(document.getElementById('re-sb').value)||0;
  } else if(reMode==='pro'){
    const m=proM[reIdx];m.d=d;
    m.teamALabel=document.getElementById('re-tla')?.value||m.teamALabel;
    m.teamBLabel=document.getElementById('re-tlb')?.value||m.teamBLabel;
    m.sa=parseInt(document.getElementById('re-sa').value)||0;
    m.sb=parseInt(document.getElementById('re-sb').value)||0;
  } else if(reMode==='tt'){
    const m=ttM[reIdx];m.d=d;
    const ttn=document.getElementById('re-ttn')?.value;
    if(ttn!==undefined){m.n=ttn;m.t=ttn;}
    m.sa=parseInt(document.getElementById('re-sa').value)||0;
    m.sb=parseInt(document.getElementById('re-sb').value)||0;
  }
  save();render();cm('reModal');
}

function addUniv(){const n=document.getElementById('nu-n').value.trim();const c=document.getElementById('nu-c').value;if(!n)return;univCfg.push({name:n,color:c});save();render();refreshSel();}
function delUniv(i){if(confirm(`"${univCfg[i].name}" ì‚­ì œ?`)){univCfg.splice(i,1);save();render();refreshSel();}}
function addMap(){const n=document.getElementById('nm').value.trim();if(!n)return;maps.push(n);save();render();refreshSel();}
function delMap(i){maps.splice(i,1);save();render();refreshSel();}

function _refreshAliasList(){
  const listEl = document.getElementById('alias-list');
  if(!listEl) return;
  const entries = Object.entries(userMapAlias);
  if(entries.length === 0){
    listEl.innerHTML = '<div style="font-size:12px;color:var(--gray-l);padding:8px 0">ì•„ì§ ì¶”ê°€ëœ ì•½ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  listEl.innerHTML = entries.map(([k,v])=>`
    <div class="srow">
      <code style="background:var(--blue-ll);color:var(--blue);border-radius:5px;padding:2px 10px;font-size:13px;font-weight:700;min-width:50px;text-align:center">${k}</code>
      <span style="color:var(--gray-l)">â†’</span>
      <span style="font-weight:600;font-size:13px">${v}</span>
      <button class="btn btn-r btn-xs" data-ak="${encodeURIComponent(k)}" onclick="delMapAlias(decodeURIComponent(this.getAttribute('data-ak')))">ì‚­ì œ</button>
    </div>`).join('');
}

function addMapAlias(){
  const key = (document.getElementById('alias-key')?.value || '').trim();
  const val = (document.getElementById('alias-val')?.value || '').trim();
  const msg = document.getElementById('alias-msg');
  if(!key){ if(msg){msg.style.color='var(--red)';msg.textContent='ì•½ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.';} return; }
  if(!val){ if(msg){msg.style.color='var(--red)';msg.textContent='ë§µì„ ì„ íƒí•˜ì„¸ìš”.';} return; }
  if(key===val){ if(msg){msg.style.color='var(--red)';msg.textContent='ì•½ìì™€ ë§µ ì´ë¦„ì´ ê°™ìŠµë‹ˆë‹¤.';} return; }
  if(PASTE_MAP_ALIAS_DEFAULT[key] && PASTE_MAP_ALIAS_DEFAULT[key]!==val){
    if(!confirm(`'${key}'ëŠ” ê¸°ë³¸ ë‚´ì¥ ì•½ì(${PASTE_MAP_ALIAS_DEFAULT[key]})ì…ë‹ˆë‹¤.\n'${val}'ìœ¼ë¡œ ë®ì–´ì“¸ê¹Œìš”?`)) return;
  }
  userMapAlias[key]=val;
  save();
  if(msg){msg.style.color='var(--green)';msg.textContent=`âœ… '${key}' â†’ '${val}' ì¶”ê°€ë¨`;}
  document.getElementById('alias-key').value='';
  document.getElementById('alias-val').value='';
  _refreshAliasList(); // render() ëŒ€ì‹  ëª©ë¡ë§Œ ë¶€ë¶„ ì—…ë°ì´íŠ¸
}

function delMapAlias(key){
  delete userMapAlias[key];
  save();
  _refreshAliasList();
}

function addTier(){
  const n=document.getElementById('nt-name').value.trim();
  if(!n)return alert('í‹°ì–´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
  if(TIERS.includes(n))return alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í‹°ì–´ì…ë‹ˆë‹¤.');
  TIERS.push(n);
  // TIERSëŠ” constì´ë¯€ë¡œ push ê°€ëŠ¥
  save();render();
  document.getElementById('p-tier').innerHTML=TIERS.map(t=>`<option value="${t}">${getTierLabel(t)}</option>`).join('');
}
function delTier(t){
  const protectedTiers=['G','K','JA','J','S','0í‹°ì–´'];
  if(protectedTiers.includes(t))return alert('ê¸°ë³¸ í‹°ì–´ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  if(!confirm(`"${t}" í‹°ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ í‹°ì–´ì˜ ì„ ìˆ˜ëŠ” ê¸°ë³¸ í‹°ì–´ë¡œ ë³€ê²½ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`))return;
  const idx=TIERS.indexOf(t);
  if(idx>=0)TIERS.splice(idx,1);
  save();render();
  document.getElementById('p-tier').innerHTML=TIERS.map(t2=>`<option value="${t2}">${getTierLabel(t2)}</option>`).join('');
}

async function addAdminAccount(){
  const id=document.getElementById('adm-id').value.trim();
  const pw=document.getElementById('adm-pw').value;
  const msg=document.getElementById('adm-msg');
  if(!id||!pw){msg.style.color='var(--red)';msg.textContent='ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.';return;}
  if(pw.length<4){msg.style.color='var(--red)';msg.textContent='ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';return;}
  const h=await sha256(id+':'+pw);
  const hashes=getAdminHashes();
  if(hashes.includes(h)){msg.style.color='var(--gold)';msg.textContent='ì´ë¯¸ ë™ì¼í•œ ê³„ì •ì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';return;}
  hashes.push(h);
  localStorage.setItem(ADMIN_HASH_KEY,JSON.stringify(hashes));
  msg.style.color='var(--green)';
  msg.textContent=`âœ… ê´€ë¦¬ì ê³„ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (ì•„ì´ë””: ${id}) í˜„ì¬ ì´ ${hashes.length}ëª…`;
  document.getElementById('adm-id').value='';
  document.getElementById('adm-pw').value='';
  // ì¹´ìš´íŠ¸ ê°±ì‹ 
  const el=document.getElementById('adm-count');
  if(el)el.textContent=hashes.length;
}

async function clearAllAdmins(){
  if(!confirm('ëª¨ë“  ê´€ë¦¬ì ê³„ì •ì„ ì´ˆê¸°í™”í•˜ê³  ê¸°ë³¸ ê³„ì •(admin99)ìœ¼ë¡œ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'))return;
  const h=await sha256('admin99:99admin');
  localStorage.setItem(ADMIN_HASH_KEY,JSON.stringify([h]));
  alert('ì´ˆê¸°í™” ì™„ë£Œ. ê¸°ë³¸ ê³„ì •(admin99 / 99admin)ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
  doLogout();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“Š í†µê³„ íƒ­
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let statsSub='overview';

function rStats(C,T){
  T.textContent='ğŸ“Š í†µê³„';
  const subOpts=[
    {id:'overview',    lbl:'ğŸ›ï¸ ì¢…í•©'},
    {id:'elo',         lbl:'ğŸ“ˆ ELO ê·¸ë˜í”„'},
    {id:'growth',      lbl:'ğŸ“Š ì„±ì¥ ê³¡ì„ '},
    {id:'award',       lbl:'ğŸ† ì´ë‹¬ì˜ ì„ ìˆ˜'},
    {id:'records',     lbl:'ğŸ–ï¸ ìµœë‹¤ ê¸°ë¡'},
    {id:'radar',       lbl:'ğŸ•¸ï¸ ëŒ€í•™ ë ˆì´ë”'},
    {id:'mismatch',    lbl:'âš¡ ë¯¸ìŠ¤ë§¤ì¹˜'},
    {id:'heatmap',     lbl:'ğŸ“… í™œë™ íˆíŠ¸ë§µ'},
    {id:'tierwin',     lbl:'ğŸ¯ í‹°ì–´ë³„ ìŠ¹ë¥ '},
    {id:'maprank',     lbl:'ğŸ—ºï¸ ë§µë³„ íŠ¹í™”'},
    {id:'univmatrix',  lbl:'ğŸ›ï¸ ëŒ€í•™ ë§¤íŠ¸ë¦­ìŠ¤'},
    {id:'racetrend',   lbl:'ğŸ”¬ ì¢…ì¡± íŠ¸ë Œë“œ'},
    ...(isLoggedIn?[{id:'csvexport',lbl:'ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°'}]:[]),
    {id:'sharecard',   lbl:'ğŸ´ ê³µìœ  ì¹´ë“œ'},
    {id:'advsearch',   lbl:'ğŸ” ê³ ê¸‰ ê²€ìƒ‰'},
    {id:'killer',      lbl:'ğŸ—¡ï¸ í‚¬ëŸ¬/í”¼í•´ì'},
    {id:'seasonal',    lbl:'ğŸ“… ìš”ì¼/ì‹œì¦Œ ìŠ¹ë¥ '},
    {id:'clutch',      lbl:'âš¡ í´ëŸ¬ì¹˜ ì§€ìˆ˜'},
    {id:'streakhist',  lbl:'ğŸ”¥ ì—­ëŒ€ ì—°ì† ê¸°ë¡'},
    {id:'tiermatch',   lbl:'ğŸ–ï¸ í‹°ì–´ë³„ ìŠ¹ë¥ '},
    {id:'univmatrix2', lbl:'ğŸ›ï¸ ëŒ€í•™ ë§¤íŠ¸ë¦­ìŠ¤+'},
  ];
  let h=`<div class="stabs no-export">${subOpts.map(o=>`<button class="stab ${statsSub===o.id?'on':''}" onclick="statsSub='${o.id}';render()">${o.lbl}</button>`).join('')}</div>`;
  if(statsSub==='overview')    h+=statsOverviewHTML();
  else if(statsSub==='elo')    h+=statsEloHTML();
  else if(statsSub==='growth') h+=statsGrowthHTML();
  else if(statsSub==='award')  h+=statsAwardHTML();
  else if(statsSub==='records')h+=statsRecordsHTML();
  else if(statsSub==='radar')  h+=statsRadarHTML();
  else if(statsSub==='mismatch')h+=statsMismatchHTML();
  else if(statsSub==='heatmap')  h+=statsHeatmapHTML();
  else if(statsSub==='tierwin')  h+=statsTierWinHTML();
  else if(statsSub==='maprank')  h+=statsMapRankHTML();
  else if(statsSub==='univmatrix')h+=statsUnivMatrixHTML();
  else if(statsSub==='racetrend')h+=statsRaceTrendHTML();
  else if(statsSub==='csvexport')h+=statsCsvExportHTML();
  else if(statsSub==='sharecard')h+=statsShareCardHTML();
  else if(statsSub==='advsearch')h+=statsAdvSearchHTML();
  else if(statsSub==='killer')   h+=statsKillerHTML();
  else if(statsSub==='seasonal') h+=statsSeasonalHTML();
  else if(statsSub==='clutch')   h+=statsClutchHTML();
  else if(statsSub==='streakhist')h+=statsStreakHistHTML();
  else if(statsSub==='tiermatch') h+=statsTierMatchHTML();
  else if(statsSub==='univmatrix2')h+=statsUnivMatrix2HTML();
  C.innerHTML=h;
  // ì„œë¸Œíƒ­ë³„ í›„ì²˜ë¦¬
  if(statsSub==='elo')         initEloChart();
  else if(statsSub==='growth') initGrowthChart();
  else if(statsSub==='radar')  initRadarChart();
  else if(statsSub==='racetrend') initRaceTrendChart();
}

/* â”€â”€â”€ ê³µí†µ ìœ í‹¸ â”€â”€â”€ */
function statsProMatchIds(){return new Set(proM.map(m=>m._id).filter(Boolean));}
function statsNonProHist(p){const s=statsProMatchIds();return(p.history||[]).filter(h=>!s.has(h.matchId));}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   1. ì¢…í•© (ê¸°ì¡´ ë‚´ìš© ìœ ì§€)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function statsOverviewHTML(){
  const proMatchIds=statsProMatchIds();
  const univStats={};
  players.forEach(p=>{
    if(!univStats[p.univ])univStats[p.univ]={w:0,l:0,color:gc(p.univ)};
    const h=statsNonProHist(p);
    univStats[p.univ].w+=h.filter(x=>x.result==='ìŠ¹').length;
    univStats[p.univ].l+=h.filter(x=>x.result==='íŒ¨').length;
  });
  const univRank=Object.entries(univStats)
    .map(([name,s])=>({name,w:s.w,l:s.l,color:s.color,rate:s.w+s.l===0?0:Math.round(s.w/(s.w+s.l)*100)}))
    .sort((a,b)=>b.rate-a.rate||b.w-a.w);

  const rv={T:{T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}},Z:{T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}},P:{T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}}};
  players.forEach(p=>{
    if(!p.history||!p.race)return;
    statsNonProHist(p).forEach(h=>{
      if(!h.oppRace||!rv[p.race]||!rv[p.race][h.oppRace])return;
      if(h.result==='ìŠ¹')rv[p.race][h.oppRace].w++;
      else if(h.result==='íŒ¨')rv[p.race][h.oppRace].l++;
    });
  });
  const mapStats={};
  players.forEach(p=>{
    (p.history||[]).forEach(h=>{
      if(!h.map||h.map==='-')return;
      if(!mapStats[h.map])mapStats[h.map]={w:0,l:0};
      if(h.result==='ìŠ¹')mapStats[h.map].w++;
      else if(h.result==='íŒ¨')mapStats[h.map].l++;
    });
  });
  const mapRank=Object.entries(mapStats).map(([name,s])=>({name,w:s.w,l:s.l,total:s.w+s.l})).sort((a,b)=>b.total-a.total);
  function calcFormPlayers(genderFilter, streakFilter){
    // streakFilter: 'ìŠ¹' = ì—°ìŠ¹ìë§Œ, 'íŒ¨' = ì—°íŒ¨ìë§Œ, undefined = ì „ì²´
    return players.filter(p=>(genderFilter?p.gender===genderFilter:true))
      .map(p=>{
        const hist=[...(p.history||[])].sort((a,b)=>(b.date||'').localeCompare(a.date||''));
        const rec=hist.slice(0,5);
        if(rec.length<1)return null;
        const streak=(()=>{let s=0,type=rec[0]?.result;for(const h of rec){if(h.result===type)s++;else break;}return{n:s,type};})();
        return{...p,form:rec,streak};
      }).filter(Boolean)
      .filter(p=>streakFilter?p.streak.type===streakFilter:true)
      .sort((a,b)=>b.streak.n-a.streak.n).slice(0,10);
  }
  const formF=calcFormPlayers('F','ìŠ¹'), formM=calcFormPlayers('M','ìŠ¹');
  const worstFormF=calcFormPlayers('F','íŒ¨'), worstFormM=calcFormPlayers('M','íŒ¨');
  const raceColor={T:'#2563eb',Z:'#dc2626',P:'#7c3aed'};
  const raceName={T:'í…Œë€',Z:'ì €ê·¸',P:'í”„ë¡œí† ìŠ¤'};
  const raceEmoji={T:'âš”ï¸',Z:'ğŸ¦Ÿ',P:'ğŸ”®'};
  function formRow(p,pi){
    const icons=p.form.map(h=>h.result==='ìŠ¹'
      ?'<span style="display:inline-block;width:20px;height:20px;background:var(--green);color:#fff;font-size:10px;font-weight:800;border-radius:4px;text-align:center;line-height:20px">W</span>'
      :'<span style="display:inline-block;width:20px;height:20px;background:var(--red);color:#fff;font-size:10px;font-weight:800;border-radius:4px;text-align:center;line-height:20px">L</span>').join('');
    const sc=p.streak.type==='ìŠ¹'?'var(--green)':'var(--red)';
    const si=p.streak.type==='ìŠ¹'?'ğŸ”¥':'â„ï¸';
    return`<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--white);border:1px solid var(--border);border-radius:8px">
      <span style="font-weight:700;font-size:11px;color:var(--gray-l);min-width:20px;text-align:right">${pi+1}</span>
      ${getPlayerPhotoHTML(p.name,'26px')}
      <span style="font-weight:800;font-size:13px;cursor:pointer;color:var(--blue);min-width:65px" onclick="openPlayerModal('${p.name}')">${p.name}${getStatusIconHTML(p.name)}</span>
      <span style="font-size:11px;color:${gc(p.univ)};font-weight:700;min-width:55px">${p.univ}</span>
      <span style="display:flex;gap:2px">${icons}</span>
      <span style="font-weight:800;font-size:12px;color:${sc};white-space:nowrap">${si} ${p.streak.n}ì—°${p.streak.type==='ìŠ¹'?'ìŠ¹':'íŒ¨'}</span>
    </div>`;
  }
  return`<div style="display:flex;flex-direction:column;gap:20px">
  <div class="ssec" id="stats-univ-sec">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
      <h4 style="margin:0;font-family:'Noto Sans KR',sans-serif">ğŸ›ï¸ ëŒ€í•™ë³„ ìŠ¹ë¥  ë­í‚¹</h4>
      <button class="btn-capture btn-xs no-export" onclick="captureStats()">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:6px">
      ${univRank.filter(u=>u.w+u.l>0).map((u,i)=>{
        const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`${i+1}ìœ„`;
        return`<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--white);border:1px solid var(--border);border-radius:8px;cursor:pointer" onclick="openUnivModal('${u.name}')">
          <span style="min-width:32px;font-weight:800;font-size:13px">${medal}</span>
          <span class="ubadge" style="background:${u.color};min-width:80px;text-align:center">${u.name}</span>
          <div style="flex:1;background:#f1f5f9;border-radius:20px;height:14px;overflow:hidden">
            <div style="width:${u.rate}%;background:${u.color};height:100%;border-radius:20px;transition:.3s"></div>
          </div>
          <span style="min-width:50px;text-align:right;font-weight:700;font-size:13px">${u.rate}%</span>
          <span style="color:var(--gray-l);font-size:11px">${u.w}ìŠ¹${u.l}íŒ¨</span>
        </div>`;
      }).join('')||'<p style="color:var(--gray-l)">ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
    </div>
  </div>
  <div class="ssec"><h4>âš”ï¸ ì¢…ì¡±ë³„ ìƒëŒ€ì „ì </h4><div style="overflow-x:auto"><table style="min-width:400px">
    <thead><tr><th>ë‚´\ìƒëŒ€</th>${['T','Z','P'].map(r=>`<th>${raceEmoji[r]} ${raceName[r]}</th>`).join('')}</tr></thead>
    <tbody>${['T','Z','P'].map(r=>`<tr><td style="font-weight:700;color:${raceColor[r]}">${raceEmoji[r]} ${raceName[r]}</td>${['T','Z','P'].map(o=>{
      const s=rv[r][o];const rate=s.w+s.l===0?'-':Math.round(s.w/(s.w+s.l)*100)+'%';
      const bg=r===o?'background:#f1f5f9':s.w>s.l?'background:#f0fdf4':s.w<s.l?'background:#fef2f2':'';
      return`<td style="${bg}">${r===o?'<span style="color:var(--gray-l)">-</span>':`<span style="font-weight:700">${rate}</span><br><span style="font-size:10px;color:var(--gray-l)">${s.w}ìŠ¹${s.l}íŒ¨</span>`}</td>`;
    }).join('')}</tr>`).join('')}</tbody>
  </table></div></div>
  <div class="ssec"><h4>ğŸ—ºï¸ ë§µë³„ ê²½ê¸° í†µê³„</h4><div style="display:flex;flex-wrap:wrap;gap:8px">
    ${mapRank.map(m=>{const rate=m.total===0?0:Math.round(m.w/m.total*100);return`<div style="background:var(--white);border:1px solid var(--border);border-radius:10px;padding:12px 16px;min-width:150px;flex:1;max-width:220px">
      <div style="font-weight:800;font-size:13px;margin-bottom:4px">${m.name}</div>
      <div style="font-size:24px;font-weight:800;color:var(--blue)">${m.total}</div>
      <div style="font-size:10px;color:var(--gray-l);margin-bottom:6px">ì´ ê²½ê¸°</div>
      <div style="height:4px;border-radius:2px;background:var(--border);overflow:hidden;margin-bottom:4px"><div style="height:100%;width:${rate}%;background:var(--blue);border-radius:2px"></div></div>
      <div style="font-size:11px;display:flex;justify-content:space-between"><span style="color:var(--green);font-weight:700">${m.w}ìŠ¹</span><span style="color:var(--gray-l)">${rate}%</span><span style="color:var(--red);font-weight:700">${m.l}íŒ¨</span></div>
    </div>`;}).join('')||'<p style="color:var(--gray-l)">ê¸°ë¡ ì—†ìŒ</p>'}
  </div></div>
  <div class="ssec"><h4>ğŸ”¥ ìµœê·¼ í¼ TOP 10 <span style="font-size:12px;color:#db2777;font-weight:600">ğŸ‘© ì—¬ì</span></h4>
    <div style="display:flex;flex-direction:column;gap:4px">${formF.map(formRow).join('')||'<p style="color:var(--gray-l)">ê¸°ë¡ ì—†ìŒ</p>'}</div>
  </div>
  <div class="ssec"><h4>ğŸ”¥ ìµœê·¼ í¼ TOP 10 <span style="font-size:12px;color:#2563eb;font-weight:600">ğŸ‘¨ ë‚¨ì</span></h4>
    <div style="display:flex;flex-direction:column;gap:4px">${formM.map(formRow).join('')||'<p style="color:var(--gray-l)">ê¸°ë¡ ì—†ìŒ</p>'}</div>
  </div>
  <div class="ssec"><h4>ğŸ§Š ìµœì•… í¼ TOP 10 <span style="font-size:12px;color:#db2777;font-weight:600">ğŸ‘© ì—¬ì</span> <span style="font-size:11px;color:var(--gray-l);font-weight:400">(ì—°íŒ¨ ì¤‘)</span></h4>
    <div style="display:flex;flex-direction:column;gap:4px">${worstFormF.map(formRow).join('')||'<p style="color:var(--gray-l)">ì—°íŒ¨ ì¤‘ì¸ ì„ ìˆ˜ ì—†ìŒ</p>'}</div>
  </div>
  <div class="ssec"><h4>ğŸ§Š ìµœì•… í¼ TOP 10 <span style="font-size:12px;color:#2563eb;font-weight:600">ğŸ‘¨ ë‚¨ì</span> <span style="font-size:11px;color:var(--gray-l);font-weight:400">(ì—°íŒ¨ ì¤‘)</span></h4>
    <div style="display:flex;flex-direction:column;gap:4px">${worstFormM.map(formRow).join('')||'<p style="color:var(--gray-l)">ì—°íŒ¨ ì¤‘ì¸ ì„ ìˆ˜ ì—†ìŒ</p>'}</div>
  </div>
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   2. ELO ë­í‚¹ ë³€ë™ ê·¸ë˜í”„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _eloSelPlayer='';
function eloSearchFilter(q){
  const d=document.getElementById('elo-search-drop');if(!d)return;
  const items=d.querySelectorAll('.sitem');
  items.forEach(el=>{el.style.display=el.textContent.toLowerCase().includes(q.toLowerCase())?'':'none';});
}
function statsEloHTML(){
  const allWithHist=players.filter(p=>p.history&&p.history.length>0)
    .sort((a,b)=>(b.elo||1200)-(a.elo||1200));
  const top20=allWithHist.slice(0,30);
  if(!_eloSelPlayer&&allWithHist.length)_eloSelPlayer=allWithHist[0].name;
  const selP=players.find(p=>p.name===_eloSelPlayer);
  return`<div style="display:flex;flex-direction:column;gap:16px">
  <div class="ssec" id="stats-elo-sec">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
      <h4 style="margin:0">ğŸ“ˆ ELO ë­í‚¹ ë³€ë™ ê·¸ë˜í”„</h4>
      <div style="position:relative">
        <input id="elo-search-input" type="text" placeholder="ğŸ” ì„ ìˆ˜ ì´ë¦„ ê²€ìƒ‰..."
          value="${_eloSelPlayer}"
          style="font-size:12px;padding:5px 10px;border:1px solid var(--border2);border-radius:8px;width:200px"
          oninput="eloSearchFilter(this.value)"
          onfocus="document.getElementById('elo-search-drop').style.display='block'"
          onblur="setTimeout(()=>{const d=document.getElementById('elo-search-drop');if(d)d.style.display='none'},200)"
          onkeydown="if(event.key==='Enter'){const q=this.value.trim();const m=players.filter(p=>p.history&&p.history.length>0&&p.name.includes(q));if(m.length===1){_eloSelPlayer=m[0].name;this.value=m[0].name;document.getElementById('elo-search-drop').style.display='none';initEloChart();}else if(q&&m.length>0){_eloSelPlayer=m[0].name;this.value=m[0].name;document.getElementById('elo-search-drop').style.display='none';initEloChart();}}">
        <div id="elo-search-drop" style="display:none;position:absolute;top:34px;left:0;background:var(--white);border:1px solid var(--border2);border-radius:8px;z-index:300;max-height:200px;overflow-y:auto;width:260px;box-shadow:var(--sh2)">
          ${allWithHist.map(p=>`<div class="sitem" onmousedown="_eloSelPlayer='${p.name.replace(/'/g,"\'")}';document.getElementById('elo-search-input').value='${p.name.replace(/'/g,"\'")}';document.getElementById('elo-search-drop').style.display='none';initEloChart()">
            <b>${p.name}</b> <span style="color:${gc(p.univ)};font-size:11px">${p.univ}</span> <span style="color:var(--gray-l);font-size:10px">ELO ${p.elo||1200}</span>
          </div>`).join('')}
        </div>
      </div>
      ${selP?`<span class="ubadge" style="background:${gc(selP.univ)}">${selP.univ}</span>`:''}
      <button class="btn-capture btn-xs no-export" style="margin-left:auto" onclick="captureSection('stats-elo-sec','elo_ranking')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
    <canvas id="eloChart" style="width:100%;max-height:300px"></canvas>
    <div id="eloRankTable" style="margin-top:16px"></div>
  </div>
  <div class="ssec">
    <h4>ğŸ… í˜„ì¬ ELO ë­í‚¹ TOP 20</h4>
    <div style="display:flex;flex-direction:column;gap:4px;margin-top:8px">
      ${top20.map((p,i)=>{
        const elo=p.elo||1200;
        const eloColor=elo>=1400?'#7c3aed':elo>=1300?'#d97706':elo>=1200?'var(--green)':'var(--red)';
        const badge=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`${i+1}`;
        const bar=Math.min(100,Math.max(0,((elo-900)/800)*100));
        return`<div style="display:flex;align-items:center;gap:8px;padding:7px 12px;background:var(--white);border:1px solid var(--border);border-radius:8px;cursor:pointer" onclick="_eloSelPlayer='${p.name}';initEloChart()">
          <span style="min-width:28px;font-weight:800;font-size:12px">${badge}</span>
          <span style="font-weight:800;font-size:13px;color:var(--blue);min-width:70px">${p.name}</span>
          <span style="font-size:11px;color:${gc(p.univ)};font-weight:700;min-width:60px">${p.univ}</span>
          <div style="flex:1;background:#f1f5f9;border-radius:20px;height:10px;overflow:hidden">
            <div style="width:${bar}%;background:${eloColor};height:100%;border-radius:20px"></div>
          </div>
          <span style="font-weight:800;font-size:14px;color:${eloColor};min-width:48px;text-align:right">${elo}</span>
          ${(()=>{const now=new Date();const ym=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;const d=(p.history||[]).filter(h=>h.date&&h.date.startsWith(ym)&&h.eloDelta!=null).reduce((s,h)=>s+(h.eloDelta||0),0);return d!==0?`<span style="font-size:10px;font-weight:700;color:${d>0?'#16a34a':'#dc2626'};background:${d>0?'#dcfce7':'#fee2e2'};padding:1px 6px;border-radius:4px">${d>0?'+':''}${d}</span>`:'';})()} 
        </div>`;
      }).join('')}
    </div>
  </div>
  </div>`;
}
function initEloChart(){
  const canvas=document.getElementById('eloChart');
  if(!canvas)return;
  const p=players.find(x=>x.name===_eloSelPlayer);
  if(!p||!p.history||!p.history.length){canvas.style.display='none';return;}
  canvas.style.display='block';
  const hist=[...p.history].reverse();
  // ELO ì¬êµ¬ì„±: eloAfter í•„ë“œ ì‚¬ìš©
  const pts=[];let elo=1200;
  hist.forEach((h,i)=>{
    if(h.eloAfter!=null)pts.push({i,elo:h.eloAfter,date:h.date||'',result:h.result,opp:h.opp||''});
    else{elo+=(h.eloDelta||0);pts.push({i,elo,date:h.date||'',result:h.result,opp:h.opp||''});}
  });
  if(!pts.length)return;
  const ctx=canvas.getContext('2d');
  const W=canvas.offsetWidth||600;const H=280;
  canvas.width=W;canvas.height=H;
  const pad={t:20,r:20,b:50,l:55};
  const minE=Math.min(...pts.map(x=>x.elo))-30;
  const maxE=Math.max(...pts.map(x=>x.elo))+30;
  const mapX=i=>(i/(pts.length-1||1))*(W-pad.l-pad.r)+pad.l;
  const mapY=e=>H-pad.b-((e-minE)/(maxE-minE||1))*(H-pad.t-pad.b);
  ctx.clearRect(0,0,W,H);
  // ë°°ê²½ ê·¸ë¦¬ë“œ
  ctx.strokeStyle='#e2e8f0';ctx.lineWidth=1;
  for(let g=0;g<=4;g++){
    const y=pad.t+g*(H-pad.t-pad.b)/4;
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
    const val=Math.round(maxE-g*(maxE-minE)/4);
    ctx.fillStyle='#94a3b8';ctx.font='10px sans-serif';ctx.textAlign='right';
    ctx.fillText(val,pad.l-4,y+4);
  }
  // 1200 ê¸°ì¤€ì„ 
  const baseY=mapY(1200);
  ctx.strokeStyle='#cbd5e1';ctx.setLineDash([4,4]);ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(pad.l,baseY);ctx.lineTo(W-pad.r,baseY);ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle='#94a3b8';ctx.font='9px sans-serif';ctx.textAlign='left';
  ctx.fillText('1200',pad.l+2,baseY-3);
  // ê·¸ë¼ë””ì–¸íŠ¸ ì±„ìš°ê¸°
  const grad=ctx.createLinearGradient(0,pad.t,0,H-pad.b);
  grad.addColorStop(0,'rgba(37,99,235,0.25)');grad.addColorStop(1,'rgba(37,99,235,0)');
  ctx.beginPath();ctx.moveTo(mapX(0),mapY(pts[0].elo));
  pts.forEach(pt=>ctx.lineTo(mapX(pt.i),mapY(pt.elo)));
  ctx.lineTo(mapX(pts.length-1),H-pad.b);ctx.lineTo(mapX(0),H-pad.b);
  ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  // ì„ 
  ctx.beginPath();ctx.strokeStyle='#2563eb';ctx.lineWidth=2.5;
  ctx.moveTo(mapX(0),mapY(pts[0].elo));
  pts.forEach(pt=>ctx.lineTo(mapX(pt.i),mapY(pt.elo)));
  ctx.stroke();
  // ì 
  pts.forEach(pt=>{
    ctx.beginPath();
    ctx.arc(mapX(pt.i),mapY(pt.elo),4,0,Math.PI*2);
    ctx.fillStyle=pt.result==='ìŠ¹'?'#16a34a':'#dc2626';
    ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=1.5;ctx.stroke();
  });
  // Xì¶• ë‚ ì§œ (ì²«/ë§ˆì§€ë§‰)
  ctx.fillStyle='#64748b';ctx.font='10px sans-serif';ctx.textAlign='center';
  if(pts.length>0)ctx.fillText(pts[0].date.slice(5)||'',mapX(0),H-pad.b+16);
  if(pts.length>1)ctx.fillText(pts[pts.length-1].date.slice(5)||'',mapX(pts.length-1),H-pad.b+16);
  // ì œëª©
  ctx.fillStyle='#1e293b';ctx.font='bold 13px sans-serif';ctx.textAlign='left';
  ctx.fillText(`${p.name} ELO ë³€ë™ (í˜„ì¬: ${p.elo||1200})`,pad.l,14);
  // ê²€ìƒ‰ ì¸í’‹ ë™ê¸°í™”
  const inp=document.getElementById('elo-search-input');
  if(inp)inp.value=_eloSelPlayer;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   3. ì„ ìˆ˜ ì„±ì¥ ê³¡ì„ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _growthSel='';
function growthSearchFilter(q){
  const d=document.getElementById('growth-search-drop');if(!d)return;
  d.querySelectorAll('.sitem').forEach(el=>{el.style.display=el.textContent.toLowerCase().includes(q.toLowerCase())?'':'none';});
}
function statsGrowthHTML(){
  const cands=players.filter(p=>p.history&&p.history.length>=2)
    .sort((a,b)=>b.history.length-a.history.length);
  if(!_growthSel&&cands.length)_growthSel=cands[0].name;
  const selP=players.find(p=>p.name===_growthSel);
  return`<div class="ssec" id="stats-growth-sec">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
      <h4 style="margin:0">ğŸ“Š ì„ ìˆ˜ ì„±ì¥ ê³¡ì„ </h4>
      <div style="position:relative">
        <input id="growth-search-input" type="text" placeholder="ğŸ” ì„ ìˆ˜ ì´ë¦„ ê²€ìƒ‰..."
          value="${_growthSel}"
          style="font-size:12px;padding:5px 10px;border:1px solid var(--border2);border-radius:8px;width:200px"
          oninput="growthSearchFilter(this.value)"
          onfocus="document.getElementById('growth-search-drop').style.display='block'"
          onblur="setTimeout(()=>{const d=document.getElementById('growth-search-drop');if(d)d.style.display='none'},200)"
          onkeydown="if(event.key==='Enter'){const q=this.value.trim();const m=players.filter(p=>p.history&&p.history.length>=2&&p.name.includes(q));if(m.length>0){_growthSel=m[0].name;this.value=m[0].name;document.getElementById('growth-search-drop').style.display='none';initGrowthChart();}}">
        <div id="growth-search-drop" style="display:none;position:absolute;top:34px;left:0;background:var(--white);border:1px solid var(--border2);border-radius:8px;z-index:300;max-height:200px;overflow-y:auto;width:260px;box-shadow:var(--sh2)">
          ${cands.map(p=>`<div class="sitem" onmousedown="_growthSel='${p.name.replace(/'/g,"\'")}';document.getElementById('growth-search-input').value='${p.name.replace(/'/g,"\'")}';document.getElementById('growth-search-drop').style.display='none';initGrowthChart()">
            <b>${p.name}</b> <span style="color:${gc(p.univ)};font-size:11px">${p.univ}</span> <span style="color:var(--gray-l);font-size:10px">${p.history.length}ê²½ê¸°</span>
          </div>`).join('')}
        </div>
      </div>
      ${selP?`<span class="ubadge" style="background:${gc(selP.univ)}">${selP.univ}</span>`:''}
      <button class="btn-capture btn-xs no-export" style="margin-left:auto" onclick="captureSection('stats-growth-sec','growth_chart')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
    <canvas id="growthChart" style="width:100%;max-height:300px"></canvas>
    <div id="growthInfo" style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap"></div>
  </div>`;
}
function initGrowthChart(){
  const canvas=document.getElementById('growthChart');
  if(!canvas)return;
  const p=players.find(x=>x.name===_growthSel);
  if(!p||!p.history||p.history.length<2){canvas.style.display='none';return;}
  const hist=[...p.history].reverse();
  // ëˆ„ì  ìŠ¹ë¥  ê³„ì‚°
  const pts=[];let w=0,total=0;
  hist.forEach((h,i)=>{
    total++;if(h.result==='ìŠ¹')w++;
    pts.push({i,rate:Math.round(w/total*100),w,l:total-w,date:h.date||''});
  });
  const W=canvas.offsetWidth||600;const H=260;
  canvas.width=W;canvas.height=H;
  const pad={t:20,r:20,b:45,l:45};
  const mapX=i=>(i/(pts.length-1||1))*(W-pad.l-pad.r)+pad.l;
  const mapY=r=>H-pad.b-(r/100)*(H-pad.t-pad.b);
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,W,H);
  // ê·¸ë¦¬ë“œ
  [0,25,50,75,100].forEach(g=>{
    const y=mapY(g);
    ctx.strokeStyle='#e2e8f0';ctx.lineWidth=1;ctx.setLineDash(g===50?[4,4]:[]);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle='#94a3b8';ctx.font='10px sans-serif';ctx.textAlign='right';
    ctx.fillText(g+'%',pad.l-4,y+4);
  });
  ctx.setLineDash([]);
  // 50% ê¸°ì¤€ì„  ê°•ì¡°
  const baseY=mapY(50);
  ctx.fillStyle='#64748b';ctx.font='9px sans-serif';ctx.textAlign='left';
  ctx.fillText('50%',pad.l+2,baseY-3);
  // ì±„ìš°ê¸°
  const col=pts[pts.length-1].rate>=50?'rgba(22,163,74,0.2)':'rgba(220,38,38,0.2)';
  const lineCol=pts[pts.length-1].rate>=50?'#16a34a':'#dc2626';
  ctx.beginPath();ctx.moveTo(mapX(0),mapY(pts[0].rate));
  pts.forEach(pt=>ctx.lineTo(mapX(pt.i),mapY(pt.rate)));
  ctx.lineTo(mapX(pts.length-1),H-pad.b);ctx.lineTo(mapX(0),H-pad.b);
  ctx.closePath();ctx.fillStyle=col;ctx.fill();
  // ì„ 
  ctx.beginPath();ctx.strokeStyle=lineCol;ctx.lineWidth=2.5;ctx.setLineDash([]);
  ctx.moveTo(mapX(0),mapY(pts[0].rate));
  pts.forEach(pt=>ctx.lineTo(mapX(pt.i),mapY(pt.rate)));
  ctx.stroke();
  // ë‚ ì§œ ë ˆì´ë¸”
  ctx.fillStyle='#64748b';ctx.font='10px sans-serif';ctx.textAlign='center';
  if(pts[0].date)ctx.fillText(pts[0].date.slice(5)||'',mapX(0),H-pad.b+14);
  if(pts[pts.length-1].date)ctx.fillText(pts[pts.length-1].date.slice(5)||'',mapX(pts.length-1),H-pad.b+14);
  ctx.fillStyle='#1e293b';ctx.font='bold 13px sans-serif';ctx.textAlign='left';
  ctx.fillText(`${p.name} ëˆ„ì  ìŠ¹ë¥  ì¶”ì´`,pad.l,14);
  // ì¸í¬
  const info=document.getElementById('growthInfo');
  if(info){
    const last=pts[pts.length-1];
    const early=pts.slice(0,Math.ceil(pts.length/3));
    const late=pts.slice(Math.floor(pts.length*2/3));
    const earlyRate=early.length?early[early.length-1].rate:0;
    const lateRate=late.length?late[late.length-1].rate:0;
    const trend=lateRate-earlyRate;
    info.innerHTML=`
      <div style="background:var(--blue-l);border:1px solid var(--blue-ll);border-radius:10px;padding:12px 16px;flex:1;min-width:120px;text-align:center">
        <div style="font-size:10px;color:var(--blue);font-weight:700;margin-bottom:4px">í˜„ì¬ ìŠ¹ë¥ </div>
        <div style="font-size:22px;font-weight:900;color:var(--blue)">${last.rate}%</div>
        <div style="font-size:11px;color:var(--gray-l)">${last.w}ìŠ¹ ${last.l}íŒ¨</div>
      </div>
      <div style="background:${trend>=0?'#f0fdf4':'#fef2f2'};border:1px solid ${trend>=0?'#bbf7d0':'#fecaca'};border-radius:10px;padding:12px 16px;flex:1;min-width:120px;text-align:center">
        <div style="font-size:10px;color:${trend>=0?'var(--green)':'var(--red)'};font-weight:700;margin-bottom:4px">ì„±ì¥ ì¶”ì„¸</div>
        <div style="font-size:22px;font-weight:900;color:${trend>=0?'var(--green)':'var(--red)'}">${trend>=0?'ğŸ“ˆ':'ğŸ“‰'} ${trend>0?'+':''}${trend}%</div>
        <div style="font-size:11px;color:var(--gray-l)">ì´ˆë°˜â†’í›„ë°˜ ë³€í™”</div>
      </div>
      <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:12px 16px;flex:1;min-width:120px;text-align:center">
        <div style="font-size:10px;color:var(--gold);font-weight:700;margin-bottom:4px">ì´ ê²½ê¸°</div>
        <div style="font-size:22px;font-weight:900;color:var(--gold)">${last.w+last.l}</div>
        <div style="font-size:11px;color:var(--gray-l)">ê²½ê¸° ê¸°ë¡</div>
      </div>`;
  }
  const inp2=document.getElementById('growth-search-input');
  if(inp2)inp2.value=_growthSel;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   4. ì´ë‹¬ì˜ ì„ ìˆ˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function statsAwardHTML(){
  const now=new Date();
  const ym=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const prevYm=now.getMonth()===0
    ?`${now.getFullYear()-1}-12`
    :`${now.getFullYear()}-${String(now.getMonth()).padStart(2,'0')}`;
  const proIds=statsProMatchIds();
  function calcMonth(ym2){
    return players.map(p=>{
      // í”„ë¡œë¦¬ê·¸ ì œì™¸í•œ íˆìŠ¤í† ë¦¬ë§Œ í•„í„°ë§
      const mh=statsNonProHist(p).filter(h=>(h.date||'').startsWith(ym2));
      const w=mh.filter(h=>h.result==='ìŠ¹').length;
      const l=mh.filter(h=>h.result==='íŒ¨').length;
      const tot=w+l;
      return{...p,mw:w,ml:l,mt:tot,mrate:tot?Math.round(w/tot*100):0};
    }).filter(p=>p.mt>0).sort((a,b)=>b.mw-a.mw||b.mrate-a.mrate);
  }
  const curList=calcMonth(ym);
  const prevList=calcMonth(prevYm);
  const [y,m]=ym.split('-');
  const [py,pm]=prevYm.split('-');
  function awardCard(title,p,extra='',color='#2563eb'){
    if(!p)return`<div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;text-align:center;flex:1;min-width:200px"><div style="font-size:28px;margin-bottom:8px">ğŸ†</div><div style="color:var(--gray-l)">ê¸°ë¡ ì—†ìŒ</div></div>`;
    const univColor=gc(p.univ);
    // ëŒ€í•™ ì•„ì´ì½˜ (gUI ì‚¬ìš© - UNIV_ICONS ë˜ëŠ” univCfg.icon ìš°ì„ )
    const univIconUrl=UNIV_ICONS[p.univ]||(univCfg.find(x=>x.name===p.univ)||{}).icon||'';
    // ì•„ì´ì½˜: URL ìˆìœ¼ë©´ ì´ë¯¸ì§€, ì—†ìœ¼ë©´ ëŒ€í•™ëª… ì²« ê¸€ì í‘œì‹œ
    const univIconInner=univIconUrl
      ? `<img src="${univIconUrl}" style="width:32px;height:32px;object-fit:contain" onerror="this.outerHTML='<span style=font-size:16px;font-weight:900;color:white>${p.univ[0]||'?'}</span>'">`
      : `<span style="font-size:18px;font-weight:900;color:#fff;font-family:Noto Sans KR,sans-serif">${p.univ[0]||'?'}</span>`;
    return`<div style="background:linear-gradient(135deg,${color}15,${color}08);border:2px solid ${color}44;border-radius:14px;padding:20px;flex:1;min-width:200px;cursor:pointer" onclick="openPlayerModal('${p.name}')">
      <div style="font-size:11px;font-weight:700;color:${color};margin-bottom:8px;letter-spacing:.5px">${title}</div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        ${p.photo?`<img src="${p.photo}" style="width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid ${univColor};flex-shrink:0;box-shadow:0 2px 8px ${univColor}55" onerror="this.style.display='none'">`:`<div style="width:44px;height:44px;border-radius:50%;background:${univColor};display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 2px 8px ${univColor}55;overflow:hidden">${univIconInner}</div>`}
        <div style="min-width:0">
          <div style="font-weight:800;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name}</div>
          <div style="display:flex;align-items:center;gap:4px;margin-top:3px;flex-wrap:wrap">
            <span style="display:inline-flex;align-items:center;gap:3px;background:${univColor};color:#fff;font-size:10px;padding:2px 7px;border-radius:4px;font-weight:700">${gUI(p.univ,'0.85em')}${p.univ}</span>
            <span style="font-size:10px;color:var(--gray-l)">${getTierLabel(p.tier||'-')}</span>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:8px;font-size:12px;flex-wrap:wrap">
        <span style="background:var(--green);color:#fff;padding:2px 8px;border-radius:6px;font-weight:700">${p.mw}ìŠ¹</span>
        <span style="background:var(--red);color:#fff;padding:2px 8px;border-radius:6px;font-weight:700">${p.ml}íŒ¨</span>
        <span style="background:${color};color:#fff;padding:2px 8px;border-radius:6px;font-weight:700">${p.mrate}%</span>
      </div>
      ${extra?`<div style="margin-top:8px;font-size:11px;color:${color};font-weight:600">${extra}</div>`:''}
    </div>`;
  }
  const mostWin=curList[0]||null;
  const highRate=curList.filter(p=>p.mt>=3).sort((a,b)=>b.mrate-a.mrate)[0]||null;
  const mostActive=[...curList].sort((a,b)=>b.mt-a.mt)[0]||null;
  const prevTop=prevList[0];
  return`<div style="display:flex;flex-direction:column;gap:20px">
  <div class="ssec" id="stats-award-sec">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px">
      <h4 style="margin:0">ğŸ† ì´ë‹¬ì˜ ì„ ìˆ˜ <span style="font-size:12px;color:var(--gray-l);font-weight:400">${y}ë…„ ${m}ì›”</span> <span style="font-size:11px;color:var(--gray-l);font-weight:400">(í”„ë¡œë¦¬ê·¸ ì œì™¸)</span></h4>
      <button class="btn-capture btn-xs no-export" onclick="captureSection('stats-award-sec','award')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      ${awardCard('ğŸ‘‘ ì´ë‹¬ ìµœë‹¤ìŠ¹',mostWin,'ì´ë²ˆ ë‹¬ ê°€ì¥ ë§ì€ ìŠ¹ë¦¬!','#d97706')}
      ${awardCard('ğŸ¯ ì´ë‹¬ ìµœê³  ìŠ¹ë¥ ',highRate,'(3ê²½ê¸° ì´ìƒ)','#16a34a')}
      ${awardCard('âš¡ ì´ë‹¬ ìµœë‹¤ ê²½ê¸°',mostActive,'ê°€ì¥ í™œë°œí•˜ê²Œ ë›°ì—ˆì–´ìš”','#7c3aed')}
    </div>
  </div>
  <div class="ssec">
    <h4 style="margin-bottom:14px">ğŸ“… ì§€ë‚œë‹¬ TOP <span style="font-size:12px;color:var(--gray-l);font-weight:400">${py}ë…„ ${pm}ì›”</span></h4>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      ${awardCard('ğŸ¥‡ ì§€ë‚œë‹¬ 1ìœ„',prevTop,'','#2563eb')}
      ${prevList[1]?awardCard('ğŸ¥ˆ ì§€ë‚œë‹¬ 2ìœ„',prevList[1],'','#64748b'):''}
      ${prevList[2]?awardCard('ğŸ¥‰ ì§€ë‚œë‹¬ 3ìœ„',prevList[2],'','#92400e'):''}
    </div>
  </div>
  <div class="ssec">
    <h4 style="margin-bottom:10px">ğŸ“‹ ì´ë‹¬ ì „ì²´ ìˆœìœ„ <span style="font-size:12px;color:var(--gray-l);font-weight:400">${y}ë…„ ${m}ì›”</span></h4>
    ${curList.length===0?'<p style="color:var(--gray-l)">ì´ë‹¬ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>':`
    <table><thead><tr><th>ìˆœìœ„</th><th>ì„ ìˆ˜</th><th>ëŒ€í•™</th><th>í‹°ì–´</th><th>ìŠ¹</th><th>íŒ¨</th><th>ìŠ¹ë¥ </th><th>ê²½ê¸°ìˆ˜</th></tr></thead><tbody>
    ${[...curList].sort((a,b)=>b.mw-a.mw||b.mrate-a.mrate).map((p,i)=>`<tr>
      <td>${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1+'ìœ„'}</td>
      <td style="cursor:pointer;color:var(--blue);font-weight:700" onclick="openPlayerModal('${p.name}')">${p.name}</td>
      <td><span class="ubadge" style="background:${gc(p.univ)}">${p.univ}</span></td>
      <td>${p.tier||'-'}</td>
      <td class="wt">${p.mw}</td><td class="lt">${p.ml}</td>
      <td style="font-weight:700;color:${p.mrate>=50?'var(--green)':'var(--red)'}">${p.mrate}%</td>
      <td>${p.mt}</td>
    </tr>`).join('')}
    </tbody></table>`}
  </div></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   5. ìµœë‹¤ ê¸°ë¡ ë³´ìœ ì
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function statsRecordsHTML(){
  if(!players.length)return`<div class="ssec"><p style="color:var(--gray-l)">ì„ ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
  const proIds=statsProMatchIds();
  const withStats=players.map(p=>{
    const h=statsNonProHist(p);
    const ph=(p.history||[]).filter(x=>proIds.has(x.matchId));
    const w=h.filter(x=>x.result==='ìŠ¹').length;
    const l=h.filter(x=>x.result==='íŒ¨').length;
    const tot=w+l;
    // ìµœì¥ ì—°ìŠ¹ ê³„ì‚° (ì˜¤ë˜ëœ ìˆœìœ¼ë¡œ ë°˜ì „ í›„ ê³„ì‚°)
    let maxStreak=0,cur=0,lastRes='';
    [...h].reverse().forEach(x=>{if(x.result===lastRes){cur++;}else{cur=1;lastRes=x.result;}if(lastRes==='ìŠ¹')maxStreak=Math.max(maxStreak,cur);});
    // í˜„ì¬ ì—°ìŠ¹
    let curStreak=0,curStreakType='';
    for(const x of h){if(!curStreakType||x.result===curStreakType){curStreak++;curStreakType=x.result;}else break;}
    return{...p,w,l,tot,rate:tot?Math.round(w/tot*100):0,maxStreak,
      curStreak,curStreakType,elo:p.elo||1200,proGames:ph.length,points:p.points||0};
  }).filter(p=>p.tot>0||p.proGames>0);
  if(!withStats.length)return`<div class="ssec"><p style="color:var(--gray-l)">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
  const cats=[
    {title:'ğŸ† ì—­ëŒ€ ìµœë‹¤ìŠ¹',icon:'ğŸ†',sort:(a,b)=>b.w-a.w,val:p=>`${p.w}ìŠ¹`,sub:p=>`ì´ ${p.tot}ê²½ê¸°`},
    {title:'ğŸ“Š ì—­ëŒ€ ìµœê³  ìŠ¹ë¥ ',icon:'ğŸ“Š',sort:(a,b)=>b.rate-a.rate||b.tot-a.tot,val:p=>`${p.rate}%`,sub:p=>`${p.w}ìŠ¹${p.l}íŒ¨`,filter:p=>p.tot>=5},
    {title:'âš¡ ì—­ëŒ€ ìµœë‹¤ ê²½ê¸°',icon:'âš¡',sort:(a,b)=>b.tot-a.tot,val:p=>`${p.tot}ê²½ê¸°`,sub:p=>`${p.w}ìŠ¹${p.l}íŒ¨`},
    {title:'ğŸ”¥ ìµœì¥ ì—°ìŠ¹ ê¸°ë¡',icon:'ğŸ”¥',sort:(a,b)=>b.maxStreak-a.maxStreak,val:p=>`${p.maxStreak}ì—°ìŠ¹`,sub:p=>`ì´ ${p.w}ìŠ¹`},
    {title:'ğŸ’ ìµœê³  ELO',icon:'ğŸ’',sort:(a,b)=>b.elo-a.elo,val:p=>`${p.elo}`,sub:p=>`${p.w}ìŠ¹${p.l}íŒ¨`},
    {title:'ğŸ¯ í˜„ì¬ ì—°ìŠ¹ì¤‘',icon:'ğŸ¯',sort:(a,b)=>b.curStreak-a.curStreak,val:p=>`${p.curStreak}ì—°${p.curStreakType==='ìŠ¹'?'ìŠ¹':'íŒ¨'}`,sub:p=>`í˜„ì¬ ì§„í–‰ì¤‘`,filter:p=>p.curStreakType==='ìŠ¹'&&p.curStreak>=2},
  ];
  function recordCard(cat){
    const list=(cat.filter?withStats.filter(cat.filter):withStats).sort(cat.sort).slice(0,5);
    return`<div class="ssec" style="flex:1;min-width:280px">
      <h4 style="margin-bottom:12px">${cat.title}</h4>
      ${list.length===0?`<p style="color:var(--gray-l);font-size:12px">ê¸°ë¡ ì—†ìŒ</p>`:`
      <div style="display:flex;flex-direction:column;gap:6px">
        ${list.map((p,i)=>{
          const badge=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`${i+1}`;
          return`<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--white);border:1px solid var(--border);border-radius:8px;cursor:pointer;${i===0?'border-color:'+gc(p.univ)+';box-shadow:0 2px 8px '+gc(p.univ)+'33':''}" onclick="openPlayerModal('${p.name}')">
            <span style="font-size:16px;min-width:24px">${badge}</span>
            ${getPlayerPhotoHTML(p.name,'30px')}
            <div style="flex:1;min-width:0">
              <div style="font-weight:800;font-size:13px">${p.name}${getStatusIconHTML(p.name)} <span style="font-size:10px;color:${gc(p.univ)};font-weight:600">${p.univ}</span></div>
              <div style="font-size:10px;color:var(--gray-l)">${cat.sub(p)}</div>
            </div>
            <span style="font-weight:900;font-size:16px;color:${i===0?gc(p.univ):'var(--text2)'};font-family:'Noto Sans KR',sans-serif">${cat.val(p)}</span>
          </div>`;
        }).join('')}
      </div>`}
    </div>`;
  }
  return`<div id="stats-records-sec"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
    <span style="font-size:12px;color:var(--gray-l)">(í”„ë¡œë¦¬ê·¸ ì œì™¸)</span>
    <button class="btn-capture btn-xs no-export" onclick="captureSection('stats-records-sec','records')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
  </div>
  <div style="display:flex;flex-wrap:wrap;gap:14px">${cats.map(recordCard).join('')}</div></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   6. ëŒ€í•™ë³„ ì„±ì  ë ˆì´ë” ì°¨íŠ¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _radarSelUniv='';
function statsRadarHTML(){
  const univs=getAllUnivs().filter(u=>players.some(p=>p.univ===u.name));
  if(!_radarSelUniv&&univs.length)_radarSelUniv=univs[0].name;
  const proIds=statsProMatchIds();
  return`<div style="display:flex;flex-direction:column;gap:16px">
  <div class="ssec" id="stats-radar-sec">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
      <h4 style="margin:0">ğŸ•¸ï¸ ëŒ€í•™ë³„ ì„±ì  ë ˆì´ë” ì°¨íŠ¸ <span style="font-size:11px;color:var(--gray-l);font-weight:400">(í”„ë¡œë¦¬ê·¸ ì œì™¸)</span></h4>
      <select id="radar-sel" style="font-size:12px;padding:4px 10px;border:1px solid var(--border2);border-radius:8px" onchange="_radarSelUniv=this.value;initRadarChart()">
        ${univs.map(u=>`<option value="${u.name}"${_radarSelUniv===u.name?' selected':''}>${u.name}</option>`).join('')}
      </select>
      <button class="btn-capture btn-xs no-export" style="margin-left:auto" onclick="captureSection('stats-radar-sec','radar')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
    <div style="display:flex;gap:20px;flex-wrap:wrap;align-items:flex-start">
      <canvas id="radarChart" width="280" height="280" style="flex-shrink:0"></canvas>
      <div id="radarInfo" style="flex:1;min-width:200px"></div>
    </div>
  </div>
  <div class="ssec">
    <h4 style="margin-bottom:12px">ğŸ“Š ì „ì²´ ëŒ€í•™ ë¹„êµ</h4>
    <div style="overflow-x:auto"><table>
      <thead><tr><th>ëŒ€í•™</th><th>ì„ ìˆ˜ìˆ˜</th><th>ìŠ¹ë¥ </th><th>ELOí‰ê· </th><th>í¬ì¸íŠ¸</th><th>í™œë™ë„</th><th>ë‹¤ì–‘ì„±</th></tr></thead>
      <tbody>
        ${univs.map(u=>{
          const mem=players.filter(p=>p.univ===u.name);
          const scores=calcUnivRadar(u.name,proIds);
          return`<tr style="cursor:pointer" onclick="_radarSelUniv='${u.name}';initRadarChart()">
            <td><span class="ubadge clickable-univ" style="background:${u.color}" onclick="event.stopPropagation();openUnivModal('${u.name}')">${u.name}</span></td>
            <td>${mem.length}ëª…</td>
            <td style="color:${scores.winrate>=50?'var(--green)':'var(--red)'};font-weight:700">${scores.winrate}%</td>
            <td>${scores.avgElo}</td>
            <td class="${scores.pts>=0?'wt':'lt'}">${scores.pts>=0?'+':''}${scores.pts}</td>
            <td>${scores.activity}</td>
            <td>${scores.diversity}ì¢…ì¡±</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table></div>
  </div></div>`;
}
function calcUnivRadar(univName, proIds){
  const mem=players.filter(p=>p.univ===univName);
  if(!mem.length)return{winrate:0,avgElo:1200,pts:0,activity:0,diversity:0,streak:0};
  const allH=mem.flatMap(p=>statsNonProHist(p));
  const w=allH.filter(h=>h.result==='ìŠ¹').length;
  const l=allH.filter(h=>h.result==='íŒ¨').length;
  const tot=w+l;
  const avgElo=Math.round(mem.reduce((s,p)=>s+(p.elo||1200),0)/mem.length);
  const pts=mem.reduce((s,p)=>s+(p.points||0),0);
  const races=new Set(mem.map(p=>p.race).filter(Boolean)).size;
  // ìµœê·¼ 30ì¼ í™œë™
  const d30=new Date();d30.setDate(d30.getDate()-30);
  const d30s=d30.toISOString().slice(0,10);
  const activity=allH.filter(h=>(h.date||'')>=d30s).length;
  // í˜„ì¬ ìµœì¥ ì—°ìŠ¹
  let maxS=0;
  mem.forEach(p=>{let cs=0,lt='';for(const h of statsNonProHist(p)){if(h.result===lt||lt===''){cs++;lt=h.result;}else{cs=1;lt=h.result;}if(lt==='ìŠ¹')maxS=Math.max(maxS,cs);}});
  return{winrate:tot?Math.round(w/tot*100):0,avgElo,pts,activity,diversity:races,streak:maxS,w,l,tot,mem:mem.length};
}
function initRadarChart(){
  const canvas=document.getElementById('radarChart');
  const info=document.getElementById('radarInfo');
  if(!canvas)return;
  const proIds=statsProMatchIds();
  const scores=calcUnivRadar(_radarSelUniv,proIds);
  const allUnivs=getAllUnivs().filter(u=>players.some(p=>p.univ===u.name));
  const maxVals={
    winrate:100,
    avgElo:Math.max(...allUnivs.map(u=>calcUnivRadar(u.name,proIds).avgElo),1500),
    activity:Math.max(...allUnivs.map(u=>calcUnivRadar(u.name,proIds).activity),1),
    diversity:3,
    streak:Math.max(...allUnivs.map(u=>calcUnivRadar(u.name,proIds).streak),1),
    mem:Math.max(...allUnivs.map(u=>calcUnivRadar(u.name,proIds).mem),1),
  };
  const labels=['ìŠ¹ë¥ ','ELO','í™œë™ë„','ë‹¤ì–‘ì„±','ì—°ìŠ¹','ì„ ìˆ˜ìˆ˜'];
  const vals=[
    scores.winrate/maxVals.winrate,
    scores.avgElo/maxVals.avgElo,
    Math.min(1,scores.activity/maxVals.activity),
    scores.diversity/maxVals.diversity,
    Math.min(1,scores.streak/maxVals.streak),
    scores.mem/maxVals.mem,
  ];
  const col=gc(_radarSelUniv);
  const W=280,H=280,cx=W/2,cy=H/2,r=100,sides=6;
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,W,H);
  const angle=i=>(-Math.PI/2)+(2*Math.PI/sides)*i;
  // ë°°ê²½ ê·¸ë¬¼
  [0.2,0.4,0.6,0.8,1.0].forEach(frac=>{
    ctx.beginPath();
    for(let i=0;i<sides;i++){
      const x=cx+r*frac*Math.cos(angle(i));
      const y=cy+r*frac*Math.sin(angle(i));
      if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
    }
    ctx.closePath();ctx.strokeStyle='#e2e8f0';ctx.lineWidth=1;ctx.stroke();
    if(frac===1||frac===0.5){ctx.fillStyle='#94a3b8';ctx.font='9px sans-serif';ctx.textAlign='center';ctx.fillText(Math.round(frac*100)+'%',cx,cy-r*frac-3);}
  });
  // ì¶•ì„ 
  for(let i=0;i<sides;i++){
    ctx.beginPath();ctx.moveTo(cx,cy);
    ctx.lineTo(cx+r*Math.cos(angle(i)),cy+r*Math.sin(angle(i)));
    ctx.strokeStyle='#cbd5e1';ctx.lineWidth=1;ctx.stroke();
  }
  // ë°ì´í„° í´ë¦¬ê³¤
  ctx.beginPath();
  for(let i=0;i<sides;i++){
    const v=vals[i];
    const x=cx+r*v*Math.cos(angle(i));
    const y=cy+r*v*Math.sin(angle(i));
    if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
  }
  ctx.closePath();
  ctx.fillStyle=col+'44';ctx.fill();
  ctx.strokeStyle=col;ctx.lineWidth=2.5;ctx.stroke();
  // ì 
  for(let i=0;i<sides;i++){
    const v=vals[i];
    const x=cx+r*v*Math.cos(angle(i));
    const y=cy+r*v*Math.sin(angle(i));
    ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);
    ctx.fillStyle=col;ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=1.5;ctx.stroke();
  }
  // ë ˆì´ë¸”
  ctx.fillStyle='#374151';ctx.font='bold 11px sans-serif';ctx.textAlign='center';
  for(let i=0;i<sides;i++){
    const x=cx+(r+18)*Math.cos(angle(i));
    const y=cy+(r+18)*Math.sin(angle(i));
    const va=Math.abs(Math.sin(angle(i)));
    ctx.textAlign=Math.cos(angle(i))>0.1?'left':Math.cos(angle(i))<-0.1?'right':'center';
    ctx.fillText(labels[i],x,y+va*5);
  }
  // ì¤‘ì•™ ëŒ€í•™ëª…
  ctx.fillStyle=col;ctx.font='bold 12px sans-serif';ctx.textAlign='center';
  ctx.fillText(_radarSelUniv,cx,cy+4);
  if(info){
    info.innerHTML=`
      <div style="display:flex;flex-direction:column;gap:8px">
        <div style="font-weight:800;font-size:16px;color:${col}">${_radarSelUniv}</div>
        ${[
          ['ì„ ìˆ˜ ìˆ˜',scores.mem+'ëª…'],
          ['ìŠ¹ë¥ ',scores.winrate+'%'],
          ['í‰ê·  ELO',scores.avgElo],
          ['ì´ í¬ì¸íŠ¸',(scores.pts>=0?'+':'')+scores.pts],
          ['ìµœê·¼ 30ì¼ í™œë™',scores.activity+'ê²½ê¸°'],
          ['ì¢…ì¡± ë‹¤ì–‘ì„±',scores.diversity+'ì¢…ì¡±'],
          ['ìµœì¥ ì—°ìŠ¹',scores.streak+'ì—°ìŠ¹'],
          ['ì´ ì „ì ',`${scores.w}ìŠ¹ ${scores.l}íŒ¨`],
        ].map(([k,v])=>`<div style="display:flex;justify-content:space-between;padding:6px 10px;background:var(--white);border:1px solid var(--border);border-radius:8px">
          <span style="font-size:12px;color:var(--text3)">${k}</span>
          <span style="font-weight:700;font-size:12px">${v}</span>
        </div>`).join('')}
      </div>`;
  }
  const sel=document.getElementById('radar-sel');
  if(sel)sel.value=_radarSelUniv;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   7. ë¯¸ìŠ¤ë§¤ì¹˜ ê°ì§€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function statsMismatchHTML(){
  const proIds=statsProMatchIds();
  const allMatches=[];
  // proMì„ ì œì™¸í•œ ë°°ì—´ë§Œ ì²˜ë¦¬
  [...miniM,...univM,...ckM,...comps].forEach((m,_)=>{
    (m.sets||[]).forEach(set=>{
      (set.games||[]).forEach(g=>{
        if(!g.playerA||!g.playerB||!g.winner)return;
        const pA=players.find(x=>x.name===g.playerA);
        const pB=players.find(x=>x.name===g.playerB);
        if(!pA||!pB)return;
        const eA=pA.elo||1200,eB=pB.elo||1200;
        const diff=Math.abs(eA-eB);
        if(diff<100)return;
        const winner=g.winner==='A'?g.playerA:g.playerB;
        const underdog=(eA<eB?pA:pB);
        const upset=winner===underdog.name;
        allMatches.push({pA:g.playerA,pB:g.playerB,eA,eB,diff,winner,upset,date:m.d||''});
      });
    });
  });
  allMatches.sort((a,b)=>b.diff-a.diff);
  const upsets=allMatches.filter(m=>m.upset).slice(0,10);
  const bigDiff=allMatches.slice(0,20);
  function matchRow(m){
    const winner=players.find(p=>p.name===m.winner);
    const loser=players.find(p=>p.name===(m.winner===m.pA?m.pB:m.pA));
    const wElo=winner?.elo||1200;const lElo=loser?.elo||1200;
    const wCol=gc(winner?.univ||'');const lCol=gc(loser?.univ||'');
    return`<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--white);border:1px solid var(--border);border-radius:8px;flex-wrap:wrap">
      <span style="font-size:11px;color:var(--gray-l);min-width:68px">${m.date}</span>
      <span style="background:var(--green);color:#fff;font-weight:800;font-size:11px;padding:2px 8px;border-radius:6px;cursor:pointer" onclick="openPlayerModal('${m.winner}')">${m.winner}</span>
      <span style="font-size:12px;font-weight:700;color:${wElo>=1300?'#7c3aed':wElo>=1200?'var(--green)':'var(--red)'}">${wElo}</span>
      <span style="color:var(--gray-l);font-size:11px">ELOì°¨</span>
      <span style="background:var(--red);color:#fff;font-weight:800;font-size:12px;padding:1px 7px;border-radius:6px">${m.diff}â†‘</span>
      <span style="color:var(--gray-l);font-size:11px">vs</span>
      <span style="background:var(--red);color:#fff;font-weight:800;font-size:11px;padding:2px 8px;border-radius:6px;cursor:pointer;opacity:.7" onclick="openPlayerModal('${m.winner===m.pA?m.pB:m.pA}')">${m.winner===m.pA?m.pB:m.pA}</span>
      <span style="font-size:12px;font-weight:700;color:${lElo>=1300?'#7c3aed':lElo>=1200?'var(--green)':'var(--red)'}">${lElo}</span>
      ${m.upset?'<span style="background:#7c3aed;color:#fff;font-size:10px;font-weight:800;padding:1px 6px;border-radius:4px">ğŸ”¥ ì´ë³€!</span>':''}
    </div>`;
  }
  return`<div style="display:flex;flex-direction:column;gap:16px">
  <div class="ssec" id="stats-mismatch-top">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <h4>ğŸ”¥ ì´ë³€ TOP 10 (í•˜ìœ„ ELOê°€ ìŠ¹ë¦¬) <span style="font-size:11px;color:var(--gray-l);font-weight:400">(í”„ë¡œë¦¬ê·¸ ì œì™¸)</span></h4>
      <button class="btn-capture btn-xs no-export" onclick="captureSection('stats-mismatch-top','mismatch')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
    ${upsets.length?`<div style="display:flex;flex-direction:column;gap:6px">${upsets.map(matchRow).join('')}</div>`:'<p style="color:var(--gray-l)">ì´ë³€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
  </div>
  <div class="ssec">
    <h4 style="margin-bottom:12px">âš¡ ELO ê²©ì°¨ TOP 20 ê²½ê¸° <span style="font-size:11px;color:var(--gray-l);font-weight:400">(í”„ë¡œë¦¬ê·¸ ì œì™¸)</span></h4>
    ${bigDiff.length?`<div style="display:flex;flex-direction:column;gap:6px">${bigDiff.map(matchRow).join('')}</div>`:'<p style="color:var(--gray-l)">ELO ê²©ì°¨ 100 ì´ìƒ ê²½ê¸° ì—†ìŒ</p>'}
  </div></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   8. ê²½ê¸° ê²°ê³¼ ê³µìœ  ì¹´ë“œ ìƒì„±
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _shareMode='player';
let _sharePlayerSearch='';
let _shareUnivSearch='';
let _shareMatchPage=0; // ê²½ê¸° ê²°ê³¼ í˜ì´ì§€ ì¸ë±ìŠ¤
const SHARE_MATCH_PER_PAGE=5;
function statsShareCardHTML(){
  const pList=players.filter(p=>p.history&&p.history.length>0).sort((a,b)=>b.history.length-a.history.length);
  const uList=(typeof univCfg!=='undefined'&&univCfg.length)?univCfg.filter(u=>players.some(p=>p.univ===u.name)):getAllUnivs().filter(u=>players.some(p=>p.univ===u.name));
  const filteredP=_sharePlayerSearch
    ?pList.filter(p=>p.name.toLowerCase().includes(_sharePlayerSearch.toLowerCase())||p.univ.toLowerCase().includes(_sharePlayerSearch.toLowerCase()))
    :[];  // ê²€ìƒ‰í•˜ê¸° ì „ì—ëŠ” ë¹ˆ ë°°ì—´ - ì•„ë¬´ê²ƒë„ í‘œì‹œ ì•ˆ í•¨
  // ëª¨ë“  ê²½ê¸° ìµœì‹ ìˆœ (tourneys ëŒ€íšŒ ê²½ê¸° í¬í•¨)
  const tourMatchesForShare=typeof getTourneyMatches==="function"?getTourneyMatches():[];
  const allMatches=[...miniM,...univM,...ckM,...comps,...tourMatchesForShare].sort((a,b)=>(b.d||"").localeCompare(a.d||""));
  // ìºì‹œ ì´ˆê¸°í™” (í˜ì´ì§€ ë Œë”ë§ë§ˆë‹¤ fresh)
  window._shareAllMatchesCached=null;


  const totalPages=Math.ceil(allMatches.length/SHARE_MATCH_PER_PAGE)||1;
  const safePage=Math.min(_shareMatchPage,totalPages-1);
  const pageMatches=allMatches.slice(safePage*SHARE_MATCH_PER_PAGE,(safePage+1)*SHARE_MATCH_PER_PAGE);

  return`<div class="ssec">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px">
      <h4 style="margin:0;font-size:16px">ğŸ´ ê³µìœ  ì¹´ë“œ ìƒì„±</h4>
    </div>
    <!-- ëª¨ë“œ íƒ­ -->
    <div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap" class="no-export">
      <button class="stab ${_shareMode==='player'?'on':''}" onclick="_shareMode='player';_sharePlayerSearch='';render()">ğŸ‘¤ ì„ ìˆ˜ ì¹´ë“œ</button>
      <button class="stab ${_shareMode==='univ'?'on':''}" onclick="_shareMode='univ';render()">ğŸ›ï¸ ëŒ€í•™ ì¹´ë“œ</button>
      <button class="stab ${_shareMode==='match'?'on':''}" onclick="_shareMode='match';window._shareMatchObj=null;render()">âš”ï¸ ê²½ê¸° ê²°ê³¼</button>
    </div>

    ${_shareMode==='player'?`
    <div style="margin-bottom:12px" class="no-export">
      <input type="text" id="share-player-q" value="${_sharePlayerSearch}"
        placeholder="ğŸ” ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„ ë˜ëŠ” ëŒ€í•™ ì´ë¦„ ê²€ìƒ‰..."
        oninput="_sharePlayerSearch=this.value;renderShareCardFilterPlayers()"
        style="width:100%;max-width:380px;padding:9px 16px;border:2px solid var(--blue);border-radius:8px;font-size:13px;box-sizing:border-box">
      <div id="share-player-list" style="display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;max-height:160px;overflow-y:auto;padding:2px">
        ${filteredP.length?filteredP.slice(0,50).map(p=>`
          <button onclick="renderShareCardByPlayer('${p.name}')"
            style="padding:4px 13px;border-radius:20px;border:2px solid ${gc(p.univ)};background:${gc(p.univ)}22;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;transition:.12s"
            onmouseover="this.style.background='${gc(p.univ)}55'" onmouseout="this.style.background='${gc(p.univ)}22'">
            ${p.name} <span style="font-size:10px;opacity:.65">${p.univ}</span>
          </button>`).join('')
          :(_sharePlayerSearch?'<span style="color:var(--gray-l);font-size:12px;padding:8px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</span>'
          :'<span style="color:var(--gray-l);font-size:12px;padding:8px">ì´ë¦„ ë˜ëŠ” ëŒ€í•™ëª…ì„ ì…ë ¥í•˜ì„¸ìš”</span>')}
      </div>
    </div>`
    :_shareMode==='univ'?`
    <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px" class="no-export">
      ${uList.map(u=>`
        <button onclick="renderShareCardByUniv('${u.name}')"
          style="padding:7px 20px;border-radius:20px;background:${u.color};color:#fff;border:none;font-size:13px;font-weight:700;cursor:pointer;box-shadow:0 2px 8px ${u.color}55;transition:.15s"
          onmouseover="this.style.transform='scale(1.06)'" onmouseout="this.style.transform='scale(1)'">
          ${u.name}
        </button>`).join('')||'<span style="color:var(--gray-l);font-size:12px">ë“±ë¡ëœ ëŒ€í•™ì´ ì—†ìŠµë‹ˆë‹¤</span>'}
    </div>`
    :`
    <div style="margin-bottom:14px" class="no-export">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-size:11px;font-weight:700;color:var(--text3)">â±ï¸ ìµœì‹ ìˆœ ê²½ê¸° ëª©ë¡ (5ê°œì”© í‘œì‹œ)</div>
        <div style="display:flex;gap:4px;align-items:center">
          <button class="btn btn-w btn-xs" onclick="_shareMatchPage=Math.max(0,_shareMatchPage-1);render()" ${safePage===0?'disabled':''}>â—€ ì´ì „</button>
          <span style="font-size:11px;color:var(--gray-l);padding:0 6px">${safePage+1} / ${totalPages}</span>
          <button class="btn btn-w btn-xs" onclick="_shareMatchPage=Math.min(${totalPages-1},_shareMatchPage+1);render()" ${safePage>=totalPages-1?'disabled':''}>ë‹¤ìŒ â–¶</button>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px;border:1px solid var(--border);border-radius:10px;padding:6px">
        ${pageMatches.length?pageMatches.map((m,pi)=>{
          const globalIdx=safePage*SHARE_MATCH_PER_PAGE+pi;
          const a=m.a||m.u||'AíŒ€',b=m.b||'BíŒ€';
          const ca=gc(a),cb=gc(b);
          const aWin=m.sa>m.sb;
          const isActive=window._shareMatchObj&&window._shareMatchObj===m;
          return`<button onclick="window._shareMatchObj=[...miniM,...univM,...ckM,...comps,...(typeof getTourneyMatches==='function'?getTourneyMatches():[])].sort((a,b)=>(b.d||'').localeCompare(a.d||''))[${globalIdx}]||null;renderShareCardByMatchObj(window._shareMatchObj)"
            style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:7px;border:2px solid ${isActive?'var(--blue)':'var(--border)'};background:${isActive?'var(--blue-l)':'transparent'};cursor:pointer;text-align:left;font-size:12px;transition:.1s"
            onmouseover="this.style.background='var(--blue-l)'" onmouseout="this.style.background='${isActive?'var(--blue-l)':'transparent'}'">
            <span style="color:var(--gray-l);min-width:80px;font-size:10px">${m.d||'-'}</span>
            <span style="background:${ca};color:#fff;padding:2px 9px;border-radius:4px;font-weight:700;font-size:11px">${a}</span>
            <span style="font-weight:900;font-size:15px;color:${aWin?'var(--green)':'#aaa'}">${m.sa}</span>
            <span style="color:var(--gray-l)">:</span>
            <span style="font-weight:900;font-size:15px;color:${(!aWin&&m.sb>m.sa)?'var(--green)':'#aaa'}">${m.sb}</span>
            <span style="background:${cb};color:#fff;padding:2px 9px;border-radius:4px;font-weight:700;font-size:11px">${b}</span>
            ${m.n?`<span style="color:var(--gold);font-size:10px;font-weight:600">ğŸ–ï¸${m.n}</span>`:''}
          </button>`;
        }).join(''):'<span style="color:var(--gray-l);padding:12px;font-size:12px;display:block">ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</span>'}
      </div>
      <div style="font-size:10px;color:var(--gray-l);text-align:right;margin-top:4px">ì „ì²´ ${allMatches.length}ê²½ê¸°</div>
    </div>`}

    <!-- ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸° -->
    <div id="sharecard-preview-wrap">
      <div style="font-size:11px;color:var(--gray-l);margin-bottom:6px">ğŸ’¡ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ì‚¬ë¼ì§‘ë‹ˆë‹¤</div>
      <div id="share-card" style="width:100%;max-width:420px;min-height:140px;border-radius:18px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.15);font-family:'Noto Sans KR',sans-serif;display:block;cursor:pointer" title="í´ë¦­í•˜ì—¬ ì¹´ë“œ ì´ˆê¸°í™”" onclick="resetShareCard(this)">
        <p style="text-align:center;color:var(--gray-l);padding:36px 20px;font-size:13px">ìœ„ì—ì„œ ì„ íƒí•˜ë©´ ì¹´ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤</p>
      </div>
      <div class="sharecard-modal-actions" style="justify-content:flex-start;margin-top:10px">
        <button class="btn btn-p btn-sm" onclick="downloadShareCardJpg()">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
      </div>
    </div>
  </div>`;
}
// ì´ì „ ì½”ë“œ í˜¸í™˜ìš©
function renderShareCardFilterPlayers(){
  const q=(document.getElementById('share-player-q')||{}).value||'';
  _sharePlayerSearch=q;
  const pList=players.filter(p=>p.history&&p.history.length>0).sort((a,b)=>b.history.length-a.history.length);
  const filtered=q?pList.filter(p=>p.name.toLowerCase().includes(q.toLowerCase())||p.univ.toLowerCase().includes(q.toLowerCase())):[];
  const list=document.getElementById('share-player-list');
  if(!list)return;
  if(!q){
    list.innerHTML='<span style="color:var(--gray-l);font-size:12px;padding:8px">ì´ë¦„ ë˜ëŠ” ëŒ€í•™ëª…ì„ ì…ë ¥í•˜ì„¸ìš”</span>';
    return;
  }
  list.innerHTML=filtered.length?filtered.slice(0,50).map(p=>`
    <button onclick="renderShareCardByPlayer('${p.name}')"
      style="padding:4px 13px;border-radius:20px;border:2px solid ${gc(p.univ)};background:${gc(p.univ)}22;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;transition:.12s"
      onmouseover="this.style.background='${gc(p.univ)}55'" onmouseout="this.style.background='${gc(p.univ)}22'">
      ${p.name} <span style="font-size:10px;opacity:.65">${p.univ}</span>
    </button>`).join(''):'<span style="color:var(--gray-l);font-size:12px;padding:8px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</span>';
}
function renderShareCardDynamic(){renderShareCardFilterPlayers();}
function renderShareCard(){
  const sel=document.getElementById('share-sel');
  if(sel){
    const val=sel.value;
    if(_shareMode==='player')renderShareCardByPlayer(val);
    else if(_shareMode==='univ')renderShareCardByUniv(val);
  }
}
function renderShareCardByPlayer(name){
  const card=document.getElementById('share-card');if(!card)return;
  const p=players.find(x=>x.name===name);
  if(!p){card.innerHTML='<p style="color:var(--gray-l);padding:40px;text-align:center">ì„ ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>';return;}
  const h=typeof statsNonProHist==='function'?statsNonProHist(p):(p.history||[]);
  const w=h.filter(x=>x.result==='ìŠ¹').length,l=h.filter(x=>x.result==='íŒ¨').length,tot=w+l;
  const rate=tot?Math.round(w/tot*100):0;
  const elo=p.elo||1200;
  const col=gc(p.univ);
  // historyëŠ” unshiftë¡œ ì¶”ê°€ë˜ë¯€ë¡œ ì•ì´ ìµœì‹  â€” slice(0,5)ê°€ ìµœê·¼ 5ê²½ê¸°
  const form=h.slice(0,5).map(x=>x.result==='ìŠ¹'
    ?'<span style="display:inline-block;width:26px;height:26px;background:#16a34a;color:#fff;font-size:11px;font-weight:800;border-radius:6px;text-align:center;line-height:26px;box-shadow:0 1px 4px rgba(0,0,0,.2)">W</span>'
    :'<span style="display:inline-block;width:26px;height:26px;background:#dc2626;color:#fff;font-size:11px;font-weight:800;border-radius:6px;text-align:center;line-height:26px;box-shadow:0 1px 4px rgba(0,0,0,.2)">L</span>').join('');
  const pts=p.points||0;
  const raceLabel=p.race==='T'?'í…Œë€':p.race==='Z'?'ì €ê·¸':p.race==='P'?'í”„ë¡œí† ìŠ¤':'?';
  // í¬ì¸íŠ¸ ìƒ‰ìƒ
  const ptsColor=pts>0?'#4ade80':pts<0?'#f87171':'rgba(255,255,255,.6)';
  // ìŠ¹ë¥  ë°”
  const ratePct=tot?rate:0;
  card.innerHTML=`<div style="background:linear-gradient(135deg,${col}dd,${col}88);padding:24px;color:#fff;position:relative;overflow:hidden">
    <div style="position:absolute;top:-30px;right:-30px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.06);pointer-events:none"></div>
    <!-- í—¤ë” -->
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px">
      <div style="width:54px;height:54px;border-radius:14px;background:rgba(255,255,255,.22);display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,.4);flex-shrink:0;overflow:hidden">${(()=>{const url=UNIV_ICONS[p.univ]||(univCfg.find(x=>x.name===p.univ)||{}).icon||'';return url?`<img src="${url}" style="width:38px;height:38px;object-fit:contain" onerror="this.parentElement.innerHTML='<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 24 24\\' fill=\\'white\\' width=\\'30\\' height=\\'30\\'><path d=\\'M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z\\'/></svg>'">` :`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='30' height='30'><path d='M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z'/></svg>`;})()}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:20px;font-weight:900;letter-spacing:.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name}${getStatusIconHTML(p.name)}${p.gender==='M'?'<span style="font-size:11px;background:rgba(255,255,255,.2);padding:1px 6px;border-radius:10px;margin-left:6px">â™‚</span>':''}</div>
        <div style="font-size:11px;opacity:.8;margin-top:3px">${p.univ} &nbsp;Â·&nbsp; ${p.tier||'-'} &nbsp;Â·&nbsp; ${raceLabel}</div>
      </div>
      <div style="text-align:center;background:rgba(0,0,0,.2);border-radius:10px;padding:7px 12px;flex-shrink:0">
        <div style="font-size:9px;opacity:.7;letter-spacing:.5px">ELO</div>
        <div style="font-size:20px;font-weight:900;line-height:1.1">${elo}</div>
      </div>
    </div>
    <!-- ìŠ¤íƒ¯ -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:14px">
      <div style="background:rgba(255,255,255,.15);border-radius:9px;padding:9px 6px;text-align:center">
        <div style="font-size:9px;opacity:.7;margin-bottom:3px">ìŠ¹</div><div style="font-size:22px;font-weight:900;color:#4ade80">${w}</div>
      </div>
      <div style="background:rgba(255,255,255,.15);border-radius:9px;padding:9px 6px;text-align:center">
        <div style="font-size:9px;opacity:.7;margin-bottom:3px">íŒ¨</div><div style="font-size:22px;font-weight:900;color:#f87171">${l}</div>
      </div>
      <div style="background:rgba(255,255,255,.15);border-radius:9px;padding:9px 6px;text-align:center">
        <div style="font-size:9px;opacity:.7;margin-bottom:3px">ìŠ¹ë¥ </div><div style="font-size:18px;font-weight:900">${tot?rate+'%':'-'}</div>
      </div>
      <div style="background:rgba(255,255,255,.15);border-radius:9px;padding:9px 6px;text-align:center">
        <div style="font-size:9px;opacity:.7;margin-bottom:3px">í¬ì¸íŠ¸</div><div style="font-size:18px;font-weight:900;color:${ptsColor}">${pts>=0?'+':''}${pts}</div>
      </div>
    </div>
    <!-- ìŠ¹ë¥  ë°” -->
    ${tot?`<div style="margin-bottom:12px">
      <div style="height:5px;border-radius:3px;background:rgba(255,255,255,.18);overflow:hidden">
        <div style="height:100%;width:${ratePct}%;background:rgba(255,255,255,.8);border-radius:3px;transition:width .3s"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:3px;font-size:9px;opacity:.6">
        <span>0%</span><span style="font-weight:700;font-size:10px">${ratePct}%</span><span>100%</span>
      </div>
    </div>`:''}
    <!-- ìµœê·¼ 5ê²½ê¸° -->
    <div>
      <div style="font-size:9px;opacity:.65;margin-bottom:6px;letter-spacing:.5px">ìµœê·¼ 5ê²½ê¸° (ìµœì‹ â†’ê³¼ê±°)</div>
      <div style="display:flex;gap:5px">${form||'<span style="opacity:.5;font-size:12px">ê¸°ë¡ì—†ìŒ</span>'}</div>
    </div>
    <div style="margin-top:14px;text-align:right;font-size:9px;opacity:.35;letter-spacing:.3px">â­ ìŠ¤íƒ€ëŒ€í•™ ë°ì´í„° ì„¼í„°</div>
  </div>`;
}
function renderShareCardByUniv(univName){
  const card=document.getElementById('share-card');if(!card)return;
  const uList=typeof univCfg!=='undefined'&&univCfg.length?univCfg:getAllUnivs();
  const u=uList.find(x=>x.name===univName)||getAllUnivs().find(x=>x.name===univName);
  if(!u){card.innerHTML='<p style="color:var(--gray-l);padding:40px;text-align:center">ëŒ€í•™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>';return;}
  const proIds=typeof statsProMatchIds==='function'?statsProMatchIds():new Set();
  const sc=typeof calcUnivRadar==='function'?calcUnivRadar(u.name,proIds):{winrate:0,avgElo:0,pts:0,w:0,l:0};
  const mem=players.filter(p=>p.univ===u.name);
  const ptsColor=sc.pts>0?'#4ade80':sc.pts<0?'#f87171':'rgba(255,255,255,.8)';
  const sortedMem=[...mem].sort((a,b)=>TIERS.indexOf(a.tier)-TIERS.indexOf(b.tier)||(b.points||0)-(a.points||0));
  card.innerHTML=`<div style="background:linear-gradient(135deg,${u.color}cc,${u.color}88);padding:24px;color:#fff;position:relative;overflow:hidden">
    <div style="position:absolute;top:-40px;right:-40px;width:160px;height:160px;border-radius:50%;background:rgba(255,255,255,.06);pointer-events:none"></div>
    <!-- í—¤ë” -->
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
      <div style="width:48px;height:48px;border-radius:12px;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,.35);flex-shrink:0;overflow:hidden">${(()=>{const url=UNIV_ICONS[u.name]||(univCfg.find(x=>x.name===u.name)||{}).icon||'';return url?`<img src="${url}" style="width:34px;height:34px;object-fit:contain" onerror="this.parentElement.innerHTML='<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 24 24\\' fill=\\'white\\' width=\\'28\\' height=\\'28\\'><path d=\\'M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z\\'/></svg>'">`:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='28' height='28'><path d='M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z'/></svg>`;})()}</div>
      <div>
        <div style="font-size:20px;font-weight:900;letter-spacing:.3px">${u.name}</div>
        <div style="font-size:11px;opacity:.75;margin-top:2px">ğŸ“ ì†Œì† ì„ ìˆ˜ ${mem.length}ëª…</div>
      </div>
    </div>
    <!-- ìŠ¤íƒ¯ 4ê²©ì -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:14px">
      <div style="background:rgba(255,255,255,.15);border-radius:9px;padding:9px 6px;text-align:center">
        <div style="font-size:9px;opacity:.7;margin-bottom:3px">ìŠ¹ë¥ </div>
        <div style="font-size:18px;font-weight:900">${sc.winrate}%</div>
      </div>
      <div style="background:rgba(255,255,255,.15);border-radius:9px;padding:9px 6px;text-align:center">
        <div style="font-size:9px;opacity:.7;margin-bottom:3px">ì „ì </div>
        <div style="font-size:13px;font-weight:900">${sc.w}W<br>${sc.l}L</div>
      </div>
      <div style="background:rgba(255,255,255,.15);border-radius:9px;padding:9px 6px;text-align:center">
        <div style="font-size:9px;opacity:.7;margin-bottom:3px">í‰ê· ELO</div>
        <div style="font-size:16px;font-weight:900">${sc.avgElo}</div>
      </div>
      <div style="background:rgba(255,255,255,.15);border-radius:9px;padding:9px 6px;text-align:center">
        <div style="font-size:9px;opacity:.7;margin-bottom:3px">í¬ì¸íŠ¸</div>
        <div style="font-size:16px;font-weight:900;color:${ptsColor}">${sc.pts>=0?'+':''}${sc.pts}</div>
      </div>
    </div>
    <!-- ì„ ìˆ˜ ëª©ë¡ -->
    <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px">
      ${sortedMem.slice(0,12).map(p=>`<span style="background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25);border-radius:20px;padding:2px 10px;font-size:10px;font-weight:600">${p.name}</span>`).join('')}
      ${mem.length>12?`<span style="opacity:.6;font-size:10px;padding:2px 6px">+${mem.length-12}ëª…</span>`:''}
    </div>
    <div style="text-align:right;font-size:9px;opacity:.35;letter-spacing:.3px">â­ ìŠ¤íƒ€ëŒ€í•™ ë°ì´í„° ì„¼í„°</div>
  </div>`;
}
function renderShareCardByMatchObj(m){
  const card=document.getElementById('share-card');if(!card)return;
  if(!m){card.innerHTML='<p style="color:var(--gray-l);padding:40px;text-align:center">ê²½ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>';return;}
  const a=m.a||'AíŒ€',b=m.b||'BíŒ€';
  const ca=gc(a),cb=gc(b);
  const aWin=m.sa>m.sb, bWin=m.sb>m.sa;
  const draw=!aWin&&!bWin;

  // â”€â”€ ë°°ê²½/ìƒ‰ìƒ ì‹œìŠ¤í…œ: ìŠ¹ë¦¬íŒ€ ìƒ‰ìƒ ê¸°ë°˜ í’€ ì»¬ëŸ¬ ì¹´ë“œ â”€â”€
  function hexToHsl(hex){
    let h=hex.replace('#','');
    if(h.length===3) h=h[0]+h[0]+h[1]+h[1]+h[2]+h[2];
    if(h.length!==6) return null;
    let r=parseInt(h.slice(0,2),16)/255;
    let g=parseInt(h.slice(2,4),16)/255;
    let b=parseInt(h.slice(4,6),16)/255;
    const max=Math.max(r,g,b),min=Math.min(r,g,b);
    let hue=0,sat=0,lit=(max+min)/2;
    if(max!==min){
      const d=max-min;
      sat=lit>.5?d/(2-max-min):d/(max+min);
      if(max===r) hue=((g-b)/d+(g<b?6:0))/6;
      else if(max===g) hue=((b-r)/d+2)/6;
      else hue=((r-g)/d+4)/6;
    }
    return{h:Math.round(hue*360),s:Math.round(sat*100),l:Math.round(lit*100)};
  }
  function makeCardTheme(hex){
    const hsl=hexToHsl(hex);
    if(!hsl) return{
      headerBg:'#1e293b', bodyBg:'#f8fafc',
      accentHex:hex||'#6366f1', accentDark:'#1e293b',
      text:'#1e293b', textDim:'rgba(30,41,59,.55)', divider:'rgba(30,41,59,.12)'
    };
    const {h,s,l}=hsl;
    // í—¤ë”: íŒ€ ì›ìƒ‰ (ì§„í•˜ê²Œ)
    const headerBg=`hsl(${h},${Math.min(s+5,90)}%,${Math.max(l-5,20)}%)`;
    // ë°”ë””: ê°™ì€ ìƒ‰ì¡° ë§¤ìš° ì—°í•œ íŒŒìŠ¤í…”
    const bodyBgL=Math.min(97, l+52);
    const bodyBgS=Math.min(s*0.25, 18);
    const bodyBg=`hsl(${h},${bodyBgS}%,${bodyBgL}%)`;
    // ê°•ì¡° ì–´ë‘ìš´ ë²„ì „
    const accentDark=`hsl(${h},${Math.min(s+10,95)}%,${Math.max(l-15,15)}%)`;
    const divider=`hsla(${h},${Math.min(s*0.5,35)}%,${Math.max(l-20,30)}%,.18)`;
    const textDim=`hsla(${h},${Math.min(s*0.4,30)}%,${Math.max(l-45,12)}%,.6)`;
    return{headerBg, bodyBg, accentHex:hex, accentDark, text:`hsl(${h},${Math.min(s*0.6,45)}%,${Math.max(l-52,8)}%)`, textDim, divider};
  }

  const theme = aWin ? makeCardTheme(ca) : bWin ? makeCardTheme(cb) : {
    headerBg:'#334155', bodyBg:'#f8fafc',
    accentHex:'#475569', accentDark:'#1e293b',
    text:'#1e293b', textDim:'rgba(71,85,105,.6)', divider:'rgba(148,163,184,.2)'
  };
  const winnerTeam=aWin?a:bWin?b:'';
  const winnerColor=aWin?ca:bWin?cb:'#475569';

  function hexToRgb(hex){
    let h=(hex||'').replace('#','');
    if(h.length===3)h=h[0]+h[0]+h[1]+h[1]+h[2]+h[2];
    if(h.length!==6)return '128,128,128';
    return parseInt(h.slice(0,2),16)+','+parseInt(h.slice(2,4),16)+','+parseInt(h.slice(4,6),16);
  }

  const caRgb=hexToRgb(ca), cbRgb=hexToRgb(cb);
  let setsHTML='';
  if(m.sets&&m.sets.length){
    setsHTML=m.sets.map((s,si)=>{
      const isAce=(si===2);
      const sLabel=isAce?'âš¡ ì—ì´ìŠ¤ê²°ì „':`${si+1}ì„¸íŠ¸`;
      const swA=s.scoreA||0,swB=s.scoreB||0;
      const sAW=swA>swB,sBW=swB>swA;
      const gameList=(s.games||[]).filter(g=>g.playerA||g.playerB);
      const games=gameList.map((g,gi)=>{
        const aW=g.winner==='A',bW=g.winner==='B';
        return`<div style="display:flex;align-items:center;gap:5px;font-size:11px;padding:3px 0;border-bottom:1px solid ${theme.divider}">
          <span style="color:${theme.textDim};min-width:42px;font-size:10px">ê²½ê¸°${gi+1}</span>
          <span style="flex:1;font-weight:${aW?'800':'400'};color:${aW?theme.text:theme.textDim};text-align:right">${g.playerA||'?'}</span>
          ${aW?`<span style="background:${ca};color:#fff;padding:1px 7px;border-radius:3px;font-size:9px;font-weight:800;flex-shrink:0">WIN</span>`:'<span style="width:34px;flex-shrink:0"></span>'}
          <span style="color:${theme.textDim};font-size:10px;flex-shrink:0">vs</span>
          ${bW?`<span style="background:${cb};color:#fff;padding:1px 7px;border-radius:3px;font-size:9px;font-weight:800;flex-shrink:0">WIN</span>`:'<span style="width:34px;flex-shrink:0"></span>'}
          <span style="flex:1;font-weight:${bW?'800':'400'};color:${bW?theme.text:theme.textDim}">${g.playerB||'?'}</span>
          ${g.map?`<span style="color:${theme.textDim};font-size:9px;flex-shrink:0">ğŸ“${g.map}</span>`:''}
        </div>`;
      }).join('');
      const setBg=isAce?`${theme.accentDark}15`:`${theme.divider}`;
      const setBorder=isAce?`${theme.accentDark}30`:theme.divider;
      return`<div style="background:${setBg};border:1px solid ${setBorder};border-radius:8px;padding:8px 12px;margin-bottom:6px">
        <div style="display:flex;align-items:center;justify-content:center;gap:6px;flex-wrap:wrap;margin-bottom:${gameList.length?'7':'0'}px">
          <span style="font-size:10px;font-weight:800;color:${isAce?theme.accentDark:theme.textDim};letter-spacing:.5px;min-width:60px;text-align:center">${sLabel}</span>
          <span style="font-weight:800;background:${sAW?ca:'transparent'};${sAW?'':'border:1px solid '+theme.divider};color:${sAW?'#fff':theme.textDim};padding:2px 9px;border-radius:4px;font-size:11px;text-align:center">${a}</span>
          <span style="font-weight:900;font-size:16px;letter-spacing:2px;min-width:48px;text-align:center">
            <span style="color:${sAW?ca:theme.textDim}">${swA}</span>
            <span style="color:${theme.textDim};font-size:12px;margin:0 4px">:</span>
            <span style="color:${sBW?cb:theme.textDim}">${swB}</span>
          </span>
          <span style="font-weight:800;background:${sBW?cb:'transparent'};${sBW?'':'border:1px solid '+theme.divider};color:${sBW?'#fff':theme.textDim};padding:2px 9px;border-radius:4px;font-size:11px;text-align:center">${b}</span>
          <span style="font-size:10px;color:${theme.textDim};white-space:nowrap">${sAW?'â–¶ '+a:sBW?'â–¶ '+b:'ë¬´ìŠ¹ë¶€'}</span>
        </div>
        ${games}
      </div>`;
    }).join('');
  }

  // â”€â”€ ëŒ€í•™ ì•„ì´ì½˜ í—¬í¼ â”€â”€
  function univIconHTML(name, size, fallbackColor){
    const url=UNIV_ICONS[name]||(univCfg.find(x=>x.name===name)||{}).icon||'';
    const s=size||'40px';
    if(url) return `<img src="${url}" style="width:${s};height:${s};object-fit:contain" onerror="this.outerHTML='<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 24 24\\' fill=\\'white\\' width=\\'${s}\\' height=\\'${s}\\'><path d=\\'M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z\\'/></svg>'">`;
    return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='${s}' height='${s}'><path d='M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z'/></svg>`;
  }

  card.innerHTML=`<div style="background:${theme.bodyBg};color:${theme.text};min-width:340px;border-radius:18px;overflow:hidden;font-family:'Noto Sans KR',sans-serif">

    <!-- ìƒë‹¨ í—¤ë” ë°”: ìŠ¹ë¦¬íŒ€ í’€ì»¬ëŸ¬ -->
    <div style="background:${theme.headerBg};padding:18px 22px 20px;position:relative;overflow:hidden">
      <!-- ë°°ê²½ ì¥ì‹ -->
      <div style="position:absolute;top:-30px;right:-30px;width:130px;height:130px;border-radius:50%;background:rgba(255,255,255,.1);pointer-events:none"></div>
      <div style="position:absolute;bottom:-40px;left:20px;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,.07);pointer-events:none"></div>

      <!-- ëŒ€íšŒëª… + ë‚ ì§œ -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        ${m.n?`<div style="font-size:11px;color:rgba(255,255,255,.9);font-weight:700;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);padding:2px 12px;border-radius:20px">ğŸ–ï¸ ${m.n}</div>`:'<div></div>'}
        <div style="font-size:11px;color:rgba(255,255,255,.65)">${m.d||''}</div>
      </div>

      <!-- íŒ€ ëŒ€ê²° -->
      <div style="display:flex;align-items:center;justify-content:center;gap:10px">
        <!-- AíŒ€ -->
        <div style="text-align:center;flex:1;min-width:0">
          <div style="width:58px;height:58px;border-radius:16px;background:${aWin?`rgba(${caRgb},.38)`:`rgba(${caRgb},.14)`};margin:0 auto 8px;display:flex;align-items:center;justify-content:center;${aWin?'box-shadow:0 4px 20px rgba(0,0,0,.25);border:2px solid rgba(255,255,255,.55);':'opacity:.5;'}overflow:hidden">
            ${univIconHTML(a,'40px')}
          </div>
          <div style="font-size:13px;font-weight:${aWin?900:600};color:${aWin?'#fff':'rgba(255,255,255,.65)'};white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${a}</div>
          ${aWin?`<div style="margin-top:5px"><span style="background:rgba(255,255,255,.25);border:1px solid rgba(255,255,255,.5);color:#fff;font-size:9px;font-weight:800;padding:2px 10px;border-radius:20px;letter-spacing:.5px">ğŸ† ìŠ¹ë¦¬</span></div>`:`<div style="margin-top:5px;font-size:10px;color:rgba(255,255,255,.5);font-weight:600">íŒ¨ë°°</div>`}
        </div>

        <!-- ìŠ¤ì½”ì–´ -->
        <div style="text-align:center;flex-shrink:0;padding:0 6px">
          <div style="font-size:52px;font-weight:900;letter-spacing:2px;line-height:1;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.25)">
            <span>${m.sa??'-'}</span><span style="font-size:30px;opacity:.6;margin:0 2px">:</span><span>${m.sb??'-'}</span>
          </div>
          ${draw?`<div style="font-size:10px;color:rgba(255,255,255,.7);margin-top:4px;letter-spacing:2px;font-weight:700">ë¬´ ìŠ¹ ë¶€</div>`:''}
        </div>

        <!-- BíŒ€ -->
        <div style="text-align:center;flex:1;min-width:0">
          <div style="width:58px;height:58px;border-radius:16px;background:${bWin?`rgba(${cbRgb},.38)`:`rgba(${cbRgb},.14)`};margin:0 auto 8px;display:flex;align-items:center;justify-content:center;${bWin?'box-shadow:0 4px 20px rgba(0,0,0,.25);border:2px solid rgba(255,255,255,.55);':'opacity:.5;'}overflow:hidden">
            ${univIconHTML(b,'40px')}
          </div>
          <div style="font-size:13px;font-weight:${bWin?900:600};color:${bWin?'#fff':'rgba(255,255,255,.65)'};white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${b}</div>
          ${bWin?`<div style="margin-top:5px"><span style="background:rgba(255,255,255,.25);border:1px solid rgba(255,255,255,.5);color:#fff;font-size:9px;font-weight:800;padding:2px 10px;border-radius:20px;letter-spacing:.5px">ğŸ† ìŠ¹ë¦¬</span></div>`:`<div style="margin-top:5px;font-size:10px;color:rgba(255,255,255,.5);font-weight:600">íŒ¨ë°°</div>`}
        </div>
      </div>
    </div>

    <!-- ë°”ë””: ì—°í•œ ë°°ê²½ -->
    <div style="padding:${setsHTML?'14px 18px 16px':'10px 18px 14px'}">
      ${setsHTML?`<div style="margin-bottom:2px">${setsHTML}</div>`:''}
      <!-- í‘¸í„° -->
      <div style="text-align:right;font-size:10px;color:${theme.textDim};letter-spacing:.3px">â­ ìŠ¤íƒ€ëŒ€í•™ ë°ì´í„° ì„¼í„°</div>
    </div>
  </div>`;
}


// ìº˜ë¦°ë” ê²½ê¸° ê³µìœ ì¹´ë“œ ì—´ê¸°
// calView=day ê²½ê¸° ê³µìœ ì¹´ë“œ - rCalì˜ allMatches ìºì‹œ ì´ìš©
function openRCalMatchShareCard(ds, mi){
  const all=(window._rCalAllMatches||[...miniM,...univM,...comps,...ckM,...proM]);
  const dayMatches=all.filter(m=>m.d===ds&&m.sa!=null&&m.sa!=='');
  const m=dayMatches[mi];
  if(!m)return;
  const isCKorPro=ckM.includes(m)||proM.includes(m);
  window._shareMatchObj={...m, a:isCKorPro?'AíŒ€':(m.a||''), b:isCKorPro?'BíŒ€':(m.b||'')};
  _shareMode='match';
  openShareCardModal();
  setTimeout(()=>{if(window._shareMatchObj)renderShareCardByMatchObj(window._shareMatchObj);},80);
}

// ìº˜ë¦°ë” calShowDay ê³µìœ ì¹´ë“œ - ìºì‹œëœ ë°°ì—´ì˜ ì¸ë±ìŠ¤ë¡œ ì°¸ì¡°
function openCalMatchShareCardByCache(ds, mi){
  const matches=window._calDayCache&&window._calDayCache[ds];
  if(!matches||mi>=matches.length)return;
  const m=matches[mi];
  if(!m)return;
  const isCKorPro=ckM.includes(m)||proM.includes(m);
  window._shareMatchObj={...m, a:isCKorPro?'AíŒ€':(m.a||''), b:isCKorPro?'BíŒ€':(m.b||'')};
  _shareMode='match';
  openShareCardModal();
  setTimeout(()=>{if(window._shareMatchObj)renderShareCardByMatchObj(window._shareMatchObj);},80);
}

function openCalMatchShareCard(mode, idx){
  // modeë³„ ë°°ì—´ì—ì„œ ì§ì ‘ ì¸ë±ìŠ¤ë¡œ ì°¸ì¡°
  const arr=mode==='mini'?miniM:mode==='univm'?univM:mode==='ck'?ckM:mode==='pro'?proM:comps;
  if(!arr||idx<0||idx>=arr.length){
    // ëª» ì°¾ìœ¼ë©´ tourneyì—ì„œ ì‹œë„ (mode==='comp'ì¼ ë•Œ)
    if(mode==='comp'){
      const tourItems=typeof getTourneyMatches==='function'?getTourneyMatches():[];
      const m=tourItems[idx-comps.length];
      if(m){
        window._shareMatchObj=m;
        _shareMode='match';
        openShareCardModal();
        setTimeout(()=>renderShareCardByMatchObj(window._shareMatchObj),80);
        return;
      }
    }
    return;
  }
  const m=arr[idx];
  if(!m)return;
  const isCKorPro=(mode==='ck'||mode==='pro');
  window._shareMatchObj={...m, a:isCKorPro?'AíŒ€':(m.a||''), b:isCKorPro?'BíŒ€':(m.b||'')};
  _shareMode='match';
  openShareCardModal();
  setTimeout(()=>{if(window._shareMatchObj)renderShareCardByMatchObj(window._shareMatchObj);},80);
}

// ëŒ€íšŒ íƒ­ ê²½ê¸° ê³µìœ ì¹´ë“œ ì—´ê¸°
function openCompMatchShareCard(tnId, gi, mi){
  const tn=(tourneys||[]).find(t=>t.id===tnId);
  if(!tn)return;
  const grp=tn.groups&&tn.groups[gi];
  if(!grp)return;
  const m=grp.matches&&grp.matches[mi];
  if(!m)return;
  window._shareMatchObj={a:m.a||'',b:m.b||'',sa:m.sa,sb:m.sb,d:m.d||'',n:tn.name,sets:m.sets||[]};
  _shareMode='match';
  openShareCardModal();
  setTimeout(()=>renderShareCardByMatchObj(window._shareMatchObj),80);
}

// ê³µìœ ì¹´ë“œ ëª¨ë‹¬ ì—´ê¸°
function openShareCardModal(){
  // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
  const existing=document.getElementById('sharecard-overlay');
  if(existing)existing.remove();
  
  const overlay=document.createElement('div');
  overlay.id='sharecard-overlay';
  overlay.className='sharecard-modal-overlay';
  overlay.innerHTML=`<div class="sharecard-modal-box" onclick="event.stopPropagation()" style="max-width:460px;width:96vw">
    <button class="sharecard-modal-close" onclick="document.getElementById('sharecard-overlay').remove()" style="z-index:2">âœ•</button>
    <div style="font-weight:700;font-size:14px;color:var(--blue);margin-bottom:14px;padding-right:30px">ğŸ´ ê³µìœ  ì¹´ë“œ</div>
    <div id="modal-share-card" style="display:flex;justify-content:center;overflow:auto;max-height:70vh;padding-bottom:4px">
      <div id="share-card" style="width:100%;max-width:420px;min-height:140px;border-radius:18px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.22);font-family:'Noto Sans KR',sans-serif;display:block">
        <p style="text-align:center;color:var(--gray-l);padding:36px 20px;font-size:13px">ì¹´ë“œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...</p>
      </div>
    </div>
    <div class="sharecard-modal-actions" style="margin-top:16px">
      <button class="btn btn-p" onclick="downloadShareCardJpg()">ğŸ“· JPG ì €ì¥</button>
      <button class="btn btn-w" onclick="downloadShareCard()">ğŸ–¼ PNG ì €ì¥</button>
      <button class="btn btn-w" onclick="document.getElementById('sharecard-overlay').remove()">ë‹«ê¸°</button>
    </div>
  </div>`;
  // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
  overlay.addEventListener('click', function(e){
    if(e.target===overlay) overlay.remove();
  });
  document.body.appendChild(overlay);
}

// ê³µìœ ì¹´ë“œ ì´ˆê¸°í™”
function resetShareCard(el){
  const c=el||document.getElementById('share-card');
  if(!c)return;
  c.innerHTML='<p style="text-align:center;color:var(--gray-l);padding:36px 20px;font-size:13px">ìœ„ì—ì„œ ì„ íƒí•˜ë©´ ì¹´ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤</p>';
}

// ì´ë¯¸ì§€ ì €ì¥ í•¨ìˆ˜ (JPG)
async function downloadShareCardJpg(){
  const el=document.getElementById('share-card');
  if(!el||el.querySelector('p')){alert('ë¨¼ì € ì¹´ë“œë¥¼ ìƒì„±í•˜ì„¸ìš”.');return;}
  try{
    // backgroundColor null â†’ ì¹´ë“œ ìì²´ ë°°ê²½ìƒ‰ ìœ ì§€
    const canvas=await html2canvas(el,{backgroundColor:null,scale:3,useCORS:true,logging:false});
    const a=document.createElement('a');
    const team=el.querySelector('[style*="font-size:14px;font-weight:800"]');
    a.download=`share_card_${new Date().toISOString().slice(0,10)}.jpg`;
    a.href=canvas.toDataURL('image/jpeg',0.96);a.click();
  }catch(e){alert('ì €ì¥ ì˜¤ë¥˜: '+e.message);}
}

// ì•ˆì „í•œ match ê°ì²´ íŒŒì‹± í—¬í¼
function _getMatchObjSafe(jsonObj){
  try{
    if(typeof jsonObj==='string') return JSON.parse(jsonObj);
    return jsonObj;
  }catch(e){return null;}
}

async function downloadShareCard(){
  const el=document.getElementById('share-card');
  if(!el||!el.children.length||el.querySelector('p')){alert('ë¨¼ì € ì¹´ë“œë¥¼ ìƒì„±í•˜ì„¸ìš”.');return;}
  try{
    const canvas=await html2canvas(el,{backgroundColor:null,scale:3,useCORS:true,logging:false});
    const a=document.createElement('a');
    a.download=`share_card_${new Date().toISOString().slice(0,10)}.png`;
    a.href=canvas.toDataURL('image/png');a.click();
  }catch(e){alert('ì €ì¥ ì˜¤ë¥˜: '+e.message);}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   A. í™œë™ëŸ‰ íˆíŠ¸ë§µ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _heatmapSelPlayer='';
function heatmapSearchFilter(q){
  const d=document.getElementById('heatmap-search-drop');if(!d)return;
  d.querySelectorAll('.sitem').forEach(el=>{el.style.display=el.textContent.toLowerCase().includes(q.toLowerCase())?'':'none';});
}
function statsHeatmapHTML(){
  const playersWithHist=players.filter(p=>(p.history||[]).length>0).sort((a,b)=>a.name.localeCompare(b.name,'ko'));
  const isPlayerMode=!!_heatmapSelPlayer;
  const dayCnt={};
  if(isPlayerMode){
    // ì„ ìˆ˜ë³„ íˆíŠ¸ë§µ: historyì˜ ë‚ ì§œ ê¸°ì¤€ (1ê²½ê¸°=1ì¹¸)
    const tp=players.find(p=>p.name===_heatmapSelPlayer);
    (tp?.history||[]).forEach(h=>{
      const d=h.date||'';if(!d)return;
      if(h.result==='ìŠ¹')dayCnt[d]=(dayCnt[d]||0)+1; // ìŠ¹ì ê¸°ì¤€ 1ë²ˆë§Œ ì¹´ìš´íŠ¸
    });
    // 0ì´ë©´ íŒ¨ë°° í¬í•¨í•´ì„œ ë‹¤ì‹œ
    if(!Object.keys(dayCnt).length){
      (tp?.history||[]).forEach(h=>{const d=h.date||'';if(!d)return;dayCnt[d]=(dayCnt[d]||0)+1;});
    }
  }else{
    // ì „ì²´ ê²½ê¸° íˆíŠ¸ë§µ: ë§¤ì¹˜ ë‚ ì§œ ê¸°ì¤€ ê²Œì„ ìˆ˜ (í† ë„ˆë¨¼íŠ¸ í¬í•¨)
    const _heatTourM=typeof getTourneyMatches==='function'?getTourneyMatches():[];
    const allM=[...miniM,...univM,...ckM,...comps,...proM,..._heatTourM];
    allM.forEach(m=>{
      const d=m.d||'';if(!d)return;
      // sets.games ì¹´ìš´íŠ¸
      let cnt=0;
      (m.sets||[]).forEach(s=>(s.games||[]).forEach(()=>cnt++));
      if(cnt>0)dayCnt[d]=(dayCnt[d]||0)+cnt;
      else dayCnt[d]=(dayCnt[d]||0)+1; // ê²½ê¸° ìì²´ë„ ì¹´ìš´íŠ¸
    });
    // ê°œì¸ íˆìŠ¤í† ë¦¬ì—ì„œë„ ì§‘ê³„ (ë§¤ì¹˜ ë°ì´í„° ì—†ëŠ” ê°œì¸ì „)
    const matchDates=new Set(Object.keys(dayCnt));
    players.forEach(p=>(p.history||[]).forEach(h=>{
      const d=h.date||'';if(!d||h.result!=='ìŠ¹')return;
      // ì´ë¯¸ ë§¤ì¹˜ë¡œ ì§‘ê³„ëœ ë‚ ì§œëŠ” ì¶”ê°€ ì§‘ê³„ ì•ˆ í•¨ (ì¤‘ë³µ ë°©ì§€)
      if(!matchDates.has(d))dayCnt[d]=(dayCnt[d]||0)+1;
    }));
  }

  if(!Object.keys(dayCnt).length){
    const msg=isPlayerMode?`${_heatmapSelPlayer} ì„ ìˆ˜ì˜ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`:'ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
    return `<div class="ssec"><p style="color:var(--gray-l);padding:40px;text-align:center">${msg}</p></div>`;
  }

  // ìµœê·¼ 52ì£¼(364ì¼) ê¸°ì¤€
  const today=new Date(); today.setHours(0,0,0,0);
  const start=new Date(today); start.setDate(start.getDate()-363);
  // startë¥¼ ì¼ìš”ì¼ë¡œ ë§ì¶¤
  start.setDate(start.getDate()-start.getDay());

  const maxCnt=Math.max(...Object.values(dayCnt),1);
  const cellSize=14, cellGap=2, cellTotal=cellSize+cellGap;
  const weeks=53;
  const svgW=weeks*cellTotal+60, svgH=7*cellTotal+36;
  const pad={l:32,t:20};

  function dateStr(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
  function heatColor(cnt){
    if(!cnt) return 'var(--border)';
    const v=cnt/maxCnt;
    if(v<0.25) return '#bbf7d0';
    if(v<0.5)  return '#4ade80';
    if(v<0.75) return '#16a34a';
    return '#166534';
  }

  let cells='', monthLabels='', lastMonth=-1;
  const cur=new Date(start);
  for(let w=0;w<weeks;w++){
    for(let d=0;d<7;d++){
      const ds=dateStr(cur);
      const cnt=dayCnt[ds]||0;
      const x=pad.l+w*cellTotal, y=pad.t+d*cellTotal;
      cells+=`<rect x="${x}" y="${y}" width="${cellSize}" height="${cellSize}" rx="2" fill="${heatColor(cnt)}" data-date="${ds}" data-cnt="${cnt}">
        <title>${ds}: ${cnt}ê²Œì„</title></rect>`;
      // ì›” ë ˆì´ë¸” (ì²« ë²ˆì§¸ ì£¼ ë˜ëŠ” ìƒˆ ì›”)
      if(d===0 && cur.getMonth()!==lastMonth){
        lastMonth=cur.getMonth();
        const mLabel=['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'][cur.getMonth()];
        monthLabels+=`<text x="${x}" y="${pad.t-6}" font-size="9" fill="var(--gray-l)">${mLabel}</text>`;
      }
      cur.setDate(cur.getDate()+1);
    }
  }

  const dayLabels=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].map((d,i)=>
    i%2===1?`<text x="${pad.l-6}" y="${pad.t+i*cellTotal+cellSize-2}" font-size="9" fill="var(--gray-l)" text-anchor="end">${d}</text>`:''
  ).join('');

  const totalGames=Object.values(dayCnt).reduce((a,b)=>a+b,0);
  const activeDays=Object.keys(dayCnt).length;
  const topDays=Object.entries(dayCnt).sort((a,b)=>b[1]-a[1]).slice(0,5);

  const selHeatP=players.find(p=>p.name===_heatmapSelPlayer);
  return`<div style="display:flex;flex-direction:column;gap:16px">
  <div class="ssec" id="stats-heatmap-sec">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px">
      <h4 style="margin:0">ğŸ“… í™œë™ëŸ‰ íˆíŠ¸ë§µ <span style="font-size:11px;color:var(--gray-l);font-weight:400">ìµœê·¼ 1ë…„</span></h4>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <div style="position:relative">
          <input id="heatmap-search-input" type="text" placeholder="ğŸ” ì„ ìˆ˜ ê²€ìƒ‰ (ì „ì²´ë³´ê¸°: ë¹„ì›Œë‘ê¸°)"
            value="${_heatmapSelPlayer}"
            style="font-size:12px;padding:4px 10px;border:1px solid var(--border2);border-radius:8px;width:200px"
            oninput="heatmapSearchFilter(this.value);if(!this.value){_heatmapSelPlayer='';render();}"
            onfocus="document.getElementById('heatmap-search-drop').style.display='block'"
            onblur="setTimeout(()=>{const d=document.getElementById('heatmap-search-drop');if(d)d.style.display='none'},200)">
          <div id="heatmap-search-drop" style="display:none;position:absolute;top:34px;left:0;background:var(--white);border:1px solid var(--border2);border-radius:8px;z-index:300;max-height:200px;overflow-y:auto;width:260px;box-shadow:var(--sh2)">
            <div class="sitem" style="color:var(--gray-l);font-style:italic" onmousedown="_heatmapSelPlayer='';document.getElementById('heatmap-search-input').value='';document.getElementById('heatmap-search-drop').style.display='none';render()">â€” ì „ì²´ ê²½ê¸° ë³´ê¸° â€”</div>
            ${playersWithHist.map(p=>`<div class="sitem" onmousedown="_heatmapSelPlayer='${p.name.replace(/'/g,"\'")}';document.getElementById('heatmap-search-input').value='${p.name.replace(/'/g,"\'")}';document.getElementById('heatmap-search-drop').style.display='none';render()">
              <b>${p.name}</b> <span style="color:${gc(p.univ)};font-size:11px">${p.univ}</span> <span style="color:var(--gray-l);font-size:10px">${(p.history||[]).length}ê²½ê¸°</span>
            </div>`).join('')}
          </div>
        </div>
        ${selHeatP?`<span class="ubadge" style="background:${gc(selHeatP.univ)}">${selHeatP.univ}</span>`:''}
        <div style="display:flex;gap:12px;font-size:12px;color:var(--gray-l)">
          <span>ì´ <b style="color:var(--blue)">${totalGames}</b>${isPlayerMode?'ê²½ê¸°':'ê²Œì„'}</span>
          <span>í™œë™ì¼ <b style="color:var(--green)">${activeDays}</b>ì¼</span>
        </div>
      </div>
    </div>
    <div style="overflow-x:auto;padding-bottom:4px">
      <svg width="${svgW}" height="${svgH}" style="display:block">
        ${monthLabels}${dayLabels}${cells}
        <text x="${pad.l}" y="${svgH-2}" font-size="9" fill="var(--gray-l)">ì ìŒ</text>
        ${[0,1,2,3,4].map((v,i)=>`<rect x="${pad.l+24+i*16}" y="${svgH-12}" width="12" height="12" rx="2" fill="${heatColor(v===0?0:Math.ceil(maxCnt*v/4))}"/>`).join('')}
        <text x="${pad.l+24+5*16}" y="${svgH-2}" font-size="9" fill="var(--gray-l)">ë§ìŒ</text>
      </svg>
    </div>
  </div>
  <div class="ssec">
    <h4 style="margin-bottom:12px">ğŸ”¥ ìµœë‹¤ ê²½ê¸°ì¼ TOP 5</h4>
    <div style="display:flex;flex-direction:column;gap:6px">
      ${topDays.map(([d,c],i)=>{
        const badge=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`${i+1}`;
        return`<div style="display:flex;align-items:center;gap:12px;padding:8px 14px;background:var(--white);border:1px solid var(--border);border-radius:8px">
          <span style="font-size:16px">${badge}</span>
          <span style="font-weight:700;font-size:13px;color:var(--blue);min-width:96px">${d}</span>
          <div style="flex:1;background:#f1f5f9;border-radius:20px;height:10px;overflow:hidden">
            <div style="width:${Math.round(c/topDays[0][1]*100)}%;background:#16a34a;height:100%;border-radius:20px"></div>
          </div>
          <span style="font-weight:800;font-size:14px;color:#16a34a;min-width:40px;text-align:right">${c}ê²Œì„</span>
        </div>`;
      }).join('')}
    </div>
  </div>
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   B. í‹°ì–´ë³„ ìŠ¹ë¥  ë¶„ì„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _tierWinFilter={race:'',univ:'',gender:''};
function statsTierWinHTML(){
  const f=_tierWinFilter;
  const proIds=statsProMatchIds();
  // ê° ì„ ìˆ˜ì˜ ìƒëŒ€ í‹°ì–´ë³„ ìŠ¹ë¥  ë¶„ì„
  // í‹°ì–´ ì¸ë±ìŠ¤ ë§µ
  const tierIdx={};
  TIERS.forEach((t,i)=>tierIdx[t]=i);
  const data=[];
  players.filter(p=>{
    if(f.race&&p.race!==f.race)return false;
    if(f.univ&&p.univ!==f.univ)return false;
    if(f.gender&&p.gender!==f.gender)return false;
    return true;
  }).forEach(p=>{
    const myIdx=tierIdx[p.tier]??99;
    let up={w:0,l:0}, same={w:0,l:0}, down={w:0,l:0};
    // ì „ì²´ íˆìŠ¤í† ë¦¬ (í”„ë¡œë¦¬ê·¸ í¬í•¨) ì‚¬ìš©
    (p.history||[]).forEach(h=>{
      const opp=players.find(x=>x.name===h.opp);
      if(!opp) return;
      const oppIdx=tierIdx[opp.tier]??99;
      const diff=myIdx-oppIdx; // ìŒìˆ˜=ìƒìœ„, ì–‘ìˆ˜=í•˜ìœ„
      const bucket=diff<0?up:diff===0?same:down;
      if(h.result==='ìŠ¹') bucket.w++; else bucket.l++;
    });
    const tot=up.w+up.l+same.w+same.l+down.w+down.l;
    if(tot<1) return; // ìµœì†Œ 1ê²½ê¸°
    data.push({...p,up,same,down,tot});
  });
  data.sort((a,b)=>{
    const aUp=a.up.w+a.up.l>0?a.up.w/(a.up.w+a.up.l):0;
    const bUp=b.up.w+b.up.l>0?b.up.w/(b.up.w+b.up.l):0;
    return bUp-aUp;
  });

  const univs=getAllUnivs();
  const bar=(w,l,color)=>{
    const t=w+l; if(!t) return '<span style="color:var(--gray-l);font-size:11px">-</span>';
    const r=Math.round(w/t*100);
    return`<div style="display:flex;flex-direction:column;align-items:center;gap:2px;min-width:52px">
      <div style="font-weight:800;font-size:12px;color:${r>=50?color:'#94a3b8'}">${r}%</div>
      <div style="width:48px;height:6px;background:#f1f5f9;border-radius:3px;overflow:hidden">
        <div style="width:${r}%;height:100%;background:${r>=50?color:'#e2e8f0'};border-radius:3px"></div>
      </div>
      <div style="font-size:9px;color:var(--gray-l)">${w}W${l}L</div>
    </div>`;
  };

  return`<div style="display:flex;flex-direction:column;gap:14px">
  <div class="ssec" id="stats-tierwin-sec">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
      <h4 style="margin:0">ğŸ¯ í‹°ì–´ë³„ ìŠ¹ë¥  ë¶„ì„ <span style="font-size:11px;color:var(--gray-l);font-weight:400">(í”„ë¡œë¦¬ê·¸Â·ë‚¨ì í¬í•¨ ì „ì²´)</span></h4>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
      <select onchange="_tierWinFilter.race=this.value;render()" style="font-size:12px;padding:5px 8px;border:1px solid var(--border2);border-radius:7px">
        <option value="">ì¢…ì¡± ì „ì²´</option>
        <option value="T"${f.race==='T'?' selected':''}>í…Œë€</option>
        <option value="Z"${f.race==='Z'?' selected':''}>ì €ê·¸</option>
        <option value="P"${f.race==='P'?' selected':''}>í”„ë¡œí† ìŠ¤</option>
      </select>
      <select onchange="_tierWinFilter.univ=this.value;render()" style="font-size:12px;padding:5px 8px;border:1px solid var(--border2);border-radius:7px">
        <option value="">ëŒ€í•™ ì „ì²´</option>
        ${univs.map(u=>`<option value="${u.name}"${f.univ===u.name?' selected':''}>${u.name}</option>`).join('')}
      </select>
      <select onchange="_tierWinFilter.gender=this.value;render()" style="font-size:12px;padding:5px 8px;border:1px solid var(--border2);border-radius:7px">
        <option value="">ì„±ë³„ ì „ì²´</option>
        <option value="M"${f.gender==='M'?' selected':''}>ğŸ‘¨ ë‚¨ì</option>
        <option value="F"${f.gender==='F'?' selected':''}>ğŸ‘© ì—¬ì</option>
      </select>
      <button class="btn btn-w btn-sm" onclick="_tierWinFilter={race:'',univ:'',gender:''};render()">ì´ˆê¸°í™”</button>
    </div>
    ${data.length===0?'<p style="color:var(--gray-l);padding:20px;text-align:center">ì¡°ê±´ì— ë§ëŠ” ë°ì´í„° ì—†ìŒ</p>':`
    <div style="overflow-x:auto"><table>
      <thead><tr>
        <th style="min-width:30px">ìˆœìœ„</th><th style="min-width:80px">ì„ ìˆ˜</th><th>ëŒ€í•™</th><th>í‹°ì–´</th>
        <th style="min-width:70px;text-align:center">â¬†ï¸ ìƒìœ„í‚¬</th>
        <th style="min-width:70px;text-align:center">â†”ï¸ ë™í‹°ì–´</th>
        <th style="min-width:70px;text-align:center">â¬‡ï¸ í•˜ìœ„ì „</th>
        <th style="min-width:50px;text-align:center">ì´ê²½ê¸°</th>
      </tr></thead><tbody>
      ${data.map((p,i)=>`<tr style="cursor:pointer" onclick="openPlayerModal('${p.name}')">
        <td>${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1}</td>
        <td style="font-weight:700;color:var(--blue)">${p.name}</td>
        <td><span class="ubadge" style="background:${gc(p.univ)}">${p.univ}</span></td>
        <td>${getTierLabel(p.tier||'-')}</td>
        <td style="text-align:center">${bar(p.up.w,p.up.l,'#7c3aed')}</td>
        <td style="text-align:center">${bar(p.same.w,p.same.l,'#2563eb')}</td>
        <td style="text-align:center">${bar(p.down.w,p.down.l,'#16a34a')}</td>
        <td style="text-align:center;color:var(--gray-l);font-size:12px">${p.tot}</td>
      </tr>`).join('')}
      </tbody>
    </table></div>`}
  </div></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   C. ë§µë³„ ì„ ìˆ˜ íŠ¹í™” ë¶„ì„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _mapRankSelMap='';
function statsMapRankHTML(){
  // ë§µ ì´ë¦„: ì„¤ì •ëœ maps + ê²½ê¸° íˆìŠ¤í† ë¦¬ì— ìˆëŠ” ë§µ ëª¨ë‘ í•©ì‚°
  const histMaps=[...new Set(players.flatMap(p=>(p.history||[]).map(h=>h.map).filter(m=>m&&m!=='-')))];
  // maps ì„¤ì • ë°°ì—´ì—ì„œë„ ì¶”ê°€ (maps = ì „ì²´ ë§µ ì„¤ì •)
  const configMaps=(maps||[]).filter(m=>m&&m!=='-');
  const allMaps=[...new Set([...histMaps,...configMaps])].sort();
  if(!allMaps.length) return`<div class="ssec"><p style="color:var(--gray-l);padding:40px;text-align:center">ë§µ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br><span style="font-size:11px">ì„¤ì •ì—ì„œ ë§µì„ ë“±ë¡í•˜ê±°ë‚˜ ê²½ê¸° ê¸°ë¡ì— ë§µ ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</span></p></div>`;
  if(!_mapRankSelMap||!allMaps.includes(_mapRankSelMap)) _mapRankSelMap=allMaps[0];

  const mapData={};
  allMaps.forEach(m=>mapData[m]={});

  // â”€â”€ 1ì°¨: player.history ê¸°ì¤€ìœ¼ë¡œ ì§‘ê³„ (ì£¼ ì†ŒìŠ¤)
  // historyì˜ matchIdë¥¼ ì¶”ì í•´ ì´ì¤‘ ì§‘ê³„ ë°©ì§€
  const countedMatchIds=new Set();
  players.forEach(p=>{
    (p.history||[]).forEach(h=>{
      if(!h.map||h.map==='-') return;
      if(!mapData[h.map]) mapData[h.map]={};
      if(!mapData[h.map][p.name]) mapData[h.map][p.name]={w:0,l:0,univ:p.univ,tier:p.tier};
      if(h.result==='ìŠ¹') mapData[h.map][p.name].w++;
      else mapData[h.map][p.name].l++;
      if(h.matchId) countedMatchIds.add(h.matchId+'_'+p.name);
    });
  });

  // â”€â”€ 2ì°¨: sets.games ë³´ì™„ (historyì— ì—†ëŠ” ê²Œì„ - matchId ì—†ê±°ë‚˜ ë¯¸ë§¤í•‘)
  const tourMatchSets=[];
  (tourneys||[]).forEach(tn=>(tn.groups||[]).forEach(grp=>(grp.matches||[]).forEach(m=>tourMatchSets.push(m))));
  const allMatchSets=[...miniM,...univM,...ckM,...comps,...proM,...tourMatchSets];
  allMatchSets.forEach(m=>{
    (m.sets||[]).forEach((set,si)=>{
      const setMap=set.map||(m.maps&&m.maps[si])||m.map||'';
      (set.games||[]).forEach(g=>{
        const mapName=g.map||setMap||'';
        if(!mapName||mapName==='-') return;
        const wn=g.winner==='A'?g.playerA:g.playerB;
        const ln=g.winner==='A'?g.playerB:g.playerA;
        // matchIdë¡œ ì´ë¯¸ historyì—ì„œ ì§‘ê³„ëœ ê²Œì„ì´ë©´ ìŠ¤í‚µ
        const wmKey=g.matchId&&wn?g.matchId+'_'+wn:'';
        const lmKey=g.matchId&&ln?g.matchId+'_'+ln:'';
        if(!mapData[mapName]) mapData[mapName]={};
        if(wn&&!countedMatchIds.has(wmKey)){
          const p=players.find(x=>x.name===wn);
          if(!mapData[mapName][wn])mapData[mapName][wn]={w:0,l:0,univ:p?.univ||'',tier:p?.tier||''};
          mapData[mapName][wn].w++;
        }
        if(ln&&!countedMatchIds.has(lmKey)){
          const p=players.find(x=>x.name===ln);
          if(!mapData[mapName][ln])mapData[mapName][ln]={w:0,l:0,univ:p?.univ||'',tier:p?.tier||''};
          mapData[mapName][ln].l++;
        }
      });
    });
  });

  // ë§µ ì „ì²´ í†µê³„ â€” ìŠ¹+íŒ¨ í•©ì‚° í›„ /2 (ì–‘ ì„ ìˆ˜ ëª¨ë‘ ì§‘ê³„ë˜ë¯€ë¡œ)
  const mapSummary=allMaps.map(m=>{
    const entries=Object.values(mapData[m]||{});
    const rawTotal=entries.reduce((s,v)=>s+v.w+v.l,0);
    const total=Math.round(rawTotal/2);
    return{name:m,games:total,players:Object.keys(mapData[m]||{}).length};
  }).sort((a,b)=>b.games-a.games||a.name.localeCompare(b.name,'ko'));

  const selData=Object.entries(mapData[_mapRankSelMap]||{})
    .map(([name,s])=>({name,w:s.w,l:s.l,univ:s.univ,tier:s.tier,tot:s.w+s.l,rate:s.w+s.l?Math.round(s.w/(s.w+s.l)*100):0}))
    .filter(p=>p.tot>=2)
    .sort((a,b)=>b.rate-a.rate||b.tot-a.tot);

  return`<div style="display:flex;flex-direction:column;gap:14px">
  <div class="ssec">
    <h4 style="margin-bottom:12px">ğŸ—ºï¸ ë§µë³„ ê²½ê¸° ìˆ˜ <span style="font-size:11px;color:var(--gray-l);font-weight:400">í´ë¦­í•˜ì—¬ ì„ íƒ</span></h4>
    <div style="display:flex;flex-wrap:wrap;gap:6px">
      ${mapSummary.map(m=>`
        <button onclick="_mapRankSelMap='${m.name.replace(/'/g,"\\'")}';render()"
          style="padding:6px 14px;border-radius:8px;border:2px solid ${_mapRankSelMap===m.name?'var(--blue)':'var(--border2)'};background:${_mapRankSelMap===m.name?'var(--blue-l)':'var(--white)'};font-size:12px;font-weight:${_mapRankSelMap===m.name?'700':'500'};color:${_mapRankSelMap===m.name?'var(--blue)':'var(--text3)'};cursor:pointer;transition:.12s">
          ${m.name} <span style="font-size:10px;opacity:.6">${m.games}ê²Œì„</span>
        </button>`).join('')}
    </div>
  </div>
  <div class="ssec" id="stats-maprank-sec">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
      <h4 style="margin:0">ğŸ† <span style="color:var(--blue)">${_mapRankSelMap}</span> ë§µ ê°•ì <span style="font-size:11px;color:var(--gray-l);font-weight:400">(2ê²½ê¸° ì´ìƒ)</span></h4>
    </div>
    ${selData.length===0?'<p style="color:var(--gray-l)">í•´ë‹¹ ë§µ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>':`
    <div style="overflow-x:auto"><table>
      <thead><tr><th>ìˆœìœ„</th><th>ì„ ìˆ˜</th><th>ëŒ€í•™</th><th>í‹°ì–´</th><th>ìŠ¹</th><th>íŒ¨</th><th>ìŠ¹ë¥ </th><th>ê²½ê¸°ìˆ˜</th></tr></thead>
      <tbody>
        ${selData.map((p,i)=>`<tr style="cursor:pointer" onclick="openPlayerModal('${p.name}')">
          <td>${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1}</td>
          <td style="font-weight:700;color:var(--blue)">${p.name}</td>
          <td><span class="ubadge" style="background:${gc(p.univ)}">${p.univ}</span></td>
          <td style="font-size:11px">${p.tier||'-'}</td>
          <td class="wt">${p.w}</td><td class="lt">${p.l}</td>
          <td style="font-weight:800;color:${p.rate>=50?'var(--green)':'var(--red)'}">
            ${p.rate}%
            <div style="width:48px;height:4px;background:#f1f5f9;border-radius:2px;display:inline-block;margin-left:4px;vertical-align:middle;overflow:hidden">
              <div style="width:${p.rate}%;height:100%;background:${p.rate>=50?'var(--green)':'var(--red)'};border-radius:2px"></div>
            </div>
          </td>
          <td>${p.tot}</td>
        </tr>`).join('')}
      </tbody>
    </table></div>`}
  </div></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   D. ëŒ€í•™ ê°„ ìƒëŒ€ì „ì  ë§¤íŠ¸ë¦­ìŠ¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function statsUnivMatrixHTML(){
  const univs=getAllUnivs().filter(u=>players.some(p=>p.univ===u.name));
  if(univs.length<2) return`<div class="ssec"><p style="color:var(--gray-l);padding:40px;text-align:center">ëŒ€í•™ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</p></div>`;

  // ëŒ€í•™ ê°„ ì „ì  ë§¤íŠ¸ë¦­ìŠ¤ êµ¬ì„±
  const matrix={};
  univs.forEach(a=>{ matrix[a.name]={}; univs.forEach(b=>{ matrix[a.name][b.name]={w:0,l:0}; }); });

  players.forEach(p=>{
    (p.history||[]).forEach(h=>{
      const opp=players.find(x=>x.name===h.opp);
      if(!opp||opp.univ===p.univ) return;
      if(!matrix[p.univ]||!matrix[p.univ][opp.univ]) return;
      if(h.result==='ìŠ¹') matrix[p.univ][opp.univ].w++;
      else matrix[p.univ][opp.univ].l++;
    });
  });

  // ê° ëŒ€í•™ì˜ ì´ ìŠ¹ë¥  ê³„ì‚° (ì •ë ¬ìš©)
  const univRank=univs.map(u=>{
    let w=0,l=0;
    univs.forEach(v=>{ if(u.name!==v.name){w+=matrix[u.name][v.name].w;l+=matrix[u.name][v.name].l;}});
    return{...u,w,l,rate:w+l?Math.round(w/(w+l)*100):0};
  }).sort((a,b)=>b.rate-a.rate||b.w-a.w);

  function cellBg(w,l){
    if(!w&&!l) return '#f8fafc';
    const r=w/(w+l);
    if(r>=0.6) return '#dcfce7';
    if(r>=0.5) return '#f0fdf4';
    if(r<=0.4) return '#fee2e2';
    if(r<0.5)  return '#fff5f5';
    return '#f8fafc';
  }

  return`<div class="ssec" id="stats-univmatrix-sec">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px">
      <h4 style="margin:0">ğŸ›ï¸ ëŒ€í•™ ê°„ ìƒëŒ€ì „ì  ë§¤íŠ¸ë¦­ìŠ¤</h4>
      <button class="btn-capture btn-xs no-export" onclick="captureSection('stats-univmatrix-sec','univmatrix')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
    <p style="font-size:11px;color:var(--gray-l);margin-bottom:10px">ê°€ë¡œ=ë‚˜, ì„¸ë¡œ=ìƒëŒ€ / ë…¹ìƒ‰=ìš°ì„¸ ë¹¨ê°•=ì—´ì„¸</p>
    <div style="overflow-x:auto">
    <table style="border-collapse:collapse;font-size:12px;min-width:${60+univRank.length*72}px">
      <thead><tr>
        <th style="padding:6px 10px;background:var(--surface);border:1px solid var(--border);white-space:nowrap;min-width:80px"></th>
        ${univRank.map(u=>`<th style="padding:6px 8px;background:${gc(u.name)}22;border:1px solid var(--border);white-space:nowrap;min-width:72px">
          <div style="display:flex;flex-direction:column;align-items:center;gap:2px">
            <span style="background:${gc(u.name)};color:#fff;padding:2px 7px;border-radius:4px;font-size:11px;font-weight:700">${u.name}</span>
            <span style="font-size:10px;color:${u.rate>=50?'var(--green)':'var(--red)'};font-weight:700">${u.rate}%</span>
          </div>
        </th>`).join('')}
        <th style="padding:6px 8px;background:var(--surface);border:1px solid var(--border);white-space:nowrap">ì´í•©</th>
      </tr></thead>
      <tbody>
        ${univRank.map(u=>`<tr>
          <td style="padding:6px 10px;background:${gc(u.name)}22;border:1px solid var(--border);font-weight:700;white-space:nowrap">
            <span style="background:${gc(u.name)};color:#fff;padding:2px 7px;border-radius:4px;font-size:11px">${u.name}</span>
          </td>
          ${univRank.map(v=>{
            if(u.name===v.name) return`<td style="background:#f1f5f9;border:1px solid var(--border);text-align:center;color:var(--gray-l)">-</td>`;
            const s=matrix[u.name][v.name];
            const t=s.w+s.l; if(!t) return`<td style="background:#f8fafc;border:1px solid var(--border);text-align:center;color:var(--gray-l);font-size:11px">-</td>`;
            const r=Math.round(s.w/t*100);
            return`<td style="background:${cellBg(s.w,s.l)};border:1px solid var(--border);text-align:center;padding:5px 4px">
              <div style="font-weight:800;font-size:13px;color:${r>=50?'#16a34a':'#dc2626'}">${r}%</div>
              <div style="font-size:10px;color:var(--gray-l)">${s.w}W${s.l}L</div>
            </td>`;
          }).join('')}
          <td style="background:var(--surface);border:1px solid var(--border);text-align:center;padding:5px 8px">
            <div style="font-weight:800;font-size:13px;color:${u.rate>=50?'#16a34a':'#dc2626'}">${u.rate}%</div>
            <div style="font-size:10px;color:var(--gray-l)">${u.w}W${u.l}L</div>
          </td>
        </tr>`).join('')}
      </tbody>
    </table></div>
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   E. ì¢…ì¡± í”½ë¥  íŠ¸ë Œë“œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _raceTrendMonths=12;
function statsRaceTrendHTML(){
  // ì›”ë³„ ì¢…ì¡±ë³„ ê²½ê¸° ìˆ˜ ì§‘ê³„ (ë§¤ì¹˜ sets.games + ê°œì¸ history ìŠ¹ìê¸°ì¤€ í•©ì‚°)
  const monthData={};
  function addRace(ym,race){if(!ym||ym.length!==7)return;if(!monthData[ym])monthData[ym]={T:0,Z:0,P:0,total:0};if(race&&monthData[ym][race]!==undefined){monthData[ym][race]++;monthData[ym].total++;}}
  // ë§¤ì¹˜ sets.games ì§‘ê³„
  const tourMs4=[];(tourneys||[]).forEach(tn=>(tn.groups||[]).forEach(grp=>(grp.matches||[]).forEach(m=>tourMs4.push(m))));
  const allM=[...miniM,...univM,...ckM,...comps,...proM,...tourMs4];
  allM.forEach(m=>{
    const ym=(m.d||'').slice(0,7);
    (m.sets||[]).forEach(s=>(s.games||[]).forEach(g=>{
      const pA=players.find(x=>x.name===g.playerA), pB=players.find(x=>x.name===g.playerB);
      addRace(ym,pA?.race);addRace(ym,pB?.race);
    }));
  });
  // ê°œì¸ history ì¤‘ ìœ„ ë§¤ì¹˜ì— ì—†ëŠ” ê°œì¸ì „ (matchId ê¸°ì¤€ ì¤‘ë³µ ë°©ì§€)
  const matchIdsInSets=new Set();
  allM.forEach(m=>(m.sets||[]).forEach(s=>(s.games||[]).forEach(g=>{if(g.matchId)matchIdsInSets.add(g.matchId);})));
  players.forEach(p=>{
    if(!p.race)return;
    (p.history||[]).forEach(h=>{
      if(h.result!=='ìŠ¹')return; // ìŠ¹ì ê¸°ì¤€ 1íšŒë§Œ
      if(h.matchId&&matchIdsInSets.has(h.matchId))return; // ì´ë¯¸ ì§‘ê³„ëœ ê²ƒ ì œì™¸
      const ym=(h.date||'').slice(0,7);
      const opp=players.find(x=>x.name===h.opp);
      addRace(ym,p.race);
      addRace(ym,opp?.race);
    });
  });

  const months=Object.keys(monthData).sort().slice(-_raceTrendMonths);
  if(!months.length) return`<div class="ssec"><p style="color:var(--gray-l);padding:40px;text-align:center">ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br><span style="font-size:11px">ê²½ê¸° ê¸°ë¡ì— ì„ ìˆ˜ ì •ë³´ì™€ ì¢…ì¡±ì´ ì…ë ¥ë˜ì–´ì•¼ ì§‘ê³„ë©ë‹ˆë‹¤.</span></p></div>`;

  return`<div style="display:flex;flex-direction:column;gap:14px">
  <div class="ssec" id="stats-racetrend-sec">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px">
      <h4 style="margin:0">ğŸ”¬ ì¢…ì¡± í”½ë¥  íŠ¸ë Œë“œ</h4>
      <div style="display:flex;gap:6px;align-items:center">
        <select onchange="_raceTrendMonths=parseInt(this.value);initRaceTrendChart()" style="font-size:12px;padding:4px 8px;border:1px solid var(--border2);border-radius:7px">
          <option value="6"${_raceTrendMonths===6?' selected':''}>ìµœê·¼ 6ê°œì›”</option>
          <option value="12"${_raceTrendMonths===12?' selected':''}>ìµœê·¼ 12ê°œì›”</option>
          <option value="24"${_raceTrendMonths===24?' selected':''}>ìµœê·¼ 24ê°œì›”</option>
        </select>
        <button class="btn-capture btn-xs no-export" onclick="captureSection('stats-racetrend-sec','racetrend')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
      </div>
    </div>
    <canvas id="raceTrendChart" style="width:100%;max-height:280px"></canvas>
  </div>
  <div class="ssec">
    <h4 style="margin-bottom:12px">ğŸ“Š ì›”ë³„ ì¢…ì¡± í”½ë¥  ìƒì„¸</h4>
    <div style="overflow-x:auto"><table>
      <thead><tr>
        <th>ì›”</th>
        <th style="color:#3b82f6">âš”ï¸ í…Œë€</th>
        <th style="color:#7c3aed">ğŸ¦Ÿ ì €ê·¸</th>
        <th style="color:#d97706">ğŸ”® í”„ë¡œí† ìŠ¤</th>
        <th>ì´ ê²Œì„</th>
      </tr></thead><tbody>
      ${months.slice().reverse().map(ym=>{
        const d=monthData[ym]; const t=d.total||1;
        const tr=Math.round(d.T/t*100), zr=Math.round(d.Z/t*100), pr=Math.round(d.P/t*100);
        return`<tr>
          <td style="font-weight:700;color:var(--text2)">${ym}</td>
          <td style="color:#3b82f6;font-weight:700">${tr}% <span style="color:var(--gray-l);font-size:10px">(${d.T})</span></td>
          <td style="color:#7c3aed;font-weight:700">${zr}% <span style="color:var(--gray-l);font-size:10px">(${d.Z})</span></td>
          <td style="color:#d97706;font-weight:700">${pr}% <span style="color:var(--gray-l);font-size:10px">(${d.P})</span></td>
          <td style="color:var(--gray-l)">${d.total}</td>
        </tr>`;
      }).join('')}
      </tbody>
    </table></div>
  </div></div>`;
}

function initRaceTrendChart(){
  const canvas=document.getElementById('raceTrendChart');
  if(!canvas) return;
  const monthData={};
  function addRace2(ym,race){if(!ym||ym.length!==7)return;if(!monthData[ym])monthData[ym]={T:0,Z:0,P:0,total:0};if(race&&monthData[ym][race]!==undefined){monthData[ym][race]++;monthData[ym].total++;}}
  const tourMs3=[];(tourneys||[]).forEach(tn=>(tn.groups||[]).forEach(grp=>(grp.matches||[]).forEach(m=>tourMs3.push(m))));
  const allM=[...miniM,...univM,...ckM,...comps,...proM,...tourMs3];
  allM.forEach(m=>{
    const ym=(m.d||'').slice(0,7);
    (m.sets||[]).forEach(s=>(s.games||[]).forEach(g=>{
      const pA=players.find(x=>x.name===g.playerA),pB=players.find(x=>x.name===g.playerB);
      addRace2(ym,pA?.race);addRace2(ym,pB?.race);
    }));
  });
  const matchIdsInSets2=new Set();
  allM.forEach(m=>(m.sets||[]).forEach(s=>(s.games||[]).forEach(g=>{if(g.matchId)matchIdsInSets2.add(g.matchId);})));
  players.forEach(p=>{
    if(!p.race)return;
    (p.history||[]).forEach(h=>{
      if(h.result!=='ìŠ¹')return;
      if(h.matchId&&matchIdsInSets2.has(h.matchId))return;
      const ym=(h.date||'').slice(0,7);
      const opp=players.find(x=>x.name===h.opp);
      addRace2(ym,p.race);addRace2(ym,opp?.race);
    });
  });
  const months=Object.keys(monthData).sort().slice(-_raceTrendMonths);
  if(!months.length){canvas.style.display='none';return;}
  canvas.style.display='block';
  const ctx=canvas.getContext('2d');
  const W=canvas.offsetWidth||600, H=240;
  canvas.width=W; canvas.height=H;
  const pad={t:20,r:20,b:40,l:40};
  const n=months.length;
  const races=[{k:'T',color:'#3b82f6',label:'í…Œë€'},{k:'Z',color:'#7c3aed',label:'ì €ê·¸'},{k:'P',color:'#d97706',label:'í”„ë¡œí† ìŠ¤'}];

  ctx.clearRect(0,0,W,H);
  // ê·¸ë¦¬ë“œ
  ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1;
  [0,25,50,75,100].forEach(v=>{
    const y=pad.t+(1-v/100)*(H-pad.t-pad.b);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
    ctx.fillStyle='#94a3b8';ctx.font='10px sans-serif';ctx.textAlign='right';
    ctx.fillText(v+'%',pad.l-4,y+4);
  });

  // ê° ì¢…ì¡± êº¾ì€ì„ 
  races.forEach(race=>{
    const pts=months.map((ym,i)=>{
      const d=monthData[ym]; const t=d.total||1;
      const r=d[race.k]/t*100;
      return{x:pad.l+i/(n-1||1)*(W-pad.l-pad.r), y:pad.t+(1-r/100)*(H-pad.t-pad.b)};
    });
    // ê·¸ë¼ë””ì–¸íŠ¸ ì±„ìš°ê¸°
    const grad=ctx.createLinearGradient(0,pad.t,0,H-pad.b);
    grad.addColorStop(0,race.color+'44'); grad.addColorStop(1,race.color+'08');
    ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y);
    pts.forEach(p=>ctx.lineTo(p.x,p.y));
    ctx.lineTo(pts[pts.length-1].x,H-pad.b); ctx.lineTo(pts[0].x,H-pad.b);
    ctx.closePath(); ctx.fillStyle=grad; ctx.fill();
    // ì„ 
    ctx.beginPath(); ctx.strokeStyle=race.color; ctx.lineWidth=2.5;
    ctx.moveTo(pts[0].x,pts[0].y); pts.forEach(p=>ctx.lineTo(p.x,p.y)); ctx.stroke();
    // ì 
    pts.forEach(pt=>{
      ctx.beginPath(); ctx.arc(pt.x,pt.y,3.5,0,Math.PI*2);
      ctx.fillStyle=race.color; ctx.fill();
      ctx.strokeStyle='#fff'; ctx.lineWidth=1.5; ctx.stroke();
    });
  });

  // Xì¶• ë ˆì´ë¸”
  ctx.fillStyle='#64748b'; ctx.font='10px sans-serif'; ctx.textAlign='center';
  months.forEach((ym,i)=>{
    if(n<=12||i%2===0){
      const x=pad.l+i/(n-1||1)*(W-pad.l-pad.r);
      ctx.fillText(ym.slice(5),x,H-pad.b+14);
    }
  });

  // ë²”ë¡€
  let lx=pad.l;
  races.forEach(race=>{
    ctx.fillStyle=race.color; ctx.fillRect(lx,H-12,12,8);
    ctx.fillStyle='#475569'; ctx.font='10px sans-serif'; ctx.textAlign='left';
    ctx.fillText(race.label,lx+16,H-4);
    lx+=60;
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEW-1. í‚¬ëŸ¬ ì„ ìˆ˜ / í”¼í•´ì ì„ ìˆ˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _killerSelPlayer='';
function statsKillerHTML(){
  const playersWithHistory=players.filter(p=>(p.history||[]).length>0);
  if(!_killerSelPlayer&&playersWithHistory.length)_killerSelPlayer=playersWithHistory[0].name;
  const univs=getAllUnivs();

  function calcKiller(targetName){
    const target=players.find(p=>p.name===targetName);
    if(!target)return{killers:[],victims:[]};
    const oppMap={};
    (target.history||[]).forEach(h=>{
      if(!h.opp)return;
      if(!oppMap[h.opp])oppMap[h.opp]={w:0,l:0};
      if(h.result==='ìŠ¹')oppMap[h.opp].w++;
      else oppMap[h.opp].l++;
    });
    const entries=Object.entries(oppMap).map(([name,s])=>{
      const opp=players.find(p=>p.name===name);
      return{name,w:s.w,l:s.l,tot:s.w+s.l,
        winRate:s.w+s.l?Math.round(s.w/(s.w+s.l)*100):0,
        univ:opp?.univ||'',elo:opp?.elo||1200};
    }).filter(e=>e.tot>=1);
    const killers=entries.filter(e=>e.l>0).sort((a,b)=>{
      const aLR=a.l/(a.w+a.l), bLR=b.l/(b.w+b.l);
      return bLR-aLR||b.l-a.l;
    }).slice(0,10);
    const victims=entries.filter(e=>e.w>0).sort((a,b)=>{
      const aWR=a.w/(a.w+a.l), bWR=b.w/(b.w+b.l);
      return bWR-aWR||b.w-a.w;
    }).slice(0,10);
    return{killers,victims};
  }

  const target=players.find(p=>p.name===_killerSelPlayer);
  const {killers,victims}=calcKiller(_killerSelPlayer);
  const tColor=gc(target?.univ||'');

  function oppRow(e,isKiller){
    const col=gc(e.univ);
    const myW=isKiller?e.l:e.w, myL=isKiller?e.w:e.l;
    const myRate=e.tot?Math.round(myW/e.tot*100):0;
    return`<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--white);border:1px solid var(--border);border-radius:8px;cursor:pointer" onclick="openPlayerModal('${e.name}')">
      ${getPlayerPhotoHTML(e.name,'28px')}
      <span style="font-weight:800;font-size:13px;color:var(--blue);min-width:65px">${e.name}${getStatusIconHTML(e.name)}</span>
      <span style="font-size:11px;color:${col};font-weight:700;min-width:55px">${e.univ}</span>
      <div style="flex:1;background:#f1f5f9;border-radius:20px;height:10px;overflow:hidden">
        <div style="width:${myRate}%;background:${isKiller?'var(--red)':'var(--green)'};height:100%;border-radius:20px"></div>
      </div>
      <span style="font-weight:800;font-size:12px;color:${isKiller?'var(--red)':'var(--green)'};white-space:nowrap;min-width:52px">${myRate}% (${myW}W${myL}L)</span>
      <span style="font-size:10px;color:var(--gray-l)">${e.tot}ê²½ê¸°</span>
    </div>`;
  }

  return`<div style="display:flex;flex-direction:column;gap:14px">
  <div class="ssec">
    <h4 style="margin-bottom:12px">ğŸ—¡ï¸ í‚¬ëŸ¬ & í”¼í•´ì ì„ ìˆ˜</h4>
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:14px">
      <span style="font-size:12px;font-weight:600;color:var(--text3)">ì„ ìˆ˜ ì„ íƒ:</span>
      <select style="padding:6px 12px;border:1.5px solid var(--border2);border-radius:8px;font-size:13px;font-weight:600"
        onchange="_killerSelPlayer=this.value;render()">
        ${playersWithHistory.sort((a,b)=>a.name.localeCompare(b.name,'ko')).map(p=>
          `<option value="${p.name}"${_killerSelPlayer===p.name?' selected':''}>${p.name} (${p.univ})</option>`
        ).join('')}
      </select>
      ${target?`<span class="ubadge" style="background:${tColor}">${target.univ}</span>
      <span style="font-size:12px;color:var(--gray-l)">${target.win||0}ìŠ¹ ${target.loss||0}íŒ¨</span>`:''}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;flex-wrap:wrap">
      <div>
        <div style="font-weight:800;font-size:14px;color:var(--red);margin-bottom:8px;padding:8px 12px;background:#fef2f2;border-radius:8px;border-left:4px solid var(--red)">
          ğŸ’€ ë‚˜ë¥¼ ê°€ì¥ ë§ì´ ì´ê¸´ ì„ ìˆ˜ (ì²œì )
        </div>
        <div style="display:flex;flex-direction:column;gap:4px">
          ${killers.length?killers.map(e=>oppRow(e,true)).join(''):'<p style="color:var(--gray-l);padding:16px;text-align:center">ì²œì  ì—†ìŒ ğŸ‘‘</p>'}
        </div>
      </div>
      <div>
        <div style="font-weight:800;font-size:14px;color:var(--green);margin-bottom:8px;padding:8px 12px;background:#f0fdf4;border-radius:8px;border-left:4px solid var(--green)">
          ğŸ† ë‚´ê°€ ê°€ì¥ ë§ì´ ì´ê¸´ ì„ ìˆ˜ (í”¼í•´ì)
        </div>
        <div style="display:flex;flex-direction:column;gap:4px">
          ${victims.length?victims.map(e=>oppRow(e,false)).join(''):'<p style="color:var(--gray-l);padding:16px;text-align:center">í”¼í•´ì ì—†ìŒ</p>'}
        </div>
      </div>
    </div>
  </div>
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEW-2. ìš”ì¼ / ì‹œì¦Œë³„ ìŠ¹ë¥ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _seasonalFilter={gender:'',univ:'',race:''};
function statsSeasonalHTML(){
  const f=_seasonalFilter;
  const univs=getAllUnivs();
  const dayNames=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  const dayStats=Array.from({length:7},(_,i)=>({day:dayNames[i],w:0,l:0}));
  const monthStats={};

  players.filter(p=>{
    if(f.gender&&p.gender!==f.gender)return false;
    if(f.univ&&p.univ!==f.univ)return false;
    if(f.race&&p.race!==f.race)return false;
    return true;
  }).forEach(p=>{
    (p.history||[]).forEach(h=>{
      if(!h.date)return;
      const d=new Date(h.date);
      if(isNaN(d.getTime()))return;
      const dow=d.getDay();
      const ym=h.date.slice(0,7);
      if(!monthStats[ym])monthStats[ym]={w:0,l:0};
      if(h.result==='ìŠ¹'){dayStats[dow].w++;monthStats[ym].w++;}
      else{dayStats[dow].l++;monthStats[ym].l++;}
    });
  });

  const maxDay=Math.max(...dayStats.map(d=>d.w+d.l),1);
  const sortedMonths=Object.entries(monthStats).sort((a,b)=>a[0].localeCompare(b[0]));
  const maxMonth=Math.max(...sortedMonths.map(([,s])=>s.w+s.l),1);

  function dayColor(rate){
    if(rate>=60)return'#16a34a';if(rate>=50)return'#2563eb';if(rate>=40)return'#d97706';return'#dc2626';
  }

  return`<div style="display:flex;flex-direction:column;gap:14px">
  <div class="ssec">
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:12px">
      <h4 style="margin:0">ğŸ“… ìš”ì¼ / ì‹œì¦Œë³„ ìŠ¹ë¥ </h4>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-left:auto">
        <select onchange="_seasonalFilter.gender=this.value;render()" style="font-size:12px;padding:4px 8px;border:1px solid var(--border2);border-radius:7px">
          <option value="">ì„±ë³„ ì „ì²´</option>
          <option value="M"${f.gender==='M'?' selected':''}>ğŸ‘¨ ë‚¨ì</option>
          <option value="F"${f.gender==='F'?' selected':''}>ğŸ‘© ì—¬ì</option>
        </select>
        <select onchange="_seasonalFilter.univ=this.value;render()" style="font-size:12px;padding:4px 8px;border:1px solid var(--border2);border-radius:7px">
          <option value="">ëŒ€í•™ ì „ì²´</option>
          ${univs.map(u=>`<option value="${u.name}"${f.univ===u.name?' selected':''}>${u.name}</option>`).join('')}
        </select>
        <select onchange="_seasonalFilter.race=this.value;render()" style="font-size:12px;padding:4px 8px;border:1px solid var(--border2);border-radius:7px">
          <option value="">ì¢…ì¡± ì „ì²´</option>
          <option value="T"${f.race==='T'?' selected':''}>í…Œë€</option>
          <option value="Z"${f.race==='Z'?' selected':''}>ì €ê·¸</option>
          <option value="P"${f.race==='P'?' selected':''}>í”„ë¡œí† ìŠ¤</option>
        </select>
        <button class="btn btn-w btn-sm" onclick="_seasonalFilter={gender:'',univ:'',race:''};render()">ì´ˆê¸°í™”</button>
      </div>
    </div>
    <h4 style="font-size:13px;margin-bottom:10px">ğŸ—“ï¸ ìš”ì¼ë³„ ìŠ¹ë¥ </h4>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px">
      ${dayStats.map((d,i)=>{
        const tot=d.w+d.l;const rate=tot?Math.round(d.w/tot*100):0;
        const col=dayColor(rate);const barH=tot?Math.round((tot/maxDay)*80)+20:0;
        const isWeekend=i===0||i===6;
        return`<div style="flex:1;min-width:70px;text-align:center;background:${isWeekend?'#fef3c7':'var(--white)'};border:1px solid var(--border);border-radius:10px;padding:12px 8px">
          <div style="font-weight:800;font-size:15px;color:${isWeekend?'var(--gold)':'var(--text)'};margin-bottom:4px">${d.day}</div>
          <div style="font-size:22px;font-weight:900;color:${col};margin-bottom:2px">${tot?rate+'%':'-'}</div>
          <div style="height:4px;background:#f1f5f9;border-radius:2px;overflow:hidden;margin:4px 0">
            <div style="width:${rate}%;background:${col};height:100%;border-radius:2px"></div>
          </div>
          <div style="font-size:10px;color:var(--gray-l)">${d.w}ìŠ¹ ${d.l}íŒ¨</div>
        </div>`;
      }).join('')}
    </div>
    <h4 style="font-size:13px;margin-bottom:10px">ğŸ“† ì›”ë³„ ìŠ¹ë¥  ì¶”ì´</h4>
    ${sortedMonths.length===0?'<p style="color:var(--gray-l)">ê¸°ë¡ ì—†ìŒ</p>':`
    <div style="overflow-x:auto">
      <div style="display:flex;align-items:flex-end;gap:6px;min-width:${sortedMonths.length*56}px;height:120px;padding-bottom:22px;position:relative">
        ${sortedMonths.map(([ym,s])=>{
          const tot=s.w+s.l;const rate=tot?Math.round(s.w/tot*100):0;
          const col=dayColor(rate);
          const barH=tot?Math.round((tot/maxMonth)*80)+10:4;
          return`<div style="display:flex;flex-direction:column;align-items:center;flex:1;min-width:48px;position:relative">
            <span style="font-size:9px;color:${col};font-weight:800;margin-bottom:2px">${rate}%</span>
            <div style="width:100%;height:${barH}px;background:${col};border-radius:4px 4px 0 0;opacity:.8;min-height:4px"></div>
            <span style="font-size:9px;color:var(--gray-l);margin-top:3px;white-space:nowrap">${ym.slice(2)}</span>
            <span style="font-size:9px;color:var(--gray-l)">${s.w}W${s.l}L</span>
          </div>`;
        }).join('')}
      </div>
    </div>`}
  </div></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEW-3. í´ëŸ¬ì¹˜ ì§€ìˆ˜ (ì—ì´ìŠ¤ì „ ìŠ¹ë¥ )
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function statsClutchHTML(){
  // ì—ì´ìŠ¤ ì„¸íŠ¸(ace:true) ì˜ ê²Œì„ì—ì„œ í”Œë ˆì´í•œ ì„ ìˆ˜ë“¤ì˜ ìŠ¹ë¥ 
  const aceStats={};
  const allMatchSets=[...miniM,...univM,...ckM,...comps,...proM];
  allMatchSets.forEach(m=>{
    (m.sets||[]).forEach(set=>{
      if(!set.ace)return; // ace ì„¸íŠ¸ë§Œ
      (set.games||[]).forEach(g=>{
        if(!g.playerA||!g.playerB||!g.winner)return;
        const wName=g.winner==='A'?g.playerA:g.playerB;
        const lName=g.winner==='A'?g.playerB:g.playerA;
        if(!aceStats[wName])aceStats[wName]={w:0,l:0};
        if(!aceStats[lName])aceStats[lName]={w:0,l:0};
        aceStats[wName].w++;
        aceStats[lName].l++;
      });
    });
  });

  // historyì—ì„œë„ ace ê²½ê¸° ì¶”ì  (matchTypeì´ë‚˜ ë©”ëª¨ ê¸°ë°˜ì€ ì—†ìœ¼ë‹ˆ ì„¸íŠ¸ ê¸°ë°˜ë§Œ ì‚¬ìš©)
  const aceList=Object.entries(aceStats).map(([name,s])=>{
    const p=players.find(x=>x.name===name);
    if(!p)return null;
    const tot=s.w+s.l;
    const rate=tot?Math.round(s.w/tot*100):0;
    return{name,w:s.w,l:s.l,tot,rate,univ:p.univ,tier:p.tier,elo:p.elo||1200,
      totalGames:(p.win||0)+(p.loss||0),
      clutchRatio:tot>0?(s.w/tot-0.5)*2:0
    };
  }).filter(Boolean).filter(e=>e.tot>=1).sort((a,b)=>b.rate-a.rate||b.tot-a.tot);

  const topClutch=aceList.slice(0,15);
  const worstClutch=[...aceList].filter(e=>e.tot>=2).sort((a,b)=>a.rate-b.rate||b.tot-a.tot).slice(0,10);

  function clutchRow(e,i){
    const col=gc(e.univ);
    const rateCol=e.rate>=60?'#7c3aed':e.rate>=50?'var(--green)':e.rate>=40?'var(--gold)':'var(--red)';
    const badge=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`${i+1}`;
    return`<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--white);border:1px solid var(--border);border-radius:8px;cursor:pointer" onclick="openPlayerModal('${e.name}')">
      <span style="min-width:24px;font-size:15px">${badge}</span>
      <span style="font-weight:800;font-size:13px;color:var(--blue);min-width:65px">${e.name}</span>
      <span style="font-size:11px;color:${col};font-weight:700;min-width:55px">${e.univ}</span>
      <div style="flex:1;background:#f1f5f9;border-radius:20px;height:10px;overflow:hidden">
        <div style="width:${e.rate}%;background:${rateCol};height:100%;border-radius:20px"></div>
      </div>
      <span style="font-weight:900;font-size:14px;color:${rateCol};min-width:40px;text-align:right">${e.rate}%</span>
      <span style="font-size:11px;color:var(--gray-l)">${e.w}W ${e.l}L (${e.tot}ê²½ê¸°)</span>
    </div>`;
  }

  const totalAceGames=aceList.reduce((s,e)=>s+e.tot,0)/2;

  return`<div style="display:flex;flex-direction:column;gap:14px">
  <div class="ssec">
    <h4 style="margin-bottom:6px">âš¡ í´ëŸ¬ì¹˜ ì§€ìˆ˜ <span style="font-size:11px;color:var(--gray-l);font-weight:400">ì—ì´ìŠ¤ ê²°ì •ì „ / íƒ€ì´ë¸Œë ˆì´ì»¤ ìŠ¹ë¥ </span></h4>
    <p style="font-size:12px;color:var(--gray-l);margin-bottom:14px">ì´ ì—ì´ìŠ¤ì „: ${Math.round(totalAceGames)}ê²½ê¸° Â· ê²½ê¸° ì…ë ¥ ì‹œ ì„¸íŠ¸ì— <b>ACE</b> í‘œì‹œëœ ê²½ê¸°ë§Œ ì§‘ê³„ë©ë‹ˆë‹¤</p>
    ${aceList.length===0?'<p style="color:var(--gray-l);padding:40px;text-align:center">ì—ì´ìŠ¤ì „ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br><span style="font-size:11px">ê²½ê¸° ì…ë ¥ ì‹œ ì„¸íŠ¸ ì„¤ì •ì—ì„œ ACE ì„¸íŠ¸ë¡œ ì§€ì •í•´ ì£¼ì„¸ìš”.</span></p>':`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div>
        <div style="font-weight:800;font-size:13px;color:#7c3aed;margin-bottom:8px;padding:7px 12px;background:#f5f3ff;border-radius:8px;border-left:4px solid #7c3aed">ğŸ¯ í´ëŸ¬ì¹˜ í‚¹ TOP 10</div>
        <div style="display:flex;flex-direction:column;gap:4px">${topClutch.slice(0,10).map(clutchRow).join('')}</div>
      </div>
      <div>
        <div style="font-weight:800;font-size:13px;color:var(--red);margin-bottom:8px;padding:7px 12px;background:#fef2f2;border-radius:8px;border-left:4px solid var(--red)">ğŸ’§ ì—ì´ìŠ¤ì „ ì•½ì TOP 10</div>
        <div style="display:flex;flex-direction:column;gap:4px">${worstClutch.map(clutchRow).join('')}</div>
      </div>
    </div>`}
  </div></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEW-4. ì—­ëŒ€ ìµœì¥ ì—°ìŠ¹/ì—°íŒ¨ ê¸°ë¡ íˆìŠ¤í† ë¦¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function statsStreakHistHTML(){
  const allStreaks=[];
  players.forEach(p=>{
    const hist=[...(p.history||[])].sort((a,b)=>(a.date||'').localeCompare(b.date||''));
    if(!hist.length)return;
    let cur=0, curType='', startDate='', endDate='';
    hist.forEach((h,i)=>{
      if(h.result===curType){
        cur++;endDate=h.date||endDate;
      }else{
        if(cur>=3){
          allStreaks.push({name:p.name,univ:p.univ,type:curType,n:cur,start:startDate,end:endDate,elo:p.elo||1200});
        }
        cur=1;curType=h.result;startDate=h.date||'';endDate=h.date||'';
      }
      if(i===hist.length-1&&cur>=3){
        allStreaks.push({name:p.name,univ:p.univ,type:curType,n:cur,start:startDate,end:endDate,elo:p.elo||1200,current:true});
      }
    });
  });

  const winStreaks=allStreaks.filter(s=>s.type==='ìŠ¹').sort((a,b)=>b.n-a.n).slice(0,15);
  const loseStreaks=allStreaks.filter(s=>s.type==='íŒ¨').sort((a,b)=>b.n-a.n).slice(0,15);

  function streakRow(s,i){
    const col=gc(s.univ);
    const isWin=s.type==='ìŠ¹';
    const badge=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`${i+1}`;
    return`<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--white);border:1px solid var(--border);border-radius:8px;cursor:pointer;${s.current?'border-color:'+( isWin?'#16a34a':'#dc2626')+';box-shadow:0 0 0 2px '+(isWin?'#dcfce7':'#fee2e2'):''}" onclick="openPlayerModal('${s.name}')">
      <span style="min-width:24px;font-size:15px">${badge}</span>
      <span style="font-weight:900;font-size:20px;color:${isWin?'var(--green)':'var(--red)'};min-width:48px">${s.n}</span>
      <div style="flex:1;min-width:0">
        <div style="font-weight:800;font-size:13px">${s.name} <span style="font-size:10px;color:${col};font-weight:600">${s.univ}</span>
          ${s.current?`<span style="font-size:10px;background:${isWin?'#dcfce7':'#fee2e2'};color:${isWin?'#16a34a':'#dc2626'};padding:1px 6px;border-radius:4px;font-weight:700;margin-left:4px">ì§„í–‰ì¤‘</span>`:''}
        </div>
        <div style="font-size:10px;color:var(--gray-l)">${s.start}${s.end&&s.end!==s.start?' ~ '+s.end:''}</div>
      </div>
      <span style="font-weight:800;font-size:13px;color:${isWin?'var(--green)':'var(--red)'};white-space:nowrap">ì—°${isWin?'ìŠ¹':'íŒ¨'}</span>
    </div>`;
  }

  return`<div style="display:flex;flex-direction:column;gap:14px">
  <div class="ssec">
    <h4 style="margin-bottom:14px">ğŸ”¥ ì—­ëŒ€ ì—°ì† ê¸°ë¡ íˆìŠ¤í† ë¦¬ <span style="font-size:11px;color:var(--gray-l);font-weight:400">(3ì—°ì† ì´ìƒ)</span></h4>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div>
        <div style="font-weight:800;font-size:13px;color:var(--green);margin-bottom:8px;padding:7px 12px;background:#f0fdf4;border-radius:8px;border-left:4px solid var(--green)">
          ğŸ† ì—­ëŒ€ ìµœì¥ ì—°ìŠ¹ TOP 15
        </div>
        <div style="display:flex;flex-direction:column;gap:4px">
          ${winStreaks.length?winStreaks.map(streakRow).join(''):'<p style="color:var(--gray-l);padding:16px;text-align:center">ê¸°ë¡ ì—†ìŒ</p>'}
        </div>
      </div>
      <div>
        <div style="font-weight:800;font-size:13px;color:var(--red);margin-bottom:8px;padding:7px 12px;background:#fef2f2;border-radius:8px;border-left:4px solid var(--red)">
          â„ï¸ ì—­ëŒ€ ìµœì¥ ì—°íŒ¨ TOP 15
        </div>
        <div style="display:flex;flex-direction:column;gap:4px">
          ${loseStreaks.length?loseStreaks.map(streakRow).join(''):'<p style="color:var(--gray-l);padding:16px;text-align:center">ê¸°ë¡ ì—†ìŒ</p>'}
        </div>
      </div>
    </div>
  </div></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEW-5. í‹°ì–´ë³„ ìŠ¹ë¥  (ìƒëŒ€ í‹°ì–´ ê¸°ì¤€ ë§¤íŠ¸ë¦­ìŠ¤)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function statsTierMatchHTML(){
  // ì‹¤ì œ TIERS ë°°ì—´ ê¸°ë°˜ (G, K, JA, J, S, ìœ ìŠ¤, ìˆ«ìí‹°ì–´ ë“±)
  const TIER_PALETTE=['#7c3aed','#dc2626','#2563eb','#16a34a','#0f172a','#0891b2','#d97706','#64748b','#9f1239','#065f46','#1e3a8a','#713f12','#3f3f46','#7c2d12','#166534'];
  // ì‹¤ì œ ì‚¬ìš©ëœ í‹°ì–´ë§Œ ì¶”ì¶œ (ëª¨ë“  ì„ ìˆ˜ì˜ tier ì¤‘ ì‹¤ì œ ë°ì´í„° ìˆëŠ” ê²ƒ)
  const usedTiers=[...new Set(players.map(p=>p.tier).filter(Boolean))].sort((a,b)=>TIERS.indexOf(a)-TIERS.indexOf(b));
  if(!usedTiers.length)return`<div class="ssec"><p style="color:var(--gray-l);padding:40px;text-align:center">í‹°ì–´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;

  const tierColor={};
  usedTiers.forEach((t,i)=>{
    const presets={G:'#091540',K:'#102058',JA:'#182d80',J:'#2040a8',S:'#2d52c8',
      '0í‹°ì–´':'#3860d8',
      '1í‹°ì–´':'#4070e0','2í‹°ì–´':'#5888f0','3í‹°ì–´':'#6e9ef8','4í‹°ì–´':'#84b4ff',
      '5í‹°ì–´':'#9ecaff','6í‹°ì–´':'#b2dcff','7í‹°ì–´':'#c6ecff','8í‹°ì–´':'#d8f4ff','ìœ ìŠ¤':'#fbbf24'};
    tierColor[t]=presets[t]||TIER_PALETTE[i%TIER_PALETTE.length];
  });

  // ëª¨ë“  íˆìŠ¤í† ë¦¬ í¬í•¨ (í”„ë¡œë¦¬ê·¸ í¬í•¨, ë‚¨ì í¬í•¨)
  const matrix={};
  usedTiers.forEach(t1=>{matrix[t1]={};usedTiers.forEach(t2=>{matrix[t1][t2]={w:0,l:0};});});

  players.forEach(p=>{
    const myTier=p.tier||'';
    if(!myTier||!matrix[myTier])return;
    (p.history||[]).forEach(h=>{
      const opp=players.find(x=>x.name===h.opp);
      const oppTier=opp?.tier||'';
      if(!oppTier||!matrix[myTier][oppTier])return;
      if(h.result==='ìŠ¹')matrix[myTier][oppTier].w++;
      else matrix[myTier][oppTier].l++;
    });
  });

  const tierOverview=usedTiers.map(t=>{
    let w=0,l=0;
    usedTiers.forEach(t2=>{w+=matrix[t][t2].w;l+=matrix[t][t2].l;});
    return{tier:t,w,l,rate:w+l?Math.round(w/(w+l)*100):null};
  }).filter(t=>t.w+t.l>0); // ê²½ê¸° ì—†ëŠ” í‹°ì–´ ì œì™¸

  const activeTiers=usedTiers.filter(t=>tierOverview.some(ov=>ov.tier===t));

  function cellStyle(w,l){
    if(!w&&!l)return'background:#f8fafc;color:#94a3b8';
    const r=w/(w+l);
    if(r>=0.65)return'background:#dcfce7;color:#16a34a';
    if(r>=0.5)return'background:#f0fdf4;color:#16a34a';
    if(r<=0.35)return'background:#fee2e2;color:#dc2626';
    if(r<0.5)return'background:#fff5f5;color:#dc2626';
    return'background:#f8fafc;color:#374151';
  }

  if(!activeTiers.length)return`<div class="ssec"><p style="color:var(--gray-l);padding:40px;text-align:center">í‹°ì–´ ê°„ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br><span style="font-size:11px">ì„ ìˆ˜ì— í‹°ì–´ê°€ ì„¤ì •ë˜ê³  ê²½ê¸° ê¸°ë¡ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</span></p></div>`;

  return`<div style="display:flex;flex-direction:column;gap:14px">
  <div class="ssec">
    <h4 style="margin-bottom:6px">ğŸ–ï¸ í‹°ì–´ ê°„ ìƒëŒ€ì „ì  ë§¤íŠ¸ë¦­ìŠ¤ <span style="font-size:11px;color:var(--gray-l);font-weight:400">ì „ ê²½ê¸° í¬í•¨ (í”„ë¡œë¦¬ê·¸Â·ë‚¨ì í¬í•¨)</span></h4>
    <p style="font-size:11px;color:var(--gray-l);margin-bottom:12px">ê°€ë¡œ=ë‚´ í‹°ì–´ / ì„¸ë¡œ=ìƒëŒ€ í‹°ì–´ / ë…¹ìƒ‰=ìš°ì„¸ ë¹¨ê°•=ì—´ì„¸</p>
    <div style="overflow-x:auto">
    <table style="border-collapse:collapse;font-size:12px;min-width:${100+activeTiers.length*72}px">
      <thead><tr>
        <th style="padding:8px 12px;background:var(--surface);border:1px solid var(--border);white-space:nowrap">ë‚´â†“ / ìƒëŒ€â†’</th>
        ${activeTiers.map(t=>`<th style="padding:6px 8px;background:${tierColor[t]}22;border:1px solid var(--border);white-space:nowrap;min-width:72px">
          <span style="background:${tierColor[t]};color:#fff;padding:2px 7px;border-radius:4px;font-size:11px;font-weight:700">${getTierLabel(t)}</span>
        </th>`).join('')}
        <th style="padding:6px 8px;background:var(--surface);border:1px solid var(--border);white-space:nowrap">ì „ì²´</th>
      </tr></thead>
      <tbody>
        ${activeTiers.map(t1=>{
          const ov=tierOverview.find(x=>x.tier===t1);
          return`<tr>
            <td style="padding:6px 10px;background:${tierColor[t1]}22;border:1px solid var(--border);font-weight:700;white-space:nowrap">
              <span style="background:${tierColor[t1]};color:#fff;padding:2px 7px;border-radius:4px;font-size:11px">${getTierLabel(t1)}</span>
            </td>
            ${activeTiers.map(t2=>{
              if(t1===t2){
                const s=matrix[t1][t2];const tot=s.w+s.l;
                const r=tot?Math.round(s.w/tot*100):null;
                return`<td style="padding:6px 8px;border:1px solid var(--border);text-align:center;background:#f1f5f9">
                  <div style="font-size:9px;color:var(--gray-l);font-weight:600">ë™í‹°ì–´</div>
                  ${tot?`<div style="font-weight:800;font-size:12px;color:${r>=50?'var(--green)':'var(--red)'}">${r}%</div>
                  <div style="font-size:10px;color:var(--gray-l)">${s.w}W${s.l}L</div>`:'<div style="color:var(--gray-l);font-size:11px">-</div>'}
                </td>`;
              }
              const s=matrix[t1][t2];const tot=s.w+s.l;
              const r=tot?Math.round(s.w/tot*100):null;
              const cs=cellStyle(s.w,s.l);
              return`<td style="padding:5px 6px;border:1px solid var(--border);text-align:center;${cs}">
                ${tot?`<div style="font-weight:800;font-size:12px">${r}%</div>
                <div style="font-size:10px;opacity:.7">${s.w}W${s.l}L</div>`:'<span style="color:#94a3b8;font-size:11px">-</span>'}
              </td>`;
            }).join('')}
            <td style="padding:5px 8px;border:1px solid var(--border);text-align:center;background:var(--surface)">
              ${ov&&ov.rate!==null?`<div style="font-weight:800;font-size:12px;color:${ov.rate>=50?'var(--green)':'var(--red)'}">${ov.rate}%</div>
              <div style="font-size:10px;color:var(--gray-l)">${ov.w}W${ov.l}L</div>`:'<span style="color:var(--gray-l)">-</span>'}
            </td>
          </tr>`;
        }).join('')}
      </tbody>
    </table></div>
  </div>
  <div class="ssec">
    <h4 style="margin-bottom:12px">ğŸ“Š í‹°ì–´ë³„ ì „ì²´ ìŠ¹ë¥  ìš”ì•½</h4>
    <div style="display:flex;flex-wrap:wrap;gap:10px">
      ${tierOverview.map(t=>{
        const col=tierColor[t.tier]||'#6b7280';
        const tot=t.w+t.l;
        return`<div style="flex:1;min-width:90px;background:var(--white);border:2px solid ${col}33;border-radius:12px;padding:12px;text-align:center">
          <div style="background:${col};color:#fff;padding:2px 9px;border-radius:5px;font-weight:800;font-size:12px;display:inline-block;margin-bottom:6px">${getTierLabel(t.tier)}</div>
          <div style="font-size:24px;font-weight:900;color:${col}">${t.rate!==null?t.rate+'%':'-'}</div>
          <div style="font-size:10px;color:var(--gray-l);margin-top:3px">${t.w}ìŠ¹ ${t.l}íŒ¨</div>
          ${tot?`<div style="height:4px;background:#f1f5f9;border-radius:2px;overflow:hidden;margin-top:5px">
            <div style="width:${t.rate||0}%;background:${col};height:100%;border-radius:2px"></div>
          </div>`:''}
        </div>`;
      }).join('')}
    </div>
  </div></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEW-6. ëŒ€í•™ ê°„ ìƒëŒ€ì „ì  ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„¸ (+ ì„ ìˆ˜ë³„ ë“œë¦´ë‹¤ìš´)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _matrix2Sel={a:'',b:''};
function statsUnivMatrix2HTML(){
  const univs=getAllUnivs().filter(u=>players.some(p=>p.univ===u.name));
  if(univs.length<2)return`<div class="ssec"><p style="color:var(--gray-l)">ëŒ€í•™ ë°ì´í„° ë¶€ì¡±</p></div>`;

  const matrix={};
  const playerMatrix={}; // playerMatrix[univA][univB]={playerA:{vs_playerB:{w,l}}}
  univs.forEach(a=>{
    matrix[a.name]={};
    playerMatrix[a.name]={};
    univs.forEach(b=>{
      matrix[a.name][b.name]={w:0,l:0};
      playerMatrix[a.name][b.name]={};
    });
  });

  players.forEach(p=>{
    (p.history||[]).forEach(h=>{
      const opp=players.find(x=>x.name===h.opp);
      if(!opp||opp.univ===p.univ)return;
      if(!matrix[p.univ]||!matrix[p.univ][opp.univ])return;
      if(h.result==='ìŠ¹')matrix[p.univ][opp.univ].w++;
      else matrix[p.univ][opp.univ].l++;
      // ì„ ìˆ˜ë³„ ë§¤íŠ¸ë¦­ìŠ¤
      if(!playerMatrix[p.univ][opp.univ][p.name])playerMatrix[p.univ][opp.univ][p.name]={};
      if(!playerMatrix[p.univ][opp.univ][p.name][opp.name])playerMatrix[p.univ][opp.univ][p.name][opp.name]={w:0,l:0};
      if(h.result==='ìŠ¹')playerMatrix[p.univ][opp.univ][p.name][opp.name].w++;
      else playerMatrix[p.univ][opp.univ][p.name][opp.name].l++;
    });
  });

  const univRank=univs.map(u=>{
    let w=0,l=0;
    univs.forEach(v=>{if(u.name!==v.name){w+=matrix[u.name][v.name].w;l+=matrix[u.name][v.name].l;}});
    return{...u,w,l,rate:w+l?Math.round(w/(w+l)*100):0};
  }).sort((a,b)=>b.rate-a.rate||b.w-a.w);

  if(!_matrix2Sel.a&&univRank.length)_matrix2Sel.a=univRank[0].name;
  if(!_matrix2Sel.b&&univRank.length>1)_matrix2Sel.b=univRank[1].name;

  // ì„ íƒëœ ë‘ ëŒ€í•™ì˜ ì„ ìˆ˜ë³„ ìƒì„¸
  let detailHTML='';
  if(_matrix2Sel.a&&_matrix2Sel.b&&_matrix2Sel.a!==_matrix2Sel.b){
    const pmAB=playerMatrix[_matrix2Sel.a]?.[_matrix2Sel.b]||{};
    const pmBA=playerMatrix[_matrix2Sel.b]?.[_matrix2Sel.a]||{};
    const sAB=matrix[_matrix2Sel.a]?.[_matrix2Sel.b]||{w:0,l:0};
    const sBA=matrix[_matrix2Sel.b]?.[_matrix2Sel.a]||{w:0,l:0};
    const colA=gc(_matrix2Sel.a), colB=gc(_matrix2Sel.b);

    // AíŒ€ ì„ ìˆ˜ë³„ vs BíŒ€
    const aPlayers=Object.entries(pmAB).map(([pName,opps])=>{
      let w=0,l=0;Object.values(opps).forEach(s=>{w+=s.w;l+=s.l;});
      return{name:pName,w,l,tot:w+l,rate:w+l?Math.round(w/(w+l)*100):0,opps};
    }).sort((a,b)=>b.w-a.w);

    detailHTML=`
    <div class="ssec" style="margin-top:0">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:14px">
        <select style="padding:6px 10px;border:1.5px solid ${colA};border-radius:8px;font-size:13px;font-weight:700;color:${colA}"
          onchange="_matrix2Sel.a=this.value;render()">
          ${univRank.map(u=>`<option value="${u.name}"${_matrix2Sel.a===u.name?' selected':''}>${u.name}</option>`).join('')}
        </select>
        <span style="font-weight:900;font-size:18px;color:var(--gray-l)">vs</span>
        <select style="padding:6px 10px;border:1.5px solid ${colB};border-radius:8px;font-size:13px;font-weight:700;color:${colB}"
          onchange="_matrix2Sel.b=this.value;render()">
          ${univRank.map(u=>`<option value="${u.name}"${_matrix2Sel.b===u.name?' selected':''}>${u.name}</option>`).join('')}
        </select>
        <div style="margin-left:auto;display:flex;gap:12px;align-items:center">
          <span style="background:${colA};color:#fff;padding:4px 14px;border-radius:8px;font-weight:800">${_matrix2Sel.a} ${sAB.w}W ${sAB.l}L</span>
          <span style="font-weight:900;font-size:15px">vs</span>
          <span style="background:${colB};color:#fff;padding:4px 14px;border-radius:8px;font-weight:800">${_matrix2Sel.b} ${sBA.w}W ${sBA.l}L</span>
        </div>
      </div>
      <div style="overflow-x:auto">
      <table>
        <thead><tr>
          <th style="background:${colA}22">${_matrix2Sel.a} ì„ ìˆ˜</th>
          <th style="background:${colA}22">ìŠ¹</th><th style="background:${colA}22">íŒ¨</th><th style="background:${colA}22">ìŠ¹ë¥ </th>
          <th>vs ìƒëŒ€ ì„ ìˆ˜ (${_matrix2Sel.b})</th>
        </tr></thead>
        <tbody>
          ${aPlayers.map(p=>{
            const oppDetail=Object.entries(p.opps).map(([oName,s])=>`
              <span style="display:inline-flex;align-items:center;gap:3px;padding:2px 8px;background:${s.w>s.l?'#dcfce7':s.w<s.l?'#fee2e2':'#f1f5f9'};border-radius:6px;font-size:11px;cursor:pointer;margin:1px" onclick="openPlayerModal('${oName}')">
                <b>${oName}</b> ${s.w}W${s.l}L
              </span>`).join('');
            return`<tr>
              <td style="font-weight:700;cursor:pointer;color:var(--blue)" onclick="openPlayerModal('${p.name}')">${p.name}</td>
              <td class="wt">${p.w}</td><td class="lt">${p.l}</td>
              <td style="font-weight:800;color:${p.rate>=50?'var(--green)':'var(--red)'}">${p.tot?p.rate+'%':'-'}</td>
              <td>${oppDetail||'<span style="color:var(--gray-l);font-size:11px">-</span>'}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table></div>
    </div>`;
  }

  function cellBg(w,l){
    if(!w&&!l)return'#f8fafc';const r=w/(w+l);
    if(r>=0.6)return'#dcfce7';if(r>=0.5)return'#f0fdf4';if(r<=0.4)return'#fee2e2';if(r<0.5)return'#fff5f5';return'#f8fafc';
  }

  return`<div style="display:flex;flex-direction:column;gap:14px">
  <div class="ssec" id="stats-univmatrix2-sec">
    <h4 style="margin-bottom:12px">ğŸ›ï¸ ëŒ€í•™ ê°„ ìƒëŒ€ì „ì  ë§¤íŠ¸ë¦­ìŠ¤ (ìƒì„¸)</h4>
    <div style="overflow-x:auto">
    <table style="border-collapse:collapse;font-size:12px;min-width:${60+univRank.length*72}px">
      <thead><tr>
        <th style="padding:6px 10px;background:var(--surface);border:1px solid var(--border)">â†“ë‚˜ / ìƒëŒ€â†’</th>
        ${univRank.map(u=>`<th style="padding:6px 8px;background:${gc(u.name)}22;border:1px solid var(--border);white-space:nowrap;min-width:72px">
          <div style="display:flex;flex-direction:column;align-items:center;gap:2px">
            <span style="background:${gc(u.name)};color:#fff;padding:2px 7px;border-radius:4px;font-size:11px;font-weight:700">${u.name}</span>
            <span style="font-size:10px;color:${u.rate>=50?'var(--green)':'var(--red)'};font-weight:700">${u.rate}%</span>
          </div>
        </th>`).join('')}
      </tr></thead>
      <tbody>
        ${univRank.map(u=>`<tr>
          <td style="padding:6px 10px;background:${gc(u.name)}22;border:1px solid var(--border);font-weight:700;white-space:nowrap">
            <span style="background:${gc(u.name)};color:#fff;padding:2px 7px;border-radius:4px;font-size:11px">${u.name}</span>
          </td>
          ${univRank.map(v=>{
            if(u.name===v.name)return`<td style="background:#f1f5f9;border:1px solid var(--border);text-align:center;color:var(--gray-l)">-</td>`;
            const s=matrix[u.name][v.name];const t=s.w+s.l;if(!t)return`<td style="background:#f8fafc;border:1px solid var(--border);text-align:center;color:var(--gray-l);font-size:11px">-</td>`;
            const r=Math.round(s.w/t*100);
            return`<td style="background:${cellBg(s.w,s.l)};border:1px solid var(--border);text-align:center;padding:5px 4px;cursor:pointer"
              onclick="_matrix2Sel.a='${u.name}';_matrix2Sel.b='${v.name}';document.getElementById('matrix2-detail').scrollIntoView({behavior:'smooth'})">
              <div style="font-weight:800;font-size:13px;color:${r>=50?'#16a34a':'#dc2626'}">${r}%</div>
              <div style="font-size:10px;color:var(--gray-l)">${s.w}W${s.l}L</div>
            </td>`;
          }).join('')}
        </tr>`).join('')}
      </tbody>
    </table></div>
    <p style="font-size:11px;color:var(--gray-l);margin-top:6px">ì…€ í´ë¦­ ì‹œ ì•„ë˜ ì„ ìˆ˜ë³„ ìƒì„¸ í‘œì‹œ</p>
  </div>
  <div id="matrix2-detail">${detailHTML}</div>
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   F. CSV / ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function statsCsvExportHTML(){
  if(!isLoggedIn)return`<div class="ssec"><div style="padding:40px;text-align:center;color:var(--gray-l)">ğŸ”’ ê´€ë¦¬ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div></div>`;
  return`<div style="display:flex;flex-direction:column;gap:14px">
  <div class="ssec">
    <h4 style="margin-bottom:14px">ğŸ“¥ CSV / ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h4>
    <div style="display:flex;flex-wrap:wrap;gap:10px">

      <!-- ì„ ìˆ˜ ì „ì  -->
      <div style="background:var(--white);border:1px solid var(--border);border-radius:12px;padding:18px;flex:1;min-width:220px">
        <div style="font-size:20px;margin-bottom:6px">ğŸ‘¤</div>
        <div style="font-weight:800;font-size:14px;margin-bottom:4px">ì„ ìˆ˜ ì „ì  CSV</div>
        <div style="font-size:11px;color:var(--gray-l);margin-bottom:12px">ì´ë¦„, ëŒ€í•™, í‹°ì–´, ì¢…ì¡±, ìŠ¹, íŒ¨, ìŠ¹ë¥ , ELO, í¬ì¸íŠ¸</div>
        <button class="btn btn-b btn-sm" onclick="csvDownloadPlayers()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
      </div>

      <!-- ê²½ê¸° íˆìŠ¤í† ë¦¬ -->
      <div style="background:var(--white);border:1px solid var(--border);border-radius:12px;padding:18px;flex:1;min-width:220px">
        <div style="font-size:20px;margin-bottom:6px">ğŸ“‹</div>
        <div style="font-weight:800;font-size:14px;margin-bottom:4px">ê²½ê¸° íˆìŠ¤í† ë¦¬ CSV</div>
        <div style="font-size:11px;color:var(--gray-l);margin-bottom:12px">ë‚ ì§œ, ìŠ¹ì, íŒ¨ì, ë§µ, ELOë³€í™”, ë§¤ì¹˜ID</div>
        <button class="btn btn-b btn-sm" onclick="csvDownloadHistory()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
      </div>

      <!-- ëŒ€í•™ë³„ í†µê³„ -->
      <div style="background:var(--white);border:1px solid var(--border);border-radius:12px;padding:18px;flex:1;min-width:220px">
        <div style="font-size:20px;margin-bottom:6px">ğŸ›ï¸</div>
        <div style="font-weight:800;font-size:14px;margin-bottom:4px">ëŒ€í•™ë³„ í†µê³„ CSV</div>
        <div style="font-size:11px;color:var(--gray-l);margin-bottom:12px">ëŒ€í•™, ì´ìŠ¹, ì´íŒ¨, ìŠ¹ë¥ , ì„ ìˆ˜ìˆ˜</div>
        <button class="btn btn-b btn-sm" onclick="csvDownloadUniv()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
      </div>

      <!-- ë§µë³„ í†µê³„ -->
      <div style="background:var(--white);border:1px solid var(--border);border-radius:12px;padding:18px;flex:1;min-width:220px">
        <div style="font-size:20px;margin-bottom:6px">ğŸ—ºï¸</div>
        <div style="font-weight:800;font-size:14px;margin-bottom:4px">ë§µë³„ í†µê³„ CSV</div>
        <div style="font-size:11px;color:var(--gray-l);margin-bottom:12px">ë§µ, ì´ê²½ê¸°, ìŠ¹íšŸìˆ˜, íŒ¨íšŸìˆ˜</div>
        <button class="btn btn-b btn-sm" onclick="csvDownloadMaps()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
      </div>

      <!-- ì „ì²´ ë°±ì—… JSON -->
      <div style="background:var(--white);border:1px solid var(--border);border-radius:12px;padding:18px;flex:1;min-width:220px">
        <div style="font-size:20px;margin-bottom:6px">ğŸ’¾</div>
        <div style="font-weight:800;font-size:14px;margin-bottom:4px">ì „ì²´ ë°±ì—… JSON</div>
        <div style="font-size:11px;color:var(--gray-l);margin-bottom:12px">ëª¨ë“  ë°ì´í„° JSON ë°±ì—… (ê¸°ì¡´ ê¸°ëŠ¥)</div>
        <button class="btn btn-w btn-sm" onclick="doExport()">ğŸ“¤ JSON ë°±ì—…</button>
      </div>
    </div>
  </div>
  </div>`;
}

function _csvDownload(filename, rows){
  const BOM='\uFEFF'; // í•œê¸€ ê¹¨ì§ ë°©ì§€
  const csv=BOM+rows.map(r=>r.map(v=>{
    const s=String(v??'');
    return s.includes(',')||s.includes('"')||s.includes('\n')?'"'+s.replace(/"/g,'""')+'"':s;
  }).join(',')).join('\n');
  const b=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(b);
  const a=document.createElement('a');
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},100);
}

function csvDownloadPlayers(){
  const proIds=statsProMatchIds();
  const rows=[['ì´ë¦„','ëŒ€í•™','í‹°ì–´','ì¢…ì¡±','ì„±ë³„','ìŠ¹(ì „ì²´)','íŒ¨(ì „ì²´)','ìŠ¹ë¥ (ì „ì²´)','ELO','í¬ì¸íŠ¸']];
  players.forEach(p=>{
    const h=statsNonProHist(p);
    const w=h.filter(x=>x.result==='ìŠ¹').length, l=h.filter(x=>x.result==='íŒ¨').length;
    const tot=w+l;
    rows.push([p.name,p.univ,p.tier||'-',p.race||'-',p.gender==='M'?'ë‚¨':'ì—¬',
      p.win,p.loss,tot?Math.round(p.win/p.loss||0)+'%':'-',p.elo||1200,p.points||0]);
  });
  _csvDownload(`ì„ ìˆ˜ì „ì _${new Date().toISOString().slice(0,10)}.csv`, rows);
}

function csvDownloadHistory(){
  const rows=[['ë‚ ì§œ','ìŠ¹ì','ìŠ¹ìëŒ€í•™','ìŠ¹ìì¢…ì¡±','íŒ¨ì','íŒ¨ìëŒ€í•™','íŒ¨ìì¢…ì¡±','ë§µ','ELOë³€í™”(ìŠ¹ì)','ë§¤ì¹˜ID']];
  players.forEach(p=>{
    (p.history||[]).forEach(h=>{
      if(h.result!=='ìŠ¹') return; // ìŠ¹ì ê¸°ì¤€ 1íšŒë§Œ
      const opp=players.find(x=>x.name===h.opp);
      rows.push([h.date||'',p.name,p.univ,p.race||'-',
        h.opp,opp?.univ||'-',h.oppRace||'-',
        h.map||'-',h.eloDelta!=null?h.eloDelta:'',h.matchId||'']);
    });
  });
  rows.sort((a,b)=>(a[0]||'').localeCompare(b[0]||''));
  _csvDownload(`ê²½ê¸°íˆìŠ¤í† ë¦¬_${new Date().toISOString().slice(0,10)}.csv`, rows);
}

function csvDownloadUniv(){
  const univs=getAllUnivs();
  const rows=[['ëŒ€í•™','ì„ ìˆ˜ìˆ˜','ì´ìŠ¹','ì´íŒ¨','ìŠ¹ë¥ ']];
  univs.forEach(u=>{
    const mems=players.filter(p=>p.univ===u.name);
    let w=0,l=0;
    mems.forEach(p=>{ const h=statsNonProHist(p); w+=h.filter(x=>x.result==='ìŠ¹').length; l+=h.filter(x=>x.result==='íŒ¨').length; });
    const rate=w+l?Math.round(w/(w+l)*100):0;
    rows.push([u.name,mems.length,w,l,rate+'%']);
  });
  _csvDownload(`ëŒ€í•™ë³„í†µê³„_${new Date().toISOString().slice(0,10)}.csv`, rows);
}

function csvDownloadMaps(){
  const mapStats={};
  players.forEach(p=>(p.history||[]).forEach(h=>{
    if(!h.map||h.map==='-') return;
    if(!mapStats[h.map]) mapStats[h.map]={w:0,l:0};
    if(h.result==='ìŠ¹') mapStats[h.map].w++; else mapStats[h.map].l++;
  }));
  const rows=[['ë§µ','ì´ê²½ê¸°','ìŠ¹íšŸìˆ˜','íŒ¨íšŸìˆ˜','ìŠ¹ë¥ ']];
  Object.entries(mapStats).sort((a,b)=>(b[1].w+b[1].l)-(a[1].w+a[1].l)).forEach(([m,s])=>{
    const tot=s.w+s.l;
    rows.push([m,tot,s.w,s.l,tot?Math.round(s.w/tot*100)+'%':'-']);
  });
  _csvDownload(`ë§µë³„í†µê³„_${new Date().toISOString().slice(0,10)}.csv`, rows);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   9. ì„ ìˆ˜ ê²€ìƒ‰ ê³ ê¸‰ í•„í„°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _advFilter={tier:'',race:'',univ:'',gender:'',minElo:'',maxElo:'',minGames:'',name:'',sort:'elo'};
function statsAdvSearchHTML(){
  const f=_advFilter;
  const univs=getAllUnivs();
  let list=[...players].filter(p=>{
    if(f.name&&!p.name.includes(f.name))return false;
    if(f.tier&&p.tier!==f.tier)return false;
    if(f.race&&p.race!==f.race)return false;
    if(f.univ&&p.univ!==f.univ)return false;
    if(f.gender&&p.gender!==f.gender)return false;
    const elo=p.elo||1200;
    if(f.minElo&&elo<parseInt(f.minElo))return false;
    if(f.maxElo&&elo>parseInt(f.maxElo))return false;
    const tot=(p.history||[]).length;
    if(f.minGames&&tot<parseInt(f.minGames))return false;
    return true;
  });
  const proIds=statsProMatchIds();
  list=list.map(p=>{
    const h=statsNonProHist(p);
    const w=h.filter(x=>x.result==='ìŠ¹').length,l=h.filter(x=>x.result==='íŒ¨').length,tot=w+l;
    return{...p,_w:w,_l:l,_tot:tot,_rate:tot?Math.round(w/tot*100):0,_elo:p.elo||1200};
  });
  if(f.sort==='elo') list.sort((a,b)=>b._elo-a._elo);
  else if(f.sort==='win') list.sort((a,b)=>b._w-a._w);
  else if(f.sort==='rate') list.sort((a,b)=>b._rate-a._rate||b._tot-a._tot);
  else if(f.sort==='games') list.sort((a,b)=>b._tot-a._tot);
  else if(f.sort==='name') list.sort((a,b)=>a.name.localeCompare(b.name));
  return`<div style="display:flex;flex-direction:column;gap:14px">
  <div class="ssec" id="stats-advsearch-sec">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
      <h4 style="margin:0">ğŸ” ì„ ìˆ˜ ê³ ê¸‰ ê²€ìƒ‰ í•„í„°</h4>
      <button class="btn-capture btn-xs no-export" onclick="captureSection('stats-advsearch-sec','advsearch')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
      <input type="text" placeholder="ğŸ” ì´ë¦„ ê²€ìƒ‰..." value="${f.name}" oninput="_advFilter.name=this.value;render()" style="padding:6px 12px;border:1px solid var(--border2);border-radius:8px;font-size:12px;width:150px">
      <select onchange="_advFilter.univ=this.value;render()" style="font-size:12px;padding:6px 10px;border:1px solid var(--border2);border-radius:8px">
        <option value="">ëŒ€í•™ ì „ì²´</option>
        ${univs.map(u=>`<option value="${u.name}"${f.univ===u.name?' selected':''}>${u.name}</option>`).join('')}
      </select>
      <select onchange="_advFilter.tier=this.value;render()" style="font-size:12px;padding:6px 10px;border:1px solid var(--border2);border-radius:8px">
        <option value="">í‹°ì–´ ì „ì²´</option>
        ${TIERS.map(t=>`<option value="${t}"${f.tier===t?' selected':''}>${getTierLabel(t)}</option>`).join('')}
      </select>
      <select onchange="_advFilter.race=this.value;render()" style="font-size:12px;padding:6px 10px;border:1px solid var(--border2);border-radius:8px">
        <option value="">ì¢…ì¡± ì „ì²´</option>
        <option value="T"${f.race==='T'?' selected':''}>í…Œë€</option>
        <option value="Z"${f.race==='Z'?' selected':''}>ì €ê·¸</option>
        <option value="P"${f.race==='P'?' selected':''}>í”„ë¡œí† ìŠ¤</option>
      </select>
      <select onchange="_advFilter.gender=this.value;render()" style="font-size:12px;padding:6px 10px;border:1px solid var(--border2);border-radius:8px">
        <option value="">ì„±ë³„ ì „ì²´</option>
        <option value="M"${f.gender==='M'?' selected':''}>ë‚¨ì</option>
        <option value="F"${f.gender==='F'?' selected':''}>ì—¬ì</option>
      </select>
      <input type="number" placeholder="ìµœì†ŒELO" value="${f.minElo}" oninput="_advFilter.minElo=this.value;render()" style="width:80px;padding:6px 8px;border:1px solid var(--border2);border-radius:8px;font-size:12px">
      <input type="number" placeholder="ìµœëŒ€ELO" value="${f.maxElo}" oninput="_advFilter.maxElo=this.value;render()" style="width:80px;padding:6px 8px;border:1px solid var(--border2);border-radius:8px;font-size:12px">
      <input type="number" placeholder="ìµœì†Œê²½ê¸°ìˆ˜" value="${f.minGames}" oninput="_advFilter.minGames=this.value;render()" style="width:90px;padding:6px 8px;border:1px solid var(--border2);border-radius:8px;font-size:12px">
      <select onchange="_advFilter.sort=this.value;render()" style="font-size:12px;padding:6px 10px;border:1px solid var(--border2);border-radius:8px">
        <option value="elo"${f.sort==='elo'?' selected':''}>ELOìˆœ</option>
        <option value="win"${f.sort==='win'?' selected':''}>ìŠ¹ìˆ˜ìˆœ</option>
        <option value="rate"${f.sort==='rate'?' selected':''}>ìŠ¹ë¥ ìˆœ</option>
        <option value="games"${f.sort==='games'?' selected':''}>ê²½ê¸°ìˆ˜ìˆœ</option>
        <option value="name"${f.sort==='name'?' selected':''}>ì´ë¦„ìˆœ</option>
      </select>
      <button class="btn btn-w btn-sm" onclick="_advFilter={tier:'',race:'',univ:'',gender:'',minElo:'',maxElo:'',minGames:'',name:'',sort:'elo'};render()">ì´ˆê¸°í™”</button>
    </div>
    <div style="font-size:12px;color:var(--gray-l);margin-bottom:8px">ê²€ìƒ‰ ê²°ê³¼: <strong>${list.length}ëª…</strong></div>
    ${list.length===0?'<p style="color:var(--gray-l);padding:20px;text-align:center">ì¡°ê±´ì— ë§ëŠ” ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>':`
    <div style="overflow-x:auto"><table>
      <thead><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ëŒ€í•™</th><th>í‹°ì–´</th><th>ì¢…ì¡±</th><th>ì„±ë³„</th><th>ELO</th><th>ìŠ¹</th><th>íŒ¨</th><th>ìŠ¹ë¥ </th><th>ê²½ê¸°ìˆ˜</th></tr></thead>
      <tbody>
        ${list.map((p,i)=>{
          const eloColor=p._elo>=1400?'#7c3aed':p._elo>=1300?'#d97706':p._elo>=1200?'var(--green)':'var(--red)';
          return`<tr style="cursor:pointer" onclick="openPlayerModal('${p.name}')">
            <td>${i+1}</td>
            <td style="font-weight:700;color:var(--blue)">${p.name}</td>
            <td><span class="ubadge" style="background:${gc(p.univ)}">${p.univ}</span></td>
            <td>${getTierLabel(p.tier||'-')}</td>
            <td><span class="rbadge r${p.race||'T'}">${p.race||'-'}</span></td>
            <td>${p.gender==='M'?'ğŸ‘¨':'ğŸ‘©'}</td>
            <td style="font-weight:800;color:${eloColor}">${p._elo}</td>
            <td class="wt">${p._w}</td>
            <td class="lt">${p._l}</td>
            <td style="font-weight:700;color:${p._rate>=50?'var(--green)':'var(--red)'}">${p._tot?p._rate+'%':'-'}</td>
            <td>${p._tot}</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table></div>`}
  </div></div>`;
}



/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ” ì „ì²´ ì„ ìˆ˜ ê²€ìƒ‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onGlobalSearch(val){
  const drop = document.getElementById('globalSearchDrop');
  if(!val || val.trim()===''){drop.style.display='none';return;}
  const q = val.toLowerCase();
  const results = players.filter(p=>
    p.name.toLowerCase().includes(q) ||
    (p.univ||'').toLowerCase().includes(q) ||
    (p.tier||'').toLowerCase().includes(q) ||
    (p.race||'').toLowerCase().includes(q) ||
    (p.memo||'').toLowerCase().includes(q)
  ).slice(0,15);
  if(results.length===0){
    drop.innerHTML='<div style="padding:16px;text-align:center;color:var(--gray-l);font-size:12px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
    drop.style.display='block';return;
  }
  const raceEmoji={T:'âš”ï¸',Z:'ğŸ¦Ÿ',P:'ğŸ”®'};
  drop.innerHTML = results.map(p=>{
    const col=gc(p.univ);
    const wr=p.win+p.loss===0?0:Math.round(p.win/(p.win+p.loss)*100);
    return `<div onclick="globalSearchSelect('${p.name}')" style="padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;transition:.1s"
      onmouseover="this.style.background='#f0f6ff'" onmouseout="this.style.background=''"
    >
      <div style="width:36px;height:36px;border-radius:8px;background:${col};display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">${raceEmoji[p.race]||'ğŸ‘¤'}</div>
      <div style="flex:1;min-width:0">
        <div style="font-weight:700;font-size:13px">${p.name} ${p.gender==='M'?'<span style="font-size:10px;background:#2563eb;color:#fff;padding:1px 5px;border-radius:4px">â™‚</span>':''}</div>
        <div style="font-size:11px;color:var(--gray-l)">${p.univ} Â· ${p.tier}</div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-weight:700;font-size:12px;color:var(--blue)">${wr}%</div>
        <div style="font-size:10px;color:var(--gray-l)">${p.win}ìŠ¹${p.loss}íŒ¨</div>
      </div>
    </div>`;
  }).join('');
  drop.style.display='block';
}

function globalSearchSelect(name){
  document.getElementById('globalSearch').value='';
  document.getElementById('globalSearchDrop').style.display='none';
  openPlayerModal(name);
}

// ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
document.addEventListener('click', e=>{
  if(!e.target.closest('#globalSearch') && !e.target.closest('#globalSearchDrop')){
    const d=document.getElementById('globalSearchDrop');
    if(d) d.style.display='none';
  }
});


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“… ê²½ê¸° ìº˜ë¦°ë”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// ìº˜ë¦°ë” ì£¼ê°„/ì¼ê°„ ë·°ë¥¼ ìœ„í•œ ìƒíƒœ
let calWeekOffset=0; // í˜„ì¬ ì£¼ ê¸°ì¤€ ì˜¤í”„ì…‹ (0=ì´ë²ˆì£¼, -1=ì§€ë‚œì£¼ ...)
let calDayDate=''; // ì¼ê°„ë·° í˜„ì¬ ë‚ ì§œ

function rCal(C,T){
  T.textContent='ğŸ“… ê²½ê¸° ìº˜ë¦°ë”';

  // ëª¨ë“  ê²½ê¸° ë°ì´í„° ë§µ (ë‚ ì§œâ†’ê²½ê¸° ê°ì²´ ë°°ì—´)
  const allMatches=[...miniM,...univM,...comps,...ckM,...proM,...(typeof getTourneyMatches==='function'?getTourneyMatches():[])];
  window._rCalAllMatches=allMatches; // calView=day ê³µìœ ì¹´ë“œìš© ì „ì—­ ìºì‹œ
  const dateMatchMap={};
  allMatches.forEach(m=>{
    const d=m.d||'';
    if(!d)return;
    if(!dateMatchMap[d])dateMatchMap[d]=[];
    dateMatchMap[d].push(m);
  });

  // ë‚ ì§œ label ìƒì„±
  function matchLabel(m){
    if(miniM.includes(m)) return `âš¡ ${m.a||''} vs ${m.b||''}`;
    if(univM.includes(m)) return `ğŸŸï¸ ${m.a||''} vs ${m.b||''}`;
    if(ckM.includes(m))   return `ğŸ¤ CK ${m.teamALabel||'AíŒ€'} vs ${m.teamBLabel||'BíŒ€'}`;
    if(proM.includes(m))  return `ğŸ… í”„ë¡œ ${m.teamALabel||'AíŒ€'} vs ${m.teamBLabel||'BíŒ€'}`;
    return `ğŸ–ï¸ ëŒ€íšŒ`;
  }
  // ìº˜ë¦°ë”ìš© íŒ€ëª… getter (í”„ë¡œ/CKëŠ” label ì‚¬ìš©)
  function getTeamA(m){ return ckM.includes(m)||proM.includes(m) ? 'AíŒ€' : (m.a||''); }
  function getTeamB(m){ return ckM.includes(m)||proM.includes(m) ? 'BíŒ€' : (m.b||''); }

  const now=new Date(calYear,calMonth,1);
  const year=now.getFullYear();
  const month=now.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const lastDate=new Date(year,month+1,0).getDate();
  const weeks=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

  const today=new Date();
  function pad(n){return String(n).padStart(2,'0');}
  function dateStr(y,m,d){return `${y}-${pad(m+1)}-${pad(d)}`;}
  const todayStr=dateStr(today.getFullYear(),today.getMonth(),today.getDate());

  // ì£¼ê°„ë·° ê¸°ì¤€ weekStart (ì˜¤í”„ì…‹ ì ìš©)
  const weekStart=new Date(today);
  weekStart.setDate(today.getDate()-today.getDay()+calWeekOffset*7);

  // ì¼ê°„ë·° ë‚ ì§œ
  if(!calDayDate) calDayDate=todayStr;

  let calHTML='';
  let navHTML='';

  if(calView==='month'){
    navHTML=`
      <button class="btn btn-w btn-sm" onclick="calYear=calMonth===0?calYear-1:calYear;calMonth=calMonth===0?11:calMonth-1;render()">â—€ ì´ì „</button>
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px;min-width:110px;text-align:center">${year}ë…„ ${month+1}ì›”</span>
      <button class="btn btn-w btn-sm" onclick="calYear=calMonth===11?calYear+1:calYear;calMonth=calMonth===11?0:calMonth+1;render()">ë‹¤ìŒ â–¶</button>
      <button class="btn btn-w btn-sm" onclick="calYear=new Date().getFullYear();calMonth=new Date().getMonth();render()">ì˜¤ëŠ˜</button>`;

    let cells='';
    let day=1;
    for(let row=0;row<6;row++){
      let rowHTML='';
      for(let col=0;col<7;col++){
        const idx=row*7+col;
        if(idx<firstDay||day>lastDate){
          rowHTML+=`<td style="background:var(--surface);vertical-align:top;padding:4px;min-height:80px"></td>`;
        } else {
          const ds=dateStr(year,month,day);
          const matches=dateMatchMap[ds]||[];
          const isToday=ds===todayStr;
          const hasMatch=matches.length>0;
          rowHTML+=`<td data-ds="${ds}" style="vertical-align:top;padding:4px;min-height:80px;cursor:${hasMatch?'pointer':'default'};${hasMatch?`background:${ds===_calActiveDay?'#dbeafe':'#f0f6ff'};`:''}border-radius:6px;${hasMatch&&ds===_calActiveDay?'outline:2px solid var(--blue);outline-offset:-2px;':''}"
            ${hasMatch?`onclick="calShowDay('${ds}')"`:''}
          >
            <div style="font-weight:${isToday?'900':'600'};font-size:12px;color:${isToday?'#fff':'var(--text)'};background:${isToday?'var(--blue)':'transparent'};width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:3px">${day}</div>
            ${matches.slice(0,2).map(m=>`<div style="font-size:9px;background:${proM.includes(m)?'#7c3aed':miniM.includes(m)?'#2563eb':univM.includes(m)?'#059669':ckM.includes(m)?'#d97706':'#2563eb'};color:#fff;border-radius:3px;padding:1px 4px;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${matchLabel(m)}</div>`).join('')}
            ${matches.length>2?`<div style="font-size:9px;color:var(--blue);font-weight:700">+${matches.length-2}ë”</div>`:''}
          </td>`;
          day++;
        }
      }
      cells+=`<tr>${rowHTML}</tr>`;
      if(day>lastDate)break;
    }
    calHTML=`
      <table style="width:100%;border-collapse:collapse;table-layout:fixed">
        <thead><tr>${weeks.map((w,i)=>`<th style="padding:8px;font-size:11px;color:${i===0?'var(--red)':i===6?'var(--blue)':'var(--gray-l)'};font-weight:700">${w}</th>`).join('')}</tr></thead>
        <tbody>${cells}</tbody>
      </table>`;

  } else if(calView==='week'){
    // ì£¼ê°„ë·°ì— ì´ì „/ë‹¤ìŒ ì£¼ ë„¤ë¹„
    const ws=new Date(weekStart);
    const we=new Date(weekStart);we.setDate(we.getDate()+6);
    const wsStr=`${ws.getMonth()+1}/${ws.getDate()}`;
    const weStr=`${we.getMonth()+1}/${we.getDate()}`;
    navHTML=`
      <button class="btn btn-w btn-sm" onclick="calWeekOffset--;render()">â—€ ì´ì „ ì£¼</button>
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;min-width:130px;text-align:center">${wsStr} ~ ${weStr}</span>
      <button class="btn btn-w btn-sm" onclick="calWeekOffset++;render()">ë‹¤ìŒ ì£¼ â–¶</button>
      <button class="btn btn-w btn-sm" onclick="calWeekOffset=0;render()">ì´ë²ˆ ì£¼</button>`;

    let rows='';
    for(let i=0;i<7;i++){
      const d=new Date(weekStart);d.setDate(weekStart.getDate()+i);
      const ds=dateStr(d.getFullYear(),d.getMonth(),d.getDate());
      const matches=dateMatchMap[ds]||[];
      const isToday=ds===todayStr;
      rows+=`<div style="display:flex;gap:12px;padding:10px 14px;background:${isToday?'var(--blue-l)':'var(--white)'};border:1px solid ${isToday?'var(--blue)':'var(--border)'};border-radius:8px;margin-bottom:6px;align-items:flex-start;cursor:${matches.length?'pointer':'default'}"
        ${matches.length?`onclick="calDayDate='${ds}';calView='day';render()"`:''}>
        <div style="min-width:48px;text-align:center">
          <div style="font-size:10px;color:${i===0?'var(--red)':i===6?'var(--blue)':'var(--gray-l)'};font-weight:700">${weeks[i]}</div>
          <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px;color:${isToday?'var(--blue)':'var(--text)'}">${d.getDate()}</div>
        </div>
        <div style="flex:1">
          ${matches.length===0
            ?`<span style="color:var(--gray-l);font-size:12px">ê²½ê¸° ì—†ìŒ</span>`
            :matches.map(m=>{
              const isCKorPro=ckM.includes(m)||proM.includes(m);
              const tA=getTeamA(m);const tB=getTeamB(m);
              const ca=isCKorPro?'#2563eb':gc(m.a||'');const cb=isCKorPro?'#dc2626':gc(m.b||'');
              const aWin=(m.sa??-1)>(m.sb??-1);const bWin=(m.sb??-1)>(m.sa??-1);
              const hasResult=(m.sa!=null&&m.sa!=='');
              return `<div style="font-size:11px;font-weight:600;padding:4px 8px;background:#f0f6ff;border:1px solid var(--blue-ll);border-radius:5px;margin-bottom:3px;display:flex;align-items:center;gap:6px">
                <span style="color:var(--blue);font-size:10px">${matchLabel(m).split(' ')[0]}</span>
                <span style="font-weight:700;color:${aWin&&hasResult?ca:'var(--text)'}">${tA}</span>
                ${hasResult?`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px">${m.sa}:<span>${m.sb}</span></span>`:`<span style="color:var(--gray-l)">vs</span>`}
                <span style="font-weight:700;color:${bWin&&hasResult?cb:'var(--text)'}">${tB}</span>
                ${hasResult?(aWin?`<span style="font-size:10px;color:${ca};font-weight:800">â–¶ ${tA} ìŠ¹</span>`:bWin?`<span style="font-size:10px;color:${cb};font-weight:800">â–¶ ${tB} ìŠ¹</span>`:'<span style="font-size:10px;color:var(--gray-l)">ë¬´</span>'):''}
              </div>`;
            }).join('')
          }
        </div>
      </div>`;
    }
    calHTML=rows;

  } else if(calView==='day'){
    // ì¼ê°„ë·°
    const d=new Date(calDayDate);
    const prevD=new Date(d);prevD.setDate(d.getDate()-1);
    const nextD=new Date(d);nextD.setDate(d.getDate()+1);
    const fmtDayStr=(dt)=>dateStr(dt.getFullYear(),dt.getMonth(),dt.getDate());
    navHTML=`
      <button class="btn btn-w btn-sm" onclick="calDayDate='${fmtDayStr(prevD)}';render()">â—€ ì „ë‚ </button>
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px;min-width:130px;text-align:center">${calDayDate}</span>
      <button class="btn btn-w btn-sm" onclick="calDayDate='${fmtDayStr(nextD)}';render()">ë‹¤ìŒë‚  â–¶</button>
      <button class="btn btn-w btn-sm" onclick="calDayDate='${todayStr}';render()">ì˜¤ëŠ˜</button>`;

    const matches=dateMatchMap[calDayDate]||[];
    if(!matches.length){
      calHTML=`<div style="padding:40px;text-align:center;color:var(--gray-l)">ì´ ë‚  ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    } else {
      calHTML=matches.map((m,mi)=>{
        const isCKorPro=ckM.includes(m)||proM.includes(m);
        const tA=getTeamA(m);const tB=getTeamB(m);
        const ca=isCKorPro?'#2563eb':gc(m.a||'');const cb=isCKorPro?'#dc2626':gc(m.b||'');
        const aWin=(m.sa??-1)>(m.sb??-1);const bWin=(m.sb??-1)>(m.sa??-1);
        const hasResult=(m.sa!=null&&m.sa!=='');
        const typeLabel=miniM.includes(m)?'âš¡ ë¯¸ë‹ˆëŒ€ì „':univM.includes(m)?'ğŸŸï¸ ëŒ€í•™ëŒ€ì „':ckM.includes(m)?'ğŸ¤ ëŒ€í•™CK':proM.includes(m)?'ğŸ… í”„ë¡œë¦¬ê·¸':'ğŸ–ï¸ ëŒ€íšŒ';
        const detKey=`calday-${calDayDate}-${mi}`;
        const detHTML=buildDetailHTML(m,miniM.includes(m)?'mini':univM.includes(m)?'univm':ckM.includes(m)?'ck':proM.includes(m)?'pro':'comp',
          tA,tB,ca,cb,aWin,bWin);
        return `<div style="background:var(--white);border:1px solid var(--border);border-radius:10px;margin-bottom:10px;overflow:hidden">
          <div style="padding:12px 16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;background:var(--surface);border-bottom:1px solid var(--border)">
            <span style="font-size:11px;font-weight:700;color:var(--blue)">${typeLabel}</span>
            <span class="ubadge${aWin&&hasResult?'':hasResult?' loser':''}" style="background:${ca}">${tA}</span>
            ${hasResult?`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px"><span class="${aWin?'wt':bWin?'lt':'pt-z'}">${m.sa}</span><span style="color:var(--gray-l);font-size:14px"> : </span><span class="${bWin?'wt':aWin?'lt':'pt-z'}">${m.sb}</span></div>`:`<span style="color:var(--gray-l);font-weight:700">vs</span>`}
            <span class="ubadge${bWin&&hasResult?'':hasResult?' loser':''}" style="background:${cb}">${tB}</span>
            ${hasResult?(aWin?`<span style="font-size:12px;font-weight:800;color:${ca}">â–¶ ${tA} ìŠ¹</span>`:bWin?`<span style="font-size:12px;font-weight:800;color:${cb}">â–¶ ${tB} ìŠ¹</span>`:'<span style="color:var(--gray-l)">ë¬´ìŠ¹ë¶€</span>'):'<span style="font-size:11px;color:var(--gray-l)">ê²°ê³¼ ë¯¸ì…ë ¥</span>'}
            <div style="margin-left:auto;display:flex;gap:4px;align-items:center" class="no-export">
            <button id="detbtn-${detKey}" class="btn-detail" onclick="toggleDetail('${detKey}')">â–¼ ìƒì„¸ ë³´ê¸°</button>
            <button class="btn btn-p btn-xs" onclick="openRCalMatchShareCard('${calDayDate}',${mi})">ğŸ´ ê³µìœ  ì¹´ë“œ</button>
          </div>
          </div>
          <div id="det-${detKey}" class="rec-detail-area" style="padding:12px 16px">
            ${detHTML}
            ${hasResult?`<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);display:flex;gap:6px" class="no-export">
              <button class="btn-capture btn-xs" onclick="captureDetail('det-${detKey}','${calDayDate}_match')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
              <button class="btn btn-p btn-xs" onclick="openRCalMatchShareCard('${calDayDate}',${mi})">ğŸ´ ê³µìœ  ì¹´ë“œ</button>
            </div>`:''}
          </div>
        </div>`;
      }).join('');
    }
  }

  C.innerHTML=`
  <div>
    <!-- ì»¨íŠ¸ë¡¤ ë°” -->
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap">
      ${navHTML}
      <div style="margin-left:auto;display:flex;gap:4px">
        <button class="btn btn-sm ${calView==='month'?'btn-b':'btn-w'}" onclick="calView='month';render()">ì›”ê°„</button>
        <button class="btn btn-sm ${calView==='week'?'btn-b':'btn-w'}" onclick="calWeekOffset=0;calView='week';render()">ì£¼ê°„</button>
        <button class="btn btn-sm ${calView==='day'?'btn-b':'btn-w'}" onclick="calDayDate='${todayStr}';calView='day';render()">ì¼ê°„</button>
      </div>
    </div>
    <!-- ìº˜ë¦°ë” ë³¸ë¬¸ -->
    <div style="background:var(--white);border:1px solid var(--border);border-radius:10px;padding:12px;overflow-x:auto">
      ${calHTML}
    </div>
    <!-- ì„ íƒ ë‚ ì§œ ê²½ê¸° ëª©ë¡ (ì›”ê°„ë·°ìš©) -->
    <div id="calDayDetail" style="margin-top:14px"></div>
  </div>`;
}

let _calActiveDay='';
let _calDetailState={}; // ìº˜ë¦°ë” ì „ìš© ìƒì„¸ ì—´ë¦¼ ìƒíƒœ

function calToggleDetail(key){
  const area=document.getElementById('det-'+key);
  const btn=document.getElementById('detbtn-'+key);
  if(!area)return;
  _calDetailState[key]=!_calDetailState[key];
  const isOpen=!!_calDetailState[key];
  area.style.display=isOpen?'block':'none';
  if(btn){btn.classList.toggle('open',isOpen);btn.textContent=isOpen?'â–² ë‹«ê¸°':'â–¼ ìƒì„¸';}
}

function calShowDay(ds){
  const el=document.getElementById('calDayDetail');
  if(!el)return;
  // ê°™ì€ ë‚ ì§œ ë‹¤ì‹œ í´ë¦­ â†’ ë‹«ê¸°
  if(_calActiveDay===ds){
    _calActiveDay='';
    _calDetailState={};
    el.style.animation='';
    el.innerHTML='';
    render();
    return;
  }
  _calActiveDay=ds;
  _calDetailState={}; // ë‚ ì§œ ë³€ê²½ ì‹œ ìƒì„¸ ìƒíƒœ ì´ˆê¸°í™”
  const allMatches=[...miniM,...univM,...comps,...ckM,...proM,...(typeof getTourneyMatches==='function'?getTourneyMatches():[])];
  const matches=allMatches.filter(m=>m.d===ds);
  // ê³µìœ ì¹´ë“œìš© ìºì‹œ - ë‚ ì§œë³„ ë§¤ì¹˜ ë°°ì—´ ì €ì¥
  if(!window._calDayCache)window._calDayCache={};
  window._calDayCache[ds]=matches;

  function buildMatchRow(m,mi){
    if(m.sa==null||m.sa==='') return ''; // ë¯¸ì…ë ¥ í•­ëª© ì œì™¸
    const isCKorPro=ckM.includes(m)||proM.includes(m);
    const tA=isCKorPro?'AíŒ€':(m.a||'');
    const tB=isCKorPro?'BíŒ€':(m.b||'');
    const ca=isCKorPro?'#2563eb':gc(m.a||'');
    const cb=isCKorPro?'#dc2626':gc(m.b||'');
    const aWin=(m.sa??-1)>(m.sb??-1);const bWin=(m.sb??-1)>(m.sa??-1);
    const typeBg=miniM.includes(m)?'#2563eb':univM.includes(m)?'#7c3aed':ckM.includes(m)?'#d97706':proM.includes(m)?'#7c3aed':'#16a34a';
    const typeLabel=miniM.includes(m)?'âš¡ ë¯¸ë‹ˆëŒ€ì „':univM.includes(m)?'ğŸŸï¸ ëŒ€í•™ëŒ€ì „':ckM.includes(m)?'ğŸ¤ ëŒ€í•™CK':proM.includes(m)?'ğŸ… í”„ë¡œë¦¬ê·¸':'ğŸ–ï¸ ëŒ€íšŒ';
    const detKey='caldm-'+ds+'-'+mi;
    const modeKey=miniM.includes(m)?'mini':univM.includes(m)?'univm':ckM.includes(m)?'ck':proM.includes(m)?'pro':'comp';
    const detHTML=buildDetailHTML(m,modeKey,tA,tB,ca,cb,aWin,bWin);
    const winLabel=aWin?'â–¶ '+tA+' ìŠ¹':bWin?'â–¶ '+tB+' ìŠ¹':'ë¬´ìŠ¹ë¶€';
    const winColor=aWin?ca:bWin?cb:'#888';
    return '<div class="rec-summary" style="margin-bottom:6px">'
      +'<div class="rec-sum-header" style="cursor:pointer" onclick="calToggleDetail(\''+detKey+'\')">'
      +'<span style="background:'+typeBg+';color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700">'+typeLabel+'</span>'
      +'<div class="rec-sum-vs" style="flex:1">'
      +'<span class="ubadge'+(aWin?'':' loser')+'" style="background:'+ca+'">'+tA+'</span>'
      +'<div class="rec-sum-score score-click" onclick="event.stopPropagation();calToggleDetail(\''+detKey+'\')" title="í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°/ë‹«ê¸°">'
      +'<span class="'+(aWin?'wt':bWin?'lt':'pt-z')+'">'+m.sa+'</span>'
      +'<span style="color:var(--gray-l);font-size:14px"> : </span>'
      +'<span class="'+(bWin?'wt':aWin?'lt':'pt-z')+'">'+m.sb+'</span>'
      +'</div>'
      +'<span class="ubadge'+(bWin?'':' loser')+'" style="background:'+cb+'">'+tB+'</span>'
      +'<span style="font-size:12px;font-weight:700;color:'+winColor+'">'+winLabel+'</span>'
      +'</div>'
      +'<div class="no-export" style="margin-left:auto;display:flex;gap:4px;align-items:center">'
      +'<button id="detbtn-'+detKey+'" class="btn-detail" onclick="event.stopPropagation();calToggleDetail(\''+detKey+'\')">â–¼ ìƒì„¸</button>'
      +'</div>'
      +'</div>'
      +'<div id="det-'+detKey+'" style="display:none;padding:10px 14px;background:var(--surface);border-top:1px solid var(--border)">'
      +detHTML
      +'<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">'
      +'<button class="btn-capture btn-xs no-export" onclick="captureDetail(\'det-'+detKey+'\',\''+ds+'_match\')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>'
      +' <button class="btn btn-p btn-xs no-export" onclick="openCalMatchShareCardByCache(\''+ds+'\','+mi+');event.stopPropagation()">ğŸ´ ê³µìœ  ì¹´ë“œ</button>'
      +'</div>'
      +'</div>'
      +'</div>';
  }

  el.style.animation='fadeIn .2s';
  el.innerHTML='<div class="ssec" style="border:2px solid var(--blue);animation:fadeIn .2s">'
    +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">'
    +'<h4 style="margin:0;color:var(--blue)">ğŸ“… '+ds+' ê²½ê¸° ëª©ë¡ <span style="font-size:12px;font-weight:400;color:var(--gray-l)">'+matches.length+'ê²½ê¸°</span></h4>'
    +'<div style="display:flex;gap:6px">'
    +'<button class="btn btn-b btn-sm" onclick="calDayDate=\''+ds+'\';calView=\'day\';render()">ğŸ“‹ ì¼ê°„ ìƒì„¸ë³´ê¸°</button>'
    +'<button class="btn btn-w btn-sm" onclick="captureDetail(&quot;calDayDetail&quot;,&quot;ìº˜ë¦°ë”_&quot;+(new Date().toLocaleDateString()))" style="margin-right:4px">ğŸ“· ì €ì¥</button>'+'<button class="btn btn-w btn-sm" onclick="_calActiveDay=\'\';document.getElementById(\'calDayDetail\').innerHTML=\'\'">âœ• ë‹«ê¸°</button>'
    +'</div></div>'
    +matches.map(buildMatchRow).join('')
    +'</div>';
  // render() ì œê±° - í˜¸ì¶œí•˜ë©´ rCalì´ ì¬ì‹¤í–‰ë˜ì–´ calDayDetailì´ ì´ˆê¸°í™”ë¨
}


function swNav(t,el){
  document.querySelectorAll('.bnav-item').forEach(b=>b.classList.remove('on'));
  if(el) el.classList.add('on');
  // íƒ­ ì „í™˜ ì‹œ ì„œë¸Œíƒ­ ìƒíƒœ ì´ˆê¸°í™”
  if(t==='comp'){compSub='league';leagueFilterDate='';leagueFilterGrp='';grpRankFilter='';}
  if(t==='mini')miniSub='records';
  if(t==='univck')ckSub='records';
  if(t==='univm')univmSub='records';
  if(t==='pro')proSub='records';
  if(t==='hist')histSub='mini';
  // íƒ­ë²„íŠ¼ ì°¾ì•„ì„œ sw í˜¸ì¶œ (ë°ìŠ¤í¬íƒ‘ íƒ­ UI ë™ê¸°í™”)
  let found=false;
  document.querySelectorAll('.tab').forEach(b=>{
    const oc=b.getAttribute('onclick')||'';
    if(oc.includes("'"+t+"'")){sw(t,b);found=true;}
  });
  // íƒ­ ë²„íŠ¼ì´ ì—†ëŠ” ê²½ìš°(ëª¨ë°”ì¼ ì „ìš© íƒ­ ë“±) ì§ì ‘ ë Œë”ë§
  if(!found){
    curTab=t;openDetails={};
    const fstrip=document.getElementById('fstrip');
    if(fstrip) fstrip.style.display=(t==='total'&&isLoggedIn)?'block':'none';
    const C=document.getElementById('rcont');
    if(C) C.innerHTML='';
    render();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ¯ ìŠ¹ë¶€ì˜ˆì¸¡ ì‹œìŠ¤í…œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveVotes(){ localStorage.setItem('su_votes', JSON.stringify(voteData)); }

function rVote(C,T){
  T.textContent='ğŸ¯ ìŠ¹ë¶€ì˜ˆì¸¡';

  // ì˜ˆì •/ì§„í–‰ì¤‘ ê²½ê¸° ìˆ˜ì§‘ (ê²°ê³¼ ì—†ëŠ” ë¯¸ë‹ˆëŒ€ì „)
  const upcoming = miniM.filter(m=> m.sa==null || m.sa===''); // null/undefined/ë¹ˆë¬¸ìì—´=ë¯¸ì…ë ¥, sa=0ë„ ì™„ë£Œë¡œ ì •ìƒ ì²˜ë¦¬
  // ê²°ê³¼ ìˆëŠ” ê²½ê¸°
  const finished = miniM.filter(m=> m.sa!=null && m.sa!==''); // ìˆ«ì(0í¬í•¨)ê°€ ìˆìœ¼ë©´ ì™„ë£Œ ê²½ê¸°

  function getVoteKey(m){ return m._id||`${m.a}_${m.b}_${m.d}`; }

  function voteBar(key, side){
    const v = voteData[key]||{a:0,b:0};
    const total = v.a+v.b;
    const myVote = voteData[key+'_my'];
    const pctA = total===0?50:Math.round(v.a/total*100);
    const pctB = 100-pctA;
    const aCol = gc((miniM.find(m=>getVoteKey(m)===key)||{}).a||'');
    const bCol = gc((miniM.find(m=>getVoteKey(m)===key)||{}).b||'');
    return `
      <div style="margin-top:10px">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--gray-l);margin-bottom:4px">
          <span>ğŸ—³ï¸ ì´ ${total}í‘œ</span>
          ${myVote?`<span style="color:var(--blue);font-weight:700">âœ… ë‚´ ì˜ˆì¸¡: ${myVote==='a'?(miniM.find(m=>getVoteKey(m)===key)||{}).a||'A':(miniM.find(m=>getVoteKey(m)===key)||{}).b||'B'}</span>`:''}
        </div>
        <div style="display:flex;height:22px;border-radius:20px;overflow:hidden;background:#f1f5f9">
          <div style="width:${pctA}%;background:${aCol||'var(--blue)'};display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:700;transition:.4s">${pctA}%</div>
          <div style="width:${pctB}%;background:${bCol||'var(--red)'};display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:700;transition:.4s">${pctB}%</div>
        </div>
      </div>`;
  }

  C.innerHTML=`
  <div style="display:flex;flex-direction:column;gap:16px">

    <!-- ì˜ˆì¸¡ ê°€ëŠ¥í•œ ê²½ê¸° -->
    <div class="ssec">
      <h4>ğŸ¯ ìŠ¹ë¶€ì˜ˆì¸¡</h4>
      ${upcoming.length===0
        ? '<p style="color:var(--gray-l);font-size:13px">ì˜ˆì¸¡ ê°€ëŠ¥í•œ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.<br><span style="font-size:11px">ë¯¸ë‹ˆëŒ€ì „ì—ì„œ ê²°ê³¼ ë¯¸ì…ë ¥ ê²½ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</span></p>'
        : upcoming.map(m=>{
            const key=getVoteKey(m);
            const v=voteData[key]||{a:0,b:0};
            const myVote=voteData[key+'_my'];
            const aCol=gc(m.a||'');
            const bCol=gc(m.b||'');
            return `<div style="background:var(--white);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px">
              <div style="font-size:11px;color:var(--gray-l);margin-bottom:8px">ğŸ“… ${m.d||'ë‚ ì§œ ë¯¸ì •'}</div>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                <div style="flex:1;text-align:center;padding:10px;background:${aCol}22;border-radius:8px;border:2px solid ${myVote==='a'?aCol:'transparent'}">
                  <div style="font-weight:800;color:${aCol}">${m.a||'íŒ€A'}</div>
                </div>
                <div style="font-weight:900;color:var(--gray-l);font-size:18px">VS</div>
                <div style="flex:1;text-align:center;padding:10px;background:${bCol}22;border-radius:8px;border:2px solid ${myVote==='b'?bCol:'transparent'}">
                  <div style="font-weight:800;color:${bCol}">${m.b||'íŒ€B'}</div>
                </div>
              </div>
              ${voteBar(key)}
              ${myVote
                ? `<button class="btn btn-w btn-sm" style="width:100%;margin-top:10px" onclick="cancelVote('${key}')">ğŸ”„ ì˜ˆì¸¡ ì·¨ì†Œ</button>`
                : `<div style="display:flex;gap:8px;margin-top:10px">
                    <button class="btn btn-sm" style="flex:1;background:${aCol};color:#fff;border-color:${aCol}" onclick="doVote('${key}','a')">${m.a||'íŒ€A'} ìŠ¹ë¦¬</button>
                    <button class="btn btn-sm" style="flex:1;background:${bCol};color:#fff;border-color:${bCol}" onclick="doVote('${key}','b')">${m.b||'íŒ€B'} ìŠ¹ë¦¬</button>
                  </div>`
              }
            </div>`;
          }).join('')
      }
    </div>

    <!-- ì˜ˆì¸¡ ê²°ê³¼ í™•ì¸ -->
    <div class="ssec">
      <h4>ğŸ† ì˜ˆì¸¡ ê²°ê³¼</h4>
      ${finished.length===0
        ? '<p style="color:var(--gray-l);font-size:13px">ê²°ê³¼ê°€ ë‚˜ì˜¨ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
        : finished.map(m=>{
            const key=getVoteKey(m);
            const v=voteData[key]||{a:0,b:0};
            const myVote=voteData[key+'_my'];
            const winner=m.sa>m.sb?'a':'b';
            const correct=myVote&&myVote===winner;
            const voted=!!myVote;
            const aCol=gc(m.a||'');
            const bCol=gc(m.b||'');
            const total=v.a+v.b;
            const pctA=total===0?50:Math.round(v.a/total*100);
            return `<div style="background:var(--white);border:1px solid ${voted?(correct?'var(--green)':'var(--red)'):'var(--border)'};border-radius:12px;padding:14px;margin-bottom:8px;opacity:${voted?1:0.7}">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                <span style="font-size:11px;color:var(--gray-l)">ğŸ“… ${m.d||''}</span>
                ${voted?`<span style="font-size:12px;font-weight:700;color:${correct?'var(--green)':'var(--red)'}">${correct?'âœ… ì˜ˆì¸¡ ì„±ê³µ!':'âŒ ì˜ˆì¸¡ ì‹¤íŒ¨'}</span>`:'<span style="font-size:11px;color:var(--gray-l)">ì˜ˆì¸¡ ì•ˆí•¨</span>'}
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div style="flex:1;text-align:center;font-weight:${m.sa>m.sb?'900':'400'};color:${m.sa>m.sb?aCol:'var(--gray-l)'}">
                  ${m.sa>m.sb?'ğŸ† ':''} ${m.a||'íŒ€A'}
                </div>
                <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px">${m.sa} : ${m.sb}</div>
                <div style="flex:1;text-align:center;font-weight:${m.sb>m.sa?'900':'400'};color:${m.sb>m.sa?bCol:'var(--gray-l)'}">
                  ${m.sb>m.sa?'ğŸ† ':''} ${m.b||'íŒ€B'}
                </div>
              </div>
              <div style="margin-top:8px">
                <div style="display:flex;height:18px;border-radius:20px;overflow:hidden;background:#f1f5f9">
                  <div style="width:${pctA}%;background:${aCol};transition:.4s"></div>
                  <div style="width:${100-pctA}%;background:${bCol};transition:.4s"></div>
                </div>
                <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--gray-l);margin-top:3px">
                  <span>${pctA}% (${v.a}í‘œ)</span><span>${100-pctA}% (${v.b}í‘œ)</span>
                </div>
              </div>
            </div>`;
          }).join('')
      }
    </div>

  </div>`;
}

function doVote(key, side){
  if(voteData[key+'_my']){ alert('ì´ë¯¸ ì˜ˆì¸¡í–ˆìŠµë‹ˆë‹¤!'); return; }
  if(!voteData[key]) voteData[key]={a:0,b:0};
  voteData[key][side]++;
  voteData[key+'_my']=side;
  saveVotes();
  render();
}

function cancelVote(key){
  const side=voteData[key+'_my'];
  if(!side)return;
  if(!confirm('ì˜ˆì¸¡ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  if(voteData[key]) voteData[key][side]=Math.max(0,voteData[key][side]-1);
  delete voteData[key+'_my'];
  saveVotes();
  render();
}

function sf(u,t){fUniv=u;fTier=t;render();}
function fsearch(type){
  const id=type==='w'?'ws':'ls';const lid=type==='w'?'wl':'ll';
  const v=document.getElementById(id).value.toLowerCase();
  const d=document.getElementById(lid);
  const f=players.filter(p=>p.name.toLowerCase().includes(v));
  if(v&&f.length){d.innerHTML=f.map(p=>`<div class="sitem" onclick="selP('${type}','${p.name}')">${p.name} <span style="color:var(--gray-l);font-size:11px">(${p.univ})</span></div>`).join('');d.style.display='block';}
  else d.style.display='none';
}
function selP(type,name){document.getElementById(type==='w'?'ws':'ls').value=name;document.getElementById(type==='w'?'wl':'ll').style.display='none';}
function upTour(i,v){tourD[i]=v;save();render();}
function om(id){const el=document.getElementById(id);if(el)el.style.display='block';}
function cm(id){
  const el=document.getElementById(id);
  if(el)el.style.display='none';
}
window.addEventListener('click',e=>{
  if(e.target.classList.contains('modal')){
    e.target.style.display='none';
  }
  if(!e.target.closest('.swrap'))document.querySelectorAll('.sdrop').forEach(d=>d.style.display='none');
});

async function doJpg(){
  const actionBar=document.getElementById('actionBar');
  const bottomNav=document.getElementById('bottomNav');
  const fstrip=document.getElementById('fstrip');
  const mobileActionBar=document.getElementById('mobileActionBar');
  const abOrig=actionBar?actionBar.style.display:'';
  const bnOrig=bottomNav?bottomNav.style.display:'';
  const fsOrig=fstrip?fstrip.style.display:'';
  const maOrig=mobileActionBar?mobileActionBar.style.display:'';
  // no-export ìš”ì†Œë“¤ì˜ ì›ë˜ style.display ì €ì¥ (ë³µì› ì‹œ ì •í™•íˆ ë˜ëŒë¦¬ê¸° ìœ„í•´)
  const noExportSaved=[...document.querySelectorAll('.no-export')].map(e=>({e,d:e.style.display}));
  function restoreAll(){
    noExportSaved.forEach(({e,d})=>e.style.display=d);
    if(actionBar)actionBar.style.display=abOrig;
    if(bottomNav)bottomNav.style.display=bnOrig;
    if(fstrip)fstrip.style.display=fsOrig;
    if(mobileActionBar)mobileActionBar.style.display=maOrig;
  }
  try{
    document.querySelectorAll('.no-export').forEach(e=>e.style.display='none');
    if(actionBar)actionBar.style.display='none';
    if(bottomNav)bottomNav.style.display='none';
    if(fstrip)fstrip.style.display='none';
    if(mobileActionBar)mobileActionBar.style.display='none';
    const cap=document.getElementById('cap');
    const origStyle=cap.getAttribute('style')||'';
    cap.style.maxWidth='900px';cap.style.margin='0 auto';cap.style.padding='24px';
    const canvas=await html2canvas(cap,{backgroundColor:'#fff',useCORS:true,scale:2,logging:false});
    cap.setAttribute('style',origStyle);
    restoreAll();
    // ìº”ë²„ìŠ¤ë¥¼ ê°€ìš´ë° ì—¬ë°± ì¶”ê°€í•´ì„œ ìƒˆ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
    const pad=40;
    const out=document.createElement('canvas');
    out.width=canvas.width+pad*2;out.height=canvas.height+pad*2;
    const ctx=out.getContext('2d');
    ctx.fillStyle='#f1f5f9';ctx.fillRect(0,0,out.width,out.height);
    ctx.drawImage(canvas,pad,pad);
    const tabNames={total:'ìŠ¤íŠ¸ë¦¬ë¨¸',tier:'í‹°ì–´ìˆœìœ„',mini:'ë¯¸ë‹ˆëŒ€ì „',univm:'ëŒ€í•™ëŒ€ì „',univck:'ëŒ€í•™CK',comp:'ëŒ€íšŒ',pro:'í”„ë¡œë¦¬ê·¸',hist:'ëŒ€ì „ê¸°ë¡',stats:'í†µê³„',cal:'ìº˜ë¦°ë”'};
    const fname=`ìŠ¤íƒ€ëŒ€í•™_${tabNames[curTab]||curTab}_${new Date().toISOString().slice(0,10)}.jpg`;
    const dataUrl=out.toDataURL('image/jpeg',.93);
    const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;
    if(isIOS){
      const w=window.open('','_blank');
      if(w){w.document.write(`<img src="${dataUrl}" style="max-width:100%"><br><p style="text-align:center;font-size:14px">ê¸¸ê²Œ ëˆŒëŸ¬ì„œ ì €ì¥í•˜ì„¸ìš”</p>`);w.document.close();}
      else alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
    }else{
      const a=document.createElement('a');a.download=fname;a.href=dataUrl;
      document.body.appendChild(a);a.click();setTimeout(()=>document.body.removeChild(a),100);
    }
  }catch(e){
    restoreAll();
    alert('ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜: '+e.message);
  }
}



/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë¡œê·¸ì¸ ì‹œìŠ¤í…œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// SHA-256 ì•”í˜¸í™”
async function sha256(str){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
const ADMIN_HASH_KEY='su_admin_hashes'; // ë°°ì—´ë¡œ ì €ì¥ (ë‹¤ì¤‘ ê´€ë¦¬ì)
async function initLoginHash(){
  if(!localStorage.getItem(ADMIN_HASH_KEY)){
    const h=await sha256('admin99:99admin');
    // ê¸°ì¡´ ë‹¨ì¼í‚¤ë„ ë§ˆì´ê·¸ë ˆì´ì…˜
    const oldH=localStorage.getItem('su_admin_hash');
    const arr=oldH?[oldH,h]:[h];
    localStorage.setItem(ADMIN_HASH_KEY,JSON.stringify(arr));
  }
}
function getAdminHashes(){
  try{
    const raw=localStorage.getItem(ADMIN_HASH_KEY);
    if(!raw)return [];
    const parsed=JSON.parse(raw);
    return Array.isArray(parsed)?parsed:[parsed];
  }catch{return [];}
}
let isLoggedIn=false;

async function doLogin(){
  const id=document.getElementById('li-id').value.trim();
  const pw=document.getElementById('li-pw').value;
  const err=document.getElementById('li-err');
  if(!id||!pw){err.textContent='ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';return;}
  const inputHash=await sha256(id+':'+pw);
  const hashes=getAdminHashes();
  if(hashes.includes(inputHash)){
    isLoggedIn=true;
    cm('loginModal');
    document.getElementById('li-id').value='';
    document.getElementById('li-pw').value='';
    document.getElementById('li-err').textContent='';
    applyLoginState();
  } else {
    err.textContent='ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    document.getElementById('li-pw').value='';
  }
}

function doLogout(){
  isLoggedIn=false;
  if(['member','cfg'].includes(curTab)){curTab='total';document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));document.querySelector('.tab').classList.add('on');}
  if(['grpedit','input'].includes(compSub)) compSub='league';
  applyLoginState();
}

function applyLoginState(){
  // í—¤ë” ë²„íŠ¼ í‘œì‹œ
  document.getElementById('hdrLoginBtn').style.display=isLoggedIn?'none':'';
  document.getElementById('hdrLogoutBtn').style.display=isLoggedIn?'':'none';
  document.getElementById('hdrLoginStatus').style.display=isLoggedIn?'':'none';
  // ì ê¸ˆ ìš”ì†Œ
  document.querySelectorAll('.lock-admin').forEach(el=>{
    el.classList.toggle('locked',!isLoggedIn);
  });
  // ê´€ë¦¬ì ì „ìš© íƒ­ (íšŒì›ê´€ë¦¬, ì„¤ì •)
  const ADMIN_TABS=['tabMember','tabCfg'];
  ADMIN_TABS.forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.display=isLoggedIn?'':'none';
  });
  // ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ â€” ë¡œê·¸ì¸ ì‹œì—ë§Œ í‘œì‹œ
  const exportHint=document.getElementById('exportHint');
  if(exportHint)exportHint.style.display=isLoggedIn?'':'none';
  const exportVis=document.getElementById('btnExportVis');
  const importVis=document.getElementById('btnImportVis');
  if(exportVis)exportVis.style.display=isLoggedIn?'flex':'none';
  if(importVis)importVis.style.display=isLoggedIn?'flex':'none';
  // ìŠ¤íŠ¸ë¦¬ë¨¸ ë“±ë¡/ê²½ê¸° ê¸°ë¡ ì…ë ¥í¼ â€” ë¡œê·¸ì¸ + ìŠ¤íŠ¸ë¦¬ë¨¸ íƒ­ì¼ ë•Œë§Œ í‘œì‹œ
  const fstrip=document.getElementById('fstrip');
  if(fstrip){
    if(!isLoggedIn){fstrip.style.display='none';}
    else{fstrip.style.display=(curTab==='total')?'block':'none';}
  }
  render();
}

// ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ â€” ë¹„ë¡œê·¸ì¸ ì‹œ ìˆ¨ê¹€
function adminBtn(html){
  return isLoggedIn ? html : '';
}
function doExport(){
  try{
    const b=new Blob([JSON.stringify({players,univCfg,maps,tourD,miniM,univM,comps,ckM,compNames,curComp,proM,tiers:TIERS,members,tourneys},null,2)],{type:'application/json'});
    const url=URL.createObjectURL(b);
    const a=document.createElement('a');
    a.href=url;a.download='star_backup.json';
    document.body.appendChild(a);a.click();
    setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},100);
  }catch(e){alert('ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜: '+e.message);}
}

function doImport(){document.getElementById('fi').click();}
function doFile(inp){
  const r=new FileReader();
  r.onload=e=>{
    try{
      const d=JSON.parse(e.target.result);
      players=d.players||[];univCfg=d.univCfg||univCfg;maps=d.maps||maps;tourD=d.tourD||Array(15).fill('');
      if(d.tiers&&d.tiers.length)TIERS.splice(0,TIERS.length,...d.tiers);
      miniM=d.miniM||[];univM=d.univM||[];comps=d.comps||[];ckM=d.ckM||[];
      compNames=d.compNames||[];curComp=d.curComp||'';
      proM=d.proM||[];
      members=d.members||[];tourneys=d.tourneys||[];ttM=d.ttM||[];
      window._compListCache={};window._shareAllMatchesCached=null;
      (function(){
        const allD=[...miniM,...univM,...comps,...ckM,...proM];
        const years=new Set(allD.map(m=>(m.d||'').slice(0,4)).filter(y=>/^\d{4}$/.test(y)));
        years.forEach(y=>{if(!yearOptions.includes(y))yearOptions.push(y);});
        yearOptions.sort();
      })();
      filterYear='ì „ì²´';filterMonth='ì „ì²´';
      fixPoints();save();init();
    }catch{alert('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜');}
  };
  r.readAsText(inp.files[0]);
}

function refreshSel(){
  const allU=getAllUnivs();
  document.getElementById('p-univ').innerHTML=allU.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
  document.getElementById('m-map').innerHTML=maps.map(m=>`<option value="${m}">${m}</option>`).join('');
}
function openGameEditModal(editRef, si, gi){
  const [mode, idxStr]=editRef.split(':');
  const idx=parseInt(idxStr);
  const arr=mode==='mini'?miniM:mode==='univm'?univM:mode==='ck'?ckM:mode==='pro'?proM:mode==='tt'?ttM:mode==='comp'?comps:null;
  if(!arr)return;
  const m=arr[idx];if(!m)return;
  const set=m.sets&&m.sets[si];if(!set)return;
  const g=set.games&&set.games[gi];if(!g)return;

  // í•´ë‹¹ ê²½ê¸°ì— ë›´ íŒ€ ë©¤ë²„ë§Œ ì¶”ì¶œ
  const isCKmode=(mode==='ck'||mode==='pro'||mode==='tt');
  let teamANames=[], teamBNames=[];
  if(isCKmode){
    teamANames=(m.teamAMembers||[]).map(x=>x.name);
    teamBNames=(m.teamBMembers||[]).map(x=>x.name);
  } else {
    // mini/univm: ê°™ì€ ëŒ€í•™ ì„ ìˆ˜ë“¤
    const univA=m.a||''; const univB=m.b||'';
    teamANames=players.filter(p=>p.univ===univA).map(p=>p.name).sort();
    teamBNames=players.filter(p=>p.univ===univB).map(p=>p.name).sort();
  }

  const mapOpts=maps.map(mp=>`<option value="${mp}"${g.map===mp?' selected':''}>${mp}</option>`).join('');
  const modal=document.createElement('div');
  modal.className='modal';modal.style.display='flex';
  modal.innerHTML=`<div class="mbox" style="max-width:460px">
    <div class="mtitle">âœï¸ ê²½ê¸° ìˆ˜ì • (${si===2?'ì—ì´ìŠ¤ì „':(si+1)+'ì„¸íŠ¸'} Â· ê²½ê¸°${gi+1})</div>
    <div style="display:flex;flex-direction:column;gap:10px;padding:4px 0 16px">
      <div style="display:flex;gap:8px;align-items:center">
        <label style="font-size:12px;font-weight:700;color:#2563eb;min-width:60px">ğŸ”µ AíŒ€ ì„ ìˆ˜</label>
        <select id="gem-pA" style="flex:1">
          <option value="">â€”ì„ íƒâ€”</option>
          ${teamANames.map(n=>`<option value="${n}"${g.playerA===n?' selected':''}>${n}</option>`).join('')}
        </select>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="font-size:12px;font-weight:700;color:#dc2626;min-width:60px">ğŸ”´ BíŒ€ ì„ ìˆ˜</label>
        <select id="gem-pB" style="flex:1">
          <option value="">â€”ì„ íƒâ€”</option>
          ${teamBNames.map(n=>`<option value="${n}"${g.playerB===n?' selected':''}>${n}</option>`).join('')}
        </select>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="font-size:12px;font-weight:700;min-width:60px">ìŠ¹ì</label>
        <select id="gem-winner" style="flex:1">
          <option value="">(ë¯¸ì •)</option>
          <option value="A"${g.winner==='A'?' selected':''}>ğŸ”µ AíŒ€ ìŠ¹</option>
          <option value="B"${g.winner==='B'?' selected':''}>ğŸ”´ BíŒ€ ìŠ¹</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="font-size:12px;font-weight:700;min-width:60px">ë§µ</label>
        <select id="gem-map" style="flex:1"><option value="">ë§µ ì—†ìŒ</option>${mapOpts}</select>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-w btn-sm" onclick="this.closest('.modal').remove()">ì·¨ì†Œ</button>
      <button class="btn btn-g btn-sm" onclick="saveGameEdit('${editRef}',${si},${gi},this)">âœ… ì €ì¥</button>
    </div>
  </div>`;
  document.body.appendChild(modal);
}

function saveGameEdit(editRef, si, gi, btn){
  const [mode, idxStr]=editRef.split(':');
  const idx=parseInt(idxStr);
  const arr=mode==='mini'?miniM:mode==='univm'?univM:mode==='ck'?ckM:mode==='pro'?proM:mode==='tt'?ttM:mode==='comp'?comps:null;
  if(!arr)return;
  const m=arr[idx];if(!m)return;
  const set=m.sets&&m.sets[si];if(!set)return;
  const g=set.games&&set.games[gi];if(!g)return;

  // pro ì™¸ ëª¨ë“œ: ê¸°ì¡´ ì´ ê²Œì„ì˜ ì„ ìˆ˜ history ë˜ëŒë¦¬ê¸°
  if(mode!=='pro' && g.playerA && g.playerB && g.winner){
    const oldWin=g.winner==='A'?g.playerA:g.playerB;
    const oldLose=g.winner==='A'?g.playerB:g.playerA;
    const mid=m._id||null;
    const mdate=m.d||'';
    const wP=players.find(p=>p.name===oldWin);
    const lP=players.find(p=>p.name===oldLose);
    if(wP){
      wP.win=Math.max(0,(wP.win||0)-1);
      wP.points=(wP.points||0)-3;
      let wi=mid?wP.history.findIndex(h=>h.matchId===mid&&h.result==='ìŠ¹'&&h.opp===oldLose):-1;
      if(wi<0)wi=wP.history.findIndex(h=>h.result==='ìŠ¹'&&h.opp===oldLose&&h.date===mdate);
      if(wi>=0){const hr=wP.history[wi];if(hr.eloDelta!=null)wP.elo=(wP.elo||ELO_DEFAULT)-hr.eloDelta;wP.history.splice(wi,1);}
    }
    if(lP){
      lP.loss=Math.max(0,(lP.loss||0)-1);
      lP.points=(lP.points||0)+3;
      let li=mid?lP.history.findIndex(h=>h.matchId===mid&&h.result==='íŒ¨'&&h.opp===oldWin):-1;
      if(li<0)li=lP.history.findIndex(h=>h.result==='íŒ¨'&&h.opp===oldWin&&h.date===mdate);
      if(li>=0){const hr=lP.history[li];if(hr.eloDelta!=null)lP.elo=(lP.elo||ELO_DEFAULT)-hr.eloDelta;lP.history.splice(li,1);}
    }
  }

  // ê²Œì„ ë°ì´í„° ì—…ë°ì´íŠ¸
  const newPA=document.getElementById('gem-pA').value||g.playerA;
  const newPB=document.getElementById('gem-pB').value||g.playerB;
  const newWinner=document.getElementById('gem-winner').value||g.winner;
  const newMap=document.getElementById('gem-map').value||g.map;
  g.playerA=newPA; g.playerB=newPB; g.winner=newWinner; g.map=newMap;

  // pro ì™¸ ëª¨ë“œ: ìƒˆ ê²°ê³¼ ì„ ìˆ˜ historyì— ë°˜ì˜
  if(mode!=='pro' && newPA && newPB && newWinner){
    applyGameResult(
      newWinner==='A'?newPA:newPB,
      newWinner==='A'?newPB:newPA,
      m.d||'', newMap||'-', m._id||''
    );
  }

  // ì„¸íŠ¸/ì´ì  ì¬ê³„ì‚°
  let sA=0,sB=0;
  (set.games||[]).forEach(gg=>{if(gg.winner==='A')sA++;else if(gg.winner==='B')sB++;});
  set.scoreA=sA;set.scoreB=sB;
  set.winner=sA>sB?'A':sB>sA?'B':'';
  let tA=0,tB=0;
  (m.sets||[]).forEach(s=>{if(s.winner==='A')tA++;else if(s.winner==='B')tB++;});
  m.sa=tA;m.sb=tB;
  save();
  btn.closest('.modal').remove();
  render();
}

async function captureStats(){
  const el=document.getElementById('stats-univ-sec');
  if(!el){alert('ìº¡ì²˜í•  ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
  try{
    const canvas=await html2canvas(el,{backgroundColor:'#ffffff',scale:2,useCORS:true});
    const a=document.createElement('a');a.download=`stats_${new Date().toISOString().slice(0,10)}.jpg`;
    a.href=canvas.toDataURL('image/jpeg',.93);a.click();
  }catch(e){alert('ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜: '+e.message);}
}

async function captureSection(sectionId, filename){
  const el=document.getElementById(sectionId);
  if(!el){alert('ìº¡ì²˜í•  ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
  try{
    const canvas=await html2canvas(el,{backgroundColor:'#ffffff',scale:2,useCORS:true,logging:false});
    const a=document.createElement('a');
    a.download=`${filename||sectionId}_${new Date().toISOString().slice(0,10)}.jpg`;
    a.href=canvas.toDataURL('image/jpeg',.93);a.click();
  }catch(e){alert('ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜: '+e.message);}
}

function toggleDark(){
  const isDark=document.body.classList.toggle('dark');
  localStorage.setItem('su_dark',isDark?'1':'');
  document.getElementById('darkToggleBtn').textContent=isDark?'â˜€ï¸ ë¼ì´íŠ¸':'ğŸŒ™ ë‹¤í¬';
}

/* â”€â”€ í´ë¦½ë³´ë“œ ë³µì‚¬ ìœ í‹¸ â”€â”€ */
function copyMatchResult(a, sa, b, sb, date, mode, idx){
  const winner=sa>sb?a:sb>sa?b:'ë¬´ìŠ¹ë¶€';
  const lines=[];
  lines.push(`ğŸ“‹ ê²½ê¸° ê²°ê³¼ [${date||'ë‚ ì§œë¯¸ìƒ'}]`);
  lines.push(`${a} ${sa} : ${sb} ${b}${winner!=='ë¬´ìŠ¹ë¶€'?' â†’ '+winner+' ìŠ¹':' â†’ ë¬´ìŠ¹ë¶€'}`);

  // ì„¸íŠ¸/ê²Œì„ ìƒì„¸ ë‚´ì—­ ì¶”ê°€
  let m=null;
  if(mode==='mini'&&idx!=null&&idx!=='null') m=miniM[idx];
  else if(mode==='univm'&&idx!=null&&idx!=='null') m=univM[idx];
  else if(mode==='ck'&&idx!=null&&idx!=='null') m=ckM[idx];
  else if(mode==='pro'&&idx!=null&&idx!=='null') m=proM[idx];
  else if(mode==='comp'&&idx!=null&&idx!=='null') m=comps[idx];
  else if(mode==='tt'&&idx!=null&&idx!=='null') m=ttM[idx];

  if(m&&m.sets&&m.sets.length){
    lines.push('');
    const isCK=(mode==='ck'||mode==='pro'||mode==='tt');
    m.sets.forEach((set,si)=>{
      const sLabel=si===2?'ì—ì´ìŠ¤ì „':`${si+1}ì„¸íŠ¸`;
      const sA=set.scoreA||0,sB=set.scoreB||0;
      const sw=sA>sB?a:sB>sA?b:'ë¬´ìŠ¹ë¶€';
      lines.push(`[${sLabel}] ${a} ${sA}:${sB} ${b}${sw!=='ë¬´ìŠ¹ë¶€'?' ('+sw+')':''}`);
      if(set.games&&set.games.length){
        set.games.forEach((g,gi)=>{
          if(!g.playerA&&!g.playerB)return;
          const wn=g.winner==='A'?g.playerA:g.winner==='B'?g.playerB:'';
          const mapStr=g.map&&g.map!=='-'?` | ${g.map}`:'';
          lines.push(`  ê²½ê¸°${gi+1}: ${g.playerA||'?'} vs ${g.playerB||'?'}${wn?' â†’ '+wn+' ìŠ¹':''}${mapStr}`);
        });
      }
    });
  }

  const text=lines.join('\n');
  navigator.clipboard.writeText(text).then(()=>{
    showToast('ğŸ“‹ ìƒì„¸ ê²°ê³¼ ë³µì‚¬ëìŠµë‹ˆë‹¤!');
  }).catch(()=>{
    const ta=document.createElement('textarea');
    ta.value=text;document.body.appendChild(ta);ta.select();
    document.execCommand('copy');document.body.removeChild(ta);
    showToast('ğŸ“‹ ë³µì‚¬ëìŠµë‹ˆë‹¤!');
  });
}

/* â”€â”€ í† ìŠ¤íŠ¸ ì•Œë¦¼ â”€â”€ */
function showToast(msg, duration=2000){
  let t=document.getElementById('_toast');
  if(!t){
    t=document.createElement('div');t.id='_toast';
    t.style.cssText='position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#1e293b;color:#fff;padding:9px 20px;border-radius:20px;font-size:13px;font-weight:600;z-index:9999;pointer-events:none;opacity:0;transition:opacity .2s;font-family:"Noto Sans KR",sans-serif;box-shadow:0 4px 16px rgba(0,0,0,.25)';
    document.body.appendChild(t);
  }
  t.textContent=msg;
  t.style.opacity='1';
  clearTimeout(t._tid);
  t._tid=setTimeout(()=>{t.style.opacity='0';},duration);
}
function initDark(){
  if(localStorage.getItem('su_dark')==='1'){
    document.body.classList.add('dark');
    const btn=document.getElementById('darkToggleBtn');
    if(btn)btn.textContent='â˜€ï¸ ë¼ì´íŠ¸';
  }
}

function init(){
  fixPoints();
  // ELO ë¯¸ì„¤ì • ì„ ìˆ˜ì—ê²Œ ê¸°ë³¸ê°’ ë¶€ì—¬
  if(typeof ELO_DEFAULT!=='undefined'){
    players.forEach(p=>{ if(p.elo===undefined||p.elo===null) p.elo=ELO_DEFAULT; });
  }
  const ptier=document.getElementById('p-tier');
  if(ptier) ptier.innerHTML=TIERS.map(t=>`<option value="${t}">${getTierLabel(t)}</option>`).join('');
  try{refreshSel();}catch(e){}
  const mdate=document.getElementById('m-date');
  if(mdate) mdate.valueAsDate=new Date();
  initLoginHash();
  applyLoginState();
  render();
}
init();
initDark();

// â”€â”€ ì‚¬ì´íŠ¸ ì²« ì ‘ì† ì‹œ ìë™ ë¶ˆëŸ¬ì˜¤ê¸° â”€â”€
// localStorageì— ì„ ìˆ˜ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ GitHubì—ì„œ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜´ (ìƒˆë¡œê³ ì¹¨ ì œì™¸)
(async function autoLoad(){
  const hasLocal = J('su_p') && JSON.parse(localStorage.getItem('su_p')||'[]').length > 0;
  if(hasLocal) return; // ì´ë¯¸ ë°ì´í„° ìˆìœ¼ë©´ ìŠ¤í‚µ
  console.log('[ìë™ ë¶ˆëŸ¬ì˜¤ê¸°] ë¡œì»¬ ë°ì´í„° ì—†ìŒ â†’ GitHub ìë™ ë¡œë“œ');
  try{
    gsSetStatus('ğŸ”„ ë°ì´í„° ìë™ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...','var(--blue)');
    const ghApiUrl='https://api.github.com/repos/nada1004/star-system/contents/data.json';
    const urls=[
      ghApiUrl,
      'https://cdn.jsdelivr.net/gh/nada1004/star-system@main/data.json',
      'https://api.allorigins.win/raw?url='+encodeURIComponent(GITHUB_JSON_URL),
    ];
    let d=null;
    for(const url of urls){
      try{
        const res=await Promise.race([
          fetch(url,{cache:'no-store',mode:'cors'}),
          new Promise((_,r)=>setTimeout(()=>r(new Error('timeout')),8000))
        ]);
        if(res&&res.ok){
          const text=await res.text();
          const raw=JSON.parse(text);
          if(raw&&raw.content&&raw.encoding==='base64'){
            const b64=raw.content.replace(/\s/g,'');
            const bin=atob(b64);
            const bytes=new Uint8Array(bin.length);
            for(let i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);
            d=JSON.parse(new TextDecoder('utf-8').decode(bytes));
          } else { d=raw; }
          break;
        }
      }catch(e){ continue; }
    }
    if(d){
      players=d.players||d.player||[];
      univCfg=d.univCfg||d.univConfig||d.universities||univCfg;
      maps=d.maps||d.map||maps;
      tourD=d.tourD||d.tournamentDates||Array(15).fill('');
      miniM=d.miniM||d.mini||d.miniMatches||[];
      univM=d.univM||d.univ||d.univMatches||[];
      comps=d.comps||d.comp||d.competitions||[];
      ckM=d.ckM||d.ck||d.ckMatches||[];
      compNames=d.compNames||d.competitionNames||[];
      curComp=d.curComp||d.currentComp||'';
      proM=d.proM||d.pro||d.proMatches||[];
      members=d.members||d.member||[];
      tourneys=d.tourneys||d.tournaments||d.tourney||[];
      ttM=d.ttM||d.tt||[];
      if(d.tiers&&d.tiers.length)TIERS.splice(0,TIERS.length,...d.tiers);
      (function(){
        const allD=[...miniM,...univM,...comps,...ckM,...proM];
        const years=new Set(allD.map(m=>(m.d||'').slice(0,4)).filter(y=>/^\d{4}$/.test(y)));
        years.forEach(y=>{if(!yearOptions.includes(y))yearOptions.push(y);});
        yearOptions.sort();
      })();
      fixPoints(); save(); init();
      gsSetStatus(`âœ… ìë™ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ (${new Date().toLocaleTimeString()})`,'var(--green)');
    } else { gsSetStatus('',''); }
  }catch(e){
    console.warn('[ìë™ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨]',e);
    gsSetStatus('','');
  }
})();
</script>


<script>
// â”€â”€ ì†ŒìŠ¤ì½”ë“œ ë³´í˜¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function(){
  // ìš°í´ë¦­ ë°©ì§€
  document.addEventListener('contextmenu',function(e){e.preventDefault();});
  // F12, Ctrl+Shift+I, Ctrl+U, Ctrl+S, Ctrl+Shift+J, Ctrl+Shift+C ì°¨ë‹¨
  document.addEventListener('keydown',function(e){
    if(
      e.key==='F12'||
      (e.ctrlKey&&e.shiftKey&&['I','i','J','j','C','c'].includes(e.key))||
      (e.ctrlKey&&['U','u','S','s'].includes(e.key))
    ){e.preventDefault();e.stopPropagation();return false;}
  });
})();
</script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GitHub JSON ì½ê¸° ì „ìš© ë¶ˆëŸ¬ì˜¤ê¸°
   â–¼ GitHubì— ì˜¬ë¦° data.json ì˜ RAW URLì„ ì…ë ¥í•˜ì„¸ìš” â–¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GITHUB_JSON_URL = 'https://raw.githubusercontent.com/nada1004/star-system/main/data.json';


function gsSetStatus(msg, color='var(--gray-l)'){
  const el=document.getElementById('cloudStatus');
  if(el){el.textContent=msg;el.style.color=color;}
}

// â”€â”€ GitHub JSON ë¶ˆëŸ¬ì˜¤ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.cloudLoad = async function(){
  try{
    gsSetStatus('ğŸ“¥ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'var(--blue)');
    const loadBtn=document.getElementById('btnCloudLoad');
    if(loadBtn){loadBtn.disabled=true;loadBtn.textContent='â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';}
    let d=null;
    const baseUrl=GITHUB_JSON_URL;
    // ë‹¤ì¤‘ URL ì‹œë„ (raw â†’ jsdelivr â†’ CORS proxy ìˆœì„œ)
    // GitHub API - base64 ì¸ì½”ë”©ìœ¼ë¡œ ë°˜í™˜ (CORS ì™„ì „ í—ˆìš©)
    const ghApiUrl='https://api.github.com/repos/nada1004/star-system/contents/data.json';
    const urls=[
      ghApiUrl,                                           // 1. GitHub API (CORS ì™„ì „ í—ˆìš©)
      'https://cdn.jsdelivr.net/gh/nada1004/star-system@main/data.json', // 2. jsdelivr CDN
      'https://api.allorigins.win/raw?url='+encodeURIComponent(baseUrl), // 3. CORS proxy
      baseUrl+'?nocache='+Date.now(),                    // 4. raw (ì§ì ‘)
    ];
    let lastErr='';
    for(const url of urls){
      try{
        const res=await Promise.race([
          fetch(url,{cache:'no-store',mode:'cors'}),
          new Promise((_,r)=>setTimeout(()=>r(new Error('íƒ€ì„ì•„ì›ƒ(10s)')),10000))
        ]);
        if(res&&res.ok){
          const text=await res.text();
          try{
            const raw=JSON.parse(text);
            // GitHub API ì‘ë‹µ ì²˜ë¦¬ (base64 content í•„ë“œê°€ ìˆìœ¼ë©´ ë””ì½”ë”©)
            if(raw&&raw.content&&raw.encoding==='base64'){
              const b64=raw.content.replace(/\s/g,'');
              const bin=atob(b64);
              const bytes=new Uint8Array(bin.length);
              for(let i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);
              const decoded=new TextDecoder('utf-8').decode(bytes);
              d=JSON.parse(decoded);
            } else {
              d=raw;
            }
          }catch(e){ lastErr='JSON í˜•ì‹ ì˜¤ë¥˜: '+e.message; continue; }
          break;
        }
        lastErr='HTTP '+(res?res.status:'ì˜¤ë¥˜');
      }catch(e){ lastErr=e.message||String(e); }
    }
    if(!d) throw new Error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì›ì¸: '+lastErr+'\n\ní•´ê²°ë°©ë²•:\nÂ· ì¸í„°ë„· ì—°ê²° í™•ì¸\nÂ· GitHub ì €ì¥ì†Œ(nada1004/star-system)ê°€ ê³µê°œ(Public) ìƒíƒœì¸ì§€ í™•ì¸\nÂ· data.json íŒŒì¼ì´ main ë¸Œëœì¹˜ì— ìˆëŠ”ì§€ í™•ì¸');
    if(!confirm('GitHub ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.\n\nâš ï¸ í˜„ì¬ ë¡œì»¬ ë°ì´í„°ê°€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    // í•„ë“œëª… ë³„ì¹­ ì§€ì› (íŒŒì‹± ìœ ì—°ì„±)
    players=d.players||d.player||[];
    univCfg=d.univCfg||d.univConfig||d.universities||univCfg;
    maps=d.maps||d.map||maps;
    tourD=d.tourD||d.tournamentDates||Array(15).fill('');
    miniM=d.miniM||d.mini||d.miniMatches||[];
    univM=d.univM||d.univ||d.univMatches||[];
    comps=d.comps||d.comp||d.competitions||[];
    ckM=d.ckM||d.ck||d.ckMatches||[];
    compNames=d.compNames||d.competitionNames||[];
    curComp=d.curComp||d.currentComp||'';
    proM=d.proM||d.pro||d.proMatches||[];
    members=d.members||d.member||[];
    tourneys=d.tourneys||d.tournaments||d.tourney||[];
    ttM=d.ttM||d.tt||[];
    if(d.tiers&&d.tiers.length && typeof TIERS!=='undefined'){ TIERS.splice(0,TIERS.length,...d.tiers); }
    console.log('[ë¶ˆëŸ¬ì˜¤ê¸°] ë°ì´í„° êµ¬ì¡°:', {players:players.length,miniM:miniM.length,univM:univM.length,comps:comps.length,ckM:ckM.length,proM:proM.length,tourneys:tourneys.length});

    save();
    fixPoints();
    window._compListCache={}; // ëŒ€íšŒ ëª©ë¡ ìºì‹œ ì´ˆê¸°í™”
    window._shareAllMatchesCached=null; // ê³µìœ ì¹´ë“œ ìºì‹œ ì´ˆê¸°í™”
    window._histTourneyCache={}; // ëŒ€íšŒ ê¸°ë¡ íƒ­ ìºì‹œ ì´ˆê¸°í™”
    curTab='total'; // íƒ­ ì´ˆê¸°í™” (ë Œë”ë§ ì˜¤ë¥˜ ë°©ì§€)
    statsSub='overview';
    histSub='mini';
    compSub='league';
    // yearOptionsë¥¼ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ì—ì„œ ìë™ ì¶”ì¶œ
    (function(){
      const allD=[...d.miniM||[],...d.univM||[],...d.comps||[],...d.ckM||[],...d.proM||[]];
      const years=new Set(allD.map(m=>(m.d||'').slice(0,4)).filter(y=>/^\d{4}$/.test(y)));
      years.forEach(y=>{if(!yearOptions.includes(y))yearOptions.push(y);});
      yearOptions.sort();
    })();
    filterYear='ì „ì²´'; // ì—°ë„ í•„í„° ì´ˆê¸°í™” (ë°ì´í„°ê°€ ë‹¤ë¥¸ ë…„ë„ì¼ ìˆ˜ ìˆìŒ)
    filterMonth='ì „ì²´';
    init();

    const compCount=(d.comps||[]).length;
    const tourCount=(d.tourneys||[]).reduce((s,t)=>s+(t.groups||[]).reduce((ss,g)=>ss+(g.matches||[]).filter(m=>m.sa!=null).length,0),0);
    const miniCount=(d.miniM||[]).length;
    const _lb=document.getElementById('btnCloudLoad');if(_lb){_lb.disabled=false;_lb.innerHTML='<span>â˜ï¸</span> ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°';}
    gsSetStatus(`âœ… ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ (${new Date().toLocaleTimeString()}) â€” ë¯¸ë‹ˆ ${miniCount}ê±´Â·ëŒ€íšŒ ${compCount+tourCount}ê±´`, 'var(--green)');
  } catch(e){
    const _lb2=document.getElementById('btnCloudLoad');if(_lb2){_lb2.disabled=false;_lb2.innerHTML='<span>â˜ï¸</span> ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°';}
    const errMsg=e.message||String(e);
    gsSetStatus('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (í•˜ë‹¨ ë©”ì‹œì§€ í™•ì¸)', 'var(--red)');
    console.error('[cloudLoad ì˜¤ë¥˜]', e);
    // ê°„ê²°í•œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
    const shortMsg=errMsg.split('\n').slice(0,3).join('\n');
    setTimeout(()=>alert('âš ï¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨\n\n'+shortMsg), 100);
  }
};


/* â•â•â•â• í˜„í™©íŒ íƒ­ rBoard â•â•â•â• */
let boardSelUniv='ì „ì²´';
// í˜„í™©íŒ ì„ ìˆ˜ ìˆœì„œ: {univ: [name, name, ...]}
let boardPlayerOrder = J('su_bpo') || {};

function _getBoardUnivs(){
  const univs = getAllUnivs().filter(u=>players.some(p=>p.univ===u.name));
  if(!boardOrder.length) return univs;
  const ordered = [];
  boardOrder.forEach(name => { const u = univs.find(x=>x.name===name); if(u) ordered.push(u); });
  univs.forEach(u => { if(!boardOrder.includes(u.name)) ordered.push(u); });
  return ordered;
}

// ëŒ€í•™ ë‚´ ì„ ìˆ˜ ì •ë ¬ (boardPlayerOrder ìš°ì„ , ì—†ìœ¼ë©´ ê¸°ë³¸ ì •ë ¬)
function _getBoardPlayers(univName){
  const univPlayers = players.filter(p=>p.univ===univName);
  const order = boardPlayerOrder[univName] || [];
  if(!order.length){
    // ê¸°ë³¸: MAIN_ROLES â†’ í‹°ì–´ â†’ í¬ì¸íŠ¸
    return [...univPlayers].sort((a,b)=>{
      const ra=getRoleOrder(a.role),rb=getRoleOrder(b.role);
      if(ra!==rb)return ra-rb;
      return TIERS.indexOf(a.tier)-TIERS.indexOf(b.tier)||b.points-a.points;
    });
  }
  const sorted = [];
  order.forEach(name=>{ const p=univPlayers.find(x=>x.name===name); if(p) sorted.push(p); });
  univPlayers.forEach(p=>{ if(!order.includes(p.name)) sorted.push(p); });
  return sorted;
}

function saveBoardPlayerOrder(){
  localStorage.setItem('su_bpo', JSON.stringify(boardPlayerOrder));
}

function rBoard(C,T){
  T.textContent='ğŸ“Š í˜„í™©íŒ';
  const univs=_getBoardUnivs();
  if(!univs.length){C.innerHTML='<div style="padding:40px;text-align:center;color:var(--gray-l)">ë“±ë¡ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';return;}
  let h=`
  <style>
    .brd-card{background:var(--brd-col,#2563eb);border-radius:18px;overflow:hidden;box-shadow:0 8px 28px var(--brd-shd,rgba(37,99,235,.3)),0 2px 8px rgba(0,0,0,.1);position:relative;transition:transform .18s,box-shadow .18s;align-self:start;}
    .brd-card:hover{transform:translateY(-2px);box-shadow:0 14px 36px var(--brd-shd,rgba(37,99,235,.38)),0 4px 12px rgba(0,0,0,.13);}
    .brd-card.drag-over{outline:3px solid rgba(255,255,255,.8);opacity:.85;}
    .brd-card.dragging{opacity:.45;transform:scale(.97);}
    .brd-hdr{padding:16px 18px 13px;position:relative;z-index:1;cursor:grab;}
    .brd-hdr:active{cursor:grabbing;}
    .brd-hdr::before{content:'';position:absolute;inset:0;background:linear-gradient(145deg,rgba(255,255,255,.18) 0%,rgba(255,255,255,0) 60%);pointer-events:none;}
    .brd-circle{position:absolute;border-radius:50%;background:rgba(255,255,255,.08);pointer-events:none;}
    .brd-row{display:flex;align-items:center;gap:7px;padding:5px 10px;border-radius:9px;background:rgba(255,255,255,.9);border:1px solid rgba(255,255,255,.6);transition:background .12s;}
    .brd-row:hover{background:rgba(255,255,255,1);}
    .brd-row-btn{cursor:pointer;flex:1;display:flex;align-items:center;gap:7px;background:none;border:none;padding:0;font-family:'Noto Sans KR',sans-serif;min-width:0;}
    .brd-photo{width:26px;height:26px;border-radius:50%;object-fit:cover;flex-shrink:0;background:rgba(0,0,0,.1);border:1.5px solid rgba(255,255,255,.5);}
    .brd-photo-placeholder{width:26px;height:26px;border-radius:50%;flex-shrink:0;background:rgba(255,255,255,.25);border:1.5px solid rgba(255,255,255,.4);display:flex;align-items:center;justify-content:center;font-size:12px;color:rgba(255,255,255,.7);}
    .brd-race{font-size:9px;font-weight:800;padding:2px 6px;border-radius:5px;flex-shrink:0;letter-spacing:.3px;}
    .brd-name{font-weight:700;font-size:12px;color:#111827;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0;text-align:left;}
    .brd-role-main{font-size:9px;padding:1px 5px;border-radius:4px;font-weight:700;white-space:nowrap;flex-shrink:0;border:1px solid;}
    .brd-role-sub{font-size:9px;padding:1px 5px;border-radius:4px;font-weight:600;white-space:nowrap;flex-shrink:0;background:rgba(100,116,139,.1);color:#64748b;border:1px solid rgba(100,116,139,.2);}
    .brd-move-btn{display:flex;flex-direction:column;gap:1px;flex-shrink:0;opacity:.55;}
    .brd-move-btn button{background:none;border:none;cursor:pointer;font-size:9px;padding:0 2px;line-height:1;color:#1e293b;transition:opacity .12s;}
    .brd-move-btn button:hover{opacity:.5;}
    .brd-move-btn button:disabled{opacity:.18;cursor:default;}
    .brd-sep{height:1px;background:rgba(255,255,255,.22);margin:0 18px;}
    .brd-body{padding:10px 10px 14px;display:flex;flex-direction:column;gap:4px;overflow:hidden;}
    .brd-row-drag{cursor:grab;}.brd-row-drag:active{cursor:grabbing;}
    .brd-tier-lbl{font-size:9px;font-weight:700;color:rgba(255,255,255,.65);letter-spacing:.8px;text-transform:uppercase;padding:0 2px;margin:6px 0 2px;}
    .brd-tier-lbl:first-child{margin-top:0;}
    .brd-univ-name-btn{font-weight:900;font-size:18px;color:#fff;letter-spacing:.2px;line-height:1.15;text-shadow:0 1px 6px rgba(0,0,0,.18);cursor:pointer;border:none;background:none;padding:0;font-family:'Noto Sans KR',sans-serif;text-align:left;}
    .brd-univ-name-btn:hover{text-decoration:underline;text-underline-offset:3px;}
    .brd-drag-hint{font-size:10px;color:rgba(255,255,255,.5);margin-left:auto;padding:2px 6px;border-radius:4px;background:rgba(255,255,255,.1);cursor:grab;flex-shrink:0;user-select:none;}
    /* ì´ë™ íŒì—… */
    .brd-move-popup{position:fixed;z-index:5000;background:#fff;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.22);padding:10px;min-width:220px;max-width:260px;max-height:90vh;overflow-y:auto;border:1px solid var(--border);}
    .brd-move-popup-title{font-size:11px;font-weight:700;color:var(--text3);padding:4px 6px 8px;border-bottom:1px solid var(--border);margin-bottom:6px;}
    .brd-move-popup-btn{display:flex;align-items:center;gap:8px;width:100%;padding:7px 10px;border:none;background:none;border-radius:7px;cursor:pointer;font-family:'Noto Sans KR',sans-serif;font-size:12px;font-weight:600;color:var(--text);transition:background .1s;text-align:left;}
    .brd-move-popup-btn:hover{background:var(--blue-l);color:var(--blue);}
    .brd-move-popup-btn:disabled{opacity:.35;cursor:default;background:none;}
    .brd-move-popup-sep{height:1px;background:var(--border);margin:4px 0;}
    /* í˜„í™©íŒ íˆ´ë°” ë²„íŠ¼ */
    .brd-tbtn{display:inline-flex;align-items:center;gap:6px;padding:6px 13px;border-radius:9px;border:1.5px solid var(--border2);background:var(--surface);color:var(--text2);font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;font-family:'Noto Sans KR',sans-serif;white-space:nowrap;line-height:1.4;}
    .brd-tbtn:hover{transform:translateY(-1px);box-shadow:0 3px 10px rgba(0,0,0,.12);}
    .brd-tbtn:active{transform:translateY(0);box-shadow:none;}
    .brd-tbtn-img{border-color:#3b82f6;color:#2563eb;background:linear-gradient(135deg,#eff6ff,#dbeafe);}
    .brd-tbtn-img:hover{background:linear-gradient(135deg,#dbeafe,#bfdbfe);border-color:#2563eb;}
    .brd-tbtn-share{border-color:#8b5cf6;color:#6d28d9;background:linear-gradient(135deg,#f5f3ff,#ede9fe);}
    .brd-tbtn-share:hover{background:linear-gradient(135deg,#ede9fe,#ddd6fe);border-color:#6d28d9;}
    body.dark .brd-tbtn-img{background:linear-gradient(135deg,#1e3a5f,#1e3a8a);color:#93c5fd;border-color:#3b82f6;}
    body.dark .brd-tbtn-share{background:linear-gradient(135deg,#2e1f5e,#3b2080);color:#c4b5fd;border-color:#7c3aed;}
  </style>
  <div class="no-export brd-toolbar" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:12px 16px;background:var(--white);border:1px solid var(--border);border-radius:14px;margin-bottom:20px;box-shadow:0 2px 12px rgba(0,0,0,.07)">
    <div style="display:flex;align-items:center;gap:8px;margin-right:2px">
      <span style="font-size:18px;line-height:1">ğŸ“Š</span>
      <span style="font-weight:900;font-size:15px;color:var(--text);letter-spacing:-.3px">í˜„í™©íŒ</span>
    </div>
    <div style="width:1px;height:22px;background:var(--border);opacity:.6"></div>
    <button class="brd-tbtn brd-tbtn-img" onclick="downloadBoardAll()" title="í˜„í™©íŒ ì „ì²´ ì´ë¯¸ì§€ë¡œ ì €ì¥">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
      ì´ë¯¸ì§€ ì €ì¥
    </button>
    <div style="width:1px;height:22px;background:var(--border);opacity:.5"></div>
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <div style="position:relative">
        <select id="board-univ-sel" onchange="boardSelUniv=this.value;render();if(boardSelUniv!=='ì „ì²´'){setTimeout(()=>{const c=document.querySelector(\`.brd-card[data-univ='\${boardSelUniv}']\`);if(c)c.scrollIntoView({behavior:'smooth',block:'center'});},120);}" style="appearance:none;-webkit-appearance:none;padding:6px 28px 6px 12px;border-radius:9px;border:1.5px solid var(--border2);font-size:12px;font-weight:700;color:var(--text);background:var(--surface);cursor:pointer;outline:none;min-width:120px;">
          <option value="ì „ì²´">ğŸ« ì „ì²´ ë³´ê¸°</option>
          ${univs.map(u=>`<option value="${u.name}"${boardSelUniv===u.name?' selected':''}>${u.name}</option>`).join('')}
        </select>
        <svg style="position:absolute;right:8px;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--gray-l)" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m6 9 6 6 6-6"/></svg>
      </div>
      ${boardSelUniv!=='ì „ì²´'?`<button class="brd-tbtn brd-tbtn-share" onclick="openBoardUnivShareCard('${boardSelUniv}')" title="${boardSelUniv} ê³µìœ  ì¹´ë“œ">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
        ê³µìœ ì¹´ë“œ
      </button>`:''}
    </div>
    <span style="font-size:11px;color:var(--gray-l);margin-left:auto">${isLoggedIn?'ğŸ–±ï¸ í—¤ë” ë“œë˜ê·¸Â·â—€â–¶ = ëŒ€í•™ìˆœì„œ &nbsp;|&nbsp; ìŠ¤íŠ¸ë¦¬ë¨¸ ë“œë˜ê·¸/í´ë¦­ = ìˆœì„œÂ·ëŒ€í•™ì´ë™':'ğŸ‘† ìŠ¤íŠ¸ë¦¬ë¨¸ í´ë¦­ â†’ ì„ ìˆ˜ ìƒì„¸'}</span>
  </div>
  <div id="board-wrap" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;align-items:start">`;
  const targets=boardSelUniv==='ì „ì²´'?univs:univs.filter(u=>u.name===boardSelUniv);
  targets.forEach(u=>{ h+=buildUnivBoardCard(u); });
  h+=`</div>`;
  C.innerHTML=h;
  injectUnivIcons(C);
  requestAnimationFrame(()=>{ injectUnivIcons(C); initBoardDrag(); });
  // íŒì—… ë‹«ê¸° ì´ë²¤íŠ¸ (í•œ ë²ˆë§Œ ë“±ë¡)
  if(!_brdPopupListenerAdded){
    document.addEventListener('click', _closeBrdPopup, {capture:true});
    _brdPopupListenerAdded = true;
  }
}

function buildUnivBoardCard(u, forExport){
  if(!u)return'';
  const col=gc(u.name);
  const univPlayers=players.filter(p=>p.univ===u.name);
  if(!univPlayers.length)return'';
  const iconUrl=UNIV_ICONS[u.name]||(univCfg.find(x=>x.name===u.name)||{}).icon||'';
  const cnt=univPlayers.length;
  const sorted=_getBoardPlayers(u.name);
  const allUnivs=getAllUnivs();

  const RACE_CFG={T:{bg:'#dbeafe',col:'#1e40af',txt:'í…Œ'},Z:{bg:'#ede9fe',col:'#5b21b6',txt:'ì €'},P:{bg:'#fef3c7',col:'#92400e',txt:'í”„'}};
  const hexToRgba=(h,a)=>{const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return`rgba(${r},${g},${b},${a})`;};
  const shd=hexToRgba(col,.3);

  // í‹°ì–´ë³„ ì¹© ë ˆì´ì•„ì›ƒ ë¹Œë” (ë¬´ì†Œì† + forExport ì‹œ ëª¨ë“  ëŒ€í•™ì— ì ìš©)
  const buildChipLayout=(isWide)=>{
    const tierMap={};
    sorted.forEach(p=>{
      const t=p.tier||'ê¸°íƒ€';
      if(!tierMap[t])tierMap[t]=[];
      tierMap[t].push(p);
    });
    const tierOrder=TIERS.filter(t=>tierMap[t]);
    if(tierMap['ê¸°íƒ€']&&!TIERS.includes('ê¸°íƒ€'))tierOrder.push('ê¸°íƒ€');

    const buildPlayerChip=(p, chipIdx)=>{
      const rc=RACE_CFG[p.race]||{bg:'#f1f5f9',col:'#475569',txt:p.race||'?'};
      const isMain=p.role&&MAIN_ROLES.includes(p.role);
      const rCol=ROLE_COLORS[p.role]||'';
      const rIcon=ROLE_ICONS[p.role]||'';
      if(forExport){
        return `<span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,.9);border-radius:8px;padding:4px 10px;margin:2px;font-size:13px">
          ${isMain?`<span style="font-size:10px;font-weight:800;color:${rCol}">${rIcon}</span>`:''}
          <span style="font-size:10px;font-weight:800;color:${rc.col}">${rc.txt}</span>
          <span style="font-weight:700;color:#111;font-size:13px">${p.name}${getStatusIconHTML(p.name)}</span>
        </span>`;
      }
      const pNameSafe=p.name.replace(/'/g,"\\'").replace(/"/g,'&quot;');
      const totalInUniv=sorted.length;
      // ê´€ë¦¬ìëŠ” ì´ë™/ì§ì±… íŒì—…, ë¹„ê´€ë¦¬ìëŠ” ì„ ìˆ˜ ìƒì„¸
      const clickFn=isLoggedIn
        ? `openBrdPlayerPopupFromChip(event,'${pNameSafe}','${u.name}',${chipIdx??0},${totalInUniv})`
        : `openPlayerModal('${pNameSafe}')`;
      return `<span class="brd-chip" data-player="${p.name}" data-univ="${u.name}" data-idx="${chipIdx??0}"${isLoggedIn?' draggable="true"':''} style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,.92);border-radius:8px;padding:5px 11px;margin:2px 2px;font-size:14px;cursor:${isLoggedIn?'grab':'pointer'};transition:box-shadow .12s,background .12s;box-shadow:0 1px 4px rgba(0,0,0,.08)" onmouseover="this.style.background='#fff';this.style.boxShadow='0 2px 8px rgba(0,0,0,.16)'" onmouseout="this.style.background='rgba(255,255,255,.92)';this.style.boxShadow='0 1px 4px rgba(0,0,0,.08)'" onclick="event.stopPropagation();${clickFn}">
        ${isMain?`<span style="font-size:11px;font-weight:800;color:${rCol}">${rIcon}</span>`:''}
        <span style="font-size:11px;font-weight:800;color:${rc.col}">${rc.txt}</span>
        <span style="font-weight:700;color:#111;font-size:14px">${p.name}${getStatusIconHTML(p.name)}</span>
        <span style="font-size:10px;color:rgba(0,0,0,.4);margin-left:2px">${p.tier||''}</span>
      </span>`;
    };

    // ì „ì²´ ìˆœì„œì—ì„œì˜ ì¸ë±ìŠ¤ ë§µ
    const chipIdxMap={};
    sorted.forEach((p,i)=>{ chipIdxMap[p.name]=i; });

    const tierRows=tierOrder.map(tier=>{
      const ps=tierMap[tier];
      return `<div style="margin-bottom:8px">
        <div style="font-size:11px;font-weight:800;color:rgba(255,255,255,.7);letter-spacing:1px;padding:0 3px;margin-bottom:4px">${tier}</div>
        <div style="display:flex;flex-wrap:wrap;gap:0">${ps.map(p=>buildPlayerChip(p, chipIdxMap[p.name]??0)).join('')}</div>
      </div>`;
    }).join('');

    const hdrDrag=isLoggedIn&&!forExport?' draggable="true" ondragstart="event.stopPropagation();const card=this.closest(\'.brd-card\');const wrap=document.getElementById(\'board-wrap\');_brdDragSrc=card;card.classList.add(\'dragging\');event.dataTransfer.effectAllowed=\'move\';event.dataTransfer.setData(\'text/card\',card.dataset.univ);" ondragend="event.stopPropagation();const card=this.closest(\'.brd-card\');card.classList.remove(\'dragging\');const wrap=document.getElementById(\'board-wrap\');if(wrap){boardOrder=[...wrap.querySelectorAll(\'.brd-card\')].map(c=>c.dataset.univ);save();syncBoardOrderToUnivCfg();}wrap&&wrap.querySelectorAll(\'.brd-card\').forEach(c=>c.classList.remove(\'drag-over\'));_brdDragSrc=null;"':'';

    return `<div class="brd-card" data-univ="${u.name}" style="--brd-col:${col};--brd-shd:${shd}${isWide?';grid-column:1/-1':''}" draggable="false">
      <div class="brd-hdr" style="cursor:${isLoggedIn&&!forExport?'grab':'default'}"${hdrDrag}>
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:46px;height:46px;border-radius:13px;background:rgba(255,255,255,.22);border:2px solid rgba(255,255,255,.4);display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden">
            ${iconUrl?`<img src="${iconUrl}" style="width:34px;height:34px;object-fit:contain" onerror="this.parentElement.innerHTML='ğŸ«'">`:'<span style="font-size:22px">ğŸ«</span>'}
          </div>
          <div style="flex:1;min-width:0">
            <button class="brd-univ-name-btn" onclick="event.stopPropagation();${forExport?'':(`openUnivModal('${u.name}')`)}">
              ${u.name}</button>
            <div style="font-size:11px;color:rgba(255,255,255,.72);margin-top:3px">${cnt}ëª…</div>
          </div>
          ${!forExport?`<div class="no-export" style="display:flex;flex-direction:column;gap:3px;flex-shrink:0">
            ${isLoggedIn?`<button onclick="event.stopPropagation();boardCardMove('${u.name}','left')" style="background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.35);border-radius:5px;color:#fff;font-size:11px;width:26px;height:22px;cursor:pointer">â—€</button>
            <button onclick="event.stopPropagation();boardCardMove('${u.name}','right')" style="background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.35);border-radius:5px;color:#fff;font-size:11px;width:26px;height:22px;cursor:pointer">â–¶</button>`:''}
          </div>`:''}
        </div>
      </div>
      <div class="brd-sep"></div>
      <div class="brd-body">${tierRows}</div>
    </div>`;
  };

  // forExport ì´ê±°ë‚˜ ë¬´ì†Œì†ì´ë©´ ì¹© ë ˆì´ì•„ì›ƒ
  if(forExport) return buildChipLayout(false);
  if(u.name==='ë¬´ì†Œì†') return buildChipLayout(true);

  // í‹°ì–´ë³„ ê·¸ë£¹í•‘ (sorted ìˆœì„œ ìœ ì§€)
  const tierGroups=[];
  const seenT={};
  sorted.forEach(p=>{
    if(!seenT[p.tier]){seenT[p.tier]=[];tierGroups.push({tier:p.tier,players:seenT[p.tier]});}
    seenT[p.tier].push(p);
  });

  const playerRows = sorted.map((p, idx)=>{
    const rc=RACE_CFG[p.race]||{bg:'#f1f5f9',col:'#475569',txt:p.race||'?'};
    const isMain=p.role&&MAIN_ROLES.includes(p.role);
    const isSub=p.role&&!MAIN_ROLES.includes(p.role);
    const rCol=ROLE_COLORS[p.role]||'';
    const rIcon=ROLE_ICONS[p.role]||'';
    // í”„ë¡œí•„ ì‚¬ì§„
    const photoSrc=p.photo||'';
    const photoHTML = photoSrc
      ? `<img class="brd-photo" src="${photoSrc}" onerror="this.style.display='none'" alt="">`
      : '';
    // ì‚¬ì§„ ì—†ìœ¼ë©´ placeholder í‘œì‹œ ì•ˆ í•¨ (ê³µë°± ë°©ì§€)
    const placeholderHTML = photoSrc ? '' : '';

    if(forExport){
      return `<div class="brd-row" style="margin-bottom:3px;display:flex;align-items:center;gap:4px;padding:3px 6px;background:rgba(255,255,255,.7);border-radius:6px">
        ${photoSrc?`<img src="${photoSrc}" style="width:22px;height:22px;border-radius:50%;object-fit:cover;flex-shrink:0;border:1.5px solid rgba(255,255,255,.6)" onerror="this.style.display='none'">`:''}
        ${isMain?`<span style="font-size:9px;font-weight:800;padding:1px 5px;border-radius:4px;background:${rCol};color:#fff;flex-shrink:0;white-space:nowrap">${rIcon}${p.role}</span>`:''}
        ${isSub?`<span style="font-size:9px;color:${ROLE_COLORS[p.role]||'#6b7280'};font-weight:700;flex-shrink:0">${p.role}</span>`:''}
        <span style="font-size:9px;font-weight:800;color:${rc.col};flex-shrink:0">${rc.txt}</span>
        <span style="font-weight:700;color:#111;font-size:12px">${p.name}${getStatusIconHTML(p.name)}</span>
        ${getTierBadge(p.tier)}
      </div>`;
    }

    const pNameSafe=p.name.replace(/'/g,"\\'").replace(/"/g,'&quot;');
    const isAdmin=isLoggedIn;
    return `<div class="brd-row no-export-movebtns" data-player="${p.name}" data-univ="${u.name}" data-idx="${idx}"${isAdmin?' draggable="true"':''} style="cursor:${isAdmin?'grab':'default'}">
      <button class="brd-row-btn" onclick="event.stopPropagation();${isAdmin?`openBrdPlayerPopup(event,'${pNameSafe}','${u.name}',${idx},${sorted.length})`:`openPlayerModal('${pNameSafe}')`}" title="${isAdmin?'í´ë¦­: ìˆœì„œë³€ê²½/ëŒ€í•™ì´ë™':'ì„ ìˆ˜ ìƒì„¸ ë³´ê¸°'}">
        ${photoSrc?`<img src="${photoSrc}" style="width:24px;height:24px;border-radius:50%;object-fit:cover;flex-shrink:0;border:1.5px solid rgba(255,255,255,.5);margin-right:1px" onerror="this.style.display='none'">` : ''}
        ${isMain?`<span class="brd-role-main" style="background:${rCol};color:#fff;border-color:${rCol}">${rIcon}${p.role}</span>`:''}
        <span class="brd-race" style="background:${rc.bg};color:${rc.col}">${rc.txt}</span>
        <span class="brd-name">${p.name}${getStatusIconHTML(p.name)}</span>
        ${isSub?`<span class="brd-role-sub">${p.role}</span>`:''}
        ${getTierBadge(p.tier)}
      </button>
      ${isAdmin?`<span style="font-size:10px;color:rgba(0,0,0,.25);padding:0 3px;cursor:grab;flex-shrink:0;user-select:none" title="ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½">â ¿</span>`:''}
    </div>`;
  }).join('');

  return `<div class="brd-card" data-univ="${u.name}" style="--brd-col:${col};--brd-shd:${shd}" draggable="false">
    <div class="brd-hdr" style="cursor:${isLoggedIn?'grab':'default'}"${isLoggedIn?' draggable="true" ondragstart="event.stopPropagation();const card=this.closest(\'.brd-card\');const wrap=document.getElementById(\'board-wrap\');_brdDragSrc=card;card.classList.add(\'dragging\');event.dataTransfer.effectAllowed=\'move\';event.dataTransfer.setData(\'text/card\',card.dataset.univ);" ondragend="event.stopPropagation();const card=this.closest(\'.brd-card\');card.classList.remove(\'dragging\');const wrap=document.getElementById(\'board-wrap\');if(wrap){boardOrder=[...wrap.querySelectorAll(\'.brd-card\')].map(c=>c.dataset.univ);save();syncBoardOrderToUnivCfg();}wrap&&wrap.querySelectorAll(\'.brd-card\').forEach(c=>c.classList.remove(\'drag-over\'));_brdDragSrc=null;"':''}>
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:46px;height:46px;border-radius:13px;background:rgba(255,255,255,.22);border:2px solid rgba(255,255,255,.4);display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;cursor:pointer" onclick="event.stopPropagation();if(boardSelUniv==='${u.name}'){boardSelUniv='ì „ì²´';}else{boardSelUniv='${u.name}';}const sel=document.getElementById('board-univ-sel');if(sel)sel.value=boardSelUniv;render();" title="í´ë¦­: í•´ë‹¹ ëŒ€í•™ í•„í„° (ë‹¤ì‹œ í´ë¦­: ì „ì²´ ë³´ê¸°)">
          ${iconUrl?`<img src="${iconUrl}" style="width:34px;height:34px;object-fit:contain" onerror="this.parentElement.innerHTML='ğŸ«'">`:'<span style="font-size:22px">ğŸ«</span>'}
        </div>
        <div style="flex:1;min-width:0">
          <button class="brd-univ-name-btn" onclick="event.stopPropagation();openUnivModal('${u.name}')">${u.name}</button>
          <div style="font-size:11px;color:rgba(255,255,255,.72);margin-top:3px">${cnt}ëª…</div>
        </div>
        <div class="no-export" style="display:flex;flex-direction:column;gap:3px;flex-shrink:0">
          ${isLoggedIn?`<button onclick="event.stopPropagation();boardCardMove('${u.name}','left')" title="ì™¼ìª½ìœ¼ë¡œ" style="background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.35);border-radius:5px;color:#fff;font-size:11px;width:26px;height:22px;cursor:pointer;line-height:1;transition:.12s" onmouseover="this.style.background='rgba(255,255,255,.38)'" onmouseout="this.style.background='rgba(255,255,255,.2)'">â—€</button>
          <button onclick="event.stopPropagation();boardCardMove('${u.name}','right')" title="ì˜¤ë¥¸ìª½ìœ¼ë¡œ" style="background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.35);border-radius:5px;color:#fff;font-size:11px;width:26px;height:22px;cursor:pointer;line-height:1;transition:.12s" onmouseover="this.style.background='rgba(255,255,255,.38)'" onmouseout="this.style.background='rgba(255,255,255,.2)'">â–¶</button>`:''}
        </div>
      </div>
    </div>
    <div class="brd-sep"></div>
    <div class="brd-body">${playerRows}</div>
  </div>`;
}

/* â”€â”€ í˜„í™©íŒ í† ìŠ¤íŠ¸ ì•Œë¦¼ â”€â”€ */
function _brdToast(msg, duration=2800){
  const existing = document.getElementById('brd-toast');
  if(existing) existing.remove();
  const el = document.createElement('div');
  el.id = 'brd-toast';
  el.textContent = msg;
  el.style.cssText = 'position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(20px);background:#1e293b;color:#fff;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,.3);opacity:0;transition:opacity .25s,transform .25s;pointer-events:none;font-family:\'Noto Sans KR\',sans-serif;';
  document.body.appendChild(el);
  requestAnimationFrame(()=>{
    el.style.opacity='1'; el.style.transform='translateX(-50%) translateY(0)';
  });
  setTimeout(()=>{
    el.style.opacity='0'; el.style.transform='translateX(-50%) translateY(10px)';
    setTimeout(()=>el.remove(), 300);
  }, duration);
}

/* â”€â”€ ì„ ìˆ˜ ì´ë™ íŒì—… â”€â”€ */
let _brdPopup = null;
let _brdPopupListenerAdded = false;
function _closeBrdPopup(e){
  if(!_brdPopup) return;
  if(!_brdPopup.contains(e.target)){
    _brdPopup.remove();
    _brdPopup = null;
  }
}

// ì¹© ì „ìš© íŒì—… (ë¬´ì†Œì† ë“± ì¹© ë ˆì´ì•„ì›ƒ) - ìœ„/ì•„ë˜ ì´ë™ ëŒ€ì‹  ëŒ€í•™ì´ë™ ìœ„ì£¼
function openBrdPlayerPopupFromChip(e, playerName, univName, idx, total){
  if(!isLoggedIn){ openPlayerModal(playerName); return; }
  e.stopPropagation();
  if(typeof _brdPopup!=='undefined'&&_brdPopup){ _brdPopup.remove(); _brdPopup=null; }
  const allUnivs = _getBoardUnivs();
  const p = players.find(x=>x.name===playerName);
  if(!p) return;

  const popup = document.createElement('div');
  popup.className = 'brd-move-popup';
  _brdPopup = popup;

  const otherUnivs = allUnivs.filter(u=>u.name!==univName);
  const univOpts = otherUnivs.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');

  popup.innerHTML = `
    <div class="brd-move-popup-title">ğŸ‘¤ ${playerName} <span style="font-size:10px;font-weight:400">(${univName})</span></div>
    <div class="brd-move-popup-sep"></div>
    <div style="padding:4px 6px 6px;font-size:11px;font-weight:700;color:var(--text3)">ğŸ·ï¸ ì§ì±… ìˆ˜ì •</div>
    <div style="display:flex;gap:4px;flex-wrap:wrap;padding:0 6px 4px">
      ${['ì´ì‚¬ì¥','ì´ì¥','ë¶€ì´ì¥','ì´ê´„','êµìˆ˜','ì½”ì¹˜','í•™ìƒíšŒì¥','ì˜¤ë½ë¶€ì¥'].map(r=>`<button class="btn btn-xs ${p.role===r?'btn-b':'btn-w'}" onclick="setBrdRole('${playerName}','${r}')" style="font-size:10px">${r}</button>`).join('')}
      <button class="btn btn-xs btn-w" onclick="setBrdRole('${playerName}','')" style="font-size:10px;color:#dc2626">í•´ì œ</button>
    </div>
    <div style="display:flex;gap:4px;padding:0 6px 6px;align-items:center">
      <input id="brd-role-chip-${playerName.replace(/[^a-zA-Z0-9ê°€-í£]/g,'')}" type="text" placeholder="ì§ì ‘ ì…ë ¥..." style="flex:1;padding:4px 7px;border-radius:6px;border:1px solid var(--border2);font-size:11px">
      <button class="btn btn-b btn-xs" onclick="(function(){const inp=document.getElementById('brd-role-chip-${playerName.replace(/[^a-zA-Z0-9ê°€-í£]/g,'')}');if(inp&&inp.value.trim())setBrdRole('${playerName}',inp.value.trim())})()">ì„¤ì •</button>
    </div>
    <div class="brd-move-popup-sep"></div>
    <div style="padding:4px 6px 6px;font-size:11px;font-weight:700;color:var(--text3)">ğŸ« ë‹¤ë¥¸ ëŒ€í•™ìœ¼ë¡œ ì´ë™</div>
    <div style="display:flex;gap:6px;padding:0 6px 4px">
      <select id="brd-chip-univ-target" style="flex:1;padding:5px 8px;border-radius:7px;border:1px solid var(--border2);font-size:12px;background:var(--white)">${univOpts||'<option disabled>ëŒ€í•™ ì—†ìŒ</option>'}</select>
      <button class="btn btn-b btn-xs" onclick="boardTransferPlayerFromChip('${playerName}','${univName}')">ì´ë™</button>
    </div>
    <div class="brd-move-popup-sep"></div>
    <button class="brd-move-popup-btn" onclick="_brdPopup&&_brdPopup.remove();_brdPopup=null;openPlayerModal('${playerName}')">ğŸ“‹ ì„ ìˆ˜ ìƒì„¸ ë³´ê¸°</button>
  `;

  document.body.appendChild(popup);
  const targetEl = e.target.closest('.brd-chip');
  const rect = targetEl?.getBoundingClientRect() || {left:e.clientX, top:e.clientY, width:0, height:0};
  let left = rect.right + 6;
  let top = rect.top;
  const pw=240, ph=300;
  if(left + pw > window.innerWidth) left = rect.left - pw - 6;
  if(top + ph > window.innerHeight) top = window.innerHeight - ph - 10;
  if(top < 8) top = 8;
  popup.style.left = left + 'px';
  popup.style.top = top + 'px';
}

function boardTransferPlayerFromChip(playerName, fromUniv){
  if(!isLoggedIn){ alert('ê´€ë¦¬ìë§Œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
  const sel = document.getElementById('brd-chip-univ-target');
  const toUniv = sel?.value;
  if(!toUniv || toUniv===fromUniv){ alert('ì´ë™í•  ëŒ€í•™ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
  if(_brdPopup){ _brdPopup.remove(); _brdPopup=null; }
  const p = players.find(x=>x.name===playerName);
  if(!p) return;
  if(!confirm(`"${playerName}"ì„(ë¥¼) "${fromUniv}" â†’ "${toUniv}"ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  p.univ = toUniv;
  if(boardPlayerOrder[fromUniv]){
    boardPlayerOrder[fromUniv] = boardPlayerOrder[fromUniv].filter(n=>n!==playerName);
  }
  save(); saveBoardPlayerOrder();
  _refreshBoardCard(fromUniv);
  _refreshBoardCard(toUniv);
  _brdToast(`âœ… "${playerName}" â†’ "${toUniv}" ì´ë™ ì™„ë£Œ`);
}

function openBrdPlayerPopup(e, playerName, univName, idx, total){
  // ë¹„ê´€ë¦¬ìëŠ” íŒì—… ì—†ì´ ì„ ìˆ˜ ìƒì„¸ ë°”ë¡œ ì—´ê¸°
  if(!isLoggedIn){ openPlayerModal(playerName); return; }

  e.stopPropagation();
  if(_brdPopup){ _brdPopup.remove(); _brdPopup=null; }
  const allUnivs = _getBoardUnivs();
  const p = players.find(x=>x.name===playerName);
  if(!p) return;

  const popup = document.createElement('div');
  popup.className = 'brd-move-popup';
  _brdPopup = popup;

  const otherUnivs = allUnivs.filter(u=>u.name!==univName);
  const univOpts = otherUnivs.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');

  popup.innerHTML = `
    <div class="brd-move-popup-title">ğŸ‘¤ ${playerName} <span style="font-size:10px;font-weight:400">(${univName})</span></div>
    <button class="brd-move-popup-btn" onclick="boardMovePlayer('${playerName}','${univName}','up')" ${idx===0?'disabled':''}>â¬† ìœ„ë¡œ</button>
    <button class="brd-move-popup-btn" onclick="boardMovePlayer('${playerName}','${univName}','down')" ${idx>=total-1?'disabled':''}>â¬‡ ì•„ë˜ë¡œ</button>
    <button class="brd-move-popup-btn" onclick="boardMovePlayer('${playerName}','${univName}','top')">â« ë§¨ ìœ„ë¡œ</button>
    <button class="brd-move-popup-btn" onclick="boardMovePlayer('${playerName}','${univName}','bottom')">â¬ ë§¨ ì•„ë˜ë¡œ</button>
    <div class="brd-move-popup-sep"></div>
    <div style="padding:4px 6px 6px;font-size:11px;font-weight:700;color:var(--text3)">ğŸ·ï¸ ì§ì±… ìˆ˜ì •</div>
    <div style="display:flex;gap:4px;flex-wrap:wrap;padding:0 6px 4px">
      ${['ì´ì‚¬ì¥','ì´ì¥','ë¶€ì´ì¥','ì´ê´„','êµìˆ˜','ì½”ì¹˜','í•™ìƒíšŒì¥','ì˜¤ë½ë¶€ì¥'].map(r=>`<button class="btn btn-xs ${p.role===r?'btn-b':'btn-w'}" onclick="setBrdRole('${playerName}','${r}')" style="font-size:10px">${r}</button>`).join('')}
      <button class="btn btn-xs btn-w" onclick="setBrdRole('${playerName}','')" style="font-size:10px;color:#dc2626">í•´ì œ</button>
    </div>
    <div style="display:flex;gap:4px;padding:0 6px 6px;align-items:center">
      <input id="brd-role-custom-${playerName.replace(/[^a-zA-Z0-9ê°€-í£]/g,'')}" type="text" placeholder="ì§ì ‘ ì…ë ¥..." style="flex:1;padding:4px 7px;border-radius:6px;border:1px solid var(--border2);font-size:11px">
      <button class="btn btn-b btn-xs" onclick="(function(){const inp=document.getElementById('brd-role-custom-${playerName.replace(/[^a-zA-Z0-9ê°€-í£]/g,'')}');if(inp&&inp.value.trim())setBrdRole('${playerName}',inp.value.trim())})()">ì„¤ì •</button>
    </div>
    <div class="brd-move-popup-sep"></div>
    <div style="padding:4px 6px 6px;font-size:11px;font-weight:700;color:var(--text3)">ğŸ« ë‹¤ë¥¸ ëŒ€í•™ìœ¼ë¡œ ì´ë™</div>
    <div style="display:flex;gap:6px;padding:0 6px 4px">
      <select id="brd-univ-target" style="flex:1;padding:5px 8px;border-radius:7px;border:1px solid var(--border2);font-size:12px;background:var(--white)">${univOpts||'<option disabled>ëŒ€í•™ ì—†ìŒ</option>'}</select>
      <button class="btn btn-b btn-xs" onclick="boardTransferPlayer('${playerName}','${univName}')">ì´ë™</button>
    </div>
    <div class="brd-move-popup-sep"></div>
    <button class="brd-move-popup-btn" onclick="_brdPopup&&_brdPopup.remove();_brdPopup=null;openPlayerModal('${playerName}')">ğŸ“‹ ì„ ìˆ˜ ìƒì„¸ ë³´ê¸°</button>
  `;

  document.body.appendChild(popup);

  // ìœ„ì¹˜ ê³„ì‚° - í´ë¦­ ëŒ€ìƒì´ brd-row ë˜ëŠ” brd-chip ì–´ëŠ ê²ƒì´ë“  ì²˜ë¦¬
  const targetEl = e.target.closest('.brd-row, .brd-chip');
  const rect = targetEl?.getBoundingClientRect() || {left:e.clientX, top:e.clientY, width:0, height:0};
  let left = rect.left + rect.width + 6;
  let top = rect.top;
  const pw=240, ph=320;
  if(left + pw > window.innerWidth) left = rect.left - pw - 6;
  if(top + ph > window.innerHeight) top = window.innerHeight - ph - 10;
  if(top < 8) top = 8;
  popup.style.left = left + 'px';
  popup.style.top = top + 'px';
}

function setBrdRole(playerName, role){
  const p=players.find(x=>x.name===playerName);
  if(!p)return;
  p.role=role||undefined;
  // ì§ì±… ë³€ê²½ ì‹œ í•´ë‹¹ ëŒ€í•™ì˜ ìˆ˜ë™ ìˆœì„œ ì´ˆê¸°í™” â†’ ì§ì±… ê¸°ì¤€ ìë™ ì •ë ¬
  if(boardPlayerOrder[p.univ]){
    delete boardPlayerOrder[p.univ];
    saveBoardPlayerOrder();
  }
  save();
  if(_brdPopup){_brdPopup.remove();_brdPopup=null;}
  _refreshBoardCard(p.univ);
}

function boardMovePlayer(playerName, univName, dir){
  if(!isLoggedIn) return;
  if(_brdPopup){ _brdPopup.remove(); _brdPopup=null; }
  const sorted = _getBoardPlayers(univName);
  const idx = sorted.findIndex(p=>p.name===playerName);
  if(idx < 0) return;
  const order = sorted.map(p=>p.name);
  let ni = idx;
  if(dir==='up') ni = Math.max(0, idx-1);
  else if(dir==='down') ni = Math.min(order.length-1, idx+1);
  else if(dir==='top') ni = 0;
  else if(dir==='bottom') ni = order.length-1;
  if(ni===idx) return;
  order.splice(idx,1);
  order.splice(ni,0,playerName);
  boardPlayerOrder[univName] = order;
  saveBoardPlayerOrder();
  // í•´ë‹¹ ì¹´ë“œë§Œ ë‹¤ì‹œ ë Œë”
  _refreshBoardCard(univName);
}

function boardTransferPlayer(playerName, fromUniv){
  if(!isLoggedIn){ alert('ê´€ë¦¬ìë§Œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
  const sel = document.getElementById('brd-univ-target');
  const toUniv = sel?.value;
  if(!toUniv || toUniv===fromUniv){ alert('ì´ë™í•  ëŒ€í•™ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
  if(_brdPopup){ _brdPopup.remove(); _brdPopup=null; }
  const p = players.find(x=>x.name===playerName);
  if(!p) return;
  if(!confirm(`"${playerName}"ì„(ë¥¼) "${fromUniv}" â†’ "${toUniv}"ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìŠ¤íŠ¸ë¦¬ë¨¸ ëª©ë¡Â·í‹°ì–´ ìˆœìœ„í‘œÂ·ì„ ìˆ˜ ìƒì„¸Â·ëŒ€í•™ ìƒì„¸ê°€ ëª¨ë‘ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.`)) return;

  // ì‹¤ì œ ë°ì´í„° ë³€ê²½
  p.univ = toUniv;

  // boardPlayerOrderì—ì„œ ì œê±°
  if(boardPlayerOrder[fromUniv]){
    boardPlayerOrder[fromUniv] = boardPlayerOrder[fromUniv].filter(n=>n!==playerName);
  }

  // ì €ì¥
  save();
  saveBoardPlayerOrder();

  // í˜„í™©íŒ ë‘ ì¹´ë“œ ì¦‰ì‹œ ê°±ì‹ 
  _refreshBoardCard(fromUniv);
  _refreshBoardCard(toUniv);

  // í˜„ì¬ ì—´ë¦° ì„ ìˆ˜ ìƒì„¸ ëª¨ë‹¬ì´ í•´ë‹¹ ì„ ìˆ˜ë©´ ê°±ì‹ 
  const pm = document.getElementById('playerModal');
  if(pm && pm.style.display !== 'none'){
    const nameEl = pm.querySelector('.brd-univ-name-btn, [data-player-name]');
    // ëª¨ë‹¬ íƒ€ì´í‹€ì— ì„ ìˆ˜ ì´ë¦„ì´ ìˆìœ¼ë©´ ê°±ì‹ 
    if(pm.innerHTML && pm.innerHTML.includes(playerName)){
      openPlayerModal(playerName);
    }
  }

  // ì„±ê³µ í† ìŠ¤íŠ¸
  _brdToast(`âœ… "${playerName}" â†’ "${toUniv}" ì´ë™ ì™„ë£Œ`);
}

function _refreshBoardCard(univName){
  const wrap = document.getElementById('board-wrap');
  if(!wrap){ render(); return; }
  const u = getAllUnivs().find(x=>x.name===univName);
  const existing = wrap.querySelector(`.brd-card[data-univ="${univName}"]`);
  // í•´ë‹¹ ëŒ€í•™ì— ì„ ìˆ˜ê°€ ì—†ìœ¼ë©´ ì¹´ë“œ ì œê±°
  if(!u || !players.some(p=>p.univ===univName)){
    if(existing) existing.remove();
    return;
  }
  const newHtml = buildUnivBoardCard(u);
  if(!newHtml){
    if(existing) existing.remove();
    return;
  }
  const tmp = document.createElement('div');
  tmp.innerHTML = newHtml;
  const newCard = tmp.firstElementChild;
  if(existing) existing.replaceWith(newCard);
  else wrap.appendChild(newCard);
  injectUnivIcons(newCard);
  // ìƒˆ ì¹´ë“œì— ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì¬ë“±ë¡
  initBoardDragCard(newCard, wrap);
  // í”Œë ˆì´ì–´ í–‰ ë“œë˜ê·¸ ì¬ë“±ë¡ (ê´€ë¦¬ìë§Œ)
  if(isLoggedIn) newCard.querySelectorAll('.brd-body').forEach(body=>initBoardPlayerDrag(body));
}

/* â”€â”€ ì¹´ë“œ í´ë¦­ ìˆœì„œ ì´ë™ â”€â”€ */
function boardCardMove(univName, dir){
  if(!isLoggedIn) return;
  const wrap = document.getElementById('board-wrap');
  if(!wrap) return;
  const cards = [...wrap.querySelectorAll('.brd-card')];
  const idx = cards.findIndex(c => c.dataset.univ === univName);
  if(idx < 0) return;
  let newIdx;
  if(dir === 'left')  newIdx = idx - 1;
  else                newIdx = idx + 1;
  if(newIdx < 0 || newIdx >= cards.length) return;
  const target = cards[newIdx];
  if(dir === 'left') target.before(cards[idx]);
  else               target.after(cards[idx]);
  // ìˆœì„œ ì €ì¥
  boardOrder = [...wrap.querySelectorAll('.brd-card')].map(c => c.dataset.univ);
  save();
  syncBoardOrderToUnivCfg();
  // ì´ë™ëœ ì¹´ë“œ ì ê¹ í•˜ì´ë¼ì´íŠ¸
  cards[idx].style.outline = '3px solid rgba(255,255,255,.9)';
  setTimeout(() => { cards[idx].style.outline = ''; }, 500);
}

/* â”€â”€ ì¹´ë“œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ â”€â”€ */
function initBoardDrag(){
  const wrap=document.getElementById('board-wrap');
  if(!wrap)return;
  wrap.querySelectorAll('.brd-card').forEach(card=>initBoardDragCard(card, wrap));
  // í”Œë ˆì´ì–´ í–‰ ë“œë˜ê·¸: ê´€ë¦¬ìë§Œ
  if(isLoggedIn) wrap.querySelectorAll('.brd-body').forEach(body=>initBoardPlayerDrag(body));
}

let _brdDragSrc = null;
let _brdRowDragSrc = null; // í”Œë ˆì´ì–´ í–‰ ë“œë˜ê·¸ ì†ŒìŠ¤

function initBoardDragCard(card, wrap){
  // dragstart/dragendëŠ” ì´ì œ brd-hdr ì¸ë¼ì¸ í•¸ë“¤ëŸ¬ë¡œ ì²˜ë¦¬
  // dragover/dropë§Œ ì¹´ë“œ ë ˆë²¨ì—ì„œ ì²˜ë¦¬
  card.addEventListener('dragover',e=>{
    if(_brdRowDragSrc) return; // í”Œë ˆì´ì–´ í–‰ ë“œë˜ê·¸ ì¤‘ì´ë©´ ì¹´ë“œ ì´ë™ ë¬´ì‹œ
    if(!_brdDragSrc) return;
    e.preventDefault();
    e.dataTransfer.dropEffect='move';
    if(_brdDragSrc!==card){
      wrap.querySelectorAll('.brd-card').forEach(c=>c.classList.remove('drag-over'));
      card.classList.add('drag-over');
    }
  });
  card.addEventListener('dragleave',e=>{
    if(!e.currentTarget.contains(e.relatedTarget)) card.classList.remove('drag-over');
  });
  card.addEventListener('drop',e=>{
    if(_brdRowDragSrc) return;
    e.preventDefault();
    if(_brdDragSrc&&_brdDragSrc!==card){
      const cards=[...wrap.querySelectorAll('.brd-card')];
      const si=cards.indexOf(_brdDragSrc), di=cards.indexOf(card);
      if(si<di) card.after(_brdDragSrc); else card.before(_brdDragSrc);
    }
    card.classList.remove('drag-over');
  });
}

/* â”€â”€ í”Œë ˆì´ì–´ í–‰ ë“œë˜ê·¸ ì•¤ ë“œë¡­ (ìŠ¤íŠ¸ë¦¬ë¨¸ ë„¤ëª¨ë°•ìŠ¤ ìˆœì„œ ë³€ê²½ + ëŒ€í•™ ê°„ ì´ë™) â”€â”€ */
function initBoardPlayerDrag(body){
  if(!isLoggedIn) return; // ê´€ë¦¬ìë§Œ

  const getUnivName = ()=> body.closest('.brd-card')?.dataset?.univ || '';

  // brd-body ìì²´ì—ë„ dragover/drop ë“±ë¡ â†’ ë‹¤ë¥¸ ëŒ€í•™ ì¹´ë“œì˜ body ìœ„ë¡œ ë“œë¡­ ì§€ì›
  body.addEventListener('dragover', e=>{
    if(!_brdRowDragSrc) return;
    e.preventDefault(); e.stopPropagation();
    e.dataTransfer.dropEffect='move';
    body.style.outline='2px dashed rgba(255,255,255,.6)';
  });
  body.addEventListener('dragleave', e=>{
    if(!body.contains(e.relatedTarget)) body.style.outline='';
  });
  body.addEventListener('drop', e=>{
    body.style.outline='';
    if(!_brdRowDragSrc) return;
    const targetUniv = getUnivName();
    const srcUniv = _brdRowDragSrc.dataset.univ;
    const playerName = _brdRowDragSrc.dataset.player;
    // ê°™ì€ ì¹´ë“œ ë‚´ ë“œë¡­ì€ row ë ˆë²¨ì—ì„œ ì²˜ë¦¬ë¨ â†’ ì—¬ê¸°ì„œëŠ” ë‹¤ë¥¸ ëŒ€í•™ ì¹´ë“œë¡œ ì´ë™ë§Œ ì²˜ë¦¬
    if(targetUniv && targetUniv !== srcUniv){
      e.preventDefault(); e.stopPropagation();
      if(!confirm(`"${playerName}"ì„(ë¥¼) "${srcUniv}" â†’ "${targetUniv}"ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      const p = players.find(x=>x.name===playerName);
      if(!p) return;
      p.univ = targetUniv;
      if(boardPlayerOrder[srcUniv]){
        boardPlayerOrder[srcUniv] = boardPlayerOrder[srcUniv].filter(n=>n!==playerName);
      }
      save();
      saveBoardPlayerOrder();
      _refreshBoardCard(srcUniv);
      _refreshBoardCard(targetUniv);
      _brdToast(`âœ… "${playerName}" â†’ "${targetUniv}" ì´ë™ ì™„ë£Œ`);
    }
  });

  // brd-row(ì¼ë°˜ ì¹´ë“œ) + brd-chip(ì¹© ë ˆì´ì•„ì›ƒ) ë‘˜ ë‹¤ ë“œë˜ê·¸ ë“±ë¡
  body.querySelectorAll('.brd-row[data-player], .brd-chip[data-player]').forEach(row=>{
    row.addEventListener('dragstart',e=>{
      e.stopPropagation();
      _brdRowDragSrc=row;
      row.style.opacity='.45';
      e.dataTransfer.effectAllowed='move';
      e.dataTransfer.setData('text/player', row.dataset.player+'|'+row.dataset.univ);
    });
    row.addEventListener('dragend',e=>{
      row.style.opacity='';
      document.querySelectorAll('.brd-row, .brd-chip').forEach(r=>r.style.outline='');
      document.querySelectorAll('.brd-body').forEach(b=>b.style.outline='');
      _brdRowDragSrc=null;
    });
    row.addEventListener('dragover',e=>{
      if(!_brdRowDragSrc) return;
      e.preventDefault(); e.stopPropagation();
      e.dataTransfer.dropEffect='move';
      if(_brdRowDragSrc!==row){
        body.querySelectorAll('.brd-row, .brd-chip').forEach(r=>r.style.outline='');
        row.style.outline='2px solid rgba(255,255,255,.85)';
      }
    });
    row.addEventListener('dragleave',e=>{ row.style.outline=''; });
    row.addEventListener('drop',e=>{
      e.preventDefault(); e.stopPropagation();
      row.style.outline='';
      if(!_brdRowDragSrc||_brdRowDragSrc===row) return;
      const targetUniv = row.dataset.univ;
      const srcUniv = _brdRowDragSrc.dataset.univ;
      if(targetUniv !== srcUniv){
        const playerName = _brdRowDragSrc.dataset.player;
        if(!confirm(`"${playerName}"ì„(ë¥¼) "${srcUniv}" â†’ "${targetUniv}"ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        const p = players.find(x=>x.name===playerName);
        if(!p) return;
        p.univ = targetUniv;
        if(boardPlayerOrder[srcUniv]){
          boardPlayerOrder[srcUniv] = boardPlayerOrder[srcUniv].filter(n=>n!==playerName);
        }
        const ti2 = (boardPlayerOrder[targetUniv]||[]).indexOf(row.dataset.player);
        if(!boardPlayerOrder[targetUniv]) boardPlayerOrder[targetUniv] = _getBoardPlayers(targetUniv).map(p=>p.name);
        if(ti2>=0) boardPlayerOrder[targetUniv].splice(ti2,0,playerName);
        else boardPlayerOrder[targetUniv].push(playerName);
        save(); saveBoardPlayerOrder();
        _refreshBoardCard(srcUniv); _refreshBoardCard(targetUniv);
        _brdToast(`âœ… "${playerName}" â†’ "${targetUniv}" ì´ë™ ì™„ë£Œ`);
        return;
      }
      // ê°™ì€ ëŒ€í•™ ë‚´ ìˆœì„œ ë³€ê²½ (ì¹©ì€ flex wrapì´ë¼ DOM ìˆœì„œ ë³€ê²½ì´ ì‹œê°ì ìœ¼ë¡œ ë°˜ì˜ë¨)
      const allItems = [...body.querySelectorAll('.brd-row[data-player], .brd-chip[data-player]')];
      const si=allItems.indexOf(_brdRowDragSrc), di=allItems.indexOf(row);
      if(si>=0 && di>=0 && si!==di){
        if(si<di) row.after(_brdRowDragSrc); else row.before(_brdRowDragSrc);
        const newOrder=[...body.querySelectorAll('.brd-row[data-player], .brd-chip[data-player]')].map(r=>r.dataset.player);
        boardPlayerOrder[targetUniv]=newOrder;
        saveBoardPlayerOrder();
      }
    });
  });
}

// ì „ì²´ì €ì¥: ì„¸ë¡œ ë‚˜ì—´
async function downloadBoardAll(){
  const btn=event?.currentTarget;
  if(btn){btn.disabled=true;btn._ot=btn.textContent;btn.textContent='â³...';}
  try{
    // ì‹¤ì œ í™”ë©´ì— í‘œì‹œëœ DOM ìˆœì„œëŒ€ë¡œ ëŒ€í•™ ê°€ì ¸ì˜¤ê¸°
    const boardWrap=document.getElementById('board-wrap');
    let univs;
    if(boardWrap){
      const cardEls=[...boardWrap.querySelectorAll('.brd-card[data-univ]')];
      const allUnivMap={};
      getAllUnivs().forEach(u=>allUnivMap[u.name]=u);
      univs=cardEls.map(el=>allUnivMap[el.dataset.univ]).filter(Boolean);
    } else {
      univs=_getBoardUnivs();
    }
    const tmpDiv=document.createElement('div');
    let cols=5;
    if(boardWrap){
      const w=boardWrap.offsetWidth;
      cols=Math.max(1,Math.floor(w/294));
    }
    const cardW=280, gap=12, padH=16;
    const totalW=cols*(cardW+gap)-gap+padH*2;
    tmpDiv.style.cssText=`position:fixed;left:-9999px;top:0;width:${totalW}px;background:#f0f2f5;padding:${padH}px;display:grid;grid-template-columns:repeat(${cols},${cardW}px);gap:${gap}px;align-items:start;`;
    univs.forEach(u=>{
      const html=buildUnivBoardCard(u, true);
      if(!html)return;
      const wrapper=document.createElement('div');
      wrapper.innerHTML=html;
      const card=wrapper.firstElementChild;
      card.querySelectorAll('.no-export,.no-export-movebtns').forEach(el=>el.remove());
      tmpDiv.appendChild(card);
    });
    document.body.appendChild(tmpDiv);
    injectUnivIcons(tmpDiv);
    await new Promise(r=>setTimeout(r,500));
    const canvas=await html2canvas(tmpDiv,{scale:2,useCORS:true,backgroundColor:'#f0f2f5',logging:false,width:tmpDiv.scrollWidth,height:tmpDiv.scrollHeight});
    document.body.removeChild(tmpDiv);
    _dlCanvasBoard(canvas,'í˜„í™©íŒ_ì „ì²´ì €ì¥.jpg');
  }catch(e){alert('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: '+e.message);}
  finally{if(btn){btn.disabled=false;btn.textContent=btn._ot||btn.textContent;}}
}

// ëŒ€í•™ë³„ ë‹¤ìš´
async function downloadBoardSel(){
  const btn=event?.currentTarget;
  if(btn){btn.disabled=true;btn._ot=btn.textContent;btn.textContent='â³...';}
  try{
    if(!boardSelUniv||boardSelUniv==='ì „ì²´'){alert('ëŒ€í•™ì„ ì„ íƒí•˜ì„¸ìš”.');return;}
    const u=getAllUnivs().find(x=>x.name===boardSelUniv);
    if(!u){alert('í•´ë‹¹ ëŒ€í•™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');return;}
    // ì‹¤ì œ DOM í˜„í™©íŒì—ì„œ í•´ë‹¹ ëŒ€í•™ ì„ ìˆ˜ ìˆœì„œ ë™ê¸°í™”
    const boardWrap=document.getElementById('board-wrap');
    if(boardWrap){
      const card=boardWrap.querySelector(`.brd-card[data-univ="${boardSelUniv}"]`);
      if(card){
        const domOrder=[...card.querySelectorAll('[data-player]')].map(el=>el.dataset.player).filter(Boolean);
        if(domOrder.length>0) boardPlayerOrder[boardSelUniv]=domOrder;
      }
    }
    const tmpDiv=document.createElement('div');
    tmpDiv.style.cssText='position:fixed;left:-9999px;top:0;width:360px;background:#f0f2f5;padding:12px;';
    tmpDiv.innerHTML=buildUnivBoardCard(u, true);
    tmpDiv.querySelectorAll('.no-export,.no-export-movebtns').forEach(el=>el.remove());
    document.body.appendChild(tmpDiv);
    injectUnivIcons(tmpDiv);
    await new Promise(r=>setTimeout(r,300));
    const canvas=await html2canvas(tmpDiv,{scale:2,useCORS:true,backgroundColor:'#f0f2f5',logging:false});
    document.body.removeChild(tmpDiv);
    _dlCanvasBoard(canvas,'í˜„í™©íŒ_'+boardSelUniv+'.jpg');
  }catch(e){alert('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: '+e.message);}
  finally{if(btn){btn.disabled=false;btn.textContent=btn._ot||btn.textContent;}}
}

function _dlCanvasBoard(canvas,filename){
  const url=canvas.toDataURL('image/jpeg',0.92);
  const a=document.createElement('a');a.href=url;a.download=filename;
  document.body.appendChild(a);a.click();setTimeout(()=>document.body.removeChild(a),100);
}

</script>

<!-- ğŸ“± ëª¨ë°”ì¼ ì „ìš© í”Œë¡œíŒ… ì•¡ì…˜ ë²„íŠ¼ -->
<div id="mobileActionBar" style="display:none;position:fixed;bottom:68px;right:12px;z-index:995;flex-direction:column;gap:8px;align-items:flex-end;">
  <button onclick="cloudLoad()" style="background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;border:none;border-radius:24px;padding:10px 16px;font-size:12px;font-weight:700;font-family:'Noto Sans KR',sans-serif;box-shadow:0 4px 16px rgba(22,163,74,.35);display:flex;align-items:center;gap:6px;cursor:pointer;white-space:nowrap;">
    <span style="font-size:16px">â˜ï¸</span><span>ë¶ˆëŸ¬ì˜¤ê¸°</span>
  </button>
  <button onclick="doJpg()" style="background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border:none;border-radius:24px;padding:10px 16px;font-size:12px;font-weight:700;font-family:'Noto Sans KR',sans-serif;box-shadow:0 4px 16px rgba(37,99,235,.35);display:flex;align-items:center;gap:6px;cursor:pointer;white-space:nowrap;">
    <span style="font-size:16px">ğŸ“·</span><span>ì €ì¥</span>
  </button>
</div>

<!-- ğŸ“± í•˜ë‹¨ ê³ ì • ë„¤ë¹„ê²Œì´ì…˜ ë°” (ëª¨ë°”ì¼) -->
<div id="bottomNav">
  <button class="bnav-item on" id="bn0" onclick="swNav('total',this)"><span>ğŸ“‹</span><span>ìŠ¤íŠ¸ë¦¬ë¨¸</span></button>
  <button class="bnav-item" id="bn1" onclick="swNav('tier',this)"><span>ğŸ“Š</span><span>í‹°ì–´</span></button>
  <button class="bnav-item" id="bn2" onclick="swNav('hist',this)"><span>ğŸ“…</span><span>ê¸°ë¡</span></button>
  <button class="bnav-item" id="bn3" onclick="swNav('mini',this)"><span>âš¡</span><span>ë¯¸ë‹ˆ</span></button>
  <button class="bnav-item" id="bn4" onclick="swNav('stats',this)"><span>ğŸ“ˆ</span><span>í†µê³„</span></button>
  <button class="bnav-item" id="bn5" onclick="swNav('cal',this)"><span>ğŸ—“ï¸</span><span>ìº˜ë¦°ë”</span></button>
</div>
<script>
// ëª¨ë°”ì¼ì—ì„œ mobileActionBar í‘œì‹œ
(function(){
  function checkMobile(){
    const bar=document.getElementById('mobileActionBar');
    if(!bar)return;
    bar.style.display=window.innerWidth<=768?'flex':'none';
  }
  checkMobile();
  window.addEventListener('resize',checkMobile);
})();
</script>

<script>
// â”€â”€ ê²€ìƒ‰ë°” ì‹¤ì‹œê°„ DOM í•„í„°ë§ (render() ì—†ì´ í•œê¸€ IME í˜¸í™˜) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function recFilterInPlace(mode, query) {
  const q = (query || '').toLowerCase().trim();
  const container = document.getElementById('rec-list-' + mode);
  if (!container) return;
  const items = container.querySelectorAll('.rec-summary[data-hay]');
  let shown = 0;
  items.forEach(el => {
    const hay = (el.getAttribute('data-hay') || '').toLowerCase();
    const match = !q || hay.includes(q);
    el.style.display = match ? '' : 'none';
    if (match) shown++;
  });
  // ê²°ê³¼ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
  const countEl = document.getElementById('rq-count-' + mode);
  if (countEl) countEl.textContent = q ? shown + 'ê±´' : '';
  // X ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
  const clearBtn = document.getElementById('rq-clear-' + mode);
  if (clearBtn) clearBtn.style.display = q ? 'inline-block' : 'none';
  // ë¹ˆ ê²°ê³¼ ë©”ì‹œì§€
  const emptyEl = document.getElementById('rq-empty-' + mode);
  if (emptyEl) emptyEl.style.display = (q && shown === 0) ? 'block' : 'none';
  // ì €ì¥
  if (!window._recQ) window._recQ = {};
  window._recQ[mode] = query;
}

function recClearSearch(mode) {
  if (!window._recQ) window._recQ = {};
  window._recQ[mode] = '';
  const inp = document.getElementById('rq-' + mode);
  if (inp) { inp.value = ''; inp.focus(); }
  recFilterInPlace(mode, '');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë¶™ì—¬ë„£ê¸° ìë™ ì…ë ¥ ê¸°ëŠ¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// ë§µ ì•½ì â†’ ì „ì²´ ì´ë¦„ ë§¤í•‘ (ì‹œìŠ¤í…œ maps ë°°ì—´ì—ë„ ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
const PASTE_MAP_ALIAS_DEFAULT = {
  // â”€â”€ ì „ì²´ ì´ë¦„ â”€â”€
  'íˆ¬í˜¼':'íˆ¬í˜¼','ë¼ë°ë¦¬ì•ˆ':'ë¼ë°ë¦¬ì•ˆ','ë…¹ì•„ì›ƒ':'ë…¹ì•„ì›ƒ','ë¦¬íŠ¸ë¦¬íŠ¸':'ë¦¬íŠ¸ë¦¬íŠ¸',
  'í´ë¦¬í¬ì´ë“œ':'í´ë¦¬í¬ì´ë“œ','í”ŒìŠ¤íƒ€':'í”ŒìŠ¤íƒ€','ì˜¥íƒ€ê³¤':'ì˜¥íƒ€ê³¤',
  'ì—í‹°íŠœë“œ':'ì—í‹°íŠœë“œ','ë§¤ì¹˜í¬ì¸íŠ¸':'ë§¤ì¹˜í¬ì¸íŠ¸','ë„ë¯¸ë„¤ì´í„°':'ë„ë¯¸ë„¤ì´í„°',
  'ì‹¤í”¼ë“œ':'ì‹¤í”¼ë“œ','ë¸”ë¦¬ì¸ ':'ë¸”ë¦¬ì¸ ','ì„œí‚·':'ì„œí‚·','ì‹  ê°œë§ˆê³ ì›':'ì‹  ê°œë§ˆê³ ì›',
  'ì•„ì´ì–¸í¬ë¦¬ìŠ¤íŠ¸':'ì•„ì´ì–¸í¬ë¦¬ìŠ¤íŠ¸','íŒŒì´ì¬':'íŒŒì´ì¬','í™”ë‘':'í™”ë‘','ì§€ì˜¥ì„¬':'ì§€ì˜¥ì„¬',
  'íˆ¬ì˜':'íˆ¬ì˜','ë„¤ì˜¤ë¦¬ê²Œì´íŠ¸':'ë„¤ì˜¤ë¦¬ê²Œì´íŠ¸','ë©”íŠ¸ë¡œí´ë¦¬ìŠ¤':'ë©”íŠ¸ë¡œí´ë¦¬ìŠ¤',
  // â”€â”€ ì•½ì â”€â”€
  'ë¼ë°':'ë¼ë°ë¦¬ì•ˆ','ë¼':'ë¼ë°ë¦¬ì•ˆ',
  'ë…¹ì•„':'ë…¹ì•„ì›ƒ','ë…¹':'ë…¹ì•„ì›ƒ',
  'ë¦¬íŠ¸':'ë¦¬íŠ¸ë¦¬íŠ¸','ë¦¬':'ë¦¬íŠ¸ë¦¬íŠ¸',
  'í´':'í´ë¦¬í¬ì´ë“œ','í´ë¦¬':'í´ë¦¬í¬ì´ë“œ','í´ìŠ¤':'í´ë¦¬í¬ì´ë“œ',   // í´ìŠ¤ ì¶”ê°€
  'í”ŒìŠ¤':'í”ŒìŠ¤íƒ€','í”Œë¦½':'í”ŒìŠ¤íƒ€',                             // í”Œë¦½ ì¶”ê°€
  'ì˜¥':'ì˜¥íƒ€ê³¤','ì˜¥íƒ€':'ì˜¥íƒ€ê³¤',                               // ì˜¥íƒ€ ì¶”ê°€
  'ì—í‹°':'ì—í‹°íŠœë“œ','ì—':'ì—í‹°íŠœë“œ',
  'ë§¤':'ë§¤ì¹˜í¬ì¸íŠ¸','ë§¤ì¹˜':'ë§¤ì¹˜í¬ì¸íŠ¸',
  'ë„ë¯¸':'ë„ë¯¸ë„¤ì´í„°','ë„':'ë„ë¯¸ë„¤ì´í„°',
  'ì‹¤':'ì‹¤í”¼ë“œ','ì‹¤í”¼':'ì‹¤í”¼ë“œ',
  'ë¸”ë¦¬':'ë¸”ë¦¬ì¸ ','ë¸”':'ë¸”ë¦¬ì¸ ',
  'ì„œ':'ì„œí‚·',
  'íˆ¬':'íˆ¬í˜¼',
  'ë©”íŠ¸':'ë©”íŠ¸ë¡œí´ë¦¬ìŠ¤','ë©”':'ë©”íŠ¸ë¡œí´ë¦¬ìŠ¤',
  'ê°œë§ˆ':'ì‹  ê°œë§ˆê³ ì›','ì‹ ê°œë§ˆ':'ì‹  ê°œë§ˆê³ ì›','ê°œ':'ì‹  ê°œë§ˆê³ ì›',
  'ì•„ì´':'ì•„ì´ì–¸í¬ë¦¬ìŠ¤íŠ¸','í¬ë¦¬':'ì•„ì´ì–¸í¬ë¦¬ìŠ¤íŠ¸','ì•„ì´ì–¸':'ì•„ì´ì–¸í¬ë¦¬ìŠ¤íŠ¸',
  'íŒŒì´':'íŒŒì´ì¬','íŒŒ':'íŒŒì´ì¬',
  'í™”':'í™”ë‘',
  'ì§€ì˜¥':'ì§€ì˜¥ì„¬','ì§€':'ì§€ì˜¥ì„¬',
  'ë„¤ì˜¤':'ë„¤ì˜¤ë¦¬ê²Œì´íŠ¸','ë¦¬ê²Œ':'ë„¤ì˜¤ë¦¬ê²Œì´íŠ¸',
};

// ê¸°ë³¸ ì•½ì + ì‚¬ìš©ì ì •ì˜ ì•½ìë¥¼ í•©ì³ ë°˜í™˜
function getMapAlias() {
  return Object.assign({}, PASTE_MAP_ALIAS_DEFAULT, (typeof userMapAlias !== 'undefined' ? userMapAlias : {}));
}

/**
 * í˜•ì‹ C íŒŒì‹±: Nì„¸íŠ¸ ë§µì•½ì ì„ ìˆ˜A ëˆ„ì A:ëˆ„ì B ì„ ìˆ˜B
 * ì˜ˆ) "1ì„¸íŠ¸ ì‹¤í”¼ ì´ì¬í˜¸ 0:1 ë³€í˜„ì œ"
 * ëˆ„ì  ìŠ¤ì½”ì–´ë¥¼ ì´ì „ ì¤„ê³¼ ë¹„êµí•´ ì´ë²ˆ ì„¸íŠ¸ ìŠ¹ìë¥¼ íŒë³„.
 * prevScore = {a, b} (ì§ì „ê¹Œì§€ì˜ ëˆ„ì ), nullì´ë©´ 0:0 ê¸°ì¤€
 * ë°˜í™˜: { winName, loseName, map, nextScore:{a,b} } | null
 */
function parseFormatC(line, prevScore) {
  const t = line.trim();

  // í˜•ì‹ C-1: Nì„¸íŠ¸ ë§µ ì„ ìˆ˜A ì ìˆ˜A:ì ìˆ˜B ì„ ìˆ˜B  (ë§µ ìˆìŒ, 5í† í°)
  // í˜•ì‹ C-2: Nì„¸íŠ¸ ì„ ìˆ˜A ì ìˆ˜A:ì ìˆ˜B ì„ ìˆ˜B      (ë§µ ì—†ìŒ, 4í† í°)
  // ì•ì˜ "Nì„¸íŠ¸ / Nì…‹" ì ‘ë‘ì–´ ì œê±° í›„ íŒŒì‹±
  const stripped = t.replace(/^\d+\s*(?:ì„¸íŠ¸|ì…‹)\s+/, '');

  // C-1 ì‹œë„: ë§µ ì„ ìˆ˜A ì ìˆ˜:ì ìˆ˜ ì„ ìˆ˜B (5í† í°)
  const m1 = stripped.match(/^(\S+)\s+(\S+)\s+(\d+)\s*:\s*(\d+)\s+(\S+)$/);
  // C-2 ì‹œë„: ì„ ìˆ˜A ì ìˆ˜:ì ìˆ˜ ì„ ìˆ˜B (3í† í°, ê°€ìš´ë° ì ìˆ˜)
  const m2 = stripped.match(/^(\S+)\s+(\d+)\s*:\s*(\d+)\s+(\S+)$/);

  let mapRaw = null, playerA, playerB, scoreA, scoreB;

  if (m1) {
    const alias = getMapAlias();
    const tok0 = m1[1];
    // tok0ì´ ë§µ ì•½ì/ì´ë¦„ì´ë©´ C-1, ì•„ë‹ˆë©´ C-2(ë§µ ì—†ìŒ)ë¡œ ì²˜ë¦¬
    // íŒë‹¨ ê¸°ì¤€: aliasì— ìˆê±°ë‚˜, maps[]ì— ìˆê±°ë‚˜, ì„ ìˆ˜ ì´ë¦„ì´ ì•„ë‹Œ í•œê¸€ ë‹¨ì–´(ë§µëª… ì¶”ì •)
    const inAlias = !!alias[tok0];
    const inMaps  = typeof maps !== 'undefined' && maps.includes(tok0);
    const isPlayerName = typeof players !== 'undefined' && players.some(p => p.name === tok0);
    // ë§µ íŒë³„:
    //  1) aliasì— ìˆê±°ë‚˜ maps[]ì— ìˆìœ¼ë©´ â†’ ë§µ
    //  2) ì„ ìˆ˜ ì´ë¦„ì— í•´ë‹¹í•˜ë©´ â†’ ì„ ìˆ˜(C-2 ì‹œë„)
    //  3) ë‘˜ ë‹¤ ì•„ë‹ˆë©´ â†’ ë§µìœ¼ë¡œ ì¶”ì • (ì•Œ ìˆ˜ ì—†ëŠ” ë§µëª… í—ˆìš©)
    const isMapToken = inAlias || inMaps || !isPlayerName;
    if (isMapToken) {
      // C-1: ë§µ ìˆìŒ
      mapRaw  = tok0;
      playerA = m1[2];
      scoreA  = parseInt(m1[3]);
      scoreB  = parseInt(m1[4]);
      playerB = m1[5];
    } else if (m2) {
      // tok0ì´ ë§µì´ ì•„ë‹ˆë©´ C-2ë¡œ ì¬ì‹œë„ (tok0 = ì„ ìˆ˜A)
      playerA = m2[1];
      scoreA  = parseInt(m2[2]);
      scoreB  = parseInt(m2[3]);
      playerB = m2[4];
    } else {
      // m1ë§Œ ë§¤ì¹­, tok0ì´ ë§µë„ ì•„ë‹Œ ê²½ìš°: tok0=ì„ ìˆ˜A, m1[2]=ì„ ìˆ˜Bì²˜ëŸ¼ ë³´ì´ì§€ë§Œ
      // ìŠ¤ì½”ì–´ê°€ ê°€ìš´ë°ì— ì—†ìœ¼ë¯€ë¡œ í˜•ì‹Cê°€ ì•„ë‹˜
      return null;
    }
  } else if (m2) {
    playerA = m2[1];
    scoreA  = parseInt(m2[2]);
    scoreB  = parseInt(m2[3]);
    playerB = m2[4];
  } else {
    return null;
  }

  // ë§µ ì´ë¦„ í™•ì •
  const alias = getMapAlias();
  let map = '-';
  if (mapRaw) {
    map = alias[mapRaw] || mapRaw;
    // ë§µ ìë™ ë“±ë¡ ê¸ˆì§€ (ì €ì¥ ì‹œì—ë§Œ ë°˜ì˜)
  }

  // ëˆ„ì  ìŠ¤ì½”ì–´ ë³€í™”ë¡œ ì´ë²ˆ ì„¸íŠ¸ ìŠ¹íŒ¨ íŒë³„
  const prev = prevScore || { a: 0, b: 0 };
  const deltaA = scoreA - prev.a;
  const deltaB = scoreB - prev.b;
  if (deltaA + deltaB !== 1) return null;
  if (deltaA < 0 || deltaB < 0) return null;

  const aWon = deltaA === 1;
  return {
    winName:   aWon ? playerA : playerB,
    loseName:  aWon ? playerB : playerA,
    map,
    nextScore: { a: scoreA, b: scoreB }
  };
}

/**
 * í•œ ì¤„ íŒŒì‹± â†’ {winName, loseName, map} | null
 *
 * ì§€ì› í˜•ì‹ A: [ë§µ] ì„ ìˆ˜ëª…ì¢…ì¡± (ìŠ¹) vs (íŒ¨) ì„ ìˆ˜ëª…ì¢…ì¡±
 * ì§€ì› í˜•ì‹ B: ì„ ìˆ˜ëª…ì¢…ì¡± âœ… ğŸ†š â¬œ ì„ ìˆ˜ëª…ì¢…ì¡± ğŸŒë§µ  (ì´ëª¨ì§€ í˜•ì‹)
 * ì§€ì› í˜•ì‹ C: Nì„¸íŠ¸ ë§µì•½ì ì„ ìˆ˜A ëˆ„ì A:ëˆ„ì B ì„ ìˆ˜B
 *   ì• ë²ˆí˜¸(1. 1ï¸âƒ£ â‘  ë“±) ìë™ ì œê±°
 */
// ë¶€ë¶„ ì´ë¦„ìœ¼ë¡œ ì„ ìˆ˜ ì°¾ê¸° (ì•½ì ë§¤ì¹­)
function findPlayerByPartialName(namePart) {
  if (!namePart) return { player: null, candidates: [] };
  const trimmed = namePart.trim();
  // 1) ì •í™• ì¼ì¹˜
  const exact = players.filter(p => p.name === trimmed);
  if (exact.length === 1) return { player: exact[0], candidates: exact };
  if (exact.length > 1)   return { player: null, candidates: exact };
  // 2) ë¶€ë¶„ ì¼ì¹˜ â€” ê²€ìƒ‰ì–´ê°€ 2ê¸€ì ì´ìƒì¼ ë•Œë§Œ (1ê¸€ì ì˜¤ë§¤ì¹­ ë°©ì§€)
  if (trimmed.length >= 2) {
    const partial = players.filter(p =>
      p.name.includes(trimmed) || trimmed.includes(p.name)
    );
    if (partial.length === 1) return { player: partial[0], candidates: partial };
    if (partial.length > 1)   return { player: null, candidates: partial };
  }
  return { player: null, candidates: [] };
}

// ë¶™ì—¬ë„£ê¸° í…ìŠ¤íŠ¸ë¥¼ ê²½ê¸° ë‹¨ìœ„ ì¤„ ë°°ì—´ë¡œ ë¶„ë¦¬
// ì²˜ë¦¬: 1ï¸âƒ£(Ní‹°ì–´)..2ï¸âƒ£(Ní‹°ì–´).. ì²˜ëŸ¼ í•œ ì¤„ì— ë¶™ì€ ê²½ìš° ë¶„ë¦¬
function splitPasteLines(raw) {
  if (!raw) return [];
  // ì¤„ë°”ê¿ˆ 1ì°¨ ë¶„ë¦¬
  const lines = raw.split(/\r?\n/);
  const result = [];
  lines.forEach(line => {
    line = line.trim();
    if (!line) return;
    // ìˆ«ì+í‚¤ìº¡ì´ëª¨ì§€(\uFE0F\u20E3) ë˜ëŠ” â‘ ~â‘³ì´ index>0ì—ì„œ ë‚˜íƒ€ë‚˜ë©´ ê·¸ ì•ì—ì„œ ë¶„ë¦¬
    // ì˜ˆ: "1ï¸âƒ£...ë¼2ï¸âƒ£...ì‹¤" â†’ ["1ï¸âƒ£...ë¼", "2ï¸âƒ£...ì‹¤"]
    // ê²½ê³„ íŒ¨í„´: ìˆ«ì(0x30-0x39) + \uFE0F + \u20E3  or  â‘ ~â‘³(\u2460-\u2473)
    const positions = [];
    for (let i = 0; i < line.length; i++) {
      const code = line.charCodeAt(i);
      // ìˆ«ì ë¬¸ì ë’¤ì— \uFE0F + \u20E3 ê°€ ì˜¤ë©´ keycap
      if (code >= 0x30 && code <= 0x39) {
        if (line.charCodeAt(i+1) === 0xFE0F && line.charCodeAt(i+2) === 0x20E3) {
          if (i > 0) positions.push(i); // index 0ì´ë©´ ì ‘ë‘ì–´ë¼ ë¶„ë¦¬ ì•ˆí•¨
          i += 2; // FE0F, 20E3 ê±´ë„ˆëœ€
          continue;
        }
      }
      // â‘ ~â‘³ (\u2460~\u2473)
      if (code >= 0x2460 && code <= 0x2473) {
        if (i > 0) positions.push(i);
      }
    }
    if (positions.length === 0) {
      result.push(line);
      return;
    }
    let prev = 0;
    positions.forEach(pos => {
      const seg = line.slice(prev, pos).trim();
      if (seg) result.push(seg);
      prev = pos;
    });
    const last = line.slice(prev).trim();
    if (last) result.push(last);
  });
  return result;
}

/**
 * ìƒˆ í˜•ì‹ (Format D) íŒŒì‹±:
 * Nê²½ê¸° - Ní‹°ì–´\níŒ¨ë°°!\nì´ë¦„T\nVS\nì´ë¦„Z\nìŠ¹ë¦¬!\në§µ: ë§µì´ë¦„\nê²½ê¸°ì¼ ê¸°ì¤€...
 */
function parseFormatD_blocks(raw) {
  const results = [];
  const lines = raw.split(/\r?\n/).map(l=>l.trim());
  // ë¹ˆ ì¤„ ì œì™¸ ì—†ì´ ì¸ë±ìŠ¤ë¡œ ì²˜ë¦¬
  let i=0;
  const nonEmpty = lines.filter(l=>l); // ë¹ˆì¤„ ì œì™¸ ë°°ì—´

  // ì—¬ëŸ¬ ì¤„ì— ê±¸ì³ ì´ë¦„+ì¢…ì¡± ìˆ˜ì§‘ í—¬í¼
  // ì¢…ì¡± ë‹¨ë…ì¤„: T, Z, P, Tì„ í”½, Pì„ í”½, Zì„ í”½, Tí›„í”½, ì„ í”½, í›„í”½ ë“±
  const isRaceLine = l => /^[TZP]?(ì„ í”½|í›„í”½)?$/.test(l) && l.length<=5 && /[TZPì„ í”½í›„]/.test(l);
  const isResultLine = l => l==='ìŠ¹ë¦¬!'||l==='íŒ¨ë°°!';
  const isVsLine = l => /^VS$/i.test(l);
  const isMapLine = l => l.startsWith('ë§µ:');
  const isGameHeader = l => /^\d+ê²½ê¸°/.test(l);
  const isStatLine = l => l.includes('ìƒëŒ€ì „ì ')||l.includes('ê²½ê¸°ì¼');

  // ì „ì²˜ë¦¬: ì—°ì†ëœ ì´ë¦„+ì¢…ì¡±ì¤„ì„ í•©ì¹˜ëŠ” ë¡œì§
  // ex) ["í‚¤ë§P"] ë˜ëŠ” ["í‚¤ë§","P"] ë˜ëŠ” ["ë€¨ì•Œ","Pì„ í”½"] â†’ "í‚¤ë§P" or "ë€¨ì•ŒP"
  function collectName(arr, startIdx) {
    // arr[startIdx]ê°€ ì´ë¦„(ë˜ëŠ” ì´ë¦„+ì¢…ì¡±), ë‹¤ìŒì¤„ì´ ì¢…ì¡± ë‹¨ë…ì¤„ì´ë©´ í•©ì¹¨
    let name = arr[startIdx] || '';
    let nextIdx = startIdx + 1;
    // ë‹¤ìŒ ì¤„ì´ ì¢…ì¡±/í”½ ë‹¨ë…ì¤„ì´ë©´ ë¶™ì„
    if(nextIdx < arr.length && isRaceLine(arr[nextIdx]) && !isResultLine(arr[nextIdx]) && !isVsLine(arr[nextIdx]) && !isMapLine(arr[nextIdx])){
      name += arr[nextIdx];
      nextIdx++;
    }
    // ë˜ ë‹¤ìŒ ì¤„ì´ ì„ í”½/í›„í”½ì´ë©´ ë¶™ì„ (ì´ë¦„P\nì„ í”½ í˜•íƒœ)
    if(nextIdx < arr.length && /^(ì„ í”½|í›„í”½)$/.test(arr[nextIdx])){
      name += arr[nextIdx];
      nextIdx++;
    }
    // ì´ë¦„ì—ì„œ ì¢…ì¡±+í”½ì˜µì…˜ ì œê±°í•˜ì—¬ ìˆœìˆ˜ ì´ë¦„ ì¶”ì¶œ
    const cleaned = name.replace(/[TZP](ì„ í”½|í›„í”½)?$/, '').replace(/(ì„ í”½|í›„í”½)$/, '').trim();
    return { name: cleaned, consumed: nextIdx - startIdx };
  }

  let ni = 0; // nonEmpty ì¸ë±ìŠ¤
  while(ni < nonEmpty.length){
    const line = nonEmpty[ni];
    if(!isGameHeader(line)){ni++;continue;}
    ni++;

    // result1
    let result1=null, result2=null, name1='', name2='', mapName='-';
    if(ni<nonEmpty.length && isResultLine(nonEmpty[ni])){result1=nonEmpty[ni];ni++;}
    else{ni++;continue;}

    // name1: VSê°€ ë‚˜ì˜¬ ë•Œê¹Œì§€ ì´ë¦„ ìˆ˜ì§‘ (ì—¬ëŸ¬ ì¤„ ê°€ëŠ¥)
    {
      const r = collectName(nonEmpty, ni);
      name1 = r.name;
      ni += r.consumed;
    }

    // VS ì¤„
    if(ni<nonEmpty.length && isVsLine(nonEmpty[ni])) ni++;

    // name2
    {
      const r = collectName(nonEmpty, ni);
      name2 = r.name;
      ni += r.consumed;
    }

    // result2
    if(ni<nonEmpty.length && isResultLine(nonEmpty[ni])){result2=nonEmpty[ni];ni++;}

    // ë§µ ì°¾ê¸°
    while(ni<nonEmpty.length){
      const ml=nonEmpty[ni];
      if(isMapLine(ml)){
        const rawMap=ml.replace('ë§µ:','').trim();
        const alias=getMapAlias();
        mapName=alias[rawMap]||rawMap;
        ni++;break;
      }
      if(isGameHeader(ml)||isResultLine(ml))break;
      ni++;
    }

    // ìƒëŒ€ì „ì /ê²½ê¸°ì¼ ì¤„ ìŠ¤í‚µ
    while(ni<nonEmpty.length && (isStatLine(nonEmpty[ni]))){ni++;}

    if(name1&&name2&&result1&&result2){
      let winName='',loseName='';
      if(result1==='ìŠ¹ë¦¬!'&&result2==='íŒ¨ë°°!'){winName=name1;loseName=name2;}
      else if(result1==='íŒ¨ë°°!'&&result2==='ìŠ¹ë¦¬!'){winName=name2;loseName=name1;}
      if(winName&&loseName) results.push({winName,loseName,map:mapName});
    }
  }
  return results;
}

function parsePasteLine(line) {
  line = line.trim();
  if (!line) return null;

  // ì•ìª½ ë²ˆí˜¸/ê¸°í˜¸ ì œê±°
  // "1.", "1)", "1ê²½ê¸°", "1ê²½ê¸°.", "â‘ ~â‘³", "1ï¸âƒ£", "-", "â€¢", "â–¶" ë“±
  // 1ï¸âƒ£(6í‹°ì–´) í˜•íƒœ ë¶„ë¦¬: ì• ì ‘ë‘ì–´ ì œê±° í›„ ì‹¤ì œ ê²½ê¸° ë‚´ìš©ë§Œ ì¶”ì¶œ
  // ì˜ˆ: "1ï¸âƒ£(6í‹°ì–´)íƒ€ë°TâŒğŸ†šâœ…í•˜ì•…ZğŸŒë¼" â†’ "íƒ€ë°TâŒğŸ†šâœ…í•˜ì•…ZğŸŒë¼"
  // í‚¤ìº¡ ì´ëª¨ì§€(\uFE0F\u20E3) í¬í•¨ ì ‘ë‘ì–´ë¥¼ ë¬¸ì ë‹¨ìœ„ë¡œ ì œê±°
  (function(){
    let i = 0;
    const code0 = line.charCodeAt(0);
    // ìˆ«ì+\uFE0F+\u20E3 (keycap ì´ëª¨ì§€) ì œê±°
    if (code0 >= 0x30 && code0 <= 0x39 &&
        line.charCodeAt(1) === 0xFE0F && line.charCodeAt(2) === 0x20E3) {
      line = line.slice(3).trimStart();
    }
    // â‘ ~â‘³ ì œê±°
    else if (code0 >= 0x2460 && code0 <= 0x2473) {
      line = line.slice(1).trimStart();
    }
  })();
  line = line
    .replace(/^\(\d+í‹°ì–´\)\s*/i, '')              // (Ní‹°ì–´) ê´„í˜¸ ì œê±°
    .replace(/^\[\d+í‹°ì–´\]\s*/i, '')              // [Ní‹°ì–´] ì œê±°
    .replace(/^[\d]+\s*ê²½ê¸°[\.\)Â·\s]*/i, '')      // Nê²½ê¸°
    .replace(/^[\d]+[Rë¼r][\.\)Â·\s]*/i, '')       // NR, Në¼ìš´ë“œ
    .replace(/^[\d]+[\.\)]\s*/, '')               // N. N)
    .replace(/^[-â€¢Â·â–¶â–·>\s]+/, '')
    .trim();

  if (!line) return null;

  // â”€â”€ í˜•ì‹ B: ì´ëª¨ì§€ í˜•ì‹ (ğŸ†š) â”€â”€
  if (line.includes('ğŸ†š')) {
    const vsIdx = line.indexOf('ğŸ†š');
    let leftPart  = line.slice(0, vsIdx).trim();
    let rightPart = line.slice(vsIdx + 'ğŸ†š'.length).trim();
    leftPart  = leftPart.replace(/ï¸/g, '').trim();
    rightPart = rightPart.replace(/ï¸/g, '').trim();

    const WIN_MARKS  = ['âœ…', 'â­•'];
    const LOSE_MARKS = ['âŒ', 'â¬œ'];
    const ALL_MARKS  = [...WIN_MARKS, ...LOSE_MARKS];

    let leftMark = null;
    for (const mk of ALL_MARKS) {
      if (leftPart.endsWith(mk)) { leftMark = mk; leftPart = leftPart.slice(0, -mk.length).trim(); break; }
    }
    let rightMark = null;
    for (const mk of ALL_MARKS) {
      if (rightPart.startsWith(mk)) { rightMark = mk; rightPart = rightPart.slice(mk.length).trim(); break; }
    }

    if (!leftMark || !rightMark) return null;

    const leftWin  = WIN_MARKS.includes(leftMark);
    const rightWin = WIN_MARKS.includes(rightMark);
    if (leftWin === rightWin) return null;

    let map = '-';
    let rightClean = rightPart;

    // ë§µ ì¶”ì¶œ: ğŸŒë§µ / ğŸŒë§µ ì´ëª¨ì§€ ë°©ì‹ ë˜ëŠ” [ë§µì•½ì] ë¸Œë¼ì¼“ ë°©ì‹ ëª¨ë‘ ì§€ì›
    const mapEmoji = rightPart.match(/[ğŸŒğŸŒ]\s*(\S+)/);
    const mapBracket = rightPart.match(/\[([^\]]+)\]\s*$/);

    if (mapEmoji) {
      // ì´ëª¨ì§€ ë°©ì‹: ì„ ìˆ˜ëª…ğŸŒë§µ
      const alias = mapEmoji[1].trim();
      map = getMapAlias()[alias] || alias;
      // ë§µ ìë™ ë“±ë¡ ê¸ˆì§€
      rightClean = rightPart.slice(0, mapEmoji.index).trim();
    } else if (mapBracket) {
      // ë¸Œë¼ì¼“ ë°©ì‹: ì„ ìˆ˜ëª… [ë§µì•½ì]
      const alias = mapBracket[1].trim();
      map = getMapAlias()[alias] || alias;
      // ë§µ ìë™ ë“±ë¡ ê¸ˆì§€
      rightClean = rightPart.slice(0, mapBracket.index).trim();
    }

    const splitNR = (s) => {
      const bracketM = s.match(/^(.+?)\[(\d*)([TZP])\]$/);
      if (bracketM) return { name: bracketM[1].trim(), race: bracketM[3] };
      const simpleM = s.match(/^(.+?)([TZP])$/);
      if (simpleM) return { name: simpleM[1].trim(), race: simpleM[2] };
      return { name: s.trim(), race: '' };
    };
    const left  = splitNR(leftPart);
    const right = splitNR(rightClean);
    if (!left.name || !right.name) return null;

    return {
      winName:  leftWin  ? left.name  : right.name,
      loseName: leftWin  ? right.name : left.name,
      map
    };
  }

  // â”€â”€ í˜•ì‹ A: [ë§µ] ì´ë¦„(ìŠ¹/íŒ¨) vs (ìŠ¹/íŒ¨)ì´ë¦„ â”€â”€
  // ë§µ ì¶”ì¶œ: ì¤„ ë§¨ ì• [xxx] ë˜ëŠ” ì¤„ ë [xxx] ë˜ëŠ” ì¤„ ë ë‹¨ì–´(ì•½ì/ë“±ë¡ë§µ)
  let map = '-';
  // 1) ë§¨ ì• [ë§µ]
  const mapMatch = line.match(/^\[([^\]]+)\]/);
  if (mapMatch) {
    const rawAlias = mapMatch[1].trim();
    map = getMapAlias()[rawAlias] || rawAlias;
    line = line.slice(mapMatch[0].length).trim();
  } else {
    // 2) ì¤„ ë [ë§µ]
    const mapEnd = line.match(/\[([^\]]+)\]\s*$/);
    if (mapEnd) {
      const rawAlias = mapEnd[1].trim();
      map = getMapAlias()[rawAlias] || rawAlias;
      line = line.slice(0, mapEnd.index).trim();
    } else {
      // 3) ì¤„ ë ë‹¨ì–´ê°€ alias/mapsì— ìˆìœ¼ë©´ ë§µìœ¼ë¡œ ì²˜ë¦¬
      const lastWord = line.match(/(\S+)\s*$/);
      if (lastWord) {
        const lw = lastWord[1];
        const alias = getMapAlias();
        if (alias[lw]) {
          map = alias[lw];
          line = line.slice(0, lastWord.index).trim();
        } else if (typeof maps !== 'undefined' && maps.includes(lw)) {
          map = lw;
          line = line.slice(0, lastWord.index).trim();
        }
      }
    }
  }

  // vs êµ¬ë¶„ìë¡œ ì¢Œ/ìš° ë¶„ë¦¬
  // ì§€ì›: " vs ", " VS ", " v ", " Vs "
  const vsSplit = line.split(/\s+vs\s+|\s+VS\s+|\s+Vs\s+/i);

  // â”€â”€ í˜•ì‹ A-1: ì¢…ì¡± ìˆìŒ "ì´ë¦„T(ìŠ¹/íŒ¨)" â”€â”€
  const parsePartWithRace = (s) => {
    s = s.trim();
    // ì´ë¦„ ì¢…ì¡±(ì„ íƒ) (ìŠ¹/íŒ¨) : "ì¥ìœ¤ì² T(íŒ¨)", "ì¥ìœ¤ì²  T (íŒ¨)", "ì¥ìœ¤ì² (íŒ¨)"
    const m = s.match(/^(.+?)\s*([TZP])?\s*\((ìŠ¹|íŒ¨)\)$/);
    if (m) return { name: m[1].trim(), race: m[2] || '', result: m[3] };
    // (ìŠ¹/íŒ¨) ì´ë¦„ ì¢…ì¡±(ì„ íƒ) í˜•ì‹: "(íŒ¨) ì´ì¬í˜¸T", "(ìŠ¹)ì´ì¬í˜¸"
    const m2 = s.match(/^\((ìŠ¹|íŒ¨)\)\s*(.+?)\s*([TZP])?$/);
    if (m2) return { name: m2[2].trim(), race: m2[3] || '', result: m2[1] };
    return null;
  };

  if (vsSplit.length >= 2) {
    const p1 = parsePartWithRace(vsSplit[0]);
    const p2 = parsePartWithRace(vsSplit[1]);
    if (p1 && p2) {
      if (p1.result === 'ìŠ¹' && p2.result === 'íŒ¨') return { winName: p1.name, loseName: p2.name, map };
      if (p1.result === 'íŒ¨' && p2.result === 'ìŠ¹') return { winName: p2.name, loseName: p1.name, map };
    }
  }

  // â”€â”€ í˜•ì‹ A-2: vs ì—†ì´ ë‘ ì„ ìˆ˜ê°€ ìˆœì„œëŒ€ë¡œ ë‚˜ì—´ëœ ê²½ìš° â”€â”€
  // ì˜ˆ: "[ì—í‹°] ì¥ìœ¤ì² (íŒ¨) (ìŠ¹)ì´ì¬í˜¸" (vs ìƒëµ)
  {
    const parts = [];
    const pat = /(.+?)\s*([TZP])?\s*\((ìŠ¹|íŒ¨)\)|(\((?:ìŠ¹|íŒ¨)\))\s*(.+?)\s*([TZP])?(?=\s|$)/g;
    let m3;
    while ((m3 = pat.exec(line)) !== null) {
      if (m3[1]) parts.push({ name: m3[1].trim(), result: m3[3] });
      else if (m3[4]) parts.push({ name: m3[5].trim(), result: m3[4].replace(/[()]/g,'') });
    }
    if (parts.length >= 2) {
      const [q1, q2] = parts;
      if (q1.result === 'ìŠ¹' && q2.result === 'íŒ¨') return { winName: q1.name, loseName: q2.name, map };
      if (q1.result === 'íŒ¨' && q2.result === 'ìŠ¹') return { winName: q2.name, loseName: q1.name, map };
    }
  }

  return null;
}

// ì„¸íŠ¸ êµ¬ë¶„ì„  íŒë³„ ë° ì„¸íŠ¸ ë²ˆí˜¸ ì¶”ì¶œ
// ë°˜í™˜: null(ì•„ë‹˜) ë˜ëŠ” ìˆ«ì(ì„¸íŠ¸ë²ˆí˜¸, 0=ì¦ê°€)
function parseSetSeparator(line) {
  const t = line.trim();
  if (!t) return null;

  // ì„¸íŠ¸ ë²ˆí˜¸ ì¶”ì¶œ í—¬í¼
  const extractSetNum = (s) => {
    // ìˆ«ì+ì„¸íŠ¸
    const m1 = s.match(/(\d+)\s*ì„¸íŠ¸/);
    if (m1) return parseInt(m1[1]);
    // í•œê¸€ ìˆ˜ (1ì…‹,2ì…‹,3ì…‹)
    const m2 = s.match(/(\d+)\s*ì…‹/);
    if (m2) return parseInt(m2[1]);
    // ì—ì´ìŠ¤
    if (/ì—ì´ìŠ¤/.test(s)) return 3;
    return null;
  };

  // êµ¬ë¶„ì„  ë¬¸ì ì§‘í•©: â• â”€ = - ã…¡ _ ~ * Â·
  const SEP = /[â•â”€=\-ã…¡_~*Â·]/;

  // íŒ¨í„´ 1: êµ¬ë¶„ì„  ë¬¸ìê°€ 3ê°œ ì´ìƒ í¬í•¨ëœ ì¤„ (ì„¸íŠ¸ ìˆ«ì ìœ ë¬´ ë¬´ê´€)
  // ì˜ˆ: â”€â”€â”€â”€â”€1ì„¸íŠ¸â”€â”€â”€â”€â”€, =====2ì„¸íŠ¸=====, 1ì…‹ã…¡ã…¡ã…¡ã…¡, --2ì„¸íŠ¸--, ======
  // êµ¬ë¶„ì„ : íŠ¹ìˆ˜ë¬¸ì 3ê°œ ì´ìƒ + ì¤„ ê¸¸ì´ì˜ 40% ì´ìƒì´ êµ¬ë¶„ì„  ë¬¸ìì—¬ì•¼ ì„¸íŠ¸êµ¬ë¶„ìœ¼ë¡œ ì¸ì‹
  // (ì´ë¦„ì— í•˜ì´í”ˆ ìˆëŠ” ê²½ìš° ì˜¤íŒŒì‹± ë°©ì§€)
  const sepCount = (t.match(/[â•â”€=\-ã…¡_~]/g) || []).length;
  const isSepLine = sepCount >= 3 && sepCount >= Math.floor(t.length * 0.4);
  if (isSepLine) {
    const n = extractSetNum(t);
    return n !== null ? n : 0; // 0 = ë²ˆí˜¸ ì—†ìœ¼ë©´ ìë™ ì¦ê°€
  }

  // íŒ¨í„´ 2: "Nì„¸íŠ¸" ë˜ëŠ” "Nì…‹" ë‹¨ë… ì¤„ (êµ¬ë¶„ì„  ì—†ì–´ë„)
  // ì˜ˆ: "2ì„¸íŠ¸", "ì„¸íŠ¸ 3", "3ì…‹", "ì—ì´ìŠ¤ì „"
  if (/^(\d+\s*ì„¸íŠ¸|ì„¸íŠ¸\s*\d+|\d+\s*ì…‹|ì…‹\s*\d+|ì—ì´ìŠ¤ì „?|ace)$/i.test(t)) {
    const n = extractSetNum(t);
    return n !== null ? n : 0;
  }

  return null;
}

function pastePreview() {
  const raw = (document.getElementById('paste-input')?.value || '').trim();
  const previewEl = document.getElementById('paste-preview');
  const applyBtn = document.getElementById('paste-apply-btn');
  if (!previewEl) return;
  if (!raw) { previewEl.innerHTML = ''; if(applyBtn) applyBtn.style.display='none'; return; }

  // â”€â”€ í˜•ì‹ D ìš°ì„  ê°ì§€: íŒ¨ë°°!/ìŠ¹ë¦¬! í˜•ì‹ (Nê²½ê¸° - Ní‹°ì–´\níŒ¨ë°°!\nì´ë¦„\nVS\nì´ë¦„\nìŠ¹ë¦¬!\në§µ: ...) â”€â”€
  if (raw.includes('íŒ¨ë°°!') || raw.includes('ìŠ¹ë¦¬!')) {
    const dResults = parseFormatD_blocks(raw);
    if (dResults.length > 0) {
      const results = dResults.map((r, i) => {
        const wMatch = findPlayerByPartialName(r.winName);
        const lMatch = findPlayerByPartialName(r.loseName);
        return {
          winName: r.winName, loseName: r.loseName, map: r.map,
          setNum: i + 1,
          wPlayer: wMatch.player, lPlayer: lMatch.player,
          wCandidates: wMatch.candidates, lCandidates: lMatch.candidates,
          lineNum: i + 1, rawLine: r.winName + ' vs ' + r.loseName
        };
      });
      window._pasteResults = results;
      window._pasteErrors = [];
      renderPastePreview(results, []);
      return;
    }
  }

  const lines = splitPasteLines(raw); // í•œì¤„ ë¶™ì€ ë³µìˆ˜ê²½ê¸° ìë™ ë¶„ë¦¬
  const results = [];
  const errors = [];
  let currentSet = 1;
  let formatCScore = null;   // í˜•ì‹ C ëˆ„ì  ìŠ¤ì½”ì–´ ìƒíƒœ { a, b }
  let isFormatC    = false;  // ì´ë²ˆ ë¸”ë¡ì´ í˜•ì‹ Cì¸ì§€

  lines.forEach((line, idx) => {
    const trimmed = line.trim();
    if (!trimmed) return;

    // â”€â”€ í˜•ì‹ C ìš°ì„  ì‹œë„: Nì„¸íŠ¸ ë§µ ì„ ìˆ˜A ëˆ„ì A:ëˆ„ì B ì„ ìˆ˜B â”€â”€
    const cParsed = parseFormatC(trimmed, formatCScore);
    if (cParsed) {
      // í˜•ì‹ C ì„¸íŠ¸ ë²ˆí˜¸ ì¶”ì¶œ (ì¤„ ì• "Nì„¸íŠ¸/Nì…‹")
      const setNumM = trimmed.match(/^(\d+)\s*(?:ì„¸íŠ¸|ì…‹)/);
      if (setNumM) currentSet = parseInt(setNumM[1]);
      formatCScore = cParsed.nextScore;
      isFormatC = true;
      const wMatch = findPlayerByPartialName(cParsed.winName);
      const lMatch = findPlayerByPartialName(cParsed.loseName);
      results.push({
        winName: cParsed.winName, loseName: cParsed.loseName, map: cParsed.map,
        setNum: currentSet,
        wPlayer: wMatch.player, lPlayer: lMatch.player,
        wCandidates: wMatch.candidates, lCandidates: lMatch.candidates,
        lineNum: idx + 1, rawLine: trimmed
      });
      return;
    }

    // í˜•ì‹ C ë¸”ë¡ì´ ëë‚˜ë©´ ìŠ¤ì½”ì–´ ì´ˆê¸°í™”
    if (isFormatC) { formatCScore = null; isFormatC = false; }

    // ì„¸íŠ¸ êµ¬ë¶„ì„  ì²˜ë¦¬
    const sepResult = parseSetSeparator(trimmed);
    if (sepResult !== null) {
      if (sepResult === 0) currentSet++;
      else currentSet = sepResult;
      return;
    }

    const parsed = parsePasteLine(line);
    if (!parsed) {
      errors.push({ line: idx + 1, raw: trimmed });
      return;
    }
    const wMatch = findPlayerByPartialName(parsed.winName);
    const lMatch = findPlayerByPartialName(parsed.loseName);
    results.push({
      ...parsed,
      setNum: currentSet,
      wPlayer: wMatch.player,
      lPlayer: lMatch.player,
      wCandidates: wMatch.candidates,
      lCandidates: lMatch.candidates,
      lineNum: idx + 1, rawLine: trimmed
    });
  });

  // íŒŒì‹± ê²°ê³¼ ì €ì¥ (ê¸°ì¡´ì— ì‚¬ìš©ìê°€ ì„ íƒí•œ ì„ ìˆ˜ ìœ ì§€)
  if (window._pasteResults) {
    results.forEach((r, i) => {
      const prev = window._pasteResults[i];
      if (!prev) return;
      // ì´ë¯¸ ë‹¨ì¼ ì„ ìˆ˜ë¡œ í™•ì •ëœ ê²½ìš°(ì¤‘ë³µ í•´ì†Œë¨) â†’ ìœ ì§€
      if (prev.wPlayer && prev.wCandidates.length === 1) {
        r.wPlayer     = prev.wPlayer;
        r.winName     = prev.wPlayer.name;
        r.wCandidates = [prev.wPlayer];
      }
      if (prev.lPlayer && prev.lCandidates.length === 1) {
        r.lPlayer     = prev.lPlayer;
        r.loseName    = prev.lPlayer.name;
        r.lCandidates = [prev.lPlayer];
      }
    });
  }
  window._pasteResults = results;
  window._pasteErrors  = errors;  // â† ì˜¤ë¥˜ ëª©ë¡ë„ ë³´ì¡´

  renderPastePreview(results, errors);
}

function renderPastePreview(results, errors) {
  const previewEl = document.getElementById('paste-preview');
  const applyBtn  = document.getElementById('paste-apply-btn');
  const badge     = document.getElementById('paste-summary-badge');
  const pendWarn  = document.getElementById('paste-pending-warn');
  if (!previewEl) return;

  const savable  = (results || []).filter(r => r.wPlayer && r.lPlayer);
  const ambig    = (results || []).filter(r => (!r.wPlayer && r.wCandidates?.length > 1) || (!r.lPlayer && r.lCandidates?.length > 1));
  const missing  = (results || []).filter(r => (!r.wPlayer && !r.wCandidates?.length) || (!r.lPlayer && !r.lCandidates?.length));

  // ìƒë‹¨ ë±ƒì§€
  if (badge) {
    if (results && results.length > 0) {
      badge.style.display = 'inline-block';
      badge.textContent = `âœ… ${savable.length}ê±´ ì €ì¥ ê°€ëŠ¥`;
      if (ambig.length) badge.textContent += ` Â· âš ï¸ ${ambig.length}ê±´ ì„ íƒ í•„ìš”`;
      if (missing.length) badge.textContent += ` Â· âŒ ${missing.length}ê±´ ë¯¸ë“±ë¡`;
      badge.style.background = savable.length === results.length ? '#dcfce7' : '#fef9c3';
      badge.style.color      = savable.length === results.length ? '#16a34a' : '#b45309';
      badge.style.border     = `1px solid ${savable.length === results.length ? '#bbf7d0' : '#fcd34d'}`;
    } else {
      badge.style.display = 'none';
    }
  }

  // í•˜ë‹¨ ê²½ê³ 
  if (pendWarn) pendWarn.style.display = ambig.length ? 'inline' : 'none';

  let html = '';

  if (results && results.length > 0) {
    // ë§µ ëª©ë¡ (ë“œë¡­ë‹¤ìš´ìš©) â€” ì„¤ì • ë§µ + ì•½ì ì „ì²´ê°’ + ì´ë²ˆ íŒŒì‹±ì—ì„œ ì¸ì‹ëœ ë§µ í¬í•¨
    const parsedMaps = results.map(r => r.map).filter(m => m && m !== '-');
    const allMaps = [...new Set([...maps.filter(m=>m&&m!=='-'), ...parsedMaps])].filter(Boolean).sort();

    // ìµœëŒ€ ì„¸íŠ¸ë²ˆí˜¸ ê³„ì‚° (ì„¸íŠ¸ ë“œë¡­ë‹¤ìš´ìš©)
    const maxSet = Math.max(...results.map(r => r.setNum || 1), 3);

    html += `<div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:10px">`;
    html += `<table style="margin:0;width:100%;font-size:12px"><thead><tr>
      <th style="text-align:left;padding:6px 8px;font-size:11px;width:76px">ì„¸íŠ¸</th>
      <th style="text-align:left;padding:6px 8px;font-size:11px;width:90px">ë§µ</th>
      <th style="text-align:left;padding:6px 8px;font-size:11px">ğŸ† ìŠ¹ì</th>
      <th style="text-align:center;padding:6px 4px;font-size:11px;width:32px">â†”</th>
      <th style="text-align:left;padding:6px 8px;font-size:11px">ğŸ’€ íŒ¨ì</th>
      <th style="text-align:left;padding:6px 8px;font-size:11px;width:70px">ìƒíƒœ</th>
      <th style="text-align:center;padding:6px 8px;font-size:11px;width:52px">ê´€ë¦¬</th>
    </tr></thead><tbody>`;

    results.forEach((r, i) => {
      const wOk    = !!r.wPlayer;
      const lOk    = !!r.lPlayer;
      const wAmbig = !wOk && r.wCandidates?.length > 1;
      const lAmbig = !lOk && r.lCandidates?.length > 1;
      const ok     = wOk && lOk;

      const wDisplayName = wOk ? r.wPlayer.name : r.winName;
      const lDisplayName = lOk ? r.lPlayer.name : r.loseName;

      // â”€â”€ ì„ ìˆ˜ ì…€ ë¹Œë” â”€â”€
      const buildCell = (isWin, displayName, resolved, isAmbig, candidates, role) => {
        const style = resolved ? (isWin ? 'color:#16a34a;font-weight:700' : 'color:#dc2626;font-weight:700') : 'color:#b45309;font-weight:700';
        let cell = `<span style="${style}">${displayName}</span>`;
        if (resolved) {
          const p = isWin ? r.wPlayer : r.lPlayer;
          if (p?.univ) cell += `<span style="font-size:10px;color:var(--gray-l);margin-left:4px">(${p.univ})</span>`;
        } else if (isAmbig) {
          cell += `<div style="margin-top:3px;display:flex;flex-wrap:wrap;gap:3px;align-items:center">
            <span style="font-size:10px;color:#b45309;font-weight:600">ì„ íƒ:</span>` +
            candidates.map(c =>
              `<button class="paste-pick-btn" data-idx="${i}" data-role="${role}" data-name="${c.name.replace(/"/g,'&quot;')}"
                style="padding:3px 9px;border-radius:5px;border:1.5px solid #fcd34d;background:#fffbeb;color:#92400e;font-size:11px;font-weight:700;cursor:pointer;transition:.12s"
                onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background='#fffbeb'">
                ${c.name}</button>`
            ).join('') + `</div>`;
        } else {
          // ë¯¸ë“±ë¡: +ë“±ë¡ ë²„íŠ¼
          const safeName = displayName.replace(/"/g,'&quot;');
          cell += `<button class="paste-reg-btn" data-idx="${i}" data-role="${role}" data-name="${safeName}"
            style="margin-left:5px;padding:2px 7px;border-radius:4px;border:1px solid #86efac;background:#f0fdf4;color:#16a34a;font-size:10px;font-weight:700;cursor:pointer;white-space:nowrap;transition:.12s"
            onmouseover="this.style.background='#dcfce7'" onmouseout="this.style.background='#f0fdf4'">+ë“±ë¡</button>`;
        }
        return cell;
      };

      const wCell = buildCell(true,  wDisplayName, wOk, wAmbig, r.wCandidates||[], 'w');
      const lCell = buildCell(false, lDisplayName, lOk, lAmbig, r.lCandidates||[], 'l');

      const statusBadge = ok
        ? `<span style="background:#dcfce7;color:#16a34a;border:1px solid #bbf7d0;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;white-space:nowrap">ì €ì¥ê°€ëŠ¥</span>`
        : (wAmbig || lAmbig)
          ? `<span style="background:#fef9c3;color:#b45309;border:1px solid #fcd34d;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;white-space:nowrap">ì„ íƒí•„ìš”</span>`
          : `<span style="background:#fee2e2;color:#dc2626;border:1px solid #fecaca;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;white-space:nowrap">ë¯¸ë“±ë¡</span>`;

      // â”€â”€ ì„¸íŠ¸ ë“œë¡­ë‹¤ìš´ â”€â”€
      const setOpts = Array.from({length: Math.max(maxSet, r.setNum||1)}, (_,k) => k+1)
        .map(n => `<option value="${n}" ${(r.setNum||1)===n?'selected':''}>${n}ì„¸íŠ¸</option>`).join('');
      const setCell = `<select class="paste-set-sel" data-idx="${i}"
        style="font-size:11px;font-weight:700;border:1px solid var(--border2);border-radius:5px;padding:2px 4px;color:${(r.setNum||1)>=3?'#7c3aed':'var(--blue)'};background:var(--white);cursor:pointer;max-width:72px"
        onchange="pasteChangeSet(${i},parseInt(this.value))">${setOpts}</select>`;

      // â”€â”€ ë§µ ë“œë¡­ë‹¤ìš´ â”€â”€
      const mapVal = r.map && r.map !== '-' ? r.map : '';
      const mapOpts = `<option value="">-</option>` +
        allMaps.map(m => `<option value="${m}" ${mapVal===m?'selected':''}>${m}</option>`).join('');
      const mapCell = `<select class="paste-map-sel" data-idx="${i}"
        style="font-size:11px;border:1px solid ${mapVal?'#7dd3fc':'var(--border2)'};border-radius:5px;padding:2px 4px;background:${mapVal?'#e0f2fe':'var(--white)'};color:${mapVal?'#0369a1':'var(--gray-l)'};cursor:pointer;max-width:88px"
        onchange="pasteChangeMap(${i},this.value)">${mapOpts}</select>`;

      // â”€â”€ ìŠ¹íŒ¨ë°˜ì „ ë²„íŠ¼ â”€â”€
      const flipBtn = `<button class="paste-flip-btn" data-idx="${i}" title="ìŠ¹íŒ¨ ë°˜ì „"
        style="padding:2px 6px;border-radius:4px;border:1px solid var(--border2);background:var(--surface);font-size:12px;cursor:pointer;transition:.12s;line-height:1.4"
        onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='var(--surface)'">ğŸ”„</button>`;

      // â”€â”€ í–‰ ì‚­ì œ ë²„íŠ¼ â”€â”€
      const delBtn = `<button class="paste-del-btn" data-idx="${i}" title="ì´ í–‰ ì‚­ì œ"
        style="padding:2px 6px;border-radius:4px;border:1px solid #fecaca;background:#fff5f5;font-size:12px;cursor:pointer;transition:.12s;line-height:1.4"
        onmouseover="this.style.background='#fee2e2'" onmouseout="this.style.background='#fff5f5'">ğŸ—‘</button>`;

      html += `<tr style="background:${ok ? '' : wAmbig||lAmbig ? '#fffbeb' : '#fff5f5'}">
        <td style="padding:4px 6px">${setCell}</td>
        <td style="padding:4px 6px">${mapCell}</td>
        <td style="padding:4px 8px">${wCell}</td>
        <td style="padding:4px 2px;text-align:center">${flipBtn}</td>
        <td style="padding:4px 8px">${lCell}</td>
        <td style="padding:4px 6px">${statusBadge}</td>
        <td style="padding:4px 6px;text-align:center">${delBtn}</td>
      </tr>`;
    });
    html += `</tbody></table></div>`;
  }

  if (errors && errors.length > 0) {
    html += `<div style="background:#fff5f5;border:1px solid #fca5a5;border-radius:8px;padding:8px 12px;font-size:11px;color:#dc2626">
      <b>âš ï¸ ì¸ì‹ ë¶ˆê°€ ${errors.length}ì¤„</b> (ê²½ê¸° í˜•ì‹ì´ ì•„ë‹Œ ì¤„ì€ ìë™ ë¬´ì‹œë©ë‹ˆë‹¤):<br>
      ${errors.map(e => `<code style="opacity:.75;font-size:10px">${e.line}í–‰: ${e.raw.slice(0,60)}${e.raw.length>60?'â€¦':''}</code>`).join('<br>')}
    </div>`;
  }

  if (savable.length > 0 && applyBtn) {
    applyBtn.style.display = 'inline-flex';
    applyBtn.textContent = `âœ… ${savable.length}ê±´ ì €ì¥í•˜ê¸°`;
  } else if (applyBtn) {
    applyBtn.style.display = 'none';
  }

  previewEl.innerHTML = html;

  // â”€â”€ ì´ë²¤íŠ¸ ë“±ë¡ â”€â”€

  // ì¤‘ë³µ ì„ íƒ ë²„íŠ¼
  previewEl.querySelectorAll('.paste-pick-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      pasteSelectPlayer(parseInt(this.dataset.idx), this.dataset.role, this.dataset.name);
    });
  });

  // ë¯¸ë“±ë¡ ì„ ìˆ˜ +ë“±ë¡ ë²„íŠ¼
  previewEl.querySelectorAll('.paste-reg-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      pasteQuickRegister(parseInt(this.dataset.idx), this.dataset.role, this.dataset.name);
    });
  });

  // ìŠ¹íŒ¨ ë°˜ì „ ë²„íŠ¼
  previewEl.querySelectorAll('.paste-flip-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      pasteFlipResult(parseInt(this.dataset.idx));
    });
  });

  // í–‰ ì‚­ì œ ë²„íŠ¼
  previewEl.querySelectorAll('.paste-del-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      pasteDeleteRow(parseInt(this.dataset.idx));
    });
  });
}

// â”€â”€ ìŠ¹íŒ¨ ë°˜ì „ â”€â”€
function pasteFlipResult(idx) {
  if (!window._pasteResults || !window._pasteResults[idx]) return;
  const r = window._pasteResults[idx];
  // ìŠ¹ìâ†”íŒ¨ì ì „ì²´ ìŠ¤ì™‘
  [r.winName,  r.loseName]  = [r.loseName,  r.winName];
  [r.wPlayer,  r.lPlayer]   = [r.lPlayer,   r.wPlayer];
  [r.wCandidates, r.lCandidates] = [r.lCandidates, r.wCandidates];
  renderPastePreview(window._pasteResults, window._pasteErrors || []);
}

// â”€â”€ ë§µ ì§ì ‘ ë³€ê²½ â”€â”€
function pasteChangeMap(idx, mapVal) {
  if (!window._pasteResults || !window._pasteResults[idx]) return;
  window._pasteResults[idx].map = mapVal || '-';
  renderPastePreview(window._pasteResults, window._pasteErrors || []);
}

// â”€â”€ ì„¸íŠ¸ ë²ˆí˜¸ ë³€ê²½ â”€â”€
function pasteChangeSet(idx, setNum) {
  if (!window._pasteResults || !window._pasteResults[idx]) return;
  window._pasteResults[idx].setNum = setNum;
  renderPastePreview(window._pasteResults, window._pasteErrors || []);
}

// â”€â”€ í–‰ ì‚­ì œ â”€â”€
function pasteDeleteRow(idx) {
  if (!window._pasteResults) return;
  window._pasteResults.splice(idx, 1);
  renderPastePreview(window._pasteResults, window._pasteErrors || []);
}

// â”€â”€ ë¯¸ë“±ë¡ ì„ ìˆ˜ ì¦‰ì‹œ ë“±ë¡ â”€â”€
function pasteQuickRegister(idx, role, name) {
  if (!isLoggedIn) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');

  // ê°„ë‹¨ ì…ë ¥ í¼ ëª¨ë‹¬ (ì¸ë¼ì¸ ìƒì„±)
  const allUnivs = getAllUnivs().map(u => `<option value="${u.name}">${u.name}</option>`).join('');
  const tierOpts = TIERS.map(t => `<option value="${t}">${t}</option>`).join('');

  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(15,23,42,.55);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px)';
  overlay.innerHTML = `
    <div style="background:#fff;border-radius:14px;padding:22px 24px;width:320px;box-shadow:0 20px 60px rgba(0,0,0,.25);font-family:'Noto Sans KR',sans-serif">
      <div style="font-weight:900;font-size:15px;margin-bottom:16px;color:#1a202c">ğŸ‘¤ ì„ ìˆ˜ ì¦‰ì‹œ ë“±ë¡</div>
      <div style="display:flex;flex-direction:column;gap:10px;font-size:13px">
        <div><label style="font-size:11px;font-weight:700;color:#2563eb;display:block;margin-bottom:3px">ì´ë¦„</label>
          <input id="qreg-name" value="${name.replace(/"/g,'&quot;')}" style="width:100%;padding:7px 10px;border:1px solid #cdd3dc;border-radius:7px;font-size:13px;box-sizing:border-box"></div>
        <div><label style="font-size:11px;font-weight:700;color:#2563eb;display:block;margin-bottom:3px">ëŒ€í•™</label>
          <select id="qreg-univ" style="width:100%;padding:7px 10px;border:1px solid #cdd3dc;border-radius:7px;font-size:13px"><option value="">ì„ íƒ ì•ˆí•¨</option>${allUnivs}</select></div>
        <div style="display:flex;gap:8px">
          <div style="flex:1"><label style="font-size:11px;font-weight:700;color:#2563eb;display:block;margin-bottom:3px">í‹°ì–´</label>
            <select id="qreg-tier" style="width:100%;padding:7px 6px;border:1px solid #cdd3dc;border-radius:7px;font-size:12px">${tierOpts}</select></div>
          <div style="flex:1"><label style="font-size:11px;font-weight:700;color:#2563eb;display:block;margin-bottom:3px">ì¢…ì¡±</label>
            <select id="qreg-race" style="width:100%;padding:7px 6px;border:1px solid #cdd3dc;border-radius:7px;font-size:12px">
              <option value="T">í…Œë€</option><option value="Z">ì €ê·¸</option><option value="P">í”„ë¡œí† ìŠ¤</option></select></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:18px;justify-content:flex-end">
        <button id="qreg-cancel" style="padding:7px 16px;border-radius:7px;border:1px solid #cdd3dc;background:#f7f9fc;font-size:13px;font-weight:600;cursor:pointer">ì·¨ì†Œ</button>
        <button id="qreg-ok" style="padding:7px 16px;border-radius:7px;border:none;background:#2563eb;color:#fff;font-size:13px;font-weight:700;cursor:pointer">ë“±ë¡í•˜ê¸°</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  document.getElementById('qreg-cancel').onclick = () => overlay.remove();
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
  document.getElementById('qreg-ok').onclick = () => {
    const newName = document.getElementById('qreg-name').value.trim();
    if (!newName) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
    if (players.find(p => p.name === newName)) return alert('ì´ë¯¸ ë“±ë¡ëœ ì„ ìˆ˜ì…ë‹ˆë‹¤.');
    const newPlayer = {
      name: newName,
      univ: document.getElementById('qreg-univ').value,
      tier: document.getElementById('qreg-tier').value,
      race: document.getElementById('qreg-race').value,
      gender: 'M', win: 0, loss: 0, points: 0, history: []
    };
    players.push(newPlayer);
    save();
    overlay.remove();
    // ë“±ë¡í•œ ì„ ìˆ˜ë¥¼ í•´ë‹¹ í–‰ì— ìë™ ë°˜ì˜
    if (window._pasteResults && window._pasteResults[idx]) {
      const r = window._pasteResults[idx];
      if (role === 'w') {
        r.winName = newPlayer.name; r.wPlayer = newPlayer; r.wCandidates = [newPlayer];
      } else {
        r.loseName = newPlayer.name; r.lPlayer = newPlayer; r.lCandidates = [newPlayer];
      }
    }
    renderPastePreview(window._pasteResults, window._pasteErrors || []);
  };
}

// ì¤‘ë³µ ì„ ìˆ˜ ì„ íƒ â€” ì¬íŒŒì‹± ì—†ì´ ë Œë”ë§ë§Œ ê°±ì‹ 
function pasteSelectPlayer(idx, role, name) {
  if (!window._pasteResults || !window._pasteResults[idx]) return;
  const r = window._pasteResults[idx];
  const p = players.find(pl => pl.name === name);
  if (!p) return;
  if (role === 'w') {
    r.winName      = p.name;
    r.wPlayer      = p;
    r.wCandidates  = [p];
  } else {
    r.loseName     = p.name;
    r.lPlayer      = p;
    r.lCandidates  = [p];
  }
  // ì¬íŒŒì‹± ì—†ì´ ë Œë”ë§ë§Œ ê°±ì‹ 
  renderPastePreview(window._pasteResults, window._pasteErrors || []);
}

function pasteApply() {
  if (!window._pasteResults) return;
  if (!isLoggedIn) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');

  // ëŒ€íšŒ ê²½ê¸° ì„¸íŠ¸ ì ìš© ëª¨ë“œ ë¶„ê¸°
  if (window._grpPasteMode) {
    const savable = window._pasteResults.filter(r => r.wPlayer && r.lPlayer);
    if (!savable.length) return alert('ì €ì¥ ê°€ëŠ¥í•œ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    const ok = _grpPasteApplyLogic(savable);
    if (ok) {
      window._grpPasteMode = false;
      cm('pasteModal');
      window._pasteResults = null;
      window._pasteErrors  = null;
      // ì €ì¥ í˜•ì‹ ì›ë³µ
      const compWrap = document.getElementById('paste-comp-wrap');
      if(compWrap) { compWrap.style.display='none'; compWrap.innerHTML='<input type="text" id="paste-comp-name" placeholder="ëŒ€íšŒëª… ì…ë ¥" style="border:1px solid var(--border2);border-radius:7px;padding:5px 10px;font-size:13px;width:180px">'; }
      const hintEl = document.getElementById('paste-mode-hint');
      if(hintEl) hintEl.textContent='';
      const applyBtn = document.getElementById('paste-apply-btn');
      if(applyBtn) applyBtn.textContent='âœ… ì €ì¥í•˜ê¸°';
    }
    return;
  }

  const mode = document.getElementById('paste-mode')?.value || 'individual';
  const dateVal = document.getElementById('paste-date')?.value || new Date().toISOString().slice(0, 10);
  const compName = document.getElementById('paste-comp-name')?.value?.trim() || '';

  if (mode === 'comp' && !compName) return alert('ëŒ€íšŒëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');

  const savable = window._pasteResults.filter(r => r.wPlayer && r.lPlayer);
  if (!savable.length) return alert('ì €ì¥ ê°€ëŠ¥í•œ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.');

  const matchId = genId();

  // â”€â”€ setsSnap êµ¬ì„± â”€â”€
  // ë¶™ì—¬ë„£ê¸° ì…ë ¥ì˜ ê° í–‰ì€ "ê°œë³„ ê²Œì„ 1ê±´"
  // ì„¸íŠ¸ë²ˆí˜¸ë³„ë¡œ ë¬¶ë˜, ê° ê²Œì„ì˜ ì‹¤ì œ ìŠ¹ì(playerA)ë¥¼ ê¸°ë¡
  const setMap = {};
  savable.forEach(r => {
    const sn = r.setNum || 1;
    if (!setMap[sn]) setMap[sn] = [];
    setMap[sn].push(r);
  });

  // ì „ì²´ ìŠ¹ì ê¸°ì¤€ íŒ€ ê²°ì • (ê°€ì¥ ë§ì´ ì´ê¸´ ìª½ì´ teamA)
  const winCount = {};
  savable.forEach(r => {
    const u = r.wPlayer.name;
    winCount[u] = (winCount[u] || 0) + 1;
  });
  // íŒ€A = ê°€ì¥ ë§ì´ ì´ê¸´ ì„ ìˆ˜, íŒ€B = ë‚˜ë¨¸ì§€ (1:1 ë§¤ì¹˜ì—…ì´ë©´ ê°ê° 1ëª…)
  // mini/univmì€ ëŒ€í•™ ê¸°ì¤€ìœ¼ë¡œ ì•„ë˜ì„œ ë³„ë„ ê³„ì‚°

  const setsSnap = Object.keys(setMap).sort((a,b) => a-b).map(sn => {
    const rows = setMap[sn];
    // ì„¸íŠ¸ ë‚´ ê²Œì„ë“¤: playerA = ìŠ¹ì, playerB = íŒ¨ì, winner í•­ìƒ 'A'
    const games = rows.map(r => ({
      playerA: r.wPlayer.name,
      playerB: r.lPlayer.name,
      map: r.map || '-',
      winner: 'A'
    }));
    // ì„¸íŠ¸ ìŠ¤ì½”ì–´ = ì´ ì„¸íŠ¸ ì•ˆì—ì„œ ê° ì„ ìˆ˜ì˜ ìŠ¹ ìˆ˜
    // (ë‹¨íŒ ì„¸íŠ¸ëŠ” scoreA=1, scoreB=0)
    return { scoreA: games.length, scoreB: 0, winner: 'A', games };
  });

  // totalA = ìŠ¹ë¦¬ ê²Œì„ ìˆ˜, totalB = íŒ¨ë°° ê²Œì„ ìˆ˜
  // â†’ ë¶™ì—¬ë„£ê¸° ì…ë ¥ì—ì„œëŠ” íŒ€ ê°œë…ì´ ì—†ìœ¼ë¯€ë¡œ ì €ì¥ ëª¨ë“œì— ë”°ë¼ ê³„ì‚°
  // mini/univm: ëŒ€í•™ ê¸°ì¤€ íŒ€ êµ¬ë¶„
  // pro: AíŒ€(wPlayer)/BíŒ€(lPlayer) êµ¬ë¶„ ìœ ì§€
  // ê¸°íƒ€: ìŠ¹ë¦¬ ê²Œì„ ìˆ˜ vs íŒ¨ë°° ê²Œì„ ìˆ˜ = savable.length vs 0 (ê°œì¸ì „)
  const totalA = savable.length;
  const totalB = 0;

  // ê°œì¸ ì „ì  ë°˜ì˜ (DB ì‹¤ì œ ì´ë¦„ìœ¼ë¡œ)
  savable.forEach(r => {
    applyGameResult(r.wPlayer.name, r.lPlayer.name, dateVal, r.map || '-', matchId);
  });

  // ëª¨ë“œë³„ ê¸°ë¡ ì¶”ê°€
  if (mode === 'mini') {
    const univWins = {}, univLosses = {};
    savable.forEach(r => {
      const wu = r.wPlayer?.univ; if(wu) univWins[wu] = (univWins[wu]||0)+1;
      const lu = r.lPlayer?.univ; if(lu) univLosses[lu] = (univLosses[lu]||0)+1;
    });
    const teamA = Object.entries(univWins).sort((a,b)=>b[1]-a[1])[0]?.[0] || '';
    const teamB = Object.entries(univLosses).sort((a,b)=>b[1]-a[1])[0]?.[0] || '';
    const sa = univWins[teamA] || 0;
    const sb = univWins[teamB] || 0;
    miniM.unshift({ _id: matchId, d: dateVal, a: teamA, b: teamB, sa, sb, sets: setsSnap });
  } else if (mode === 'univm') {
    const univWins = {}, univLosses = {};
    savable.forEach(r => {
      const wu = r.wPlayer?.univ; if(wu) univWins[wu] = (univWins[wu]||0)+1;
      const lu = r.lPlayer?.univ; if(lu) univLosses[lu] = (univLosses[lu]||0)+1;
    });
    const teamA = Object.entries(univWins).sort((a,b)=>b[1]-a[1])[0]?.[0] || '';
    const teamB = Object.entries(univLosses).sort((a,b)=>b[1]-a[1])[0]?.[0] || '';
    const sa = univWins[teamA] || 0;
    const sb = univWins[teamB] || 0;
    univM.unshift({ _id: matchId, d: dateVal, a: teamA, b: teamB, sa, sb, sets: setsSnap });
  } else if (mode === 'pro') {
    // í”„ë¡œë¦¬ê·¸: ì„¸íŠ¸ë³„ë¡œ ë¬¶ì–´ì„œ ì €ì¥ (ìŠ¹ì=AíŒ€, íŒ¨ì=BíŒ€)
    const mA = [], mB = [];
    savable.forEach(r => {
      if (!mA.find(m => m.name === r.wPlayer.name))
        mA.push({ name: r.wPlayer.name, univ: r.wPlayer.univ||'', race: r.wPlayer.race||'', tier: r.wPlayer.tier||'' });
      if (!mB.find(m => m.name === r.lPlayer.name))
        mB.push({ name: r.lPlayer.name, univ: r.lPlayer.univ||'', race: r.lPlayer.race||'', tier: r.lPlayer.tier||'' });
    });
    // AíŒ€ = ê°€ì¥ ë§ì´ ì´ê¸´ ì„ ìˆ˜ë“¤, BíŒ€ = ì§„ ì„ ìˆ˜ë“¤
    // ì‹¤ì œ íŒ€ë³„ ìŠ¹ìˆ˜: AíŒ€ì´ ì´ê¸´ ê²Œì„ = savable ì „ì²´(ëª¨ë‘ wPlayerê°€ AíŒ€ì›)
    const proTotalA = savable.length;
    const proTotalB = 0;
    proM.unshift({ _id: matchId, d: dateVal, sa: proTotalA, sb: proTotalB,
      teamALabel: 'AíŒ€', teamBLabel: 'BíŒ€',
      teamAMembers: mA, teamBMembers: mB, sets: setsSnap,
      univWins: {}, univLosses: {}
    });
  } else if (mode === 'comp') {
    if (compName && !compNames.includes(compName)) compNames.push(compName);
    curComp = compName;
    comps.unshift({ _id: matchId, d: dateVal, n: compName, a: '', b: '', sa: totalA, sb: totalB, sets: setsSnap });
  }
  // individual: ê°œì¸ ì „ì ë§Œ (ì´ë¯¸ applyGameResult ì²˜ë¦¬ë¨)

  if (typeof fixPoints === 'function') fixPoints();
  save();
  render();

  // ëª¨ë‹¬ ë‹«ê³  ì™„ë£Œ ì•Œë¦¼
  cm('pasteModal');
  window._pasteResults = null;
  window._pasteErrors  = null;

  // ì €ì¥ í˜•ì‹ì— ë”°ë¼ í•´ë‹¹ íƒ­ìœ¼ë¡œ ìë™ ì´ë™
  const tabMap = { mini:'mini', univm:'univm', pro:'pro', comp:'comp' };
  if (tabMap[mode]) {
    const tabBtn = document.querySelector(`.tab[onclick*="sw('${tabMap[mode]}'"]`);
    if (tabBtn) tabBtn.click();
  }

  // ì„±ê³µ í† ìŠ¤íŠ¸
  const modeLabel = { individual:'ê°œì¸ ì „ì ', mini:'ë¯¸ë‹ˆëŒ€ì „', univm:'ëŒ€í•™ëŒ€ì „', pro:'í”„ë¡œë¦¬ê·¸', comp:'ëŒ€íšŒ' }[mode] || '';
  const toast = document.createElement('div');
  toast.textContent = `âœ… ${savable.length}ê±´ ì €ì¥ ì™„ë£Œ${modeLabel ? ' â†’ ' + modeLabel : ''}!`;
  toast.style.cssText = 'position:fixed;bottom:32px;left:50%;transform:translateX(-50%);background:#16a34a;color:#fff;padding:12px 24px;border-radius:10px;font-weight:700;font-size:14px;z-index:99999;box-shadow:0 4px 20px rgba(0,0,0,.2)';
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 2800);
}

function onPasteModeChange(val) {
  const compWrap = document.getElementById('paste-comp-wrap');
  const hint     = document.getElementById('paste-mode-hint');
  if (compWrap) compWrap.style.display = val === 'comp' ? 'flex' : 'none';
  const hints = {
    individual: 'ê°œì¸ ì „ì  íˆìŠ¤í† ë¦¬ì—ë§Œ ê¸°ë¡ë©ë‹ˆë‹¤.',
    mini:       'ë¯¸ë‹ˆëŒ€ì „ ê¸°ë¡ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤. íŒ€ì€ ìŠ¹ì/íŒ¨ì ì†Œì† ëŒ€í•™ìœ¼ë¡œ ìë™ ê²°ì •ë©ë‹ˆë‹¤.',
    univm:      'ëŒ€í•™ëŒ€ì „ ê¸°ë¡ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤. íŒ€ì€ ìŠ¹ì/íŒ¨ì ì†Œì† ëŒ€í•™ìœ¼ë¡œ ìë™ ê²°ì •ë©ë‹ˆë‹¤.',
    pro:        'í”„ë¡œë¦¬ê·¸ ê¸°ë¡ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤. ìŠ¹ìëŠ” AíŒ€, íŒ¨ìëŠ” BíŒ€ìœ¼ë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.',
    comp:       'ëŒ€íšŒ ê¸°ë¡ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤. ì•„ë˜ ëŒ€íšŒëª…ì„ ì…ë ¥í•˜ì„¸ìš”.',
  };
  if (hint) hint.textContent = hints[val] || '';
}

function closePasteModal() {
  // ëŒ€íšŒ ì„¸íŠ¸ ëª¨ë“œì˜€ë‹¤ë©´ UI ì›ë³µ
  if (window._grpPasteMode) {
    window._grpPasteMode = false;
    const compWrap = document.getElementById('paste-comp-wrap');
    if(compWrap) {
      compWrap.style.display='none';
      compWrap.innerHTML='<input type="text" id="paste-comp-name" placeholder="ëŒ€íšŒëª… ì…ë ¥" style="border:1px solid var(--border2);border-radius:7px;padding:5px 10px;font-size:13px;width:180px">';
    }
    const hintEl = document.getElementById('paste-mode-hint');
    if(hintEl) hintEl.textContent='';
    const modeSel = document.getElementById('paste-mode');
    if(modeSel) { modeSel.style.display=''; }
    const modeLabel = document.getElementById('paste-mode-label');
    if(modeLabel) { modeLabel.style.display=''; }
    const applyBtn = document.getElementById('paste-apply-btn');
    if(applyBtn) applyBtn.textContent='âœ… ì €ì¥í•˜ê¸°';
  }
  cm('pasteModal');
}

function openPasteModal() {
  if (!isLoggedIn) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
  window._grpPasteMode = false; // ì¼ë°˜ ëª¨ë“œë¡œ ì´ˆê¸°í™”
  // ë§¤ë²ˆ ì—´ ë•Œ ì´ˆê¸°í™”
  const textarea  = document.getElementById('paste-input');
  const previewEl = document.getElementById('paste-preview');
  const applyBtn  = document.getElementById('paste-apply-btn');
  const badge     = document.getElementById('paste-summary-badge');
  const pendWarn  = document.getElementById('paste-pending-warn');
  if (textarea)  textarea.value  = '';
  if (previewEl) previewEl.innerHTML = '';
  if (applyBtn)  applyBtn.style.display = 'none';
  if (badge)     badge.style.display = 'none';
  if (pendWarn)  pendWarn.style.display = 'none';
  window._pasteResults = null;
  window._pasteErrors  = null;

  const dateInput = document.getElementById('paste-date');
  if (dateInput) dateInput.value = new Date().toISOString().slice(0, 10);

  // ëª¨ë“œ íŒíŠ¸ ì´ˆê¸°í™”
  const modeEl = document.getElementById('paste-mode');
  if (modeEl) onPasteModeChange(modeEl.value);

  om('pasteModal');
}


</script>
</body>
</html>
