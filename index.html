<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>â­ ìŠ¤íƒ€ ëŒ€í•™ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ V31</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root{
  --bg:#f0f2f5;--white:#fff;--surface:#f7f9fc;--border:#e4e8ee;--border2:#cdd3dc;
  --blue:#2563eb;--blue-d:#1d4ed8;--blue-l:#eff6ff;--blue-ll:#dbeafe;
  --gold:#d97706;--gold-bg:#fffbeb;--gold-b:#fde68a;
  --green:#16a34a;--red:#dc2626;--gray:#64748b;--gray-l:#9ca3af;
  --text:#1a202c;--text2:#374151;--text3:#6b7280;
  --god:#7c3aed;--king:#dc2626;--jack:#2563eb;--joker:#16a34a;--spade:#0f172a;
  --r:8px;--sh:0 1px 3px rgba(0,0,0,.06);--sh2:0 4px 20px rgba(0,0,0,.08);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Noto Sans KR',sans-serif;background:#fff;color:var(--text);font-size:13px;padding:16px;line-height:1.5;font-weight:400;}
button{font-family:'Noto Sans KR',sans-serif;cursor:pointer;}
input,select,textarea{font-family:'Noto Sans KR',sans-serif;font-weight:400;}
b,strong{font-weight:600;}
.app{max-width:1480px;margin:auto;background:var(--white);border-radius:14px;border:1px solid var(--border);box-shadow:var(--sh2);overflow:hidden;}
.hdr{background:linear-gradient(135deg,#1e3a8a 0%,#2563eb 55%,#1e40af 100%);padding:14px 24px;display:flex;align-items:center;gap:12px;position:relative;overflow:hidden;}
.hdr::after{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,rgba(255,255,255,.025) 0,rgba(255,255,255,.025) 1px,transparent 1px,transparent 14px);}
.hdr-ico{font-size:22px;z-index:1;}
.hdr-title{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:17px;color:#fff;letter-spacing:.5px;z-index:1;}
.hdr-ver{background:rgba(255,255,255,.15);color:rgba(255,255,255,.9);font-size:10px;padding:2px 9px;border-radius:20px;font-weight:500;letter-spacing:.5px;border:1px solid rgba(255,255,255,.22);z-index:1;}

/* â•â• V27 ì‹ ê·œ CSS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•â• V28 ì‹ ê·œ CSS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fadeIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.score-click{cursor:pointer;padding:2px 10px;border-radius:8px;transition:.12s;}
.score-click:hover{background:var(--blue-ll,#dbeafe);}

/* ì¡°ë³„ ìˆœìœ„í‘œ ì„¸ë ¨í™” */
.grp-rank-table{width:100%;border-collapse:separate;border-spacing:0;border-radius:10px;overflow:hidden;border:1.5px solid var(--border);}
.grp-rank-table th{background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff;padding:9px 14px;font-size:11px;font-weight:700;letter-spacing:.5px;}
.grp-rank-table td{padding:9px 14px;border-bottom:1px solid var(--border);font-size:13px;transition:background .1s;}
.grp-rank-table tr:last-child td{border-bottom:none;}
.grp-rank-table tr:hover td{background:#f0f6ff;}
.grp-rank-top1{background:linear-gradient(90deg,#fffbeb,#fff)!important;}
.grp-rank-top2{background:linear-gradient(90deg,#f1f5f9,#fff)!important;}
.grp-match-card{background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;box-shadow:0 1px 4px rgba(0,0,0,.04);transition:box-shadow .15s;}
.grp-match-card:hover{box-shadow:0 3px 12px rgba(37,99,235,.1);}
.grp-match-vs{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--gray-l);}
.grp-match-score{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:22px;letter-spacing:2px;}
.grp-section-hdr{display:flex;align-items:center;gap:8px;margin-bottom:12px;}
.grp-badge{display:inline-block;padding:4px 14px;border-radius:20px;color:#fff;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px;letter-spacing:.5px;}
/* í‹°ì–´ í•„í„° */
.tier-filter-bar{display:flex;gap:6px;flex-wrap:wrap;padding:10px 0;margin-bottom:8px;align-items:center;}
.tier-filter-btn{padding:4px 13px;border-radius:20px;border:1.5px solid var(--border2);background:#fff;font-size:12px;font-weight:600;cursor:pointer;transition:.15s;}
.tier-filter-btn:hover{border-color:var(--blue);color:var(--blue);}
.tier-filter-btn.on{background:var(--blue);color:#fff;border-color:var(--blue);}
/* ê²½ê¸° ìˆ˜ì • ëª¨ë‹¬ */
.edit-match-modal .mbox{width:680px;}
/* ì´ë¯¸ì§€ ì €ì¥ ë²„íŠ¼ */
.btn-capture{background:linear-gradient(135deg,#7c3aed,#2563eb);color:#fff;border:none;padding:6px 14px;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;transition:.15s;}
.btn-capture:hover{opacity:.88;}
/* ì¡°í¸ì„± ê´€ë¦¬ ìš°ì¸¡ í‹°ì–´ í•„í„° */
.grp-edit-header{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
/* í”„ë¡œë¦¬ê·¸ ìˆ˜ì • ë²„íŠ¼ */
.pro-edit-btn{display:inline-flex;align-items:center;gap:3px;padding:3px 9px;border-radius:5px;background:#ea580c;color:#fff;border:none;font-size:11px;font-weight:600;cursor:pointer;transition:.15s;}
.pro-edit-btn:hover{background:#c2410c;}
/* ì¢…ì¡± í•„í„°ë§ëœ ì„ ìˆ˜ ì„ íƒ ê°œì„  */
.race-player-select{border-left:3px solid var(--blue);background:var(--blue-l)!important;}

.tabs{display:flex;gap:2px;padding:6px 16px;background:var(--surface);border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab{padding:6px 13px;border:none;background:transparent;color:var(--text3);border-radius:6px;font-size:12px;font-weight:500;white-space:nowrap;transition:.15s;}
.tab:hover{background:var(--blue-l);color:var(--blue);}
.tab.on{background:var(--blue);color:#fff;box-shadow:0 1px 8px rgba(37,99,235,.25);}
.tab.cfg{background:transparent;}
.tab.cfg.on{background:#334155;color:#fff;box-shadow:none;}
.fstrip{padding:10px 18px 0;background:var(--surface);border-bottom:1px solid var(--border);}
.form-row{display:flex;gap:8px;margin-bottom:10px;padding:10px 14px;background:var(--white);border-radius:var(--r);flex-wrap:wrap;align-items:center;border:1px solid var(--border);box-shadow:var(--sh);}
.flabel{font-weight:600;font-size:12px;color:var(--blue);white-space:nowrap;}
input,select{padding:6px 10px;border:1px solid var(--border2);border-radius:6px;background:var(--white);color:var(--text);font-size:12px;transition:.15s;}
input:focus,select:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1);}
input::placeholder{color:var(--gray-l);}
.btn{padding:6px 13px;border-radius:6px;border:none;font-size:12px;font-weight:600;transition:.15s;}
.btn-b{background:var(--blue);color:#fff;}.btn-b:hover{background:var(--blue-d);}
.btn-g{background:#16a34a;color:#fff;}.btn-g:hover{background:#15803d;}
.btn-o{background:#ea580c;color:#fff;}.btn-o:hover{background:#c2410c;}
.btn-r{background:#dc2626;color:#fff;}.btn-r:hover{background:#b91c1c;}
.btn-w{background:var(--white);color:var(--text2);border:1px solid var(--border2);}.btn-w:hover{background:var(--surface);}
.btn-p{background:#7c3aed;color:#fff;}.btn-p:hover{background:#6d28d9;}
.btn-xs{padding:2px 8px;font-size:11px;border-radius:5px;}
.btn-sm{padding:4px 10px;font-size:12px;border-radius:6px;}
.btn-detail{padding:3px 10px;border-radius:5px;border:1px solid var(--border2);background:var(--surface);color:var(--text3);font-size:11px;font-weight:500;cursor:pointer;transition:.15s;}
.btn-detail:hover{border-color:var(--blue);color:var(--blue);}
.btn-detail.open{background:var(--blue);color:#fff;border-color:var(--blue);}
.main{padding:18px;}#cap{background:var(--white);text-align:left;}
.rtitle{text-align:center;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px;margin-bottom:16px;color:var(--text);letter-spacing:.5px;}
table{width:100%;border-collapse:collapse;background:transparent;border:1px solid var(--border);border-radius:var(--r);overflow:hidden;height:1px;}
tbody{height:auto;}
table:empty{display:none;}
th{background:var(--surface);padding:8px 12px;border-bottom:1px solid var(--border);color:var(--text3);font-size:11px;letter-spacing:.3px;font-weight:600;}
td{padding:8px 12px;border-bottom:1px solid var(--border);text-align:center;font-weight:400;background:var(--white);}
tr:last-child td{border-bottom:none;}
tr:not(.ugrp):not(.tgrp):hover td{background:#fafbff;}
.ugrp td{background:var(--c,#2563eb);font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;border-top:2px solid var(--c,#2563eb);padding:9px 16px;color:#fff;border-left:4px solid var(--c,#2563eb);text-align:left;text-shadow:0 1px 4px rgba(0,0,0,.2);}
.tgrp td{background:#f7f9fc;color:var(--text3);font-weight:500;font-size:11px;padding:4px 16px 4px 28px;border-bottom:1px solid var(--border);text-align:left;}
.rbadge{font-weight:600;padding:2px 6px;border-radius:4px;font-size:11px;letter-spacing:.3px;}
.rT{background:#dbeafe;color:#1d4ed8;border:1px solid #bfdbfe;}
.rZ{background:#ede9fe;color:#7c3aed;border:1px solid #ddd6fe;}
.rP{background:#fef3c7;color:#b45309;border:1px solid #fde68a;}
.ubadge{padding:2px 9px;border-radius:5px;font-size:11px;font-weight:600;color:#fff!important;display:inline-block;min-width:56px;text-align:center;box-shadow:0 1px 2px rgba(0,0,0,.15);}
.ubadge.loser{opacity:0.32;filter:grayscale(100%);box-shadow:none;}
.tbadge{padding:2px 7px;border-radius:4px;font-size:11px;font-weight:500;}
.tbadge-god{background:#f3e8ff;color:#7c3aed;border:1px solid #ddd6fe;}
.tbadge-king{background:#fee2e2;color:#dc2626;border:1px solid #fecaca;}
.tbadge-jack{background:#dbeafe;color:#1d4ed8;border:1px solid #bfdbfe;}
.tbadge-joker{background:#dcfce7;color:#16a34a;border:1px solid #bbf7d0;}
.tbadge-spade{background:#1e293b;color:#e2e8f0;border:1px solid #334155;}
.tbadge-0{background:var(--gold-bg);color:var(--gold);border:1px solid var(--gold-b);}
.tbadge-default{background:var(--surface);color:var(--text3);border:1px solid var(--border2);}
.wt{color:var(--green);font-weight:600;}
.lt{color:var(--red);font-weight:600;}
.pt-p{color:#16a34a;font-weight:700;}
.pt-n{color:#dc2626;font-weight:700;}
.pt-z{color:#94a3b8;font-weight:400;}
.fbar{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:12px;align-items:center;}
.fbar strong{color:var(--gray-l);font-size:11px;font-weight:500;}
.pill{padding:3px 11px;border-radius:20px;border:1px solid var(--border2);background:var(--white);color:var(--text3);font-size:11px;font-weight:500;cursor:pointer;transition:.15s;}
.pill:hover{border-color:var(--blue);color:var(--blue);}
.pill.on{background:var(--blue);color:#fff;border-color:var(--blue);}
.swrap{position:relative;display:inline-block;}
.sdrop{display:none;position:absolute;top:36px;left:0;background:var(--white);border:1px solid var(--border2);border-radius:8px;width:200px;z-index:500;max-height:190px;overflow-y:auto;box-shadow:var(--sh2);}
.sitem{padding:7px 12px;cursor:pointer;font-size:12px;transition:.1s;}
.sitem:hover{background:var(--blue-l);color:var(--blue);}
.scards{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;}
.scard{flex:1;min-width:120px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;}
.scard .sv{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:24px;}
.scard .sl{font-size:11px;color:var(--gray-l);margin-top:3px;font-weight:400;}
.ipanel{background:var(--blue-l);border:1px solid var(--blue-ll);border-radius:10px;padding:14px 18px;margin-bottom:14px;}
.ocard{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:9px 12px;min-width:100px;text-align:center;}
.rscard{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 16px;text-align:center;flex:1;min-width:100px;}
.rk1{color:#d97706;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;background:#fffbeb;border:1px solid #fcd34d;padding:2px 9px;border-radius:5px;display:inline-block;}
.rk2{color:#6b7280;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;background:#f1f5f9;border:1px solid #e2e8f0;padding:2px 9px;border-radius:5px;display:inline-block;}
.rk3{color:#92400e;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;background:#fef3c7;border:1px solid #fde68a;padding:2px 9px;border-radius:5px;display:inline-block;}
.stabs{display:flex;gap:3px;margin-bottom:14px;flex-wrap:wrap;}
.stab{padding:5px 13px;border-radius:6px;border:1px solid var(--border2);background:var(--white);color:var(--text3);font-size:12px;font-weight:500;cursor:pointer;transition:.15s;}
.stab:hover{background:var(--blue-l);color:var(--blue);}
.stab.on{background:var(--blue);color:#fff;border-color:var(--blue);}
.match-builder{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:18px;}
.match-builder h3{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:var(--blue);margin:-16px -16px 16px;padding:12px 16px;background:var(--blue-l);border-bottom:2px solid var(--blue-ll);border-radius:10px 10px 0 0;}
.set-block{background:var(--white);border:1px solid var(--border2);border-radius:8px;padding:14px;margin-bottom:10px;}
.set-block.ace{border-color:#c4b5fd;}
.set-title{display:flex;align-items:center;gap:8px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.set-badge{display:inline-block;padding:3px 10px;border-radius:5px;font-size:12px;font-weight:600;background:var(--blue);color:#fff;}
.set-badge.ace{background:#7c3aed;}
.game-row{display:flex;align-items:center;gap:6px;margin-bottom:6px;padding:8px 10px;background:var(--surface);border-radius:7px;flex-wrap:wrap;}
.game-row select{flex:1;min-width:110px;}
.win-btn{padding:5px 13px;border-radius:5px;border:1px solid var(--border2);background:var(--white);font-weight:500;font-size:12px;cursor:pointer;transition:.15s;white-space:nowrap;}
.win-btn:hover{border-color:var(--blue);}
.win-btn.win-sel{background:var(--green);color:#fff;border-color:var(--green);}
.win-btn.lose-sel{background:var(--red);color:#fff;border-color:var(--red);}
.score-board{display:flex;align-items:center;gap:12px;padding:10px 16px;background:var(--blue-l);border-radius:8px;margin-bottom:12px;flex-wrap:wrap;}
.score-num{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:26px;}
.rec-summary{background:var(--white);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;overflow:hidden;transition:box-shadow .15s;min-height:44px;}
.rec-summary:empty{display:none!important;}
.rec-summary:hover{box-shadow:var(--sh);}
.rec-sum-header{padding:8px 12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.rec-sum-vs{display:flex;align-items:center;gap:7px;flex:1;flex-wrap:wrap;}
.rec-sum-score{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px;display:flex;align-items:center;gap:5px;}
.rec-detail-area{border-top:1px solid var(--border);padding:10px 12px;background:var(--surface);display:none;}
.rec-detail-area.open{display:block;}
.rec-card{background:var(--white);border:1px solid var(--border);border-radius:8px;margin-bottom:10px;overflow:hidden;}
.rec-header{padding:10px 14px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;background:var(--surface);border-bottom:1px solid var(--border);}
.rec-sets{padding:10px 14px;}
.set-row{margin-bottom:5px;}
.set-row-title{font-size:11px;font-weight:600;color:var(--blue);margin-bottom:5px;padding:2px 7px;background:var(--blue-l);border-radius:4px;display:inline-block;}
.set-row-title.ace-t{color:#7c3aed;background:#f5f3ff;}
.game-detail{display:flex;align-items:center;gap:5px;padding:3px 8px;background:var(--surface);border-radius:5px;margin-bottom:3px;font-size:12px;flex-wrap:wrap;}
.set-result-row{display:flex;align-items:center;gap:7px;padding:6px 10px;background:var(--white);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;}
.set-team-col{flex:1;min-width:80px;}
.set-team-label{font-size:12px;font-weight:600;}
.set-score-center{display:flex;align-items:center;gap:5px;min-width:70px;justify-content:center;}
.set-score-num{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:17px;}
.ck-panel{background:var(--white);border:1px solid var(--border2);border-radius:8px;padding:12px;flex:1;min-width:200px;}
.ck-panel h4{font-size:12px;font-weight:600;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border);}
.mem-tag{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;margin:2px;color:#fff;}
.mem-tag button{background:none;border:none;color:#fff;cursor:pointer;font-size:12px;line-height:1;padding:0 2px;}
.ssec{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:16px 18px;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04);}
.ssec h4{font-family:'Noto Sans KR',sans-serif;font-size:14px;font-weight:800;color:var(--text2);margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid var(--border);}
.srow{display:flex;align-items:center;gap:7px;padding:7px 10px;background:var(--white);border:1px solid var(--border);border-radius:7px;margin-bottom:5px;}
.cdot{width:24px;height:24px;border-radius:5px;flex-shrink:0;}
.modal{display:none;position:fixed;z-index:2000;inset:0;background:rgba(15,23,42,.5);backdrop-filter:blur(4px);}
.mbox{background:var(--white);margin:5% auto;padding:24px;width:500px;max-width:95vw;border-radius:12px;border:1px solid var(--border);box-shadow:0 16px 48px rgba(0,0,0,.16);}
.mtitle{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px;color:var(--blue);margin-bottom:16px;}
.mbox label{display:block;font-size:11px;font-weight:500;color:var(--gray-l);margin-top:10px;margin-bottom:3px;}
.mbox input,.mbox select{width:100%;}
.mbtns{display:flex;gap:7px;margin-top:18px;}
.tour-wrap{background:linear-gradient(160deg,#f8faff,#eff6ff,#f8faff);border-radius:12px;border:1px solid #bfdbfe;padding:48px 20px 32px;overflow-x:auto;position:relative;min-height:500px;}
.tour-wrap::before{content:'â­  STAR UNIVERSITY TOURNAMENT  â­';position:absolute;top:12px;left:50%;transform:translateX(-50%);font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:11px;color:rgba(37,99,235,.18);letter-spacing:5px;white-space:nowrap;}
.tour-inner{display:flex;align-items:center;justify-content:center;gap:0;min-width:860px;}
.rcol{display:flex;flex-direction:column;justify-content:space-around;align-items:center;position:relative;min-width:172px;}
.rcol-lbl{position:absolute;top:-28px;left:50%;transform:translateX(-50%);font-size:9px;font-weight:500;letter-spacing:3px;color:#60a5fa;white-space:nowrap;}
.mcard{background:#fff;border:1px solid #bfdbfe;border-radius:8px;width:150px;padding:9px;margin:8px 0;box-shadow:0 1px 4px rgba(37,99,235,.06);}
.mcard-lbl{font-size:9px;color:#93c5fd;text-align:center;margin-bottom:7px;letter-spacing:1.5px;font-weight:500;}
.mteam{display:flex;align-items:center;justify-content:center;padding:7px 9px;border-radius:5px;border:1px solid #dbeafe;background:#f8faff;min-height:34px;font-size:12px;font-weight:500;color:#94a3b8;}
.mteam.set{color:#1e293b;}
.mvs{text-align:center;font-size:9px;color:#93c5fd;margin:4px 0;font-weight:500;letter-spacing:1.5px;}
.msel-wrap{margin-top:7px;display:flex;flex-direction:column;gap:3px;}
.msel{width:100%;padding:3px 5px;font-size:10px;background:#f8faff;color:#64748b;border:1px solid #bfdbfe;border-radius:4px;}
.conn{width:32px;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.conn-line{width:100%;height:1px;background:linear-gradient(90deg,#93c5fd,rgba(147,197,253,.1));}
.champ-col{display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;min-width:168px;}
.champ-lbl2{position:absolute;top:-28px;left:50%;transform:translateX(-50%);font-size:9px;font-weight:500;letter-spacing:3px;color:#d97706;white-space:nowrap;}
.champ-box{background:linear-gradient(135deg,#fffbeb,#fef3c7);border:1px solid #fcd34d;border-radius:12px;width:158px;padding:16px 12px;text-align:center;box-shadow:0 3px 16px rgba(217,119,6,.14);}
.champ-star{color:#d97706;font-size:10px;letter-spacing:3px;margin-bottom:7px;display:block;}
.champ-lbl{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:10px;color:#d97706;letter-spacing:3px;margin-bottom:8px;}
.champ-team{font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:#92400e;padding:8px 6px;background:rgba(217,119,6,.08);border:1px solid rgba(217,119,6,.3);border-radius:7px;min-height:40px;display:flex;align-items:center;justify-content:center;}
.foot{display:none!important;}
.male-icon{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;background:#2563eb;color:#fff;border-radius:50%;font-size:8px;font-weight:700;margin-left:3px;vertical-align:middle;flex-shrink:0;}
.female-icon{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;background:#db2777;color:#fff;border-radius:50%;font-size:8px;font-weight:700;margin-left:3px;vertical-align:middle;flex-shrink:0;}
.clickable-name{cursor:pointer;color:var(--blue);font-weight:500;border-bottom:1px solid rgba(37,99,235,.25);transition:.12s;}
.clickable-name:hover{border-bottom-color:var(--blue);}
.clickable-univ{cursor:pointer;}
.clickable-univ:hover{opacity:0.82;}
.umbox{background:var(--white);margin:3% auto;padding:24px;width:700px;max-width:96vw;border-radius:12px;border:1px solid var(--border);box-shadow:0 16px 48px rgba(0,0,0,.14);max-height:88vh;overflow-y:auto;}
.login-box input{width:100%;padding:10px 14px;border:1px solid var(--border2);border-radius:8px;font-size:13px;margin-bottom:10px;display:block;}
.login-box input:focus{border-color:var(--blue);outline:none;box-shadow:0 0 0 3px rgba(37,99,235,.1);}
.hdr-login-btn{background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.25);padding:4px 13px;border-radius:20px;font-size:11px;font-weight:500;cursor:pointer;z-index:1;transition:.15s;}
.hdr-login-btn:hover{background:rgba(255,255,255,.28);}
.locked{opacity:.38;pointer-events:none;cursor:not-allowed;}

/* 1:1 ìƒëŒ€ì „ì  */
.vs-box{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px;}
.vs-bar-wrap{height:7px;border-radius:20px;overflow:hidden;background:var(--border);display:flex;margin:8px 0;}
.vs-bar-a{background:var(--blue);transition:width .4s;}
.vs-bar-b{background:var(--red);transition:width .4s;}

/* ë‚ ì§œ ì •ë ¬ */
.sort-bar{display:flex;gap:5px;align-items:center;margin-bottom:8px;flex-wrap:wrap;}
.sort-btn{padding:3px 9px;border-radius:5px;border:1px solid var(--border2);background:var(--white);color:var(--text3);font-size:11px;font-weight:500;cursor:pointer;transition:.12s;}
.sort-btn.on{background:var(--blue);color:#fff;border-color:var(--blue);}
.sort-btn:hover:not(.on){border-color:var(--blue);color:var(--blue);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“± ëª¨ë°”ì¼ UI ê°œì„ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
  body { padding: 0; font-size: 12px; background: #fff; }
  .app { border-radius: 0; border: none; }
  .hdr { padding: 10px 14px; gap: 8px; }
  .hdr-title { font-size: 14px; }
  .hdr-ver { display: none; }
  #globalSearch { width: 110px !important; }

  /* íƒ­ ë©”ë‰´ */
  .tabs { padding: 6px 8px; gap: 3px; }
  .tab { padding: 6px 10px; font-size: 11px; }

  /* í¼ ì˜ì—­ */
  .form-row { flex-direction: column; align-items: stretch; gap: 6px; }
  .form-row input, .form-row select { width: 100%; }
  .flabel { font-size: 11px; }

  /* í…Œì´ë¸” ëª¨ë°”ì¼ ê°€ë…ì„± */
  table { font-size: 11px; }
  th, td { padding: 6px 8px; }
  .ubadge { min-width: 44px; font-size: 10px; padding: 2px 6px; }

  /* ë²„íŠ¼ í¬ê¸° */
  .btn { padding: 8px 14px; font-size: 12px; }
  .btn-sm { padding: 7px 12px; font-size: 11px; }
  .btn-xs { padding: 5px 8px; font-size: 10px; }

  /* ë©”ì¸ ì½˜í…ì¸  */
  .main { padding: 12px; }
  .ssec { padding: 12px; }
  .scards { gap: 8px; }
  .scard { min-width: 90px; padding: 10px; }
  .scard .sv { font-size: 20px; }

  /* í‘¸í„° */
  /* .foot ì œê±°ë¨ */

  /* ëª¨ë‹¬ */
  .mbox { width: 95vw !important; padding: 18px !important; margin: 10% auto !important; }
  .umbox { width: 96vw !important; padding: 14px !important; margin: 4% auto !important; }

  /* ì ìˆ˜ë³´ë“œ */
  .score-board { gap: 8px; padding: 10px 12px; }
  .score-num { font-size: 22px; }

  /* ëŒ€ì „ ì¹´ë“œ */
  .rec-header { padding: 8px 10px; gap: 6px; }
  .rec-sum-score { font-size: 18px; }

  /* íˆ¬ì–´ë„ˆë¨¼íŠ¸ */
  .tour-wrap { padding: 36px 12px 20px; }
  .mcard { width: 120px; padding: 8px; }

  /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” ìˆ¨ê¹€ ê³µê°„ í™•ë³´ */
  #bottomNav { display: flex !important; }
}

@media (min-width: 769px) {
  #bottomNav { display: none !important; }
}

/* í•˜ë‹¨ ê³ ì • ë„¤ë¹„ê²Œì´ì…˜ ë°” */
#bottomNav {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: #fff;
  border-top: 1px solid var(--border);
  z-index: 1000;
  padding: 6px 0 env(safe-area-inset-bottom, 6px);
  box-shadow: 0 -2px 12px rgba(0,0,0,.08);
}
.bnav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  padding: 4px 2px;
  cursor: pointer;
  border: none;
  background: none;
  font-family: 'Noto Sans KR', sans-serif;
  color: var(--gray-l);
  font-size: 9px;
  font-weight: 600;
  transition: .15s;
}
.bnav-item.on { color: var(--blue); }
.bnav-item span:first-child { font-size: 18px; }
</style>
</head>
<body>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ (í—¤ë” ë²„íŠ¼ í´ë¦­ ì‹œ) -->
<div id="loginModal" class="modal no-export" style="display:none">
  <div class="mbox" style="width:340px;text-align:center;padding:32px 28px">
    <div style="font-size:32px;margin-bottom:8px">ğŸ”</div>
    <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:17px;color:#1e3a8a;margin-bottom:20px">ê´€ë¦¬ì ë¡œê·¸ì¸</div>
    <input type="text" id="li-id" placeholder="ì•„ì´ë””" autocomplete="username"
      style="width:100%;padding:10px 14px;border:1.5px solid var(--border2);border-radius:8px;font-size:13px;margin-bottom:10px;display:block"
      onkeydown="if(event.key==='Enter')document.getElementById('li-pw').focus()">
    <input type="password" id="li-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password"
      style="width:100%;padding:10px 14px;border:1.5px solid var(--border2);border-radius:8px;font-size:13px;margin-bottom:10px;display:block"
      onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()" style="width:100%;padding:11px;background:linear-gradient(135deg,#1e3a8a,#2563eb);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer">ğŸ” ë¡œê·¸ì¸</button>
    <div class="login-err" id="li-err" style="color:#dc2626;font-size:12px;margin-top:8px;min-height:18px"></div>
    <button onclick="cm('loginModal')" style="margin-top:10px;background:none;border:none;color:var(--gray-l);font-size:12px;cursor:pointer">ì·¨ì†Œ</button>
  </div>
</div>

<div class="app">
<div class="hdr">
  <span class="hdr-ico">ğŸ†</span>
  <div class="hdr-title">ìŠ¤íƒ€ ëŒ€í•™ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
  <div class="hdr-ver">V31</div>
  <div style="margin-left:auto;display:flex;gap:6px;z-index:1;align-items:center">
    <!-- ì „ì²´ ì„ ìˆ˜ ê²€ìƒ‰ -->
    <div style="position:relative">
      <input id="globalSearch" type="text" placeholder="ğŸ” ì„ ìˆ˜ ê²€ìƒ‰..." oninput="onGlobalSearch(this.value)"
        style="width:160px;padding:5px 12px;border-radius:20px;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.15);color:#fff;font-size:12px;outline:none;"
        onfocus="this.style.background='rgba(255,255,255,.25)'" onblur="this.style.background='rgba(255,255,255,.15)'">
      <div id="globalSearchDrop" style="display:none;position:fixed;top:50px;right:16px;background:#fff;border:1px solid var(--border2);border-radius:10px;width:300px;max-height:360px;overflow-y:auto;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,.22)"></div>
    </div>
    <span id="hdrLoginStatus" style="color:rgba(255,255,255,.7);font-size:11px;display:none">âœ… ê´€ë¦¬ì</span>
    <button id="hdrLoginBtn" class="hdr-login-btn" onclick="om('loginModal')">ğŸ” ë¡œê·¸ì¸í•˜ê¸°</button>
    <button id="hdrLogoutBtn" class="hdr-login-btn" style="display:none;background:rgba(220,38,38,.4);border-color:rgba(220,38,38,.5)" onclick="doLogout()">ğŸ”“ ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</div>

<div class="tabs no-export">
  <button class="tab on"  onclick="sw('total',this)">ğŸ“‹ ìŠ¤íŠ¸ë¦¬ë¨¸</button>
  <button class="tab"     onclick="sw('tier',this)">ğŸ“Š í‹°ì–´ ìˆœìœ„í‘œ</button>
  <button class="tab"     onclick="sw('hist',this)">ğŸ“… ëŒ€ì „ ê¸°ë¡</button>
  <button class="tab"     onclick="sw('mini',this)">âš¡ ë¯¸ë‹ˆëŒ€ì „</button>
  <button class="tab"     onclick="sw('univck',this)">ğŸ¤ ëŒ€í•™CK</button>
  <button class="tab"     onclick="sw('univm',this)">ğŸŸï¸ ëŒ€í•™ëŒ€ì „</button>
  <button class="tab"     onclick="sw('comp',this)">ğŸ–ï¸ ëŒ€íšŒ</button>
  <button class="tab"     onclick="sw('pro',this)">ğŸ… í”„ë¡œë¦¬ê·¸</button>
  <button class="tab" onclick="sw('stats',this)">ğŸ“Š í†µê³„</button>
  <button class="tab" onclick="sw('cal',this)">ğŸ“… ìº˜ë¦°ë”</button>
  <button id="tabMember" class="tab" onclick="sw('member',this)">ğŸ‘¥ íšŒì›ê´€ë¦¬</button>
  <button id="tabCfg" class="tab cfg" onclick="sw('cfg',this)">âš™ï¸ ì„¤ì •</button>
</div>

<div id="fstrip" class="fstrip no-export lock-admin">
  <div class="form-row">
    <span class="flabel">ğŸ¬ ìŠ¤íŠ¸ë¦¬ë¨¸ ë“±ë¡</span>
    <select id="p-univ"></select>
    <select id="p-tier"></select>
    <select id="p-race"><option value="T">í…Œë€</option><option value="Z">ì €ê·¸</option><option value="P">í”„ë¡œí† ìŠ¤</option></select>
    <select id="p-gender"><option value="F">ğŸ‘© ì—¬ì</option><option value="M">ğŸ‘¨ ë‚¨ì</option></select>
    <input type="text" id="p-name" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„" style="width:120px;">
    <button class="btn btn-b" onclick="addPlayer()">+ ë“±ë¡</button>
  </div>
  <div class="form-row" style="border-color:#93c5fd;background:#f0f6ff;">
    <span class="flabel">âš”ï¸ ê²½ê¸° ê¸°ë¡</span>
    <input type="date" id="m-date">
    <div class="swrap">
      <input type="text" id="ws" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ê²€ìƒ‰..." onkeyup="fsearch('w')" style="width:130px;">
      <div id="wl" class="sdrop"></div>
    </div>
    <span style="font-weight:800;color:var(--gray-l);">VS</span>
    <div class="swrap">
      <input type="text" id="ls" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ê²€ìƒ‰..." onkeyup="fsearch('l')" style="width:130px;">
      <div id="ll" class="sdrop"></div>
    </div>
    <select id="m-map"></select>
    <button class="btn btn-g" onclick="recMatch()">ğŸ’¾ ì €ì¥</button>
  </div>
</div>

<div class="main"><div id="cap">
  <div class="rtitle" id="rtitle"></div>
  <div id="farea" class="no-export"></div>
  <div id="rcont"></div>
</div></div>

<!-- í•˜ë‹¨ ì•¡ì…˜ ë²„íŠ¼ ë°” -->
<input type="file" id="fi" style="display:none" onchange="doFile(this)">
<div id="actionBar" style="display:flex;align-items:center;gap:8px;padding:10px 18px;background:var(--surface);border-top:1px solid var(--border);flex-wrap:wrap;">
  <button class="btn btn-b" onclick="doJpg()" style="display:flex;align-items:center;gap:5px;"><span>ğŸ“·</span> JPG ì €ì¥</button>
  <button class="btn btn-g" onclick="cloudLoad()" style="display:flex;align-items:center;gap:5px;"><span>â˜ï¸</span> ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <button id="btnExportVis" class="btn btn-w" onclick="doExport()" style="display:none;align-items:center;gap:5px;border:1px solid var(--border2);"><span>ğŸ“¤</span> ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
  <button id="btnImportVis" class="btn btn-w" onclick="doImport()" style="display:none;align-items:center;gap:5px;border:1px solid var(--border2);"><span>ğŸ“</span> ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
  <span id="cloudStatus" style="font-size:12px;color:var(--gray-l);margin-left:4px"></span>
  <span id="exportHint" style="font-size:12px;color:var(--gray-l)">ğŸ’¡ ë‹¤ë¥¸ ê¸°ê¸°ì™€ ê³µìœ  ì‹œ ë°ì´í„° ë‚´ë³´ë‚´ê¸° â†’ ê°€ì ¸ì˜¤ê¸°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”</span>
</div>
</div>

<!-- ì„ ìˆ˜ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="emModal" class="modal no-export">
  <div class="mbox">
    <div class="mtitle">âœï¸ ì„ ìˆ˜ ì •ë³´ ìˆ˜ì •</div>
    <div id="emBody"></div>
    <div class="mbtns">
      <button class="btn btn-b" style="flex:1" onclick="savePlayer()">ì €ì¥</button>
      <button class="btn btn-r" style="flex:1" onclick="delPlayer()">ì‚­ì œ</button>
      <button class="btn btn-w" style="flex:1" onclick="cm('emModal')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- ê¸°ë¡ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="reModal" class="modal no-export">
  <div class="mbox">
    <div class="mtitle" id="reTitle">ìˆ˜ì •</div>
    <div id="reBody"></div>
    <div class="mbtns">
      <button class="btn btn-b" style="flex:1" onclick="saveRow()">ì €ì¥</button>
      <button class="btn btn-w" style="flex:1" onclick="cm('reModal')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- ëŒ€íšŒëª… ê´€ë¦¬ ëª¨ë‹¬ -->
<div id="cnModal" class="modal no-export">
  <div class="mbox" style="width:420px;">
    <div class="mtitle">ğŸ–ï¸ ëŒ€íšŒëª… ê´€ë¦¬</div>
    <div id="cnBody"></div>
    <div class="mbtns"><button class="btn btn-w" style="flex:1" onclick="cm('cnModal')">ë‹«ê¸°</button></div>
  </div>
</div>

<!-- ì„ ìˆ˜ ìƒì„¸ ëª¨ë‹¬ -->
<div id="playerModal" class="modal no-export">
  <div class="umbox">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:8px;flex-wrap:wrap">
      <div class="mtitle" id="playerModalTitle" style="margin-bottom:0">ì„ ìˆ˜ ìƒì„¸</div>
      <div style="display:flex;gap:6px;align-items:center">
        <button id="playerModalEditBtn" class="btn btn-o btn-sm" style="display:none" onclick="openEPFromModal()">âœï¸ ìˆ˜ì •</button>
        <button class="btn-capture" onclick="capturePlayerModal()">ğŸ“¸ ì´ë¯¸ì§€ ì €ì¥</button>
        <button class="btn btn-w btn-sm" onclick="cm('playerModal')">âœ• ë‹«ê¸°</button>
      </div>
    </div>
    <div id="playerModalBody"></div>
  </div>
</div>

<!-- ëŒ€í•™ ìƒì„¸ ëª¨ë‹¬ -->
<div id="univModal" class="modal no-export">
  <div class="umbox">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:8px;flex-wrap:wrap">
      <div class="mtitle" id="univModalTitle" style="margin-bottom:0">ëŒ€í•™ ìƒì„¸</div>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="btn-capture" onclick="captureUnivModal()">ğŸ“¸ ì´ë¯¸ì§€ ì €ì¥</button>
        <button class="btn btn-w btn-sm" onclick="cm('univModal')">âœ• ë‹«ê¸°</button>
      </div>
    </div>
    <div id="univModalBody"></div>
  </div>
</div>

<!-- ì¡°í¸ì„± ê²½ê¸° ì…ë ¥ ëª¨ë‹¬ -->
<div id="grpMatchModal" class="modal no-export">
  <div class="umbox" style="width:780px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="mtitle" id="grpMatchTitle" style="margin-bottom:0">ê²½ê¸° ì…ë ¥</div>
      <button class="btn btn-w btn-sm" onclick="cm('grpMatchModal')">âœ• ë‹«ê¸°</button>
    </div>
    <div id="grpMatchBody"></div>
  </div>
</div>

<!-- íšŒì› ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
<div id="memberModal" class="modal no-export">
  <div class="umbox" style="width:680px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="mtitle" id="memberModalTitle" style="margin-bottom:0">íšŒì› ì¶”ê°€</div>
      <button class="btn btn-w btn-sm" onclick="cm('memberModal')">âœ• ë‹«ê¸°</button>
    </div>
    <div id="memberModalBody"></div>
    <div class="mbtns" style="margin-top:16px">
      <button class="btn btn-b" style="flex:1" onclick="memberSave()">ğŸ’¾ ì €ì¥</button>
      <button class="btn btn-w" style="flex:1" onclick="cm('memberModal')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- íšŒì› ìƒì„¸ ëª¨ë‹¬ -->
<div id="memberDetailModal" class="modal no-export">
  <div class="umbox" style="width:680px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="mtitle" id="memberDetailTitle" style="margin-bottom:0">íšŒì› ìƒì„¸</div>
      <button class="btn btn-w btn-sm" onclick="cm('memberDetailModal')">âœ• ë‹«ê¸°</button>
    </div>
    <div id="memberDetailBody"></div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS - í‹°ì–´ ìˆœì„œ: god > king > jack > joker > spade > 0í‹°ì–´ > 1í‹°ì–´ ...
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let TIERS = J('su_tiers') || ['G','K','JA','J','S','0í‹°ì–´','1í‹°ì–´','2í‹°ì–´','3í‹°ì–´','4í‹°ì–´','5í‹°ì–´','6í‹°ì–´','7í‹°ì–´','8í‹°ì–´','ìœ ìŠ¤'];
const RACES=['T','Z','P'];
const RNAME={T:'í…Œë€',Z:'ì €ê·¸',P:'í”„ë¡œí† ìŠ¤'};
const RANK_PTS={'ğŸ¥‡ 1ìœ„':3,'ğŸ¥ˆ 2ìœ„':0,'ğŸ¥‰ 3ìœ„':-3,'4ê°•':0,'8ê°•':0,'ì¶œì „':0};

function getTierBadge(tier){
  const map={
    'G':'tbadge tbadge-god',
    'K':'tbadge tbadge-king',
    'JA':'tbadge tbadge-jack',
    'J':'tbadge tbadge-joker',
    'S':'tbadge tbadge-spade',
    '0í‹°ì–´':'tbadge tbadge-0',
  };
  return `<span class="${map[tier]||'tbadge tbadge-default'}">${tier}</span>`;
}

function getTierLabel(tier){
  const icons={G:'ğŸ‘‘',K:'ğŸ”´',JA:'âš”ï¸',J:'ğŸƒ',S:'â™ ï¸'};
  const labels={G:'G (God)',K:'K (King)',JA:'JA (Jack)',J:'J (Joker)',S:'S (Spade)'};
  return icons[tier]?`${icons[tier]} ${labels[tier]||tier}`:tier;
}

function getTierPillLabel(tier){
  const icons={G:'ğŸ‘‘',K:'ğŸ”´',JA:'âš”ï¸',J:'ğŸƒ',S:'â™ ï¸'};
  const labels={G:'G (God)',K:'K (King)',JA:'JA (Jack)',J:'J (Joker)',S:'S (Spade)'};
  return icons[tier]?`${icons[tier]} ${labels[tier]||tier}`:tier;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA LOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function J(k){try{const v=localStorage.getItem(k);return v?JSON.parse(v):null;}catch{return null;}}

let players    = J('su_p')  || [];
let univCfg    = J('su_u')  || [{name:'í‘ì¹´ë°ë¯¸',color:'#1e3a8a'},{name:'JSA',color:'#c2410c'},{name:'ëŠªì§€ëŒ€',color:'#15803d'},{name:'ë¬´ì†Œì†',color:'#6b7280'}];
let maps       = J('su_m')  || ['íˆ¬í˜¼','ì„œí‚·','ë¸”ë¦¬ì¸ ','ì‹  ê°œë§ˆê³ ì›'];
let tourD      = J('su_t')  || Array(15).fill('');
let miniM      = J('su_mm') || [];
let univM      = J('su_um') || [];
let comps      = J('su_cm') || [];
let ckM        = J('su_ck') || [];
let compNames  = J('su_cn') || [];
let curComp    = J('su_cc') || '';
// í”„ë¡œë¦¬ê·¸ ë°ì´í„°
let proM       = J('su_pro') || [];
// íšŒì› ê´€ë¦¬ ë°ì´í„°: [{id,nick,uid,status,banType,banEnd,banDone,category,memo,posts:[{url,savedAt,note}],comments:[{url,savedAt,note}],createdAt,updatedAt}]
let members    = J('su_mb') || [];
// ëŒ€íšŒ ì¡°í¸ì„±: [{id,name,groups:[{name,univs:[],matches:[{a,b,sa,sb,sets:[]}]}]}]
let tourneys   = J('su_tn') || [];
let ttM        = J('su_ttm') || [];

let BLD = {};
let openDetails = {};

function fixPoints(){
  // êµ¬ í‹°ì–´ëª… â†’ ìƒˆ ì•½ì–´ ë§ˆì´ê·¸ë ˆì´ì…˜
  const tierMap={god:'G',king:'K',jack:'JA',joker:'J',spade:'S'};
  players.forEach(p=>{
    if(!p.history)p.history=[];
    if(p.points===undefined)p.points=0;
    if(!p.win)p.win=0; if(!p.loss)p.loss=0;
    if(!p.gender || !['M','F'].includes(p.gender))p.gender='F';
    if(tierMap[p.tier])p.tier=tierMap[p.tier]; // ê¸°ì¡´ ë°ì´í„° ìë™ ë³€í™˜
  });
}

function save(){
  localStorage.setItem('su_tiers',JSON.stringify(TIERS));
  localStorage.setItem('su_p', JSON.stringify(players));
  localStorage.setItem('su_u', JSON.stringify(univCfg));
  localStorage.setItem('su_m', JSON.stringify(maps));
  localStorage.setItem('su_t', JSON.stringify(tourD));
  localStorage.setItem('su_mm',JSON.stringify(miniM));
  localStorage.setItem('su_um',JSON.stringify(univM));
  localStorage.setItem('su_cm',JSON.stringify(comps));
  localStorage.setItem('su_ck',JSON.stringify(ckM));
  localStorage.setItem('su_cn',JSON.stringify(compNames));
  localStorage.setItem('su_cc',JSON.stringify(curComp));
  localStorage.setItem('su_pro',JSON.stringify(proM));
  localStorage.setItem('su_mb',JSON.stringify(members));
  localStorage.setItem('su_tn',JSON.stringify(tourneys));
  localStorage.setItem('su_ttm',JSON.stringify(ttM));
}

let curTab='total', editName='', reMode='', reIdx=-1;
let calYear=new Date().getFullYear(), calMonth=new Date().getMonth(), calView='month';
let voteData=JSON.parse(localStorage.getItem('su_votes')||'{}');
let fUniv='ì „ì²´', fTier='ì „ì²´';
let miniSub='input', univmSub='input', ckSub='input', compSub='league', histSub='mini';
let histUniv='';
let searchTarget='';
let recSortDir='desc'; // ë‚ ì§œ ì •ë ¬: 'desc'=ìµœì‹ ìˆœ, 'asc'=ì˜¤ë˜ëœìˆœ
let vsNameA='', vsNameB=''; // 1:1 ìƒëŒ€ì „ì  ì¡°íšŒ

// ê³µí†µ ì—°ë„/ì›” í•„í„° ìƒíƒœ
let yearOptions=['2026'];
let filterYear='ì „ì²´';
let filterMonth='ì „ì²´'; // 'ì „ì²´' ë˜ëŠ” '01'~'12'

function gc(n){const u=univCfg.find(x=>x.name===n);return u?u.color:'#6b7280';}
function pC(n){return n>0?'pt-p':n<0?'pt-n':'pt-z';}
function pS(n){return (n>0?'+':'')+n;}
function getAllUnivs(){
  const r=[...univCfg];const s=new Set(univCfg.map(u=>u.name));
  players.forEach(p=>{if(!s.has(p.univ)){r.push({name:p.univ,color:'#6b7280'});s.add(p.univ);}});
  return r;
}
function getMembers(univ){return players.filter(p=>p.univ===univ);}

function genderIcon(gender){
  if(gender==='M')return `<span class="male-icon">â™‚</span>`;
  return '';
}

/* ELO ìƒìˆ˜ */
const ELO_DEFAULT=1200;
const ELO_K=32;

function calcElo(winnerElo, loserElo){
  const exp=1/(1+Math.pow(10,(loserElo-winnerElo)/400));
  return Math.round(ELO_K*(1-exp));
}

function applyGameResult(winName, loseName, date, map, matchId){
  const w=players.find(p=>p.name===winName);
  const l=players.find(p=>p.name===loseName);
  if(!w||!l||w===l)return;
  w.win++;l.loss++;w.points+=3;l.points-=3;
  // ELO ê³„ì‚°
  const wElo=w.elo||ELO_DEFAULT;
  const lElo=l.elo||ELO_DEFAULT;
  const delta=calcElo(wElo,lElo);
  w.elo=wElo+delta;
  l.elo=lElo-delta;
  const t=Date.now();
  const d=date||new Date().toISOString().slice(0,10);
  const m=map||'-';
  w.history.unshift({date:d,time:t,result:'ìŠ¹',opp:l.name,oppRace:l.race,map:m,matchId:matchId||'',eloDelta:delta,eloAfter:w.elo});
  l.history.unshift({date:d,time:t,result:'íŒ¨',opp:w.name,oppRace:w.race,map:m,matchId:matchId||'',eloDelta:-delta,eloAfter:l.elo});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëŒ€ì „ ê¸°ë¡ ì‚­ì œ ì‹œ ì„ ìˆ˜ ìŠ¤íƒ¯ ì™„ì „ ë¡¤ë°±
   - matchId ìˆìœ¼ë©´ matchIdë¡œ ì •í™•íˆ ì œê±°
   - matchId ì—†ìœ¼ë©´(êµ¬ ë°ì´í„°) ë‚ ì§œ+ìƒëŒ€ ì¡°í•©ìœ¼ë¡œ ì œê±°
   - ì–´ë–¤ ê²½ìš°ì—ë„ win/loss/points ì°¨ê°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function revertMatchRecord(matchObj){
  if(!matchObj||!matchObj.sets)return;
  const mid=matchObj._id||null;
  const mdate=matchObj.d||'';

  matchObj.sets.forEach(set=>{
    if(!set.games)return;
    set.games.forEach(g=>{
      if(!g.playerA||!g.playerB||!g.winner)return;
      const wName=g.winner==='A'?g.playerA:g.playerB;
      const lName=g.winner==='A'?g.playerB:g.playerA;
      const w=players.find(p=>p.name===wName);
      const l=players.find(p=>p.name===lName);

      if(w){
        w.win=Math.max(0,(w.win||0)-1);
        w.points=(w.points||0)-3;
        // matchId ìš°ì„ , ì—†ìœ¼ë©´ ë‚ ì§œ+ê²°ê³¼+ìƒëŒ€ ë°©ì‹ (ì°¾ëŠ” ì¦‰ì‹œ 1ê±´ë§Œ ì œê±°)
        let idx=-1;
        if(mid) idx=w.history.findIndex(h=>h.matchId===mid&&h.result==='ìŠ¹'&&h.opp===lName);
        if(idx<0) idx=w.history.findIndex(h=>h.result==='ìŠ¹'&&h.opp===lName&&h.date===mdate);
        if(idx<0) idx=w.history.findIndex(h=>h.result==='ìŠ¹'&&h.opp===lName);
        if(idx>=0){const hr=w.history[idx];if(hr.eloDelta!=null){w.elo=(w.elo||ELO_DEFAULT)-hr.eloDelta;}w.history.splice(idx,1);}
      }
      if(l){
        l.loss=Math.max(0,(l.loss||0)-1);
        l.points=(l.points||0)+3;
        let idx=-1;
        if(mid) idx=l.history.findIndex(h=>h.matchId===mid&&h.result==='íŒ¨'&&h.opp===wName);
        if(idx<0) idx=l.history.findIndex(h=>h.result==='íŒ¨'&&h.opp===wName&&h.date===mdate);
        if(idx<0) idx=l.history.findIndex(h=>h.result==='íŒ¨'&&h.opp===wName);
        if(idx>=0){const hr=l.history[idx];if(hr.eloDelta!=null){l.elo=(l.elo||ELO_DEFAULT)-hr.eloDelta;}l.history.splice(idx,1);}
      }
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB & RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sw(t,el){
  // íƒ­ ë³€ê²½ ì‹œ ì„œë¸Œíƒ­ ì´ˆê¸°í™”
  if(t==='comp') { compSub='league'; leagueFilterDate=''; leagueFilterGrp=''; grpRankFilter=''; }
  if(t==='mini') miniSub='records';
  if(t==='univck') ckSub='records';
  if(t==='univm') univmSub='records';
  if(t==='pro') proSub='records';
  if(t==='hist') histSub='mini'; // ëŒ€ì „ ê¸°ë¡ íƒ­ìœ¼ë¡œ ëŒì•„ì˜¬ ë•Œ ì´ˆê¸°í™”
  curTab=t;openDetails={};
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  document.getElementById('fstrip').style.display=(t==='total'&&isLoggedIn)?'block':'none';
  // ì´ì „ ë‚´ìš© ì œê±° í›„ ë Œë”ë§
  const C=document.getElementById('rcont');
  if(C) C.innerHTML='';
  render();
}
function render(){
  const C=document.getElementById('rcont');
  const T=document.getElementById('rtitle');
  if(!C||!T)return;
  document.getElementById('farea').innerHTML='';
  // ì´ì „ ë‚´ìš© ì œê±°
  C.innerHTML='';
  const renderFn=({total:rTotal,tier:rTier,hist:rHist,mini:rMini,univck:rCK,univm:rUnivM,comp:rComp,pro:rPro,member:rMember,cfg:rCfg,stats:rStats,cal:rCal,vote:rVote})[curTab];
  if(renderFn)renderFn(C,T);
  // ë Œë”ë§ í›„ ë¹ˆ rec-summary ì œê±° (ë‚´ìš© ì—†ëŠ” ë¹ˆ ì¤„ ë°©ì§€)
  requestAnimationFrame(()=>{
    C.querySelectorAll('.rec-summary').forEach(el=>{
      const header=el.querySelector('.rec-sum-header');
      if(!header||header.innerText.trim()==='')el.remove();
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„ ìˆ˜ ì´ë¦„ í´ë¦­ â†’ ëª¨ë‹¬
   ëŒ€í•™ í´ë¦­ â†’ ëª¨ë‹¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openPlayerModal(name){
  const p=players.find(x=>x.name===name);
  if(!p)return;
  document.getElementById('playerModalTitle').innerText=`ğŸ‘¤ ${name} ì„ ìˆ˜ ìƒì„¸`;
  document.getElementById('playerModalBody').innerHTML=buildPlayerDetailHTML(p);
  // ì–´ë“œë¯¼ ì „ìš© ìˆ˜ì • ë²„íŠ¼
  const editBtn=document.getElementById('playerModalEditBtn');
  if(editBtn) editBtn.style.display=isLoggedIn?'inline-flex':'none';
  // í˜„ì¬ ëª¨ë‹¬ì— í‘œì‹œ ì¤‘ì¸ ì„ ìˆ˜ëª… ì €ì¥
  window._playerModalCurrentName=name;
  om('playerModal');
}

function openEPFromModal(){
  const name=window._playerModalCurrentName;
  if(!name)return;
  cm('playerModal');
  setTimeout(()=>openEP(name),100);
}

async function capturePlayerModal(){
  const body=document.getElementById('playerModalBody');
  if(!body){alert('ìº¡ì²˜í•  ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
  try{
    const canvas=await html2canvas(body,{backgroundColor:'#ffffff',scale:2,useCORS:true});
    const a=document.createElement('a');
    a.download=`${window._playerModalCurrentName||'player'}_stat.jpg`;
    a.href=canvas.toDataURL('image/jpeg',0.92);
    document.body.appendChild(a);a.click();
    setTimeout(()=>document.body.removeChild(a),100);
  }catch(e){alert('ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜: '+e.message);}
}

async function captureUnivModal(){
  const body=document.getElementById('univModalBody');
  const title=document.getElementById('univModalTitle');
  if(!body){alert('ìº¡ì²˜í•  ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
  try{
    const canvas=await html2canvas(body,{backgroundColor:'#ffffff',scale:2,useCORS:true});
    const a=document.createElement('a');
    a.download=`${title?title.innerText.replace('ğŸ›ï¸ ',''):'univ'}_ëŒ€í•™ì •ë³´.jpg`;
    a.href=canvas.toDataURL('image/jpeg',0.92);
    document.body.appendChild(a);a.click();
    setTimeout(()=>document.body.removeChild(a),100);
  }catch(e){alert('ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜: '+e.message);}
}

async function captureDetail(id, filename){
  const el=document.getElementById(id);
  if(!el){alert('ìº¡ì²˜í•  ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
  try{
    const canvas=await html2canvas(el,{backgroundColor:'#ffffff',scale:2,useCORS:true});
    const a=document.createElement('a');
    a.download=`ê²½ê¸°ìƒì„¸_${filename}.jpg`;
    a.href=canvas.toDataURL('image/jpeg',0.92);
    document.body.appendChild(a);a.click();
    setTimeout(()=>document.body.removeChild(a),100);
  }catch(e){alert('ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜: '+e.message);}
}

function openUnivModal(univName){
  document.getElementById('univModalTitle').innerText=`ğŸ›ï¸ ${univName} ëŒ€í•™ ìƒì„¸`;
  document.getElementById('univModalBody').innerHTML=buildUnivDetailHTML(univName);
  om('univModal');
}

function buildPlayerDetailHTML(p){
  const col=gc(p.univ);
  const opps={},rv={T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}};
  p.history.forEach(h=>{
    if(!opps[h.opp])opps[h.opp]={w:0,l:0,race:h.oppRace};
    if(h.result==='ìŠ¹'){opps[h.opp].w++;if(rv[h.oppRace])rv[h.oppRace].w++;}
    else{opps[h.opp].l++;if(rv[h.oppRace])rv[h.oppRace].l++;}
  });
  const tot=p.win+p.loss;const wr=tot?Math.round(p.win/tot*100):0;
  let h=`<div class="ipanel" style="border-color:${col}66;background:${col}0d;margin-bottom:14px;">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px">
      <span class="ubadge clickable-univ" style="background:${col};font-size:13px;padding:5px 14px" onclick="cm('playerModal');setTimeout(()=>openUnivModal('${p.univ}'),100)">${p.univ}</span>
      <span class="rbadge r${p.race}">${p.race}</span>
      <span style="font-size:20px">${p.name}${genderIcon(p.gender)}</span>
      ${getTierBadge(p.tier)}
    </div>
    <div style="display:flex;gap:24px;flex-wrap:wrap">
      <div><div style="font-size:11px;color:var(--gray-l)">ì´ ì „ì </div>
        <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px"><span class="wt">${p.win}ìŠ¹</span> <span class="lt">${p.loss}íŒ¨</span></div></div>
      <div><div style="font-size:11px;color:var(--gray-l)">ìŠ¹ë¥ </div>
        <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px;color:${wr>=50?'var(--green)':'var(--red)'}">${wr}%</div></div>
      <div><div style="font-size:11px;color:var(--gray-l)">í¬ì¸íŠ¸</div>
        <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px" class="${pC(p.points)}">${pS(p.points)}</div></div>
      <div style="border-left:2px solid var(--border);padding-left:12px"><div style="font-size:11px;color:#7c3aed;font-weight:700">ğŸ… ELO</div>
        <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px;color:${(p.elo||ELO_DEFAULT)>=1300?'#7c3aed':(p.elo||ELO_DEFAULT)>=1200?'var(--green)':'var(--red)'}">${p.elo||ELO_DEFAULT}</div></div>
    </div>
  </div>`;
  // ì¢…ì¡±ë³„ ìŠ¹ë¥ 
  h+=`<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px">`;
  RACES.forEach(r=>{
    const s=rv[r];const t=s.w+s.l;const w=t?Math.round(s.w/t*100):0;
    h+=`<div class="rscard"><div style="margin-bottom:6px"><span class="rbadge r${r}">${r} ${RNAME[r]}</span></div>
      <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px;color:${w>=50?'var(--green)':'var(--red)'}">${t?w+'%':'-'}</div>
      <div style="font-size:11px;margin-top:4px"><span class="wt">${s.w}ìŠ¹</span> <span class="lt">${s.l}íŒ¨</span></div></div>`;
  });
  h+=`</div>`;
  // ìƒëŒ€ ì „ì 
  const oppList=Object.entries(opps).sort((a,b)=>(b[1].w+b[1].l)-(a[1].w+a[1].l));
  if(oppList.length){
    h+=`<div style="font-weight:700;font-size:12px;color:var(--blue);margin-bottom:8px">ğŸ†š ìƒëŒ€ ì „ì </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">`;
    oppList.forEach(([opp,s])=>{
      const ot=s.w+s.l;const ow=ot?Math.round(s.w/ot*100):0;
      h+=`<div class="ocard" style="cursor:pointer" onclick="cm('playerModal');setTimeout(()=>openPlayerModal('${opp}'),100)">
        <div style="font-weight:700;font-size:13px;color:var(--blue);text-decoration:underline dotted">${opp}</div>
        <div style="font-size:11px;margin:3px 0"><span class="rbadge r${s.race}">${s.race}</span></div>
        <div><span class="wt">${s.w}ìŠ¹</span> <span class="lt">${s.l}íŒ¨</span></div>
        <div style="font-weight:700;font-size:12px;color:${ow>=50?'var(--green)':'var(--red)'}">${ow}%</div>
      </div>`;
    });
    h+=`</div>`;
  }
  // ìµœê·¼ ê¸°ë¡ (ê°œì¸ history)
  if(p.history.length){
    h+=`<div style="font-weight:700;font-size:12px;color:var(--blue);margin-bottom:8px">ğŸ“‹ ìµœê·¼ ê²½ê¸° ê¸°ë¡ (ìƒìœ„ 20ê°œ)</div>`;
    h+=`<table><thead><tr><th>ë‚ ì§œ</th><th>ê²°ê³¼</th><th>ìƒëŒ€</th><th>ì¢…ì¡±</th><th>ë§µ</th><th>ELO</th></tr></thead><tbody>`;
    p.history.slice(0,20).forEach(hh=>{
      const isWin=hh.result==='ìŠ¹';
      const eloStr=hh.eloDelta!=null?`<span style="font-weight:700;color:${hh.eloDelta>0?'var(--green)':'var(--red)'}">${hh.eloDelta>0?'+':''}${hh.eloDelta}</span>`:'-';
      h+=`<tr>
        <td style="color:var(--gray-l);font-size:11px">${hh.date}</td>
        <td>${isWin?`<span style="background:var(--blue);color:#fff;font-size:11px;font-weight:800;padding:2px 9px;border-radius:4px">WIN</span>`:`<span style="background:#94a3b8;color:#fff;font-size:11px;font-weight:700;padding:2px 9px;border-radius:4px;opacity:.7">LOSE</span>`}</td>
        <td style="cursor:pointer;color:var(--blue);font-weight:700;text-decoration:underline dotted" onclick="cm('playerModal');setTimeout(()=>openPlayerModal('${hh.opp}'),100)">${hh.opp}</td>
        <td><span class="rbadge r${hh.oppRace}">${hh.oppRace}</span></td>
        <td style="color:var(--gray-l);font-size:11px">${hh.map}</td>
        <td>${eloStr}</td>
      </tr>`;
    });
    h+=`</tbody></table>`;
  }
  // ì„ ìˆ˜ ë©”ëª¨
  h+=`<div style="margin-top:16px;padding:14px;background:#fffbeb;border:1px solid var(--gold-b);border-radius:10px">
    <div style="font-weight:700;font-size:12px;color:var(--gold);margin-bottom:8px">ğŸ“ ì„ ìˆ˜ ë©”ëª¨</div>
    ${p.memo?`<div style="font-size:12px;color:var(--text2);margin-bottom:8px;line-height:1.6">${p.memo.replace(/\n/g,'<br>')}</div>`:'<div style="font-size:12px;color:var(--gray-l);margin-bottom:8px">ë©”ëª¨ ì—†ìŒ</div>'}
    ${isLoggedIn?`<textarea id="player-memo-input" style="width:100%;min-height:70px;font-size:12px;border:1px solid var(--border2);border-radius:6px;padding:8px;resize:vertical" placeholder="ì„ ìˆ˜ì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">${p.memo||''}</textarea>
    <div style="display:flex;gap:6px;margin-top:6px">
      <button class="btn btn-b btn-sm" onclick="savePlayerMemo('${p.name}')">ğŸ’¾ ë©”ëª¨ ì €ì¥</button>
      ${p.memo?`<button class="btn btn-r btn-sm" onclick="savePlayerMemo('${p.name}',true)">ì‚­ì œ</button>`:''}
    </div>`:''}
  </div>`;
  return h;
}

function buildUnivDetailHTML(univName){
  const col=gc(univName);
  const members=getMembers(univName);
  // ëŒ€ì „ ê¸°ë¡ì—ì„œ ìƒëŒ€ ëŒ€í•™ ìŠ¹/íŒ¨ ì§‘ê³„
  const oppStats={}; // {univName: {w,l}}
  function addOpp(myU,oppU,myWin){
    if(myU!==univName)return;
    if(oppU===univName)return;
    if(!oppStats[oppU])oppStats[oppU]={w:0,l:0};
    if(myWin)oppStats[oppU].w++;else oppStats[oppU].l++;
  }
  miniM.forEach(m=>{addOpp(m.a,m.b,m.sa>m.sb);addOpp(m.b,m.a,m.sb>m.sa);});
  univM.forEach(m=>{addOpp(m.a,m.b,m.sa>m.sb);addOpp(m.b,m.a,m.sb>m.sa);});
  comps.forEach(m=>{const a=m.a||m.u||'';addOpp(a,m.b,m.sa>m.sb);addOpp(m.b,a,m.sb>m.sa);});

  const tot=members.reduce((s,p)=>s+p.win+p.loss,0);
  const wins=members.reduce((s,p)=>s+p.win,0);
  const pts=members.reduce((s,p)=>s+p.points,0);
  const wr=tot?Math.round(wins/tot*100):0;

  let h=`<div style="background:${col}0d;border:2px solid ${col}44;border-radius:12px;padding:16px 20px;margin-bottom:16px;">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
      <span class="ubadge" style="background:${col};font-size:14px;padding:5px 16px">${univName}</span>
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px;color:${col}">ëŒ€í•™ í†µí•© ì •ë³´</span>
    </div>
    <div style="display:flex;gap:20px;flex-wrap:wrap">
      <div><div style="font-size:11px;color:var(--gray-l)">ì„ ìˆ˜ ìˆ˜</div><div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px">${members.length}ëª…</div></div>
      <div><div style="font-size:11px;color:var(--gray-l)">ê°œì¸ ì „ì </div><div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px"><span class="wt">${wins}ìŠ¹</span> <span class="lt">${tot-wins}íŒ¨</span></div></div>
      <div><div style="font-size:11px;color:var(--gray-l)">ìŠ¹ë¥ </div><div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px;color:${wr>=50?'var(--green)':'var(--red)'}">${tot?wr+'%':'-'}</div></div>
      <div><div style="font-size:11px;color:var(--gray-l)">ì´ í¬ì¸íŠ¸</div><div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px" class="${pC(pts)}">${pS(pts)}</div></div>
    </div>
  </div>`;

  // ì„ ìˆ˜ ëª©ë¡
  if(members.length){
    const sorted=[...members].sort((a,b)=>TIERS.indexOf(a.tier)-TIERS.indexOf(b.tier)||b.points-a.points);
    h+=`<div style="font-weight:700;font-size:13px;color:var(--blue);margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--blue-ll)">ğŸ‘¥ ì†Œì† ì„ ìˆ˜ (${members.length}ëª…)</div>`;
    h+=`<table><thead><tr><th>í‹°ì–´</th><th>ì¢…ì¡±</th><th>ì´ë¦„</th><th>ì„±ë³„</th><th>ìŠ¹</th><th>íŒ¨</th><th>í¬ì¸íŠ¸</th></tr></thead><tbody>`;
    sorted.forEach(p=>{
      h+=`<tr>
        <td>${getTierBadge(p.tier)}</td>
        <td><span class="rbadge r${p.race}">${p.race}</span></td>
        <td style="cursor:pointer;color:var(--blue);font-weight:700;text-decoration:underline dotted" onclick="cm('univModal');setTimeout(()=>openPlayerModal('${p.name}'),100)">${p.name}</td>
        <td>${p.gender==='M'?'<span class="male-icon">â™‚</span> ë‚¨':'<span class="female-icon">â™€</span> ì—¬'}</td>
        <td class="wt">${p.win}</td>
        <td class="lt">${p.loss}</td>
        <td class="${pC(p.points)}" style="font-family:'Noto Sans KR',sans-serif;font-weight:900">${pS(p.points)}</td>
      </tr>`;
    });
    h+=`</tbody></table>`;
  }

  // ìƒëŒ€ ëŒ€í•™ ì „ì 
  const oppList=Object.entries(oppStats).filter(([,s])=>s.w+s.l>0).sort((a,b)=>(b[1].w+b[1].l)-(a[1].w+a[1].l));
  if(oppList.length){
    h+=`<div style="font-weight:700;font-size:13px;color:#7c3aed;margin:18px 0 10px;padding-bottom:6px;border-bottom:2px solid #ede9fe">ğŸ†š ìƒëŒ€ ëŒ€í•™ ëŒ€ì „ ì „ì  (ëŒ€ì „ ê¸°ë¡ ê¸°ì¤€)</div>`;
    h+=`<table><thead><tr><th>ìƒëŒ€ ëŒ€í•™</th><th>ìŠ¹</th><th>íŒ¨</th><th>ìŠ¹ë¥ </th></tr></thead><tbody>`;
    oppList.forEach(([opp,s])=>{
      const ot=s.w+s.l;const ow=ot?Math.round(s.w/ot*100):0;
      const oc=gc(opp);
      h+=`<tr>
        <td><span class="ubadge clickable-univ" style="background:${oc}" onclick="cm('univModal');setTimeout(()=>openUnivModal('${opp}'),100)">${opp}</span></td>
        <td class="wt" style="font-weight:800;font-size:14px">${s.w}</td>
        <td class="lt" style="font-weight:800;font-size:14px">${s.l}</td>
        <td style="font-weight:700;color:${ow>=50?'var(--green)':'var(--red)'}">${ot?ow+'%':'-'}</td>
      </tr>`;
    });
    h+=`</tbody></table>`;
  }

  // ìµœê·¼ ëŒ€ì „ ê¸°ë¡ (ë¯¸ë‹ˆ+ëŒ€í•™ëŒ€ì „)
  const myMatches=[
    ...miniM.filter(m=>m.a===univName||m.b===univName).map(m=>({...m,mode:'ë¯¸ë‹ˆëŒ€ì „'})),
    ...univM.filter(m=>m.a===univName||m.b===univName).map(m=>({...m,mode:'ëŒ€í•™ëŒ€ì „'})),
  ].sort((a,b)=>(b.d||'').localeCompare(a.d||''));
  if(myMatches.length){
    h+=`<div style="font-weight:700;font-size:13px;color:var(--gold);margin:18px 0 10px;padding-bottom:6px;border-bottom:2px solid var(--gold-b)">ğŸ“‹ ìµœê·¼ ëŒ€ì „ ê¸°ë¡</div>`;
    h+=`<table><thead><tr><th>ë‚ ì§œ</th><th>ì¢…ë¥˜</th><th>ìƒëŒ€</th><th>ê²°ê³¼</th></tr></thead><tbody>`;
    myMatches.slice(0,10).forEach(m=>{
      const isA=m.a===univName;
      const opp=isA?m.b:m.a;
      const myS=isA?m.sa:m.sb;const oppS=isA?m.sb:m.sa;
      const win=myS>oppS;const oc=gc(opp);
      const modeBg=m.mode==='ë¯¸ë‹ˆëŒ€ì „'?'#2563eb':'#7c3aed';
      h+=`<tr>
        <td style="color:var(--gray-l);font-size:11px">${m.d||''}</td>
        <td><span style="background:${modeBg};color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700">${m.mode}</span></td>
        <td><span class="ubadge clickable-univ" style="background:${oc}" onclick="cm('univModal');setTimeout(()=>openUnivModal('${opp}'),100)">${opp}</span></td>
        <td>${win?`<span class="wt" style="font-weight:800">${myS}:${oppS} ìŠ¹</span>`:`<span class="lt" style="font-weight:800">${myS}:${oppS} íŒ¨</span>`}</td>
      </tr>`;
    });
    h+=`</tbody></table>`;
  }
  return h;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„±ì  ê´€ë¦¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rTotal(C,T){
  T.innerText='ğŸ¬ ì „ì²´ ìŠ¤íƒ€í¬ë˜í”„íŠ¸ ìŠ¤íŠ¸ë¦¬ë¨¸ ë¦¬ìŠ¤íŠ¸';
  let h=`<table><thead><tr><th>í‹°ì–´</th><th>ëŒ€í•™</th><th>ì¢…ì¡±</th><th>ìŠ¤íŠ¸ë¦¬ë¨¸</th><th>ì„±ë³„</th><th>ìŠ¹</th><th>íŒ¨</th><th>í¬ì¸íŠ¸</th>${isLoggedIn?'<th class="no-export">ê´€ë¦¬</th>':''}</tr></thead><tbody>`;
  getAllUnivs().forEach(u=>{
    const up=players.filter(p=>p.univ===u.name);if(!up.length)return;
    h+=`<tr class="ugrp" style="--c:${u.color}"><td colspan="${isLoggedIn?9:8}">
      <span class="clickable-univ" onclick="openUnivModal('${u.name}')" style="color:#fff;font-size:14px;">ğŸ›ï¸ ${u.name}</span>
      <span style="font-size:11px;color:rgba(255,255,255,.75);margin-left:6px">(${up.length}ëª…)</span>
    </td></tr>`;
    const sorted=[...up].sort((a,b)=>TIERS.indexOf(a.tier)-TIERS.indexOf(b.tier)||b.points-a.points);
    let lt='';
    sorted.forEach(p=>{
      if(p.tier!==lt){lt=p.tier;h+=`<tr class="tgrp"><td colspan="${isLoggedIn?9:8}">â–· ${getTierLabel(p.tier)}</td></tr>`;}
      h+=`<tr>
        <td>${getTierBadge(p.tier)}</td>
        <td><span class="ubadge clickable-univ" style="background:${u.color}" onclick="openUnivModal('${u.name}')">${p.univ}</span></td>
        <td><span class="rbadge r${p.race}">${p.race}</span></td>
        <td style="text-align:left"><span class="clickable-name" onclick="openPlayerModal('${p.name}')">${p.name}</span>${genderIcon(p.gender)}</td>
        <td>${p.gender==='M'?'<span class="male-icon">â™‚</span>':''}</td>
        <td class="wt">${p.win}</td><td class="lt">${p.loss}</td>
        <td class="${pC(p.points)}" style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px">${pS(p.points)}</td>
        ${isLoggedIn?`<td class="no-export">${adminBtn(`<button class="btn btn-w btn-xs" onclick="openEP('${p.name}')">ìˆ˜ì •</button>`)}</td>`:''}
      </tr>`;
    });
  });
  C.innerHTML=h+`</tbody></table>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í‹°ì–´ ìˆœìœ„í‘œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let tierRankMode='tier'; // tier | winstreak | wins | revstreak | winrate | recent

function rTier(C,T){
  T.innerText='ğŸ“Š í‹°ì–´ ìˆœìœ„í‘œ';
  const allU=getAllUnivs();
  const F=document.getElementById('farea');
  // ëª¨ë“œ ë²„íŠ¼
  const modes=[
    {id:'tier',lbl:'ğŸ“Š í‹°ì–´ìˆœ'},
    {id:'wins',lbl:'ğŸ† ë‹¤ìŠ¹ìˆœ'},
    {id:'winstreak',lbl:'ğŸ”¥ ìŠ¹ì°¨ìˆœ'},
    {id:'winrate',lbl:'ğŸ“ˆ ìŠ¹ë¥ ìˆœ'},
    {id:'revstreak',lbl:'â„ï¸ ì—­ìŠ¹ì°¨ìˆœ'},
    {id:'recent',lbl:'ğŸ• ìµœê·¼ ê²½ê¸°'},
  ];
  let fh=`<div class="fbar"><strong>ë³´ê¸°:</strong>`;
  modes.forEach(m=>{fh+=`<button class="pill ${tierRankMode===m.id?'on':''}" onclick="tierRankMode='${m.id}';render()">${m.lbl}</button>`;});
  fh+=`</div>`;
  if(tierRankMode!=='recent'){
    fh+=`<div class="fbar"><strong>ëŒ€í•™:</strong><button class="pill ${fUniv==='ì „ì²´'?'on':''}" onclick="sf('ì „ì²´','${fTier}')">ì „ì²´</button>`;
    allU.forEach(u=>{fh+=`<button class="pill ${fUniv===u.name?'on':''}" style="${fUniv===u.name?`background:${u.color};border-color:${u.color};color:#fff`:''}" onclick="sf('${u.name}','${fTier}')">${u.name}</button>`;});
    fh+=`</div><div class="fbar"><strong>í‹°ì–´:</strong><button class="pill ${fTier==='ì „ì²´'?'on':''}" onclick="sf('${fUniv}','ì „ì²´')">ì „ì²´</button>`;
    TIERS.forEach(t=>{fh+=`<button class="pill ${fTier===t?'on':''}" onclick="sf('${fUniv}','${t}')">${getTierPillLabel(t)}</button>`;});
    fh+=`</div>`;
  }
  F.innerHTML=fh;

  if(tierRankMode==='recent'){
    // ìµœê·¼ ê²½ê¸° ë‚´ì—­: ëª¨ë“  ëŒ€ì „ì—ì„œ ìµœê·¼ ê²Œì„ ì¶”ì¶œ
    const recentGames=[];
    function extractGames(matchList){
      matchList.forEach(m=>{
        (m.sets||[]).forEach(set=>{
          (set.games||[]).forEach(g=>{
            if(!g.playerA||!g.playerB||!g.winner)return;
            const wn=g.winner==='A'?g.playerA:g.playerB;
            const ln=g.winner==='A'?g.playerB:g.playerA;
            recentGames.push({date:m.d||'',winner:wn,loser:ln,map:g.map||'-'});
          });
        });
      });
    }
    extractGames(miniM);extractGames(univM);extractGames(comps);extractGames(ckM);
    recentGames.sort((a,b)=>b.date.localeCompare(a.date));
    let h=`<table><thead><tr><th>ë‚ ì§œ</th><th>ìŠ¹ì</th><th>íŒ¨ì</th><th>ë§µ</th></tr></thead><tbody>`;
    if(!recentGames.length)h+=`<tr><td colspan="4" style="padding:30px;color:var(--gray-l);text-align:center">ê²½ê¸° ê¸°ë¡ ì—†ìŒ</td></tr>`;
    recentGames.slice(0,50).forEach(g=>{
      const wp=players.find(p=>p.name===g.winner);const lp=players.find(p=>p.name===g.loser);
      const wc=wp?gc(wp.univ):'#888';const lc=lp?gc(lp.univ):'#888';
      h+=`<tr>
        <td style="color:var(--gray-l);font-size:11px">${g.date}</td>
        <td><span class="wt" style="font-weight:800;cursor:pointer" onclick="openPlayerModal('${g.winner}')">${g.winner}</span>${wp?`<span class="ubadge" style="background:${wc};font-size:10px;padding:1px 6px;margin-left:4px">${wp.univ}</span>`:''}</td>
        <td><span style="opacity:.6;cursor:pointer" onclick="openPlayerModal('${g.loser}')">${g.loser}</span>${lp?`<span class="ubadge" style="background:${lc};font-size:10px;padding:1px 6px;margin-left:4px;opacity:.6">${lp.univ}</span>`:''}</td>
        <td style="color:var(--gray-l);font-size:11px">${g.map}</td>
      </tr>`;
    });
    C.innerHTML=h+`</tbody></table>`;
    return;
  }

  let list=[...players];
  if(fUniv!=='ì „ì²´')list=list.filter(p=>p.univ===fUniv);
  if(fTier!=='ì „ì²´')list=list.filter(p=>p.tier===fTier);

  if(tierRankMode==='tier') list.sort((a,b)=>TIERS.indexOf(a.tier)-TIERS.indexOf(b.tier)||b.points-a.points);
  else if(tierRankMode==='wins') list.sort((a,b)=>b.win-a.win||a.loss-b.loss);
  else if(tierRankMode==='winrate'){
    list=list.filter(p=>(p.win+p.loss)>=1);
    list.sort((a,b)=>{const ra=(a.win+a.loss)?a.win/(a.win+a.loss):0;const rb=(b.win+b.loss)?b.win/(b.win+b.loss):0;return rb-ra||b.win-a.win;});
  }
  else if(tierRankMode==='winstreak'){
    // ìŠ¹ì°¨: ìŠ¹ìˆ˜ - íŒ¨ìˆ˜ (ë§ì„ìˆ˜ë¡ ìƒìœ„)
    list.sort((a,b)=>(b.win-b.loss)-(a.win-a.loss)||b.win-a.win);
  }
  else if(tierRankMode==='revstreak'){
    // ì—­ìŠ¹ì°¨: íŒ¨ìˆ˜ - ìŠ¹ìˆ˜ (ë§ì„ìˆ˜ë¡ ìƒìœ„, ì¦‰ ìŠ¹ì°¨ ë‚®ì€ ìˆœ)
    list.sort((a,b)=>(b.loss-b.win)-(a.loss-a.win)||b.loss-a.loss);
  }
  else if(tierRankMode==='elo'){
    list.sort((a,b)=>(b.elo||ELO_DEFAULT)-(a.elo||ELO_DEFAULT));
  }

  const modeHeaders={
    tier:'í¬ì¸íŠ¸',wins:'ìŠ¹',winrate:'ìŠ¹ë¥ ',winstreak:'ìŠ¹ì°¨',revstreak:'ì—­ìŠ¹ì°¨'
  };
  if(tierRankMode==='elo') tierRankMode='tier'; // ELO ì œê±° í›„ fallback
  const extraHeader=modeHeaders[tierRankMode]||'í¬ì¸íŠ¸';

  let h=`<table><thead><tr><th>ìˆœìœ„</th><th>í‹°ì–´</th><th>ëŒ€í•™</th><th>ì¢…ì¡±</th><th>ì´ë¦„</th><th>ìŠ¹</th><th>íŒ¨</th><th>ìŠ¹ë¥ </th><th>${extraHeader}</th></tr></thead><tbody>`;
  list.forEach((p,i)=>{
    const col=gc(p.univ);const tot=p.win+p.loss;const wr=tot?Math.round(p.win/tot*100):0;
    let rnkHTML;
    if(i===0) rnkHTML=`<span class="rk1">1ë“±</span>`;
    else if(i===1) rnkHTML=`<span class="rk2">2ë“±</span>`;
    else if(i===2) rnkHTML=`<span class="rk3">3ë“±</span>`;
    else rnkHTML=`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px">${i+1}ìœ„</span>`;
    let extraVal='';
    if(tierRankMode==='tier') extraVal=`<span class="${pC(p.points)}" style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px">${pS(p.points)}</span>`;
    else if(tierRankMode==='wins') extraVal=`<span class="wt" style="font-size:15px;font-weight:800">${p.win}</span>`;
    else if(tierRankMode==='winrate') extraVal=`<span style="font-weight:700;color:${wr>=50?'var(--green)':'var(--red)'}">${tot?wr+'%':'-'}</span>`;
    else if(tierRankMode==='winstreak'){const diff=p.win-p.loss;extraVal=`<span style="font-weight:800;color:${diff>0?'var(--green)':diff<0?'var(--red)':'var(--gray-l)'}">${diff>0?'+':''}${diff}</span>`;}
    else if(tierRankMode==='revstreak'){const diff=p.loss-p.win;extraVal=`<span style="font-weight:800;color:${diff>0?'var(--red)':diff<0?'var(--green)':'var(--gray-l)'}">${diff>0?'+':''}${diff}</span>`;}
    else if(tierRankMode==='elo'){const e=p.elo||ELO_DEFAULT;extraVal=`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;font-weight:800;color:${e>=1400?'#7c3aed':e>=1300?'var(--gold)':e>=1200?'var(--green)':'var(--red)'}">${e}</span>`;}
    h+=`<tr>
      <td>${rnkHTML}</td>
      <td>${getTierBadge(p.tier)}</td>
      <td><span class="ubadge clickable-univ" style="background:${col}" onclick="openUnivModal('${p.univ}')">${p.univ}</span></td>
      <td><span class="rbadge r${p.race}">${p.race}</span></td>
      <td style="font-weight:700"><span class="clickable-name" onclick="openPlayerModal('${p.name}')">${p.name}</span>${genderIcon(p.gender)}</td>
      <td class="wt">${p.win}</td><td class="lt">${p.loss}</td>
      <td style="font-weight:700;color:${wr>=50?'var(--green)':'var(--red)'}">${tot?wr+'%':'-'}</td>
      <td>${extraVal}</td>
    </tr>`;
  });
  C.innerHTML=h+`</tbody></table>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëŒ€ì „ ê¸°ë¡ íƒ­
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   1:1 ìƒëŒ€ì „ì  ë¹ ë¥¸ ì¡°íšŒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function vsSearchHTML(){
  const sortedPlayers=[...players].sort((a,b)=>a.name.localeCompare(b.name,'ko'));
  const opts=sortedPlayers.map(p=>`<option value="${p.name}">${p.name} (${p.univ})</option>`).join('');

  let resultHTML='';
  if(vsNameA && vsNameB && vsNameA!==vsNameB){
    const pA=players.find(p=>p.name===vsNameA);
    const pB=players.find(p=>p.name===vsNameB);
    const colA=pA?gc(pA.univ):'#2563eb';
    const colB=pB?gc(pB.univ):'#dc2626';

    // ëª¨ë“  ê²½ê¸°ì—ì„œ ë‘ ì„ ìˆ˜ ê°„ ì§ì ‘ ëŒ€ê²° ì°¾ê¸°
    let aWins=0, bWins=0;
    const gameLogs=[];

    function scanVs(arr, modeLabel){
      arr.forEach(m=>{
        (m.sets||[]).forEach((set,si)=>{
          (set.games||[]).forEach(g=>{
            const aIsA=(g.playerA===vsNameA&&g.playerB===vsNameB);
            const aIsB=(g.playerA===vsNameB&&g.playerB===vsNameA);
            if(!aIsA&&!aIsB)return;
            const aWon=(aIsA&&g.winner==='A')||(aIsB&&g.winner==='B');
            const bWon=(aIsA&&g.winner==='B')||(aIsB&&g.winner==='A');
            if(aWon)aWins++;
            else if(bWon)bWins++;
            gameLogs.push({date:m.d||'',mode:modeLabel,map:g.map||'-',aWon,bWon,si,m});
          });
        });
      });
    }
    scanVs(miniM,'âš¡ ë¯¸ë‹ˆëŒ€ì „');
    scanVs(univM,'ğŸŸï¸ ëŒ€í•™ëŒ€ì „');
    scanVs(comps,'ğŸ–ï¸ ëŒ€íšŒ');
    scanVs(ckM,'ğŸ¤ ëŒ€í•™CK');
    scanVs(proM,'ğŸ… í”„ë¡œë¦¬ê·¸');
    gameLogs.sort((a,b)=>b.date.localeCompare(a.date));

    const total=aWins+bWins;
    const aRate=total?Math.round(aWins/total*100):0;
    const bRate=total?Math.round(bWins/total*100):0;

    resultHTML=`
    <div class="vs-box">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px">
        <div style="display:flex;align-items:center;gap:10px">
          <span class="ubadge" style="background:${colA};font-size:13px;padding:4px 14px">${vsNameA}</span>
          ${pA?getTierBadge(pA.tier):''}
        </div>
        <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px;color:var(--gray-l)">VS</span>
        <div style="display:flex;align-items:center;gap:10px">
          ${pB?getTierBadge(pB.tier):''}
          <span class="ubadge" style="background:${colB};font-size:13px;padding:4px 14px">${vsNameB}</span>
        </div>
      </div>
      ${total===0?`<div style="padding:20px;text-align:center;color:var(--gray-l);font-size:13px">ë‘ ì„ ìˆ˜ ê°„ ì§ì ‘ ëŒ€ê²° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`:
      `<div style="text-align:center;margin-bottom:10px">
        <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:28px;color:${colA}">${aWins}</span>
        <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px;color:var(--gray-l);margin:0 8px">:</span>
        <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:28px;color:${colB}">${bWins}</span>
        <div style="font-size:11px;color:var(--text3);margin-top:4px">ì´ ${total}ê²Œì„</div>
      </div>
      <div class="vs-bar-wrap">
        <div class="vs-bar-a" style="width:${aRate}%"></div>
        <div class="vs-bar-b" style="width:${bRate}%"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-bottom:12px">
        <span style="color:${colA};font-weight:600">${vsNameA} ${aRate}%</span>
        <span style="color:${colB};font-weight:600">${bRate}% ${vsNameB}</span>
      </div>
      <div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:8px">ğŸ“‹ ëŒ€ì „ ë‚´ì—­</div>
      <table><thead><tr><th>ë‚ ì§œ</th><th>ëŒ€ì „</th><th>ë§µ</th><th>ê²°ê³¼</th></tr></thead><tbody>
      ${gameLogs.map(lg=>`<tr>
        <td style="color:var(--gray-l);font-size:11px">${lg.date}</td>
        <td style="font-size:11px">${lg.mode}</td>
        <td style="color:var(--gray-l);font-size:11px">${lg.map}</td>
        <td>${lg.aWon?`<span style="color:${colA};font-weight:600">${vsNameA} ìŠ¹</span>`:lg.bWon?`<span style="color:${colB};font-weight:600">${vsNameB} ìŠ¹</span>`:'<span style="color:var(--gray-l)">ë¯¸ì •</span>'}</td>
      </tr>`).join('')}
      </tbody></table>`}
    </div>`;
  }

  return `
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px">
    <div style="font-size:13px;font-weight:600;color:var(--text2);margin-bottom:12px">âš”ï¸ ë‘ ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ë©´ ì§ì ‘ ëŒ€ê²° ì „ì ì„ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <select style="flex:1;min-width:150px;max-width:240px" onchange="vsNameA=this.value;renderVs()">
        <option value="">ì„ ìˆ˜ A ì„ íƒ...</option>${opts}
      </select>
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;color:var(--gray-l)">VS</span>
      <select style="flex:1;min-width:150px;max-width:240px" onchange="vsNameB=this.value;renderVs()">
        <option value="">ì„ ìˆ˜ B ì„ íƒ...</option>${opts}
      </select>
    </div>
  </div>
  <div id="vsResult">${resultHTML}</div>`;
}

function renderVs(){
  const r=document.getElementById('vsResult');
  if(!r)return;
  // ì„ íƒê°’ ë‹¤ì‹œ ì½ê¸°
  const sels=document.querySelectorAll('[onchange*="vsName"]');
  if(sels[0])vsNameA=sels[0].value;
  if(sels[1])vsNameB=sels[1].value;
  if(!vsNameA||!vsNameB||vsNameA===vsNameB){r.innerHTML='';return;}

  const pA=players.find(p=>p.name===vsNameA);
  const pB=players.find(p=>p.name===vsNameB);
  const colA=pA?gc(pA.univ):'#2563eb';
  const colB=pB?gc(pB.univ):'#dc2626';
  let aWins=0,bWins=0;
  const gameLogs=[];
  function scanVs(arr,modeLabel){
    arr.forEach(m=>{
      (m.sets||[]).forEach((set,si)=>{
        (set.games||[]).forEach(g=>{
          const aIsA=(g.playerA===vsNameA&&g.playerB===vsNameB);
          const aIsB=(g.playerA===vsNameB&&g.playerB===vsNameA);
          if(!aIsA&&!aIsB)return;
          const aWon=(aIsA&&g.winner==='A')||(aIsB&&g.winner==='B');
          const bWon=(aIsA&&g.winner==='B')||(aIsB&&g.winner==='A');
          if(aWon)aWins++;else if(bWon)bWins++;
          gameLogs.push({date:m.d||'',mode:modeLabel,map:g.map||'-',aWon,bWon});
        });
      });
    });
  }
  scanVs(miniM,'âš¡ ë¯¸ë‹ˆëŒ€ì „');scanVs(univM,'ğŸŸï¸ ëŒ€í•™ëŒ€ì „');scanVs(comps,'ğŸ–ï¸ ëŒ€íšŒ');scanVs(ckM,'ğŸ¤ ëŒ€í•™CK');scanVs(proM,'ğŸ… í”„ë¡œë¦¬ê·¸');
  gameLogs.sort((a,b)=>b.date.localeCompare(a.date));
  const total=aWins+bWins;
  const aRate=total?Math.round(aWins/total*100):0;
  const bRate=total?100-aRate:0;

  r.innerHTML=`<div class="vs-box">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px">
      <div style="display:flex;align-items:center;gap:8px">
        <span class="ubadge" style="background:${colA};font-size:13px;padding:4px 14px">${vsNameA}</span>
        ${pA?getTierBadge(pA.tier):''}
      </div>
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px;color:var(--gray-l)">VS</span>
      <div style="display:flex;align-items:center;gap:8px">
        ${pB?getTierBadge(pB.tier):''}
        <span class="ubadge" style="background:${colB};font-size:13px;padding:4px 14px">${vsNameB}</span>
      </div>
    </div>
    ${total===0?`<div style="padding:20px;text-align:center;color:var(--gray-l)">ì§ì ‘ ëŒ€ê²° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`:`
    <div style="text-align:center;margin-bottom:10px">
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:32px;color:${colA}">${aWins}</span>
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px;color:var(--gray-l);margin:0 10px">:</span>
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:32px;color:${colB}">${bWins}</span>
      <div style="font-size:11px;color:var(--text3);margin-top:4px">ì´ ${total}ê²Œì„ Â· ${aWins>bWins?vsNameA:bWins>aWins?vsNameB:'ë™ë¥ '} ìš°ì„¸</div>
    </div>
    <div class="vs-bar-wrap">
      <div class="vs-bar-a" style="width:${aRate}%"></div>
      <div class="vs-bar-b" style="width:${bRate}%"></div>
    </div>
    <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:14px">
      <span style="color:${colA};font-weight:600">${vsNameA} ${aRate}%</span>
      <span style="color:${colB};font-weight:600">${bRate}% ${vsNameB}</span>
    </div>
    <div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:8px">ğŸ“‹ ê²Œì„ ë‚´ì—­</div>
    <table><thead><tr><th>ë‚ ì§œ</th><th>ëŒ€ì „ ì¢…ë¥˜</th><th>ë§µ</th><th>ê²°ê³¼</th></tr></thead><tbody>
    ${gameLogs.map(lg=>`<tr>
      <td style="color:var(--gray-l);font-size:11px">${lg.date}</td>
      <td style="font-size:11px">${lg.mode}</td>
      <td style="color:var(--gray-l);font-size:11px">${lg.map}</td>
      <td>${lg.aWon?`<span class="wt">${vsNameA} ìŠ¹</span>`:lg.bWon?`<span class="lt">${vsNameB} ìŠ¹</span>`:'<span style="color:var(--gray-l)">ë¯¸ì •</span>'}</td>
    </tr>`).join('')}
    </tbody></table>`}
  </div>`;
}

function rHist(C,T){
  T.innerText='ğŸ“… ëŒ€ì „ ê¸°ë¡';
  const tabs=[
    {id:'race',lbl:'ğŸ§¬ ì¢…ì¡±ìŠ¹ë¥ '},
    {id:'mini',lbl:'âš¡ ë¯¸ë‹ˆëŒ€ì „'},
    {id:'ck',lbl:'ğŸ¤ ëŒ€í•™CK'},
    {id:'univm',lbl:'ğŸŸï¸ ëŒ€í•™ëŒ€ì „'},
    {id:'comp',lbl:'ğŸ–ï¸ ëŒ€íšŒ'},
    {id:'univstat',lbl:'ğŸ›ï¸ ëŒ€í•™ë³„'},
    {id:'univrank',lbl:'ğŸ›ï¸ ëŒ€í•™ë³„ í¬ì¸íŠ¸ ìˆœìœ„'},
    {id:'pro',lbl:'ğŸ… í”„ë¡œë¦¬ê·¸'},
    {id:'player',lbl:'ğŸ‘¤ ì„ ìˆ˜ë³„'},
    {id:'vs',lbl:'âš”ï¸ 1:1 ìƒëŒ€ì „ì '}
  ];
  let h=`<div class="stabs no-export">`;
  tabs.forEach(t=>{h+=`<button class="stab ${histSub===t.id?'on':''}" onclick="histSub='${t.id}';openDetails={};render()">${t.lbl}</button>`;});
  h+=`</div>`;
  const needDateFilter=['mini','ck','univm','comp','pro','player'].includes(histSub);
  if(needDateFilter && typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('hist');
  }
  if(histSub==='vs'){
    h+=vsSearchHTML();
    C.innerHTML=h;
    return;
  }
  if(histSub==='player'){
    h+=`<input type="text" id="hs" placeholder="ğŸ” ìŠ¤íŠ¸ë¦¬ë¨¸ ê²€ìƒ‰..." onkeyup="doSearch(this.value)"
      style="width:100%;max-width:320px;padding:10px 16px;border:2px solid var(--blue);border-radius:8px;font-size:13px;margin-bottom:16px;">
      <div id="hres"></div>`;
    C.innerHTML=h;
    if(searchTarget){
      document.getElementById('hs').value=searchTarget;
      doSearch(searchTarget);
    }
    return;
  }
  if(histSub==='race'){
    if(typeof raceSummaryHTML==='function'){
      h+=raceSummaryHTML();
      C.innerHTML=h;
      return;
    }
    rRace(C,T);
    return;
  }
  if(histSub==='univstat'){h+=rHistUnivStat();C.innerHTML=h;return;}
  if(histSub==='univrank'){
    if(typeof rUnivBodyHTML==='function'){
      h+=rUnivBodyHTML();
      C.innerHTML=h;
      return;
    }
    rUniv(C,T);
    return;
  }
  if(histSub==='mini') h+=recSummaryListHTML(miniM,'mini','hist');
  else if(histSub==='ck') h+=recSummaryListHTML(ckM,'ck','hist');
  else if(histSub==='univm') h+=recSummaryListHTML(univM,'univm','hist');
  else if(histSub==='comp') h+=compSummaryListHTML('hist');
  else if(histSub==='pro') h+=recSummaryListHTML(proM,'pro','hist');
  C.innerHTML=h;
}

/* ëŒ€í•™ë³„ í†µí•© ì„±ì  */
function rHistUnivStat(){
  const allU=getAllUnivs();
  if(!histUniv&&allU.length) histUniv=allU[0].name;
  let h='';
  if(typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('hist-univ');
  }
  h+=`<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px;" class="no-export">`;
  allU.forEach(u=>{
    const sel=histUniv===u.name;
    h+=`<button class="pill ${sel?'on':''}" style="${sel?`background:${u.color};border-color:${u.color};color:#fff`:''}" onclick="histUniv='${u.name}';openDetails={};render()">${u.name}</button>`;
  });
  h+=`</div>`;
  if(!histUniv) return h+`<div style="padding:40px;text-align:center;color:var(--gray-l)">ëŒ€í•™ì„ ì„ íƒí•˜ì„¸ìš”.</div>`;
  const col=gc(histUniv);
  const myMini=miniM.filter(m=>(m.a===histUniv||m.b===histUniv)&&(!passDateFilter||passDateFilter(m.d||'')));
  const myUnivM=univM.filter(m=>(m.a===histUniv||m.b===histUniv)&&(!passDateFilter||passDateFilter(m.d||'')));
  const myCK=ckM.filter(m=>((m.teamAMembers||[]).some(x=>x.univ===histUniv)||(m.teamBMembers||[]).some(x=>x.univ===histUniv))&&(!passDateFilter||passDateFilter(m.d||'')));
  const myComp=comps.filter(m=>(((m.a||m.u)===histUniv)||m.b===histUniv)&&(!passDateFilter||passDateFilter(m.d||'')));
  function calcStats(arr,getA,getB){let w=0,l=0,d=0;arr.forEach(m=>{const a=getA(m),b=getB(m);const iA=(a===histUniv),iB=(b===histUniv);if(iA){if(m.sa>m.sb)w++;else if(m.sb>m.sa)l++;else d++;}else if(iB){if(m.sb>m.sa)w++;else if(m.sa>m.sb)l++;else d++;}});return{w,l,d,total:w+l+d};}
  const sm=calcStats(myMini,m=>m.a,m=>m.b);
  const su=calcStats(myUnivM,m=>m.a,m=>m.b);
  const sc=calcStats(myComp,m=>m.a||m.u,m=>m.b);
  let ckW=0,ckL=0;
  myCK.forEach(m=>{if(m.univWins&&m.univWins[histUniv])ckW+=m.univWins[histUniv];if(m.univLosses&&m.univLosses[histUniv])ckL+=m.univLosses[histUniv];});

  // ìƒëŒ€ ëŒ€í•™ ìŠ¹/íŒ¨ ì§‘ê³„
  const oppStats={};
  function addOpp(myU,oppU,myWin){
    if(myU!==histUniv||oppU===histUniv)return;
    if(!oppStats[oppU])oppStats[oppU]={w:0,l:0};
    if(myWin)oppStats[oppU].w++;else oppStats[oppU].l++;
  }
  myMini.forEach(m=>{addOpp(m.a,m.b,m.sa>m.sb);addOpp(m.b,m.a,m.sb>m.sa);});
  myUnivM.forEach(m=>{addOpp(m.a,m.b,m.sa>m.sb);addOpp(m.b,m.a,m.sb>m.sa);});
  myComp.forEach(m=>{const a=m.a||m.u||'';addOpp(a,m.b,m.sa>m.sb);addOpp(m.b,a,m.sb>m.sa);});

  h+=`<div style="background:${col}0d;border:2px solid ${col}44;border-radius:12px;padding:16px 20px;margin-bottom:20px;">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
      <span class="ubadge clickable-univ" style="background:${col};font-size:14px;padding:5px 16px" onclick="openUnivModal('${histUniv}')">${histUniv}</span>
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px;color:${col}">ëŒ€ì „ í†µí•© ì„±ì </span>
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      ${statCard('âš¡ ë¯¸ë‹ˆëŒ€ì „',sm.w,sm.l,sm.d,col)}
      ${statCard('ğŸŸï¸ ëŒ€í•™ëŒ€ì „',su.w,su.l,su.d,col)}
      ${statCard('ğŸ–ï¸ ëŒ€íšŒ',sc.w,sc.l,sc.d,col)}
      ${statCard('ğŸ¤ ëŒ€í•™CK (ê²Œì„)',ckW,ckL,0,col)}
    </div>
  </div>`;

  // ìƒëŒ€ ëŒ€í•™ë³„ ì „ì í‘œ
  const oppList=Object.entries(oppStats).filter(([,s])=>s.w+s.l>0).sort((a,b)=>(b[1].w+b[1].l)-(a[1].w+a[1].l));
  if(oppList.length){
    h+=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:#7c3aed;margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid #ede9fe">ğŸ†š ìƒëŒ€ ëŒ€í•™ ëŒ€ì „ ì „ì </div>`;
    h+=`<table style="margin-bottom:20px"><thead><tr><th>ìƒëŒ€ ëŒ€í•™</th><th>ìŠ¹</th><th>íŒ¨</th><th>ìŠ¹ë¥ </th></tr></thead><tbody>`;
    oppList.forEach(([opp,s])=>{
      const ot=s.w+s.l;const ow=ot?Math.round(s.w/ot*100):0;const oc=gc(opp);
      h+=`<tr><td><span class="ubadge clickable-univ" style="background:${oc}" onclick="openUnivModal('${opp}')">${opp}</span></td>
        <td class="wt" style="font-weight:800;font-size:14px">${s.w}</td>
        <td class="lt" style="font-weight:800;font-size:14px">${s.l}</td>
        <td style="font-weight:700;color:${ow>=50?'var(--green)':'var(--red)'}">${ot?ow+'%':'-'}</td></tr>`;
    });
    h+=`</tbody></table>`;
  }

  if(myMini.length){h+=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:var(--blue);margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--blue-ll)">âš¡ ë¯¸ë‹ˆëŒ€ì „ ê¸°ë¡</div>`;h+=recSummaryListHTMLFiltered(myMini,'mini','ustat-mini',histUniv);}
  if(myUnivM.length){h+=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:#7c3aed;margin:16px 0 10px;padding-bottom:6px;border-bottom:2px solid #ede9fe">ğŸŸï¸ ëŒ€í•™ëŒ€ì „ ê¸°ë¡</div>`;h+=recSummaryListHTMLFiltered(myUnivM,'univm','ustat-univm',histUniv);}
  if(myCK.length){h+=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:#dc2626;margin:16px 0 10px;padding-bottom:6px;border-bottom:2px solid #fee2e2">ğŸ¤ ëŒ€í•™CK ê¸°ë¡</div>`;h+=recSummaryListHTMLFiltered(myCK,'ck','ustat-ck',histUniv);}
  if(myComp.length){
    h+=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:var(--gold);margin:16px 0 10px;padding-bottom:6px;border-bottom:2px solid var(--gold-b)">ğŸ–ï¸ ëŒ€íšŒ ê¸°ë¡</div>`;
    myComp.forEach(m=>{
      const rIdx=comps.indexOf(m);const a=m.a||m.hostUniv||m.u||'';const b=m.b||'';
      const ca=gc(a);const cb=gc(b);const aWin=m.sa>m.sb;const bWin=m.sb>m.sa;
      const isA=(a===histUniv),isB=(b===histUniv);const myWin=(isA&&aWin)||(isB&&bWin);
      const key=`ustat-comp-${rIdx}`;
      h+=`<div class="rec-summary">
        <div class="rec-sum-header">
          <span style="color:var(--gray-l);font-size:11px;min-width:72px">${m.d}</span>
          <span style="font-weight:700;font-size:13px">ğŸ–ï¸ ${m.n}</span>
          <div class="rec-sum-vs">
            ${a?`<span class="ubadge${aWin?'':' loser'} clickable-univ" style="background:${ca}" onclick="openUnivModal('${a}')">${a}</span>`:''}
            ${(a&&b)?`<div class="rec-sum-score"><span class="${aWin?'wt':bWin?'lt':'pt-z'}">${m.sa||0}</span><span style="color:var(--gray-l);font-size:14px">:</span><span class="${bWin?'wt':aWin?'lt':'pt-z'}">${m.sb||0}</span></div>`:''}
            ${b?`<span class="ubadge${bWin?'':' loser'} clickable-univ" style="background:${cb}" onclick="openUnivModal('${b}')">${b}</span>`:''}
            <span style="font-size:12px;font-weight:700;color:${myWin?col:'#888'}">${myWin?'â–¶ '+histUniv+' ìŠ¹':aWin?'â–¶ '+a+' ìŠ¹':bWin?'â–¶ '+b+' ìŠ¹':'ë¬´ìŠ¹ë¶€'}</span>
          </div>
          <div style="margin-left:auto" class="no-export"><button id="detbtn-${key}" class="btn-detail" onclick="toggleDetail('${key}')">â–¼ ìƒì„¸ ë³´ê¸°</button></div>
        </div>
        <div id="det-${key}" class="rec-detail-area">${buildDetailHTML(m,'comp',a,b,ca,cb,aWin,bWin)}</div>
      </div>`;
    });
  }
  if(!myMini.length&&!myUnivM.length&&!myCK.length&&!myComp.length)h+=`<div style="padding:40px;text-align:center;color:var(--gray-l)">ì´ ëŒ€í•™ì˜ ëŒ€ì „ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  return h;
}

function statCard(label,w,l,d,col){
  const tot=w+l+d;const wr=tot?Math.round(w/tot*100):0;
  return `<div style="background:var(--white);border:1px solid ${col}33;border-radius:10px;padding:12px 16px;min-width:120px;text-align:center;flex:1">
    <div style="font-size:11px;font-weight:700;color:var(--text3);margin-bottom:8px">${label}</div>
    <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px"><span class="wt">${w}ìŠ¹</span> <span class="lt">${l}íŒ¨</span>${d?` <span style="color:var(--gray-l)">${d}ë¬´</span>`:''}</div>
    <div style="font-size:12px;font-weight:700;color:${wr>=50?'var(--green)':'var(--red)'};margin-top:4px">${tot?wr+'%':'-'}</div>
  </div>`;
}

function recSummaryListHTMLFiltered(arr,mode,ctxPrefix,filterUniv){
  if(!arr.length)return`<div style="padding:20px;text-align:center;color:var(--gray-l);">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  let h='';
  arr.forEach(m=>{
    if(!m.a||!m.b) return;
    if(m.sa==null||m.sa===''||m.sb==null||m.sb==='') return;
    if(isNaN(Number(m.sa))||isNaN(Number(m.sb))) return;
    if(typeof passDateFilter==='function' && !passDateFilter(m.d||''))return;
    const srcArr=mode==='mini'?miniM:mode==='univm'?univM:ckM;
    const i=srcArr.indexOf(m);
    const isCK=(mode==='ck');
    const ca=isCK?'#2563eb':gc(m.a);const cb=isCK?'#dc2626':gc(m.b);
    const labelA=isCK?'AíŒ€':m.a;const labelB=isCK?'BíŒ€':m.b;
    const aWin=(m.sa>m.sb),bWin=(m.sb>m.sa);
    const col=gc(filterUniv);
    const isA=(!isCK&&m.a===filterUniv)||(isCK&&(m.teamAMembers||[]).some(x=>x.univ===filterUniv));
    const isB=(!isCK&&m.b===filterUniv)||(isCK&&(m.teamBMembers||[]).some(x=>x.univ===filterUniv));
    const myWin=(isA&&aWin)||(isB&&bWin);
    const key=`${ctxPrefix}-${mode}-${i}`;
    h+=`<div class="rec-summary">
      <div class="rec-sum-header">
        <span style="color:var(--gray-l);font-size:11px;min-width:72px">${m.d||''}</span>
        ${m.t?`<span style="font-weight:700;font-size:12px;color:var(--text3)">${m.t}</span>`:''}
        ${(m.n&&mode!=='comp')?`<span style="font-weight:700;font-size:12px;color:var(--text3)">${m.n}</span>`:''}
        <div class="rec-sum-vs">
          <span class="ubadge${aWin?'':' loser'} clickable-univ" style="background:${ca}" onclick="openUnivModal('${isCK?'':m.a}')">${labelA}</span>
          <div class="rec-sum-score"><span class="${aWin?'wt':bWin?'lt':'pt-z'}">${m.sa}</span><span style="color:var(--gray-l);font-size:14px">:</span><span class="${bWin?'wt':aWin?'lt':'pt-z'}">${m.sb}</span></div>
          <span class="ubadge${bWin?'':' loser'} clickable-univ" style="background:${cb}" onclick="openUnivModal('${isCK?'':m.b}')">${labelB}</span>
          <span style="font-size:12px;font-weight:700;color:${myWin?col:'#888'}">${myWin?'â–¶ '+filterUniv+' ìŠ¹':aWin?'â–¶ '+labelA+' ìŠ¹':bWin?'â–¶ '+labelB+' ìŠ¹':'ë¬´ìŠ¹ë¶€'}</span>
        </div>
        <div style="margin-left:auto" class="no-export"><button id="detbtn-${key}" class="btn-detail" onclick="toggleDetail('${key}')">â–¼ ìƒì„¸ ë³´ê¸°</button></div>
      </div>
      <div id="det-${key}" class="rec-detail-area">${buildDetailHTML(m,mode,labelA,labelB,ca,cb,aWin,bWin)}</div>
    </div>`;
  });
  return h;
}

function recSummaryListHTML(arr, mode, context){
  if(!arr.length)return `<div style="padding:40px;text-align:center;color:var(--gray-l);">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  // ë‚ ì§œ í•„í„° + ì ìˆ˜/íŒ€ ë¯¸ì…ë ¥(ë¹ˆ í•­ëª©) ì œì™¸ í›„ ì •ë ¬
  let filtered=arr.map((m,i)=>({m,i})).filter(({m})=>{
    if(!m.a||!m.b) return false;
    if(m.sa==null||m.sa===''||m.sb==null||m.sb==='') return false;
    if(isNaN(Number(m.sa))||isNaN(Number(m.sb))) return false;
    return typeof passDateFilter!=='function'||passDateFilter(m.d||'');
  });
  filtered.sort((a,b)=>recSortDir==='asc'?(a.m.d||'').localeCompare(b.m.d||''):(b.m.d||'').localeCompare(a.m.d||''));
  if(!filtered.length)return `<div style="padding:40px;text-align:center;color:var(--gray-l);">í•´ë‹¹ ê¸°ê°„ì— ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  const sortBar=`<div class="sort-bar no-export">
    <span style="font-size:11px;color:var(--text3)">ë‚ ì§œ ì •ë ¬</span>
    <button class="sort-btn ${recSortDir==='desc'?'on':''}" onclick="recSortDir='desc';render()">ìµœì‹ ìˆœ â†“</button>
    <button class="sort-btn ${recSortDir==='asc'?'on':''}" onclick="recSortDir='asc';render()">ì˜¤ë˜ëœìˆœ â†‘</button>
    <span style="font-size:11px;color:var(--gray-l);margin-left:4px">${filtered.length}ê±´</span>
  </div>`;
  let h=sortBar;
  filtered.forEach(({m,i})=>{
    const isCK=(mode==='ck'||mode==='pro'||mode==='tt');
    const ca=isCK?'#2563eb':gc(m.a);
    const cb=isCK?'#dc2626':gc(m.b);
    const labelA=isCK?'AíŒ€':m.a;
    const labelB=isCK?'BíŒ€':m.b;
    const aWin=(m.sa>m.sb);const bWin=(m.sb>m.sa);
    const key=`${context}-${mode}-${i}`;
    h+=`<div class="rec-summary">
      <div class="rec-sum-header">
        <span style="color:var(--gray-l);font-size:11px;min-width:72px">${m.d||''}</span>
        <div class="rec-sum-vs">
          <span class="ubadge${aWin?'':' loser'} clickable-univ" style="background:${ca}" onclick="${!isCK?`openUnivModal('${m.a||''}')`:''}">${labelA}</span>
          <div class="rec-sum-score score-click" onclick="toggleDetail('${key}')" title="í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°/ë‹«ê¸°">
            <span class="${aWin?'wt':bWin?'lt':'pt-z'}">${m.sa}</span>
            <span style="color:var(--gray-l);font-size:14px">:</span>
            <span class="${bWin?'wt':aWin?'lt':'pt-z'}">${m.sb}</span>
          </div>
          <span class="ubadge${bWin?'':' loser'} clickable-univ" style="background:${cb}" onclick="${!isCK?`openUnivModal('${m.b||''}')`:''}">${labelB}</span>
          <span style="font-size:12px;color:${aWin?ca:bWin?cb:'#888'};font-weight:600">
            ${aWin?'â–¶ '+labelA+' ìŠ¹':bWin?'â–¶ '+labelB+' ìŠ¹':'ë¬´ìŠ¹ë¶€'}
          </span>
        </div>
        <div style="margin-left:auto;display:flex;gap:5px;align-items:center" class="no-export">
          <button id="detbtn-${key}" class="btn-detail" onclick="toggleDetail('${key}')">â–¼ ìƒì„¸</button>
          ${mode!=='ck'?adminBtn(`<button class="btn btn-o btn-xs" onclick="openRE('${mode}',${i})">ìˆ˜ì •</button>`):''}
          ${adminBtn(`<button class="btn btn-r btn-xs" onclick="delRec('${mode}',${i})">ì‚­ì œ</button>`)}
        </div>
      </div>
      <div id="det-${key}" class="rec-detail-area">
        ${buildDetailHTML(m, mode, labelA, labelB, ca, cb, aWin, bWin)}
        <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
          ${m.memo?`<div style="font-size:12px;color:var(--text2);background:#fffbeb;border:1px solid var(--gold-b);border-radius:6px;padding:6px 10px;margin-bottom:6px">ğŸ“ ${m.memo}</div>`:''}
          <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
            <button class="btn-capture btn-xs no-export" onclick="captureDetail('det-${key}','${m.d||'match'}')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
            ${isLoggedIn?`<input type="text" id="memo-${key}" placeholder="ê²½ê¸° ë©”ëª¨ ì…ë ¥..." value="${m.memo||''}" style="flex:1;font-size:12px">
            <button class="btn btn-w btn-xs" onclick="saveMemo('${mode}',${i},'memo-${key}')">ğŸ’¾ ë©”ëª¨</button>
            ${m.memo?`<button class="btn btn-r btn-xs" onclick="saveMemo('${mode}',${i},null)">ì‚­ì œ</button>`:''}`:''}
        </div>
      </div>
    </div>
  </div>`;
  });
  return h||`<div style="padding:40px;text-align:center;color:var(--gray-l);">í•´ë‹¹ ê¸°ê°„ì— ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
}

function buildDetailHTML(m, mode, labelA, labelB, ca, cb, aWin, bWin){
  if(!m.sets||!m.sets.length) return `<div style="font-size:12px;color:var(--gray-l);padding:8px 0">ì„¸íŠ¸ ìƒì„¸ ê¸°ë¡ ì—†ìŒ</div>`;
  let h='';
  m.sets.forEach((set,si)=>{
    const isAce=(si===2);
    const sLabel=isAce?'ğŸ¯ ì—ì´ìŠ¤ì „':`${si+1}ì„¸íŠ¸`;
    const swA=set.scoreA||0, swB=set.scoreB||0;
    const setAWin=swA>swB, setBWin=swB>swA;
    h+=`<div class="set-row">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:7px 12px;background:${isAce?'#f5f3ff':'var(--blue-l)'};border-radius:7px;border:1px solid ${isAce?'#ddd6fe':'var(--blue-ll)'}">
        <span class="set-row-title ${isAce?'ace-t':''}" style="margin-bottom:0">${sLabel}</span>
        <span class="ubadge${setAWin?'':' loser'}" style="background:${ca};font-size:10px">${labelA}</span>
        <span style="font-weight:800;font-size:15px">
          <span class="${setAWin?'wt':setBWin?'lt':'pt-z'}">${swA}</span>
          <span style="color:var(--border2)"> : </span>
          <span class="${setBWin?'wt':setAWin?'lt':'pt-z'}">${swB}</span>
        </span>
        <span class="ubadge${setBWin?'':' loser'}" style="background:${cb};font-size:10px">${labelB}</span>
        ${setAWin?`<span style="font-size:11px;font-weight:800;color:${ca};margin-left:4px">â–¶ ${labelA} ì„¸íŠ¸ ìŠ¹</span>`:setBWin?`<span style="font-size:11px;font-weight:800;color:${cb};margin-left:4px">â–¶ ${labelB} ì„¸íŠ¸ ìŠ¹</span>`:'<span style="font-size:11px;color:var(--gray-l)">ë¬´ìŠ¹ë¶€</span>'}
      </div>`;
    if(set.games&&set.games.length){
      set.games.forEach((g,gi)=>{
        if(!g.playerA&&!g.playerB)return;
        const pA=players.find(p=>p.name===g.playerA);
        const pB=players.find(p=>p.name===g.playerB);
        const aIsWinner=(g.winner==='A');
        const bIsWinner=(g.winner==='B');
        const hasWinner=!!(g.winner);
        const mapStr=g.map?`<span style="background:var(--surface);border:1px solid var(--border);padding:2px 8px;border-radius:4px;font-size:10px;color:var(--text3)">ğŸ“ ${g.map}</span>`:'';
        const winBgA=ca+'22';const winBgB=cb+'22';
        const winBorderA=ca+'66';const winBorderB=cb+'66';
        const styleA=hasWinner?(aIsWinner?`display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;background:${winBgA};border:2px solid ${winBorderA};`:`display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;background:#f1f5f9;border:1px solid #cbd5e1;opacity:0.45;filter:grayscale(1);`):`display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;background:var(--surface);border:1px solid var(--border);`;
        const styleB=hasWinner?(bIsWinner?`display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;background:${winBgB};border:2px solid ${winBorderB};`:`display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;background:#f1f5f9;border:1px solid #cbd5e1;opacity:0.45;filter:grayscale(1);`):`display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;background:var(--surface);border:1px solid var(--border);`;
        const winTagA=aIsWinner&&hasWinner?`<span style="background:${ca};color:#fff;font-size:10px;font-weight:800;padding:2px 7px;border-radius:4px;letter-spacing:.5px">WIN</span>`:'';
        const winTagB=bIsWinner&&hasWinner?`<span style="background:${cb};color:#fff;font-size:10px;font-weight:800;padding:2px 7px;border-radius:4px;letter-spacing:.5px">WIN</span>`:'';
        const clickA=g.playerA?`onclick="openPlayerModal('${g.playerA}')" style="cursor:pointer;text-decoration:underline dotted;"`:'';
        const clickB=g.playerB?`onclick="openPlayerModal('${g.playerB}')" style="cursor:pointer;text-decoration:underline dotted;"`:'';
        h+=`<div style="display:flex;align-items:center;gap:6px;padding:4px 4px;flex-wrap:wrap;">
          <span style="color:var(--gray-l);font-size:10px;min-width:42px;font-weight:600">ê²½ê¸°${gi+1}</span>
          <div style="${styleA}">
            ${pA?`<span class="rbadge r${pA.race}" style="font-size:10px">${pA.race}</span>`:''}
            <strong style="font-size:12px;color:var(--text)" ${clickA}>${g.playerA||'?'}</strong>
            ${pA?genderIcon(pA.gender):''}
            <span style="font-size:10px;color:${ca};font-weight:700">(${labelA})</span>
            ${winTagA}
          </div>
          <span style="color:var(--gray-l);font-size:11px;font-weight:600">vs</span>
          <div style="${styleB}">
            ${pB?`<span class="rbadge r${pB.race}" style="font-size:10px">${pB.race}</span>`:''}
            <strong style="font-size:12px;color:var(--text)" ${clickB}>${g.playerB||'?'}</strong>
            ${pB?genderIcon(pB.gender):''}
            <span style="font-size:10px;color:${cb};font-weight:700">(${labelB})</span>
            ${winTagB}
          </div>
          ${mapStr}
        </div>`;
      });
    } else {
      h+=`<div style="font-size:11px;color:var(--gray-l);padding:4px 0">ìƒì„¸ ê²½ê¸° ê¸°ë¡ ì—†ìŒ</div>`;
    }
    h+=`</div>`;
  });
  return h;
}

function compSummaryListHTML(context){
  if(!comps.length)return`<div style="padding:40px;text-align:center;color:var(--gray-l);">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  let h='';
  [...comps].sort((a,b)=>b.d.localeCompare(a.d)).forEach((m)=>{
    if(typeof passDateFilter==='function' && !passDateFilter(m.d||''))return;
    const rIdx=comps.indexOf(m);
    const a=m.a||m.hostUniv||m.u||'';const b=m.b||'';
    const ca=gc(a);const cb=gc(b);
    const aWin=m.sa>m.sb;const bWin=m.sb>m.sa;
    const key=`${context}-comp-${rIdx}`;
    h+=`<div class="rec-summary">
      <div class="rec-sum-header">
        <span style="color:var(--gray-l);font-size:11px;min-width:72px">${m.d}</span>
        <span style="font-weight:700;font-size:13px">ğŸ–ï¸ ${m.n}</span>
        <div class="rec-sum-vs">
          ${a?`<span class="ubadge${aWin?'':' loser'} clickable-univ" style="background:${ca}" onclick="openUnivModal('${a}')">${a}</span>`:''}
          ${(a&&b)?`<div class="rec-sum-score">
            <span class="${aWin?'wt':bWin?'lt':'pt-z'}">${m.sa||0}</span>
            <span style="color:var(--gray-l);font-size:14px">:</span>
            <span class="${bWin?'wt':aWin?'lt':'pt-z'}">${m.sb||0}</span>
          </div>`:''}
          ${b?`<span class="ubadge${bWin?'':' loser'} clickable-univ" style="background:${cb}" onclick="openUnivModal('${b}')">${b}</span>`:''}
          ${(a&&b)?`<span style="font-size:12px;font-weight:700;color:${aWin?ca:bWin?cb:'#888'}">
            ${aWin?'â–¶ '+a+' ìŠ¹':bWin?'â–¶ '+b+' ìŠ¹':'ë¬´ìŠ¹ë¶€'}
          </span>`:''}
        </div>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center" class="no-export">
          <button id="detbtn-${key}" class="btn-detail" onclick="toggleDetail('${key}')">â–¼ ìƒì„¸ ë³´ê¸°</button>
          ${adminBtn(`<button class="btn btn-o btn-xs" onclick="openRE('comp',${rIdx})">ìˆ˜ì •</button>`)}
          ${adminBtn(`<button class="btn btn-r btn-xs" onclick="delRec('comp',${rIdx})">ì‚­ì œ</button>`)}
        </div>
      </div>
      <div id="det-${key}" class="rec-detail-area">
        ${buildDetailHTML(m,'comp',a,b,ca,cb,aWin,bWin)}
      </div>
    </div>`;
  });
  return h||`<div style="padding:40px;text-align:center;color:var(--gray-l);">í•´ë‹¹ ê¸°ê°„ì— ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
}

function delRec(mode,i){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ í•´ë‹¹ ëŒ€ì „ì˜ ëª¨ë“  ê²½ê¸° ê²°ê³¼ê°€ ì„ ìˆ˜ ì„±ì ì—ì„œ ì°¨ê°ë©ë‹ˆë‹¤.'))return;
  let matchObj=null;
  if(mode==='mini')     { matchObj=miniM[i];  miniM.splice(i,1); }
  else if(mode==='univm'){ matchObj=univM[i];  univM.splice(i,1); }
  else if(mode==='comp') { matchObj=comps[i];  comps.splice(i,1); }
  else if(mode==='ck')   { matchObj=ckM[i];    ckM.splice(i,1);   }
  else if(mode==='pro')  { matchObj=proM[i];   proM.splice(i,1);  }
  else if(mode==='tt')   { matchObj=ttM[i];    ttM.splice(i,1);   }
  if(matchObj) revertMatchRecord(matchObj);
  save();render();
}

function goToPlayer(name){
  searchTarget=name;histSub='player';openDetails={};curTab='hist';
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(b=>{if(b.textContent.includes('ëŒ€ì „ ê¸°ë¡'))b.classList.add('on');});
  document.getElementById('fstrip').style.display='none';
  render();
}

/* ì„ ìˆ˜ë³„ ê²€ìƒ‰ */
function doSearch(val){
  const v=(val||'').toLowerCase().trim();
  const R=document.getElementById('hres');
  if(!R)return;
  if(!v){R.innerHTML='';return;}
  const p=players.find(x=>x.name.toLowerCase().includes(v));
  if(!p){R.innerHTML=`<div style="color:var(--gray-l);padding:20px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;return;}
  searchTarget=p.name;
  const opps={},rv={T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}};
  p.history.forEach(h=>{
    if(!opps[h.opp])opps[h.opp]={w:0,l:0,race:h.oppRace};
    if(h.result==='ìŠ¹'){opps[h.opp].w++;if(rv[h.oppRace])rv[h.oppRace].w++;}
    else{opps[h.opp].l++;if(rv[h.oppRace])rv[h.oppRace].l++;}
  });
  const matchLog=[];
  function scanMatches(arr, modeLabel, getLabel){
    arr.forEach(m=>{
      if(!m.sets)return;
      m.sets.forEach((set,si)=>{
        if(!set.games)return;
        set.games.forEach(g=>{
          const isA=(g.playerA===p.name), isB=(g.playerB===p.name);
          if(!isA&&!isB)return;
          const isWin=(isA&&g.winner==='A')||(isB&&g.winner==='B');
          const opp=isA?g.playerB:g.playerA;
          const oppP=players.find(x=>x.name===opp);
          const d=m.d||'';
          if(typeof passDateFilter==='function' && !passDateFilter(d)) return;
          matchLog.push({
            date:d,
            mode:modeLabel,
            label:getLabel(m),
            result:isWin?'ìŠ¹':'íŒ¨',
            opp:opp||'?',
            oppRace:oppP?.race||'?',
            map:g.map||'-',
            setLabel:si===2?'ì—ì´ìŠ¤ì „':`${si+1}ì„¸íŠ¸`,
            mObj:m,
            si:si,
            gi:set.games.indexOf(g)
          });
        });
      });
    });
  }
  scanMatches(miniM,'ë¯¸ë‹ˆëŒ€ì „',m=>m.t||'ë¯¸ë‹ˆëŒ€ì „');
  scanMatches(univM,'ëŒ€í•™ëŒ€ì „',m=>m.n||`${m.a} vs ${m.b}`);
  scanMatches(comps,'ëŒ€íšŒ',m=>m.n||'ëŒ€íšŒ');
  scanMatches(ckM,'ëŒ€í•™CK',m=>'ëŒ€í•™CK');
  matchLog.sort((a,b)=>b.date.localeCompare(a.date));

  // í•„í„°ì— ë”°ë¥¸ ê¸°ê°„ë³„ ì „ì  ì§‘ê³„
  let fWin=p.win, fLoss=p.loss;
  if(!(filterYear==='ì „ì²´' && filterMonth==='ì „ì²´')){
    fWin=0;fLoss=0;
    matchLog.forEach(lg=>{
      if(lg.result==='ìŠ¹')fWin++; else if(lg.result==='íŒ¨')fLoss++;
    });
  }
  const fTot=fWin+fLoss;
  const fWr=fTot?Math.round(fWin/fTot*100):0;

  const col=gc(p.univ);

  const modeBg={'ë¯¸ë‹ˆëŒ€ì „':'#2563eb','ëŒ€í•™ëŒ€ì „':'#7c3aed','ëŒ€íšŒ':'#d97706','ëŒ€í•™CK':'#dc2626'};
  let h=`<div class="ipanel" style="border-color:${col}66;background:${col}0d;">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px">
      <span class="ubadge clickable-univ" style="background:${col};font-size:13px;padding:5px 14px" onclick="openUnivModal('${p.univ}')">${p.univ}</span>
      <span class="rbadge r${p.race}">${p.race}</span>
      <span style="font-size:20px">${p.name}${genderIcon(p.gender)}</span>
      ${getTierBadge(p.tier)}
    </div>
    <div style="display:flex;gap:24px;flex-wrap:wrap">
      <div><div style="font-size:11px;color:var(--gray-l)">ì´ ì „ì </div>
        <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px"><span class="wt">${fWin}ìŠ¹</span> <span class="lt">${fLoss}íŒ¨</span></div></div>
      <div><div style="font-size:11px;color:var(--gray-l)">ìŠ¹ë¥ </div>
        <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px;color:${fWr>=50?'var(--green)':'var(--red)'}">${fTot?fWr+'%':'-'}</div></div>
      <div><div style="font-size:11px;color:var(--gray-l)">í¬ì¸íŠ¸</div>
        <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px" class="${pC(p.points)}">${pS(p.points)}</div></div>
    </div>
  </div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px">`;
  RACES.forEach(r=>{
    const s=rv[r];const t=s.w+s.l;const w=t?Math.round(s.w/t*100):0;
    h+=`<div class="rscard"><div style="margin-bottom:6px"><span class="rbadge r${r}">${r} ${RNAME[r]}</span></div>
      <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px;color:${w>=50?'var(--green)':'var(--red)'}">${t?w+'%':'-'}</div>
      <div style="font-size:11px;margin-top:4px"><span class="wt">${s.w}ìŠ¹</span> <span class="lt">${s.l}íŒ¨</span></div></div>`;
  });
  h+=`</div><div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">`;
  Object.entries(opps).sort((a,b)=>(b[1].w+b[1].l)-(a[1].w+a[1].l)).forEach(([opp,s])=>{
    const ot=s.w+s.l;const ow=ot?Math.round(s.w/ot*100):0;
    h+=`<div class="ocard" style="cursor:pointer" onclick="openPlayerModal('${opp}')">
      <div style="font-weight:700;font-size:13px;color:var(--blue);text-decoration:underline dotted">${opp}</div>
      <div style="font-size:11px;margin:3px 0"><span class="rbadge r${s.race}">${s.race}</span></div>
      <div><span class="wt">${s.w}ìŠ¹</span> <span class="lt">${s.l}íŒ¨</span></div>
      <div style="font-weight:700;font-size:12px;color:${ow>=50?'var(--green)':'var(--red)'}">${ow}%</div>
    </div>`;
  });
  h+=`</div>`;

  if(matchLog.length){
    h+=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px;color:var(--blue);margin-bottom:8px;padding-bottom:6px;border-bottom:2px solid var(--blue-ll)">ğŸ“‹ ëŒ€ì „ë³„ ìƒì„¸ ê¸°ë¡ <span style="font-size:10px;font-weight:400;color:var(--gray-l)">(í–‰ í´ë¦­ ì‹œ ê²½ê¸° ìƒì„¸ / ì´ë¦„ í´ë¦­ ì‹œ í•´ë‹¹ ì„ ìˆ˜ ì´ë™)</span></div>`;
    h+=`<table><thead><tr><th>ë‚ ì§œ</th><th>ëŒ€ì „ ì¢…ë¥˜</th><th>ì„¸íŠ¸</th><th>ê²°ê³¼</th><th>ìƒëŒ€</th><th>ìƒëŒ€ì¢…ì¡±</th><th>ë§µ</th><th style="width:20px"></th></tr></thead><tbody>`;
    matchLog.forEach((lg,li)=>{
      const mb=modeBg[lg.mode]||'#6b7280';
      const modeCell=lg.mode==='ëŒ€íšŒ'
        ?`<span style="background:${mb};color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700">${lg.mode}</span><span style="font-size:11px;font-weight:700;color:var(--gold);margin-left:4px">${lg.label}</span>`
        :`<span style="background:${mb};color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700">${lg.mode}</span>`;
      const resultCell=lg.result==='ìŠ¹'
        ?`<span style="background:var(--blue);color:#fff;font-size:12px;font-weight:800;padding:3px 11px;border-radius:5px;letter-spacing:.5px">WIN</span>`
        :`<span style="background:#94a3b8;color:#fff;font-size:12px;font-weight:700;padding:3px 11px;border-radius:5px;letter-spacing:.5px;opacity:0.7">LOSE</span>`;
      const oppP=players.find(x=>x.name===lg.opp);
      const oppClick=lg.opp!=='?'?`onclick="event.stopPropagation();openPlayerModal('${lg.opp}')" style="color:var(--blue);text-decoration:underline dotted;cursor:pointer;font-weight:700"`:'';
      const detKey=`psearch-${li}`;
      const mObj=lg.mObj;
      const isCK=(lg.mode==='ëŒ€í•™CK');
      const ca=isCK?'#2563eb':(mObj.a?gc(mObj.a):'#888');
      const cb=isCK?'#dc2626':(mObj.b?gc(mObj.b):'#888');
      const labelA=isCK?'AíŒ€':(mObj.a||'A');
      const labelB=isCK?'BíŒ€':(mObj.b||'B');
      const singleSetHTML=buildSingleSetHTML(mObj,lg.si,labelA,labelB,ca,cb);
      h+=`<tr style="cursor:pointer" onclick="toggleDetail('${detKey}')">
        <td style="color:var(--gray-l);font-size:11px">${lg.date}</td>
        <td>${modeCell}</td>
        <td style="color:var(--gray-l);font-size:11px">${lg.setLabel}</td>
        <td>${resultCell}</td>
        <td><span ${oppClick}>${lg.opp}</span></td>
        <td>${lg.oppRace!=='?'?`<span class="rbadge r${lg.oppRace}">${lg.oppRace}</span>`:'-'}</td>
        <td style="color:var(--gray-l);font-size:11px">${lg.map}</td>
        <td style="color:var(--gray-l);font-size:10px" id="detbtn-${detKey}">â–¼</td>
      </tr>
      <tr id="det-${detKey}" style="display:none">
        <td colspan="8" style="padding:0;background:var(--surface)">
          <div style="padding:10px 16px">${singleSetHTML}</div>
        </td>
      </tr>`;
    });
    h+=`</tbody></table>`;
  } else {
    h+=`<div style="padding:20px;text-align:center;color:var(--gray-l);background:var(--surface);border-radius:8px;border:1px solid var(--border)">ëŒ€ì „ ê¸°ë¡ì—ì„œ ì´ ì„ ìˆ˜ì˜ ê²½ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }
  R.innerHTML=h;
}

function toggleDetail(key){
  const area=document.getElementById('det-'+key);
  const btn=document.getElementById('detbtn-'+key);
  if(!area)return;
  const isTR=area.tagName==='TR';
  if(isTR){
    const open=area.style.display==='none'||area.style.display==='';
    area.style.display=open?'table-row':'none';
    if(btn)btn.textContent=open?'â–²':'â–¼';
  } else {
    openDetails[key]=!openDetails[key];
    area.classList.toggle('open',!!openDetails[key]);
    if(btn){btn.classList.toggle('open',!!openDetails[key]);btn.textContent=openDetails[key]?'â–² ìƒì„¸ ë‹«ê¸°':'â–¼ ìƒì„¸ ë³´ê¸°';}
  }
}

function savePlayerMemo(name, del=false){
  const p=players.find(x=>x.name===name);
  if(!p)return;
  if(del){
    delete p.memo;
  } else {
    const el=document.getElementById('player-memo-input');
    if(el) p.memo=el.value.trim();
  }
  save();
  document.getElementById('playerModalBody').innerHTML=buildPlayerDetailHTML(p);
}

function saveMemo(mode,idx,inputId){
  let arr;
  if(mode==='mini') arr=miniM;
  else if(mode==='univm') arr=univM;
  else if(mode==='comp') arr=comps;
  else if(mode==='ck') arr=ckM;
  else if(mode==='pro') arr=proM;
  else return;
  if(!arr[idx])return;
  if(inputId===null){
    delete arr[idx].memo;
  } else {
    const el=document.getElementById(inputId);
    if(el) arr[idx].memo=el.value.trim();
  }
  save();render();
}

function buildSingleSetHTML(m, si, labelA, labelB, ca, cb){
  if(!m.sets||!m.sets[si])return`<div style="font-size:11px;color:var(--gray-l)">ì„¸íŠ¸ ê¸°ë¡ ì—†ìŒ</div>`;
  const set=m.sets[si];
  const isAce=(si===2);
  const sLabel=isAce?'ğŸ¯ ì—ì´ìŠ¤ì „':`${si+1}ì„¸íŠ¸`;
  const swA=set.scoreA||0,swB=set.scoreB||0;
  const setAWin=swA>swB,setBWin=swB>swA;
  let h=`<div style="font-size:11px;font-weight:700;color:${isAce?'#7c3aed':'var(--blue)'};margin-bottom:8px">${sLabel} â€” ${labelA} <span class="${setAWin?'wt':'lt'}">${swA}</span>:<span class="${setBWin?'wt':'lt'}">${swB}</span> ${labelB}</div>`;
  if(set.games&&set.games.length){
    set.games.forEach((g,gi)=>{
      if(!g.playerA&&!g.playerB)return;
      const pA=players.find(p=>p.name===g.playerA);
      const pB=players.find(p=>p.name===g.playerB);
      const aIsWinner=g.winner==='A';const bIsWinner=g.winner==='B';const hasWinner=!!g.winner;
      const winBgA=ca+'22',winBgB=cb+'22',winBorderA=ca+'66',winBorderB=cb+'66';
      const styleA=hasWinner?(aIsWinner?`display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:${winBgA};border:2px solid ${winBorderA};`:`display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:#f1f5f9;border:1px solid #cbd5e1;opacity:0.45;filter:grayscale(1);`):`display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:var(--surface);border:1px solid var(--border);`;
      const styleB=hasWinner?(bIsWinner?`display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:${winBgB};border:2px solid ${winBorderB};`:`display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:#f1f5f9;border:1px solid #cbd5e1;opacity:0.45;filter:grayscale(1);`):`display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:var(--surface);border:1px solid var(--border);`;
      const cA=g.playerA?`onclick="openPlayerModal('${g.playerA}')" style="cursor:pointer;text-decoration:underline dotted"`:'';
      const cB=g.playerB?`onclick="openPlayerModal('${g.playerB}')" style="cursor:pointer;text-decoration:underline dotted"`:'';
      const mapStr=g.map?`<span style="background:var(--surface);border:1px solid var(--border);padding:2px 6px;border-radius:4px;font-size:10px">ğŸ“${g.map}</span>`:'';
      h+=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;flex-wrap:wrap">
        <span style="color:var(--gray-l);font-size:10px;min-width:40px">ê²½ê¸°${gi+1}</span>
        <div style="${styleA}">${pA?`<span class="rbadge r${pA.race}" style="font-size:10px">${pA.race}</span>`:''}<strong style="font-size:12px" ${cA}>${g.playerA||'?'}</strong>${pA?genderIcon(pA.gender):''}<span style="font-size:10px;color:${ca};font-weight:700">(${labelA})</span>${aIsWinner&&hasWinner?`<span style="background:${ca};color:#fff;font-size:9px;font-weight:800;padding:1px 6px;border-radius:3px">WIN</span>`:''}</div>
        <span style="color:var(--gray-l);font-size:10px">vs</span>
        <div style="${styleB}">${pB?`<span class="rbadge r${pB.race}" style="font-size:10px">${pB.race}</span>`:''}<strong style="font-size:12px" ${cB}>${g.playerB||'?'}</strong>${pB?genderIcon(pB.gender):''}<span style="font-size:10px;color:${cb};font-weight:700">(${labelB})</span>${bIsWinner&&hasWinner?`<span style="background:${cb};color:#fff;font-size:9px;font-weight:800;padding:1px 6px;border-radius:3px">WIN</span>`:''}</div>
        ${mapStr}
      </div>`;
    });
  }
  return h;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì¢…ì¡± ìŠ¹ë¥ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rRace(C,T){
  T.innerText='ğŸ§¬ ì¢…ì¡±ë³„ ì „ì²´ ìŠ¹ë¥ ';
  let h='';
  if(typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('race');
  }
  if(typeof raceSummaryHTML==='function'){
    h+=raceSummaryHTML();
    C.innerHTML=h;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëŒ€í•™ë³„ í¬ì¸íŠ¸ ìˆœìœ„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rUniv(C,T){
  T.innerText='ğŸ›ï¸ ëŒ€í•™ë³„ í¬ì¸íŠ¸ ìˆœìœ„';
  C.innerHTML=rUnivBodyHTML();
}

function rUnivBodyHTML(){
  const uS={};
  // ëŒ€í•™ë³„ ê¸°ë³¸ êµ¬ì¡° ìƒì„±
  getAllUnivs().forEach(u=>{uS[u.name]={w:0,l:0,pts:0,cnt:0};});
  // ì„ ìˆ˜ ìˆ˜ ì¹´ìš´íŠ¸
  players.forEach(p=>{
    if(!uS[p.univ])uS[p.univ]={w:0,l:0,pts:0,cnt:0};
    uS[p.univ].cnt++;
  });
  // ì—°/ì›” í•„í„°ë¥¼ ì ìš©í•œ ê²½ê¸° ê²°ê³¼ë¡œ ìŠ¹/íŒ¨/í¬ì¸íŠ¸ ì§‘ê³„
  players.forEach(p=>{
    const univ=p.univ;
    const bucket=uS[univ];
    if(!bucket)return;
    (p.history||[]).forEach(h=>{
      const d=h.date||'';
      if(typeof passDateFilter==='function' && !passDateFilter(d)) return;
      if(h.result==='ìŠ¹') bucket.w++;
      else if(h.result==='íŒ¨') bucket.l++;
    });
  });
  Object.values(uS).forEach(s=>{
    s.pts = (s.w*3)-(s.l*3);
  });
  const sorted=Object.entries(uS).filter(([,s])=>s.cnt>0).sort((a,b)=>b[1].pts-a[1].pts);
  let h='';
  if(typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('univ-rank');
  }
  h+=`<table><thead><tr><th>ìˆœìœ„</th><th>ëŒ€í•™</th><th>ì„ ìˆ˜ ìˆ˜</th><th>ì´ ìŠ¹</th><th>ì´ íŒ¨</th><th>ì´ í¬ì¸íŠ¸</th><th>ìŠ¹ë¥ </th></tr></thead><tbody>`;
  if(!sorted.length)h+=`<tr><td colspan="7" style="padding:40px;color:var(--gray-l)">ë“±ë¡ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
  sorted.forEach(([name,s],i)=>{
    const col=gc(name);const tot=s.w+s.l;const wr=tot?Math.round(s.w/tot*100):0;
    let rnkHTML;
    if(i===0) rnkHTML=`<span class="rk1">1ë“±</span>`;
    else if(i===1) rnkHTML=`<span class="rk2">2ë“±</span>`;
    else if(i===2) rnkHTML=`<span class="rk3">3ë“±</span>`;
    else rnkHTML=`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px">${i+1}ìœ„</span>`;
    h+=`<tr style="background:${col}08">
      <td>${rnkHTML}</td>
      <td><span class="ubadge clickable-univ" style="background:${col}" onclick="openUnivModal('${name}')">${name}</span></td>
      <td style="color:var(--gray-l)">${s.cnt}ëª…</td>
      <td class="wt" style="font-size:15px;font-weight:800">${s.w}</td>
      <td class="lt" style="font-size:15px;font-weight:800">${s.l}</td>
      <td class="${pC(s.pts)}" style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px">${pS(s.pts)}</td>
      <td style="font-weight:700;color:${wr>=50?'var(--green)':'var(--red)'}">${tot?wr+'%':'-'}</td>
    </tr>`;
  });
  return h+`</tbody></table>`;
}

// ì¢…ì¡± ìŠ¹ë¥  ê³µí†µ HTML (ì—°ë„/ì›” í•„í„° ì ìš©)
function raceSummaryHTML(){
  const rs={T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}};
  const vs={T:{T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}},Z:{T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}},P:{T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}}};
  players.forEach(p=>{
    const myRace=p.race;
    if(!rs[myRace])return;
    (p.history||[]).forEach(h=>{
      const d=h.date||'';
      if(typeof passDateFilter==='function' && !passDateFilter(d)) return;
      if(h.result==='ìŠ¹') rs[myRace].w++; else rs[myRace].l++;
      if(vs[myRace]?.[h.oppRace]){
        if(h.result==='ìŠ¹') vs[myRace][h.oppRace].w++; else vs[myRace][h.oppRace].l++;
      }
    });
  });
  const RC={T:'#1d4ed8',Z:'#7c3aed',P:'#b45309'};
  let h=`<div class="scards">`;
  RACES.forEach(r=>{
    const s=rs[r];const tot=s.w+s.l;const wr=tot?Math.round(s.w/tot*100):0;
    h+=`<div class="scard" style="border-top:4px solid ${RC[r]}">
      <div class="sv" style="color:${RC[r]}">${tot?wr+'%':'-'}</div>
      <div style="margin:6px 0"><span class="rbadge r${r}">${r} ${RNAME[r]}</span></div>
      <div class="sl"><span class="wt">${s.w}ìŠ¹</span> Â· <span class="lt">${s.l}íŒ¨</span></div>
    </div>`;
  });
  h+=`</div><table><thead><tr><th>ë‚´ ì¢…ì¡±</th><th>vs í…Œë€(T)</th><th>vs ì €ê·¸(Z)</th><th>vs í”„ë¡œí† ìŠ¤(P)</th></tr></thead><tbody>`;
  RACES.forEach(my=>{
    h+=`<tr><td><span class="rbadge r${my}">${my} ${RNAME[my]}</span></td>`;
    RACES.forEach(op=>{
      const s=vs[my][op];const t=s.w+s.l;const w=t?Math.round(s.w/t*100):0;
      h+=`<td><span class="wt">${s.w}ìŠ¹</span> <span class="lt">${s.l}íŒ¨</span>${t?` <span style="color:${w>=50?'var(--green)':'var(--red)'};font-weight:700">(${w}%)</span>`:''}`;
    });
    h+=`</tr>`;
  });
  return h+`</tbody></table>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ê³µí†µ ì„¸íŠ¸ ë¹Œë”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function stabs(current, opts){
  return `<div class="stabs no-export">${opts.map(o=>{
    if(o.id==='input'&&!isLoggedIn) return '';
    return `<button class="stab ${current===o.id?'on':''}" onclick="${o.fn}">${o.lbl}</button>`;
  }).join('')}</div>`;
}

// ê³µí†µ ì—°ë„/ì›” í•„í„° UI
function buildYearMonthFilter(section){
  let h=`<div class="fbar no-export" style="margin-bottom:12px;flex-wrap:wrap">
    <strong>ê¸°ê°„</strong>`;
  const years=['ì „ì²´',...yearOptions];
  years.forEach(y=>{
    const sel=(filterYear===y);
    const label=(y==='ì „ì²´')?'ì „ì²´':`${y}ë…„`;
    h+=`<button class="pill ${sel?'on':''}" onclick="setFilterYear('${y}','${section}')">${label}</button>`;
  });
  if(isLoggedIn){
    h+=`<button class="pill" onclick="addYear('${section}')">+ ì—°ë„ ì¶”ê°€</button>`;
  }
  h+=`<span style="font-size:11px;color:var(--gray-l);margin-left:10px">ì›”</span>`;
  const months=['ì „ì²´','01','02','03','04','05','06','07','08','09','10','11','12'];
  months.forEach(m=>{
    const sel=(filterMonth===m);
    const label=(m==='ì „ì²´')?'ì „ì²´':`${parseInt(m,10)}ì›”`;
    h+=`<button class="pill ${sel?'on':''}" onclick="setFilterMonth('${m}','${section}')">${label}</button>`;
  });
  h+='</div>';
  return h;
}

function setFilterYear(y, section){
  filterYear=y;
  openDetails={};
  render();
}

function addYear(section){
  if(!isLoggedIn)return;
  const y=prompt('ì¶”ê°€í•  ì—°ë„ (ì˜ˆ: 2027)ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
  if(!y)return;
  const v=y.trim();
  if(!/^\d{4}$/.test(v))return;
  if(!yearOptions.includes(v))yearOptions.push(v);
  render();
}

function setFilterMonth(m, section){
  filterMonth=m;
  openDetails={};
  render();
}

function passDateFilter(dateStr){
  if(!dateStr)return true;
  const y=dateStr.slice(0,4);
  const m=dateStr.slice(5,7);
  if(filterYear!=='ì „ì²´' && y!==filterYear)return false;
  if(filterMonth!=='ì „ì²´' && m!==filterMonth)return false;
  return true;
}

function setBuilderHTML(bld, mode){
  const isCK=(mode==='ck'||mode==='pro'||mode==='tt');const isComp=(mode==='comp');
  const allU=getAllUnivs();
  const uOptsA=allU.map(u=>`<option value="${u.name}"${bld.teamA===u.name?' selected':''}>${u.name}</option>`).join('');
  const uOptsB=allU.map(u=>`<option value="${u.name}"${bld.teamB===u.name?' selected':''}>${u.name}</option>`).join('');
  let scoreA=0,scoreB=0;
  bld.sets.forEach(s=>{if(s.winner==='A')scoreA++;else if(s.winner==='B')scoreB++;});
  let h='';
  // CK ëª¨ë“œì—ì„œëŠ” ë‚ ì§œë¥¼ buildCKInputHTMLì—ì„œë§Œ í‘œì‹œ (ì¤‘ë³µ ë°©ì§€)
  if(!isCK){
  h+=`<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;align-items:center">
    <label style="font-size:12px;font-weight:700;color:var(--blue)">ë‚ ì§œ</label>
    <input type="date" value="${bld.date||''}" onchange="BLD['${mode}'].date=this.value" style="width:140px">`;
  if(isComp)h+=`<label style="font-size:12px;font-weight:700;color:var(--blue)">ëŒ€íšŒëª…</label>
    <input type="text" id="comp-name-input" value="${bld.compName||curComp||''}" placeholder="ëŒ€íšŒëª…" style="width:150px" onchange="BLD['comp'].compName=this.value">`;
  h+=`</div>`;
  }
  if(!isCK){
    // ì¢…ì¡± í•„í„° ìƒíƒœ (BLDì— ì €ì¥)
    const rfA=bld.raceFilterA||'';const rfB=bld.raceFilterB||'';
    h+=`<div style="display:flex;gap:14px;margin-bottom:16px;flex-wrap:wrap">
      <div style="flex:1;min-width:160px">
        <label style="font-size:12px;font-weight:700;color:var(--blue);display:block;margin-bottom:6px">ğŸ”µ ${isComp?'ì£¼ìµœ ëŒ€í•™ A':'íŒ€ A ëŒ€í•™'}</label>
        <select onchange="BLD['${mode}'].teamA=this.value;BLD['${mode}'].raceFilterA='';BLD['${mode}'].sets=[];render()" style="width:100%">
          <option value="">ëŒ€í•™ ì„ íƒ</option>${uOptsA}
        </select>
        ${bld.teamA?`<div style="margin-top:6px;display:flex;gap:4px;align-items:center;flex-wrap:wrap">
          <span class="ubadge" style="background:${gc(bld.teamA)}">${bld.teamA}</span>
          ${!isComp?`<span style="font-size:11px;color:var(--gray-l)">ì¢…ì¡± í•„í„°:</span>
          <button class="pill ${rfA===''?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterA='';render()">ì „ì²´</button>
          <button class="pill ${rfA==='T'?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterA='T';render()">í…Œë€</button>
          <button class="pill ${rfA==='Z'?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterA='Z';render()">ì €ê·¸</button>
          <button class="pill ${rfA==='P'?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterA='P';render()">í”„í† </button>`:''}
        </div>`:''}
      </div>
      <div style="flex:1;min-width:160px">
        <label style="font-size:12px;font-weight:700;color:var(--red);display:block;margin-bottom:6px">ğŸ”´ ${isComp?'ëŒ€ê²° ëŒ€í•™ B':'íŒ€ B ëŒ€í•™'}</label>
        <select onchange="BLD['${mode}'].teamB=this.value;BLD['${mode}'].raceFilterB='';BLD['${mode}'].sets=[];render()" style="width:100%">
          <option value="">ëŒ€í•™ ì„ íƒ</option>${uOptsB}
        </select>
        ${bld.teamB?`<div style="margin-top:6px;display:flex;gap:4px;align-items:center;flex-wrap:wrap">
          <span class="ubadge" style="background:${gc(bld.teamB)}">${bld.teamB}</span>
          ${!isComp?`<span style="font-size:11px;color:var(--gray-l)">ì¢…ì¡± í•„í„°:</span>
          <button class="pill ${rfB===''?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterB='';render()">ì „ì²´</button>
          <button class="pill ${rfB==='T'?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterB='T';render()">í…Œë€</button>
          <button class="pill ${rfB==='Z'?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterB='Z';render()">ì €ê·¸</button>
          <button class="pill ${rfB==='P'?'on':''}" style="padding:2px 8px;font-size:11px" onclick="BLD['${mode}'].raceFilterB='P';render()">í”„í† </button>`:''}
        </div>`:''}
      </div>
    </div>`;
  }
  const teamA=bld.teamA||'';const teamB=bld.teamB||'';
  const rfA=bld.raceFilterA||'';const rfB=bld.raceFilterB||'';
  const rawMA=isCK?(bld.membersA||[]):getMembers(teamA);
  const rawMB=isCK?(bld.membersB||[]):getMembers(teamB);
  const mA=rfA?rawMA.filter(p=>p.race===rfA):rawMA;
  const mB=rfB?rawMB.filter(p=>p.race===rfB):rawMB;
  const canBuild=(isCK)?(rawMA.length&&rawMB.length):(teamA&&teamB);
  if(canBuild){
    h+=`<div class="score-board">
      <span style="font-weight:700">${isCK?'íŒ€A ('+mA.map(m=>m.name).join(',')+')':teamA}</span>
      <span class="score-num wt">${scoreA}</span>
      <span style="color:var(--gray-l);font-size:20px;font-weight:700">:</span>
      <span class="score-num lt">${scoreB}</span>
      <span style="font-weight:700">${isCK?'íŒ€B ('+mB.map(m=>m.name).join(',')+')':teamB}</span>
      <span style="font-size:11px;color:var(--gray-l);margin-left:auto">${bld.sets.length}ì„¸íŠ¸</span>
    </div>`;
    bld.sets.forEach((set,si)=>{
      const isAce=(si===2);const sLabel=isAce?'ğŸ¯ ì—ì´ìŠ¤ì „':`${si+1}ì„¸íŠ¸`;
      const sA=set.scoreA||0,sB=set.scoreB||0;
      h+=`<div class="set-block ${isAce?'ace':''}">
        <div class="set-title">
          <span class="set-badge ${isAce?'ace':''}">${sLabel}</span>
          <span style="font-size:12px;color:var(--gray-l)">ê²½ê¸° ${set.games.length}ê°œ &nbsp;|&nbsp; <span class="${sA>sB?'wt':''}">${sA}</span>:<span class="${sB>sA?'wt':''}">${sB}</span></span>
          <button class="btn btn-r btn-xs" onclick="BLD['${mode}'].sets.splice(${si},1);render()">ì„¸íŠ¸ ì‚­ì œ</button>
        </div>`;
      set.games.forEach((g,gi)=>{
        const optsA=mA.map(p=>`<option value="${p.name}"${g.playerA===p.name?' selected':''}>${p.name} [${p.tier}/${p.race}]${isCK?' ('+p.univ+')':''}</option>`).join('');
        const optsB=mB.map(p=>`<option value="${p.name}"${g.playerB===p.name?' selected':''}>${p.name} [${p.tier}/${p.race}]${isCK?' ('+p.univ+')':''}</option>`).join('');
        const mapOpts=maps.map(m=>`<option value="${m}"${g.map===m?' selected':''}>${m}</option>`).join('');
        h+=`<div class="game-row">
          <span style="font-size:11px;font-weight:700;color:var(--gray-l);min-width:40px">ê²½ê¸°${gi+1}</span>
          <select onchange="BLD['${mode}'].sets[${si}].games[${gi}].playerA=this.value"><option value="">A ì„ íƒ</option>${optsA}</select>
          <span style="font-size:11px;color:var(--gray-l)">vs</span>
          <select onchange="BLD['${mode}'].sets[${si}].games[${gi}].playerB=this.value"><option value="">B ì„ íƒ</option>${optsB}</select>
          <select onchange="BLD['${mode}'].sets[${si}].games[${gi}].map=this.value" style="max-width:100px"><option value="">ë§µ ì„ íƒ</option>${mapOpts}</select>
          <button class="win-btn ${g.winner==='A'?'win-sel':''}" onclick="BLD['${mode}'].sets[${si}].games[${gi}].winner='A';recalcSet('${mode}',${si});render()">A ìŠ¹</button>
          <button class="win-btn ${g.winner==='B'?'lose-sel':''}" onclick="BLD['${mode}'].sets[${si}].games[${gi}].winner='B';recalcSet('${mode}',${si});render()">B ìŠ¹</button>
          <button class="btn btn-r btn-xs" onclick="BLD['${mode}'].sets[${si}].games.splice(${gi},1);recalcSet('${mode}',${si});render()">ì‚­ì œ</button>
        </div>`;
      });
      h+=`<button class="btn btn-w btn-sm" onclick="BLD['${mode}'].sets[${si}].games.push({playerA:'',playerB:'',winner:'',map:''});render()">+ ê²½ê¸° ì¶”ê°€</button></div>`;
    });
    if(bld.sets.length<3){
      const nLabel=bld.sets.length===2?'ğŸ¯ ì—ì´ìŠ¤ì „ ì¶”ê°€':`${bld.sets.length+1}ì„¸íŠ¸ ì¶”ê°€`;
      h+=`<button class="btn btn-b" style="margin-right:8px;margin-top:4px" onclick="BLD['${mode}'].sets.push({games:[],scoreA:0,scoreB:0,winner:''});render()">+ ${nLabel}</button>`;
    }
    h+=`<div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-g" onclick="saveMatch('${mode}')">âœ… ì €ì¥</button>
      <button class="btn btn-w" onclick="BLD['${mode}']=null;render()">ì´ˆê¸°í™”</button>
    </div>`;
  }
  return h;
}

function recalcSet(mode,si){
  const set=BLD[mode].sets[si];let a=0,b=0;
  set.games.forEach(g=>{if(g.winner==='A')a++;else if(g.winner==='B')b++;});
  set.scoreA=a;set.scoreB=b;set.winner=a>b?'A':b>a?'B':'';
}

function genId(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6);}

function saveMatch(mode){
  const bld=BLD[mode];if(!bld)return;
  if(!bld.sets.length)return alert('ì„¸íŠ¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
  const isCK=(mode==='ck'||mode==='tt');const isComp=(mode==='comp');
  let totalA=0,totalB=0;
  bld.sets.forEach((s,si)=>{recalcSet(mode,si);if(s.winner==='A')totalA++;else if(s.winner==='B')totalB++;});
  const date=bld.date||new Date().toISOString().slice(0,10);
  const matchId=genId();
  const setsSnap=bld.sets.map(s=>({scoreA:s.scoreA,scoreB:s.scoreB,winner:s.winner,games:s.games.map(g=>({...g}))}));
  bld.sets.forEach(set=>{
    set.games.forEach(g=>{
      if(!g.playerA||!g.playerB||!g.winner)return;
      const wName=g.winner==='A'?g.playerA:g.playerB;
      const lName=g.winner==='A'?g.playerB:g.playerA;
      applyGameResult(wName,lName,date,g.map||'-',matchId);
    });
  });
  if(mode==='mini'){
    if(!bld.teamA||!bld.teamB)return alert('íŒ€ì„ ì„ íƒí•˜ì„¸ìš”.');
    miniM.unshift({_id:matchId,d:date,a:bld.teamA,b:bld.teamB,sa:totalA,sb:totalB,sets:setsSnap});
  } else if(mode==='univm'){
    if(!bld.teamA||!bld.teamB)return alert('íŒ€ì„ ì„ íƒí•˜ì„¸ìš”.');
    univM.unshift({_id:matchId,d:date,a:bld.teamA,b:bld.teamB,sa:totalA,sb:totalB,sets:setsSnap});
  } else if(mode==='ck'){
    const mA=bld.membersA||[];const mB=bld.membersB||[];
    if(!mA.length||!mB.length)return alert('íŒ€ ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
    const univW={},univL={};
    bld.sets.forEach(set=>{
      set.games.forEach(g=>{
        if(!g.playerA||!g.playerB||!g.winner)return;
        const wName=g.winner==='A'?g.playerA:g.playerB;
        const lName=g.winner==='A'?g.playerB:g.playerA;
        const wM=(g.winner==='A'?mA:mB).find(m=>m.name===wName);
        const lM=(g.winner==='A'?mB:mA).find(m=>m.name===lName);
        if(wM){univW[wM.univ]=(univW[wM.univ]||0)+1;}
        if(lM){univL[lM.univ]=(univL[lM.univ]||0)+1;}
      });
    });
    ckM.unshift({_id:matchId,d:date,sa:totalA,sb:totalB,
      teamALabel:'AíŒ€',
      teamBLabel:'BíŒ€',
      teamAMembers:mA,teamBMembers:mB,sets:setsSnap,
      univWins:univW,univLosses:univL
    });
  } else if(mode==='pro'){
    const mA=bld.membersA||[];const mB=bld.membersB||[];
    if(!mA.length||!mB.length)return alert('íŒ€ ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
    const univW={},univL={};
    bld.sets.forEach(set=>{
      set.games.forEach(g=>{
        if(!g.playerA||!g.playerB||!g.winner)return;
        const wName=g.winner==='A'?g.playerA:g.playerB;
        const lName=g.winner==='A'?g.playerB:g.playerA;
        const wM=(g.winner==='A'?mA:mB).find(m=>m.name===wName);
        const lM=(g.winner==='A'?mB:mA).find(m=>m.name===lName);
        if(wM){univW[wM.univ]=(univW[wM.univ]||0)+1;}
        if(lM){univL[lM.univ]=(univL[lM.univ]||0)+1;}
      });
    });
    proM.unshift({_id:matchId,d:date,sa:totalA,sb:totalB,
      teamALabel:'AíŒ€',
      teamBLabel:'BíŒ€',
      teamAMembers:mA,teamBMembers:mB,sets:setsSnap,
      univWins:univW,univLosses:univL
    });
  } else if(mode==='comp'){
    const cn=bld.compName||document.getElementById('comp-name-input')?.value||curComp||'';
    if(!cn)return alert('ëŒ€íšŒëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
    if(!bld.teamA||!bld.teamB)return alert('ëŒ€í•™ì„ ì„ íƒí•˜ì„¸ìš”.');
    if(cn&&!compNames.includes(cn))compNames.push(cn);
    curComp=cn;
    comps.unshift({_id:matchId,d:date,n:cn,hostUniv:bld.teamA,u:bld.teamA,a:bld.teamA,b:bld.teamB,sa:totalA,sb:totalB,sets:setsSnap});
  } else if(mode==='tt'){
    const mA=bld.membersA||[];const mB=bld.membersB||[];
    if(!mA.length||!mB.length)return alert('íŒ€ ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
    const tLabel=bld.tiers&&bld.tiers.length?bld.tiers.join('+')+'í‹°ì–´':'ì „ì²´';
    ttM.unshift({_id:matchId,d:date,sa:totalA,sb:totalB,
      teamALabel:'AíŒ€',teamBLabel:'BíŒ€',tierLabel:tLabel,
      teamAMembers:mA,teamBMembers:mB,sets:setsSnap
    });
  }
  BLD[mode]=null;save();
  if(mode==='mini')miniSub='records';
  else if(mode==='univm')univmSub='records';
  else if(mode==='ck')ckSub='records';
  else if(mode==='pro')proSub='records';
  else if(mode==='comp')compSub='records';
  else if(mode==='tt'){_ttSub='records';compSub='tiertour';}
  render();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë¯¸ë‹ˆëŒ€ì „
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rMini(C,T){
  T.innerText='âš¡ ë¯¸ë‹ˆëŒ€ì „';
  if(!isLoggedIn && miniSub==='input') miniSub='records';
  const subOpts=[{id:'input',lbl:'ğŸ“ ê²½ê¸° ì…ë ¥',fn:`miniSub='input';render()`},{id:'rank',lbl:'ğŸ† ìˆœìœ„',fn:`miniSub='rank';render()`},{id:'records',lbl:'ğŸ“‹ ê¸°ë¡',fn:`miniSub='records';openDetails={};render()`}];
  let h=stabs(miniSub,subOpts);
  if(miniSub!=='input' && typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('mini');
  }
  if(miniSub==='input'&&isLoggedIn){if(!BLD['mini'])BLD['mini']={date:'',title:'',teamA:'',teamB:'',sets:[]};h+=`<div class="match-builder"><h3>âš¡ ë¯¸ë‹ˆëŒ€ì „ ì…ë ¥</h3>${setBuilderHTML(BLD['mini'],'mini')}</div>`;}
  else if(miniSub==='rank'){h+=miniRankHTML();}
  else{h+=recSummaryListHTML(miniM,'mini','tab');}
  C.innerHTML=h;
}

function miniRankHTML(){
  const sc={};
  getAllUnivs().forEach(u=>{sc[u.name]={w:0,l:0,pts:0,total:0};});
  miniM.forEach(m=>{
    if(!sc[m.a])sc[m.a]={w:0,l:0,pts:0,total:0};if(!sc[m.b])sc[m.b]={w:0,l:0,pts:0,total:0};
    sc[m.a].total++;sc[m.b].total++;
    if(m.sa>m.sb){sc[m.a].w++;sc[m.a].pts+=3;sc[m.b].l++;sc[m.b].pts-=3;}
    else if(m.sb>m.sa){sc[m.b].w++;sc[m.b].pts+=3;sc[m.a].l++;sc[m.a].pts-=3;}
  });
  const sorted=Object.entries(sc).filter(([,s])=>s.total>0).sort((a,b)=>b[1].pts-a[1].pts);
  let h=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--blue);margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--blue-ll)">ğŸ† ë¯¸ë‹ˆëŒ€ì „ ëŒ€í•™ë³„ ìˆœìœ„</div>
  <table><thead><tr><th>ìˆœìœ„</th><th>ëŒ€í•™</th><th>ìŠ¹</th><th>íŒ¨</th><th>í¬ì¸íŠ¸</th></tr></thead><tbody>`;
  if(!sorted.length)h+=`<tr><td colspan="5" style="padding:30px;color:var(--gray-l)">ê¸°ë¡ ì—†ìŒ</td></tr>`;
  sorted.forEach(([name,s],i)=>{
    const col=gc(name);let rnkHTML;
    if(i===0) rnkHTML=`<span class="rk1">1ë“±</span>`;else if(i===1) rnkHTML=`<span class="rk2">2ë“±</span>`;else if(i===2) rnkHTML=`<span class="rk3">3ë“±</span>`;else rnkHTML=`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px">${i+1}ìœ„</span>`;
    h+=`<tr><td>${rnkHTML}</td><td><span class="ubadge clickable-univ" style="background:${col}" onclick="openUnivModal('${name}')">${name}</span></td><td class="wt" style="font-size:15px;font-weight:800">${s.w}</td><td class="lt" style="font-size:15px;font-weight:800">${s.l}</td><td class="${pC(s.pts)}" style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px">${pS(s.pts)}</td></tr>`;
  });
  return h+`</tbody></table>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëŒ€í•™CK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rCK(C,T){
  T.innerText='ğŸ¤ ëŒ€í•™CK';
  if(!isLoggedIn && ckSub==='input') ckSub='records';
  const subOpts=[{id:'input',lbl:'ğŸ“ ê²½ê¸° ì…ë ¥',fn:`ckSub='input';render()`},{id:'rank',lbl:'ğŸ† ëŒ€í•™ ìˆœìœ„',fn:`ckSub='rank';render()`},{id:'records',lbl:'ğŸ“‹ ê¸°ë¡',fn:`ckSub='records';openDetails={};render()`}];
  let h=stabs(ckSub,subOpts);
  if(ckSub!=='input' && typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('ck');
  }
  if(ckSub==='input'&&isLoggedIn){if(!BLD['ck'])BLD['ck']={date:'',membersA:[],membersB:[],sets:[]};h+=buildCKInputHTML();}
  else if(ckSub==='rank'){h+=ckRankHTML();}
  else{h+=recSummaryListHTML(ckM,'ck','tab');}
  C.innerHTML=h;
}

function buildCKInputHTML(){
  const bld=BLD['ck'];const allU=getAllUnivs();
  const uO=`<option value="">ëŒ€í•™ ì„ íƒ</option>`+allU.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
  const mA=bld.membersA||[];const mB=bld.membersB||[];
  let h=`<div class="match-builder"><h3>ğŸ¤ ëŒ€í•™CK ì…ë ¥</h3>
    <div style="margin-bottom:14px;display:flex;align-items:center;gap:10px">
      <label style="font-size:12px;font-weight:700;color:var(--blue)">ë‚ ì§œ</label>
      <input type="date" value="${bld.date||''}" onchange="BLD['ck'].date=this.value">
    </div>

    <!-- ì„ ìˆ˜ ê²€ìƒ‰ìœ¼ë¡œ ë¹ ë¥¸ íŒ€ ì§œê¸° -->
    <div style="background:var(--blue-l);border:1px solid var(--blue-ll);border-radius:10px;padding:12px 14px;margin-bottom:16px">
      <div style="font-size:12px;font-weight:700;color:var(--blue);margin-bottom:8px">ğŸ” ì„ ìˆ˜ ê²€ìƒ‰ìœ¼ë¡œ ë¹ ë¥¸ íŒ€ ì§œê¸° <span style="font-weight:400;color:var(--gray-l)">(ì´ë¦„Â·ëŒ€í•™ ê²€ìƒ‰ í›„ AíŒ€/BíŒ€ ë°°ì •)</span></div>
      <div style="position:relative;display:flex;gap:6px;align-items:center">
        <input type="text" id="ck-search-input" placeholder="ì„ ìˆ˜ ì´ë¦„ ë˜ëŠ” ëŒ€í•™ ê²€ìƒ‰..." 
          style="flex:1;padding:8px 12px;border:1.5px solid var(--blue);border-radius:8px;font-size:13px"
          oninput="ckSearchPlayer()">
      </div>
      <div id="ck-search-results" style="display:none;margin-top:6px;background:#fff;border:1px solid var(--border2);border-radius:8px;max-height:180px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,.1)"></div>
    </div>

    <div style="display:flex;gap:14px;flex-wrap:wrap;margin-bottom:16px">
      <div class="ck-panel">
        <h4>ğŸ”µ íŒ€ A êµ¬ì„± (${mA.length}ëª…)</h4>
        <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
          <select id="ck-a-univ" style="flex:1" onchange="ckFilterPlayers('A')">${uO}</select>
          <select id="ck-a-player" style="flex:1"><option value="">ëŒ€í•™ ë¨¼ì € ì„ íƒ</option></select>
          <button class="btn btn-b btn-xs" onclick="ckAddMember('A')">+ ì¶”ê°€</button>
        </div>
        <div>${mA.map((m,i)=>`<span class="mem-tag" style="background:${gc(m.univ)}">${m.name}<span style="font-size:10px;opacity:.8">(${m.univ}${m.tier?'/'+m.tier:''}${m.race?'/'+m.race:''})</span><button onclick="BLD['ck'].membersA.splice(${i},1);BLD['ck'].sets=[];render()">Ã—</button></span>`).join('')||'<span style="color:var(--gray-l);font-size:12px">ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”</span>'}</div>
      </div>
      <div class="ck-panel">
        <h4>ğŸ”´ íŒ€ B êµ¬ì„± (${mB.length}ëª…)</h4>
        <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
          <select id="ck-b-univ" style="flex:1" onchange="ckFilterPlayers('B')">${uO}</select>
          <select id="ck-b-player" style="flex:1"><option value="">ëŒ€í•™ ë¨¼ì € ì„ íƒ</option></select>
          <button class="btn btn-b btn-xs" onclick="ckAddMember('B')">+ ì¶”ê°€</button>
        </div>
        <div>${mB.map((m,i)=>`<span class="mem-tag" style="background:${gc(m.univ)}">${m.name}<span style="font-size:10px;opacity:.8">(${m.univ}${m.tier?'/'+m.tier:''}${m.race?'/'+m.race:''})</span><button onclick="BLD['ck'].membersB.splice(${i},1);BLD['ck'].sets=[];render()">Ã—</button></span>`).join('')||'<span style="color:var(--gray-l);font-size:12px">ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”</span>'}</div>
      </div>
    </div>`;
  h+=setBuilderHTML(bld,'ck');h+=`</div>`;return h;
}

function ckSearchPlayer(){
  const inp=document.getElementById('ck-search-input');
  const res=document.getElementById('ck-search-results');
  if(!inp||!res)return;
  const q=inp.value.trim().toLowerCase();
  if(!q){res.style.display='none';res.innerHTML='';return;}
  const bld=BLD['ck']||{};
  const already=[...(bld.membersA||[]),...(bld.membersB||[])].map(m=>m.name);
  const results=players.filter(p=>
    (p.name.toLowerCase().includes(q)||(p.univ||'').toLowerCase().includes(q)||(p.tier||'').toLowerCase().includes(q)||(p.race||'').toLowerCase().includes(q))
  ).slice(0,20);
  if(!results.length){res.innerHTML='<div style="padding:10px 12px;color:var(--gray-l);font-size:12px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';res.style.display='block';return;}
  res.innerHTML=results.map(p=>{
    const col=gc(p.univ);
    const inA=(bld.membersA||[]).some(m=>m.name===p.name);
    const inB=(bld.membersB||[]).some(m=>m.name===p.name);
    const inTeam=inA||inB;
    return `<div style="padding:8px 12px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);${inTeam?'opacity:.5;':''}">
      <span style="width:28px;height:28px;border-radius:6px;background:${col};color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0">${p.race||'?'}</span>
      <div style="flex:1;font-size:12px">
        <span style="font-weight:700">${p.name}</span>
        <span style="color:var(--gray-l);font-size:11px;margin-left:4px">${p.univ} Â· ${p.tier||'-'} Â· ${p.race||'-'}</span>
        ${inA?'<span style="background:#dbeafe;color:#1d4ed8;border-radius:3px;padding:1px 5px;font-size:10px;font-weight:700;margin-left:4px">AíŒ€</span>':''}
        ${inB?'<span style="background:#fee2e2;color:#dc2626;border-radius:3px;padding:1px 5px;font-size:10px;font-weight:700;margin-left:4px">BíŒ€</span>':''}
      </div>
      ${!inTeam?`
      <button onclick="ckAddBySearch('A','${p.name}')" style="background:#2563eb;color:#fff;border:none;border-radius:5px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer">AíŒ€</button>
      <button onclick="ckAddBySearch('B','${p.name}')" style="background:#dc2626;color:#fff;border:none;border-radius:5px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer">BíŒ€</button>
      `:'<span style="font-size:11px;color:var(--gray-l)">ë°°ì •ë¨</span>'}
    </div>`;
  }).join('');
  res.style.display='block';
}

function ckAddBySearch(team, name){
  if(!BLD['ck'])return;
  const arr=team==='A'?BLD['ck'].membersA:BLD['ck'].membersB;
  const other=team==='A'?BLD['ck'].membersB:BLD['ck'].membersA;
  if(arr.find(m=>m.name===name)||other.find(m=>m.name===name))return;
  const pObj=players.find(p=>p.name===name)||{};
  arr.push({name,univ:pObj.univ||'',race:pObj.race||'',tier:pObj.tier||''});
  BLD['ck'].sets=[];
  // ê²€ìƒ‰ ê²°ê³¼ ìƒˆë¡œê³ ì¹¨
  ckSearchPlayer();
  render();
}


function ckFilterPlayers(team){
  const univSel=document.getElementById(`ck-${team.toLowerCase()}-univ`);
  playerSel.innerHTML=univMembers.length?`<option value="">ë©¤ë²„ ì„ íƒ</option>`+univMembers.map(p=>`<option value="${p.name}">${p.name} [${p.tier}/${p.race}]</option>`).join(''):`<option value="">ë©¤ë²„ ì—†ìŒ</option>`;
}

function ckAddMember(team){
  const univSel=document.getElementById(`ck-${team.toLowerCase()}-univ`);
  const playerSel=document.getElementById(`ck-${team.toLowerCase()}-player`);
  if(!univSel||!playerSel)return;
  const univ=univSel.value;const name=playerSel.value;
  if(!name)return alert('ë©¤ë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  const arr=team==='A'?BLD['ck'].membersA:BLD['ck'].membersB;
  if(arr.find(m=>m.name===name))return alert('ì´ë¯¸ ì¶”ê°€ë¨');
  const pObj=players.find(p=>p.name===name)||{};
  arr.push({name,univ,race:pObj.race||'',tier:pObj.tier||''});BLD['ck'].sets=[];render();
}

function ckRankHTML(){
  const uS={};
  getAllUnivs().forEach(u=>{uS[u.name]={w:0,l:0,pts:0,total:0};});
  ckM.forEach(m=>{
    if(m.univWins)Object.entries(m.univWins).forEach(([u,c])=>{if(!uS[u])uS[u]={w:0,l:0,pts:0,total:0};uS[u].w+=c;uS[u].pts+=c*3;uS[u].total+=c;});
    if(m.univLosses)Object.entries(m.univLosses).forEach(([u,c])=>{if(!uS[u])uS[u]={w:0,l:0,pts:0,total:0};uS[u].l+=c;uS[u].pts-=c*3;uS[u].total+=c;});
  });
  const sorted=Object.entries(uS).filter(([,s])=>s.total>0).sort((a,b)=>b[1].pts-a[1].pts);
  let h=`<div style="font-size:11px;color:var(--gray-l);margin-bottom:10px">â€» ëŒ€í•™ ìˆœìœ„ë§Œ í‘œì‹œ (ì†Œì† ë©¤ë²„ ê°œë³„ í‘œì‹œ ì—†ìŒ)</div>
  <table><thead><tr><th>ìˆœìœ„</th><th>ëŒ€í•™</th><th>ê²Œì„ ìŠ¹</th><th>ê²Œì„ íŒ¨</th><th>í¬ì¸íŠ¸</th></tr></thead><tbody>`;
  if(!sorted.length)h+=`<tr><td colspan="5" style="padding:30px;color:var(--gray-l)">ê¸°ë¡ ì—†ìŒ</td></tr>`;
  sorted.forEach(([name,s],i)=>{
    const col=gc(name);let rnkHTML;
    if(i===0) rnkHTML=`<span class="rk1">1ë“±</span>`;else if(i===1) rnkHTML=`<span class="rk2">2ë“±</span>`;else if(i===2) rnkHTML=`<span class="rk3">3ë“±</span>`;else rnkHTML=`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px">${i+1}ìœ„</span>`;
    h+=`<tr><td>${rnkHTML}</td><td><span class="ubadge clickable-univ" style="background:${col}" onclick="openUnivModal('${name}')">${name}</span></td><td class="wt" style="font-size:15px;font-weight:800">${s.w}</td><td class="lt" style="font-size:15px;font-weight:800">${s.l}</td><td class="${pC(s.pts)}" style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px">${pS(s.pts)}</td></tr>`;
  });
  return h+`</tbody></table>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëŒ€í•™ëŒ€ì „
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rUnivM(C,T){
  T.innerText='ğŸŸï¸ ëŒ€í•™ëŒ€ì „';
  if(!isLoggedIn && univmSub==='input') univmSub='records';
  const subOpts=[{id:'input',lbl:'ğŸ“ ê²½ê¸° ì…ë ¥',fn:`univmSub='input';render()`},{id:'rank',lbl:'ğŸ† ìˆœìœ„',fn:`univmSub='rank';render()`},{id:'records',lbl:'ğŸ“‹ ê¸°ë¡',fn:`univmSub='records';openDetails={};render()`}];
  let h=stabs(univmSub,subOpts);
  if(univmSub!=='input' && typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('univm');
  }
  if(univmSub==='input'&&isLoggedIn){if(!BLD['univm'])BLD['univm']={date:'',note:'',teamA:'',teamB:'',sets:[]};h+=`<div class="match-builder"><h3>ğŸŸï¸ ëŒ€í•™ëŒ€ì „ ì…ë ¥</h3>${setBuilderHTML(BLD['univm'],'univm')}</div>`;}
  else if(univmSub==='rank'){h+=univMRankHTML();}
  else{h+=recSummaryListHTML(univM,'univm','tab');}
  C.innerHTML=h;
}

function univMRankHTML(){
  const sc={};
  getAllUnivs().forEach(u=>{sc[u.name]={w:0,l:0,pts:0,total:0};});
  univM.forEach(m=>{
    if(!sc[m.a])sc[m.a]={w:0,l:0,pts:0,total:0};if(!sc[m.b])sc[m.b]={w:0,l:0,pts:0,total:0};
    sc[m.a].total++;sc[m.b].total++;
    if(m.sa>m.sb){sc[m.a].w++;sc[m.a].pts+=3;sc[m.b].l++;sc[m.b].pts-=3;}
    else if(m.sb>m.sa){sc[m.b].w++;sc[m.b].pts+=3;sc[m.a].l++;sc[m.a].pts-=3;}
  });
  const sorted=Object.entries(sc).filter(([,s])=>s.total>0).sort((a,b)=>b[1].pts-a[1].pts);
  let h=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--blue);margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--blue-ll)">ğŸ† ëŒ€í•™ëŒ€ì „ ëŒ€í•™ë³„ ìˆœìœ„</div>
  <table><thead><tr><th>ìˆœìœ„</th><th>ëŒ€í•™</th><th>ìŠ¹</th><th>íŒ¨</th><th>í¬ì¸íŠ¸</th></tr></thead><tbody>`;
  if(!sorted.length)h+=`<tr><td colspan="5" style="padding:30px;color:var(--gray-l)">ê¸°ë¡ ì—†ìŒ</td></tr>`;
  sorted.forEach(([name,s],i)=>{
    const col=gc(name);let rnkHTML;
    if(i===0) rnkHTML=`<span class="rk1">1ë“±</span>`;else if(i===1) rnkHTML=`<span class="rk2">2ë“±</span>`;else if(i===2) rnkHTML=`<span class="rk3">3ë“±</span>`;else rnkHTML=`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px">${i+1}ìœ„</span>`;
    h+=`<tr><td>${rnkHTML}</td><td><span class="ubadge clickable-univ" style="background:${col}" onclick="openUnivModal('${name}')">${name}</span></td><td class="wt" style="font-size:15px;font-weight:800">${s.w}</td><td class="lt" style="font-size:15px;font-weight:800">${s.l}</td><td class="${pC(s.pts)}" style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px">${pS(s.pts)}</td></tr>`;
  });
  return h+`</tbody></table>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í”„ë¡œë¦¬ê·¸ (ëŒ€í•™CK ë°©ì‹)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let proSub='records';

function rPro(C,T){
  T.innerText='ğŸ… í”„ë¡œë¦¬ê·¸';
  if(!isLoggedIn && proSub==='input') proSub='records';
  const subOpts=[
    {id:'input',lbl:'ğŸ“ ê²½ê¸° ì…ë ¥',fn:`proSub='input';render()`},
    {id:'rank',lbl:'ğŸ† ìˆœìœ„',fn:`proSub='rank';render()`},
    {id:'records',lbl:'ğŸ“‹ ê¸°ë¡',fn:`proSub='records';openDetails={};render()`}
  ];
  let h=stabs(proSub,subOpts);
  if(proSub!=='input' && typeof buildYearMonthFilter==='function'){
    h+=buildYearMonthFilter('pro');
  }
  if(proSub==='input'&&isLoggedIn){
    if(!BLD['pro'])BLD['pro']={date:'',membersA:[],membersB:[],sets:[]};
    h+=buildProInputHTML();
  } else if(proSub==='rank'){
    h+=proRankHTML();
  } else {
    h+=recSummaryListHTML(proM,'pro','tab');
  }
  C.innerHTML=h;
}

function buildProInputHTML(){
  const bld=BLD['pro'];const allU=getAllUnivs();
  const uO=`<option value="">ëŒ€í•™ ì„ íƒ</option>`+allU.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
  const mA=bld.membersA||[];const mB=bld.membersB||[];
  // í‹°ì–´ ë‹¤ì¤‘ ì„ íƒ ìƒíƒœ
  if(!bld.tierFilters)bld.tierFilters=[];
  const tf=bld.tierFilters;
  let h=`<div class="match-builder"><h3>ğŸ… í”„ë¡œë¦¬ê·¸ ì…ë ¥</h3>
    <div style="margin-bottom:14px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <label style="font-size:12px;font-weight:700;color:var(--blue)">ë‚ ì§œ</label>
      <input type="date" value="${bld.date||''}" onchange="BLD['pro'].date=this.value">
    </div>

    <div style="display:flex;gap:14px;flex-wrap:wrap;margin-bottom:16px">
      <div class="ck-panel">
        <h4>ğŸ”µ íŒ€ A êµ¬ì„±</h4>
        <div style="display:flex;gap:6px;margin-bottom:6px;flex-wrap:wrap">
          <input type="text" id="pro-a-search" placeholder="ğŸ” ì„ ìˆ˜ ì´ë¦„Â·ë©”ëª¨ ê²€ìƒ‰..." style="flex:1;min-width:140px;padding:6px 10px;border:1px solid var(--border2);border-radius:6px" oninput="proSearchPlayer('A')">
        </div>
        <div id="pro-a-drop" style="display:none;max-height:160px;overflow-y:auto;border:1px solid var(--border2);border-radius:6px;background:#fff;margin-bottom:6px"></div>
        <div>${mA.map((m,i)=>`<span class="mem-tag" style="background:${gc(m.univ)}">${m.name}<span style="font-size:10px;opacity:.8">(${m.univ}${m.tier?'/'+m.tier:''}${m.race?'/'+m.race:''})</span><button onclick="BLD['pro'].membersA.splice(${i},1);BLD['pro'].sets=[];render()">Ã—</button></span>`).join('')||'<span style="color:var(--gray-l);font-size:12px">ì„ ìˆ˜ë¥¼ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”</span>'}</div>
      </div>
      <div class="ck-panel">
        <h4>ğŸ”´ íŒ€ B êµ¬ì„±</h4>
        <div style="display:flex;gap:6px;margin-bottom:6px;flex-wrap:wrap">
          <input type="text" id="pro-b-search" placeholder="ğŸ” ì„ ìˆ˜ ì´ë¦„Â·ë©”ëª¨ ê²€ìƒ‰..." style="flex:1;min-width:140px;padding:6px 10px;border:1px solid var(--border2);border-radius:6px" oninput="proSearchPlayer('B')">
        </div>
        <div id="pro-b-drop" style="display:none;max-height:160px;overflow-y:auto;border:1px solid var(--border2);border-radius:6px;background:#fff;margin-bottom:6px"></div>
        <div>${mB.map((m,i)=>`<span class="mem-tag" style="background:${gc(m.univ)}">${m.name}<span style="font-size:10px;opacity:.8">(${m.univ}${m.tier?'/'+m.tier:''}${m.race?'/'+m.race:''})</span><button onclick="BLD['pro'].membersB.splice(${i},1);BLD['pro'].sets=[];render()">Ã—</button></span>`).join('')||'<span style="color:var(--gray-l);font-size:12px">ì„ ìˆ˜ë¥¼ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”</span>'}</div>
      </div>
    </div>`;
  h+=setBuilderHTML(bld,'pro');h+=`</div>`;return h;
}

function proSearchPlayer(team){
  const searchEl=document.getElementById(`pro-${team.toLowerCase()}-search`);
  const dropEl=document.getElementById(`pro-${team.toLowerCase()}-drop`);
  if(!searchEl||!dropEl)return;
  const q=searchEl.value.trim().toLowerCase();
  if(!q){dropEl.style.display='none';dropEl.innerHTML='';return;}
  const bld=BLD['pro']||{};
  const already=[...(bld.membersA||[]),...(bld.membersB||[])].map(m=>m.name);
  const results=players.filter(p=>
    p.gender==='M' &&
    !already.includes(p.name) &&
    (p.name.toLowerCase().includes(q)||(p.memo||'').toLowerCase().includes(q)||(p.univ||'').toLowerCase().includes(q)||(p.tier||'').toLowerCase().includes(q))
  ).slice(0,20);
  if(!results.length){
    dropEl.innerHTML='<div style="padding:10px;color:var(--gray-l);font-size:12px;text-align:center">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
    dropEl.style.display='block';return;
  }
  dropEl.innerHTML=results.map(p=>`<div onclick="proAddPlayerDirect('${team}','${p.name}')"
    style="padding:8px 12px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;font-size:12px"
    onmouseover="this.style.background='#f0f6ff'" onmouseout="this.style.background=''">
    <span style="display:inline-block;width:28px;height:28px;border-radius:6px;background:${gc(p.univ)};color:#fff;text-align:center;line-height:28px;font-size:11px;font-weight:700;flex-shrink:0">${(p.race||'?').charAt(0)}</span>
    <div>
      <div style="font-weight:700">${p.name} <span style="font-size:10px;background:${gc(p.univ)};color:#fff;padding:1px 5px;border-radius:3px">${p.univ}</span></div>
      <div style="font-size:10px;color:var(--gray-l)">${p.tier||'-'} Â· ${p.race||'-'}${p.memo?` Â· ${p.memo.slice(0,20)}`:''}</div>
    </div>
  </div>`).join('');
  dropEl.style.display='block';
}

function proAddPlayerDirect(team, name){
  const bld=BLD['pro'];if(!bld)return;
  const arr=team==='A'?bld.membersA:bld.membersB;
  if(arr.find(m=>m.name===name))return;
  const pObj=players.find(p=>p.name===name)||{};
  arr.push({name,univ:pObj.univ||'',race:pObj.race||'',tier:pObj.tier||''});
  bld.sets=[];
  const searchEl=document.getElementById(`pro-${team.toLowerCase()}-search`);
  const dropEl=document.getElementById(`pro-${team.toLowerCase()}-drop`);
  if(searchEl)searchEl.value='';
  if(dropEl){dropEl.style.display='none';dropEl.innerHTML='';}
  render();
}

function proToggleTier(t){
  const bld=BLD['pro'];if(!bld)return;
  if(!bld.tierFilters)bld.tierFilters=[];
  const idx=bld.tierFilters.indexOf(t);
  if(idx>=0)bld.tierFilters.splice(idx,1);else bld.tierFilters.push(t);
  bld.sets=[];render();
}

function proFilterPlayers(team){
  const univSel=document.getElementById(`pro-${team.toLowerCase()}-univ`);
  const playerSel=document.getElementById(`pro-${team.toLowerCase()}-player`);
  if(!univSel||!playerSel)return;
  const univ=univSel.value;
  const bld=BLD['pro']||{};const tf=(bld.tierFilters||[]);
  // í‹°ì–´ í•„í„° ì ìš© (ë‹¤ì¤‘ì„ íƒ: ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´)
  const mems=univ?players.filter(p=>p.univ===univ&&p.gender==='M'&&(tf.length===0||tf.includes(p.tier))):[];
  playerSel.innerHTML=mems.length?`<option value="">ë©¤ë²„ ì„ íƒ</option>`+mems.map(p=>`<option value="${p.name}">${p.name} [${p.tier||'-'}/${p.race||'-'}]</option>`).join(''):`<option value="">ë©¤ë²„ ì—†ìŒ</option>`;
}

function proAddMember(team){
  const univSel=document.getElementById(`pro-${team.toLowerCase()}-univ`);
  const playerSel=document.getElementById(`pro-${team.toLowerCase()}-player`);
  if(!univSel||!playerSel)return;
  const univ=univSel.value;const name=playerSel.value;
  if(!name)return alert('ë©¤ë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  const arr=team==='A'?BLD['pro'].membersA:BLD['pro'].membersB;
  if(arr.find(m=>m.name===name))return alert('ì´ë¯¸ ì¶”ê°€ë¨');
  const pObj=players.find(p=>p.name===name)||{};
  arr.push({name,univ,race:pObj.race||'',tier:pObj.tier||''});BLD['pro'].sets=[];render();
}

function proRankHTML(){
  const uS={};
  getAllUnivs().forEach(u=>{uS[u.name]={w:0,l:0,pts:0,total:0};});
  proM.forEach(m=>{
    if(m.univWins)Object.entries(m.univWins).forEach(([u,c])=>{if(!uS[u])uS[u]={w:0,l:0,pts:0,total:0};uS[u].w+=c;uS[u].pts+=c*3;uS[u].total+=c;});
    if(m.univLosses)Object.entries(m.univLosses).forEach(([u,c])=>{if(!uS[u])uS[u]={w:0,l:0,pts:0,total:0};uS[u].l+=c;uS[u].pts-=c*3;uS[u].total+=c;});
  });
  const sorted=Object.entries(uS).filter(([,s])=>s.total>0).sort((a,b)=>b[1].pts-a[1].pts);
  let h=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--blue);margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--blue-ll)">ğŸ… í”„ë¡œë¦¬ê·¸ ëŒ€í•™ë³„ ìˆœìœ„</div>
  <table><thead><tr><th>ìˆœìœ„</th><th>ëŒ€í•™</th><th>ê²Œì„ ìŠ¹</th><th>ê²Œì„ íŒ¨</th><th>í¬ì¸íŠ¸</th></tr></thead><tbody>`;
  if(!sorted.length)h+=`<tr><td colspan="5" style="padding:30px;color:var(--gray-l)">ê¸°ë¡ ì—†ìŒ</td></tr>`;
  sorted.forEach(([name,s],i)=>{
    const col=gc(name);let rnkHTML;
    if(i===0)rnkHTML=`<span class="rk1">1ë“±</span>`;else if(i===1)rnkHTML=`<span class="rk2">2ë“±</span>`;else if(i===2)rnkHTML=`<span class="rk3">3ë“±</span>`;else rnkHTML=`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px">${i+1}ìœ„</span>`;
    h+=`<tr><td>${rnkHTML}</td><td><span class="ubadge clickable-univ" style="background:${col}" onclick="openUnivModal('${name}')">${name}</span></td><td class="wt" style="font-size:15px;font-weight:800">${s.w}</td><td class="lt" style="font-size:15px;font-weight:800">${s.l}</td><td class="${pC(s.pts)}" style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px">${pS(s.pts)}</td></tr>`;
  });
  return h+`</tbody></table>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëŒ€íšŒ (ì¡°ë³„ë¦¬ê·¸ + ì¡°í¸ì„± ê´€ë¦¬ + ëŒ€ì§„í‘œ + ê°œì¸ìˆœìœ„)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let leagueFilterDate='';
let leagueFilterGrp='';
let grpRankFilter='';
let grpSub='list';
let grpEditId=null;
let grpMatchState={tnId:null,gi:null,mi:null};

function getCurrentTourney(){
  return tourneys.find(t=>t.name===curComp)||tourneys[0]||null;
}

function rComp(C,T){
  T.innerText='ğŸ–ï¸ ëŒ€íšŒ';
  if(!isLoggedIn && compSub==='grpedit') compSub='league';

  const tn=getCurrentTourney();

  let h=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap;padding:12px 16px;background:var(--gold-bg);border:1px solid var(--gold-b);border-radius:10px">
    <span style="font-weight:700;color:var(--gold);white-space:nowrap">ğŸ–ï¸ ëŒ€íšŒ ì„ íƒ:</span>
    <select style="flex:1;max-width:220px;font-weight:700" onchange="curComp=this.value;leagueFilterDate='';leagueFilterGrp='';grpRankFilter='';save();render()">
      <option value="">â€” ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš” â€”</option>
      ${tourneys.map(t=>`<option value="${t.name}"${curComp===t.name?' selected':''}>${t.name}</option>`).join('')}
    </select>
    ${isLoggedIn?`<button class="btn btn-b btn-xs" onclick="grpNewTourney()">+ ìƒˆ ëŒ€íšŒ</button>`:''}
    ${tn?`<span style="font-size:11px;color:var(--gray-l)">${tn.groups.length}ê°œ ì¡° Â· ${tn.groups.reduce((s,g)=>s+(g.matches||[]).length,0)}ê²½ê¸° ë“±ë¡</span>`:''}
  </div>`;

  const subOpts=[
    {id:'league',lbl:'ğŸ“… ì¡°ë³„ë¦¬ê·¸ ì¼ì •'},
    {id:'grprank',lbl:'ğŸ“Š ì¡°ë³„ ìˆœìœ„'},
    {id:'tour',lbl:'âš”ï¸ ëŒ€ì§„í‘œ'},
    {id:'comprank',lbl:'ğŸ… ê°œì¸ ìˆœìœ„'},
    ...(isLoggedIn?[{id:'grpedit',lbl:'ğŸ—ï¸ ì¡°í¸ì„± ê´€ë¦¬'},{id:'tiertour',lbl:'ğŸ¯ í‹°ì–´ëŒ€íšŒ'}]:[{id:'tiertour',lbl:'ğŸ¯ í‹°ì–´ëŒ€íšŒ'}]),
  ];
  h+=`<div class="stabs no-export">${subOpts.map(o=>`<button class="stab ${compSub===o.id?'on':''}" onclick="compSub='${o.id}';render()">${o.lbl}</button>`).join('')}</div>`;

  if(!tn && compSub!=='grpedit'){
    h+=`<div style="padding:60px 20px;text-align:center;background:var(--surface);border-radius:12px;border:2px dashed var(--border2)">
      <div style="font-size:44px;margin-bottom:14px">ğŸ†</div>
      <div style="font-size:16px;font-weight:700;margin-bottom:8px">ë“±ë¡ëœ ëŒ€íšŒê°€ ì—†ìŠµë‹ˆë‹¤</div>
      <div style="color:var(--gray-l);margin-bottom:20px">ìƒˆ ëŒ€íšŒë¥¼ ë§Œë“¤ì–´ ì¡°í¸ì„±ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
      ${isLoggedIn?`<button class="btn btn-b" onclick="grpNewTourney()">+ ìƒˆ ëŒ€íšŒ ë§Œë“¤ê¸°</button>`:''}
    </div>`;
    C.innerHTML=h; return;
  }

  if(compSub==='league') h+=rCompLeague(tn);
  else if(compSub==='grprank') h+=rCompGrpRankFull(tn);
  else if(compSub==='tour') h+=rCompTour();
  else if(compSub==='comprank') h+=rCompPlayerRank(tn);
  else if(compSub==='grpedit') h+=rCompGrpEdit();
  else if(compSub==='tiertour') h+=rTierTour();
  C.innerHTML=h;
}

function rCompLeague(tn){
  if(!tn) return `<div style="padding:30px;text-align:center;color:var(--gray-l)">ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>`;
  const allMatches=[];
  tn.groups.forEach((grp,gi)=>{
    const gl='ABCDEFGHIJ'[gi]||gi;
    const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
    (grp.matches||[]).forEach((m,mi)=>{
      allMatches.push({...m,grpName:grp.name,grpIdx:gi,grpLetter:gl,matchNum:mi+1,grpColor:col});
    });
  });
  allMatches.sort((a,b)=>(a.d||'9999').localeCompare(b.d||'9999'));
  const dates=[...new Set(allMatches.map(m=>m.d).filter(Boolean))].sort();
  let h=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--blue);margin-bottom:12px">ğŸ† ${tn.name}</div>`;
  h+=`<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px;padding-bottom:10px;border-bottom:2px solid var(--border)">
    <button class="pill ${!leagueFilterDate?'on':''}" onclick="leagueFilterDate='';render()">ì „ì²´</button>`;
  dates.forEach(d=>{
    const dt=new Date(d+'T00:00:00');const days=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    h+=`<button class="pill ${leagueFilterDate===d?'on':''}" onclick="leagueFilterDate='${d}';render()">${dt.getMonth()+1}/${dt.getDate()}(${days[dt.getDay()]})</button>`;
  });
  h+=`</div>`;
  if(tn.groups.length>1){
    h+=`<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px;align-items:center"><span style="font-size:11px;font-weight:700;color:var(--gray-l)">ì¡°:</span>
      <button class="pill ${!leagueFilterGrp?'on':''}" onclick="leagueFilterGrp='';render()">ì „ì²´</button>`;
    tn.groups.forEach((grp,gi)=>{
      const gl='ABCDEFGHIJ'[gi];const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
      h+=`<button class="pill ${leagueFilterGrp===grp.name?'on':''}" style="${leagueFilterGrp===grp.name?`background:${col};border-color:${col};color:#fff`:''}" onclick="leagueFilterGrp='${grp.name}';render()">GROUP ${gl}</button>`;
    });
    h+=`</div>`;
  }
  let filtered=allMatches;
  if(leagueFilterDate) filtered=filtered.filter(m=>m.d===leagueFilterDate);
  if(leagueFilterGrp) filtered=filtered.filter(m=>m.grpName===leagueFilterGrp);
  if(!filtered.length){
    h+=`<div style="padding:40px;text-align:center;color:var(--gray-l);background:var(--surface);border-radius:10px">
      ${allMatches.length?'í•´ë‹¹ ì¡°ê±´ì˜ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.':'ì•„ì§ ë“±ë¡ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.'}
      ${isLoggedIn?`<br><br><button class="btn btn-b btn-sm" onclick="compSub='grpedit';render()">+ ì¡°í¸ì„± ê´€ë¦¬ì—ì„œ ê²½ê¸° ì¶”ê°€</button>`:''}
    </div>`;
    return h;
  }
  const byDate={};
  filtered.forEach(m=>{const k=m.d||'ë‚ ì§œ ë¯¸ì •';if(!byDate[k])byDate[k]=[];byDate[k].push(m);});
  Object.keys(byDate).sort().forEach(date=>{
    let dateLabel=date;
    if(date!=='ë‚ ì§œ ë¯¸ì •'){
      const dt=new Date(date+'T00:00:00');
      const days=['ì¼ìš”ì¼','ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼','í† ìš”ì¼'];
      dateLabel=`${dt.getFullYear()}ë…„ ${dt.getMonth()+1}ì›” ${dt.getDate()}ì¼ ${days[dt.getDay()]}`;
    }
    h+=`<div style="margin-bottom:22px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <div style="flex:1;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px;color:#1e3a8a;padding:8px 16px;background:linear-gradient(90deg,#1e3a8a10,transparent);border-left:4px solid #2563eb;border-radius:0 8px 8px 0">ğŸ“… ${dateLabel}</div>
        ${isLoggedIn?`<button class="btn btn-b btn-xs no-export" onclick="grpAddMatchByDate('${tn.id}','${date}')">+ ê²½ê¸° ì¶”ê°€</button>`:''}
      </div>`;
    byDate[date].forEach(m=>{
      const ca=gc(m.a||'');const cb=gc(m.b||'');
      const isDone=m.sa!=null&&m.sb!=null;
      const aWin=isDone&&m.sa>m.sb;const bWin=isDone&&m.sb>m.sa;
      const detId=`ld-${m.grpIdx}-${m.matchNum-1}`;
      const hasDetail=isDone&&m.sets&&m.sets.some(s=>(s.games||[]).some(g=>g.playerA||g.playerB));
      h+=`<div class="grp-match-card">
        <div style="display:flex;flex-direction:column;align-items:center;gap:3px;min-width:68px">
          <span class="grp-badge" style="background:${m.grpColor};font-size:11px">GROUP ${m.grpLetter}</span>
          <span style="font-size:10px;color:var(--gray-l);font-weight:600">${m.matchNum}ê²½ê¸°</span>
          ${isDone?`<span style="background:#dcfce7;color:#16a34a;font-size:10px;font-weight:700;padding:1px 7px;border-radius:8px">ì™„ë£Œ</span>`:`<span style="background:#f1f5f9;color:var(--gray-l);font-size:10px;padding:1px 7px;border-radius:8px">ì˜ˆì •</span>`}
        </div>
        <div style="flex:1;display:flex;align-items:center;gap:8px;justify-content:center;flex-wrap:wrap">
          <div style="text-align:center;min-width:80px">
            <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:#fff;background:${ca||'#888'};padding:8px 12px;border-radius:8px;${aWin?'box-shadow:0 0 0 2.5px '+ca+'99':''}${isDone&&!aWin?';opacity:.5':''}">${m.a||'â€”'}</div>
          </div>
          <div style="text-align:center;min-width:60px">
            ${isDone?`<div class="grp-match-score"><span style="color:${aWin?'var(--green)':bWin?'var(--red)':'var(--text)'}">${m.sa}</span><span style="color:var(--gray-l)"> : </span><span style="color:${bWin?'var(--green)':aWin?'var(--red)':'var(--text)'}">${m.sb}</span></div>
            <div style="font-size:11px;font-weight:700;color:${aWin?ca:bWin?cb:'var(--gray-l)'};">${aWin?m.a+' ìŠ¹':bWin?m.b+' ìŠ¹':'ë¬´ìŠ¹ë¶€'}</div>
            ${hasDetail?`<button class="btn-detail" style="margin-top:4px;font-size:10px" onclick="leagueToggleDet('${detId}',this)">ìƒì„¸ â–¼</button>`:''}
            `:`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:18px;color:var(--gray-l)">VS</div>`}
          </div>
          <div style="text-align:center;min-width:80px">
            <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:#fff;background:${cb||'#888'};padding:8px 12px;border-radius:8px;${bWin?'box-shadow:0 0 0 2.5px '+cb+'99':''}${isDone&&!bWin?';opacity:.5':''}">${m.b||'â€”'}</div>
          </div>
        </div>
        ${isLoggedIn?`<div class="no-export" style="display:flex;flex-direction:column;gap:4px">
          <button class="btn btn-b btn-xs" onclick="leagueEditMatch('${tn.id}',${m.grpIdx},${m.matchNum-1})">âœï¸ ê²°ê³¼</button>
          <button class="btn btn-r btn-xs" onclick="grpDelMatch('${tn.id}',${m.grpIdx},${m.matchNum-1})">ì‚­ì œ</button>
        </div>`:''}
      </div>
      <div id="${detId}" style="display:none;margin-top:-4px;margin-bottom:8px;padding:12px;background:var(--surface);border-radius:0 0 10px 10px;border:1px solid var(--border);border-top:none">
        ${grpMatchDetail(m)}
      </div>`;
    });
    h+=`</div>`;
  });
  return h;
}

function leagueToggleDet(id,btn){
  const el=document.getElementById(id);if(!el)return;
  const open=el.style.display==='none'||!el.style.display;
  el.style.display=open?'block':'none';
  if(btn){btn.textContent=open?'ë‹«ê¸° â–²':'ìƒì„¸ ë³´ê¸° â–¼';btn.classList.toggle('open',open);}
}

function leagueEditMatch(tnId,gi,mi){
  grpMatchState={tnId,gi,mi};
  const tn=tourneys.find(t=>t.id===tnId);
  if(tn)grpOpenMatchModal(tn,gi,mi);
}

function grpMatchDetail(m){
  if(!m.sets||!m.sets.length) return `<div style="font-size:12px;color:var(--gray-l)">ìƒì„¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  let h=`<div style="font-size:12px;font-weight:700;color:var(--text2);margin-bottom:8px">ğŸ” ì„¸ë¶€ ê²½ê¸° ê¸°ë¡</div>`;
  m.sets.forEach((set,si)=>{
    const lbl=si===2?'ğŸ¯ ì—ì´ìŠ¤ì „':`${si+1}ì„¸íŠ¸`;
    const sA=set.scoreA||0;const sB=set.scoreB||0;
    h+=`<div style="margin-bottom:10px">
      <div style="display:flex;align-items:center;gap:8px;padding:5px 10px;background:${si===2?'#f5f3ff':'var(--blue-l)'};border-radius:6px;margin-bottom:6px">
        <strong style="font-size:11px;color:${si===2?'#7c3aed':'var(--blue)'}">${lbl}</strong>
        <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px"><span class="${sA>sB?'wt':''}">${sA}</span><span style="color:var(--gray-l)">:</span><span class="${sB>sA?'wt':''}">${sB}</span></span>
        <span style="font-size:11px;font-weight:700;color:${sA>sB?'var(--green)':sB>sA?'var(--red)':'var(--gray-l)'}">${sA>sB?(m.a||'AíŒ€')+' ìŠ¹':sB>sA?(m.b||'BíŒ€')+' ìŠ¹':'ë¬´ìŠ¹ë¶€'}</span>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:5px">`;
    (set.games||[]).forEach((g,gi)=>{
      if(!g.playerA&&!g.playerB)return;
      const pa=players.find(p=>p.name===g.playerA);const pb=players.find(p=>p.name===g.playerB);
      const wA=g.winner==='A';const wB=g.winner==='B';
      h+=`<div style="font-size:11px;background:#fff;padding:5px 10px;border-radius:6px;border:1px solid var(--border);display:flex;align-items:center;gap:4px">
        <span style="font-size:10px;color:var(--gray-l);min-width:14px">${gi+1}</span>
        <span style="font-weight:${wA?'800':'400'};color:${wA?'var(--green)':'var(--text)'}">${g.playerA||'?'}</span>
        ${pa?`<span class="rbadge r${pa.race}" style="font-size:9px;padding:0 3px">${pa.race||''}</span>`:''}
        <span style="color:var(--gray-l);font-size:10px">vs</span>
        <span style="font-weight:${wB?'800':'400'};color:${wB?'var(--green)':'var(--text)'}">${g.playerB||'?'}</span>
        ${pb?`<span class="rbadge r${pb.race}" style="font-size:9px;padding:0 3px">${pb.race||''}</span>`:''}
        ${g.map?`<span style="color:var(--gray-l);font-size:10px;margin-left:2px">[${g.map}]</span>`:''}
      </div>`;
    });
    h+=`</div></div>`;
  });
  return h;
}

function rCompGrpRankFull(tn){
  if(!tn) return `<div style="padding:30px;text-align:center;color:var(--gray-l)">ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>`;
  const GL='ABCDEFGHIJ';
  let h=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--blue);margin-bottom:4px">ğŸ“Š ${tn.name} â€” ì¡°ë³„ ìˆœìœ„</div>
  <div style="font-size:11px;color:var(--gray-l);margin-bottom:14px">ìŠ¹ì  â†’ ì„¸íŠ¸ ë“ì‹¤ â†’ ë“ì  ìˆœ Â· ìƒìœ„ 2íŒ€ í† ë„ˆë¨¼íŠ¸ ì§„ì¶œ</div>`;
  if(tn.groups.length>1){
    h+=`<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:14px">
      <button class="pill ${!grpRankFilter?'on':''}" onclick="grpRankFilter='';render()">ì „ì²´</button>`;
    tn.groups.forEach((grp,gi)=>{
      const gl=GL[gi];const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
      h+=`<button class="pill ${grpRankFilter===grp.name?'on':''}" style="${grpRankFilter===grp.name?`background:${col};border-color:${col};color:#fff`:''}" onclick="grpRankFilter='${grp.name}';render()">GROUP ${gl}</button>`;
    });
    h+=`</div>`;
  }
  const targetGroups=grpRankFilter?tn.groups.filter(g=>g.name===grpRankFilter):tn.groups;
  targetGroups.forEach(grp=>{
    const gi=tn.groups.indexOf(grp);const gl=GL[gi]||gi;
    const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
    const sc={};
    grp.univs.forEach(u=>{sc[u]={w:0,l:0,gw:0,gl2:0,pts:0,played:0};});
    (grp.matches||[]).forEach(m=>{
      if(m.sa==null||m.sb==null)return;
      if(!sc[m.a])sc[m.a]={w:0,l:0,gw:0,gl2:0,pts:0,played:0};
      if(!sc[m.b])sc[m.b]={w:0,l:0,gw:0,gl2:0,pts:0,played:0};
      sc[m.a].played++;sc[m.b].played++;
      sc[m.a].gw+=m.sa;sc[m.a].gl2+=m.sb;sc[m.b].gw+=m.sb;sc[m.b].gl2+=m.sa;
      if(m.sa>m.sb){sc[m.a].w++;sc[m.a].pts+=3;sc[m.b].l++;}
      else if(m.sb>m.sa){sc[m.b].w++;sc[m.b].pts+=3;sc[m.a].l++;}
      else{sc[m.a].pts++;sc[m.b].pts++;}
    });
    const sorted=Object.entries(sc).sort((a,b)=>b[1].pts-a[1].pts||(b[1].gw-b[1].gl2)-(a[1].gw-a[1].gl2)||b[1].gw-a[1].gw);
    const played=grp.matches.filter(m=>m.sa!=null).length;
    h+=`<div style="background:${col}06;border:2px solid ${col}33;border-radius:12px;padding:16px;margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap">
        <span style="background:${col};color:#fff;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px;padding:3px 14px;border-radius:20px">GROUP ${gl}</span>
        <span style="font-size:11px;color:var(--gray-l)">${played}/${grp.matches.length}ê²½ê¸° ì™„ë£Œ</span>
        <div style="margin-left:auto;display:flex;gap:5px;flex-wrap:wrap">${grp.univs.map(u=>`<span class="ubadge" style="background:${gc(u)};font-size:11px">${u}</span>`).join('')}</div>
      </div>
      <table class="grp-rank-table"><thead><tr><th>ìˆœìœ„</th><th>ëŒ€í•™</th><th>ê²½ê¸°</th><th>ìŠ¹</th><th>íŒ¨</th><th>ë“</th><th>ì‹¤</th><th>ë“ì‹¤</th><th>ìŠ¹ì </th></tr></thead><tbody>`;
    sorted.forEach(([name,s],i)=>{
      const uc=gc(name);const diff=s.gw-s.gl2;const isTop=i<2;
      const rowClass=i===0?'grp-rank-top1':i===1?'grp-rank-top2':'';
      h+=`<tr class="${rowClass}">
        <td>${i===0?`<span class="rk1">1ìœ„</span>`:i===1?`<span class="rk2">2ìœ„</span>`:i===2?`<span class="rk3">3ìœ„</span>`:`${i+1}ìœ„`}</td>
        <td><span class="ubadge clickable-univ" style="background:${uc};font-size:11px" onclick="openUnivModal('${name}')">${name}</span></td>
        <td style="color:var(--gray-l)">${s.played}</td><td class="wt">${s.w}</td><td class="lt">${s.l}</td>
        <td class="wt">${s.gw}</td><td class="lt">${s.gl2}</td>
        <td style="font-weight:700;color:${diff>0?'var(--green)':diff<0?'var(--red)':'var(--gray-l)'}">${diff>=0?'+':''}${diff}</td>
        <td style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:${col}">${s.pts}</td>
      </tr>`;
    });
    h+=`</tbody></table>`;
    if(played===0) h+=`<div style="font-size:12px;color:var(--gray-l);padding:10px 0;text-align:center">â³ ì•„ì§ ì§„í–‰ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
    h+=`</div>`;
  });
  return h;
}

function rCompTour(){
  const allU=getAllUnivs();
  function teamBox(idx,label){const v=tourD[idx]||'';const col=v?gc(v):'';return `<div class="mteam ${v?'set':''}" style="${v?`background:${col}18;border-color:${col};color:${col};font-weight:800`:''}">${v||label}</div>`;}
  function mCard(label,i1,i2,no){
    const selHtml=isLoggedIn?`<div class="msel-wrap no-export">
      <select class="msel" onchange="upTour(${i1},this.value)"><option value="">íŒ€A...</option>${allU.map(u=>`<option value="${u.name}"${tourD[i1]===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
      <select class="msel" onchange="upTour(${i2},this.value)"><option value="">íŒ€B...</option>${allU.map(u=>`<option value="${u.name}"${tourD[i2]===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
    </div>`:'';
    return `<div class="mcard"><div class="mcard-lbl">${label} Â· ${no}</div>${teamBox(i1,'ë¯¸í™•ì •')}<div class="mvs">VS</div>${teamBox(i2,'ë¯¸í™•ì •')}${selHtml}</div>`;
  }
  const champ=tourD[14]||'';const cc=champ?gc(champ):'';
  const champSel=isLoggedIn?`<select class="msel no-export" style="margin-top:10px" onchange="upTour(14,this.value)"><option value="">ì±”í”¼ì–¸...</option>${allU.map(u=>`<option value="${u.name}"${champ===u.name?' selected':''}>${u.name}</option>`).join('')}</select>`:'';
  return `<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;color:var(--blue);margin-bottom:12px">âš”ï¸ í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ â€” ê° ì¡° ìƒìœ„ 2íŒ€</div>
  <div class="tour-wrap"><div class="tour-inner">
    <div class="rcol" style="height:480px"><div class="rcol-lbl">8ê°• QUARTER</div>${mCard('8ê°•',0,1,1)}${mCard('8ê°•',2,3,2)}${mCard('8ê°•',4,5,3)}${mCard('8ê°•',6,7,4)}</div>
    <div class="conn"><div class="conn-line"></div></div>
    <div class="rcol" style="height:340px"><div class="rcol-lbl">4ê°• SEMI</div>${mCard('4ê°•',8,9,1)}${mCard('4ê°•',10,11,2)}</div>
    <div class="conn"><div class="conn-line"></div></div>
    <div class="rcol" style="height:200px"><div class="rcol-lbl">ğŸ† ê²°ìŠ¹ FINAL</div>${mCard('ê²°ìŠ¹',12,13,1)}</div>
    <div class="conn"><div class="conn-line"></div></div>
    <div class="champ-col" style="height:200px"><div class="champ-lbl2">ğŸ† CHAMPION</div>
      <div class="champ-box"><span class="champ-star">âœ¦ âœ¦ âœ¦</span><div class="champ-lbl">CHAMPION</div>
        <div class="champ-team" style="${cc?`background:${cc}18;border-color:${cc};color:${cc}`:''}">${champ||'?'}</div>${champSel}
      </div>
    </div>
  </div></div>`;
}

function rCompPlayerRank(tn){
  if(!tn) return `<div style="padding:30px;text-align:center;color:var(--gray-l)">ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>`;
  const pStats={};
  tn.groups.forEach(grp=>{
    (grp.matches||[]).forEach(m=>{
      if(m.sa==null)return;
      (m.sets||[]).forEach(set=>{
        (set.games||[]).forEach(g=>{
          if(!g.playerA||!g.playerB||!g.winner)return;
          const wn=g.winner==='A'?g.playerA:g.playerB;const ln=g.winner==='A'?g.playerB:g.playerA;
          if(!pStats[wn])pStats[wn]={w:0,l:0};if(!pStats[ln])pStats[ln]={w:0,l:0};
          pStats[wn].w++;pStats[ln].l++;
        });
      });
    });
  });
  const sorted=Object.entries(pStats).sort((a,b)=>{const da=a[1].w-a[1].l,db=b[1].w-b[1].l;return db!==da?db-da:b[1].w-a[1].w;});
  if(!sorted.length) return `<div style="padding:40px;text-align:center;color:var(--gray-l);background:var(--surface);border-radius:10px">â³ ì•„ì§ ê¸°ë¡ëœ ê²½ê¸° ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
  let h=`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--blue);margin-bottom:14px">ğŸ… ${tn.name} ê°œì¸ ìˆœìœ„</div>
  <table><thead><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ì†Œì†</th><th>ìŠ¹</th><th>íŒ¨</th><th>ìŠ¹ì°¨</th><th>ìŠ¹ë¥ </th></tr></thead><tbody>`;
  sorted.forEach(([name,s],i)=>{
    const p=players.find(x=>x.name===name);const col=p?gc(p.univ):'#888';
    const tot=s.w+s.l;const wr=tot?Math.round(s.w/tot*100):0;const diff=s.w-s.l;
    h+=`<tr>
      <td>${i===0?`<span class="rk1">1ë“±</span>`:i===1?`<span class="rk2">2ë“±</span>`:i===2?`<span class="rk3">3ë“±</span>`:`${i+1}ìœ„`}</td>
      <td><span class="clickable-name" onclick="openPlayerModal('${name}')">${name}</span></td>
      <td>${p?`<span class="ubadge" style="background:${col};font-size:11px">${p.univ}</span>`:'-'}</td>
      <td class="wt" style="font-weight:800">${s.w}</td><td class="lt" style="font-weight:800">${s.l}</td>
      <td style="font-weight:800;color:${diff>0?'var(--green)':diff<0?'var(--red)':'var(--gray-l)'}">${diff>=0?'+':''}${diff}</td>
      <td style="font-weight:700;color:${wr>=50?'var(--green)':'var(--red)'}">${tot?wr+'%':'-'}</td>
    </tr>`;
  });
  return h+`</tbody></table>`;
}

function grpToggleTierFilter(t){
  if(!window._grpTierFilters)window._grpTierFilters=[];
  const i=window._grpTierFilters.indexOf(t);
  if(i>=0)window._grpTierFilters.splice(i,1);else window._grpTierFilters.push(t);
  render();
}

function rCompGrpEdit(){
  if(!isLoggedIn) return `<div style="padding:30px;text-align:center;color:var(--gray-l)">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>`;
  if(grpSub==='edit'&&grpEditId) return rGrpEditInner();
  if(!window._grpTierFilters)window._grpTierFilters=[];
  const tfs=window._grpTierFilters;
  let h=`<div class="grp-edit-header">
    <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;color:var(--blue)">ğŸ—ï¸ ëŒ€íšŒ ì¡°í¸ì„± ê´€ë¦¬</span>
    <button class="btn btn-b btn-sm" onclick="grpNewTourney()">+ ìƒˆ ëŒ€íšŒ ë§Œë“¤ê¸°</button>
    <div style="margin-left:auto;display:flex;gap:5px;align-items:center;flex-wrap:wrap">
      <span style="font-size:11px;font-weight:700;color:var(--gray-l)">ì¶œì „ í‹°ì–´ <span style="font-weight:400;font-size:10px">(ë³µìˆ˜ì„ íƒ)</span>:</span>
      <button class="tier-filter-btn ${tfs.length===0?'on':''}" onclick="window._grpTierFilters=[];render()">ì „ì²´</button>
      ${TIERS.map(t=>`<button class="tier-filter-btn ${tfs.includes(t)?'on':''}" onclick="grpToggleTierFilter('${t}')">${getTierLabel(t)}</button>`).join('')}
    </div>
  </div>`;
  if(!tourneys.length){h+=`<div style="padding:40px;text-align:center;color:var(--gray-l);background:var(--surface);border-radius:10px;border:2px dashed var(--border2)">ë“±ë¡ëœ ëŒ€íšŒê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;return h;}
  tourneys.forEach((tn,ti)=>{
    const isActive=tn.name===curComp;
    h+=`<div style="background:${isActive?'var(--blue-l)':'var(--surface)'};border:${isActive?'2px solid var(--blue)':'1px solid var(--border)'};border-radius:12px;padding:16px 20px;margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px">
        <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px">${isActive?'âœ… ':''} ${tn.name}</span>
        <span style="font-size:11px;color:var(--gray-l)">${tn.groups.length}ê°œì¡° / ${tn.groups.reduce((s,g)=>s+(g.matches||[]).length,0)}ê²½ê¸°</span>
        <div style="margin-left:auto;display:flex;gap:6px;flex-wrap:wrap">
          ${!isActive?`<button class="btn btn-b btn-xs" onclick="curComp='${tn.name}';save();render()">í˜„ì¬ ëŒ€íšŒë¡œ ì„¤ì •</button>`:'<span style="font-size:11px;color:var(--blue);font-weight:700">ğŸ“Œ í˜„ì¬ ëŒ€íšŒ</span>'}
          <button class="btn btn-w btn-xs" onclick="grpEditId='${tn.id}';grpSub='edit';render()">ğŸ“ ì¡°í¸ì„± ì…ë ¥</button>
          <button class="btn btn-r btn-xs" onclick="grpDelTourney(${ti})">ì‚­ì œ</button>
        </div>
      </div>
      ${tn.groups.length?`<div style="display:flex;gap:6px;flex-wrap:wrap">${tn.groups.map((g,gi)=>{const gl='ABCDEFGHIJ'[gi];const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];return `<span style="background:${col};color:#fff;padding:2px 12px;border-radius:20px;font-size:11px;font-weight:700">GROUP ${gl}ì¡° (${g.univs.length}íŒ€, ${(g.matches||[]).length}ê²½ê¸°)</span>`;}).join('')}</div>`:'<span style="font-size:11px;color:var(--gray-l)">ì¡° ì—†ìŒ</span>'}
    </div>`;
  });
  return h;
}

function rGrpEditInner(){
  const tn=tourneys.find(t=>t.id===grpEditId);
  if(!tn){grpSub='list';render();return '';}
  const GL='ABCDEFGHIJ';
  let h=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap">
    <button class="btn btn-w btn-sm" onclick="grpSub='list';render()">â† ëª©ë¡</button>
    <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px">ğŸ† ${tn.name} â€” ì¡°í¸ì„±</span>
    <button class="btn btn-b btn-sm" style="margin-left:auto" onclick="grpAddGroup('${tn.id}')">+ ${GL[tn.groups.length]||'?'}ì¡° ì¶”ê°€</button>
  </div>`;
  if(!tn.groups.length){
    h+=`<div style="text-align:center;padding:50px;background:var(--surface);border-radius:12px;border:2px dashed var(--border2)">
      <div style="font-size:32px;margin-bottom:12px">ğŸ†</div>
      <div style="font-weight:700;margin-bottom:10px">Aì¡°ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ì¡°ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”</div>
      <button class="btn btn-b" onclick="grpAddGroup('${tn.id}')">+ GROUP Aì¡° ë§Œë“¤ê¸°</button>
    </div>`;
    return h;
  }
  tn.groups.forEach((grp,gi)=>{
    const gl=GL[gi]||gi;const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
    const availU=getAllUnivs().map(u=>u.name).filter(n=>!grp.univs.includes(n));
    h+=`<div style="background:${col}08;border:2px solid ${col}44;border-radius:12px;padding:16px;margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap">
        <span style="background:${col};color:#fff;font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:14px;padding:3px 16px;border-radius:20px">GROUP ${gl}ì¡°</span>
        <span style="font-size:11px;color:var(--gray-l)">${grp.univs.length}ê°œ ëŒ€í•™ Â· ${(grp.matches||[]).length}ê²½ê¸°</span>
        <button class="btn btn-r btn-xs" style="margin-left:auto" onclick="grpDelGroup('${tn.id}',${gi})">ì¡° ì‚­ì œ</button>
      </div>
      <div style="margin-bottom:14px">
        <div style="font-size:12px;font-weight:700;color:${col};margin-bottom:8px">â‘  ëŒ€í•™ ì„ íƒ</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
          ${grp.univs.map((u,ui)=>`<span class="ubadge" style="background:${gc(u)};font-size:12px">${u}<button onclick="grpRemoveUniv('${tn.id}',${gi},${ui})" style="background:rgba(255,255,255,.3);border:none;border-radius:50%;color:#fff;width:16px;height:16px;font-size:9px;cursor:pointer;margin-left:3px;line-height:16px;text-align:center">Ã—</button></span>`).join('')}
          ${!grp.univs.length?'<span style="color:var(--gray-l);font-size:12px">ì•„ì§ ì—†ìŒ</span>':''}
        </div>
        ${availU.length?`<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <div style="position:relative;flex:1;min-width:150px">
            <input type="text" id="grp-univ-search-${gi}" placeholder="ğŸ” ëŒ€í•™ ê²€ìƒ‰..." style="width:100%;padding:6px 10px;font-size:12px;border:1px solid var(--border2);border-radius:6px" oninput="grpFilterUnivSel(${gi})">
          </div>
          <select id="grp-univ-sel-${gi}" style="max-width:200px"><option value="">â€” ëŒ€í•™ ì„ íƒ â€”</option>${availU.map(u=>`<option value="${u}">${u}</option>`).join('')}</select>
          <button class="btn btn-b btn-sm" onclick="grpAddUniv('${tn.id}',${gi})">+ ì¶”ê°€</button>
        </div>`:`<div style="font-size:11px;color:var(--gray-l)">ëª¨ë“  ëŒ€í•™ì´ ì¶”ê°€ë¨</div>`}
      </div>
      <div>
        <div style="font-size:12px;font-weight:700;color:${col};margin-bottom:8px">â‘¡ ê²½ê¸° ì¼ì • (${(grp.matches||[]).length}ê²½ê¸° ë“±ë¡)</div>
        ${(grp.matches||[]).length?`<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">${grp.matches.map((m,mi)=>{
          const isDone=m.sa!=null&&m.sb!=null;const ca=gc(m.a||'');const cb=gc(m.b||'');
          return `<div style="background:#fff;border:1px solid var(--border);border-radius:8px;padding:7px 12px;font-size:12px;display:flex;align-items:center;gap:6px;flex-wrap:wrap">
            <span style="font-size:10px;font-weight:700;color:${col}">${gl}ì¡° ${mi+1}ê²½ê¸°</span>
            ${m.d?`<span style="font-size:10px;color:var(--gray-l)">${m.d.slice(5)}</span>`:''}
            <span style="background:${ca||'#888'};color:#fff;padding:1px 7px;border-radius:4px;font-size:11px">${m.a||'?'}</span>
            <span style="color:var(--gray-l)">vs</span>
            <span style="background:${cb||'#888'};color:#fff;padding:1px 7px;border-radius:4px;font-size:11px">${m.b||'?'}</span>
            ${isDone?`<span style="font-weight:800;font-size:12px"><span class="wt">${m.sa}</span>:<span class="lt">${m.sb}</span></span>`:'<span style="font-size:10px;color:var(--gray-l)">ì˜ˆì •</span>'}
            <button class="btn btn-b btn-xs" onclick="grpEditMatch('${tn.id}',${gi},${mi})">âœï¸ ê²°ê³¼ì…ë ¥</button>
            <button class="btn btn-r btn-xs" onclick="grpDelMatch('${tn.id}',${gi},${mi})">Ã—</button>
          </div>`;
        }).join('')}</div>`:''}
        ${grp.univs.length>=2?`<button class="btn btn-b btn-sm" onclick="grpAddMatch('${tn.id}',${gi})">+ ${gl}ì¡° ê²½ê¸° ì¶”ê°€</button>`:`<span style="font-size:11px;color:var(--gray-l)">â€» ëŒ€í•™ 2ê°œ ì´ìƒ ì¶”ê°€ í›„ ê²½ê¸° ë“±ë¡ ê°€ëŠ¥</span>`}
      </div>
    </div>`;
  });
  return h;
}

function grpAddMatchByDate(tnId, date){
  // í•´ë‹¹ ë‚ ì§œì˜ ì¡° ì¤‘ íŒ€ì´ 2ê°œ ì´ìƒì¸ ì²« ë²ˆì§¸ ì¡°ì— ê²½ê¸° ì¶”ê°€
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  // ì¡° ì„ íƒ (íŒ€ 2ê°œ ì´ìƒ ìˆëŠ” ì¡°ê°€ ìˆìœ¼ë©´ ì²« ë²ˆì§¸, ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì¡°)
  const validGrp=tn.groups.find(g=>g.univs.length>=2)||tn.groups[0];
  if(!validGrp){alert('ì¡°ë¥¼ ë¨¼ì € ë§Œë“¤ì–´ ì£¼ì„¸ìš”.');return;}
  const gi=tn.groups.indexOf(validGrp);
  validGrp.matches.push({a:'',b:'',d:date,sa:null,sb:null,sets:[]});
  const mi=validGrp.matches.length-1;
  save();grpMatchState={tnId,gi,mi};grpOpenMatchModal(tn,gi,mi);
}

function grpAddMatch(tnId,gi){
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  const grp=tn.groups[gi];
  if(grp.univs.length<2){alert('ë¨¼ì € ëŒ€í•™ì„ 2ê°œ ì´ìƒ ì¶”ê°€í•˜ì„¸ìš”.');return;}
  tn.groups[gi].matches.push({a:'',b:'',d:'',sa:null,sb:null,sets:[]});
  const mi=tn.groups[gi].matches.length-1;
  save();grpMatchState={tnId,gi,mi};grpOpenMatchModal(tn,gi,mi);
}
function grpEditMatch(tnId,gi,mi){
  grpMatchState={tnId,gi,mi};const tn=tourneys.find(t=>t.id===tnId);if(tn)grpOpenMatchModal(tn,gi,mi);
}
function grpDelMatch(tnId,gi,mi){
  if(!confirm('ê²½ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nâš ï¸ ì„ ìˆ˜ ê°œì¸ ì „ì ë„ ë¡¤ë°±ë©ë‹ˆë‹¤.'))return;
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  revertMatchRecord(tn.groups[gi].matches[mi]);
  tn.groups[gi].matches.splice(mi,1);save();render();
}

function grpOpenMatchModal(tn,gi,mi){
  const grp=tn.groups[gi];const m=grp.matches[mi];
  const GL=['A','B','C','D','E','F','G','H','I','J'];const gl=GL[gi]||String.fromCharCode(65+gi);
  const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
  const uOpts=`<option value="">â€” ëŒ€í•™ ì„ íƒ â€”</option>`+grp.univs.map(u=>`<option value="${u}"${m.a===u?' selected':''}>${u}</option>`).join('');
  const uOptsB=`<option value="">â€” ëŒ€í•™ ì„ íƒ â€”</option>`+grp.univs.map(u=>`<option value="${u}"${m.b===u?' selected':''}>${u}</option>`).join('');
  document.getElementById('grpMatchTitle').textContent=`GROUP ${gl}ì¡° ${mi+1}ê²½ê¸° ê²°ê³¼ ì…ë ¥`;
  document.getElementById('grpMatchBody').innerHTML=`
    <div style="background:${col}10;border:1px solid ${col}44;border-radius:10px;padding:14px;margin-bottom:16px">
      <div style="font-size:11px;font-weight:700;color:${col};margin-bottom:10px">
        ğŸ“‹ GROUP ${gl}ì¡° ì†Œì† ëŒ€í•™: ${grp.univs.map(u=>`<span style="background:${gc(u)};color:#fff;padding:1px 8px;border-radius:4px;font-size:11px;margin-left:4px">${u}</span>`).join('')}
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start">
        <div style="flex:1;min-width:130px">
          <div style="font-size:11px;font-weight:700;color:var(--blue);margin-bottom:4px">ğŸ”µ íŒ€ A ëŒ€í•™</div>
          <select id="gm-a" onchange="grpRefreshSets()" style="width:100%">${uOpts}</select>
        </div>
        <div style="font-size:16px;font-weight:800;color:var(--gray-l);padding-top:22px">VS</div>
        <div style="flex:1;min-width:130px">
          <div style="font-size:11px;font-weight:700;color:var(--red);margin-bottom:4px">ğŸ”´ íŒ€ B ëŒ€í•™</div>
          <select id="gm-b" onchange="grpRefreshSets()" style="width:100%">${uOptsB}</select>
        </div>
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--gray-l);margin-bottom:4px">ğŸ“… ë‚ ì§œ</div>
          <input type="date" id="gm-date" value="${m.d||new Date().toISOString().slice(0,10)}" style="width:145px">
        </div>
      </div>
    </div>
    <div id="gm-sets"></div>
    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
      <button class="btn btn-b btn-sm" onclick="grpAddSet()">+ 1ì„¸íŠ¸</button>
      <button class="btn btn-w btn-sm" onclick="grpAddSet2()">+ 2ì„¸íŠ¸</button>
      <button class="btn btn-w btn-sm" onclick="grpAddSet3()">ğŸ¯ ì—ì´ìŠ¤ì „</button>
      <button class="btn btn-g btn-sm" style="margin-left:auto" onclick="grpSaveMatch()">âœ… ì €ì¥ (ê°œì¸ì „ì  ìë™ë°˜ì˜)</button>
      <button class="btn btn-w btn-sm" onclick="cm('grpMatchModal')">ì·¨ì†Œ</button>
    </div>`;
  om('grpMatchModal');
  grpRefreshSets();
}

function grpUpdateMemberList(){
  function mHTML(univ){
    if(!univ)return '';
    const mems=players.filter(p=>p.univ===univ);
    if(!mems.length)return `<span style="color:var(--gray-l)">ì„ ìˆ˜ ì—†ìŒ</span>`;
    return `<div style="display:flex;flex-wrap:wrap;gap:3px">${mems.map(p=>`<span style="font-size:11px;background:${gc(univ)}12;border:1px solid ${gc(univ)}44;padding:2px 7px;border-radius:4px">${p.name}<span style="color:var(--gray-l)">[${p.tier||'-'}/${p.race||'-'}]</span></span>`).join('')}</div>`;
  }
  const aEl=document.getElementById('gm-a'),bEl=document.getElementById('gm-b');
  const aDiv=document.getElementById('gm-a-mems'),bDiv=document.getElementById('gm-b-mems');
  if(aEl&&aDiv)aDiv.innerHTML=mHTML(aEl.value);
  if(bEl&&bDiv)bDiv.innerHTML=mHTML(bEl.value);
}

function grpRefreshSets(){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];
  const aEl=document.getElementById('gm-a');const bEl=document.getElementById('gm-b');
  if(!aEl)return;
  const teamA=aEl.value,teamB=bEl?bEl.value:'';
  const tfs=window._grpTierFilters||[];
  const mA=players.filter(p=>p.univ===teamA&&(tfs.length===0||tfs.includes(p.tier)));
  const mB=players.filter(p=>p.univ===teamB&&(tfs.length===0||tfs.includes(p.tier)));
  const tfLabel=tfs.length?` [${tfs.join('+')}]`:'';
  const optsA=`<option value="">AíŒ€ ì„ ìˆ˜${tfLabel}</option>`+mA.map(p=>`<option value="${p.name}">${p.name} [${p.tier||'-'}/${p.race||'-'}]</option>`).join('');
  const optsB=`<option value="">BíŒ€ ì„ ìˆ˜${tfLabel}</option>`+mB.map(p=>`<option value="${p.name}">${p.name} [${p.tier||'-'}/${p.race||'-'}]</option>`).join('');
  const setsEl=document.getElementById('gm-sets');if(!setsEl)return;
  if(!m.sets||!m.sets.length){setsEl.innerHTML='<div style="color:var(--gray-l);font-size:12px;margin:12px 0;padding:14px;background:var(--surface);border-radius:8px;text-align:center">ì„¸íŠ¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš” â†“</div>';return;}
  let h='';
  m.sets.forEach((set,si)=>{
    const lbl=si===2?'ğŸ¯ ì—ì´ìŠ¤ì „':`${si+1}ì„¸íŠ¸`;
    const sA=set.scoreA||0,sB=set.scoreB||0;
    h+=`<div class="set-block${si===2?' ace':''}">
      <div class="set-title">
        <span class="set-badge${si===2?' ace':''}">${lbl}</span>
        <span style="font-size:12px;color:var(--gray-l)">ê²½ê¸° ${(set.games||[]).length}ê°œ Â· <span class="${sA>sB?'wt':''}">${sA}</span>:<span class="${sB>sA?'wt':''}">${sB}</span></span>
        <button class="btn btn-r btn-xs" onclick="grpDelSet(${si})">ì„¸íŠ¸ ì‚­ì œ</button>
      </div>`;
    (set.games||[]).forEach((g,gi2)=>{
      const mapOpts=maps.map(mp=>`<option value="${mp}"${g.map===mp?' selected':''}>${mp}</option>`).join('');
      const selA=optsA.replace(`value="${g.playerA}"`,`value="${g.playerA}" selected`);
      const selB=optsB.replace(`value="${g.playerB}"`,`value="${g.playerB}" selected`);
      h+=`<div class="game-row">
        <span style="font-size:11px;font-weight:700;color:var(--gray-l);min-width:40px">ê²½ê¸°${gi2+1}</span>
        <select onchange="grpSetGame(${si},${gi2},'playerA',this.value)">${selA}</select>
        <span style="font-size:11px;color:var(--gray-l)">vs</span>
        <select onchange="grpSetGame(${si},${gi2},'playerB',this.value)">${selB}</select>
        <select onchange="grpSetGame(${si},${gi2},'map',this.value)" style="max-width:100px"><option value="">ë§µ</option>${mapOpts}</select>
        <button class="win-btn ${g.winner==='A'?'win-sel':''}" onclick="grpSetGame(${si},${gi2},'winner','A');grpRefreshSets()">A ìŠ¹</button>
        <button class="win-btn ${g.winner==='B'?'lose-sel':''}" onclick="grpSetGame(${si},${gi2},'winner','B');grpRefreshSets()">B ìŠ¹</button>
        <button class="btn btn-r btn-xs" onclick="grpDelGame(${si},${gi2})">ì‚­ì œ</button>
      </div>`;
    });
    h+=`<button class="btn btn-w btn-sm" onclick="grpAddGame(${si})">+ ê²½ê¸° ì¶”ê°€</button></div>`;
  });
  setsEl.innerHTML=h;
}

function grpSetGame(si,gi,field,val){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];
  if(m.sets[si]&&m.sets[si].games[gi])m.sets[si].games[gi][field]=val;
}
function grpAddSet(){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];if(!m.sets)m.sets=[];
  if(m.sets.length>=3){alert('ìµœëŒ€ 3ì„¸íŠ¸(ì—ì´ìŠ¤ì „ í¬í•¨)ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');return;}
  m.sets.push({games:[{playerA:'',playerB:'',winner:'',map:''}],scoreA:0,scoreB:0,winner:''});grpRefreshSets();
}
function grpAddSet2(){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];if(!m.sets)m.sets=[];
  if(m.sets.length>=3){alert('ì´ë¯¸ ìµœëŒ€ ì„¸íŠ¸ì…ë‹ˆë‹¤.');return;}
  if(m.sets.length<1)m.sets.push({games:[{playerA:'',playerB:'',winner:'',map:''}],scoreA:0,scoreB:0,winner:''});
  if(m.sets.length<2)m.sets.push({games:[{playerA:'',playerB:'',winner:'',map:''}],scoreA:0,scoreB:0,winner:''});
  grpRefreshSets();
}
function grpAddSet3(){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];if(!m.sets)m.sets=[];
  if(m.sets.length>=3){alert('ì—ì´ìŠ¤ì „ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤.');return;}
  while(m.sets.length<3)m.sets.push({games:[{playerA:'',playerB:'',winner:'',map:''}],scoreA:0,scoreB:0,winner:''});
  grpRefreshSets();
}
function grpDelSet(si){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];m.sets.splice(si,1);grpRefreshSets();
}
function grpAddGame(si){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];if(!m.sets[si].games)m.sets[si].games=[];
  m.sets[si].games.push({playerA:'',playerB:'',winner:'',map:''});grpRefreshSets();
}
function grpDelGame(si,gi2){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const m=tn.groups[grpMatchState.gi].matches[grpMatchState.mi];m.sets[si].games.splice(gi2,1);grpRefreshSets();
}

function grpSaveMatch(){
  const tn=tourneys.find(t=>t.id===grpMatchState.tnId);if(!tn)return;
  const {gi,mi}=grpMatchState;const m=tn.groups[gi].matches[mi];
  m.d=document.getElementById('gm-date')?.value||'';
  m.a=document.getElementById('gm-a')?.value||'';
  m.b=document.getElementById('gm-b')?.value||'';
  if(!m.a||!m.b){alert('ë‘ íŒ€ì„ ì„ íƒí•˜ì„¸ìš”.');return;}
  // ì´ì „ ê¸°ë¡ ë¡¤ë°±
  if(m._id)revertMatchRecord({...m,_id:m._id});
  const matchId=genId();m._id=matchId;
  let sa=0,sb=0;
  (m.sets||[]).forEach(set=>{
    let sA=0,sB=0;
    (set.games||[]).forEach(g=>{if(g.winner==='A')sA++;else if(g.winner==='B')sB++;});
    set.scoreA=sA;set.scoreB=sB;set.winner=sA>sB?'A':sB>sA?'B':'';
    if(set.winner==='A')sa++;else if(set.winner==='B')sb++;
  });
  m.sa=sa;m.sb=sb;
  // ì„ ìˆ˜ ê°œì¸ ì „ì  ìë™ ë°˜ì˜
  (m.sets||[]).forEach(set=>{
    (set.games||[]).forEach(g=>{
      if(!g.playerA||!g.playerB||!g.winner)return;
      const wn=g.winner==='A'?g.playerA:g.playerB;const ln=g.winner==='A'?g.playerB:g.playerA;
      applyGameResult(wn,ln,m.d,g.map||'',matchId);
    });
  });
  save();cm('grpMatchModal');render();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ¯ í‹°ì–´ëŒ€íšŒ - CK ë°©ì‹ ê²½ê¸° ì…ë ¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _ttSub = 'input'; // input | records

function rTierTour(){
  if(!isLoggedIn && _ttSub==='input') _ttSub='records';
  const subOpts=[
    {id:'input',lbl:'ğŸ“ ê²½ê¸° ì…ë ¥',fn:`_ttSub='input';render()`},
    {id:'records',lbl:'ğŸ“‹ ê¸°ë¡',fn:`_ttSub='records';openDetails={};render()`}
  ];
  let h=stabs(_ttSub,subOpts);
  if(_ttSub==='input' && isLoggedIn){
    if(!BLD['tt'])BLD['tt']={date:'',tiers:[],membersA:[],membersB:[],sets:[]};
    h+=buildTierTourInputHTML();
  } else {
    // ê¸°ë¡ì€ ckM ì¤‘ tt íƒ€ì…ë§Œ or ë³„ë„ ttM ë°°ì—´ ì‚¬ìš©
    // ê°„ë‹¨í•˜ê²Œ ttM ë°°ì—´ì— ì €ì¥
    h+=ttM&&ttM.length?recSummaryListHTML(ttM,'ck','tiertour'):'<div style="padding:40px;text-align:center;color:var(--gray-l)">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
  }
  return h;
}

function buildTierTourInputHTML(){
  const bld=BLD['tt'];
  if(!bld.tiers)bld.tiers=[];
  const tfs=bld.tiers;
  const eligible=players.filter(p=>tfs.length===0||tfs.includes(p.tier));
  const mA=bld.membersA||[];const mB=bld.membersB||[];
  const addedNames=[...mA,...mB].map(m=>m.name);

  let h=`<div class="match-builder"><h3>ğŸ¯ í‹°ì–´ëŒ€íšŒ ì…ë ¥</h3>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
      <label style="font-size:12px;font-weight:700;color:var(--blue)">ë‚ ì§œ</label>
      <input type="date" value="${bld.date||''}" onchange="BLD['tt'].date=this.value">
    </div>

    <!-- ì°¸ê°€ í‹°ì–´ ì„ íƒ -->
    <div style="background:var(--blue-l);border:1px solid var(--blue-ll);border-radius:10px;padding:10px 14px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:var(--blue);margin-bottom:8px">â‘  ì°¸ê°€ í‹°ì–´ <span style="font-weight:400;color:var(--gray-l)">(ë³µìˆ˜ ì„ íƒ)</span></div>
      <div style="display:flex;gap:5px;flex-wrap:wrap">
        <button class="tier-filter-btn ${tfs.length===0?'on':''}" onclick="BLD['tt'].tiers=[];BLD['tt'].membersA=[];BLD['tt'].membersB=[];BLD['tt'].sets=[];render()">ì „ì²´</button>
        ${TIERS.map(t=>`<button class="tier-filter-btn ${tfs.includes(t)?'on':''}" onclick="ttToggleTier('${t}')">${getTierLabel(t)}</button>`).join('')}
      </div>
      <div style="font-size:11px;color:var(--blue);margin-top:6px">ëŒ€ìƒ ì„ ìˆ˜: <strong>${eligible.length}ëª…</strong></div>
    </div>

    <!-- ì„ ìˆ˜ ëª©ë¡ í´ë¦­ìœ¼ë¡œ íŒ€ ë°°ì • -->
    <div style="margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:var(--text2);margin-bottom:8px">â‘¡ ì„ ìˆ˜ í´ë¦­ â†’ íŒ€ ë°°ì • <span style="font-weight:400;color:var(--gray-l);font-size:11px">(AíŒ€ ë²„íŠ¼ / BíŒ€ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€)</span></div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;padding:10px;background:var(--surface);border:1px solid var(--border);border-radius:8px;max-height:200px;overflow-y:auto">
        ${eligible.length===0
          ?'<span style="color:var(--gray-l);font-size:12px">í‹°ì–´ë¥¼ ì„ íƒí•˜ë©´ ì„ ìˆ˜ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤</span>'
          :eligible.map(p=>{
              const inA=mA.some(m=>m.name===p.name);
              const inB=mB.some(m=>m.name===p.name);
              const bg=inA?'#2563eb':inB?'#dc2626':gc(p.univ);
              if(inA||inB){
                return `<span style="display:inline-flex;align-items:center;gap:3px;background:${bg};color:#fff;padding:4px 8px;border-radius:6px;font-size:11px;opacity:0.55">${p.name}<span style="opacity:.8;font-size:10px;margin-left:2px">${p.univ}/${p.tier}</span><span style="background:rgba(255,255,255,.3);border-radius:2px;padding:0 4px;font-size:9px;font-weight:800;margin-left:3px">${inA?'AíŒ€':'BíŒ€'}</span></span>`;
              }
              return `<span style="display:inline-flex;align-items:center;gap:4px;background:${bg};color:#fff;padding:3px 6px;border-radius:6px;font-size:11px">
                <span style="font-weight:700">${p.name}</span><span style="opacity:.8;font-size:10px">${p.univ}/${p.tier}</span>
                <button onclick="ttAddPlayer('A','${p.name}')" style="background:#fff;color:#2563eb;border:none;border-radius:3px;padding:1px 6px;font-size:10px;font-weight:800;cursor:pointer;margin-left:2px">AíŒ€</button>
                <button onclick="ttAddPlayer('B','${p.name}')" style="background:#fff;color:#dc2626;border:none;border-radius:3px;padding:1px 6px;font-size:10px;font-weight:800;cursor:pointer">BíŒ€</button>
              </span>`;
            }).join('')
        }
      </div>
    </div>

    <!-- íŒ€ êµ¬ì„± í™•ì¸ + ê²€ìƒ‰ ì¶”ê°€ -->
    <div style="display:flex;gap:14px;flex-wrap:wrap;margin-bottom:16px">
      <div class="ck-panel">
        <h4>ğŸ”µ íŒ€ A (${mA.length}ëª…)</h4>
        <div style="display:flex;gap:6px;margin-bottom:6px">
          <input type="text" id="tt-a-search" placeholder="ğŸ” ì´ë¦„Â·ë©”ëª¨ ê²€ìƒ‰..." style="flex:1;padding:5px 8px;border:1px solid var(--border2);border-radius:6px;font-size:12px" oninput="ttSearchPlayer('A')">
        </div>
        <div id="tt-a-drop" style="display:none;max-height:140px;overflow-y:auto;border:1px solid var(--border2);border-radius:6px;background:#fff;margin-bottom:6px"></div>
        <div>${mA.map((m,i)=>`<span class="mem-tag" style="background:${gc(m.univ)}">${m.name}<span style="font-size:10px;opacity:.8">(${m.univ}${m.tier?'/'+m.tier:''})</span><button onclick="BLD['tt'].membersA.splice(${i},1);BLD['tt'].sets=[];render()">Ã—</button></span>`).join('')||'<span style="color:var(--gray-l);font-size:12px">ì„ ìˆ˜ ì—†ìŒ</span>'}</div>
      </div>
      <div class="ck-panel">
        <h4>ğŸ”´ íŒ€ B (${mB.length}ëª…)</h4>
        <div style="display:flex;gap:6px;margin-bottom:6px">
          <input type="text" id="tt-b-search" placeholder="ğŸ” ì´ë¦„Â·ë©”ëª¨ ê²€ìƒ‰..." style="flex:1;padding:5px 8px;border:1px solid var(--border2);border-radius:6px;font-size:12px" oninput="ttSearchPlayer('B')">
        </div>
        <div id="tt-b-drop" style="display:none;max-height:140px;overflow-y:auto;border:1px solid var(--border2);border-radius:6px;background:#fff;margin-bottom:6px"></div>
        <div>${mB.map((m,i)=>`<span class="mem-tag" style="background:${gc(m.univ)}">${m.name}<span style="font-size:10px;opacity:.8">(${m.univ}${m.tier?'/'+m.tier:''})</span><button onclick="BLD['tt'].membersB.splice(${i},1);BLD['tt'].sets=[];render()">Ã—</button></span>`).join('')||'<span style="color:var(--gray-l);font-size:12px">ì„ ìˆ˜ ì—†ìŒ</span>'}</div>
      </div>
    </div>`;
  h+=setBuilderHTML(bld,'tt');h+=`</div>`;return h;
}

function ttToggleTier(t){
  const bld=BLD['tt'];if(!bld)return;
  if(!bld.tiers)bld.tiers=[];
  const i=bld.tiers.indexOf(t);
  if(i>=0)bld.tiers.splice(i,1);else bld.tiers.push(t);
  bld.membersA=[];bld.membersB=[];bld.sets=[];render();
}

function ttAddPlayer(team, name){
  const bld=BLD['tt'];if(!bld)return;
  const all=[...(bld.membersA||[]),...(bld.membersB||[])];
  if(all.find(m=>m.name===name))return;
  const pObj=players.find(p=>p.name===name)||{};
  const mem={name,univ:pObj.univ||'',race:pObj.race||'',tier:pObj.tier||''};
  if(team==='A')bld.membersA.push(mem);else bld.membersB.push(mem);
  bld.sets=[];render();
}

function ttSearchPlayer(team){
  const searchEl=document.getElementById(`tt-${team.toLowerCase()}-search`);
  const dropEl=document.getElementById(`tt-${team.toLowerCase()}-drop`);
  if(!searchEl||!dropEl)return;
  const q=searchEl.value.trim().toLowerCase();
  if(!q){dropEl.style.display='none';dropEl.innerHTML='';return;}
  const bld=BLD['tt']||{};
  const tfs=bld.tiers||[];
  const already=[...(bld.membersA||[]),...(bld.membersB||[])].map(m=>m.name);
  const results=players.filter(p=>
    (tfs.length===0||tfs.includes(p.tier)) &&
    !already.includes(p.name) &&
    (p.name.toLowerCase().includes(q)||(p.memo||'').toLowerCase().includes(q)||(p.univ||'').toLowerCase().includes(q))
  ).slice(0,15);
  if(!results.length){dropEl.innerHTML='<div style="padding:8px 12px;color:var(--gray-l);font-size:12px">ê²°ê³¼ ì—†ìŒ</div>';dropEl.style.display='block';return;}
  dropEl.innerHTML=results.map(p=>`<div onclick="ttAddPlayer('${team}','${p.name}')"
    style="padding:7px 12px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;font-size:12px"
    onmouseover="this.style.background='#f0f6ff'" onmouseout="this.style.background=''">
    <span style="width:26px;height:26px;border-radius:5px;background:${gc(p.univ)};color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0">${p.race||'?'}</span>
    <div><div style="font-weight:700">${p.name} <span style="font-size:10px;color:var(--gray-l)">${p.univ} Â· ${p.tier||'-'}</span></div></div>
  </div>`).join('');
  dropEl.style.display='block';
}

function tierTourAutoGroup(){
  // êµ¬ë²„ì „ í˜¸í™˜ìš© - ë” ì´ìƒ ì‚¬ìš© ì•ˆ í•¨
}

function grpNewTourney(){
  const st = _tierTourState;
  if(!st.tiers) st.tiers=[];
  if(!st.groups) st.groups=[];

  // ì„ íƒëœ í‹°ì–´ì˜ ì„ ìˆ˜ ëª©ë¡
  const eligible = players.filter(p => st.tiers.length===0 || st.tiers.includes(p.tier));

  let h = `<div class="ssec">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap">
      <h4 style="margin:0">ğŸ¯ í‹°ì–´ëŒ€íšŒ ì¡°í¸ì„±</h4>
      <span style="font-size:11px;color:var(--gray-l)">(ì„ íƒí•œ í‹°ì–´ì˜ ì„ ìˆ˜ë“¤ë¡œ ì¡°ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤)</span>
    </div>

    <!-- í‹°ì–´ ì„ íƒ (ë³µìˆ˜) -->
    <div style="background:var(--blue-l);border:1px solid var(--blue-ll);border-radius:10px;padding:12px 16px;margin-bottom:16px">
      <div style="font-size:12px;font-weight:700;color:var(--blue);margin-bottom:8px">â‘  ì°¸ê°€ í‹°ì–´ ì„ íƒ <span style="font-weight:400;color:var(--gray-l)">(ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
        <button class="tier-filter-btn ${st.tiers.length===0?'on':''}" onclick="_tierTourState.tiers=[];render()">ì „ì²´</button>
        ${TIERS.map(t=>`<button class="tier-filter-btn ${st.tiers.includes(t)?'on':''}" onclick="(()=>{const i=_tierTourState.tiers.indexOf('${t}');if(i>=0)_tierTourState.tiers.splice(i,1);else _tierTourState.tiers.push('${t}');render()})();">${getTierLabel(t)}</button>`).join('')}
      </div>
      <div style="font-size:11px;color:var(--blue);font-weight:700">
        ì°¸ê°€ ëŒ€ìƒ: ${eligible.length}ëª…
        ${st.tiers.length ? `[${st.tiers.join('+')}í‹°ì–´]` : '(ì „ì²´)'}
      </div>
    </div>

    <!-- ì„ ìˆ˜ ëª©ë¡ -->
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 16px;margin-bottom:16px;max-height:220px;overflow-y:auto">
      <div style="font-size:12px;font-weight:700;color:var(--text2);margin-bottom:10px">â‘¡ ì°¸ê°€ ì„ ìˆ˜ í™•ì¸</div>
      ${eligible.length===0?'<div style="color:var(--gray-l);font-size:12px">ì„ íƒëœ í‹°ì–´ì— í•´ë‹¹í•˜ëŠ” ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
        :eligible.map(p=>`<span style="display:inline-flex;align-items:center;gap:4px;background:${gc(p.univ)};color:#fff;padding:3px 8px;border-radius:6px;font-size:11px;margin:2px">${p.name} <span style="opacity:.75">${p.univ}/${p.tier}</span></span>`).join('')}
    </div>

    <!-- ì¡° êµ¬ì„± -->
    <div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        <div style="font-size:12px;font-weight:700;color:var(--text2)">â‘¢ ì¡° í¸ì„±</div>
        ${isLoggedIn?`<button class="btn btn-b btn-sm" onclick="_tierTourState.groups.push({name:'GROUP '+String.fromCharCode(65+_tierTourState.groups.length),players:[],matches:[]});render()">+ ì¡° ì¶”ê°€</button>
        <button class="btn btn-w btn-sm" onclick="tierTourAutoGroup()">ğŸ² ìë™ ë°°ì •</button>`:''}
      </div>
      ${st.groups.length===0?'<div style="padding:30px;text-align:center;color:var(--gray-l);background:var(--surface);border:2px dashed var(--border2);border-radius:10px">ì¡°ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ìë™ ë°°ì •ì„ ì‚¬ìš©í•˜ì„¸ìš”</div>':''}
      ${st.groups.map((grp,gi)=>{
        const col=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2'][gi%6];
        const available=eligible.filter(p=>!st.groups.some((g,gj)=>gj!==gi&&g.players.includes(p.name)));
        return `<div style="background:${col}0d;border:2px solid ${col}44;border-radius:10px;padding:14px;margin-bottom:12px">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
            <span style="background:${col};color:#fff;font-weight:800;font-size:13px;padding:3px 14px;border-radius:20px">${grp.name}</span>
            <span style="font-size:11px;color:var(--gray-l)">${grp.players.length}ëª…</span>
            ${isLoggedIn?`<button class="btn btn-r btn-xs" style="margin-left:auto" onclick="_tierTourState.groups.splice(${gi},1);render()">ì¡° ì‚­ì œ</button>`:''}
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px">
            ${grp.players.map((pn,pi)=>{
              const pp=players.find(x=>x.name===pn)||{};
              return `<span style="background:${gc(pp.univ||'')};color:#fff;padding:2px 8px;border-radius:6px;font-size:11px;display:inline-flex;align-items:center;gap:4px">${pn}${isLoggedIn?`<button onclick="event.stopPropagation();_tierTourState.groups[${gi}].players.splice(${pi},1);render()" style="background:rgba(255,255,255,.3);border:none;color:#fff;border-radius:50%;width:14px;height:14px;font-size:9px;cursor:pointer;line-height:14px;text-align:center;padding:0">Ã—</button>`:''}`;
            }).join('')}
            ${grp.players.length===0?'<span style="color:var(--gray-l);font-size:11px">ì„ ìˆ˜ ì—†ìŒ</span>':''}
          </div>
          ${isLoggedIn&&available.length?`<div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
            <select id="tt-add-${gi}" style="font-size:12px;padding:4px 8px;border:1px solid var(--border2);border-radius:6px">
              <option value="">â€” ì„ ìˆ˜ ì¶”ê°€ â€”</option>
              ${available.map(p=>`<option value="${p.name}">${p.name} [${p.tier||'-'}/${p.race||'-'}] ${p.univ}</option>`).join('')}
            </select>
            <button class="btn btn-b btn-xs" onclick="(()=>{const v=document.getElementById('tt-add-${gi}')?.value;if(v&&!_tierTourState.groups[${gi}].players.includes(v)){_tierTourState.groups[${gi}].players.push(v);render();}})()">+ ì¶”ê°€</button>
          </div>`:''}
        </div>`;
      }).join('')}
    </div>
  </div>`;
  return h;
}

function tierTourAutoGroup(){
  const st=_tierTourState;
  if(!st.groups.length){
    const n=parseInt(prompt('ëª‡ ì¡°ë¡œ ë‚˜ëˆŒê¹Œìš”?','4')||'0');
    if(!n||n<2)return;
    st.groups=[];
    for(let i=0;i<n;i++) st.groups.push({name:'GROUP '+String.fromCharCode(65+i),players:[],matches:[]});
  }
  // ì„ íƒëœ í‹°ì–´ ì„ ìˆ˜ë“¤ ì„ì–´ì„œ ë°°ì •
  const eligible=players.filter(p=>st.tiers.length===0||st.tiers.includes(p.tier));
  const shuffled=[...eligible].sort(()=>Math.random()-0.5);
  st.groups.forEach(g=>g.players=[]);
  shuffled.forEach((p,i)=>{
    st.groups[i%st.groups.length].players.push(p.name);
  });
  render();
}

function grpNewTourney(){
  const name=prompt('ìƒˆ ëŒ€íšŒëª…ì„ ì…ë ¥í•˜ì„¸ìš”:');if(!name||!name.trim())return;
  const id=genId();tourneys.unshift({id,name:name.trim(),groups:[],createdAt:new Date().toISOString()});
  curComp=name.trim();save();grpEditId=tourneys[0].id;grpSub='edit';compSub='grpedit';render();
}
function grpDelTourney(ti){
  if(!confirm(`"${tourneys[ti].name}" ëŒ€íšŒë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  if(curComp===tourneys[ti].name)curComp='';tourneys.splice(ti,1);save();render();
}
function grpFilterUnivSel(gi){
  const searchEl=document.getElementById(`grp-univ-search-${gi}`);
  const selEl=document.getElementById(`grp-univ-sel-${gi}`);
  if(!searchEl||!selEl)return;
  const q=searchEl.value.trim().toLowerCase();
  Array.from(selEl.options).forEach(opt=>{
    if(!opt.value)return;
    opt.style.display=(!q||opt.text.toLowerCase().includes(q))?'':'none';
  });
  // ì²« ë²ˆì§¸ ë§¤ì¹­ ì˜µì…˜ ìë™ ì„ íƒ
  const firstMatch=Array.from(selEl.options).find(o=>o.value&&o.style.display!=='none');
  if(firstMatch)selEl.value=firstMatch.value;
}

function grpAddGroup(tnId){
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  const name=`${'ABCDEFGHIJ'[tn.groups.length]||tn.groups.length+1}ì¡°`;
  tn.groups.push({name,univs:[],matches:[]});save();render();
}
function grpDelGroup(tnId,gi){
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  if(!confirm(`"${tn.groups[gi].name}"ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  tn.groups.splice(gi,1);save();render();
}
function grpAddUniv(tnId,gi){
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  const sel=document.getElementById(`grp-univ-sel-${gi}`);const val=sel?sel.value:'';
  if(!val){alert('ëŒ€í•™ì„ ì„ íƒí•˜ì„¸ìš”.');return;}
  if(tn.groups[gi].univs.includes(val)){alert('ì´ë¯¸ ì¶”ê°€ëœ ëŒ€í•™ì…ë‹ˆë‹¤.');return;}
  tn.groups[gi].univs.push(val);save();render();
}
function grpRemoveUniv(tnId,gi,ui){
  const tn=tourneys.find(t=>t.id===tnId);if(!tn)return;
  tn.groups[gi].univs.splice(ui,1);save();render();
}
function bindLeagueDateBtns(){}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   íšŒì› ê´€ë¦¬ (rMember)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let memberSearch='';
let memberEditId=null;

const BAN_TYPES=[
  {val:'30h',lbl:'30ì‹œê°„'},{val:'60h',lbl:'60ì‹œê°„'},{val:'100h',lbl:'100ì‹œê°„'},
  {val:'10d',lbl:'10ì¼'},{val:'30d',lbl:'30ì¼'},{val:'60d',lbl:'60ì¼'},{val:'perm',lbl:'ì˜êµ¬ì°¨ë‹¨'}
];
const MEMBER_CATS=[{val:'warn',lbl:'âš ï¸ ì£¼ì˜'},{val:'bad',lbl:'ğŸ˜¡ ì•…ì„±'},{val:'sus',lbl:'ğŸ” ì˜ì‹¬'}];

function banEndLabel(m){
  if(!m.banType)return '';
  if(m.banType==='perm')return 'ì˜êµ¬ì°¨ë‹¨';
  if(!m.banEnd)return m.banType;
  const end=new Date(m.banEnd);const now=new Date();
  if(now>=end)return 'âœ… ì°¨ë‹¨ ì™„ë£Œ';
  const diff=Math.ceil((end-now)/3600000);
  return `ì°¨ë‹¨ ì¤‘ (${diff}ì‹œê°„ ë‚¨ìŒ)`;
}

function isBanDone(m){
  if(!m.banType||m.banType==='perm')return false;
  if(!m.banEnd)return false;
  return new Date()>=new Date(m.banEnd);
}

function rMember(C,T){
  T.innerText='ğŸ‘¥ íšŒì› ê´€ë¦¬';
  const adminOk=isLoggedIn;
  // ì°¨ë‹¨ ì™„ë£Œì ë¶„ë¦¬
  const done=members.filter(m=>isBanDone(m));
  const active=members.filter(m=>!isBanDone(m));
  const filtered=memberSearch
    ? active.filter(m=>m.nick.toLowerCase().includes(memberSearch.toLowerCase())||m.uid.toLowerCase().includes(memberSearch.toLowerCase()))
    : active;

  let h=`<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px">
    <input type="text" id="memberSearchInput" placeholder="ë‹‰ë„¤ì„ ë˜ëŠ” íšŒì›ë²ˆí˜¸ ì…ë ¥..." value="${memberSearch}"
      style="flex:1;max-width:280px" onkeydown="if(event.key==='Enter')memberDoSearch()">
    <button class="btn btn-b btn-sm" onclick="memberDoSearch()">ğŸ” íšŒì›ê²€ìƒ‰</button>
    ${memberSearch?`<button class="btn btn-w btn-sm" onclick="memberSearch='';render()">âœ• ì´ˆê¸°í™”</button>`:''}
    ${adminOk?`<button class="btn btn-g btn-sm" onclick="memberOpenAdd()">+ íšŒì› ì¶”ê°€</button>`:''}
  </div>`;

  // ì°¨ë‹¨ ì™„ë£Œì ì•Œë¦¼
  if(done.length){
    h+=`<div style="background:#f0fdf4;border:2px solid #86efac;border-radius:10px;padding:12px 16px;margin-bottom:16px">
      <div style="font-weight:700;font-size:13px;color:#16a34a;margin-bottom:8px">âœ… ì°¨ë‹¨ ì™„ë£Œì (${done.length}ëª…)</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">`;
    done.forEach(m=>{
      h+=`<span style="background:#dcfce7;color:#16a34a;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:700">
        ${m.nick} <span style="opacity:.6">(${m.uid})</span>
        ${adminOk?`<button onclick="memberConfirmDone('${m.id}')" style="background:none;border:none;color:#16a34a;cursor:pointer;font-weight:700;margin-left:4px">âœ“ í™•ì¸</button>`:''}
      </span>`;
    });
    h+=`</div></div>`;
  }

  if(!filtered.length){h+=`<div style="padding:40px;text-align:center;color:var(--gray-l);background:var(--surface);border-radius:10px">${memberSearch?'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ':'ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>`;C.innerHTML=h;return;}

  h+=`<table><thead><tr><th>ë‹‰ë„¤ì„</th><th>íšŒì›ë²ˆí˜¸</th><th>ë¶„ë¥˜</th><th>ì°¨ë‹¨</th><th>ì°¨ë‹¨ì´ë ¥</th><th>ìƒíƒœ</th><th>ë“±ë¡ì¼</th><th>ê´€ë¦¬</th></tr></thead><tbody>`;
  filtered.forEach(m=>{
    const catObj=MEMBER_CATS.find(c=>c.val===m.category)||{lbl:''};
    const banLabel=banEndLabel(m);
    const isActive=m.banType&&!isBanDone(m);
    const banHistCount=(m.banHistory||[]).length;
    h+=`<tr style="${isActive?'background:#fff1f1':''}">
      <td style="font-weight:700">${m.nick}</td>
      <td style="color:var(--gray-l)">${m.uid}</td>
      <td>${catObj.lbl?`<span style="font-size:11px">${catObj.lbl}</span>`:'-'}</td>
      <td><span style="font-size:11px;font-weight:700;color:${isActive?'var(--red)':banLabel.startsWith('âœ…')?'var(--green)':'var(--gray-l)'}">${banLabel||'-'}</span></td>
      <td><span style="font-size:11px;font-weight:700;color:${banHistCount>0?'var(--red)':'var(--gray-l)'}">${banHistCount}ê±´</span></td>
      <td><button class="btn-detail" style="font-size:11px" onclick="memberOpenDetail('${m.id}')">ìƒì„¸ë³´ê¸°</button></td>
      <td style="color:var(--gray-l);font-size:11px">${(m.createdAt||'').slice(0,10)}</td>
      <td class="no-export">${adminOk?`<button class="btn btn-o btn-xs" onclick="memberOpenEdit('${m.id}')">ìˆ˜ì •</button> <button class="btn btn-r btn-xs" onclick="memberDel('${m.id}')">ì‚­ì œ</button>`:'-'}</td>
    </tr>`;
  });
  h+=`</tbody></table>`;
  C.innerHTML=h;
}

function memberDoSearch(){
  const inp=document.getElementById('memberSearchInput');
  if(inp) memberSearch=inp.value.trim();
  render();
}

function memberOpenAdd(){
  memberEditId=null;_tmpPosts=[];
  document.getElementById('memberModalTitle').textContent='íšŒì› ì¶”ê°€';
  memberFillForm({nick:'',uid:'',category:'warn',banType:'',memo:'',report:'',posts:[]});
  om('memberModal');
}

function memberOpenEdit(id){
  const m=members.find(x=>x.id===id);if(!m)return;
  memberEditId=id;_tmpPosts=[...(m.posts||[])];
  document.getElementById('memberModalTitle').textContent='íšŒì› ìˆ˜ì •';
  memberFillForm(m);
  om('memberModal');
}

function memberFillForm(m){
  const banOpts=BAN_TYPES.map(b=>`<option value="${b.val}"${m.banType===b.val?' selected':''}>${b.lbl}</option>`).join('');
  const catOpts=MEMBER_CATS.map(c=>`<option value="${c.val}"${m.category===c.val?' selected':''}>${c.lbl}</option>`).join('');
  // ì°¨ë‹¨ ì´ë ¥ í‘œì‹œ (ì €ì¥ëœ ê¸°ë¡)
  const banHist=(m.banHistory||[]);
  const banHistHTML=banHist.length?`<div style="margin-top:8px;max-height:120px;overflow-y:auto;">`+banHist.map(h=>`<div style="font-size:11px;padding:3px 8px;background:var(--surface);border-radius:4px;margin-bottom:3px;color:var(--gray-l)">${h.date} Â· ${h.type} Â· ${h.memo||''}</div>`).join('')+`</div>`:'<div style="font-size:11px;color:var(--gray-l)">ì—†ìŒ</div>';
  document.getElementById('memberModalBody').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div>
        <label style="font-size:11px;font-weight:700;color:var(--gray-l);display:block;margin-bottom:4px">ë‹‰ë„¤ì„ *</label>
        <input type="text" id="mb-nick" value="${m.nick||''}" placeholder="ë‹‰ë„¤ì„" style="width:100%">
      </div>
      <div>
        <label style="font-size:11px;font-weight:700;color:var(--gray-l);display:block;margin-bottom:4px">íšŒì›ë²ˆí˜¸ *</label>
        <input type="text" id="mb-uid" value="${m.uid||''}" placeholder="íšŒì›ë²ˆí˜¸" style="width:100%">
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div>
        <label style="font-size:11px;font-weight:700;color:var(--gray-l);display:block;margin-bottom:4px">ë¶„ë¥˜</label>
        <select id="mb-cat" style="width:100%"><option value="">ë¶„ë¥˜ ì—†ìŒ</option>${catOpts}</select>
      </div>
      <div>
        <label style="font-size:11px;font-weight:700;color:var(--gray-l);display:block;margin-bottom:4px">ì°¨ë‹¨ ê¸°ê°„ (ìƒˆë¡œ ì¶”ê°€)</label>
        <select id="mb-ban" style="width:100%"><option value="">ì°¨ë‹¨ ì—†ìŒ</option>${banOpts}</select>
      </div>
    </div>
    <div style="margin-bottom:10px">
      <label style="font-size:11px;font-weight:700;color:var(--gray-l);display:block;margin-bottom:4px">ë©”ëª¨</label>
      <textarea id="mb-memo" rows="2" style="width:100%;padding:8px;border:1px solid var(--border2);border-radius:6px;font-size:12px;resize:vertical">${m.memo||''}</textarea>
    </div>
    <div style="margin-bottom:10px">
      <label style="font-size:11px;font-weight:700;color:var(--red);display:block;margin-bottom:4px">ğŸš¨ ì‹ ê³  ë‚´ìš©</label>
      <textarea id="mb-report" rows="2" style="width:100%;padding:8px;border:1.5px solid var(--red);border-radius:6px;font-size:12px;resize:vertical;color:var(--text)">${m.report||''}</textarea>
    </div>
    <div style="background:var(--surface);border-radius:8px;padding:10px 12px;margin-bottom:10px">
      <div style="font-weight:700;font-size:12px;color:var(--red);margin-bottom:6px">ğŸš« ì°¨ë‹¨ ì´ë ¥ (${banHist.length}ê±´)</div>
      ${banHistHTML}
    </div>
    <div>
      <div style="font-weight:700;font-size:12px;color:var(--blue);margin-bottom:6px">ğŸ”— ê²Œì‹œê¸€ ì´ë ¥</div>
      <div id="mb-posts">${memberPostsHTML(_tmpPosts)}</div>
      <div style="display:flex;gap:6px;margin-top:6px">
        <input type="text" id="mb-post-url" placeholder="ê²Œì‹œê¸€ URL" style="flex:1">
        <input type="text" id="mb-post-note" placeholder="ë©”ëª¨" style="width:100px">
        <button class="btn btn-b btn-xs" onclick="memberAddPost()">ì¶”ê°€</button>
      </div>
    </div>`;
}

function memberPostsHTML(posts){
  if(!posts.length)return '<div style="color:var(--gray-l);font-size:11px">ì—†ìŒ</div>';
  return posts.map((p,i)=>`<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;background:var(--surface);padding:4px 8px;border-radius:6px">
    <a href="${p.url}" target="_blank" style="color:var(--blue);font-size:11px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.url}</a>
    ${p.note?`<span style="font-size:10px;color:var(--gray-l)">${p.note}</span>`:''}
    <span style="font-size:10px;color:var(--gray-l)">${(p.savedAt||'').slice(0,10)}</span>
    <button onclick="memberRemovePost(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:12px">Ã—</button>
  </div>`).join('');
}

function memberCommentsHTML(comments){
  if(!comments.length)return '<div style="color:var(--gray-l);font-size:11px">ì—†ìŒ</div>';
  return comments.map((c,i)=>`<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;background:var(--surface);padding:4px 8px;border-radius:6px">
    <a href="${c.url}" target="_blank" style="color:var(--red);font-size:11px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.url}</a>
    ${c.note?`<span style="font-size:10px;color:var(--gray-l)">${c.note}</span>`:''}
    <span style="font-size:10px;color:var(--gray-l)">${(c.savedAt||'').slice(0,10)}</span>
    <button onclick="memberRemoveComment(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:12px">Ã—</button>
  </div>`).join('');
}

// ì„ì‹œ í¸ì§‘ìš© ë°°ì—´
let _tmpPosts=[];
function memberAddPost(){
  const url=document.getElementById('mb-post-url').value.trim();
  const note=document.getElementById('mb-post-note').value.trim();
  if(!url)return;
  _tmpPosts.push({url,note,savedAt:new Date().toISOString()});
  document.getElementById('mb-post-url').value='';
  document.getElementById('mb-post-note').value='';
  document.getElementById('mb-posts').innerHTML=memberPostsHTML(_tmpPosts);
}
function memberRemovePost(i){_tmpPosts.splice(i,1);document.getElementById('mb-posts').innerHTML=memberPostsHTML(_tmpPosts);}

function memberSave(){
  const nick=document.getElementById('mb-nick').value.trim();
  const uid=document.getElementById('mb-uid').value.trim();
  if(!nick||!uid){alert('ë‹‰ë„¤ì„ê³¼ íšŒì›ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return;}
  const banType=document.getElementById('mb-ban').value;
  const cat=document.getElementById('mb-cat').value;
  const memo=document.getElementById('mb-memo').value;
  const report=document.getElementById('mb-report').value;
  let banEnd=null;
  if(banType&&banType!=='perm'){
    const now2=new Date();
    if(banType.endsWith('h'))banEnd=new Date(now2.getTime()+parseInt(banType)*3600000).toISOString();
    else if(banType.endsWith('d'))banEnd=new Date(now2.getTime()+parseInt(banType)*86400000).toISOString();
  }
  const now=new Date().toISOString();
  if(memberEditId){
    const idx=members.findIndex(m=>m.id===memberEditId);
    if(idx>=0){
      const existing=members[idx];
      const banHistory=[...(existing.banHistory||[])];
      // ìƒˆë¡œìš´ ì°¨ë‹¨ì´ ì¶”ê°€ëœ ê²½ìš°ì—ë§Œ ì´ë ¥ì— ê¸°ë¡
      if(banType&&banType!==existing.banType){
        const bt=BAN_TYPES.find(b=>b.val===banType);
        banHistory.push({date:now.slice(0,10),type:bt?bt.lbl:banType,memo,banEnd});
      }
      members[idx]={...existing,nick,uid,category:cat,banType,banEnd,banHistory,memo,report,posts:_tmpPosts,updatedAt:now};
    }
  } else {
    const banHistory=[];
    if(banType){const bt=BAN_TYPES.find(b=>b.val===banType);banHistory.push({date:now.slice(0,10),type:bt?bt.lbl:banType,memo,banEnd});}
    members.unshift({id:genId(),nick,uid,category:cat,banType,banEnd,banHistory,memo,report,posts:_tmpPosts,createdAt:now,updatedAt:now});
  }
  save();cm('memberModal');render();
}

function memberDel(id){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  members=members.filter(m=>m.id!==id);save();render();
}

function memberConfirmDone(id){
  const m=members.find(x=>x.id===id);if(!m)return;
  m.banType='';m.banEnd=null;save();render();
}

function memberOpenDetail(id){
  const m=members.find(x=>x.id===id);if(!m)return;
  const catObj=MEMBER_CATS.find(c=>c.val===m.category)||{lbl:''};
  const banLabel=banEndLabel(m);
  const banHist=(m.banHistory||[]);
  document.getElementById('memberDetailTitle').textContent=`ğŸ‘¤ ${m.nick} ìƒì„¸`;
  document.getElementById('memberDetailBody').innerHTML=`
    <div style="background:var(--surface);border-radius:8px;padding:14px;margin-bottom:14px">
      <div style="display:flex;gap:14px;flex-wrap:wrap">
        <div><div style="font-size:10px;color:var(--gray-l)">ë‹‰ë„¤ì„</div><div style="font-weight:700;font-size:15px">${m.nick}</div></div>
        <div><div style="font-size:10px;color:var(--gray-l)">íšŒì›ë²ˆí˜¸</div><div style="font-weight:700">${m.uid}</div></div>
        <div><div style="font-size:10px;color:var(--gray-l)">ë¶„ë¥˜</div><div>${catObj.lbl||'-'}</div></div>
        <div><div style="font-size:10px;color:var(--gray-l)">ì°¨ë‹¨ ìƒíƒœ</div><div style="font-weight:700;color:${banLabel.startsWith('âœ…')?'var(--green)':'var(--red)'}">${banLabel||'ì—†ìŒ'}</div></div>
        <div><div style="font-size:10px;color:var(--gray-l)">ë“±ë¡ì¼</div><div style="font-size:11px">${(m.createdAt||'').slice(0,10)}</div></div>
      </div>
      ${m.memo?`<div style="margin-top:10px;font-size:12px;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid var(--border)">ğŸ“ ${m.memo}</div>`:''}
      ${m.report?`<div style="margin-top:8px;font-size:12px;background:#fff1f1;padding:8px 12px;border-radius:6px;border:1px solid #fca5a5;color:var(--red)">ğŸš¨ ì‹ ê³ ë‚´ìš©: ${m.report}</div>`:''}
    </div>
    <div style="font-weight:700;font-size:12px;color:var(--red);margin-bottom:8px">ğŸš« ì°¨ë‹¨ ì´ë ¥ (${banHist.length}ê±´)</div>
    ${banHist.length?`<div style="max-height:150px;overflow-y:auto;margin-bottom:14px">`+banHist.map(h=>`<div style="font-size:11px;padding:4px 8px;background:var(--surface);border-radius:4px;margin-bottom:3px;color:var(--gray-l)">${h.date} Â· ${h.type} Â· ${h.memo||''}</div>`).join('')+'</div>':`<div style="color:var(--gray-l);font-size:11px;margin-bottom:14px">ì—†ìŒ</div>`}
    <div style="font-weight:700;font-size:12px;color:var(--blue);margin-bottom:8px">ğŸ”— ê²Œì‹œê¸€ ì´ë ¥ (${(m.posts||[]).length}ê±´)</div>
    ${(m.posts||[]).length?m.posts.map(p=>`<div style="margin-bottom:6px;padding:6px 10px;background:var(--surface);border-radius:6px;display:flex;align-items:center;gap:8px">
      <a href="${p.url}" target="_blank" onclick="event.stopPropagation()" style="color:var(--blue);font-size:12px;flex:1">ğŸ”— ê¸€ ì´ë ¥ í™•ì¸í•˜ê¸°</a>
      ${p.note?`<span style="font-size:10px;color:var(--gray-l)">${p.note}</span>`:''}
      <span style="font-size:10px;color:var(--gray-l)">${(p.savedAt||'').slice(0,10)}</span>
    </div>`).join(''):'<div style="color:var(--gray-l);font-size:11px">ì—†ìŒ</div>'}`;
  om('memberDetailModal');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„¤ì •
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rCfg(C,T){
  T.innerText='âš™ï¸ ì„¤ì •';
  let h=`<div class="ssec"><h4>ğŸ›ï¸ ëŒ€í•™ ê´€ë¦¬</h4>`;
  univCfg.forEach((u,i)=>{
    h+=`<div class="srow">
      <div class="cdot" style="background:${u.color}"></div>
      <input type="text" value="${u.name}" style="flex:1;max-width:160px" onblur="univCfg[${i}].name=this.value;save()">
      <input type="color" value="${u.color}" style="width:40px;height:32px;padding:2px;border-radius:5px;cursor:pointer;border:1px solid var(--border2)" onchange="univCfg[${i}].color=this.value;this.previousElementSibling.previousElementSibling.style.background=this.value;save()">
      <button class="btn btn-r btn-xs" onclick="delUniv(${i})">ì‚­ì œ</button>
    </div>`;
  });
  h+=`<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <input type="text" id="nu-n" placeholder="ìƒˆ ëŒ€í•™ëª…" style="width:150px">
    <input type="color" id="nu-c" value="#2563eb" style="width:40px;height:34px;padding:2px;border-radius:5px;cursor:pointer;border:1px solid var(--border2)">
    <button class="btn btn-b" onclick="addUniv()">+ ëŒ€í•™ ì¶”ê°€</button>
  </div></div>
  <div class="ssec"><h4>ğŸ—ºï¸ ë§µ ê´€ë¦¬</h4>`;
  maps.forEach((m,i)=>{
    h+=`<div class="srow">
      <span style="font-size:14px">ğŸ“</span>
      <input type="text" value="${m}" style="flex:1" onblur="maps[${i}]=this.value;save();refreshSel()">
      <button class="btn btn-r btn-xs" onclick="delMap(${i})">ì‚­ì œ</button>
    </div>`;
  });
  h+=`<div style="margin-top:12px;display:flex;gap:8px">
    <input type="text" id="nm" placeholder="ìƒˆ ë§µ ì´ë¦„" style="width:200px">
    <button class="btn btn-b" onclick="addMap()">+ ë§µ ì¶”ê°€</button>
  </div></div>
  <div class="ssec"><h4>ğŸ­ í‹°ì–´ ê´€ë¦¬</h4>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
      ${TIERS.map((t,i)=>`<div style="text-align:center;padding:8px 12px;background:var(--white);border:1px solid var(--border);border-radius:8px;display:flex;flex-direction:column;align-items:center;gap:4px">
        ${getTierBadge(t)}
        <div style="font-size:10px;color:var(--gray-l)">${i+1}ìˆœìœ„</div>
        ${!['G','K','JA','J','S','0í‹°ì–´'].includes(t)?`<button class="btn btn-r btn-xs" onclick="delTier('${t}')">ì‚­ì œ</button>`:''}
      </div>`).join('')}
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input type="text" id="nt-name" placeholder="í‹°ì–´ ì´ë¦„ (ì˜ˆ: 9í‹°ì–´)" style="width:160px">
      <button class="btn btn-b" onclick="addTier()">+ í‹°ì–´ ì¶”ê°€</button>
    </div>
    <div style="font-size:11px;color:var(--gray-l);margin-top:6px">â€» ê¸°ë³¸ í‹°ì–´(G/K/JA/J/S/0í‹°ì–´)ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
  </div>
  <div class="ssec"><h4>ğŸ‘¤ ê´€ë¦¬ì ê³„ì • ê´€ë¦¬</h4>
    <p style="font-size:12px;color:var(--gray-l);margin-bottom:12px">ê´€ë¦¬ìë¥¼ ì—¬ëŸ¬ ëª… ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ê³„ì •ì€ ìœ ì§€ë˜ê³  ìƒˆ ê³„ì •ì´ ì¶”ê°€ë©ë‹ˆë‹¤.</p>
    <div style="margin-bottom:14px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:8px">
      <div style="font-size:12px;font-weight:700;color:var(--blue);margin-bottom:8px">í˜„ì¬ ë“±ë¡ëœ ê´€ë¦¬ì ê³„ì • ìˆ˜: <span id="adm-count">-</span>ëª…</div>
      <div id="adm-list" style="font-size:11px;color:var(--gray-l)"></div>
      <button class="btn btn-r btn-xs" style="margin-top:8px" onclick="clearAllAdmins()">âš ï¸ ì „ì²´ ê³„ì • ì´ˆê¸°í™” (ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹)</button>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
      <input type="text" id="adm-id" placeholder="ìƒˆ ê´€ë¦¬ì ì•„ì´ë””" style="width:180px" autocomplete="off">
      <input type="password" id="adm-pw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ)" style="width:180px" autocomplete="new-password">
      <button class="btn btn-p" onclick="addAdminAccount()">ğŸ‘¤ ê´€ë¦¬ì ì¶”ê°€</button>
    </div>
    <div id="adm-msg" style="font-size:12px;min-height:18px"></div>
  </div>`;
  // ê´€ë¦¬ì ìˆ˜ í‘œì‹œ
  setTimeout(()=>{
    const el=document.getElementById('adm-count');
    const listEl=document.getElementById('adm-list');
    if(el){const h=getAdminHashes();el.textContent=h.length;}
    if(listEl){listEl.textContent='â€» ë³´ì•ˆìƒ ê³„ì • ëª©ë¡ì€ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';}
  },50);
  C.innerHTML=h;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„ ìˆ˜ CRUD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addPlayer(){
  const n=document.getElementById('p-name').value.trim();
  if(!n)return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
  if(players.find(p=>p.name===n))return alert('ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
  players.push({name:n,univ:document.getElementById('p-univ').value,tier:document.getElementById('p-tier').value,race:document.getElementById('p-race').value,gender:document.getElementById('p-gender').value,win:0,loss:0,points:0,history:[]});
  document.getElementById('p-name').value='';save();render();
}
function recMatch(){
  const wN=document.getElementById('ws').value.trim();const lN=document.getElementById('ls').value.trim();
  const w=players.find(p=>p.name===wN);const l=players.find(p=>p.name===lN);
  if(!w||!l||w===l)return alert('ì„ ìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì„ íƒí•˜ì„¸ìš”.');
  const m=document.getElementById('m-map').value;const d=document.getElementById('m-date').value;
  applyGameResult(wN,lN,d,m,genId());
  document.getElementById('ws').value='';document.getElementById('ls').value='';save();render();
}
function openEP(name){
  editName=name;const p=players.find(x=>x.name===name);
  document.getElementById('emBody').innerHTML=`
    <label>ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„</label><input type="text" id="ed-n" value="${p.name}">
    <label>í‹°ì–´</label><select id="ed-t">${TIERS.map(t=>`<option value="${t}"${p.tier===t?' selected':''}>${getTierLabel(t)}</option>`).join('')}</select>
    <label>ëŒ€í•™</label><select id="ed-u">${getAllUnivs().map(u=>`<option value="${u.name}"${p.univ===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
    <label>ì¢…ì¡±</label><select id="ed-r"><option value="T"${p.race==='T'?' selected':''}>í…Œë€</option><option value="Z"${p.race==='Z'?' selected':''}>ì €ê·¸</option><option value="P"${p.race==='P'?' selected':''}>í”„ë¡œí† ìŠ¤</option></select>
    <label>ì„±ë³„</label><select id="ed-g"><option value="F"${(p.gender||'F')==='F'?' selected':''}>ğŸ‘© ì—¬ì</option><option value="M"${p.gender==='M'?' selected':''}>ğŸ‘¨ ë‚¨ì</option></select>
    <div style="margin-top:16px;padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;">
      <div style="font-weight:700;font-size:12px;color:var(--blue);margin-bottom:12px">ğŸ“Š ìŠ¹íŒ¨ ì§ì ‘ ì¡°ì •</div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px">
        <div style="flex:1;min-width:100px">
          <div style="font-size:11px;font-weight:700;color:var(--gray-l);margin-bottom:4px">ìŠ¹ (í˜„ì¬: ${p.win})</div>
          <input type="number" id="ed-win" value="${p.win}" min="0" style="width:100%">
        </div>
        <div style="flex:1;min-width:100px">
          <div style="font-size:11px;font-weight:700;color:var(--gray-l);margin-bottom:4px">íŒ¨ (í˜„ì¬: ${p.loss})</div>
          <input type="number" id="ed-loss" value="${p.loss}" min="0" style="width:100%">
        </div>
        <div style="flex:1;min-width:100px">
          <div style="font-size:11px;font-weight:700;color:var(--gray-l);margin-bottom:4px">í¬ì¸íŠ¸ (í˜„ì¬: ${p.points})</div>
          <input type="number" id="ed-pts" value="${p.points}" style="width:100%">
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-o btn-sm" onclick="
          if(confirm('ìŠ¹íŒ¨ì™€ íˆìŠ¤í† ë¦¬ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
            const p=players.find(x=>x.name===editName);
            p.win=0;p.loss=0;p.points=0;p.history=[];
            document.getElementById('ed-win').value=0;
            document.getElementById('ed-loss').value=0;
            document.getElementById('ed-pts').value=0;
            save();render();
          }
        ">ğŸ”„ ìŠ¹íŒ¨ ì „ì²´ ì´ˆê¸°í™”</button>
        <button class="btn btn-w btn-sm" onclick="
          const p=players.find(x=>x.name===editName);
          p.win=parseInt(document.getElementById('ed-win').value)||0;
          p.loss=parseInt(document.getElementById('ed-loss').value)||0;
          p.points=parseInt(document.getElementById('ed-pts').value)||0;
          save();render();
          document.getElementById('emBody').querySelector('.apply-ok').style.display='inline-block';
          setTimeout(()=>document.getElementById('emBody').querySelector('.apply-ok').style.display='none',1500);
        " style="border-color:var(--green);color:var(--green)">âœ… ìŠ¹íŒ¨ ì ìš©</button>
        <span class="apply-ok" style="display:none;color:var(--green);font-weight:700;font-size:12px;align-self:center">ì ìš©ë¨!</span>
      </div>
      <div style="font-size:10px;color:var(--gray-l);margin-top:8px">â€» ìŠ¹íŒ¨ ì´ˆê¸°í™” ì‹œ ê°œì¸ ê²½ê¸° ê¸°ë¡(íˆìŠ¤í† ë¦¬)ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤. ëŒ€ì „ ê¸°ë¡(ë¯¸ë‹ˆ/ëŒ€í•™ëŒ€ì „ ë“±)ì€ ìœ ì§€ë©ë‹ˆë‹¤.</div>
    </div>`;
  om('emModal');
}
function savePlayer(){
  const p=players.find(x=>x.name===editName);
  const newName=document.getElementById('ed-n').value.trim();
  const oldName=editName;

  // ì´ë¦„ ë³€ê²½ ì‹œ ëª¨ë“  ê¸°ë¡ ìë™ ê°±ì‹ 
  if(newName && newName !== oldName){
    // íˆìŠ¤í† ë¦¬ ë‚´ ìƒëŒ€ë°© ì´ë¦„ ê°±ì‹ 
    players.forEach(other=>{
      (other.history||[]).forEach(h=>{
        if(h.opp===oldName) h.opp=newName;
      });
    });
    // íˆìŠ¤í† ë¦¬ ë‚´ ë³¸ì¸ ì´ë¦„ì€ p.name ë³€ê²½ìœ¼ë¡œ ìë™ ì²˜ë¦¬
    // ë¯¸ë‹ˆëŒ€ì „/ëŒ€í•™ëŒ€ì „/ëŒ€íšŒ/CK/í”„ë¡œ ê²½ê¸° ë‚´ ì„ ìˆ˜ëª… ê°±ì‹ 
    const renameInMatches=(arr)=>{
      arr.forEach(m=>{
        (m.sets||[]).forEach(set=>{
          (set.games||[]).forEach(g=>{
            if(g.playerA===oldName) g.playerA=newName;
            if(g.playerB===oldName) g.playerB=newName;
            if(g.winner && (g.winner===oldName)) g.winner=newName;
          });
        });
        (m.teamAMembers||[]).forEach(mb=>{if(mb.name===oldName)mb.name=newName;});
        (m.teamBMembers||[]).forEach(mb=>{if(mb.name===oldName)mb.name=newName;});
      });
    };
    renameInMatches(miniM);
    renameInMatches(univM);
    renameInMatches(comps);
    renameInMatches(ckM);
    renameInMatches(proM);
    // ì¡°í¸ì„± ëŒ€íšŒ
    tourneys.forEach(tn=>{
      tn.groups.forEach(grp=>{
        (grp.matches||[]).forEach(m=>{
          (m.sets||[]).forEach(set=>{
            (set.games||[]).forEach(g=>{
              if(g.playerA===oldName) g.playerA=newName;
              if(g.playerB===oldName) g.playerB=newName;
            });
          });
        });
      });
    });
  }

  p.name=newName||oldName;
  p.tier=document.getElementById('ed-t').value;
  p.univ=document.getElementById('ed-u').value;
  p.race=document.getElementById('ed-r').value;
  p.gender=document.getElementById('ed-g').value;
  p.win=parseInt(document.getElementById('ed-win').value)||0;
  p.loss=parseInt(document.getElementById('ed-loss').value)||0;
  p.points=parseInt(document.getElementById('ed-pts').value)||0;
  save();render();cm('emModal');
}
function setAllFemale(){
  if(!confirm(`ëª¨ë“  ìŠ¤íŠ¸ë¦¬ë¨¸ ${players.length}ëª…ì„ ì—¬ìë¡œ ì¼ê´„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´í›„ ë‚¨ì ì„ ìˆ˜ëŠ” ê°œë³„ ìˆ˜ì •ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.`))return;
  players.forEach(p=>p.gender='F');
  save();render();
  alert(`ì™„ë£Œ! ì´ ${players.length}ëª…ì´ ì—¬ìë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

function delPlayer(){
  if(confirm(`"${editName}" ì„ ìˆ˜ë¥¼ ì‚­ì œí• ê¹Œìš”?`)){const idx=players.findIndex(p=>p.name===editName);if(idx>=0)players.splice(idx,1);save();render();cm('emModal');}
}

function openRE(mode,idx){
  reMode=mode;reIdx=idx;const allU=getAllUnivs();
  let body='',tit='';
  if(mode==='mini'){
    const m=miniM[idx];tit='âš¡ ë¯¸ë‹ˆëŒ€ì „ ìˆ˜ì •';
    body=`<label>ë‚ ì§œ</label><input type="date" id="re-d" value="${m.d}">
      <label>íŒ€ A ëŒ€í•™</label><select id="re-a">${allU.map(u=>`<option value="${u.name}"${m.a===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
      <label>íŒ€ A ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sa" value="${m.sa}">
      <label>íŒ€ B ëŒ€í•™</label><select id="re-b">${allU.map(u=>`<option value="${u.name}"${m.b===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
      <label>íŒ€ B ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sb" value="${m.sb}">`;
  } else if(mode==='univm'){
    const m=univM[idx];tit='ğŸŸï¸ ëŒ€í•™ëŒ€ì „ ìˆ˜ì •';
    body=`<label>ë‚ ì§œ</label><input type="date" id="re-d" value="${m.d}">
      <label>íŒ€ A</label><select id="re-a">${allU.map(u=>`<option value="${u.name}"${m.a===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
      <label>A ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sa" value="${m.sa}">
      <label>íŒ€ B</label><select id="re-b">${allU.map(u=>`<option value="${u.name}"${m.b===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
      <label>B ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sb" value="${m.sb}">`;
  } else if(mode==='comp'){
    const c=comps[idx];tit='ğŸ–ï¸ ëŒ€íšŒ ìˆ˜ì •';
    body=`<label>ë‚ ì§œ</label><input type="date" id="re-d" value="${c.d}">
      <label>ëŒ€íšŒëª…</label><input type="text" id="re-cn" value="${c.n}">
      <label>ëŒ€í•™ A</label><select id="re-a">${allU.map(u=>`<option value="${u.name}"${(c.a||c.u)===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
      <label>A ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sa" value="${c.sa||0}">
      <label>ëŒ€í•™ B</label><select id="re-b">${allU.map(u=>`<option value="${u.name}"${c.b===u.name?' selected':''}>${u.name}</option>`).join('')}</select>
      <label>B ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sb" value="${c.sb||0}">`;
  } else if(mode==='pro'){
    const m=proM[idx];tit='ğŸ… í”„ë¡œë¦¬ê·¸ ìˆ˜ì •';
    const mA=m.teamAMembers||[];const mB=m.teamBMembers||[];
    body=`<label>ë‚ ì§œ</label><input type="date" id="re-d" value="${m.d||''}">
      <label>AíŒ€ ë ˆì´ë¸”</label><input type="text" id="re-tla" value="${m.teamALabel||''}">
      <label>AíŒ€ ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sa" value="${m.sa||0}">
      <label>BíŒ€ ë ˆì´ë¸”</label><input type="text" id="re-tlb" value="${m.teamBLabel||''}">
      <label>BíŒ€ ì„¸íŠ¸ ìŠ¹</label><input type="number" id="re-sb" value="${m.sb||0}">
      <div style="margin-top:10px;font-size:11px;color:var(--gray-l)">â€» ì„¸íŠ¸ë³„ ê°œì¸ ê²½ê¸°ëŠ” ê¸°ë¡ ìƒì„¸ë³´ê¸°ì—ì„œ ìˆ˜ì •í•˜ì„¸ìš”.</div>`;
  }
  document.getElementById('reTitle').innerText=tit;
  document.getElementById('reBody').innerHTML=body;om('reModal');
}
function saveRow(){
  const d=document.getElementById('re-d')?.value||'';
  if(reMode==='mini'){
    miniM[reIdx].d=d;
    miniM[reIdx].a=document.getElementById('re-a')?.value||miniM[reIdx].a;
    miniM[reIdx].b=document.getElementById('re-b')?.value||miniM[reIdx].b;
    miniM[reIdx].sa=parseInt(document.getElementById('re-sa').value)||0;
    miniM[reIdx].sb=parseInt(document.getElementById('re-sb').value)||0;
  } else if(reMode==='univm'){
    const m=univM[reIdx];m.d=d;m.a=document.getElementById('re-a').value;
    m.sa=parseInt(document.getElementById('re-sa').value)||0;
    m.b=document.getElementById('re-b').value;m.sb=parseInt(document.getElementById('re-sb').value)||0;
  } else if(reMode==='comp'){
    const c=comps[reIdx];c.d=d;c.n=document.getElementById('re-cn').value;
    c.a=document.getElementById('re-a').value;c.u=c.a;c.hostUniv=c.a;
    c.sa=parseInt(document.getElementById('re-sa').value)||0;
    c.b=document.getElementById('re-b').value;c.sb=parseInt(document.getElementById('re-sb').value)||0;
  } else if(reMode==='pro'){
    const m=proM[reIdx];m.d=d;
    m.teamALabel=document.getElementById('re-tla')?.value||m.teamALabel;
    m.teamBLabel=document.getElementById('re-tlb')?.value||m.teamBLabel;
    m.sa=parseInt(document.getElementById('re-sa').value)||0;
    m.sb=parseInt(document.getElementById('re-sb').value)||0;
  }
  save();render();cm('reModal');
}

function addUniv(){const n=document.getElementById('nu-n').value.trim();const c=document.getElementById('nu-c').value;if(!n)return;univCfg.push({name:n,color:c});save();render();refreshSel();}
function delUniv(i){if(confirm(`"${univCfg[i].name}" ì‚­ì œ?`)){univCfg.splice(i,1);save();render();refreshSel();}}
function addMap(){const n=document.getElementById('nm').value.trim();if(!n)return;maps.push(n);save();render();refreshSel();}
function delMap(i){maps.splice(i,1);save();render();refreshSel();}

function addTier(){
  const n=document.getElementById('nt-name').value.trim();
  if(!n)return alert('í‹°ì–´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
  if(TIERS.includes(n))return alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í‹°ì–´ì…ë‹ˆë‹¤.');
  TIERS.push(n);
  // TIERSëŠ” constì´ë¯€ë¡œ push ê°€ëŠ¥
  save();render();
  document.getElementById('p-tier').innerHTML=TIERS.map(t=>`<option value="${t}">${getTierLabel(t)}</option>`).join('');
}
function delTier(t){
  const protectedTiers=['G','K','JA','J','S','0í‹°ì–´'];
  if(protectedTiers.includes(t))return alert('ê¸°ë³¸ í‹°ì–´ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  if(!confirm(`"${t}" í‹°ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ í‹°ì–´ì˜ ì„ ìˆ˜ëŠ” ê¸°ë³¸ í‹°ì–´ë¡œ ë³€ê²½ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`))return;
  const idx=TIERS.indexOf(t);
  if(idx>=0)TIERS.splice(idx,1);
  save();render();
  document.getElementById('p-tier').innerHTML=TIERS.map(t2=>`<option value="${t2}">${getTierLabel(t2)}</option>`).join('');
}

async function addAdminAccount(){
  const id=document.getElementById('adm-id').value.trim();
  const pw=document.getElementById('adm-pw').value;
  const msg=document.getElementById('adm-msg');
  if(!id||!pw){msg.style.color='var(--red)';msg.textContent='ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.';return;}
  if(pw.length<4){msg.style.color='var(--red)';msg.textContent='ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';return;}
  const h=await sha256(id+':'+pw);
  const hashes=getAdminHashes();
  if(hashes.includes(h)){msg.style.color='var(--gold)';msg.textContent='ì´ë¯¸ ë™ì¼í•œ ê³„ì •ì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';return;}
  hashes.push(h);
  localStorage.setItem(ADMIN_HASH_KEY,JSON.stringify(hashes));
  msg.style.color='var(--green)';
  msg.textContent=`âœ… ê´€ë¦¬ì ê³„ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (ì•„ì´ë””: ${id}) í˜„ì¬ ì´ ${hashes.length}ëª…`;
  document.getElementById('adm-id').value='';
  document.getElementById('adm-pw').value='';
  // ì¹´ìš´íŠ¸ ê°±ì‹ 
  const el=document.getElementById('adm-count');
  if(el)el.textContent=hashes.length;
}

async function clearAllAdmins(){
  if(!confirm('ëª¨ë“  ê´€ë¦¬ì ê³„ì •ì„ ì´ˆê¸°í™”í•˜ê³  ê¸°ë³¸ ê³„ì •(admin99)ìœ¼ë¡œ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'))return;
  const h=await sha256('admin99:99admin');
  localStorage.setItem(ADMIN_HASH_KEY,JSON.stringify([h]));
  alert('ì´ˆê¸°í™” ì™„ë£Œ. ê¸°ë³¸ ê³„ì •(admin99 / 99admin)ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
  doLogout();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“Š í†µê³„ íƒ­
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rStats(C,T){
  T.textContent='ğŸ“Š í†µê³„';

  // â”€â”€ ë°ì´í„° ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 1. ëŒ€í•™ë³„ ìŠ¹ë¥  (í”„ë¡œë¦¬ê·¸ ê¸°ë¡ ì œì™¸: ê°œì¸ historyì—ì„œ í”„ë¡œë¦¬ê·¸ matchIdë§Œ ê±¸ëŸ¬ëƒ„)
  // í”„ë¡œë¦¬ê·¸ matchId ì§‘í•©
  const proMatchIds=new Set(proM.map(m=>m._id).filter(Boolean));
  const univStats={};
  players.forEach(p=>{
    if(!univStats[p.univ]) univStats[p.univ]={w:0,l:0,color:gc(p.univ)};
    // í”„ë¡œë¦¬ê·¸ ê¸°ë¡ ì œì™¸
    const nonProHist=(p.history||[]).filter(h=>!proMatchIds.has(h.matchId));
    const pw=nonProHist.filter(h=>h.result==='ìŠ¹').length;
    const pl=nonProHist.filter(h=>h.result==='íŒ¨').length;
    univStats[p.univ].w+=pw;
    univStats[p.univ].l+=pl;
  });
  const univRank=Object.entries(univStats)
    .map(([name,s])=>({name,w:s.w,l:s.l,color:s.color,rate:s.w+s.l===0?0:Math.round(s.w/(s.w+s.l)*100)}))
    .sort((a,b)=>b.rate-a.rate||b.w-a.w);

  // 2. ì¢…ì¡±ë³„ ìƒëŒ€ì „ì  (í”„ë¡œë¦¬ê·¸ ê¸°ë¡ ì œì™¸)
  const rv={T:{T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}},Z:{T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}},P:{T:{w:0,l:0},Z:{w:0,l:0},P:{w:0,l:0}}};
  players.forEach(p=>{
    if(!p.history||!p.race)return;
    p.history.filter(h=>!proMatchIds.has(h.matchId)).forEach(h=>{
      if(!h.oppRace||!rv[p.race]||!rv[p.race][h.oppRace])return;
      if(h.result==='ìŠ¹') rv[p.race][h.oppRace].w++;
      else if(h.result==='íŒ¨') rv[p.race][h.oppRace].l++;
    });
  });

  // 3. ì›”ë³„ ê²½ê¸° ìˆ˜
  const monthStats={};
  const allMatches=[...miniM,...univM,...comps,...ckM,...proM];
  allMatches.forEach(m=>{
    const d=m.d||'';
    if(!d)return;
    const ym=d.slice(0,7);
    monthStats[ym]=(monthStats[ym]||0)+1;
  });
  const months=Object.keys(monthStats).sort();

  // 4. ë§µë³„ ìŠ¹ë¥ 
  const mapStats={};
  players.forEach(p=>{
    (p.history||[]).forEach(h=>{
      if(!h.map||h.map==='-')return;
      if(!mapStats[h.map]) mapStats[h.map]={w:0,l:0};
      if(h.result==='ìŠ¹') mapStats[h.map].w++;
      else if(h.result==='íŒ¨') mapStats[h.map].l++;
    });
  });
  const mapRank=Object.entries(mapStats)
    .map(([name,s])=>({name,w:s.w,l:s.l,total:s.w+s.l}))
    .sort((a,b)=>b.total-a.total);

  // 5. í¼ (ìµœê·¼ 5ê²½ê¸°) - ì—¬ì/ë‚¨ì ë¶„ë¦¬
  function calcFormPlayers(genderFilter){
    return players
      .filter(p=>p.history&&p.history.length>=3&&(genderFilter?p.gender===genderFilter:true))
      .map(p=>{
        const rec=[...p.history].slice(0,5);
        const streak=()=>{
          let s=0,type=rec[0]?.result;
          for(const h of rec){if(h.result===type)s++;else break;}
          return {n:s,type};
        };
        const st=streak();
        return {...p,form:rec,streak:st};
      })
      .sort((a,b)=>b.streak.n-a.streak.n)
      .slice(0,10);
  }
  const formPlayersF=calcFormPlayers('F');
  const formPlayersM=calcFormPlayers('M');

  // â”€â”€ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const raceColor={T:'#2563eb',Z:'#dc2626',P:'#7c3aed'};
  const raceName={T:'í…Œë€',Z:'ì €ê·¸',P:'í”„ë¡œí† ìŠ¤'};
  const raceEmoji={T:'âš”ï¸',Z:'ğŸ¦Ÿ',P:'ğŸ”®'};

  C.innerHTML=`
  <div style="display:flex;flex-direction:column;gap:20px">

    <!-- ëŒ€í•™ë³„ ìŠ¹ë¥  ë­í‚¹ -->
    <div class="ssec">
      <h4 style="font-family:'Noto Sans KR',sans-serif">ğŸ›ï¸ ëŒ€í•™ë³„ ìŠ¹ë¥  ë­í‚¹</h4>
      <div style="display:flex;flex-direction:column;gap:6px">
        ${univRank.filter(u=>u.w+u.l>0).map((u,i)=>{
          const bar=u.rate;
          const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`${i+1}ìœ„`;
          return `<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--white);border:1px solid var(--border);border-radius:8px;">
            <span style="min-width:32px;font-weight:800;font-size:13px">${medal}</span>
            <span style="min-width:80px;font-weight:700;color:${u.color}">${u.name}</span>
            <div style="flex:1;background:#f1f5f9;border-radius:20px;height:14px;overflow:hidden">
              <div style="width:${bar}%;background:${u.color};height:100%;border-radius:20px;transition:.3s"></div>
            </div>
            <span style="min-width:50px;text-align:right;font-weight:700;font-size:13px">${bar}%</span>
            <span style="color:var(--gray-l);font-size:11px">${u.w}ìŠ¹${u.l}íŒ¨</span>
          </div>`;
        }).join('')||'<p style="color:var(--gray-l)">ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
      </div>
    </div>

    <!-- ì¢…ì¡±ë³„ ìƒëŒ€ì „ì  -->
    <div class="ssec">
      <h4>âš”ï¸ ì¢…ì¡±ë³„ ìƒëŒ€ì „ì </h4>
      <div style="overflow-x:auto">
        <table style="min-width:400px">
          <thead>
            <tr>
              <th>ë‚´\ìƒëŒ€</th>
              <th>${raceEmoji.T} í…Œë€</th>
              <th>${raceEmoji.Z} ì €ê·¸</th>
              <th>${raceEmoji.P} í”„ë¡œí† ìŠ¤</th>
            </tr>
          </thead>
          <tbody>
            ${['T','Z','P'].map(r=>`
            <tr>
              <td style="font-weight:700;color:${raceColor[r]}">${raceEmoji[r]} ${raceName[r]}</td>
              ${['T','Z','P'].map(o=>{
                const s=rv[r][o];
                const rate=s.w+s.l===0?'-':Math.round(s.w/(s.w+s.l)*100)+'%';
                const bg=r===o?'background:#f1f5f9':s.w>s.l?'background:#f0fdf4':s.w<s.l?'background:#fef2f2':'';
                return `<td style="${bg}">
                  ${r===o?'<span style="color:var(--gray-l)">-</span>':`<span style="font-weight:700">${rate}</span><br><span style="font-size:10px;color:var(--gray-l)">${s.w}ìŠ¹${s.l}íŒ¨</span>`}
                </td>`;
              }).join('')}
            </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>

    <!-- ë§µë³„ ìŠ¹ë¥  í†µê³„ -->
    <div class="ssec">
      <h4>ğŸ—ºï¸ ë§µë³„ ê²½ê¸° í†µê³„</h4>
      <div style="display:flex;flex-wrap:wrap;gap:8px">
        ${mapRank.map(m=>{
          const rate=m.total===0?0:Math.round(m.w/m.total*100);
          const barW=m.total>0?rate:0;
          return `<div style="background:var(--white);border:1px solid var(--border);border-radius:10px;padding:12px 16px;min-width:150px;flex:1;max-width:220px">
            <div style="font-weight:800;font-size:13px;margin-bottom:4px">${m.name}</div>
            <div style="font-size:24px;font-weight:800;color:var(--blue);font-family:'Noto Sans KR',sans-serif;font-weight:900;line-height:1.1">${m.total}</div>
            <div style="font-size:10px;color:var(--gray-l);margin-bottom:6px">ì´ ê²½ê¸°</div>
            <div style="height:4px;border-radius:2px;background:var(--border);overflow:hidden;margin-bottom:4px">
              <div style="height:100%;width:${barW}%;background:var(--blue);border-radius:2px"></div>
            </div>
            <div style="font-size:11px;display:flex;justify-content:space-between"><span style="color:var(--green);font-weight:700">${m.w}ìŠ¹</span><span style="color:var(--gray-l)">${rate}%</span><span style="color:var(--red);font-weight:700">${m.l}íŒ¨</span></div>
          </div>`;
        }).join('')||'<p style="color:var(--gray-l)">ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
      </div>
    </div>

    <!-- ìµœê·¼ í¼ (ì—°ìŠ¹/ì—°íŒ¨) - ì—¬ì -->
    <div class="ssec">
      <h4>ğŸ”¥ ìµœê·¼ í¼ TOP 10 <span style="font-size:12px;color:#db2777;font-weight:600">ğŸ‘© ì—¬ì</span></h4>
      <div style="display:flex;flex-direction:column;gap:4px">
        ${formPlayersF.map((p,pi)=>{
          const formIcons=p.form.map(h=>h.result==='ìŠ¹'
            ?'<span style="display:inline-block;width:20px;height:20px;background:var(--green);color:#fff;font-size:10px;font-weight:800;border-radius:4px;text-align:center;line-height:20px">W</span>'
            :'<span style="display:inline-block;width:20px;height:20px;background:var(--red);color:#fff;font-size:10px;font-weight:800;border-radius:4px;text-align:center;line-height:20px">L</span>'
          ).join('');
          const streakColor=p.streak.type==='ìŠ¹'?'var(--green)':'var(--red)';
          const streakIcon=p.streak.type==='ìŠ¹'?'ğŸ”¥':'â„ï¸';
          return `<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--white);border:1px solid var(--border);border-radius:8px">
            <span style="font-weight:700;font-size:11px;color:var(--gray-l);min-width:20px;text-align:right">${pi+1}</span>
            <span style="font-weight:800;font-size:13px;cursor:pointer;color:var(--blue);min-width:65px" onclick="openPlayerModal('${p.name}')">${p.name}</span>
            <span style="font-size:11px;color:${gc(p.univ)};font-weight:700;min-width:55px">${p.univ}</span>
            <span style="display:flex;gap:2px">${formIcons}</span>
            <span style="font-weight:800;font-size:12px;color:${streakColor};white-space:nowrap">${streakIcon} ${p.streak.n}ì—°${p.streak.type==='ìŠ¹'?'ìŠ¹':'íŒ¨'}</span>
          </div>`;
        }).join('')||'<p style="color:var(--gray-l)">ê²½ê¸° ê¸°ë¡ì´ 3ê²½ê¸° ì´ìƒì¸ ì—¬ì ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
      </div>
    </div>

    <!-- ìµœê·¼ í¼ (ì—°ìŠ¹/ì—°íŒ¨) - ë‚¨ì -->
    <div class="ssec">
      <h4>ğŸ”¥ ìµœê·¼ í¼ TOP 10 <span style="font-size:12px;color:#2563eb;font-weight:600">ğŸ‘¨ ë‚¨ì</span></h4>
      <div style="display:flex;flex-direction:column;gap:4px">
        ${formPlayersM.map((p,pi)=>{
          const formIcons=p.form.map(h=>h.result==='ìŠ¹'
            ?'<span style="display:inline-block;width:20px;height:20px;background:var(--green);color:#fff;font-size:10px;font-weight:800;border-radius:4px;text-align:center;line-height:20px">W</span>'
            :'<span style="display:inline-block;width:20px;height:20px;background:var(--red);color:#fff;font-size:10px;font-weight:800;border-radius:4px;text-align:center;line-height:20px">L</span>'
          ).join('');
          const streakColor=p.streak.type==='ìŠ¹'?'var(--green)':'var(--red)';
          const streakIcon=p.streak.type==='ìŠ¹'?'ğŸ”¥':'â„ï¸';
          return `<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--white);border:1px solid var(--border);border-radius:8px">
            <span style="font-weight:700;font-size:11px;color:var(--gray-l);min-width:20px;text-align:right">${pi+1}</span>
            <span style="font-weight:800;font-size:13px;cursor:pointer;color:var(--blue);min-width:65px" onclick="openPlayerModal('${p.name}')">${p.name}</span>
            <span style="font-size:11px;color:${gc(p.univ)};font-weight:700;min-width:55px">${p.univ}</span>
            <span style="display:flex;gap:2px">${formIcons}</span>
            <span style="font-weight:800;font-size:12px;color:${streakColor};white-space:nowrap">${streakIcon} ${p.streak.n}ì—°${p.streak.type==='ìŠ¹'?'ìŠ¹':'íŒ¨'}</span>
          </div>`;
        }).join('')||'<p style="color:var(--gray-l)">ê²½ê¸° ê¸°ë¡ì´ 3ê²½ê¸° ì´ìƒì¸ ë‚¨ì ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
      </div>
    </div>

  </div>`;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ” ì „ì²´ ì„ ìˆ˜ ê²€ìƒ‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onGlobalSearch(val){
  const drop = document.getElementById('globalSearchDrop');
  if(!val || val.trim()===''){drop.style.display='none';return;}
  const q = val.toLowerCase();
  const results = players.filter(p=>
    p.name.toLowerCase().includes(q) ||
    (p.univ||'').toLowerCase().includes(q) ||
    (p.tier||'').toLowerCase().includes(q) ||
    (p.race||'').toLowerCase().includes(q) ||
    (p.memo||'').toLowerCase().includes(q)
  ).slice(0,15);
  if(results.length===0){
    drop.innerHTML='<div style="padding:16px;text-align:center;color:var(--gray-l);font-size:12px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
    drop.style.display='block';return;
  }
  const raceEmoji={T:'âš”ï¸',Z:'ğŸ¦Ÿ',P:'ğŸ”®'};
  drop.innerHTML = results.map(p=>{
    const col=gc(p.univ);
    const wr=p.win+p.loss===0?0:Math.round(p.win/(p.win+p.loss)*100);
    return `<div onclick="globalSearchSelect('${p.name}')" style="padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;transition:.1s"
      onmouseover="this.style.background='#f0f6ff'" onmouseout="this.style.background=''"
    >
      <div style="width:36px;height:36px;border-radius:8px;background:${col};display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">${raceEmoji[p.race]||'ğŸ‘¤'}</div>
      <div style="flex:1;min-width:0">
        <div style="font-weight:700;font-size:13px">${p.name} ${p.gender==='M'?'<span style="font-size:10px;background:#2563eb;color:#fff;padding:1px 5px;border-radius:4px">â™‚</span>':''}</div>
        <div style="font-size:11px;color:var(--gray-l)">${p.univ} Â· ${p.tier}</div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-weight:700;font-size:12px;color:var(--blue)">${wr}%</div>
        <div style="font-size:10px;color:var(--gray-l)">${p.win}ìŠ¹${p.loss}íŒ¨</div>
      </div>
    </div>`;
  }).join('');
  drop.style.display='block';
}

function globalSearchSelect(name){
  document.getElementById('globalSearch').value='';
  document.getElementById('globalSearchDrop').style.display='none';
  openPlayerModal(name);
}

// ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
document.addEventListener('click', e=>{
  if(!e.target.closest('#globalSearch') && !e.target.closest('#globalSearchDrop')){
    const d=document.getElementById('globalSearchDrop');
    if(d) d.style.display='none';
  }
});


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“… ê²½ê¸° ìº˜ë¦°ë”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// ìº˜ë¦°ë” ì£¼ê°„/ì¼ê°„ ë·°ë¥¼ ìœ„í•œ ìƒíƒœ
let calWeekOffset=0; // í˜„ì¬ ì£¼ ê¸°ì¤€ ì˜¤í”„ì…‹ (0=ì´ë²ˆì£¼, -1=ì§€ë‚œì£¼ ...)
let calDayDate=''; // ì¼ê°„ë·° í˜„ì¬ ë‚ ì§œ

function rCal(C,T){
  T.textContent='ğŸ“… ê²½ê¸° ìº˜ë¦°ë”';

  // ëª¨ë“  ê²½ê¸° ë°ì´í„° ë§µ (ë‚ ì§œâ†’ê²½ê¸° ê°ì²´ ë°°ì—´)
  const allMatches=[...miniM,...univM,...comps,...ckM,...proM];
  const dateMatchMap={};
  allMatches.forEach(m=>{
    const d=m.d||'';
    if(!d)return;
    if(!dateMatchMap[d])dateMatchMap[d]=[];
    dateMatchMap[d].push(m);
  });

  // ë‚ ì§œ label ìƒì„±
  function matchLabel(m){
    if(miniM.includes(m)) return `âš¡ ${m.a||''} vs ${m.b||''}`;
    if(univM.includes(m)) return `ğŸŸï¸ ${m.a||''} vs ${m.b||''}`;
    if(ckM.includes(m))   return `ğŸ¤ CK ${m.teamALabel||'AíŒ€'} vs ${m.teamBLabel||'BíŒ€'}`;
    if(proM.includes(m))  return `ğŸ… í”„ë¡œ ${m.teamALabel||'AíŒ€'} vs ${m.teamBLabel||'BíŒ€'}`;
    return `ğŸ–ï¸ ëŒ€íšŒ`;
  }
  // ìº˜ë¦°ë”ìš© íŒ€ëª… getter (í”„ë¡œ/CKëŠ” label ì‚¬ìš©)
  function getTeamA(m){ return ckM.includes(m)||proM.includes(m) ? 'AíŒ€' : (m.a||''); }
  function getTeamB(m){ return ckM.includes(m)||proM.includes(m) ? 'BíŒ€' : (m.b||''); }

  const now=new Date(calYear,calMonth,1);
  const year=now.getFullYear();
  const month=now.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const lastDate=new Date(year,month+1,0).getDate();
  const weeks=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

  const today=new Date();
  function pad(n){return String(n).padStart(2,'0');}
  function dateStr(y,m,d){return `${y}-${pad(m+1)}-${pad(d)}`;}
  const todayStr=dateStr(today.getFullYear(),today.getMonth(),today.getDate());

  // ì£¼ê°„ë·° ê¸°ì¤€ weekStart (ì˜¤í”„ì…‹ ì ìš©)
  const weekStart=new Date(today);
  weekStart.setDate(today.getDate()-today.getDay()+calWeekOffset*7);

  // ì¼ê°„ë·° ë‚ ì§œ
  if(!calDayDate) calDayDate=todayStr;

  let calHTML='';
  let navHTML='';

  if(calView==='month'){
    navHTML=`
      <button class="btn btn-w btn-sm" onclick="calYear=calMonth===0?calYear-1:calYear;calMonth=calMonth===0?11:calMonth-1;render()">â—€ ì´ì „</button>
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px;min-width:110px;text-align:center">${year}ë…„ ${month+1}ì›”</span>
      <button class="btn btn-w btn-sm" onclick="calYear=calMonth===11?calYear+1:calYear;calMonth=calMonth===11?0:calMonth+1;render()">ë‹¤ìŒ â–¶</button>
      <button class="btn btn-w btn-sm" onclick="calYear=new Date().getFullYear();calMonth=new Date().getMonth();render()">ì˜¤ëŠ˜</button>`;

    let cells='';
    let day=1;
    for(let row=0;row<6;row++){
      let rowHTML='';
      for(let col=0;col<7;col++){
        const idx=row*7+col;
        if(idx<firstDay||day>lastDate){
          rowHTML+=`<td style="background:var(--surface);vertical-align:top;padding:4px;min-height:80px"></td>`;
        } else {
          const ds=dateStr(year,month,day);
          const matches=dateMatchMap[ds]||[];
          const isToday=ds===todayStr;
          const hasMatch=matches.length>0;
          rowHTML+=`<td data-ds="${ds}" style="vertical-align:top;padding:4px;min-height:80px;cursor:${hasMatch?'pointer':'default'};${hasMatch?`background:${ds===_calActiveDay?'#dbeafe':'#f0f6ff'};`:''}border-radius:6px;${hasMatch&&ds===_calActiveDay?'outline:2px solid var(--blue);outline-offset:-2px;':''}"
            ${hasMatch?`onclick="calShowDay('${ds}')"`:''}
          >
            <div style="font-weight:${isToday?'900':'600'};font-size:12px;color:${isToday?'#fff':'var(--text)'};background:${isToday?'var(--blue)':'transparent'};width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:3px">${day}</div>
            ${matches.slice(0,2).map(m=>`<div style="font-size:9px;background:${proM.includes(m)?'#7c3aed':miniM.includes(m)?'#2563eb':univM.includes(m)?'#059669':ckM.includes(m)?'#d97706':'#2563eb'};color:#fff;border-radius:3px;padding:1px 4px;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${matchLabel(m)}</div>`).join('')}
            ${matches.length>2?`<div style="font-size:9px;color:var(--blue);font-weight:700">+${matches.length-2}ë”</div>`:''}
          </td>`;
          day++;
        }
      }
      cells+=`<tr>${rowHTML}</tr>`;
      if(day>lastDate)break;
    }
    calHTML=`
      <table style="width:100%;border-collapse:collapse;table-layout:fixed">
        <thead><tr>${weeks.map((w,i)=>`<th style="padding:8px;font-size:11px;color:${i===0?'var(--red)':i===6?'var(--blue)':'var(--gray-l)'};font-weight:700">${w}</th>`).join('')}</tr></thead>
        <tbody>${cells}</tbody>
      </table>`;

  } else if(calView==='week'){
    // ì£¼ê°„ë·°ì— ì´ì „/ë‹¤ìŒ ì£¼ ë„¤ë¹„
    const ws=new Date(weekStart);
    const we=new Date(weekStart);we.setDate(we.getDate()+6);
    const wsStr=`${ws.getMonth()+1}/${ws.getDate()}`;
    const weStr=`${we.getMonth()+1}/${we.getDate()}`;
    navHTML=`
      <button class="btn btn-w btn-sm" onclick="calWeekOffset--;render()">â—€ ì´ì „ ì£¼</button>
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:15px;min-width:130px;text-align:center">${wsStr} ~ ${weStr}</span>
      <button class="btn btn-w btn-sm" onclick="calWeekOffset++;render()">ë‹¤ìŒ ì£¼ â–¶</button>
      <button class="btn btn-w btn-sm" onclick="calWeekOffset=0;render()">ì´ë²ˆ ì£¼</button>`;

    let rows='';
    for(let i=0;i<7;i++){
      const d=new Date(weekStart);d.setDate(weekStart.getDate()+i);
      const ds=dateStr(d.getFullYear(),d.getMonth(),d.getDate());
      const matches=dateMatchMap[ds]||[];
      const isToday=ds===todayStr;
      rows+=`<div style="display:flex;gap:12px;padding:10px 14px;background:${isToday?'var(--blue-l)':'var(--white)'};border:1px solid ${isToday?'var(--blue)':'var(--border)'};border-radius:8px;margin-bottom:6px;align-items:flex-start;cursor:${matches.length?'pointer':'default'}"
        ${matches.length?`onclick="calDayDate='${ds}';calView='day';render()"`:''}>
        <div style="min-width:48px;text-align:center">
          <div style="font-size:10px;color:${i===0?'var(--red)':i===6?'var(--blue)':'var(--gray-l)'};font-weight:700">${weeks[i]}</div>
          <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px;color:${isToday?'var(--blue)':'var(--text)'}">${d.getDate()}</div>
        </div>
        <div style="flex:1">
          ${matches.length===0
            ?`<span style="color:var(--gray-l);font-size:12px">ê²½ê¸° ì—†ìŒ</span>`
            :matches.map(m=>{
              const isCKorPro=ckM.includes(m)||proM.includes(m);
              const tA=getTeamA(m);const tB=getTeamB(m);
              const ca=isCKorPro?'#2563eb':gc(m.a||'');const cb=isCKorPro?'#dc2626':gc(m.b||'');
              const aWin=(m.sa??-1)>(m.sb??-1);const bWin=(m.sb??-1)>(m.sa??-1);
              const hasResult=(m.sa!=null&&m.sa!=='');
              return `<div style="font-size:11px;font-weight:600;padding:4px 8px;background:#f0f6ff;border:1px solid var(--blue-ll);border-radius:5px;margin-bottom:3px;display:flex;align-items:center;gap:6px">
                <span style="color:var(--blue);font-size:10px">${matchLabel(m).split(' ')[0]}</span>
                <span style="font-weight:700;color:${aWin&&hasResult?ca:'var(--text)'}">${tA}</span>
                ${hasResult?`<span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:13px">${m.sa}:<span>${m.sb}</span></span>`:`<span style="color:var(--gray-l)">vs</span>`}
                <span style="font-weight:700;color:${bWin&&hasResult?cb:'var(--text)'}">${tB}</span>
                ${hasResult?(aWin?`<span style="font-size:10px;color:${ca};font-weight:800">â–¶ ${tA} ìŠ¹</span>`:bWin?`<span style="font-size:10px;color:${cb};font-weight:800">â–¶ ${tB} ìŠ¹</span>`:'<span style="font-size:10px;color:var(--gray-l)">ë¬´</span>'):''}
              </div>`;
            }).join('')
          }
        </div>
      </div>`;
    }
    calHTML=rows;

  } else if(calView==='day'){
    // ì¼ê°„ë·°
    const d=new Date(calDayDate);
    const prevD=new Date(d);prevD.setDate(d.getDate()-1);
    const nextD=new Date(d);nextD.setDate(d.getDate()+1);
    const fmtDayStr=(dt)=>dateStr(dt.getFullYear(),dt.getMonth(),dt.getDate());
    navHTML=`
      <button class="btn btn-w btn-sm" onclick="calDayDate='${fmtDayStr(prevD)}';render()">â—€ ì „ë‚ </button>
      <span style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:16px;min-width:130px;text-align:center">${calDayDate}</span>
      <button class="btn btn-w btn-sm" onclick="calDayDate='${fmtDayStr(nextD)}';render()">ë‹¤ìŒë‚  â–¶</button>
      <button class="btn btn-w btn-sm" onclick="calDayDate='${todayStr}';render()">ì˜¤ëŠ˜</button>`;

    const matches=dateMatchMap[calDayDate]||[];
    if(!matches.length){
      calHTML=`<div style="padding:40px;text-align:center;color:var(--gray-l)">ì´ ë‚  ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    } else {
      calHTML=matches.map((m,mi)=>{
        const isCKorPro=ckM.includes(m)||proM.includes(m);
        const tA=getTeamA(m);const tB=getTeamB(m);
        const ca=isCKorPro?'#2563eb':gc(m.a||'');const cb=isCKorPro?'#dc2626':gc(m.b||'');
        const aWin=(m.sa??-1)>(m.sb??-1);const bWin=(m.sb??-1)>(m.sa??-1);
        const hasResult=(m.sa!=null&&m.sa!=='');
        const typeLabel=miniM.includes(m)?'âš¡ ë¯¸ë‹ˆëŒ€ì „':univM.includes(m)?'ğŸŸï¸ ëŒ€í•™ëŒ€ì „':ckM.includes(m)?'ğŸ¤ ëŒ€í•™CK':proM.includes(m)?'ğŸ… í”„ë¡œë¦¬ê·¸':'ğŸ–ï¸ ëŒ€íšŒ';
        const detKey=`calday-${calDayDate}-${mi}`;
        const detHTML=buildDetailHTML(m,miniM.includes(m)?'mini':univM.includes(m)?'univm':ckM.includes(m)?'ck':proM.includes(m)?'pro':'comp',
          tA,tB,ca,cb,aWin,bWin);
        return `<div style="background:var(--white);border:1px solid var(--border);border-radius:10px;margin-bottom:10px;overflow:hidden">
          <div style="padding:12px 16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;background:var(--surface);border-bottom:1px solid var(--border)">
            <span style="font-size:11px;font-weight:700;color:var(--blue)">${typeLabel}</span>
            <span class="ubadge${aWin&&hasResult?'':hasResult?' loser':''}" style="background:${ca}">${tA}</span>
            ${hasResult?`<div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px"><span class="${aWin?'wt':bWin?'lt':'pt-z'}">${m.sa}</span><span style="color:var(--gray-l);font-size:14px"> : </span><span class="${bWin?'wt':aWin?'lt':'pt-z'}">${m.sb}</span></div>`:`<span style="color:var(--gray-l);font-weight:700">vs</span>`}
            <span class="ubadge${bWin&&hasResult?'':hasResult?' loser':''}" style="background:${cb}">${tB}</span>
            ${hasResult?(aWin?`<span style="font-size:12px;font-weight:800;color:${ca}">â–¶ ${tA} ìŠ¹</span>`:bWin?`<span style="font-size:12px;font-weight:800;color:${cb}">â–¶ ${tB} ìŠ¹</span>`:'<span style="color:var(--gray-l)">ë¬´ìŠ¹ë¶€</span>'):'<span style="font-size:11px;color:var(--gray-l)">ê²°ê³¼ ë¯¸ì…ë ¥</span>'}
            <div style="margin-left:auto" class="no-export"><button id="detbtn-${detKey}" class="btn-detail" onclick="toggleDetail('${detKey}')">â–¼ ìƒì„¸ ë³´ê¸°</button></div>
          </div>
          <div id="det-${detKey}" class="rec-detail-area" style="padding:12px 16px">${detHTML}</div>
        </div>`;
      }).join('');
    }
  }

  C.innerHTML=`
  <div>
    <!-- ì»¨íŠ¸ë¡¤ ë°” -->
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap">
      ${navHTML}
      <div style="margin-left:auto;display:flex;gap:4px">
        <button class="btn btn-sm ${calView==='month'?'btn-b':'btn-w'}" onclick="calView='month';render()">ì›”ê°„</button>
        <button class="btn btn-sm ${calView==='week'?'btn-b':'btn-w'}" onclick="calWeekOffset=0;calView='week';render()">ì£¼ê°„</button>
        <button class="btn btn-sm ${calView==='day'?'btn-b':'btn-w'}" onclick="calDayDate='${todayStr}';calView='day';render()">ì¼ê°„</button>
      </div>
    </div>
    <!-- ìº˜ë¦°ë” ë³¸ë¬¸ -->
    <div style="background:var(--white);border:1px solid var(--border);border-radius:10px;padding:12px;overflow-x:auto">
      ${calHTML}
    </div>
    <!-- ì„ íƒ ë‚ ì§œ ê²½ê¸° ëª©ë¡ (ì›”ê°„ë·°ìš©) -->
    <div id="calDayDetail" style="margin-top:14px"></div>
  </div>`;
}

let _calActiveDay='';
let _calDetailState={}; // ìº˜ë¦°ë” ì „ìš© ìƒì„¸ ì—´ë¦¼ ìƒíƒœ

function calToggleDetail(key){
  const area=document.getElementById('det-'+key);
  const btn=document.getElementById('detbtn-'+key);
  if(!area)return;
  _calDetailState[key]=!_calDetailState[key];
  const isOpen=!!_calDetailState[key];
  area.style.display=isOpen?'block':'none';
  if(btn){btn.classList.toggle('open',isOpen);btn.textContent=isOpen?'â–² ë‹«ê¸°':'â–¼ ìƒì„¸';}
}

function calShowDay(ds){
  const el=document.getElementById('calDayDetail');
  if(!el)return;
  // ê°™ì€ ë‚ ì§œ ë‹¤ì‹œ í´ë¦­ â†’ ë‹«ê¸°
  if(_calActiveDay===ds){
    _calActiveDay='';
    _calDetailState={};
    el.style.animation='';
    el.innerHTML='';
    render();
    return;
  }
  _calActiveDay=ds;
  _calDetailState={}; // ë‚ ì§œ ë³€ê²½ ì‹œ ìƒì„¸ ìƒíƒœ ì´ˆê¸°í™”
  const allMatches=[...miniM,...univM,...comps,...ckM,...proM];
  const matches=allMatches.filter(m=>m.d===ds);

  function buildMatchRow(m,mi){
    if(m.sa==null||m.sa==='') return ''; // ë¯¸ì…ë ¥ í•­ëª© ì œì™¸
    const isCKorPro=ckM.includes(m)||proM.includes(m);
    const tA=isCKorPro?'AíŒ€':(m.a||'');
    const tB=isCKorPro?'BíŒ€':(m.b||'');
    const ca=isCKorPro?'#2563eb':gc(m.a||'');
    const cb=isCKorPro?'#dc2626':gc(m.b||'');
    const aWin=(m.sa??-1)>(m.sb??-1);const bWin=(m.sb??-1)>(m.sa??-1);
    const typeBg=miniM.includes(m)?'#2563eb':univM.includes(m)?'#7c3aed':ckM.includes(m)?'#d97706':proM.includes(m)?'#7c3aed':'#16a34a';
    const typeLabel=miniM.includes(m)?'âš¡ ë¯¸ë‹ˆëŒ€ì „':univM.includes(m)?'ğŸŸï¸ ëŒ€í•™ëŒ€ì „':ckM.includes(m)?'ğŸ¤ ëŒ€í•™CK':proM.includes(m)?'ğŸ… í”„ë¡œë¦¬ê·¸':'ğŸ–ï¸ ëŒ€íšŒ';
    const detKey='caldm-'+ds+'-'+mi;
    const modeKey=miniM.includes(m)?'mini':univM.includes(m)?'univm':ckM.includes(m)?'ck':proM.includes(m)?'pro':'comp';
    const detHTML=buildDetailHTML(m,modeKey,tA,tB,ca,cb,aWin,bWin);
    const winLabel=aWin?'â–¶ '+tA+' ìŠ¹':bWin?'â–¶ '+tB+' ìŠ¹':'ë¬´ìŠ¹ë¶€';
    const winColor=aWin?ca:bWin?cb:'#888';
    return '<div class="rec-summary" style="margin-bottom:6px">'
      +'<div class="rec-sum-header" style="cursor:pointer" onclick="calToggleDetail(\''+detKey+'\')">'
      +'<span style="background:'+typeBg+';color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700">'+typeLabel+'</span>'
      +'<div class="rec-sum-vs" style="flex:1">'
      +'<span class="ubadge'+(aWin?'':' loser')+'" style="background:'+ca+'">'+tA+'</span>'
      +'<div class="rec-sum-score score-click" onclick="event.stopPropagation();calToggleDetail(\''+detKey+'\')" title="í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°/ë‹«ê¸°">'
      +'<span class="'+(aWin?'wt':bWin?'lt':'pt-z')+'">'+m.sa+'</span>'
      +'<span style="color:var(--gray-l);font-size:14px"> : </span>'
      +'<span class="'+(bWin?'wt':aWin?'lt':'pt-z')+'">'+m.sb+'</span>'
      +'</div>'
      +'<span class="ubadge'+(bWin?'':' loser')+'" style="background:'+cb+'">'+tB+'</span>'
      +'<span style="font-size:12px;font-weight:700;color:'+winColor+'">'+winLabel+'</span>'
      +'</div>'
      +'<div class="no-export" style="margin-left:auto;display:flex;gap:4px;align-items:center">'
      +'<button id="detbtn-'+detKey+'" class="btn-detail" onclick="event.stopPropagation();calToggleDetail(\''+detKey+'\')">â–¼ ìƒì„¸</button>'
      +'</div>'
      +'</div>'
      +'<div id="det-'+detKey+'" style="display:none;padding:10px 14px;background:var(--surface);border-top:1px solid var(--border)">'
      +detHTML
      +'<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">'
      +'<button class="btn-capture btn-xs no-export" onclick="captureDetail(\'det-'+detKey+'\',\''+ds+'_match\')">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>'
      +'</div>'
      +'</div>'
      +'</div>';
  }

  el.style.animation='fadeIn .2s';
  el.innerHTML='<div class="ssec" style="border:2px solid var(--blue);animation:fadeIn .2s">'
    +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">'
    +'<h4 style="margin:0;color:var(--blue)">ğŸ“… '+ds+' ê²½ê¸° ëª©ë¡ <span style="font-size:12px;font-weight:400;color:var(--gray-l)">'+matches.length+'ê²½ê¸°</span></h4>'
    +'<div style="display:flex;gap:6px">'
    +'<button class="btn btn-b btn-sm" onclick="calDayDate=\''+ds+'\';calView=\'day\';render()">ğŸ“‹ ì¼ê°„ ìƒì„¸ë³´ê¸°</button>'
    +'<button class="btn btn-w btn-sm" onclick="captureDetail(&quot;calDayDetail&quot;,&quot;ìº˜ë¦°ë”_&quot;+(new Date().toLocaleDateString()))" style="margin-right:4px">ğŸ“· ì €ì¥</button>'+'<button class="btn btn-w btn-sm" onclick="_calActiveDay=\'\';document.getElementById(\'calDayDetail\').innerHTML=\'\'">âœ• ë‹«ê¸°</button>'
    +'</div></div>'
    +matches.map(buildMatchRow).join('')
    +'</div>';
  // render() ì œê±° - í˜¸ì¶œí•˜ë©´ rCalì´ ì¬ì‹¤í–‰ë˜ì–´ calDayDetailì´ ì´ˆê¸°í™”ë¨
}


function swNav(t,el){
  document.querySelectorAll('.bnav-item').forEach(b=>b.classList.remove('on'));
  if(el) el.classList.add('on');
  // íƒ­ ì „í™˜ ì‹œ ì„œë¸Œíƒ­ ìƒíƒœ ì´ˆê¸°í™”
  if(t==='comp'){compSub='league';leagueFilterDate='';leagueFilterGrp='';grpRankFilter='';}
  if(t==='mini')miniSub='records';
  if(t==='univck')ckSub='records';
  if(t==='univm')univmSub='records';
  if(t==='pro')proSub='records';
  if(t==='hist')histSub='mini';
  // íƒ­ë²„íŠ¼ ì°¾ì•„ì„œ sw í˜¸ì¶œ (ë°ìŠ¤í¬íƒ‘ íƒ­ UI ë™ê¸°í™”)
  let found=false;
  document.querySelectorAll('.tab').forEach(b=>{
    const oc=b.getAttribute('onclick')||'';
    if(oc.includes("'"+t+"'")){sw(t,b);found=true;}
  });
  // íƒ­ ë²„íŠ¼ì´ ì—†ëŠ” ê²½ìš°(ëª¨ë°”ì¼ ì „ìš© íƒ­ ë“±) ì§ì ‘ ë Œë”ë§
  if(!found){
    curTab=t;openDetails={};
    const fstrip=document.getElementById('fstrip');
    if(fstrip) fstrip.style.display=(t==='total'&&isLoggedIn)?'block':'none';
    const C=document.getElementById('rcont');
    if(C) C.innerHTML='';
    render();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ¯ ìŠ¹ë¶€ì˜ˆì¸¡ ì‹œìŠ¤í…œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveVotes(){ localStorage.setItem('su_votes', JSON.stringify(voteData)); }

function rVote(C,T){
  T.textContent='ğŸ¯ ìŠ¹ë¶€ì˜ˆì¸¡';

  // ì˜ˆì •/ì§„í–‰ì¤‘ ê²½ê¸° ìˆ˜ì§‘ (ê²°ê³¼ ì—†ëŠ” ë¯¸ë‹ˆëŒ€ì „)
  const upcoming = miniM.filter(m=> m.sa==null || m.sa===''); // null/undefined/ë¹ˆë¬¸ìì—´=ë¯¸ì…ë ¥, sa=0ë„ ì™„ë£Œë¡œ ì •ìƒ ì²˜ë¦¬
  // ê²°ê³¼ ìˆëŠ” ê²½ê¸°
  const finished = miniM.filter(m=> m.sa!=null && m.sa!==''); // ìˆ«ì(0í¬í•¨)ê°€ ìˆìœ¼ë©´ ì™„ë£Œ ê²½ê¸°

  function getVoteKey(m){ return m._id||`${m.a}_${m.b}_${m.d}`; }

  function voteBar(key, side){
    const v = voteData[key]||{a:0,b:0};
    const total = v.a+v.b;
    const myVote = voteData[key+'_my'];
    const pctA = total===0?50:Math.round(v.a/total*100);
    const pctB = 100-pctA;
    const aCol = gc((miniM.find(m=>getVoteKey(m)===key)||{}).a||'');
    const bCol = gc((miniM.find(m=>getVoteKey(m)===key)||{}).b||'');
    return `
      <div style="margin-top:10px">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--gray-l);margin-bottom:4px">
          <span>ğŸ—³ï¸ ì´ ${total}í‘œ</span>
          ${myVote?`<span style="color:var(--blue);font-weight:700">âœ… ë‚´ ì˜ˆì¸¡: ${myVote==='a'?(miniM.find(m=>getVoteKey(m)===key)||{}).a||'A':(miniM.find(m=>getVoteKey(m)===key)||{}).b||'B'}</span>`:''}
        </div>
        <div style="display:flex;height:22px;border-radius:20px;overflow:hidden;background:#f1f5f9">
          <div style="width:${pctA}%;background:${aCol||'var(--blue)'};display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:700;transition:.4s">${pctA}%</div>
          <div style="width:${pctB}%;background:${bCol||'var(--red)'};display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:700;transition:.4s">${pctB}%</div>
        </div>
      </div>`;
  }

  C.innerHTML=`
  <div style="display:flex;flex-direction:column;gap:16px">

    <!-- ì˜ˆì¸¡ ê°€ëŠ¥í•œ ê²½ê¸° -->
    <div class="ssec">
      <h4>ğŸ¯ ìŠ¹ë¶€ì˜ˆì¸¡</h4>
      ${upcoming.length===0
        ? '<p style="color:var(--gray-l);font-size:13px">ì˜ˆì¸¡ ê°€ëŠ¥í•œ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.<br><span style="font-size:11px">ë¯¸ë‹ˆëŒ€ì „ì—ì„œ ê²°ê³¼ ë¯¸ì…ë ¥ ê²½ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</span></p>'
        : upcoming.map(m=>{
            const key=getVoteKey(m);
            const v=voteData[key]||{a:0,b:0};
            const myVote=voteData[key+'_my'];
            const aCol=gc(m.a||'');
            const bCol=gc(m.b||'');
            return `<div style="background:var(--white);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px">
              <div style="font-size:11px;color:var(--gray-l);margin-bottom:8px">ğŸ“… ${m.d||'ë‚ ì§œ ë¯¸ì •'}</div>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                <div style="flex:1;text-align:center;padding:10px;background:${aCol}22;border-radius:8px;border:2px solid ${myVote==='a'?aCol:'transparent'}">
                  <div style="font-weight:800;color:${aCol}">${m.a||'íŒ€A'}</div>
                </div>
                <div style="font-weight:900;color:var(--gray-l);font-size:18px">VS</div>
                <div style="flex:1;text-align:center;padding:10px;background:${bCol}22;border-radius:8px;border:2px solid ${myVote==='b'?bCol:'transparent'}">
                  <div style="font-weight:800;color:${bCol}">${m.b||'íŒ€B'}</div>
                </div>
              </div>
              ${voteBar(key)}
              ${myVote
                ? `<button class="btn btn-w btn-sm" style="width:100%;margin-top:10px" onclick="cancelVote('${key}')">ğŸ”„ ì˜ˆì¸¡ ì·¨ì†Œ</button>`
                : `<div style="display:flex;gap:8px;margin-top:10px">
                    <button class="btn btn-sm" style="flex:1;background:${aCol};color:#fff;border-color:${aCol}" onclick="doVote('${key}','a')">${m.a||'íŒ€A'} ìŠ¹ë¦¬</button>
                    <button class="btn btn-sm" style="flex:1;background:${bCol};color:#fff;border-color:${bCol}" onclick="doVote('${key}','b')">${m.b||'íŒ€B'} ìŠ¹ë¦¬</button>
                  </div>`
              }
            </div>`;
          }).join('')
      }
    </div>

    <!-- ì˜ˆì¸¡ ê²°ê³¼ í™•ì¸ -->
    <div class="ssec">
      <h4>ğŸ† ì˜ˆì¸¡ ê²°ê³¼</h4>
      ${finished.length===0
        ? '<p style="color:var(--gray-l);font-size:13px">ê²°ê³¼ê°€ ë‚˜ì˜¨ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
        : finished.map(m=>{
            const key=getVoteKey(m);
            const v=voteData[key]||{a:0,b:0};
            const myVote=voteData[key+'_my'];
            const winner=m.sa>m.sb?'a':'b';
            const correct=myVote&&myVote===winner;
            const voted=!!myVote;
            const aCol=gc(m.a||'');
            const bCol=gc(m.b||'');
            const total=v.a+v.b;
            const pctA=total===0?50:Math.round(v.a/total*100);
            return `<div style="background:var(--white);border:1px solid ${voted?(correct?'var(--green)':'var(--red)'):'var(--border)'};border-radius:12px;padding:14px;margin-bottom:8px;opacity:${voted?1:0.7}">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                <span style="font-size:11px;color:var(--gray-l)">ğŸ“… ${m.d||''}</span>
                ${voted?`<span style="font-size:12px;font-weight:700;color:${correct?'var(--green)':'var(--red)'}">${correct?'âœ… ì˜ˆì¸¡ ì„±ê³µ!':'âŒ ì˜ˆì¸¡ ì‹¤íŒ¨'}</span>`:'<span style="font-size:11px;color:var(--gray-l)">ì˜ˆì¸¡ ì•ˆí•¨</span>'}
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div style="flex:1;text-align:center;font-weight:${m.sa>m.sb?'900':'400'};color:${m.sa>m.sb?aCol:'var(--gray-l)'}">
                  ${m.sa>m.sb?'ğŸ† ':''} ${m.a||'íŒ€A'}
                </div>
                <div style="font-family:'Noto Sans KR',sans-serif;font-weight:900;font-size:20px">${m.sa} : ${m.sb}</div>
                <div style="flex:1;text-align:center;font-weight:${m.sb>m.sa?'900':'400'};color:${m.sb>m.sa?bCol:'var(--gray-l)'}">
                  ${m.sb>m.sa?'ğŸ† ':''} ${m.b||'íŒ€B'}
                </div>
              </div>
              <div style="margin-top:8px">
                <div style="display:flex;height:18px;border-radius:20px;overflow:hidden;background:#f1f5f9">
                  <div style="width:${pctA}%;background:${aCol};transition:.4s"></div>
                  <div style="width:${100-pctA}%;background:${bCol};transition:.4s"></div>
                </div>
                <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--gray-l);margin-top:3px">
                  <span>${pctA}% (${v.a}í‘œ)</span><span>${100-pctA}% (${v.b}í‘œ)</span>
                </div>
              </div>
            </div>`;
          }).join('')
      }
    </div>

  </div>`;
}

function doVote(key, side){
  if(voteData[key+'_my']){ alert('ì´ë¯¸ ì˜ˆì¸¡í–ˆìŠµë‹ˆë‹¤!'); return; }
  if(!voteData[key]) voteData[key]={a:0,b:0};
  voteData[key][side]++;
  voteData[key+'_my']=side;
  saveVotes();
  render();
}

function cancelVote(key){
  const side=voteData[key+'_my'];
  if(!side)return;
  if(!confirm('ì˜ˆì¸¡ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  if(voteData[key]) voteData[key][side]=Math.max(0,voteData[key][side]-1);
  delete voteData[key+'_my'];
  saveVotes();
  render();
}

function sf(u,t){fUniv=u;fTier=t;render();}
function fsearch(type){
  const id=type==='w'?'ws':'ls';const lid=type==='w'?'wl':'ll';
  const v=document.getElementById(id).value.toLowerCase();
  const d=document.getElementById(lid);
  const f=players.filter(p=>p.name.toLowerCase().includes(v));
  if(v&&f.length){d.innerHTML=f.map(p=>`<div class="sitem" onclick="selP('${type}','${p.name}')">${p.name} <span style="color:var(--gray-l);font-size:11px">(${p.univ})</span></div>`).join('');d.style.display='block';}
  else d.style.display='none';
}
function selP(type,name){document.getElementById(type==='w'?'ws':'ls').value=name;document.getElementById(type==='w'?'wl':'ll').style.display='none';}
function upTour(i,v){tourD[i]=v;save();render();}
function om(id){document.getElementById(id).style.display='block';}
function cm(id){document.getElementById(id).style.display='none';}
window.addEventListener('click',e=>{
  if(e.target.classList.contains('modal'))e.target.style.display='none';
  if(!e.target.closest('.swrap'))document.querySelectorAll('.sdrop').forEach(d=>d.style.display='none');
});

async function doJpg(){
  document.querySelectorAll('.no-export').forEach(e=>e.style.display='none');
  const cap=document.getElementById('cap');
  const origStyle=cap.getAttribute('style')||'';
  cap.style.maxWidth='900px';cap.style.margin='0 auto';cap.style.padding='24px';
  const canvas=await html2canvas(cap,{backgroundColor:'#fff',useCORS:true,scale:2,logging:false});
  cap.setAttribute('style',origStyle);
  // ìº”ë²„ìŠ¤ë¥¼ ê°€ìš´ë° ì—¬ë°± ì¶”ê°€í•´ì„œ ìƒˆ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
  const pad=40;
  const out=document.createElement('canvas');
  out.width=canvas.width+pad*2;out.height=canvas.height+pad*2;
  const ctx=out.getContext('2d');
  ctx.fillStyle='#f1f5f9';ctx.fillRect(0,0,out.width,out.height);
  ctx.drawImage(canvas,pad,pad);
  const a=document.createElement('a');a.download=`star_v22_${curTab}.jpg`;a.href=out.toDataURL('image/jpeg',.93);a.click();
  document.querySelectorAll('.no-export').forEach(e=>e.style.display='');
}



/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë¡œê·¸ì¸ ì‹œìŠ¤í…œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// SHA-256 ì•”í˜¸í™”
async function sha256(str){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
const ADMIN_HASH_KEY='su_admin_hashes'; // ë°°ì—´ë¡œ ì €ì¥ (ë‹¤ì¤‘ ê´€ë¦¬ì)
async function initLoginHash(){
  if(!localStorage.getItem(ADMIN_HASH_KEY)){
    const h=await sha256('admin99:99admin');
    // ê¸°ì¡´ ë‹¨ì¼í‚¤ë„ ë§ˆì´ê·¸ë ˆì´ì…˜
    const oldH=localStorage.getItem('su_admin_hash');
    const arr=oldH?[oldH,h]:[h];
    localStorage.setItem(ADMIN_HASH_KEY,JSON.stringify(arr));
  }
}
function getAdminHashes(){
  try{
    const raw=localStorage.getItem(ADMIN_HASH_KEY);
    if(!raw)return [];
    const parsed=JSON.parse(raw);
    return Array.isArray(parsed)?parsed:[parsed];
  }catch{return [];}
}
let isLoggedIn=false;

async function doLogin(){
  const id=document.getElementById('li-id').value.trim();
  const pw=document.getElementById('li-pw').value;
  const err=document.getElementById('li-err');
  if(!id||!pw){err.textContent='ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';return;}
  const inputHash=await sha256(id+':'+pw);
  const hashes=getAdminHashes();
  if(hashes.includes(inputHash)){
    isLoggedIn=true;
    cm('loginModal');
    document.getElementById('li-id').value='';
    document.getElementById('li-pw').value='';
    document.getElementById('li-err').textContent='';
    applyLoginState();
  } else {
    err.textContent='ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    document.getElementById('li-pw').value='';
  }
}

function doLogout(){
  isLoggedIn=false;
  if(['member','cfg'].includes(curTab)){curTab='total';document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));document.querySelector('.tab').classList.add('on');}
  if(['grpedit','input'].includes(compSub)) compSub='league';
  applyLoginState();
}

function applyLoginState(){
  // í—¤ë” ë²„íŠ¼ í‘œì‹œ
  document.getElementById('hdrLoginBtn').style.display=isLoggedIn?'none':'';
  document.getElementById('hdrLogoutBtn').style.display=isLoggedIn?'':'none';
  document.getElementById('hdrLoginStatus').style.display=isLoggedIn?'':'none';
  // ì ê¸ˆ ìš”ì†Œ
  document.querySelectorAll('.lock-admin').forEach(el=>{
    el.classList.toggle('locked',!isLoggedIn);
  });
  // ê´€ë¦¬ì ì „ìš© íƒ­ (íšŒì›ê´€ë¦¬, ì„¤ì •)
  const ADMIN_TABS=['tabMember','tabCfg'];
  ADMIN_TABS.forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.display=isLoggedIn?'':'none';
  });
  // ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ â€” ë¡œê·¸ì¸ ì‹œì—ë§Œ í‘œì‹œ
  const exportBtn=document.getElementById('btnExport');
  const importBtn=document.getElementById('btnImport');
  const exportHint=document.getElementById('exportHint');
  if(exportBtn)exportBtn.style.display=isLoggedIn?'':'none';
  if(importBtn)importBtn.style.display=isLoggedIn?'':'none';
  if(exportHint)exportHint.style.display=isLoggedIn?'':'none';
  const exportVis=document.getElementById('btnExportVis');
  const importVis=document.getElementById('btnImportVis');
  if(exportVis)exportVis.style.display=isLoggedIn?'flex':'none';
  if(importVis)importVis.style.display=isLoggedIn?'flex':'none';
  // ìŠ¤íŠ¸ë¦¬ë¨¸ ë“±ë¡/ê²½ê¸° ê¸°ë¡ ì…ë ¥í¼ â€” ë¡œê·¸ì¸ + ìŠ¤íŠ¸ë¦¬ë¨¸ íƒ­ì¼ ë•Œë§Œ í‘œì‹œ
  const fstrip=document.getElementById('fstrip');
  if(fstrip){
    if(!isLoggedIn){fstrip.style.display='none';}
    else{fstrip.style.display=(curTab==='total')?'block':'none';}
  }
  render();
}

// ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ â€” ë¹„ë¡œê·¸ì¸ ì‹œ ìˆ¨ê¹€
function adminBtn(html){
  return isLoggedIn ? html : '';
}
function doExport(){
  try{
    const b=new Blob([JSON.stringify({players,univCfg,maps,tourD,miniM,univM,comps,ckM,compNames,curComp,proM,tiers:TIERS,members,tourneys},null,2)],{type:'application/json'});
    const url=URL.createObjectURL(b);
    const a=document.createElement('a');
    a.href=url;a.download='star_backup.json';
    document.body.appendChild(a);a.click();
    setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},100);
  }catch(e){alert('ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜: '+e.message);}
}

function doImport(){document.getElementById('fi').click();}
function doFile(inp){
  const r=new FileReader();
  r.onload=e=>{
    try{
      const d=JSON.parse(e.target.result);
      players=d.players||[];univCfg=d.univCfg||univCfg;maps=d.maps||maps;tourD=d.tourD||Array(15).fill('');
      if(d.tiers&&d.tiers.length)TIERS.splice(0,TIERS.length,...d.tiers);
      miniM=d.miniM||[];univM=d.univM||[];comps=d.comps||[];ckM=d.ckM||[];
      compNames=d.compNames||[];curComp=d.curComp||'';
      proM=d.proM||[];
      members=d.members||[];tourneys=d.tourneys||[];ttM=d.ttM||[];
      fixPoints();save();init();
    }catch{alert('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜');}
  };
  r.readAsText(inp.files[0]);
}

function refreshSel(){
  const allU=getAllUnivs();
  document.getElementById('p-univ').innerHTML=allU.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
  document.getElementById('m-map').innerHTML=maps.map(m=>`<option value="${m}">${m}</option>`).join('');
}
function init(){
  fixPoints();
  // ELO ë¯¸ì„¤ì • ì„ ìˆ˜ì—ê²Œ ê¸°ë³¸ê°’ ë¶€ì—¬
  if(typeof ELO_DEFAULT!=='undefined'){
    players.forEach(p=>{ if(p.elo===undefined||p.elo===null) p.elo=ELO_DEFAULT; });
  }
  document.getElementById('p-tier').innerHTML=TIERS.map(t=>`<option value="${t}">${getTierLabel(t)}</option>`).join('');
  refreshSel();
  document.getElementById('m-date').valueAsDate=new Date();
  initLoginHash();
  applyLoginState();
  render();
}
init();
</script>



<script>
// â”€â”€ ì†ŒìŠ¤ì½”ë“œ ë³´í˜¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function(){
  // ìš°í´ë¦­ ë°©ì§€
  document.addEventListener('contextmenu',function(e){e.preventDefault();});
  // F12, Ctrl+Shift+I, Ctrl+U, Ctrl+S, Ctrl+Shift+J, Ctrl+Shift+C ì°¨ë‹¨
  document.addEventListener('keydown',function(e){
    if(
      e.key==='F12'||
      (e.ctrlKey&&e.shiftKey&&['I','i','J','j','C','c'].includes(e.key))||
      (e.ctrlKey&&['U','u','S','s'].includes(e.key))
    ){e.preventDefault();e.stopPropagation();return false;}
  });
})();
</script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GitHub JSON ì½ê¸° ì „ìš© ë¶ˆëŸ¬ì˜¤ê¸°
   â–¼ GitHubì— ì˜¬ë¦° data.json ì˜ RAW URLì„ ì…ë ¥í•˜ì„¸ìš” â–¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GITHUB_JSON_URL = 'https://raw.githubusercontent.com/nada1004/star-system/main/data.json';


function gsSetStatus(msg, color='var(--gray-l)'){
  const el=document.getElementById('cloudStatus');
  if(el){el.textContent=msg;el.style.color=color;}
}

// â”€â”€ GitHub JSON ë¶ˆëŸ¬ì˜¤ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.cloudLoad = async function(){
  try{
    gsSetStatus('ğŸ“¥ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'var(--blue)');
    const res = await fetch(GITHUB_JSON_URL + '?t=' + Date.now());
    if(!res.ok) throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ ('+res.status+')');
    const d = await res.json();
    if(!confirm(`GitHub ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.\n\nâš ï¸ í˜„ì¬ ë¡œì»¬ ë°ì´í„°ê°€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    players=d.players||[];
    univCfg=d.univCfg||univCfg;
    maps=d.maps||maps;
    tourD=d.tourD||Array(15).fill('');
    miniM=d.miniM||[];
    univM=d.univM||[];
    comps=d.comps||[];
    ckM=d.ckM||[];
    compNames=d.compNames||[];
    curComp=d.curComp||'';
    proM=d.proM||[];
    members=d.members||[];
    tourneys=d.tourneys||[];
    ttM=d.ttM||[];
    if(d.tiers&&d.tiers.length && typeof TIERS!=='undefined'){ TIERS.splice(0,TIERS.length,...d.tiers); }

    save();
    fixPoints();
    init();

    gsSetStatus(`âœ… ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ (${new Date().toLocaleTimeString()})`, 'var(--green)');
  } catch(e){
    gsSetStatus('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+e.message, 'var(--red)');
    console.error(e);
  }
};

// â”€â”€ ì €ì¥ ê¸°ëŠ¥ ì—†ìŒ (ì½ê¸° ì „ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

</script>

<!-- ğŸ“± í•˜ë‹¨ ê³ ì • ë„¤ë¹„ê²Œì´ì…˜ ë°” (ëª¨ë°”ì¼) -->
<div id="bottomNav">
  <button class="bnav-item on" id="bn0" onclick="swNav('total',this)"><span>ğŸ“‹</span><span>ìŠ¤íŠ¸ë¦¬ë¨¸</span></button>
  <button class="bnav-item" id="bn1" onclick="swNav('tier',this)"><span>ğŸ“Š</span><span>í‹°ì–´</span></button>
  <button class="bnav-item" id="bn2" onclick="swNav('hist',this)"><span>ğŸ“…</span><span>ê¸°ë¡</span></button>
  <button class="bnav-item" id="bn3" onclick="swNav('mini',this)"><span>âš¡</span><span>ë¯¸ë‹ˆ</span></button>
  <button class="bnav-item" id="bn4" onclick="swNav('stats',this)"><span>ğŸ“ˆ</span><span>í†µê³„</span></button>
  <button class="bnav-item" id="bn5" onclick="swNav('cal',this)"><span>ğŸ—“ï¸</span><span>ìº˜ë¦°ë”</span></button>
</div>
</body>
</html>
